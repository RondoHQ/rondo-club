# Milestone v5.0: Google Contacts Sync

**Status:** SHIPPED 2026-01-18
**Phases:** 79-85
**Total Plans:** 16

## Overview

Transform Caelis from manual CSV import/export to seamless bidirectional Google Contacts synchronization. Building on existing Google OAuth infrastructure from Calendar integration, this milestone adds Contacts API scope, comprehensive field mapping, delta sync via syncToken, conflict resolution with Caelis as source of truth, and a Settings UI for connection management. Seven phases progress from OAuth foundation through import, export, ongoing sync, conflict handling, UI, and finally CLI commands for administrative operations.

## Phases

### Phase 79: OAuth Foundation
**Goal**: Users can connect Google Contacts via OAuth with existing Calendar infrastructure
**Depends on**: Nothing (first phase of milestone)
**Requirements**: OAUTH-01, OAUTH-02, OAUTH-03, OAUTH-04
**Success Criteria** (what must be TRUE):
  1. User with existing Google Calendar connection can add Contacts scope without re-authenticating
  2. New users can connect Google Contacts in a single OAuth flow
  3. Google Contacts connection status displays in Settings > Connections
  4. Tokens are stored securely using existing Sodium encryption
**Plans**: 2 plans

Plans:
- [x] 79-01-PLAN.md - Backend OAuth infrastructure (GoogleOAuth extension, connection storage, REST endpoints)
- [x] 79-02-PLAN.md - Frontend Settings UI (Contacts subtab, connect/disconnect flow)

### Phase 80: Import from Google
**Goal**: Users can import all their Google Contacts into Caelis with proper field mapping
**Depends on**: Phase 79
**Requirements**: IMPORT-01, IMPORT-02, IMPORT-03, IMPORT-04, IMPORT-05, IMPORT-06, IMPORT-07, IMPORT-08, IMPORT-09
**Success Criteria** (what must be TRUE):
  1. User sees all Google Contacts appear in Caelis after connecting
  2. Contact details (name, email, phone, address, birthday) are correctly mapped
  3. Duplicate contacts are detected by email and merged rather than duplicated
  4. Photos from Google appear on Caelis person profiles
  5. Work history is created from Google organization data
**Plans**: 3 plans

Plans:
- [x] 80-01-PLAN.md - Backend API Import class with Google People API integration and field mapping
- [x] 80-02-PLAN.md - REST endpoint to trigger import and update API client
- [x] 80-03-PLAN.md - Frontend import UI with auto-trigger, progress, and results display

### Phase 81: Export to Google
**Goal**: Users can push Caelis contacts to Google Contacts
**Depends on**: Phase 80
**Requirements**: EXPORT-01, EXPORT-02, EXPORT-03, EXPORT-04, EXPORT-05
**Success Criteria** (what must be TRUE):
  1. New Caelis contact appears in user's Google Contacts after sync
  2. Caelis contact fields (name, email, phone, etc.) are correctly mapped to Google format
  3. Photos uploaded from Caelis appear in Google Contacts
  4. User can bulk export existing unlinked contacts to Google
**Plans**: 3 plans

Plans:
- [x] 81-01-PLAN.md - Core export class with field mapping and Google API integration
- [x] 81-02-PLAN.md - Save hooks, async queue, and REST endpoint for single export
- [x] 81-03-PLAN.md - Bulk export for unlinked contacts with Settings UI

### Phase 82: Delta Sync
**Goal**: Background sync detects and propagates changes in both directions
**Depends on**: Phase 81
**Requirements**: SYNC-01, SYNC-02, SYNC-03, SYNC-04, SYNC-05
**Success Criteria** (what must be TRUE):
  1. Changes in Google Contacts appear in Caelis without manual action
  2. Changes in Caelis contacts appear in Google Contacts without manual action
  3. Sync runs automatically in background at configurable frequency
  4. Only changed contacts are synced (not full re-import every time)
**Plans**: 3 plans

Plans:
- [x] 82-01-PLAN.md - Core sync class with WP-Cron scheduling and round-robin user processing
- [x] 82-02-PLAN.md - Delta sync logic using syncToken for pull and post_modified for push
- [x] 82-03-PLAN.md - REST endpoint for manual sync and Settings UI for frequency control

### Phase 83: Conflict & Deletion
**Goal**: Conflicts are detected and resolved, deletions are handled correctly
**Depends on**: Phase 82
**Requirements**: CONFLICT-01, CONFLICT-02, CONFLICT-04, DELETE-01, DELETE-02
**Success Criteria** (what must be TRUE):
  1. When contact modified in both systems, conflict is detected
  2. Default resolution strategy (Caelis wins) is applied automatically
  3. Conflict resolution is logged as activity entry for audit
  4. Deleting a contact in Caelis removes it from Google Contacts
  5. Deleting a contact in Google only unlinks it in Caelis (preserves Caelis data)
**Plans**: 2 plans

Plans:
- [x] 83-01-PLAN.md - Conflict detection and resolution with field snapshots and activity logging
- [x] 83-02-PLAN.md - Deletion propagation via WordPress hook to Google API

### Phase 84: Settings & Person UI
**Goal**: Users can manage sync connection and view sync status per contact
**Depends on**: Phase 83
**Requirements**: SETTINGS-01, SETTINGS-03, SETTINGS-07, PERSON-01
**Success Criteria** (what must be TRUE):
  1. Sync status shows error count when last sync had errors
  2. Sync history log viewer shows recent sync operations
  3. Person detail page shows "View in Google Contacts" link for synced contacts
**Plans**: 2 plans

Plans:
- [x] 84-01-PLAN.md - Backend: REST field for google_contact_id, sync history storage and retrieval
- [x] 84-02-PLAN.md - Frontend: Error count display, sync history viewer, View in Google link

### Phase 85: Polish & CLI
**Goal**: Administrative CLI commands for sync management and final hardening
**Depends on**: Phase 84
**Requirements**: CLI-01, CLI-02, CLI-03, CLI-04, CLI-05
**Success Criteria** (what must be TRUE):
  1. Admin can trigger sync via WP-CLI with `wp caelis google-contacts sync --user-id=ID`
  2. Admin can force full resync with `--full` flag
  3. Admin can check sync status via WP-CLI
  4. Admin can list unresolved conflicts via WP-CLI
  5. Admin can unlink all contacts to reset sync state
**Plans**: 1 plan

Plans:
- [x] 85-01-PLAN.md - WP-CLI commands for Google Contacts sync management

## Progress

| Phase | Plans Complete | Status | Completed |
|-------|----------------|--------|-----------|
| 79. OAuth Foundation | 2/2 | Complete | 2026-01-17 |
| 80. Import from Google | 3/3 | Complete | 2026-01-17 |
| 81. Export to Google | 3/3 | Complete | 2026-01-17 |
| 82. Delta Sync | 3/3 | Complete | 2026-01-17 |
| 83. Conflict & Deletion | 2/2 | Complete | 2026-01-17 |
| 84. Settings & Person UI | 2/2 | Complete | 2026-01-18 |
| 85. Polish & CLI | 1/1 | Complete | 2026-01-18 |

## Milestone Summary

**Key Decisions:**
- Separate callback endpoint for contacts OAuth (different post-auth behavior)
- User-level connection storage (contacts sync is account-wide)
- No token revocation on disconnect (user may have Calendar with same account)
- Skip contacts without email (match by email only)
- Fill gaps only on duplicate match (never overwrite existing Caelis data)
- Async export via WP-Cron (avoid blocking contact save)
- Three-way comparison for conflict detection (Google vs Caelis vs snapshot)
- Caelis wins by default for conflict resolution
- Sync history stored in connection meta (last 10 entries)

**Issues Resolved:**
- Bidirectional sync between Caelis and Google Contacts
- OAuth scope management with incremental addition
- Field mapping in both directions
- Conflict detection and resolution
- Deletion propagation vs unlinking

**Technical Debt Incurred:**
- CONFLICT-03 (configurable resolution strategies) deferred to future
- SETTINGS-06 (conflict resolution preference dropdown) deferred to future

---
*Archived: 2026-01-18 as part of v5.0 milestone completion*
*For current project status, see .planning/ROADMAP.md*
