# Milestone v12.0: Membership Fees

**Status:** SHIPPED 2026-02-01
**Phases:** 123-128
**Total Plans:** 15

## Overview

This milestone implements a membership fee calculation system for Stadion. Starting with configurable fee settings, then building the calculation engine for age-based fees, adding family discount logic with address grouping, and finally integrating pro-rata calculations with a user-facing list view. The system calculates fees but does not track payments (deferred to future milestone).

## Phases

### Phase 123: Settings & Backend Foundation
**Goal**: Admin can configure all fee amounts through settings UI
**Depends on**: Nothing (first phase of milestone)
**Plans**: 2 plans

Plans:
- [x] 123-01: Settings backend and calculation service class
- [x] 123-02: Settings UI subtab with fee configuration form

**Details:**
- Created STADION_Membership_Fees service class with Stadion\Fees namespace
- REST API endpoints for reading/writing fee settings (stadion_fee_settings option)
- Admin "Contributie" subtab under Settings > Admin
- 6 configurable fee amounts: Mini (130), Pupil (180), Junior (230), Senior (255), Recreant (65), Donateur (55)

### Phase 124: Fee Calculation Engine
**Goal**: System calculates correct base fees based on member type and age group
**Depends on**: Phase 123
**Plans**: 2 plans

Plans:
- [x] 124-01: Core calculation logic (age group parsing, member type detection, calculate_fee method)
- [x] 124-02: Season snapshot and caching (season key, snapshot storage, get_fee_for_person API)

**Details:**
- Age group parsing with "Meiden" suffix handling
- Team type detection for Recreant/Walking Football and Donateur
- Season-based caching with July 1 boundary (YYYY-YYYY format)
- Diagnostic status for non-calculable members
- Public API: get_fee_for_person() with caching options

### Phase 125: Family Discount
**Goal**: Youth members at same address receive tiered family discounts
**Depends on**: Phase 124
**Plans**: 2 plans

Plans:
- [x] 125-01: Address normalization and family grouping (normalize_postal_code, extract_house_number, get_family_key, build_family_groups)
- [x] 125-02: Tiered discount calculation logic (get_family_discount_rate, calculate_fee_with_family_discount)

**Details:**
- Address normalization: postal code + house number for family grouping
- Family key format: POSTALCODE-HOUSENUMBER (ignoring street name)
- Tiered discounts: 0% (1st), 25% (2nd), 50% (3rd+) applied to cheapest members first
- Non-youth (senior, recreant, donateur) excluded from family discount

### Phase 126: Pro-rata & UI
**Goal**: Users can view calculated fees with pro-rata
**Depends on**: Phase 125
**Plans**: 3 plans

Plans:
- [x] 126-01: Pro-rata calculation based on Sportlink join date (get_prorata_percentage, calculate_full_fee)
- [x] 126-02: Contributie list page and REST endpoint (sidebar nav, /fees endpoint, ContributieList.jsx)
- [x] 126-03: Address mismatch filter for sibling detection

**Details:**
- Quarterly pro-rata: 100% (Jul-Sep), 75% (Oct-Dec), 50% (Jan-Mar), 25% (Apr-Jun)
- REST endpoint: /stadion/v1/fees with season parameter
- Contributie list with 7 columns, sortable, category badges
- Amber highlighting for pro-rata < 100%, green for family discounts
- Address mismatch detection for siblings with different addresses

### Phase 127: Fee Caching
**Goal**: Fees are cached per person for fast list loading and correct pro-rata calculation
**Depends on**: Phase 126
**Plans**: 3 plans

Plans:
- [x] 127-01: Fix PRO-04 bug (lid-sinds), cache storage methods
- [x] 127-02: FeeCacheInvalidator class with ACF hooks
- [x] 127-03: REST endpoint optimization, bulk recalculation

**Details:**
- Pro-rata now uses `lid-sinds` field (not `registratiedatum`)
- Cached fees in person meta: _fee_base, _fee_family_discount, _fee_prorata, _fee_final
- FeeCacheInvalidator with hooks for age group, address, team, lid-sinds changes
- Settings change triggers bulk cache invalidation with 10-second delay cron
- Fee list loads < 1 second with 1400+ members

### Phase 127.1: Nikki Integration (INSERTED)
**Goal**: Match Nikki contribution data to calculated fees, display comparison in Contributie list
**Depends on**: Phase 127
**Plans**: 2 plans (1 skipped)

Plans:
- [x] 127.1-01: WP-CLI import command (SKIPPED - external process handles import)
- [x] 127.1-02: REST API and UI extension (nikki_total/nikki_saldo in API, new columns in ContributieList)

**Details:**
- REST API returns nikki_total and nikki_saldo per member
- Nikki year mapping: 2025 data = season 2025-2026
- Contributie list shows Nikki Total and Saldo columns
- Red/green color coding: positive saldo (owes money) = red, zero/negative = green
- All monetary values display with 2 decimal places

### Phase 128: Google Sheets Export
**Goal**: Users can export fee data to Google Sheets
**Depends on**: Phase 127.1
**Plans**: 1 plan

Plans:
- [x] 128-01: Backend export endpoint and frontend button

**Details:**
- Export button on Contributie page with FileSpreadsheet icon
- POST /stadion/v1/google-sheets/export-fees endpoint
- 10 Dutch-labeled columns: Naam, Relatiecode, Categorie, Leeftijdsgroep, Basis, Gezinskorting, Pro-rata %, Bedrag, Nikki Total, Saldo
- nl_NL locale for Euro currency formatting
- Totals row at bottom (Basis and Bedrag only)
- Auto-opens spreadsheet in new browser tab

---

## Milestone Summary

**Key Decisions:**
- Single option array for fee storage (efficient retrieval, follows VOGEmail pattern)
- Season key format: YYYY-YYYY (e.g., 2025-2026) for human readability
- Family key format: POSTALCODE-HOUSENUMBER (street name ignored for matching flexibility)
- Tiered discount: 0%/25%/50% for position 1/2/3+ (per FAM requirements)
- Quarterly pro-rata tiers: 100%/75%/50%/25% (simple, fair for sports season structure)
- Separate cache meta key from snapshot (cache uses stadion_fee_cache_, snapshot uses fee_snapshot_)
- Null vs 0 for missing Nikki data (distinguishes "no data" from "zero balance")
- Red/green color coding for saldo (positive owes money = red)

**Issues Resolved:**
- PRO-04: Fixed pro-rata to use `lid-sinds` field instead of `registratiedatum`
- Address invalidation uses OLD family key (ensures siblings in old family get cache cleared)
- 10-second cron delay for bulk recalculation (gives system time to settle)

**Issues Deferred:**
- Payment tracking (paid/unpaid) - deferred to future milestone
- Invoice generation - external system handles invoicing
- Payment reminders - deferred to future milestone
- Multiple seasons support - focus on current season only

**Technical Debt Incurred:**
- lid-sinds field relies on external Sportlink data import - not ACF field created in Stadion
- Pro-rata calculation expects lid-sinds populated by external process
- Nikki data import handled by external process (not in Stadion codebase)

---

_For current project status, see .planning/ROADMAP.md_

---
*Archived: 2026-02-01 as part of v12.0 milestone completion*
