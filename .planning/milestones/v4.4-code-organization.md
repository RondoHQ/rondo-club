# Milestone v4.4: Code Organization

**Status:** SHIPPED 2026-01-16
**Phases:** 64-66
**Total Plans:** 6

## Overview

Reorganize PHP codebase with proper structure, one-class-per-file compliance, and PSR-4 autoloading. This milestone transforms the codebase from manual class loading to modern Composer-based autoloading with proper namespaces.

## Phases

### Phase 64: Audit & Planning

**Goal**: Identify multi-class files, design folder structure, plan namespace hierarchy
**Depends on**: v4.3 complete
**Plans**: 1 plan

Plans:
- [x] 64-01: Complete codebase audit, folder structure, namespace hierarchy

**Result**: Comprehensive AUDIT.md with 1 multi-class file identified (class-notification-channels.php with 3 classes), 9-folder structure designed, Caelis\ namespace hierarchy planned for 41 classes.

### Phase 65: Split & Reorganize

**Goal**: Split multi-class file and achieve one-class-per-file compliance
**Depends on**: Phase 64
**Plans**: 1 plan

Plans:
- [x] 65-01: Split notification classes, update autoloader, enable PHPCS rule

**Result**: Split PRM_Notification_Channel, PRM_Email_Channel, PRM_Slack_Channel into separate files. Enabled PHPCS Generic.Files.OneClassPerFile rule. Added WP-CLI exclusion (9 CLI command classes kept together).

### Phase 66: PSR-4 Autoloader

**Goal**: Implement Composer autoloading with namespaces, remove manual requires
**Depends on**: Phase 65
**Plans**: 4 plans

Plans:
- [x] 66-01: Add Caelis\Core and Caelis\REST namespaces (15 classes)
- [x] 66-02: Add Caelis\Calendar, Caelis\Notifications, Caelis\Collaboration namespaces (14 classes)
- [x] 66-03: Add Caelis\Import, Caelis\Export, Caelis\CardDAV, Caelis\Data namespaces (9 classes)
- [x] 66-04: Update references, add backward compatibility aliases, finalize autoloader

**Result**: 38 classes with PSR-4 namespaces across 9 namespace groups. Composer autoloading configured with classmap. 38 backward-compatible class aliases. Manual prm_autoloader() removed (52 lines).

---

## Milestone Summary

**Namespace Groups:**
- Caelis\Core (6 classes): PostTypes, Taxonomies, AccessControl, Visibility, UserRoles, AutoTitle
- Caelis\REST (9 classes): Base, Api, People, Companies, Todos, Workspaces, Slack, ImportExport, Calendar
- Caelis\Calendar (6 classes): Connections, Matcher, Sync, GoogleProvider, CalDAVProvider, GoogleOAuth
- Caelis\Notifications (3 classes): Channel, EmailChannel, SlackChannel
- Caelis\Collaboration (5 classes): CommentTypes, WorkspaceMembers, Mentions, MentionNotifications, Reminders
- Caelis\Import (3 classes): Monica, VCard, GoogleContacts
- Caelis\Export (2 classes): VCard, ICalFeed
- Caelis\CardDAV (4 classes): Server, AuthBackend, CardDAVBackend, PrincipalBackend
- Caelis\Data (3 classes): InverseRelationships, TodoMigration, CredentialEncryption

**Key Decisions:**
- WP-CLI multi-class exception: Keep 9 CLI command classes together (conditionally loaded, logically grouped)
- Composer classmap alongside PSR-4: Support current class-*.php naming during transition
- Backward-compatible aliases: All PRM_* class names still work via class_alias()

**Issues Resolved During Deployment:**
- Global PHP classes (WP_Error, Exception, DateTime, etc.) need `\` prefix in namespaced files
- PRM_* class aliases need `\` prefix when called from namespaced code
- PHP constants (PRM_THEME_DIR, etc.) need `\` prefix in namespaced files

**Technical Debt Incurred:**
- Files still named class-*.php (PSR-4 convention would be ClassName.php)
- Classes still in includes/ flat directory (PSR-4 convention would be src/Namespace/ClassName.php)
- Backward-compatible aliases should be removed in future version

---

_For current project status, see .planning/ROADMAP.md_
