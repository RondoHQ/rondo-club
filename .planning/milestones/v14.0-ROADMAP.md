# Milestone v14.0: Performance Optimization

**Status:** SHIPPED 2026-02-04
**Phases:** 135-138
**Total Plans:** 5

## Overview

Eliminate unnecessary API calls and optimize dashboard load time by fixing duplicate requests on page load, implementing conditional data loading for modals, deduplicating React Query queries across components, and optimizing backend count queries to use proper SQL COUNT operations instead of fetching all records.

## Phases

### Phase 135: Fix Duplicate API Calls

**Goal**: All page loads make single API call per endpoint (not 2x)
**Depends on**: Nothing (first phase)
**Plans**: 2 plans

Plans:
- [x] 135-01-PLAN.md - Optimize QueryClient defaults (add refetchOnWindowFocus: false)
- [x] 135-02-PLAN.md - Migrate to createBrowserRouter data router pattern (gap closure)

**Details:**
- Added `refetchOnWindowFocus: false` to QueryClient defaultOptions
- Migrated from BrowserRouter (JSX routes) to createBrowserRouter (data routes)
- Fixed ES module double-load by removing ?ver= query string from wp_enqueue_script
- Documented React Query's built-in concurrent request deduplication

### Phase 136: Modal Lazy Loading

**Goal**: Modals with people selectors do not load data until opened
**Depends on**: Phase 135
**Plans**: 1 plan

Plans:
- [x] 136-01-PLAN.md - Add enabled option to usePeople and update modals

**Details:**
- Extended usePeople hook with optional `{ enabled }` option
- QuickActivityModal fetches people only when modal opens
- TodoModal fetches people only when modal opens
- GlobalTodoModal fetches people only when modal opens
- Dashboard loads without unnecessary /wp/v2/person API calls

### Phase 137: Query Deduplication

**Goal**: Single shared queries for current-user and cached VOG count
**Depends on**: Phase 136
**Plans**: 1 plan

Plans:
- [x] 137-01-PLAN.md - Create useCurrentUser hook and configure VOG count caching

**Details:**
- Created useCurrentUser hook used by 6 components (ApprovalCheck, FairplayRoute, Sidebar, UserMenu, FinancesCard, PersonDetail)
- Added options parameter to useFilteredPeople enabling staleTime configuration
- VOG count now cached for 5 minutes, preventing refetch on every navigation
- Single cache entry shared by all current-user consumers

### Phase 138: Backend Query Optimization

**Goal**: Todo count queries use SQL COUNT instead of fetching all records
**Depends on**: Phase 137
**Plans**: 1 plan

Plans:
- [x] 138-01-PLAN.md - Optimize todo count functions with wp_count_posts()

**Details:**
- Optimized count_open_todos() to use wp_count_posts() instead of get_posts()
- Optimized count_awaiting_todos() to use wp_count_posts() instead of get_posts()
- Dashboard stats load faster with efficient SQL COUNT queries

---

## Milestone Summary

**Key Decisions:**
- Disabled refetchOnWindowFocus to prevent unnecessary API calls on tab switches
- Migrated from BrowserRouter (JSX routes) to createBrowserRouter (data routes) for single-mount guarantee
- Removed version query string from ES module to prevent double-mount (browser ES module cache keys by full URL)
- Used 5-minute staleTime for current-user to balance freshness and performance
- Default enabled=true for usePeople backward compatibility

**Issues Resolved:**
- Duplicate API calls on every page load (2x per endpoint)
- QuickActivityModal loading 1400+ people records on dashboard
- Multiple redundant current-user queries across components
- VOG count refetching on every navigation
- Inefficient backend todo count queries using get_posts() with posts_per_page=-1

**Issues Deferred:**
None

**Technical Debt Incurred:**
None

---

*For current project status, see .planning/ROADMAP.md*
