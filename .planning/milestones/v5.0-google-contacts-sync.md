# Milestone v5.0: Google Contacts Two-Way Sync

**Status:** DRAFT
**Target:** TBD
**Phases:** TBD

## Overview

Enable bidirectional synchronization between Caelis and Google Contacts, allowing users to:
- Import contacts from Google Contacts with full metadata (photos, emails, phones, addresses, birthdays)
- Export Caelis contacts to Google Contacts
- Keep both systems in sync with automatic change detection and propagation
- Handle conflicts when contacts are edited in both places

This builds on the existing Google OAuth infrastructure (used for Calendar) and the one-way Google Contacts CSV import, replacing the manual CSV workflow with a seamless API-based sync.

## Goals

1. **Seamless Integration**: Users connect once via OAuth, then contacts sync automatically
2. **Data Integrity**: No data loss during sync; conflicts are handled gracefully
3. **Privacy Preserving**: Users control which contacts sync; workspace/private boundaries respected
4. **Performance**: Efficient delta sync (only changed contacts), not full re-import each time
5. **Familiar Pattern**: Consistent with existing Calendar integration UX

## Non-Goals

- Real-time sync (webhook-based) - will use polling/cron like Calendar
- Syncing to multiple Google accounts simultaneously (future enhancement)
- Syncing companies/organizations as separate Google Contact groups (contacts only)
- Two-way relationship sync (Google doesn't have relationship concepts)

---

## Requirements

### Functional Requirements

#### FR1: OAuth Connection
- [ ] Extend existing Google OAuth to request `contacts.readonly` and `contacts` scopes
- [ ] Support incremental scope addition (users with Calendar-only can add Contacts)
- [ ] Store connection status in user meta alongside Calendar connection
- [ ] Display connection status in Settings > Connections

#### FR2: Initial Import
- [ ] Pull all contacts from user's Google Contacts via People API
- [ ] Map Google Contact fields to Caelis person fields:
  - `names[0].givenName` → `first_name`
  - `names[0].familyName` → `last_name`
  - `nicknames[0].value` → `nickname`
  - `photos[0].url` → featured image (sideload)
  - `emailAddresses[]` → `contact_info` (type: email)
  - `phoneNumbers[]` → `contact_info` (type: phone/mobile)
  - `addresses[]` → `addresses` repeater
  - `urls[]` → `contact_info` (type: website/linkedin/twitter/etc.)
  - `birthdays[0]` → `important_date` (type: birthday)
  - `biographies[0].value` → `story` field
  - `organizations[0]` → `work_history` (create company if needed)
- [ ] Detect and handle duplicates (match by email first, then name)
- [ ] Store `google_contact_id` (resourceName) on each imported person
- [ ] Store `google_etag` for change detection
- [ ] Track sync timestamp per contact

#### FR3: Export to Google
- [ ] Push new Caelis contacts to Google Contacts
- [ ] Create Google Contact with mapped fields (reverse of import mapping)
- [ ] Store returned `resourceName` as `google_contact_id`
- [ ] Only export contacts marked for sync (opt-in or by visibility)

#### FR4: Ongoing Sync
- [ ] Background sync via WP-Cron (configurable interval: 15min to daily)
- [ ] Delta sync using `syncToken` from People API
- [ ] Detect changes in Google (new, modified, deleted contacts)
- [ ] Detect changes in Caelis (track `post_modified` vs `last_synced`)
- [ ] Propagate changes bidirectionally

#### FR5: Conflict Resolution
- [ ] Detect conflicts (contact modified in both systems since last sync)
- [ ] Default strategy: Most recent wins (based on modification timestamp)
- [ ] Alternative strategies (user configurable):
  - Google wins
  - Caelis wins
  - Manual review (queue conflicts for user decision)
- [ ] Log all conflict resolutions for audit

#### FR6: Deletion Handling
- [ ] When contact deleted in Google: Option to delete in Caelis or unlink
- [ ] When contact deleted in Caelis: Option to delete in Google or unlink
- [ ] Default: Unlink only (safe default, no data loss)
- [ ] User preference for deletion propagation

#### FR7: Sync Controls
- [ ] Per-contact sync toggle (some contacts may be Caelis-only)
- [ ] Bulk enable/disable sync
- [ ] Sync direction preference (bidirectional, import-only, export-only)
- [ ] Contact group/label filtering (only sync contacts with specific Google labels)

#### FR8: Settings UI
- [ ] Google Contacts connection card in Settings > Connections
- [ ] Connect/Disconnect buttons
- [ ] Sync status display (last sync time, contacts synced, errors)
- [ ] Manual "Sync Now" button
- [ ] Sync preferences panel:
  - Sync frequency dropdown
  - Sync direction dropdown
  - Conflict resolution strategy dropdown
  - Deletion behavior dropdown
- [ ] Sync history/log viewer

#### FR9: Person Detail Integration
- [ ] Show sync status indicator on person profile
- [ ] "Synced with Google" badge with last sync time
- [ ] Link to view contact in Google Contacts
- [ ] Manual "Sync this contact" action
- [ ] "Unlink from Google" action

### Non-Functional Requirements

#### NFR1: Performance
- Sync should process 100 contacts in under 30 seconds
- Delta sync should complete in under 10 seconds for typical changes
- Background sync should not impact site performance

#### NFR2: Reliability
- Failed syncs should retry with exponential backoff
- Partial failures should not corrupt data
- Sync state should be recoverable after crashes

#### NFR3: Security
- OAuth tokens encrypted at rest (existing Sodium encryption)
- Minimal scope requests (only contacts, not full Google account)
- Token refresh handled automatically before expiration

#### NFR4: Scalability
- Support up to 10,000 contacts per user
- Pagination for large contact lists
- Rate limiting compliance with Google API quotas

---

## Technical Design

### Database Schema Additions

```php
// New post meta fields on 'person' post type
'_google_contact_id'     // string: Google People API resourceName (e.g., "people/c12345")
'_google_etag'           // string: ETag for change detection
'_google_sync_enabled'   // bool: Whether this contact should sync
'_google_last_synced'    // datetime: Last successful sync timestamp
'_google_sync_status'    // enum: 'synced', 'pending_push', 'pending_pull', 'conflict', 'unlinked'
'_google_raw_data'       // json: Cached Google contact data for conflict resolution

// New user meta fields
'caelis_google_contacts_sync_token'    // string: People API sync token for delta sync
'caelis_google_contacts_last_sync'     // datetime: Last full sync timestamp
'caelis_google_contacts_sync_enabled'  // bool: Master switch for contacts sync
'caelis_google_contacts_sync_frequency'// string: '15min', '1hour', '6hours', 'daily'
'caelis_google_contacts_sync_direction'// string: 'bidirectional', 'import', 'export'
'caelis_google_contacts_conflict_mode' // string: 'newest', 'google', 'caelis', 'manual'
'caelis_google_contacts_delete_mode'   // string: 'unlink', 'propagate'
```

### New PHP Classes

```
includes/
├── class-google-contacts-provider.php   # People API client, CRUD operations
├── class-google-contacts-sync.php       # Sync orchestration, delta detection
├── class-google-contacts-mapper.php     # Field mapping between Google and Caelis
├── class-google-contacts-conflict.php   # Conflict detection and resolution
└── class-rest-google-contacts.php       # REST API endpoints for UI
```

### Class Responsibilities

#### `Caelis\Calendar\GoogleContactsProvider`
- Authenticate with People API using existing OAuth tokens
- CRUD operations: get, create, update, delete contacts
- Handle pagination for large contact lists
- Manage syncToken for delta sync
- Rate limiting and retry logic

#### `Caelis\Calendar\GoogleContactsSync`
- Orchestrate full and delta sync operations
- Track sync state per contact
- Trigger sync via cron or manual request
- Queue and process sync jobs
- Log sync operations

#### `Caelis\Calendar\GoogleContactsMapper`
- Map Google Contact fields → Caelis person fields
- Map Caelis person fields → Google Contact fields
- Handle field type conversions (dates, phones, etc.)
- Normalize data formats

#### `Caelis\Calendar\GoogleContactsConflict`
- Detect conflicts (both sides modified)
- Apply resolution strategy
- Queue manual conflicts for review
- Merge non-conflicting field changes

#### `Caelis\REST\GoogleContacts`
- `GET /prm/v1/google-contacts/status` - Connection and sync status
- `POST /prm/v1/google-contacts/connect` - Initiate OAuth flow
- `POST /prm/v1/google-contacts/disconnect` - Revoke and cleanup
- `POST /prm/v1/google-contacts/sync` - Trigger manual sync
- `GET /prm/v1/google-contacts/conflicts` - List pending conflicts
- `POST /prm/v1/google-contacts/conflicts/{id}/resolve` - Resolve conflict
- `GET /prm/v1/google-contacts/log` - Sync history

### React Components

```
src/
├── pages/Settings/
│   └── ConnectionsTab/
│       └── GoogleContactsCard.jsx    # Connection card with status, actions
├── components/
│   ├── GoogleContactsSyncStatus.jsx  # Sync indicator for person detail
│   ├── GoogleContactsConflictModal.jsx # Manual conflict resolution
│   └── SyncLogViewer.jsx             # Sync history display
```

### API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/prm/v1/google-contacts/status` | Get connection status, last sync, stats |
| POST | `/prm/v1/google-contacts/connect` | Start OAuth flow (returns auth URL) |
| GET | `/prm/v1/google-contacts/callback` | OAuth callback handler |
| DELETE | `/prm/v1/google-contacts/disconnect` | Revoke access, cleanup |
| POST | `/prm/v1/google-contacts/sync` | Trigger immediate sync |
| GET | `/prm/v1/google-contacts/preferences` | Get sync preferences |
| PUT | `/prm/v1/google-contacts/preferences` | Update sync preferences |
| GET | `/prm/v1/google-contacts/conflicts` | List unresolved conflicts |
| POST | `/prm/v1/google-contacts/conflicts/{id}` | Resolve a conflict |
| GET | `/prm/v1/google-contacts/log` | Get sync history |
| POST | `/prm/v1/people/{id}/google-sync` | Sync single contact |
| DELETE | `/prm/v1/people/{id}/google-link` | Unlink contact from Google |

### Google People API Integration

**Scopes Required:**
- `https://www.googleapis.com/auth/contacts` (read/write)
- Or `https://www.googleapis.com/auth/contacts.readonly` (import-only mode)

**Key API Endpoints:**
- `people.connections.list` - List user's contacts with syncToken support
- `people.get` - Get single contact by resourceName
- `people.createContact` - Create new contact
- `people.updateContact` - Update existing contact
- `people.deleteContact` - Delete contact

**Sync Token Flow:**
1. First sync: Call `connections.list` without syncToken, get all contacts
2. Store returned `nextSyncToken` in user meta
3. Subsequent syncs: Call with stored syncToken, get only changes
4. If syncToken expired (410 error): Full re-sync

### Field Mapping Reference

| Google People API | Caelis Field | Notes |
|-------------------|--------------|-------|
| `names[0].givenName` | `first_name` | ACF field |
| `names[0].familyName` | `last_name` | ACF field |
| `names[0].displayName` | `post_title` | Auto-generated |
| `nicknames[0].value` | `nickname` | ACF field |
| `photos[0].url` | `_thumbnail_id` | Sideload as attachment |
| `emailAddresses[].value` | `contact_info[]` | type: email |
| `emailAddresses[].type` | `contact_info[].contact_label` | Work, Home, etc. |
| `phoneNumbers[].value` | `contact_info[]` | type: phone/mobile |
| `phoneNumbers[].type` | `contact_info[].contact_label` | Mobile, Work, Home |
| `addresses[].streetAddress` | `addresses[].street` | ACF repeater |
| `addresses[].city` | `addresses[].city` | |
| `addresses[].region` | `addresses[].state` | |
| `addresses[].postalCode` | `addresses[].postal_code` | |
| `addresses[].country` | `addresses[].country` | |
| `addresses[].type` | `addresses[].address_label` | Work, Home, etc. |
| `urls[].value` | `contact_info[]` | Detect type from URL |
| `birthdays[0].date` | `important_date` | Create with type: birthday |
| `biographies[0].value` | `story` | ACF WYSIWYG field |
| `organizations[0].name` | `work_history[].company` | Create company if needed |
| `organizations[0].title` | `work_history[].job_title` | |
| `organizations[0].current` | `work_history[].is_current` | |
| `resourceName` | `_google_contact_id` | Post meta |
| `etag` | `_google_etag` | Post meta |

### Sync State Machine

```
┌─────────────┐
│   UNLINKED  │ ←── Contact exists only in Caelis, no Google link
└──────┬──────┘
       │ Export to Google
       ▼
┌─────────────┐
│   SYNCED    │ ←── Contact synced, no pending changes
└──────┬──────┘
       │
   ┌───┴───┐
   │       │
   ▼       ▼
┌──────────────┐  ┌──────────────┐
│ PENDING_PUSH │  │ PENDING_PULL │
│ (Caelis edit)│  │ (Google edit)│
└──────┬───────┘  └───────┬──────┘
       │                  │
       └────────┬─────────┘
                │ Both edited?
                ▼
         ┌─────────────┐
         │  CONFLICT   │
         └──────┬──────┘
                │ Resolved
                ▼
         ┌─────────────┐
         │   SYNCED    │
         └─────────────┘
```

### Cron Schedule

```php
// Register cron event per user (like calendar sync)
add_action('caelis_google_contacts_sync', [$this, 'process_user_sync'], 10, 1);

// Schedule based on user preference
wp_schedule_single_event(
    $next_sync_time,
    'caelis_google_contacts_sync',
    ['user_id' => $user_id]
);
```

### WP-CLI Commands

```bash
# Trigger sync for a user
wp caelis google-contacts sync --user-id=1

# Full re-sync (ignore sync token)
wp caelis google-contacts sync --user-id=1 --full

# Check sync status
wp caelis google-contacts status --user-id=1

# List conflicts
wp caelis google-contacts conflicts --user-id=1

# Resolve conflict
wp caelis google-contacts resolve --contact-id=123 --strategy=google

# Unlink all contacts (keeps data, removes Google IDs)
wp caelis google-contacts unlink-all --user-id=1
```

---

## Implementation Phases

### Phase 1: Infrastructure & OAuth Extension
**Goal:** Extend Google OAuth to support Contacts scope, create provider class

- [ ] Update `GoogleOAuth` class to support additional scopes
- [ ] Create `GoogleContactsProvider` class with People API client
- [ ] Add user meta fields for sync configuration
- [ ] Add post meta fields for contact sync state
- [ ] REST endpoint for connection status

**Key Files:**
- `includes/class-google-oauth.php` (modify)
- `includes/class-google-contacts-provider.php` (new)

### Phase 2: Import from Google
**Goal:** One-way import via API (replace CSV import)

- [ ] Create `GoogleContactsMapper` class for field mapping
- [ ] Implement `connections.list` with pagination
- [ ] Import contacts with full field mapping
- [ ] Duplicate detection (email-first, then name)
- [ ] Photo sideloading from Google
- [ ] Birthday creation as important_date
- [ ] Company creation from organizations
- [ ] Store Google IDs and ETags

**Key Files:**
- `includes/class-google-contacts-mapper.php` (new)
- `includes/class-google-contacts-provider.php` (extend)

### Phase 3: Export to Google
**Goal:** Push new Caelis contacts to Google

- [ ] Implement `createContact` API call
- [ ] Reverse field mapping (Caelis → Google format)
- [ ] Handle photo upload to Google
- [ ] Store returned resourceName
- [ ] Bulk export for existing contacts

**Key Files:**
- `includes/class-google-contacts-mapper.php` (extend)
- `includes/class-google-contacts-provider.php` (extend)

### Phase 4: Delta Sync & Change Detection
**Goal:** Efficient ongoing sync using syncToken

- [ ] Create `GoogleContactsSync` orchestration class
- [ ] Implement syncToken-based delta sync
- [ ] Track Caelis changes via `post_modified`
- [ ] Detect which side changed
- [ ] Background sync via WP-Cron
- [ ] Rate limiting and error handling

**Key Files:**
- `includes/class-google-contacts-sync.php` (new)

### Phase 5: Conflict Resolution
**Goal:** Handle simultaneous edits gracefully

- [ ] Create `GoogleContactsConflict` class
- [ ] Detect conflicts (both modified since last sync)
- [ ] Implement resolution strategies (newest/google/caelis/manual)
- [ ] Queue manual conflicts
- [ ] Conflict resolution UI
- [ ] Audit logging

**Key Files:**
- `includes/class-google-contacts-conflict.php` (new)
- `src/components/GoogleContactsConflictModal.jsx` (new)

### Phase 6: Settings UI
**Goal:** User-facing configuration and status

- [ ] Google Contacts connection card in Settings
- [ ] Connect/Disconnect flow
- [ ] Sync preferences panel
- [ ] Sync status and history display
- [ ] Manual sync button

**Key Files:**
- `src/pages/Settings/ConnectionsTab/GoogleContactsCard.jsx` (new)
- `includes/class-rest-google-contacts.php` (new)

### Phase 7: Person Detail Integration
**Goal:** Per-contact sync visibility and controls

- [ ] Sync status badge on person profile
- [ ] "View in Google Contacts" link
- [ ] Per-contact sync toggle
- [ ] "Sync now" action
- [ ] "Unlink" action

**Key Files:**
- `src/components/GoogleContactsSyncStatus.jsx` (new)
- `src/pages/People/PersonDetail.jsx` (modify)

### Phase 8: Polish & Edge Cases
**Goal:** Production-ready reliability

- [ ] Deletion handling (unlink vs propagate)
- [ ] Error recovery and retry logic
- [ ] Sync lock to prevent concurrent syncs
- [ ] WP-CLI commands
- [ ] Documentation
- [ ] Performance optimization for large contact lists

**Key Files:**
- `includes/class-wp-cli.php` (extend)
- `docs/google-contacts-sync.md` (new)

---

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Google API rate limits | Sync failures for large accounts | Implement exponential backoff, batch requests |
| OAuth token expiration | Sync stops working | Auto-refresh before expiration (existing pattern) |
| Data loss from conflicts | User loses edits | Default to safe merge, manual review option |
| Scope creep | Delayed delivery | Strict phase boundaries, MVP first |
| Google API changes | Breaking changes | Version lock, monitoring, fallback to CSV |

---

## Success Metrics

- [ ] Users can connect Google Contacts in under 1 minute
- [ ] Initial import completes within 2 minutes for 1000 contacts
- [ ] Delta sync completes within 10 seconds for typical changes
- [ ] Zero data loss reported in first month
- [ ] 90%+ of connected users have successful daily syncs

---

## Open Questions

1. **Workspace contacts**: Should contacts in workspaces be syncable to Google? (Proposal: No, only private contacts sync to personal Google account)

2. **Multiple Google accounts**: Should we support syncing to multiple Google accounts? (Proposal: Defer to future enhancement)

3. **Contact groups**: Should Caelis labels map to Google Contact groups? (Proposal: Yes, as a future enhancement after core sync works)

4. **Relationship sync**: Google has limited relationship support (spouse, etc.). Should we attempt to sync relationships? (Proposal: No, too complex and lossy)

5. **Photo sync direction**: Should we push Caelis photos to Google, or only pull? (Proposal: Bidirectional, newest wins)

---

## References

- [Google People API Documentation](https://developers.google.com/people)
- [People API Sync Guide](https://developers.google.com/people/contacts-api-migration)
- [Existing Calendar Integration](./v4.0-calendar-integration.md)
- [Existing Google Contacts CSV Import](../includes/class-google-contacts-import.php)

---

*Last updated: 2026-01-17*
