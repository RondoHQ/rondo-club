# Milestone v5.1: Gmail Integration

**Status:** DRAFT
**Target:** TBD (after v5.0 Google Contacts Sync)
**Phases:** TBD
**Depends on:** v5.0 Google Contacts Sync (shared OAuth infrastructure)

## Overview

Integrate Gmail with Stadion to automatically track email correspondence with contacts, enabling users to:
- See recent email threads with a contact on their profile
- Log emails as activities in the contact timeline
- Compose and send emails directly from contact pages
- Get notified when important contacts email them
- Search across email history with contacts

This builds on the Google OAuth infrastructure established in v4.0 (Calendar) and extended in v5.0 (Contacts), adding Gmail scopes to create a unified Google integration suite.

## Goals

1. **Relationship Context**: Surface email history on contact profiles for better relationship awareness
2. **Activity Completeness**: Emails become part of the contact timeline alongside calls, meetings, notes
3. **Reduced Context Switching**: Compose emails without leaving Stadion
4. **Privacy First**: Email content stays in Gmail; Stadion stores metadata and references only
5. **Consistent UX**: Same patterns as Calendar/Contacts integration

## Non-Goals

- Full email client replacement (not trying to be Gmail)
- Email templates or mail merge functionality (future enhancement)
- Mass email campaigns or marketing automation
- Email archiving or backup (Gmail remains source of truth)
- Real-time email push notifications (will use polling like Calendar)

---

## Requirements

### Functional Requirements

#### FR1: OAuth Connection
- [ ] Extend Google OAuth to request Gmail scopes (`gmail.readonly`, `gmail.send`, `gmail.compose`)
- [ ] Support incremental scope addition (users with Calendar/Contacts can add Gmail)
- [ ] Single "Google" connection card managing all Google services
- [ ] Per-service toggles (Calendar: on, Contacts: on, Gmail: on/off)
- [ ] Clear permission explanation before requesting Gmail access

#### FR2: Email Thread Display
- [ ] Show recent email threads on person detail page
- [ ] Match emails by contact's email addresses (from `contact_info` field)
- [ ] Display thread subject, snippet, date, and read/unread status
- [ ] Paginate/load more for contacts with extensive email history
- [ ] Click thread to open in Gmail (new tab)
- [ ] Cache thread metadata locally for performance

#### FR3: Email as Activity
- [ ] "Log as Activity" button on email threads
- [ ] Create activity with type "email" and link to Gmail thread
- [ ] Auto-extract: subject as title, date, participants
- [ ] Option to add notes when logging
- [ ] Logged emails appear in contact timeline with Gmail icon
- [ ] Link in timeline opens original email in Gmail

#### FR4: Auto-Logging (Optional)
- [ ] User preference to auto-log all emails with contacts
- [ ] Background sync creates activities for new sent/received emails
- [ ] Configurable: log sent only, received only, or both
- [ ] Deduplication: don't re-log same email thread
- [ ] Respect per-contact "don't auto-log" override

#### FR5: Compose from Stadion
- [ ] "Send Email" button on person detail page
- [ ] Pre-fill recipient from contact's primary email
- [ ] Simple compose modal: To, Subject, Body (plain text + basic formatting)
- [ ] Send via Gmail API (appears in user's Sent folder)
- [ ] Auto-log sent email as activity
- [ ] Support CC/BCC fields
- [ ] Attachment support (upload and attach files)

#### FR6: Reply from Stadion
- [ ] "Reply" button on email threads shown in Stadion
- [ ] Quote original message in reply
- [ ] Maintain thread context (In-Reply-To header)
- [ ] Reply appears in Gmail as part of thread

#### FR7: Email Search
- [ ] Search emails with a specific contact from their profile
- [ ] Full-text search within threads (uses Gmail search)
- [ ] Filter by date range
- [ ] Results link to Gmail threads

#### FR8: Contact Matching
- [ ] Match incoming emails to contacts by email address
- [ ] Handle multiple email addresses per contact
- [ ] Case-insensitive email matching
- [ ] Suggest "Add to Stadion" for frequent unmatched senders
- [ ] Integration with Google Contacts sync (emails already mapped)

#### FR9: Email Notifications (Optional)
- [ ] Notify when email received from "favorite" contacts
- [ ] Configurable notification channels (existing email/Slack system)
- [ ] Digest mode: daily summary of emails from tracked contacts
- [ ] Don't duplicate Gmail's own notifications

#### FR10: Settings UI
- [ ] Gmail toggle in Google connection card
- [ ] Sync preferences:
  - Auto-log emails (on/off)
  - Auto-log direction (sent/received/both)
  - Check frequency (15min to daily)
- [ ] Per-contact email tracking override
- [ ] Email signature for compose (optional)

#### FR11: Person Detail Integration
- [ ] "Emails" tab or section on person profile
- [ ] Recent threads list with quick actions
- [ ] "Compose" floating action button
- [ ] Email count badge showing unread from contact
- [ ] Collapsible email section to save space

### Non-Functional Requirements

#### NFR1: Performance
- Thread list should load within 2 seconds
- Compose/send should complete within 5 seconds
- Background sync should not impact site performance

#### NFR2: Privacy & Security
- Email body content NOT stored in Stadion database
- Only metadata cached: subject, snippet, date, participants, thread ID
- OAuth tokens encrypted at rest (existing pattern)
- Users can revoke Gmail access independently

#### NFR3: Reliability
- Graceful degradation if Gmail API unavailable
- Retry logic for transient failures
- Clear error messages for auth issues

#### NFR4: Quotas
- Respect Gmail API quotas (250 quota units/user/second)
- Batch requests where possible
- Implement exponential backoff

---

## Technical Design

### Database Schema Additions

```php
// New post meta fields on 'person' post type
'_gmail_last_thread_check'  // datetime: Last time we checked for new threads
'_gmail_thread_count'       // int: Cached count of threads with this contact
'_gmail_auto_log'           // bool: Override for auto-logging (null = use global setting)

// Activity comment meta (for logged emails)
'_gmail_thread_id'          // string: Gmail thread ID for linking back
'_gmail_message_id'         // string: Specific message ID if logging single email
'_gmail_subject'            // string: Email subject (for display without API call)

// New user meta fields
'stadion_gmail_enabled'           // bool: Master switch for Gmail integration
'stadion_gmail_auto_log'          // bool: Auto-log emails as activities
'stadion_gmail_auto_log_direction'// string: 'sent', 'received', 'both'
'stadion_gmail_check_frequency'   // string: '15min', '1hour', '6hours', 'daily'
'stadion_gmail_last_history_id'   // string: Gmail history ID for incremental sync
'stadion_gmail_signature'         // string: Email signature for compose
```

### New PHP Classes

```
includes/
â”œâ”€â”€ class-gmail-provider.php      # Gmail API client, send/receive/search
â”œâ”€â”€ class-gmail-sync.php          # Background sync, auto-logging orchestration
â”œâ”€â”€ class-gmail-matcher.php       # Match emails to contacts by address
â””â”€â”€ class-rest-gmail.php          # REST API endpoints for UI
```

### Class Responsibilities

#### `Stadion\Google\GmailProvider`
- Authenticate with Gmail API using shared OAuth tokens
- List threads for a set of email addresses
- Get thread/message details
- Send emails (with threading support)
- Search emails
- Handle Gmail history API for incremental sync

#### `Stadion\Google\GmailSync`
- Background sync via WP-Cron
- Detect new emails since last check (history API)
- Auto-create activities for matched emails
- Deduplication logic
- Rate limiting

#### `Stadion\Google\GmailMatcher`
- Match email addresses to Stadion contacts
- Build reverse index: email â†’ person_id
- Handle case normalization
- Integrate with Google Contacts sync data

#### `Stadion\REST\Gmail`
- `GET /rondo/v1/gmail/status` - Connection status
- `GET /rondo/v1/gmail/threads` - List threads for a contact
- `GET /rondo/v1/gmail/threads/{id}` - Get thread details
- `POST /rondo/v1/gmail/send` - Send email
- `POST /rondo/v1/gmail/threads/{id}/log` - Log thread as activity
- `GET /rondo/v1/gmail/search` - Search emails
- `GET /rondo/v1/gmail/preferences` - Get preferences
- `PUT /rondo/v1/gmail/preferences` - Update preferences

### React Components

```
src/
â”œâ”€â”€ pages/People/
â”‚   â””â”€â”€ PersonDetail/
â”‚       â””â”€â”€ EmailsSection.jsx       # Email threads list for contact
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ Gmail/
â”‚   â”‚   â”œâ”€â”€ EmailThreadList.jsx     # List of thread cards
â”‚   â”‚   â”œâ”€â”€ EmailThreadCard.jsx     # Single thread preview
â”‚   â”‚   â”œâ”€â”€ EmailComposeModal.jsx   # Compose/reply modal
â”‚   â”‚   â”œâ”€â”€ EmailLogModal.jsx       # Log email as activity dialog
â”‚   â”‚   â””â”€â”€ EmailSearchModal.jsx    # Search emails with contact
â”‚   â””â”€â”€ Settings/
â”‚       â””â”€â”€ GmailPreferences.jsx    # Gmail-specific settings
```

### API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/rondo/v1/gmail/status` | Gmail connection status, quota usage |
| GET | `/rondo/v1/gmail/threads` | List threads (params: emails[], maxResults, pageToken) |
| GET | `/rondo/v1/gmail/threads/{id}` | Get full thread with messages |
| POST | `/rondo/v1/gmail/send` | Send new email or reply |
| POST | `/rondo/v1/gmail/threads/{id}/log` | Log thread as activity |
| GET | `/rondo/v1/gmail/search` | Search (params: query, emails[], maxResults) |
| GET | `/rondo/v1/gmail/preferences` | Get user's Gmail preferences |
| PUT | `/rondo/v1/gmail/preferences` | Update preferences |
| GET | `/rondo/v1/people/{id}/emails` | Shortcut: threads for a person |
| POST | `/rondo/v1/people/{id}/emails/send` | Shortcut: send to a person |

### Gmail API Integration

**Scopes Required:**
- `https://www.googleapis.com/auth/gmail.readonly` - Read emails and threads
- `https://www.googleapis.com/auth/gmail.send` - Send emails
- `https://www.googleapis.com/auth/gmail.compose` - Create drafts (optional)

**Key API Endpoints:**
- `users.threads.list` - List threads matching query
- `users.threads.get` - Get thread with all messages
- `users.messages.get` - Get single message details
- `users.messages.send` - Send a new message
- `users.history.list` - Incremental changes since historyId

**Thread Query Strategy:**
```
# Find all threads involving contact@example.com
from:contact@example.com OR to:contact@example.com

# For multiple email addresses
(from:addr1@x.com OR to:addr1@x.com) OR (from:addr2@y.com OR to:addr2@y.com)
```

### Data Flow: Email Thread Display

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PersonDetail   â”‚
â”‚    Component    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ usePersonEmails(personId)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   REST API      â”‚
â”‚ /people/{id}/   â”‚
â”‚    emails       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Get contact's email addresses
         â”‚ Build Gmail query
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GmailProvider   â”‚
â”‚ threads.list()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Thread metadata
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EmailsSection   â”‚
â”‚ renders threads â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow: Send Email

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EmailCompose    â”‚
â”‚    Modal        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ POST /gmail/send
         â”‚ { to, subject, body, threadId? }
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GmailProvider   â”‚
â”‚ messages.send() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Returns message ID
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Auto-create     â”‚
â”‚ activity if     â”‚
â”‚ enabled         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow: Auto-Log Background Sync

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WP-Cron       â”‚
â”‚ stadion_gmail_   â”‚
â”‚     sync        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ For each user with Gmail enabled
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GmailSync       â”‚
â”‚ history.list()  â”‚
â”‚ since lastId    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ New message IDs
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GmailMatcher    â”‚
â”‚ Match addresses â”‚
â”‚ to contacts     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Matched person_ids
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create Activity â”‚
â”‚ type: 'email'   â”‚
â”‚ with thread ref â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Activity Integration

Emails logged as activities use the existing `stadion_activity` comment type:

```php
[
    'comment_type'    => 'stadion_activity',
    'comment_post_ID' => $person_id,
    'comment_content' => '', // Optional notes added by user
    'comment_meta'    => [
        'activity_type'     => 'email',
        'activity_date'     => '2026-01-17',
        '_gmail_thread_id'  => 'thread123abc',
        '_gmail_subject'    => 'Re: Project Update',
        'participants'      => [/* other person IDs in thread */],
    ],
]
```

Timeline display shows:
- Email icon (existing `Mail` from lucide-react)
- Subject line as title
- Date of most recent message
- "View in Gmail" link
- Participant avatars if multi-person thread

### Unified Google OAuth Architecture

After v5.0 and v5.1, the Google OAuth system manages three services:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Google Connection                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   Shared OAuth                       â”‚   â”‚
â”‚  â”‚  â€¢ Single authorization flow                         â”‚   â”‚
â”‚  â”‚  â€¢ Combined scopes requested incrementally           â”‚   â”‚
â”‚  â”‚  â€¢ One refresh token for all services                â”‚   â”‚
â”‚  â”‚  â€¢ Centralized token storage & refresh               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Calendar   â”‚  â”‚  Contacts   â”‚  â”‚   Gmail     â”‚        â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚        â”‚
â”‚  â”‚  âœ“ Enabled  â”‚  â”‚  âœ“ Enabled  â”‚  â”‚  â—‹ Disabled â”‚        â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚        â”‚
â”‚  â”‚  Scopes:    â”‚  â”‚  Scopes:    â”‚  â”‚  Scopes:    â”‚        â”‚
â”‚  â”‚  calendar.  â”‚  â”‚  contacts   â”‚  â”‚  gmail.     â”‚        â”‚
â”‚  â”‚  readonly   â”‚  â”‚  contacts.  â”‚  â”‚  readonly   â”‚        â”‚
â”‚  â”‚             â”‚  â”‚  readonly   â”‚  â”‚  gmail.send â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Incremental Scope Request Flow

```
User has: Calendar only
User clicks: "Enable Gmail"

1. Check current token scopes
2. Calculate additional scopes needed
3. Redirect to Google with:
   - include_granted_scopes=true
   - scope=gmail.readonly gmail.send
4. User approves additional access
5. Google returns token with ALL scopes
6. Update stored credentials
7. Enable Gmail features
```

### Privacy Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     What's Stored Where                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Gmail (Google's servers):                                  â”‚
â”‚  â”œâ”€â”€ Full email content                                     â”‚
â”‚  â”œâ”€â”€ Attachments                                            â”‚
â”‚  â”œâ”€â”€ Thread history                                         â”‚
â”‚  â””â”€â”€ Search index                                           â”‚
â”‚                                                             â”‚
â”‚  Stadion Database:                                           â”‚
â”‚  â”œâ”€â”€ OAuth tokens (encrypted)                               â”‚
â”‚  â”œâ”€â”€ Thread IDs (references only)                           â”‚
â”‚  â”œâ”€â”€ Cached metadata:                                       â”‚
â”‚  â”‚   â”œâ”€â”€ Subject lines                                      â”‚
â”‚  â”‚   â”œâ”€â”€ Snippets (first ~100 chars)                        â”‚
â”‚  â”‚   â”œâ”€â”€ Dates                                              â”‚
â”‚  â”‚   â””â”€â”€ Participant email addresses                        â”‚
â”‚  â”œâ”€â”€ Activity log entries (type: email)                     â”‚
â”‚  â””â”€â”€ User preferences                                       â”‚
â”‚                                                             â”‚
â”‚  NOT stored in Stadion:                                      â”‚
â”‚  â”œâ”€â”€ Full email body                                        â”‚
â”‚  â”œâ”€â”€ Attachments                                            â”‚
â”‚  â””â”€â”€ Email headers (except minimal threading info)          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### WP-CLI Commands

```bash
# Check Gmail status for user
wp stadion gmail status --user-id=1

# Trigger email sync for user
wp stadion gmail sync --user-id=1

# List recent threads for a contact
wp stadion gmail threads --person-id=123 --limit=10

# Clear cached email data
wp stadion gmail clear-cache --user-id=1
```

---

## Implementation Phases

### Phase 1: OAuth Extension for Gmail
**Goal:** Add Gmail scopes to existing Google OAuth, unified connection UI

- [ ] Refactor `GoogleOAuth` to support multiple services and incremental scopes
- [ ] Create service-specific scope configuration
- [ ] Update Settings > Connections with unified Google card
- [ ] Per-service enable/disable toggles
- [ ] Scope explanation UI before requesting Gmail access

**Key Files:**
- `includes/class-google-oauth.php` (refactor)
- `src/pages/Settings/ConnectionsTab/GoogleCard.jsx` (new/refactor)

### Phase 2: Thread List Display
**Goal:** Show email threads on person profile

- [ ] Create `GmailProvider` class with threads.list
- [ ] Create `GmailMatcher` for email â†’ contact matching
- [ ] REST endpoint: `GET /rondo/v1/people/{id}/emails`
- [ ] `EmailsSection` component for PersonDetail
- [ ] `EmailThreadCard` component
- [ ] Pagination support

**Key Files:**
- `includes/class-gmail-provider.php` (new)
- `includes/class-gmail-matcher.php` (new)
- `includes/class-rest-gmail.php` (new)
- `src/pages/People/PersonDetail/EmailsSection.jsx` (new)

### Phase 3: Log Email as Activity
**Goal:** Manual logging of email threads to timeline

- [ ] "Log as Activity" button on thread cards
- [ ] `EmailLogModal` component
- [ ] Store Gmail thread reference in activity meta
- [ ] Display logged emails in timeline with Gmail icon
- [ ] "View in Gmail" link from logged activities

**Key Files:**
- `src/components/Gmail/EmailLogModal.jsx` (new)
- `includes/class-comment-types.php` (extend for email activities)

### Phase 4: Compose & Send
**Goal:** Send emails from Stadion

- [ ] `EmailComposeModal` component
- [ ] REST endpoint: `POST /rondo/v1/gmail/send`
- [ ] Gmail API messages.send integration
- [ ] Pre-fill recipient from contact
- [ ] Basic formatting (plain text initially)
- [ ] Auto-log sent emails as activities

**Key Files:**
- `src/components/Gmail/EmailComposeModal.jsx` (new)
- `includes/class-gmail-provider.php` (extend)

### Phase 5: Reply in Thread
**Goal:** Reply to emails maintaining thread context

- [ ] "Reply" button on email threads
- [ ] Quote original message
- [ ] Thread ID handling (In-Reply-To, References headers)
- [ ] Reply appears in same Gmail thread

**Key Files:**
- `src/components/Gmail/EmailComposeModal.jsx` (extend)
- `includes/class-gmail-provider.php` (extend)

### Phase 6: Background Sync & Auto-Log
**Goal:** Automatic activity creation for emails

- [ ] Create `GmailSync` class
- [ ] History API integration for incremental sync
- [ ] WP-Cron scheduling per user
- [ ] Auto-create activities for matched emails
- [ ] Deduplication logic
- [ ] User preferences for auto-log behavior

**Key Files:**
- `includes/class-gmail-sync.php` (new)

### Phase 7: Email Search
**Goal:** Search emails with a contact

- [ ] `EmailSearchModal` component
- [ ] REST endpoint: `GET /rondo/v1/gmail/search`
- [ ] Gmail search query building
- [ ] Date range filtering
- [ ] Results display with thread previews

**Key Files:**
- `src/components/Gmail/EmailSearchModal.jsx` (new)

### Phase 8: Polish & Advanced Features
**Goal:** Production-ready, full-featured

- [ ] Attachment support for compose
- [ ] CC/BCC fields
- [ ] Email signature setting
- [ ] Rich text compose (optional)
- [ ] Unread badge on person cards
- [ ] WP-CLI commands
- [ ] Documentation
- [ ] Error handling and retry logic
- [ ] Rate limiting compliance

**Key Files:**
- Various polish across existing files
- `docs/gmail-integration.md` (new)

---

## UI Mockups

### Person Detail - Emails Section

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Emails with John Smith                    [Compose] [ğŸ”]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“§ Re: Project proposal                              â”‚   â”‚
â”‚  â”‚    Hey John, I've reviewed the proposal and...       â”‚   â”‚
â”‚  â”‚    Today, 2:30 PM                    [Log] [Reply]   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“§ Lunch next week?                                  â”‚   â”‚
â”‚  â”‚    Would you be free for lunch on Tuesday? I...      â”‚   â”‚
â”‚  â”‚    Yesterday                         [Log] [Reply]   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ âœ‰ï¸ Contract review (3 messages)                      â”‚   â”‚
â”‚  â”‚    Thanks for sending this over. A few questions...  â”‚   â”‚
â”‚  â”‚    Jan 15                            [Log] [Reply]   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚                    [Load more threads...]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Compose Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  New Email                                            [X]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  To:    john.smith@example.com                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  CC:    (optional)                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  Subject: [                                            ]    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  Hi John,                                           â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  [Compose your message...]                          â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  [ğŸ“ Attach]                              [Cancel] [Send]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Timeline with Logged Email

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Timeline                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â—‹ Note â€¢ Today                                             â”‚
â”‚  â”‚  Discussed Q2 roadmap priorities                         â”‚
â”‚  â”‚                                                          â”‚
â”‚  âœ‰ Email â€¢ Yesterday                                        â”‚
â”‚  â”‚  Re: Project proposal                                    â”‚
â”‚  â”‚  [View in Gmail â†’]                                       â”‚
â”‚  â”‚                                                          â”‚
â”‚  â˜ Phone â€¢ Jan 15                                           â”‚
â”‚  â”‚  Quick call about timeline                               â”‚
â”‚  â”‚                                                          â”‚
â”‚  ğŸ“… Meeting â€¢ Jan 14                                        â”‚
â”‚  â”‚  Weekly sync (from Calendar)                             â”‚
â”‚  â”‚  [View in Calendar â†’]                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Gmail API quotas | Rate limiting for active users | Batch requests, caching, exponential backoff |
| Sensitive scopes review | Delayed launch if Google requires verification | Request only necessary scopes, prepare verification docs |
| Email privacy concerns | User hesitation to connect | Clear privacy explanation, metadata-only storage, easy disconnect |
| Large mailboxes | Slow thread loading | Pagination, query optimization, caching |
| Thread matching accuracy | Wrong emails shown for contact | Email-first matching, handle email changes |

---

## Success Metrics

- [ ] Users can connect Gmail in under 2 minutes
- [ ] Thread list loads within 2 seconds for typical contact
- [ ] 80%+ of users who connect Gmail use it weekly
- [ ] Email compose/send completes within 5 seconds
- [ ] Zero email content stored in Stadion database (privacy)

---

## Open Questions

1. **Rich text compose**: Should we support HTML formatting in compose, or start with plain text only? (Proposal: Plain text MVP, rich text as enhancement)

2. **Attachment handling**: Should attachments be uploadable from Stadion, or only reference existing Gmail attachments? (Proposal: Support upload for new emails)

3. **Multiple email addresses**: How do we handle contacts with many email addresses? Show all threads or require primary email selection? (Proposal: Query all addresses, may need optimization)

4. **Email templates**: Should we add templating/snippets for common emails? (Proposal: Defer to future enhancement)

5. **Shared mailboxes**: Should we support Google Workspace shared mailboxes? (Proposal: Defer, personal Gmail only for MVP)

6. **Offline access**: Should compose work offline with send queue? (Proposal: No, require connectivity)

---

## Security Considerations

### OAuth Scopes Justification

| Scope | Why Needed | What It Allows |
|-------|------------|----------------|
| `gmail.readonly` | Display threads on contact profiles | Read email metadata and content |
| `gmail.send` | Send emails from Stadion | Send as user (appears in Sent folder) |
| `gmail.compose` | Create drafts (optional) | Save unsent drafts |

### Data Handling

- **No email body storage**: Full content fetched on-demand, never persisted
- **Metadata caching**: Subject, snippet, date cached for performance (cleared on disconnect)
- **Token encryption**: Same Sodium encryption as Calendar/Contacts
- **Audit logging**: All Gmail API calls logged for debugging (no content logged)

### User Control

- **Granular permissions**: Enable/disable Gmail independently of other Google services
- **Per-contact override**: Disable email tracking for specific contacts
- **Easy disconnect**: One-click revoke with data cleanup
- **Export before disconnect**: Option to download activity logs

---

## Dependencies

- **v5.0 Google Contacts Sync**: Shared OAuth refactoring, email address mapping
- **Existing infrastructure**:
  - `CredentialEncryption` for token storage
  - Activity/comment system for email logging
  - WP-Cron for background sync
  - REST API patterns

---

## References

- [Gmail API Documentation](https://developers.google.com/gmail/api)
- [Gmail API Guides](https://developers.google.com/gmail/api/guides)
- [Threads Resource](https://developers.google.com/gmail/api/reference/rest/v1/users.threads)
- [Messages Resource](https://developers.google.com/gmail/api/reference/rest/v1/users.messages)
- [History API for Sync](https://developers.google.com/gmail/api/guides/sync)
- [Existing Calendar Integration](./v4.0-calendar-integration.md)
- [Google Contacts Sync PRD](./v5.0-google-contacts-sync.md)

---

*Last updated: 2026-01-17*
