---
phase: 53-person-meetings-section
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/client.js
  - src/hooks/useMeetings.js
  - src/pages/People/PersonDetail.jsx
  - includes/class-rest-calendar.php
autonomous: true
---

<objective>
Add a "Meetings" tab to PersonDetail showing upcoming and past calendar meetings with this person, with ability to log past meetings as activities.

Purpose: Surface calendar integration data on person profiles so users can see their meeting history and easily log interactions.
Output: Working Meetings tab with meeting lists and "Log as Activity" functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-contact-matching/51-01-SUMMARY.md

# Key existing files:
@src/pages/People/PersonDetail.jsx
@src/api/client.js
@src/components/Timeline/QuickActivityModal.jsx
@includes/class-rest-calendar.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add meetings API functions and hook</name>
  <files>src/api/client.js, src/hooks/useMeetings.js</files>
  <action>
    1. In src/api/client.js, add to prmApi object:
       - `getPersonMeetings: (personId, params = {}) => api.get(`/prm/v1/people/${personId}/meetings`, { params })`
       - `logMeetingAsActivity: (eventId) => api.post(`/prm/v1/calendar/events/${eventId}/log`)`

    2. Create new src/hooks/useMeetings.js with:
       - `usePersonMeetings(personId)` - TanStack Query hook that calls getPersonMeetings
       - Query key: `['person-meetings', personId]`
       - Returns `{ upcoming, past, total_upcoming, total_past }` structure from API
       - `useLogMeetingAsActivity()` - mutation hook that calls logMeetingAsActivity
       - On success: invalidate person-meetings, person timeline queries
  </action>
  <verify>No TypeScript/lint errors from `npm run lint`</verify>
  <done>API functions and hook exported and usable</done>
</task>

<task type="auto">
  <name>Task 2: Implement log_event_as_activity backend</name>
  <files>includes/class-rest-calendar.php</files>
  <action>
    Replace the stub `log_event_as_activity` method with working implementation:

    1. Get event post by ID, verify ownership (author = current user)
    2. Get event metadata: title, start_time, end_time, location, meeting_url, _matched_people
    3. Find all matched person IDs from _matched_people JSON
    4. For each matched person, create an activity comment using existing pattern:
       - Comment on person post (comment_post_ID = person_id)
       - comment_type = 'activity'
       - Use ACF fields: activity_type = 'meeting', activity_date = event start date, activity_time = event start time
       - content = event title + location/url info
       - participants = other matched person IDs
    5. Mark event as logged: set _logged_as_activity = true meta
    6. Return success with created activity count

    Follow existing activity creation pattern from class-rest-people.php create_activity method.
  </action>
  <verify>Test with curl: `curl -X POST https://cael.is/wp-json/prm/v1/calendar/events/{id}/log -H "X-WP-Nonce: ..."` returns success</verify>
  <done>POST endpoint returns 200 with activity count, activities visible in person timeline</done>
</task>

<task type="auto">
  <name>Task 3: Add Meetings tab to PersonDetail</name>
  <files>src/pages/People/PersonDetail.jsx</files>
  <action>
    1. Import usePersonMeetings, useLogMeetingAsActivity from hooks/useMeetings
    2. Import Calendar icon from lucide-react (already imported)
    3. Add `const { data: meetings, isLoading: meetingsLoading } = usePersonMeetings(id)` alongside other queries
    4. Add `const logMeeting = useLogMeetingAsActivity()`

    5. Add new tab button after "Work" in tab navigation:
       ```jsx
       <button
         onClick={() => setActiveTab('meetings')}
         className={`pb-3 text-sm font-medium border-b-2 transition-colors ${
           activeTab === 'meetings'
             ? 'border-accent-600 text-accent-600'
             : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:border-gray-300'
         }`}
       >
         Meetings
         {meetings?.total_upcoming > 0 && (
           <span className="ml-1 text-xs bg-accent-100 dark:bg-accent-900/30 text-accent-700 dark:text-accent-300 px-1.5 py-0.5 rounded-full">
             {meetings.total_upcoming}
           </span>
         )}
       </button>
       ```

    6. Add tab content section after work tab content:
       ```jsx
       {activeTab === 'meetings' && (
         <div className="space-y-6">
           {/* Upcoming Meetings */}
           <div className="card p-6">
             <h2 className="font-semibold mb-4">Upcoming Meetings</h2>
             {meetingsLoading ? (
               <div className="text-gray-500 dark:text-gray-400">Loading...</div>
             ) : meetings?.upcoming?.length > 0 ? (
               <div className="space-y-3">
                 {meetings.upcoming.map(meeting => (
                   <MeetingCard key={meeting.id} meeting={meeting} showLogButton={false} />
                 ))}
               </div>
             ) : (
               <div className="text-gray-500 dark:text-gray-400 text-sm">No upcoming meetings</div>
             )}
           </div>

           {/* Past Meetings */}
           <div className="card p-6">
             <h2 className="font-semibold mb-4">Past Meetings</h2>
             {meetings?.past?.length > 0 ? (
               <div className="space-y-3">
                 {meetings.past.map(meeting => (
                   <MeetingCard
                     key={meeting.id}
                     meeting={meeting}
                     showLogButton={true}
                     onLog={() => handleLogMeeting(meeting)}
                     isLogging={loggingMeetingId === meeting.id}
                   />
                 ))}
               </div>
             ) : (
               <div className="text-gray-500 dark:text-gray-400 text-sm">No past meetings</div>
             )}
           </div>
         </div>
       )}
       ```

    7. Create MeetingCard component inline (inside PersonDetail or extract to separate file):
       - Show meeting title, date/time formatted nicely
       - Show location or meeting URL if present
       - Show calendar name badge
       - Show other attendees (other_attendees array)
       - Show match confidence indicator if < 80%
       - "Log as Activity" button for past meetings (disabled if already logged)

    8. Add state: `const [loggingMeetingId, setLoggingMeetingId] = useState(null)`

    9. Add handler:
       ```jsx
       const handleLogMeeting = async (meeting) => {
         setLoggingMeetingId(meeting.id);
         try {
           await logMeeting.mutateAsync(meeting.id);
           // Show success toast or feedback
         } catch (error) {
           console.error('Failed to log meeting:', error);
         } finally {
           setLoggingMeetingId(null);
         }
       };
       ```

    Full dark mode support throughout - use existing patterns from the file.
  </action>
  <verify>`npm run build` succeeds without errors</verify>
  <done>Meetings tab visible and functional, shows upcoming/past meetings, Log as Activity works</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run lint` passes
- [ ] `npm run build` succeeds without errors
- [ ] Meetings tab appears in PersonDetail
- [ ] Meetings data loads from API
- [ ] Log as Activity creates activity in timeline
- [ ] Dark mode styling consistent
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Meetings tab shows upcoming and past meetings
- Log as Activity button creates activity and updates UI
</success_criteria>

<output>
After completion, create `.planning/phases/53-person-meetings-section/53-01-SUMMARY.md`
</output>
