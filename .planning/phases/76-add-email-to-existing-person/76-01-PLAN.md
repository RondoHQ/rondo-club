---
phase: 76-add-email-to-existing-person
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/AddAttendeePopup.jsx
  - src/components/MeetingDetailModal.jsx
  - src/hooks/usePeople.js
autonomous: true

must_haves:
  truths:
    - "Clicking Add button on unknown attendee shows choice popup"
    - "User can select 'Add to existing person' to open person search"
    - "User can search and select existing person from results"
    - "Selected person gets attendee email added to their contact_info"
    - "User can select 'Create new person' to open PersonEditModal"
    - "Attendee list updates after email added to existing person"
  artifacts:
    - path: "src/components/AddAttendeePopup.jsx"
      provides: "Choice popup with person search"
      exports: ["default"]
    - path: "src/components/MeetingDetailModal.jsx"
      provides: "Integration of AddAttendeePopup"
      contains: "AddAttendeePopup"
    - path: "src/hooks/usePeople.js"
      provides: "useAddEmailToPerson hook"
      exports: ["useAddEmailToPerson"]
  key_links:
    - from: "src/components/AddAttendeePopup.jsx"
      to: "/rondo/v1/search"
      via: "useSearch hook"
      pattern: "useSearch\\("
    - from: "src/components/AddAttendeePopup.jsx"
      to: "src/hooks/usePeople.js"
      via: "useAddEmailToPerson hook"
      pattern: "useAddEmailToPerson\\("
    - from: "src/components/MeetingDetailModal.jsx"
      to: "src/components/AddAttendeePopup.jsx"
      via: "Component import"
      pattern: "AddAttendeePopup"
---

<objective>
Add choice popup when adding meeting attendee, allowing user to add email to existing person OR create new person.

Purpose: Prevent duplicate person creation when attendee email belongs to existing contact without that email in their record.

Output: AddAttendeePopup component, useAddEmailToPerson hook, integrated into MeetingDetailModal.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/76-add-email-to-existing-person/76-RESEARCH.md

# Prior phase summary
@.planning/phases/74-add-person-from-meeting/74-01-SUMMARY.md

# Key existing files
@src/components/MeetingDetailModal.jsx
@src/hooks/usePeople.js
@src/components/layout/Layout.jsx (lines 197-400 for SearchModal pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AddAttendeePopup component with choice and search modes</name>
  <files>src/components/AddAttendeePopup.jsx</files>
  <action>
Create AddAttendeePopup component with two modes:

**Choice mode (default):**
- Display two buttons: "Add to existing person" and "Create new person"
- "Add to existing" switches to search mode
- "Create new" calls onCreateNew callback
- Click outside or escape closes popup

**Search mode:**
- Back button returns to choice mode
- Search input with debounced query (reuse useSearch hook from useDashboard)
- Display person results with thumbnails (reuse pattern from SearchModal in Layout.jsx)
- Clicking person calls onSelectPerson callback with person object
- Show "Searching..." loading state
- Show "No people found" when no results and query >= 2 chars
- Show empty state message when query < 2 chars

**Props:**
- isOpen: boolean
- onClose: () => void
- onCreateNew: () => void
- onSelectPerson: (person) => void
- attendee: { name, email } - for context in UI

**Styling:**
- Position: absolute, appears below/beside trigger button
- Use Tailwind classes consistent with existing popups (UserMenu, QuickAddMenu)
- Dark mode support with dark: classes
- Max height with overflow scroll for results
- Width: w-72 (enough for search and results)

**Technical notes:**
- Import useSearch from @/hooks/useDashboard
- Import User, Search, ChevronLeft, UserPlus icons from lucide-react
- Use useRef + useEffect for click-outside detection (same pattern as UserMenu)
- Focus search input when entering search mode
  </action>
  <verify>
Component renders without errors. Both modes work:
1. Choice mode shows two buttons
2. Search mode shows input and results from useSearch
3. Click outside closes popup
  </verify>
  <done>
AddAttendeePopup.jsx exists with choice/search modes, uses useSearch hook, handles click outside, follows existing popup patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useAddEmailToPerson hook with meeting invalidation</name>
  <files>src/hooks/usePeople.js</files>
  <action>
Add new hook useAddEmailToPerson to usePeople.js:

```javascript
/**
 * Add email address to existing person's contact_info.
 * Fetches fresh person data, checks for duplicate, adds email, triggers calendar re-matching.
 */
export function useAddEmailToPerson() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ personId, email }) => {
      // Fetch fresh person data to get current contact_info
      const response = await wpApi.getPerson(personId, { _embed: true });
      const person = response.data;

      const currentContacts = person.acf?.contact_info || [];

      // Check if email already exists (case-insensitive)
      const emailExists = currentContacts.some(
        c => c.contact_type === 'email' &&
             c.contact_value.toLowerCase() === email.toLowerCase()
      );

      if (emailExists) {
        return { alreadyExists: true, person: transformPerson(person) };
      }

      // Add new email
      const newContact = {
        contact_type: 'email',
        contact_value: email.toLowerCase(),
        contact_label: 'Email',
      };

      await wpApi.updatePerson(personId, {
        acf: {
          contact_info: [...currentContacts, newContact],
        },
      });

      // Return updated person
      const updated = await wpApi.getPerson(personId, { _embed: true });
      return { alreadyExists: false, person: transformPerson(updated.data) };
    },
    onSuccess: (_, { personId }) => {
      // Invalidate person detail and list caches
      queryClient.invalidateQueries({ queryKey: peopleKeys.detail(personId) });
      queryClient.invalidateQueries({ queryKey: peopleKeys.lists() });
      // Invalidate meetings to trigger re-matching (email was added)
      queryClient.invalidateQueries({ queryKey: meetingsKeys.today });
      queryClient.invalidateQueries({ queryKey: meetingsKeys.date });
      queryClient.invalidateQueries({ queryKey: ['person-meetings'] });
    },
  });
}
```

**Technical notes:**
- transformPerson is already defined in usePeople.js
- meetingsKeys is already imported from useMeetings.js
- Calendar re-matching happens server-side via acf/save_post hook automatically
- Meeting query invalidation ensures UI updates immediately
  </action>
  <verify>
`npm run build` succeeds. Hook exported from usePeople.js.
  </verify>
  <done>
useAddEmailToPerson hook exists in usePeople.js with: fetch person, check duplicate email, add contact, invalidate meeting queries.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate AddAttendeePopup into MeetingDetailModal</name>
  <files>src/components/MeetingDetailModal.jsx</files>
  <action>
Modify MeetingDetailModal to use AddAttendeePopup instead of directly opening PersonEditModal:

**State changes:**
- Add: `const [popupAttendee, setPopupAttendee] = useState(null);` (which attendee has popup open)
- Keep existing: showPersonModal, personPrefill states

**Import AddAttendeePopup and useAddEmailToPerson:**
```javascript
import AddAttendeePopup from '@/components/AddAttendeePopup';
import { useCreatePerson, useAddEmailToPerson } from '@/hooks/usePeople';
```

**Add mutation hook:**
```javascript
const addEmailMutation = useAddEmailToPerson();
```

**Modify handleAddPerson:**
Instead of directly opening PersonEditModal, just set the popup attendee:
```javascript
const handleAddPerson = (attendee) => {
  setPopupAttendee(attendee);
};
```

**Add popup handlers:**
```javascript
// Handle "Create new person" from popup
const handleCreateNew = () => {
  const { first_name, last_name } = extractNameFromAttendee(popupAttendee);
  setPersonPrefill({
    first_name,
    last_name,
    email: popupAttendee.email || '',
  });
  setPopupAttendee(null);
  setShowPersonModal(true);
};

// Handle selecting existing person from popup search
const handleSelectPerson = async (person) => {
  if (!popupAttendee?.email) return;

  const result = await addEmailMutation.mutateAsync({
    personId: person.id,
    email: popupAttendee.email,
  });

  setPopupAttendee(null);

  if (result.alreadyExists) {
    // Email already existed - could show toast, but just close silently for now
  }
};
```

**Update AttendeeRow component:**
Pass down popupAttendee state so it can render the popup next to the correct Add button:
```jsx
<AttendeeRow
  key={attendee.email || index}
  attendee={attendee}
  onAddPerson={handleAddPerson}
  isPopupOpen={popupAttendee?.email === attendee.email}
  onClosePopup={() => setPopupAttendee(null)}
  onCreateNew={handleCreateNew}
  onSelectPerson={handleSelectPerson}
  isAddingEmail={addEmailMutation.isPending}
/>
```

**Modify AttendeeRow component:**
Add popup rendering next to the Add button when isPopupOpen:
```jsx
function AttendeeRow({
  attendee,
  onAddPerson,
  isPopupOpen,
  onClosePopup,
  onCreateNew,
  onSelectPerson,
  isAddingEmail
}) {
  // ... existing content code ...

  return (
    <div className="relative px-2 -mx-2">
      {/* existing content */}

      {/* Popup positioned relative to this attendee row */}
      {isPopupOpen && (
        <AddAttendeePopup
          isOpen={true}
          onClose={onClosePopup}
          onCreateNew={onCreateNew}
          onSelectPerson={onSelectPerson}
          attendee={attendee}
          isLoading={isAddingEmail}
        />
      )}
    </div>
  );
}
```

Position the popup below the Add button using absolute positioning.

**Keep PersonEditModal integration as-is** - it's still used when user chooses "Create new person".
  </action>
  <verify>
1. `npm run build` succeeds
2. `npm run dev` - test in browser:
   - Click Add button on unknown attendee -> popup appears with two choices
   - Click "Create new person" -> PersonEditModal opens with prefilled data
   - Click "Add to existing" -> search mode appears
   - Search for person, click result -> email added, popup closes, attendee updates
  </verify>
  <done>
MeetingDetailModal uses AddAttendeePopup. Add button shows choice popup. "Create new" opens PersonEditModal. "Add to existing" allows search and adds email to selected person. Attendee list updates after both flows.
  </done>
</task>

</tasks>

<verification>
1. Build verification: `npm run build` completes without errors
2. Lint verification: `npm run lint` passes (or errors are pre-existing)
3. Functional verification in browser:
   - Unknown attendee shows Add button (unchanged from Phase 74)
   - Clicking Add shows popup with "Add to existing person" and "Create new person"
   - "Create new person" opens PersonEditModal with prefilled name/email
   - "Add to existing person" shows search interface
   - Searching shows person results with thumbnails
   - Selecting person adds email and updates attendee list
   - Clicking outside popup closes it
   - Dark mode renders correctly
</verification>

<success_criteria>
- AddAttendeePopup.jsx component created with choice/search modes
- useAddEmailToPerson hook created with duplicate detection and meeting invalidation
- MeetingDetailModal integrates popup and handles both flows
- User can add email to existing person without creating duplicate
- Attendee list updates immediately after email added
- Build passes, deployed to production
</success_criteria>

<output>
After completion, create `.planning/phases/76-add-email-to-existing-person/76-01-SUMMARY.md`
</output>
