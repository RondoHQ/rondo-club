---
phase: 171-export-command-foundation
plan: 04
type: execute
wave: 3
depends_on: ["171-02"]
files_modified:
  - includes/class-demo-export.php
autonomous: true
must_haves:
  truths:
    - "Exported fixture contains rondo_club_name setting"
    - "Exported fixture contains membership fee configurations for all seasons"
    - "Exported fixture contains family discount configurations for all seasons"
    - "Exported fixture contains player_roles and excluded_roles arrays"
    - "Exported fixture contains VOG email settings and templates"
    - "Exported fixture contains VOG exempt commissies as fixture refs"
  artifacts:
    - path: "includes/class-demo-export.php"
      provides: "Implemented export_settings method"
      contains: "export_settings"
  key_links:
    - from: "includes/class-demo-export.php"
      to: "docs/demo-fixture-schema.md"
      via: "JSON output matches schema for settings section"
      pattern: "export_settings"
---

<objective>
Implement the export method for settings data (WordPress options).

Purpose: Settings data (fee categories, role config, family discount, VOG email config) is required for a working demo. Without these, the Contributie page, VOG management, and role-based features would not function.
Output: Complete settings section in the fixture JSON.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@docs/demo-fixture-schema.md (settings section)
@fixtures/demo-fixture.example.json (settings example)
@.planning/phases/171-export-command-foundation/171-02-SUMMARY.md
@includes/class-club-config.php
@includes/class-membership-fees.php (lines 1-50 — option key patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement export_settings</name>
  <files>includes/class-demo-export.php</files>
  <action>
Replace the stub method `export_settings()` in the DemoExport class.

**`export_settings()` method:**

Build the settings object with the following keys:

1. **`rondo_club_name`**: `get_option('rondo_club_name', '')` (required string)

2. **`rondo_membership_fees_{season}`**: These are dynamic option keys. To find all seasons, query the seizoen taxonomy: `get_terms(['taxonomy' => 'seizoen', 'hide_empty' => false])`. For each season slug, check if option `rondo_membership_fees_{slug}` exists. Use `get_option("rondo_membership_fees_{$slug}")`. The value is already a structured array/object with category configs (`label`, `amount`, `age_classes`, `matching_werkfuncties`). Include all seasons that have fee configurations. The keys in the output should be the full option name (e.g., `"rondo_membership_fees_2024-2025"`).

3. **`rondo_family_discount_{season}`**: Same pattern as membership fees. For each season slug, check if option `rondo_family_discount_{slug}` exists. Use `get_option("rondo_family_discount_{$slug}")`. The value contains `type`, `fixed_amount`, `percentage`. Include all seasons that have configs.

4. **`rondo_player_roles`**: `get_option('rondo_player_roles', [])` — array of objects with `value` and `label` keys.

5. **`rondo_excluded_roles`**: `get_option('rondo_excluded_roles', [])` — array of objects with `value` and `label` keys.

6. **`rondo_vog_from_email`**: `get_option('rondo_vog_from_email', '')` (nullable)

7. **`rondo_vog_from_name`**: `get_option('rondo_vog_from_name', '')` (nullable)

8. **`rondo_vog_template_new`**: `get_option('rondo_vog_template_new', '')` (nullable, HTML)

9. **`rondo_vog_template_renewal`**: `get_option('rondo_vog_template_renewal', '')` (nullable, HTML)

10. **`rondo_vog_reminder_template_new`**: `get_option('rondo_vog_reminder_template_new', '')` (nullable, HTML)

11. **`rondo_vog_reminder_template_renewal`**: `get_option('rondo_vog_reminder_template_renewal', '')` (nullable, HTML)

12. **`rondo_vog_exempt_commissies`**: `get_option('rondo_vog_exempt_commissies', [])` — this is an array of WordPress post IDs. Convert each to a fixture ref: `$this->get_ref($id, 'commissie')`. Filter out nulls.

**Implementation notes:**
- For nullable string settings, convert empty strings to `null`.
- For the dynamic season-based settings, iterate over seizoen terms to discover all relevant option keys. This ensures we don't miss any seasons.
- The `get_option()` values for fee configs and family discount may already be arrays/objects (WordPress auto-unserializes). Just include them as-is.

Log the settings count: `WP_CLI::log(sprintf('  Exported settings (%d fee configs, %d family discount configs)', ...));`
  </action>
  <verify>
Run `php -l includes/class-demo-export.php` for syntax. Deploy and run export. Verify: (1) settings section contains rondo_club_name, (2) membership fee configs exist for each season, (3) family discount configs exist for each season, (4) player_roles and excluded_roles are arrays of objects, (5) VOG settings are included, (6) VOG exempt commissies are fixture refs (not WordPress IDs), (7) empty string settings are null.
  </verify>
  <done>Settings section is fully populated with club name, per-season fee and family discount configs, role configs, VOG email settings and templates, and VOG exempt commissie refs.</done>
</task>

<task type="auto">
  <name>Task 2: Update meta record_counts to reflect actual exported data</name>
  <files>includes/class-demo-export.php</files>
  <action>
Update the `export()` method in the DemoExport class to ensure the meta `record_counts` reflect the actual number of items in each exported array, not just the pre-counted ref map sizes.

Currently, `build_meta()` is called before the entity arrays are populated (in plan 01, it counted from ref_maps). Now that all export methods are implemented, restructure the `export()` method so that:

1. First, call `build_ref_maps()` (unchanged)
2. Then, export all entities and store in variables:
   ```php
   $people = $this->export_people();
   $teams = $this->export_teams();
   $commissies = $this->export_commissies();
   $discipline_cases = $this->export_discipline_cases();
   $todos = $this->export_todos();
   $comments = $this->export_comments();
   $taxonomies = $this->export_taxonomies();
   $settings = $this->export_settings();
   ```
3. Then, build the meta section AFTER exporting entities, using actual array counts:
   ```php
   $meta = [
       'version' => '1.0',
       'exported_at' => gmdate('c'),
       'source' => 'Production export',
       'record_counts' => [
           'people' => count($people),
           'teams' => count($teams),
           'commissies' => count($commissies),
           'discipline_cases' => count($discipline_cases),
           'todos' => count($todos),
           'comments' => count($comments),
       ],
   ];
   ```
4. Assemble the fixture with the actual data arrays.
5. The `build_meta()` helper method can be removed or simplified since meta is now built inline.
6. The `count_comments_by_type()` helper is also no longer needed for meta (but can be kept if useful elsewhere).

This ensures the meta record_counts are always accurate and match the actual exported data, not just the database counts (which could differ if some records are skipped during export — e.g., comments on non-person posts).
  </action>
  <verify>
Run `php -l includes/class-demo-export.php` for syntax. Deploy and run export. Verify that meta.record_counts.people matches the length of the people array, and similarly for all other entity types.
  </verify>
  <done>Meta record_counts are derived from actual exported array lengths, ensuring consistency between the meta header and the fixture data.</done>
</task>

</tasks>

<verification>
1. `php -l includes/class-demo-export.php` passes
2. Settings section contains all required configuration options
3. Fee configs cover all seasons from the seizoen taxonomy
4. VOG exempt commissies use fixture refs
5. Meta record_counts match actual exported array lengths
6. The complete fixture file is valid JSON
7. Running `wp rondo demo export` produces a complete, valid fixture matching the schema
</verification>

<success_criteria>
- Settings data is fully populated with all WordPress options needed for a working demo
- Season-based settings (fees, family discount) cover all available seasons
- VOG exempt commissies use fixture ref IDs instead of WordPress post IDs
- Meta record_counts are accurate and match the actual exported data
- The export is complete — all 9 fixture sections are populated with real production data
</success_criteria>

<output>
After completion, create `.planning/phases/171-export-command-foundation/171-04-SUMMARY.md`
</output>
