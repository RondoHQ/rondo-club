---
phase: 171-export-command-foundation
plan: 02
type: execute
wave: 2
depends_on: ["171-01"]
files_modified:
  - includes/class-demo-export.php
autonomous: true
must_haves:
  truths:
    - "Exported fixture contains all people records with their ACF fields, contact info, addresses, work history, and relationships"
    - "Exported fixture contains all teams with their content, parent hierarchy, and contact info"
    - "Exported fixture contains all commissies with their content, parent hierarchy, and contact info"
    - "Work history entries reference teams/commissies using fixture ref IDs, not WordPress post IDs"
    - "Person relationships reference other persons and relationship types using fixture ref IDs"
    - "Team and commissie names appear unchanged in the export"
    - "Exported fixture contains the relationship_types and seizoenen taxonomies"
  artifacts:
    - path: "includes/class-demo-export.php"
      provides: "Implemented export_people, export_teams, export_commissies, export_taxonomies methods"
      contains: "export_people"
  key_links:
    - from: "includes/class-demo-export.php"
      to: "docs/demo-fixture-schema.md"
      via: "JSON output matches schema for people, teams, commissies, taxonomies sections"
      pattern: "export_people|export_teams|export_commissies|export_taxonomies"
---

<objective>
Implement the export methods for people, teams, commissies, and taxonomies — the core entity types that form the foundation of the fixture.

Purpose: These are the largest and most complex entity types. People have the most ACF fields, repeater fields, and cross-entity references. Teams and commissies are simpler but critical for work_history references. Taxonomies (relationship_types, seizoenen) are needed for person relationship references.
Output: A fixture JSON file containing all people, teams, commissies, and taxonomy data in the documented schema format.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@docs/demo-fixture-schema.md
@fixtures/demo-fixture.example.json
@.planning/phases/171-export-command-foundation/171-01-SUMMARY.md
@acf-json/group_person_fields.json
@acf-json/group_team_fields.json
@acf-json/group_commissie_fields.json
@acf-json/group_relationship_type_fields.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement export_teams, export_commissies, and export_taxonomies</name>
  <files>includes/class-demo-export.php</files>
  <action>
Replace the stub methods `export_teams()`, `export_commissies()`, and `export_taxonomies()` in the DemoExport class.

**`export_teams()` method:**

1. Query all team posts: `get_posts(['post_type' => 'team', 'numberposts' => -1, 'post_status' => ['publish', 'draft', 'private'], 'orderby' => 'ID', 'order' => 'ASC'])`
2. For each team, build an object matching the fixture schema:
   - `_ref`: Use `$this->get_ref($post->ID, 'team')`
   - `title`: `$post->post_title` (preserved unchanged per EXPORT-06)
   - `content`: `$post->post_content` (nullable, set to null if empty)
   - `status`: `$post->post_status`
   - `parent`: If `$post->post_parent > 0`, use `$this->get_ref($post->post_parent, 'team')`, otherwise `null`
   - `acf` object:
     - `website`: `get_field('website', $post->ID)` — nullable
     - `contact_info`: Read the ACF repeater `contact_info`. For each row: `contact_type`, `contact_label`, `contact_value`. Return empty array if no rows.
3. Log progress: `WP_CLI::log(sprintf('  Exported %d teams', count($teams)));`

**`export_commissies()` method:**

Same structure as `export_teams()` but with `post_type => 'commissie'` and refs as `commissie:N`. The parent field uses `$this->get_ref($post->post_parent, 'commissie')`.

**`export_taxonomies()` method:**

Returns an object with two keys:

1. `relationship_types`: Query all terms in `relationship_type` taxonomy using `get_terms(['taxonomy' => 'relationship_type', 'hide_empty' => false])`. For each term:
   - `_ref`: `"relationship_type:{$term->slug}"`
   - `name`: `$term->name`
   - `slug`: `$term->slug`
   - `acf` object:
     - `inverse_relationship_type`: Get ACF field `inverse_relationship_type` from the term. This is a term object or ID — convert to a ref using `"relationship_type:{inverse_term_slug}"`. If the ACF field returns a term object, extract its slug. If it returns a term ID, look up the slug with `get_term($term_id)`. Set to null if empty.

2. `seizoenen`: Query all terms in `seizoen` taxonomy using `get_terms(['taxonomy' => 'seizoen', 'hide_empty' => false])`. For each term:
   - `name`: `$term->name`
   - `slug`: `$term->slug`
   - `is_current`: `(bool) get_term_meta($term->term_id, 'is_current_season', true)`

Log progress for each taxonomy.
  </action>
  <verify>
Run `php -l includes/class-demo-export.php` for syntax. Deploy and run `wp rondo demo export --output=/tmp/test-fixture.json`. Then verify teams, commissies, and taxonomies sections contain data. Check that team/commissie parent refs are valid fixture refs (not WordPress IDs). Check that relationship_type inverse refs use slug-based format.
  </verify>
  <done>Teams, commissies, and taxonomies are exported with correct schema format, parent hierarchy refs, and taxonomy term data including inverse relationship refs.</done>
</task>

<task type="auto">
  <name>Task 2: Implement export_people</name>
  <files>includes/class-demo-export.php</files>
  <action>
Replace the stub method `export_people()` in the DemoExport class. This is the most complex export method due to the number of fields and cross-entity references.

**`export_people()` method:**

1. Query all person posts: `get_posts(['post_type' => 'person', 'numberposts' => -1, 'post_status' => 'any', 'orderby' => 'ID', 'order' => 'ASC'])`

2. For each person, build an object matching the fixture schema. Use `get_field()` for ACF fields and `get_post_meta()` for non-ACF meta:

   **Top-level:**
   - `_ref`: `$this->get_ref($post->ID, 'person')`
   - `title`: `$post->post_title`
   - `status`: `$post->post_status`

   **`acf` object — Basic Information:**
   - `first_name`: `get_field('first_name', $post->ID)` (string, required)
   - `infix`: `get_field('infix', $post->ID)` (nullable)
   - `last_name`: `get_field('last_name', $post->ID)` (string, required)
   - `nickname`: `get_field('nickname', $post->ID)` (nullable)
   - `gender`: `get_field('gender', $post->ID)` (nullable)
   - `pronouns`: `get_field('pronouns', $post->ID)` (nullable)
   - `birthdate`: `get_field('birthdate', $post->ID)` (required, format Y-m-d — ACF returns this format natively)
   - `former_member`: `(bool) get_field('former_member', $post->ID)` (default false)
   - `lid-tot`: `get_field('lid-tot', $post->ID)` (nullable)
   - `datum-overlijden`: `get_field('datum-overlijden', $post->ID)` (nullable)

   **`acf` object — Contact Information:**
   - `contact_info`: Read ACF repeater `contact_info`. For each row: `['contact_type' => ..., 'contact_label' => ..., 'contact_value' => ...]`. Return empty array if no rows or false.

   **`acf` object — Addresses:**
   - `addresses`: Read ACF repeater `addresses`. For each row: `['address_label' => ..., 'street' => ..., 'postal_code' => ..., 'city' => ..., 'state' => ..., 'country' => ...]`. Return empty array if no rows.

   **`acf` object — Work History:**
   - `work_history`: Read ACF repeater `work_history`. For each row:
     - `team`: The ACF field stores a WordPress post ID. Determine entity type from the post's post_type (`team` or `commissie`), then convert to fixture ref using `$this->get_ref($team_id, $post_type)`. Set to null if empty.
     - `entity_type`: The post_type of the referenced team/commissie post
     - `job_title`: String value
     - `description`: String value (nullable)
     - `start_date`: String value (nullable, Y-m-d format)
     - `end_date`: String value (nullable, Y-m-d format)
     - `is_current`: Boolean value

   **`acf` object — Relationships:**
   - `relationships`: Read ACF repeater `relationships`. For each row:
     - `related_person`: The ACF field stores a WordPress post ID. Convert to fixture ref: `$this->get_ref($person_id, 'person')`. Skip the row if the related person is not in the ref map.
     - `relationship_type`: The ACF field stores a term ID or term object. Extract the slug and format as `"relationship_type:{slug}"`. Skip if empty.
     - `relationship_label`: String value (nullable)

   **`acf` object — Sportlink-Synced Fields:**
   - `lid-sinds`: `get_field('lid-sinds', $post->ID)` (nullable)
   - `leeftijdsgroep`: `get_field('leeftijdsgroep', $post->ID)` (nullable)
   - `datum-vog`: `get_field('datum-vog', $post->ID)` (nullable)
   - `datum-foto`: `get_field('datum-foto', $post->ID)` (nullable)
   - `type-lid`: `get_field('type-lid', $post->ID)` (nullable)
   - `huidig-vrijwilliger`: `get_field('huidig-vrijwilliger', $post->ID)` (nullable, string "0" or "1")
   - `financiele-blokkade`: `(bool) get_field('financiele-blokkade', $post->ID)`
   - `relatiecode`: `get_field('relatiecode', $post->ID)` (nullable)
   - `werkfuncties`: Read ACF repeater `werkfuncties`. Same structure as work_history (convert team/commissie IDs to refs).
   - `freescout-id`: `get_field('freescout-id', $post->ID)` (nullable)
   - `factuur-adres`: `get_field('factuur-adres', $post->ID)` (nullable)
   - `factuur-email`: `get_field('factuur-email', $post->ID)` (nullable)
   - `factuur-referentie`: `get_field('factuur-referentie', $post->ID)` (nullable)

   **`post_meta` object:**
   - `vog_email_sent_date`: `get_post_meta($post->ID, 'vog_email_sent_date', true)` (nullable)
   - `vog_justis_submitted_date`: `get_post_meta($post->ID, 'vog_justis_submitted_date', true)` (nullable)
   - `vog_reminder_sent_date`: `get_post_meta($post->ID, 'vog_reminder_sent_date', true)` (nullable)
   - For `_nikki_*` and `_fee_snapshot_*` / `_fee_forecast_*` fields: Use a helper method to scan post meta for keys matching `_nikki_*_total`, `_nikki_*_saldo`, `_fee_snapshot_*`, `_fee_forecast_*` patterns. Include all matching meta keys with their values.

   **Important:** For all nullable fields, ensure empty strings are converted to `null` for clean JSON output. Create a helper method `normalize_value($value)` that returns `null` if the value is empty string, false, or an empty ACF field.

3. Log progress every 100 people: `WP_CLI::log(sprintf('  Exported %d / %d people...', $i, $total));`
4. Final log: `WP_CLI::log(sprintf('  Exported %d people', count($people)));`

**Performance consideration:** For large datasets (3000+ people), avoid loading all ACF field data into memory at once. Process one person at a time and append to the array.
  </action>
  <verify>
Run `php -l includes/class-demo-export.php` for syntax. Deploy and run `wp rondo demo export --output=/tmp/test-fixture.json`. Verify: (1) the people array contains the expected number of records, (2) a sample person has all required fields, (3) work_history team refs use fixture format (e.g., "team:5" not WordPress ID), (4) relationships use person refs and relationship_type refs, (5) nullable fields are null (not empty string).
  </verify>
  <done>All people records are exported with complete ACF fields, contact info, addresses, work history (with team/commissie refs), relationships (with person and relationship_type refs), Sportlink-synced fields, and post meta. All cross-entity references use fixture ref IDs.</done>
</task>

</tasks>

<verification>
1. `php -l includes/class-demo-export.php` passes
2. Exported fixture contains all people from the database
3. Exported fixture contains all teams with names unchanged
4. Exported fixture contains all commissies with names unchanged
5. Exported fixture contains relationship_types taxonomy terms with inverse refs
6. Exported fixture contains seizoenen taxonomy terms with is_current flags
7. Person work_history entries use fixture refs for teams/commissies
8. Person relationships use fixture refs for related persons and relationship types
9. Team/commissie parent fields use fixture refs
10. Nullable fields are null (not empty string or false)
11. Record counts in meta section match actual array lengths
</verification>

<success_criteria>
- People, teams, commissies, and taxonomies sections are fully populated
- All cross-entity references use the fixture ref ID system
- Team and commissie names are preserved unchanged (EXPORT-06)
- All relationships between entities are preserved (EXPORT-07)
- Data matches the schema defined in docs/demo-fixture-schema.md
</success_criteria>

<output>
After completion, create `.planning/phases/171-export-command-foundation/171-02-SUMMARY.md`
</output>
