---
phase: 171-export-command-foundation
plan: 03
type: execute
wave: 3
depends_on: ["171-02"]
files_modified:
  - includes/class-demo-export.php
autonomous: true
must_haves:
  truths:
    - "Exported fixture contains all discipline cases with person refs and seizoen slugs"
    - "Exported fixture contains all todos with related_persons as person refs"
    - "Exported fixture contains all comments (notes, activities, emails) with person refs"
    - "Activity comments include participants as person refs"
    - "Email comments include template type, recipient, subject, and content snapshot"
    - "Todo custom statuses (rondo_open, rondo_awaiting, rondo_completed) are preserved"
  artifacts:
    - path: "includes/class-demo-export.php"
      provides: "Implemented export_discipline_cases, export_todos, export_comments methods"
      contains: "export_discipline_cases"
  key_links:
    - from: "includes/class-demo-export.php"
      to: "docs/demo-fixture-schema.md"
      via: "JSON output matches schema for discipline_cases, todos, comments sections"
      pattern: "export_discipline_cases|export_todos|export_comments"
---

<objective>
Implement the export methods for discipline cases, todos, and comments (notes/activities/emails).

Purpose: These entity types all reference people, so they depend on the person ref map built in plan 02. Discipline cases also reference seizoen taxonomy terms. Comments are WordPress comments with custom types (rondo_note, rondo_activity, rondo_email).
Output: Complete fixture data for discipline cases, todos, and comments sections.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@docs/demo-fixture-schema.md
@fixtures/demo-fixture.example.json
@.planning/phases/171-export-command-foundation/171-02-SUMMARY.md
@acf-json/group_discipline_case_fields.json
@acf-json/group_todo_fields.json
@includes/class-comment-types.php (lines 1-30 — comment type constants)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement export_discipline_cases and export_todos</name>
  <files>includes/class-demo-export.php</files>
  <action>
Replace the stub methods `export_discipline_cases()` and `export_todos()` in the DemoExport class.

**`export_discipline_cases()` method:**

1. Query all discipline case posts: `get_posts(['post_type' => 'discipline_case', 'numberposts' => -1, 'post_status' => 'any', 'orderby' => 'ID', 'order' => 'ASC'])`
2. For each discipline case, build an object matching the fixture schema:
   - `_ref`: `$this->get_ref($post->ID, 'discipline_case')`
   - `title`: `$post->post_title`
   - `status`: `$post->post_status`
   - `acf` object:
     - `dossier_id`: `get_field('dossier_id', $post->ID)` (required string)
     - `person`: The ACF `person` field stores a WordPress post ID (or post object). Extract the ID and convert to fixture ref: `$this->get_ref($person_id, 'person')`. Set to null if empty or if person not found in ref map.
     - `match_date`: `get_field('match_date', $post->ID)` (nullable, format "Ymd")
     - `processing_date`: `get_field('processing_date', $post->ID)` (nullable, format "Ymd")
     - `match_description`: `get_field('match_description', $post->ID)` (nullable)
     - `team_name`: `get_field('team_name', $post->ID)` (nullable)
     - `charge_codes`: `get_field('charge_codes', $post->ID)` (nullable)
     - `charge_description`: `get_field('charge_description', $post->ID)` (nullable)
     - `sanction_description`: `get_field('sanction_description', $post->ID)` (nullable)
     - `administrative_fee`: Convert to float: `(float) get_field('administrative_fee', $post->ID)` (nullable)
     - `is_charged`: `(bool) get_field('is_charged', $post->ID)` (required)
   - `seizoen`: Get the seizoen taxonomy term for this post using `wp_get_post_terms($post->ID, 'seizoen')`. If a term exists, use its slug (e.g., "2024-2025"). Set to null if no term assigned.

3. Apply `normalize_value()` helper to nullable fields.
4. Log: `WP_CLI::log(sprintf('  Exported %d discipline cases', count($cases)));`

**`export_todos()` method:**

1. Query all todo posts with custom statuses: `get_posts(['post_type' => 'rondo_todo', 'numberposts' => -1, 'post_status' => ['rondo_open', 'rondo_awaiting', 'rondo_completed'], 'orderby' => 'ID', 'order' => 'ASC'])`
2. For each todo, build an object matching the fixture schema:
   - `_ref`: `$this->get_ref($post->ID, 'todo')`
   - `title`: `$post->post_title`
   - `content`: `$post->post_content` (nullable, set to null if empty)
   - `status`: `$post->post_status` (one of: rondo_open, rondo_awaiting, rondo_completed)
   - `date`: `$post->post_date` in ISO 8601 format. Use `get_post_time('c', false, $post->ID)` or format from `$post->post_date`
   - `acf` object:
     - `related_persons`: ACF field `related_persons` returns an array of post IDs (or post objects). Convert each to a fixture ref: `$this->get_ref($person_id, 'person')`. Filter out any null refs (persons not in map). Return as array of ref strings (e.g., `["person:1", "person:5"]`). Return empty array if no related persons.
     - `notes`: `get_field('notes', $post->ID)` (nullable, HTML content)
     - `awaiting_since`: `get_field('awaiting_since', $post->ID)` (nullable, format "Y-m-d H:i:s")
     - `due_date`: `get_field('due_date', $post->ID)` (nullable, format "Y-m-d")

3. Apply `normalize_value()` to nullable fields.
4. Log: `WP_CLI::log(sprintf('  Exported %d todos', count($todos)));`

**Important:** For ACF relationship/post object fields, check whether ACF returns a post object or just an ID. Use something like:
```php
$person_id = is_object($person_field) ? $person_field->ID : (int) $person_field;
```
This pattern should be extracted into a helper method `resolve_post_id($field_value)` that handles both cases.
  </action>
  <verify>
Run `php -l includes/class-demo-export.php` for syntax. Deploy and run export. Verify: (1) discipline_cases array contains expected records, (2) discipline case person fields are fixture refs, (3) seizoen is a slug string, (4) todos have custom statuses preserved, (5) todo related_persons are arrays of person refs, (6) todo dates are in ISO 8601 format.
  </verify>
  <done>Discipline cases and todos are exported with all ACF fields, cross-entity references as fixture refs, seizoen as slug, and custom todo statuses preserved.</done>
</task>

<task type="auto">
  <name>Task 2: Implement export_comments</name>
  <files>includes/class-demo-export.php</files>
  <action>
Replace the stub method `export_comments()` in the DemoExport class.

**`export_comments()` method:**

1. Query all comments with custom types: `get_comments(['type__in' => ['rondo_note', 'rondo_activity', 'rondo_email'], 'number' => 0, 'orderby' => 'comment_date', 'order' => 'ASC'])`

2. For each comment, build an object matching the fixture schema:
   - `type`: `$comment->comment_type` (one of: rondo_note, rondo_activity, rondo_email)
   - `person`: Convert `$comment->comment_post_ID` to fixture ref: `$this->get_ref($comment->comment_post_ID, 'person')`. Skip comments where the person is not in the ref map (comments on non-person posts).
   - `content`: `$comment->comment_content` (HTML content)
   - `date`: `$comment->comment_date` formatted in ISO 8601 (e.g., "2026-02-11T10:30:00"). The comment_date is already in local time, format it as `date('Y-m-d\TH:i:s', strtotime($comment->comment_date))`
   - `author_id`: `(int) $comment->user_id` — set to null if 0 (system-generated)
   - `meta`: Build meta object based on comment type:

   **For `rondo_note` type:**
   - `_note_visibility`: `get_comment_meta($comment->comment_ID, '_note_visibility', true)` — default to "shared" if empty

   **For `rondo_activity` type:**
   - `activity_type`: `get_comment_meta($comment->comment_ID, 'activity_type', true)` (nullable)
   - `activity_date`: `get_comment_meta($comment->comment_ID, 'activity_date', true)` (nullable, Y-m-d)
   - `activity_time`: `get_comment_meta($comment->comment_ID, 'activity_time', true)` (nullable)
   - `participants`: `get_comment_meta($comment->comment_ID, 'participants', true)` — this is an array of WordPress post IDs. Convert each to a fixture ref: `$this->get_ref($id, 'person')`. Filter out nulls. Return empty array if none.

   **For `rondo_email` type:**
   - `email_template_type`: `get_comment_meta($comment->comment_ID, 'email_template_type', true)` (string)
   - `email_recipient`: `get_comment_meta($comment->comment_ID, 'email_recipient', true)` (string)
   - `email_subject`: `get_comment_meta($comment->comment_ID, 'email_subject', true)` (string)
   - `email_content_snapshot`: `get_comment_meta($comment->comment_ID, 'email_content_snapshot', true)` (string, HTML)

3. Only include the `meta` key if there are actual meta values to include.
4. Skip comments where `person` ref is null (comment is not on a person post).
5. Log progress: `WP_CLI::log(sprintf('  Exported %d comments (%d notes, %d activities, %d emails)', ...));` Count by type for the summary.

**Edge cases:**
- `participants` meta may be stored as a serialized array. `get_comment_meta()` with `true` (single) should unserialize it automatically.
- Some comments may have `user_id = 0` (system comments like email logs) — export as `author_id: null`.
- Ensure empty meta objects are still included (e.g., `{}` for a note with no visibility set).
  </action>
  <verify>
Run `php -l includes/class-demo-export.php` for syntax. Deploy and run export. Verify: (1) comments array contains records, (2) each comment has the correct type field, (3) person refs are fixture format, (4) rondo_note comments have _note_visibility meta, (5) rondo_activity comments have activity meta with participants as person refs, (6) rondo_email comments have email meta fields, (7) author_id is null for system-generated comments.
  </verify>
  <done>All comments (notes, activities, emails) are exported with correct meta fields per type, person refs as fixture IDs, and activity participants converted to person refs.</done>
</task>

</tasks>

<verification>
1. `php -l includes/class-demo-export.php` passes
2. Discipline cases exported with person refs and seizoen slugs
3. Todos exported with custom statuses and related_persons as person ref arrays
4. Comments exported with type-specific meta fields
5. Activity participants are person refs (not WordPress IDs)
6. Email comments include template_type, recipient, subject, content_snapshot
7. Note comments include _note_visibility
8. Comments on non-person posts are excluded
9. Record counts in meta section match actual array lengths for all entity types
</verification>

<success_criteria>
- Discipline cases, todos, and comments sections are fully populated
- All cross-entity references (person links) use fixture ref IDs
- Comment meta is type-specific and complete
- Todo custom statuses are preserved as-is
- Seizoen references use slug strings
</success_criteria>

<output>
After completion, create `.planning/phases/171-export-command-foundation/171-03-SUMMARY.md`
</output>
