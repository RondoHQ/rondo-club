---
phase: 171-export-command-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-demo-export.php
  - includes/class-wp-cli.php
  - functions.php
autonomous: true
must_haves:
  truths:
    - "Running `wp rondo demo export` creates a JSON file at the specified path"
    - "The export command outputs progress messages during execution"
    - "The exported JSON has the correct top-level structure matching the fixture schema"
    - "A ref-mapping system converts WordPress post IDs to fixture reference IDs"
  artifacts:
    - path: "includes/class-demo-export.php"
      provides: "DemoExport class with export orchestration and ref-mapping"
      contains: "class DemoExport"
    - path: "includes/class-wp-cli.php"
      provides: "WP-CLI command registration for rondo demo export"
      contains: "rondo demo"
    - path: "functions.php"
      provides: "WP-CLI conditional loading of DemoExport"
      contains: "DemoExport"
  key_links:
    - from: "includes/class-wp-cli.php"
      to: "includes/class-demo-export.php"
      via: "WP-CLI command invokes DemoExport::export()"
      pattern: "DemoExport"
---

<objective>
Create the WP-CLI command structure and export orchestration class that will serve as the foundation for all export functionality.

Purpose: Provides the skeleton (`wp rondo demo export`) and the reference ID mapping system that all subsequent export plans build upon.
Output: A working WP-CLI command that creates a valid (but mostly empty) fixture JSON file, plus a DemoExport class with the ref-mapping infrastructure.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@docs/demo-fixture-schema.md
@fixtures/demo-fixture.example.json
@includes/class-wp-cli.php (lines 2604-2621 — command registration)
@functions.php (lines 465-469 — WP-CLI loading section)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create the DemoExport class with ref-mapping and export orchestration</name>
  <files>includes/class-demo-export.php</files>
  <action>
Create a new file `includes/class-demo-export.php` with namespace `Rondo\Demo` and class `DemoExport`.

The class must:

1. **Properties:**
   - `$ref_maps` (private array): Stores mapping from WordPress post IDs to fixture ref strings. Structure: `['person' => [wp_id => 'person:N'], 'team' => [...], 'commissie' => [...], 'discipline_case' => [...], 'todo' => [...]]`
   - `$output_path` (private string): Path to write the JSON fixture file

2. **Constructor:** Accept `$output_path` parameter and store it.

3. **`export()` method (public):** The main orchestration method. It:
   - Calls `$this->build_ref_maps()` to pre-build all ID mappings
   - Builds the fixture array with all 9 top-level keys from the schema: `meta`, `people`, `teams`, `commissies`, `discipline_cases`, `todos`, `comments`, `taxonomies`, `settings`
   - For now, each entity section calls a stub method that returns an empty array (these will be implemented in plans 02-04)
   - Calls `$this->build_meta()` for the meta section
   - Writes the JSON to `$this->output_path` using `wp_json_encode()` with `JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES`
   - Returns the fixture array (for potential programmatic use)

4. **`build_ref_maps()` method (private):** Queries ALL post IDs for each entity type using `get_posts()` with `'numberposts' => -1, 'post_status' => 'any', 'fields' => 'ids'` and builds sequential ref maps. For teams and commissies, also query with `'post_status' => ['publish', 'draft', 'private']`. For todos, use `'post_status' => ['rondo_open', 'rondo_awaiting', 'rondo_completed']`. Assign sequential numbers starting from 1 for each entity type.

5. **`get_ref( $post_id, $entity_type )` method (protected):** Look up a post ID in `$this->ref_maps[$entity_type]` and return the ref string (e.g., `"person:42"`). Return `null` if not found.

6. **`build_meta()` method (private):** Returns the meta object with:
   - `version`: `"1.0"`
   - `exported_at`: Current UTC time in ISO 8601 format (`gmdate('c')`)
   - `source`: `"Production export"`
   - `record_counts`: Count each entity type from `$this->ref_maps` array sizes, plus a `comments` count from `count_comments_by_type()` (a helper method that counts comments with types `rondo_note`, `rondo_activity`, `rondo_email`)

7. **`count_comments_by_type()` method (private):** Use `get_comments()` with `'type__in' => ['rondo_note', 'rondo_activity', 'rondo_email'], 'count' => true` to get the total comment count.

8. **Stub methods (protected, returning empty arrays):** `export_people()`, `export_teams()`, `export_commissies()`, `export_discipline_cases()`, `export_todos()`, `export_comments()`, `export_taxonomies()`, `export_settings()`. These will be filled in by subsequent plans.

Use `WP_CLI::log()` for progress messages throughout the export process (log when starting, when building ref maps, when each section is exported, and when writing the file).
  </action>
  <verify>
Verify the file exists and has the correct namespace, class structure, and all required methods. Run `php -l includes/class-demo-export.php` to check syntax.
  </verify>
  <done>The DemoExport class exists with export orchestration, ref-mapping system, meta builder, and stub methods for all entity sections.</done>
</task>

<task type="auto">
  <name>Task 2: Register WP-CLI command and wire up loading</name>
  <files>includes/class-wp-cli.php, functions.php</files>
  <action>
**In `includes/class-wp-cli.php`:**

1. Add a new WP-CLI command class `RONDO_Demo_CLI_Command` at the end of the file (before the command registration section). The class should have one method:

   ```php
   /**
    * Export production data to a demo fixture file.
    *
    * ## OPTIONS
    *
    * [--output=<path>]
    * : Output file path for the fixture JSON. Defaults to fixtures/demo-fixture.json in theme directory.
    *
    * ## EXAMPLES
    *
    *     wp rondo demo export
    *     wp rondo demo export --output=/tmp/demo-data.json
    *
    * @when after_wp_load
    */
   public function export( $args, $assoc_args ) {
       $default_path = RONDO_THEME_DIR . '/fixtures/demo-fixture.json';
       $output_path = isset( $assoc_args['output'] ) ? $assoc_args['output'] : $default_path;

       // Ensure output directory exists
       $dir = dirname( $output_path );
       if ( ! is_dir( $dir ) ) {
           wp_mkdir_p( $dir );
       }

       WP_CLI::log( sprintf( 'Exporting demo data to: %s', $output_path ) );

       $exporter = new \Rondo\Demo\DemoExport( $output_path );
       $fixture = $exporter->export();

       WP_CLI::success( sprintf(
           'Export complete! %d people, %d teams, %d commissies, %d discipline cases, %d todos, %d comments exported to %s',
           $fixture['meta']['record_counts']['people'],
           $fixture['meta']['record_counts']['teams'],
           $fixture['meta']['record_counts']['commissies'],
           $fixture['meta']['record_counts']['discipline_cases'],
           $fixture['meta']['record_counts']['todos'],
           $fixture['meta']['record_counts']['comments'],
           $output_path
       ));
   }
   ```

2. Add the command registration at the bottom of the file (in the registration section, before the closing `}`):
   ```php
   WP_CLI::add_command( 'rondo demo', 'RONDO_Demo_CLI_Command' );
   ```

**In `functions.php`:**

In the WP-CLI loading section (around line 466-469), add a `use` statement import for the DemoExport class. The existing code already loads `class-wp-cli.php` which is where the command lives. No additional require is needed since PSR-4 autoloading will handle the `Rondo\Demo\DemoExport` class. However, add a `use` statement at the top of the file (in the imports section) for the new namespace:

```php
use Rondo\Demo\DemoExport;
```

And add the class alias for backward compatibility:
```php
if ( ! class_exists( 'RONDO_Demo_Export' ) ) {
    class_alias( DemoExport::class, 'RONDO_Demo_Export' );
}
```
  </action>
  <verify>
Run `php -l includes/class-wp-cli.php` and `php -l functions.php` to check syntax. Then on the production server, after deploy, test with: `wp rondo demo export --output=/tmp/test-fixture.json` — it should create a JSON file with the correct top-level structure (meta + 8 empty entity sections).
  </verify>
  <done>The `wp rondo demo export` command is registered, creates a JSON file at the specified path, and outputs progress messages and a success summary with record counts.</done>
</task>

</tasks>

<verification>
1. `php -l includes/class-demo-export.php` passes (no syntax errors)
2. `php -l includes/class-wp-cli.php` passes
3. `php -l functions.php` passes
4. On production: `wp rondo demo export --output=/tmp/test-fixture.json` creates a valid JSON file
5. The JSON file has all 9 top-level keys: meta, people, teams, commissies, discipline_cases, todos, comments, taxonomies, settings
6. The meta section has correct version, exported_at timestamp, source, and record_counts
7. Record counts show actual counts from the database (even though entity arrays are still empty stubs)
8. The ref_maps contain sequential IDs for all entity types
</verification>

<success_criteria>
- `wp rondo demo export` command exists and runs without errors
- Output JSON has correct top-level structure matching the fixture schema
- Ref-mapping system builds sequential IDs from real WordPress post IDs
- Meta section contains accurate record counts from production database
- Foundation is ready for plans 02-04 to implement entity export methods
</success_criteria>

<output>
After completion, create `.planning/phases/171-export-command-foundation/171-01-SUMMARY.md`
</output>
