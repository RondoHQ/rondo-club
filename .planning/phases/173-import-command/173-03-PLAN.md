---
phase: 173-import-command
plan: 03
type: execute
wave: 2
depends_on: ["173-01"]
files_modified:
  - includes/class-demo-import.php
  - includes/class-wp-cli.php
autonomous: true

must_haves:
  truths:
    - "User can run `wp rondo demo import --clean` to wipe existing data before import"
    - "Clean removes all posts of relevant CPTs, all taxonomy terms, and all relevant options"
    - "Clean does NOT remove user accounts or WordPress core data"
    - "Import still works correctly after clean (fresh state)"
  artifacts:
    - path: "includes/class-demo-import.php"
      provides: "clean() method that removes all demo-relevant data"
      contains: "function clean"
    - path: "includes/class-wp-cli.php"
      provides: "--clean flag on import command"
      contains: "clean"
  key_links:
    - from: "includes/class-wp-cli.php"
      to: "includes/class-demo-import.php"
      via: "clean() call before import() when --clean flag is set"
      pattern: "->clean()"
---

<objective>
Add a `--clean` flag to the import command that wipes all existing Rondo data before importing, ensuring a clean slate for the demo fixture. This allows re-running import on the same instance without duplicate data.

Purpose: Without clean, running import twice would create duplicate posts. The clean flag enables idempotent imports and fresh demo environments.

Output: `wp rondo demo import --clean` wipes existing data then imports fresh.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@includes/class-demo-import.php
@includes/class-wp-cli.php
@.planning/phases/173-import-command/173-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement clean() method in DemoImport</name>
  <files>includes/class-demo-import.php</files>
  <action>
Add a `public function clean()` method to the DemoImport class that removes all Rondo-specific data from the WordPress instance.

**Delete posts for all relevant custom post types (in this order to respect comment dependencies):**

1. Delete all comments of custom types first:
   ```php
   $comment_types = ['rondo_note', 'rondo_activity', 'rondo_email'];
   $comments = get_comments(['type__in' => $comment_types, 'number' => 0]);
   foreach ($comments as $comment) {
       wp_delete_comment($comment->comment_ID, true); // force delete, skip trash
   }
   WP_CLI::log(sprintf('  Deleted %d comments', count($comments)));
   ```

2. Delete all posts for each CPT (force delete, skip trash):
   ```php
   $post_types = ['rondo_todo', 'discipline_case', 'person', 'team', 'commissie'];
   foreach ($post_types as $post_type) {
       $posts = get_posts([
           'post_type' => $post_type,
           'numberposts' => -1,
           'post_status' => 'any',
           'fields' => 'ids',
       ]);
       foreach ($posts as $post_id) {
           wp_delete_post($post_id, true); // force delete, bypass trash
       }
       WP_CLI::log(sprintf('  Deleted %d %s posts', count($posts), $post_type));
   }
   ```
   Note: For rondo_todo, query with custom statuses: `['rondo_open', 'rondo_awaiting', 'rondo_completed']` since 'any' may not include custom statuses.

3. Delete taxonomy terms:
   ```php
   $taxonomies = ['relationship_type', 'seizoen'];
   foreach ($taxonomies as $taxonomy) {
       $terms = get_terms(['taxonomy' => $taxonomy, 'hide_empty' => false, 'fields' => 'ids']);
       if (!is_wp_error($terms)) {
           foreach ($terms as $term_id) {
               wp_delete_term($term_id, $taxonomy);
           }
           WP_CLI::log(sprintf('  Deleted %d %s terms', count($terms), $taxonomy));
       }
   }
   ```

4. Delete Rondo-specific WordPress options:
   ```php
   // Static option keys
   $option_keys = [
       'rondo_club_name',
       'rondo_player_roles',
       'rondo_excluded_roles',
       'rondo_vog_from_email',
       'rondo_vog_from_name',
       'rondo_vog_template_new',
       'rondo_vog_template_renewal',
       'rondo_vog_reminder_template_new',
       'rondo_vog_reminder_template_renewal',
       'rondo_vog_exempt_commissies',
   ];

   foreach ($option_keys as $key) {
       delete_option($key);
   }

   // Dynamic season-keyed options (scan for pattern)
   global $wpdb;
   $dynamic_options = $wpdb->get_col(
       "SELECT option_name FROM {$wpdb->options}
        WHERE option_name LIKE 'rondo_membership_fees_%'
           OR option_name LIKE 'rondo_family_discount_%'"
   );
   foreach ($dynamic_options as $option_name) {
       delete_option($option_name);
   }

   WP_CLI::log(sprintf('  Deleted %d options', count($option_keys) + count($dynamic_options)));
   ```

**Important:** Do NOT delete:
- WordPress user accounts
- WordPress core options (siteurl, blogname, etc.)
- Plugin settings not prefixed with `rondo_`
- Media/uploads (fixture doesn't include media)

Log a summary line: `WP_CLI::log('Clean complete.');`
  </action>
  <verify>
Grep for `function clean` in class-demo-import.php.
Verify all 5 post types are deleted.
Verify both taxonomy types are deleted.
Verify option cleanup includes both static and dynamic keys.
Run `php -l includes/class-demo-import.php` for syntax check.
  </verify>
  <done>
clean() method removes all Rondo CPT posts, custom comment types, taxonomy terms, and Rondo-specific options without touching users or WordPress core data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add --clean flag to WP-CLI import command</name>
  <files>includes/class-wp-cli.php</files>
  <action>
Update the `import()` method in `RONDO_Demo_CLI_Command` to accept a `--clean` flag.

**Update WP-CLI docs block:**
```
 * [--clean]
 * : Remove all existing Rondo data before importing. Use this to start fresh.
```

**Add to examples:**
```
 *     wp rondo demo import --clean
 *     wp rondo demo import --input=/tmp/demo-data.json --clean
```

**Implementation â€” add before the import() call:**
```php
if (isset($assoc_args['clean']) && $assoc_args['clean']) {
    WP_CLI::log('Cleaning existing data...');
    $importer->clean();
    WP_CLI::log('');
}
```

The clean runs BEFORE import so the import starts with a fresh database. The `WP_CLI::log('')` adds a visual separator between clean output and import output.
  </action>
  <verify>
Grep for `--clean` in class-wp-cli.php.
Verify the clean call happens before import.
Verify the flag is documented in the WP-CLI docs block.
  </verify>
  <done>
`wp rondo demo import --clean` wipes all existing Rondo data before importing fresh fixture data. Running without --clean imports additively (for cases where you want to add to existing data).
  </done>
</task>

</tasks>

<verification>
1. `php -l includes/class-demo-import.php` passes
2. `clean()` method exists and deletes all 5 CPTs, 2 taxonomies, and all Rondo options
3. `--clean` flag is documented in WP-CLI help
4. Clean runs before import when flag is present
5. Clean does NOT remove users or WordPress core data
6. Running `wp rondo demo import --clean` twice produces identical results (idempotent)
</verification>

<success_criteria>
- clean() method removes all Rondo-specific posts, terms, and options
- --clean flag is properly documented and functional in WP-CLI
- Clean runs before import when flag is set
- Import works correctly on a cleaned database (no orphaned references)
- User accounts and WordPress core data are preserved
</success_criteria>

<output>
After completion, create `.planning/phases/173-import-command/173-03-SUMMARY.md`
</output>
