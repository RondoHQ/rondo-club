---
phase: 173-import-command
plan: 02
type: execute
wave: 2
depends_on: ["173-01"]
files_modified:
  - includes/class-demo-import.php
autonomous: true

must_haves:
  truths:
    - "All dates in imported data are shifted relative to today so the demo always looks current"
    - "Birthdays are shifted by full years only (preserving month/day) to maintain age accuracy"
    - "Activity dates, comment dates, and todo dates are shifted to appear recent"
    - "Season slugs are shifted to match the current academic year"
  artifacts:
    - path: "includes/class-demo-import.php"
      provides: "Date-shifting logic integrated into import pipeline"
      contains: "shift_date"
  key_links:
    - from: "includes/class-demo-import.php"
      to: "fixture date fields"
      via: "shift_date() calls during import of each entity type"
      pattern: "shift_date"
---

<objective>
Add date-shifting logic to the DemoImport class so that all dates in the fixture are shifted relative to today, making the demo always look "fresh" — with recent activities, upcoming birthdays, and current seasons regardless of when the fixture was originally exported.

Purpose: Without date shifting, a fixture exported in February 2026 would show increasingly stale data over time. Date shifting ensures the demo always looks like it was just populated with current data.

Output: All dates in imported data are shifted so the fixture appears fresh and current.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/demo-fixture-schema.md
@includes/class-demo-import.php
@.planning/phases/173-import-command/173-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement date-shifting algorithm</name>
  <files>includes/class-demo-import.php</files>
  <action>
Add a date-shifting system to DemoImport that calculates a shift offset from the fixture's export date and applies it to all date fields during import.

**1. Calculate shift offset in `import()` method (before any entity imports):**

```php
// Calculate date shift: difference between export date and today
$export_date = new \DateTime($this->fixture['meta']['exported_at']);
$today = new \DateTime('today', wp_timezone());
$this->date_offset = $today->diff($export_date);  // DateInterval
$this->export_year = (int) $export_date->format('Y');
$this->import_year = (int) $today->format('Y');
$this->year_shift = $this->import_year - $this->export_year;
```

Store `$date_offset` and `$year_shift` as class properties.

**2. Create helper methods for different date formats:**

`shift_date($date_string, $format = 'Y-m-d')` — Shift a date string by the calculated offset.
- If `$date_string` is null or empty, return null.
- Parse the date, add the `$date_offset` interval, return in the same format.
- Supported formats: `'Y-m-d'`, `'Ymd'`, `'Y-m-d H:i:s'`, ISO 8601 (`'c'`).
- For ISO 8601 dates like `"2026-02-11T10:30:00"`, parse and shift, return in same format.

`shift_birthdate($date_string)` — Special handler for birthdates.
- Shift by full years only (using `$this->year_shift`) to preserve the exact month/day.
- This keeps age calculations accurate (adding months/days would change age).
- Example: If year_shift=1 and birthdate is "1990-03-15", result is "1991-03-15".
- Handle leap year edge case: if birthdate is Feb 29 and target year is not a leap year, use Feb 28.

`shift_season_slug($slug)` — Shift season slugs like "2025-2026".
- Parse start and end years, add `$year_shift` to each.
- Example: year_shift=1, "2025-2026" becomes "2026-2027".

**3. Apply date shifting in each import method:**

**People (in import_people):**
- `birthdate` → use `shift_birthdate()`
- `lid-tot` → use `shift_date()`
- `datum-overlijden` → use `shift_date()`
- `lid-sinds` → use `shift_date()`
- `datum-vog` → use `shift_date()`
- `datum-foto` → use `shift_date()` (though typically null in anonymized data)
- `work_history[].start_date` → use `shift_date()`
- `work_history[].end_date` → use `shift_date()`
- `werkfuncties[].start_date` → use `shift_date()`
- `werkfuncties[].end_date` → use `shift_date()`
- `post_meta.vog_email_sent_date` → use `shift_date()`
- `post_meta.vog_justis_submitted_date` → use `shift_date()`
- `post_meta.vog_reminder_sent_date` → use `shift_date()`
- Dynamic meta keys `_nikki_{year}_*` → shift the year in the key name (e.g., `_nikki_2025_total` → `_nikki_2026_total` if year_shift=1)
- Dynamic meta keys `_fee_snapshot_{season}` and `_fee_forecast_{season}` → shift the season in the key name

**Discipline cases (in import_discipline_cases):**
- `acf.match_date` → use `shift_date($date, 'Ymd')` (format is Ymd)
- `acf.processing_date` → use `shift_date($date, 'Ymd')`
- `seizoen` → use `shift_season_slug()`

**Todos (in import_todos):**
- `date` (post creation date) → use `shift_date()` with ISO 8601 format
- `acf.awaiting_since` → use `shift_date($date, 'Y-m-d H:i:s')`
- `acf.due_date` → use `shift_date()`

**Comments (in import_comments):**
- `date` → use `shift_date()` with ISO 8601 format
- `meta.activity_date` (for rondo_activity type) → use `shift_date()`

**Taxonomies (in import_taxonomies):**
- Seizoen names and slugs → use `shift_season_slug()` for both name and slug

**Settings (in import_settings):**
- Season-keyed settings: `rondo_membership_fees_{season}` and `rondo_family_discount_{season}` → shift the season in the option key name using `shift_season_slug()`

**4. Log the date shift at start of import:**
```php
WP_CLI::log(sprintf('Date shift: %d years, %d months, %d days (from %s to %s)',
    $this->date_offset->y, $this->date_offset->m, $this->date_offset->d,
    $export_date->format('Y-m-d'), $today->format('Y-m-d')
));
```
  </action>
  <verify>
Grep for `shift_date` in class-demo-import.php to verify it's called in each import method.
Grep for `shift_birthdate` to verify special birthdate handling exists.
Grep for `shift_season_slug` to verify season shifting exists.
Verify `date_offset` and `year_shift` properties exist on the class.
Run `php -l includes/class-demo-import.php` for syntax check.
  </verify>
  <done>
All date fields across all entity types are shifted relative to today. Birthdates use full-year shifts to preserve age accuracy. Season slugs are shifted to match the current academic year. Dynamic meta key names with years/seasons are shifted. The import logs the shift offset for visibility.
  </done>
</task>

</tasks>

<verification>
1. `php -l includes/class-demo-import.php` passes
2. `shift_date()` is called for all date fields in people, discipline_cases, todos, comments
3. `shift_birthdate()` preserves month/day while shifting year
4. `shift_season_slug()` shifts both years in "YYYY-YYYY" format
5. Dynamic meta keys (_nikki_YEAR_*, _fee_snapshot_SEASON) have shifted year/season in key names
6. Season-keyed settings options have shifted season in option key
7. Date shift offset is logged at start of import
</verification>

<success_criteria>
- All dates in imported fixture data are shifted relative to today
- Birthdates preserve month/day (full-year shift only) for accurate age calculations
- Season slugs shift correctly (e.g., 2025-2026 → 2026-2027 if importing a year later)
- Dynamic meta key names containing years/seasons are shifted
- Settings with season-keyed option names are shifted
</success_criteria>

<output>
After completion, create `.planning/phases/173-import-command/173-02-SUMMARY.md`
</output>
