---
phase: 173-import-command
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-demo-import.php
  - includes/class-wp-cli.php
  - functions.php
autonomous: true

must_haves:
  truths:
    - "User can run `wp rondo demo import` and it creates all posts, terms, and meta from the fixture"
    - "All entity types are imported in correct dependency order"
    - "All fixture references are resolved to WordPress post IDs"
    - "Relationships between entities are preserved after import"
  artifacts:
    - path: "includes/class-demo-import.php"
      provides: "DemoImport class with full import pipeline"
      contains: "class DemoImport"
    - path: "includes/class-wp-cli.php"
      provides: "WP-CLI import subcommand on rondo demo"
      contains: "function import"
  key_links:
    - from: "includes/class-wp-cli.php"
      to: "includes/class-demo-import.php"
      via: "DemoImport instantiation and import() call"
      pattern: "new DemoImport"
    - from: "includes/class-demo-import.php"
      to: "fixtures/demo-fixture.json"
      via: "JSON file read and decode"
      pattern: "json_decode"
---

<objective>
Create the DemoImport class and WP-CLI command that reads a fixture JSON file and imports all entity types into WordPress in the correct dependency order, resolving all fixture references to WordPress post IDs.

Purpose: This is the core import pipeline - the reverse of the export from Phase 171/172. It must handle all 8 entity types (taxonomies, teams, commissies, people, discipline_cases, todos, comments, settings) with proper reference resolution.

Output: Working `wp rondo demo import` command that creates all posts, terms, meta, and comments from a fixture file.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/demo-fixture-schema.md
@includes/class-demo-export.php
@includes/class-wp-cli.php
@functions.php
@.planning/phases/170-fixture-format-design/170-01-SUMMARY.md
@.planning/phases/171-export-command-foundation/171-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DemoImport class with full import pipeline</name>
  <files>includes/class-demo-import.php, functions.php</files>
  <action>
Create `includes/class-demo-import.php` in `Rondo\Demo` namespace, mirroring the export class structure.

**Class structure:**

```php
namespace Rondo\Demo;
class DemoImport {
    private $ref_map = [];  // Maps fixture refs ("person:1") to WordPress post IDs
    private $fixture;       // Parsed fixture data
    private $fixture_path;  // Path to fixture file
}
```

**Main `import()` method orchestration — import in this exact order (per schema docs):**
1. Read and validate fixture JSON (check `meta.version === "1.0"`, validate required top-level keys)
2. `import_taxonomies()` — relationship_types and seizoenen
3. `import_teams()` — teams with parent hierarchy (two-pass: create posts, then set parents)
4. `import_commissies()` — same two-pass pattern as teams
5. `import_people()` — create person posts with all ACF fields, then resolve refs (work_history, werkfuncties, relationships) in second pass
6. `import_discipline_cases()` — create posts, set person ref and seizoen term
7. `import_todos()` — create posts with custom statuses, set related_persons refs
8. `import_comments()` — create comments on person posts with type-specific meta
9. `import_settings()` — update WordPress options, resolve commissie refs in VOG exempt list

**Reference resolution pattern:**
- As each entity is created, store: `$this->ref_map["person:1"] = $new_post_id;`
- When resolving refs, call `$this->resolve_ref("person:1")` which returns the WordPress post ID
- For taxonomy refs like `"relationship_type:parent"`, store term_id in ref_map

**Entity-specific import details:**

**import_taxonomies():**
- For each relationship_type: `wp_insert_term($name, 'relationship_type', ['slug' => $slug])`
- If term already exists (by slug), use existing term ID
- Store ref: `$this->ref_map["relationship_type:$slug"] = $term_id`
- After all terms created, set ACF `inverse_relationship_type` field using resolved refs
- For seizoenen: `wp_insert_term($name, 'seizoen', ['slug' => $slug])`, set `is_current_season` term meta

**import_teams():**
- Pass 1: Create all team posts with `wp_insert_post(['post_type' => 'team', 'post_title' => $title, 'post_status' => $status, 'post_content' => $content ?? ''])`. Store ref mapping. Set ACF fields (website, contact_info via `update_field()`).
- Pass 2: Resolve parent refs. For each team with a parent ref, update `wp_update_post(['ID' => $post_id, 'post_parent' => $resolved_parent_id])`.

**import_commissies():** Same two-pass pattern as teams.

**import_people():**
- Pass 1: Create person posts. Set simple ACF fields (first_name, infix, last_name, nickname, gender, pronouns, birthdate, former_member, lid-tot, datum-overlijden, lid-sinds, leeftijdsgroep, datum-vog, datum-foto, type-lid, huidig-vrijwilliger, financiele-blokkade, relatiecode, freescout-id, factuur-adres, factuur-email, factuur-referentie). Set contact_info and addresses repeaters via `update_field()`. Set post_meta directly via `update_post_meta()` for vog_email_sent_date, vog_justis_submitted_date, vog_reminder_sent_date, and dynamic _nikki_ and _fee_ fields.
- Pass 2: Resolve refs in work_history, werkfuncties, and relationships repeaters. For each person, build the repeater arrays with resolved team/commissie/person refs, then `update_field()`.

**import_discipline_cases():**
- Create posts with wp_insert_post. Set ACF fields. Resolve person ref. Set seizoen taxonomy term via `wp_set_object_terms()`.

**import_todos():**
- Create posts with custom post statuses (rondo_open, rondo_awaiting, rondo_completed). Set post_date from fixture `date` field. Resolve related_persons refs. Set ACF fields.

**import_comments():**
- For each comment: resolve person ref to get post_id. Use `wp_insert_comment(['comment_post_ID' => $post_id, 'comment_type' => $type, 'comment_content' => $content, 'comment_date' => $date, 'user_id' => $author_id ?? 0])`. Then set comment meta based on type (rondo_note: _note_visibility; rondo_activity: activity_type, activity_date, activity_time, participants; rondo_email: email_template_type, email_recipient, email_subject, email_content_snapshot). For activity participants, resolve person refs.

**import_settings():**
- For each setting key/value: `update_option($key, $value)`.
- Special handling for `rondo_vog_exempt_commissies`: resolve commissie refs to post IDs before saving.

**Progress logging:**
- Use `WP_CLI::log()` for each import step
- Log counts after each entity type
- Log progress every 100 people (same pattern as export)

**In functions.php:** Add `use Rondo\Demo\DemoImport;` import and create `RONDO_Demo_Import` class alias (matching the export pattern).
  </action>
  <verify>
Run `php -l includes/class-demo-import.php` to verify syntax.
Grep for all required methods: import_taxonomies, import_teams, import_commissies, import_people, import_discipline_cases, import_todos, import_comments, import_settings.
Verify ref_map usage pattern in the file.
  </verify>
  <done>
DemoImport class exists with all 8 import methods, ref resolution system, two-pass import for hierarchical entities and people relationships, and proper progress logging.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register WP-CLI import subcommand</name>
  <files>includes/class-wp-cli.php</files>
  <action>
Add an `import` method to the existing `RONDO_Demo_CLI_Command` class in `includes/class-wp-cli.php`.

**Method signature and WP-CLI docs:**
```php
/**
 * Import demo data from a fixture file.
 *
 * ## OPTIONS
 *
 * [--input=<path>]
 * : Input fixture JSON file path. Defaults to fixtures/demo-fixture.json in theme directory.
 *
 * ## EXAMPLES
 *
 *     wp rondo demo import
 *     wp rondo demo import --input=/tmp/demo-data.json
 *
 * @when after_wp_load
 */
public function import( $args, $assoc_args ) {
```

**Implementation:**
1. Determine input path: `$assoc_args['input']` or default to `RONDO_THEME_DIR . '/fixtures/demo-fixture.json'`
2. Validate file exists and is readable
3. Log the import source path
4. Instantiate `new DemoImport($input_path)` (using the `use` import already at top of file from DemoExport — add `use Rondo\Demo\DemoImport;` if needed)
5. Call `$importer->import()`
6. On success: `WP_CLI::success()` with summary of imported counts from the fixture meta

**No changes to command registration needed** — the `RONDO_Demo_CLI_Command` class is already registered as `wp rondo demo`, so `import` method automatically becomes `wp rondo demo import`.
  </action>
  <verify>
Grep for `function import` in class-wp-cli.php.
Verify the DemoImport use statement is present.
Verify the method is inside RONDO_Demo_CLI_Command class.
  </verify>
  <done>
Running `wp rondo demo import` reads fixture file, imports all data, and reports success with record counts.
  </done>
</task>

</tasks>

<verification>
1. `php -l includes/class-demo-import.php` passes (no syntax errors)
2. `includes/class-demo-import.php` contains all 8 import methods
3. `includes/class-wp-cli.php` has `import` method in `RONDO_Demo_CLI_Command`
4. `functions.php` has `use Rondo\Demo\DemoImport` statement
5. Ref resolution pattern is consistent throughout all import methods
6. Import order matches schema: taxonomies → teams → commissies → people → discipline_cases → todos → comments → settings
</verification>

<success_criteria>
- DemoImport class can read a fixture JSON file
- All 8 entity types have dedicated import methods
- Reference resolution maps fixture refs to WordPress post IDs
- Two-pass import handles hierarchical parents and cross-entity relationships
- WP-CLI command `wp rondo demo import` invokes the importer
- Progress logging provides user feedback during import
</success_criteria>

<output>
After completion, create `.planning/phases/173-import-command/173-01-SUMMARY.md`
</output>
