---
phase: 147-birthdate-field-widget
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - acf-json/group_person_fields.json
  - src/pages/People/PersonDetail.jsx
  - includes/class-reminders.php
  - docs/api-leden-crud.md
autonomous: true

must_haves:
  truths:
    - "Person header displays age followed by birthdate in Dutch format"
    - "Persons without birthdate show age line without date parenthetical"
    - "Dashboard upcoming birthdays widget shows people with upcoming birthdays"
    - "Birthday calculation uses month/day comparison for recurring logic"
  artifacts:
    - path: "acf-json/group_person_fields.json"
      provides: "Birthdate date picker field"
      contains: "field_birthdate"
    - path: "src/pages/People/PersonDetail.jsx"
      provides: "Age + birthdate display in header"
      contains: "acf.birthdate"
    - path: "includes/class-reminders.php"
      provides: "Birthday queries from person meta"
      contains: "meta_key = 'birthdate'"
  key_links:
    - from: "src/pages/People/PersonDetail.jsx"
      to: "person.acf.birthdate"
      via: "ACF field data from REST API"
      pattern: "acf\\.birthdate|acf\\?\\.birthdate"
    - from: "includes/class-reminders.php"
      to: "postmeta birthdate"
      via: "direct meta query"
      pattern: "birthdate.*meta"
---

<objective>
Add birthdate field to person profiles and update display + dashboard widget to use person meta instead of Important Dates CPT.

Purpose: Simplify birthdate handling by storing birthdates directly on person records (consistent with Sportlink data model) rather than as separate Important Date posts.

Output:
- ACF birthdate field (read-only, date picker)
- Person header shows "43 jaar (6 feb 1982)" format
- Dashboard upcoming birthdays queries person birthdate meta
- Updated API documentation
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/147-birthdate-field-widget/147-CONTEXT.md
@.planning/phases/147-birthdate-field-widget/147-RESEARCH.md
@acf-json/group_person_fields.json
@src/pages/People/PersonDetail.jsx
@includes/class-reminders.php
@docs/api-leden-crud.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add birthdate ACF field and update person header display</name>
  <files>
    acf-json/group_person_fields.json
    src/pages/People/PersonDetail.jsx
  </files>
  <action>
1. **ACF field** - Add birthdate field to group_person_fields.json:
   - Add after the `field_pronouns` field (in Basic Information tab)
   - Field definition:
     ```json
     {
         "key": "field_birthdate",
         "label": "Birthdate",
         "name": "birthdate",
         "type": "date_picker",
         "display_format": "d F Y",
         "return_format": "Y-m-d",
         "readonly": 1,
         "wrapper": {
             "width": "50"
         }
     }
     ```
   - Set readonly: 1 because this is Sportlink-synced data

2. **Person header display** - Update PersonDetail.jsx:
   - Find the existing age display (around line 1148): `{age !== null && <span>{age} jaar</span>}`
   - Replace age calculation logic to use `acf.birthdate` directly instead of finding birthday from personDates
   - Update display format to: `{age} jaar ({formattedBirthdate})` where formattedBirthdate is "6 feb 1982"
   - Use Dutch month abbreviations via date-fns nl locale (already configured)
   - Format: `d MMM yyyy` with lowercase month (jan, feb, mrt, apr, mei, jun, jul, aug, sep, okt, nov, dec)
   - If no birthdate exists, hide the entire age/birthdate line (no placeholder)
   - Keep deceased logic: if person has death date, show age at death

Key patterns from existing code:
- Line 160: `const age = (birthDate && !birthdayYearUnknown) ? ...`
- Line 1148: `{age !== null && <span>{age} jaar</span>}`
- Use `format(date, 'd MMM yyyy')` for Dutch date formatting

The current code finds birthday from personDates (Important Dates CPT). Change to use acf.birthdate directly.
  </action>
  <verify>
1. ACF field visible in WordPress admin for Person edit screen (readonly)
2. PersonDetail page shows birthdate after age: "43 jaar (6 feb 1982)"
3. Persons without birthdate show no age/date line
4. npm run lint passes
  </verify>
  <done>
- Birthdate ACF field exists with readonly flag
- Person header displays age and birthdate in Dutch format
- No birthdate = no display (graceful hide)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update dashboard widget to query person birthdate meta</name>
  <files>
    includes/class-reminders.php
  </files>
  <action>
Update `get_upcoming_reminders()` method in class-reminders.php to query person birthdate meta instead of Important Dates CPT:

1. **Replace the important_date query** with a query for persons with birthdate meta:
   ```php
   global $wpdb;

   $people_with_birthdays = $wpdb->get_results("
       SELECT p.ID, p.post_title, pm.meta_value as birthdate
       FROM {$wpdb->posts} p
       INNER JOIN {$wpdb->postmeta} pm ON p.ID = pm.post_id
       WHERE p.post_type = 'person'
       AND p.post_status = 'publish'
       AND pm.meta_key = 'birthdate'
       AND pm.meta_value != ''
   ");
   ```

2. **Calculate next occurrence** using existing `calculate_next_occurrence()` method:
   - Birthdays are always recurring (is_recurring = true)
   - Use month/day comparison to find next occurrence

3. **Build reminder structure** matching existing format:
   ```php
   $upcoming[] = [
       'id'              => $person->ID,
       'title'           => html_entity_decode($person->post_title, ENT_QUOTES, 'UTF-8') . ' - Verjaardag',
       'date_value'      => $person->birthdate,
       'next_occurrence' => $next_occurrence->format('Y-m-d'),
       'days_until'      => (int) $today->diff($next_occurrence)->days,
       'is_recurring'    => true,
       'year_unknown'    => false,
       'date_type'       => ['Birthday'],
       'related_people'  => [[
           'id'        => $person->ID,
           'name'      => html_entity_decode($person->post_title, ENT_QUOTES, 'UTF-8'),
           'thumbnail' => get_the_post_thumbnail_url($person->ID, 'thumbnail'),
       ]],
   ];
   ```

4. **Update `get_weekly_digest()`** similarly to use person birthdate meta

5. **Keep days_until logic**:
   - 0 = "vandaag" (same day)
   - N = "Nd" format
   - Widget already handles this display

Do NOT remove the Important Dates CPT query entirely yet - that happens in Phase 148. For now, this method should ONLY return birthdays from person meta. Other date types (anniversaries, etc.) will be removed in Phase 148.
  </action>
  <verify>
1. Dashboard widget shows upcoming birthdays
2. Birthday calculation uses month/day for "upcoming" logic
3. Same-day birthdays show with days_until = 0
4. Widget displays person name and "Verjaardag" label
5. npm run build succeeds (PHP changes don't affect build)
  </verify>
  <done>
- Dashboard reminders endpoint returns birthdays from person meta
- Birthday next occurrence calculation uses recurring logic
- Widget shows same information format as before
  </done>
</task>

<task type="auto">
  <name>Task 3: Update documentation</name>
  <files>
    docs/api-leden-crud.md
    docs/api-important-dates.md
  </files>
  <action>
1. **Update docs/api-leden-crud.md**:
   - Add `birthdate` field to the Person ACF fields documentation
   - Document format: Y-m-d (ISO date string)
   - Note: Read-only in UI (Sportlink synced)
   - Add example in JSON response showing birthdate field

2. **Delete docs/api-important-dates.md**:
   - This documentation is being removed proactively before infrastructure removal
   - The Important Dates CPT will be fully removed in Phase 148
   - Remove the file entirely using git rm or equivalent

Ensure docs accurately reflect the new birthdate field as part of person data model.
  </action>
  <verify>
1. docs/api-leden-crud.md includes birthdate field documentation
2. docs/api-important-dates.md no longer exists
3. Documentation accurately describes the birthdate field format and behavior
  </verify>
  <done>
- API documentation updated with birthdate field
- Important dates API documentation removed
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **ACF field exists**:
   - Log into WordPress admin
   - Edit any Person
   - Birthdate field visible in Basic Information section
   - Field is read-only

2. **Person header display**:
   - Visit a person with birthdate set
   - Header shows: "43 jaar (6 feb 1982)" format
   - Visit a person without birthdate
   - No age/date line displayed

3. **Dashboard widget**:
   - Visit dashboard
   - Upcoming birthdays widget shows people with upcoming birthdays
   - Format: "[Name] - Verjaardag" with date and days until

4. **Documentation**:
   - docs/api-leden-crud.md includes birthdate field
   - docs/api-important-dates.md does not exist

5. **Build check**:
   - `npm run build` completes without errors
   - `npm run lint` passes (or shows only pre-existing issues)
</verification>

<success_criteria>
1. Person ACF field group includes birthdate date picker field (readonly)
2. Person header displays age followed by birthdate in format "34 jaar (6 feb)"
3. Persons without birthdate show no date parenthetical
4. Upcoming birthdays widget queries person birthdate meta field
5. Birthday matching uses month/day comparison for upcoming logic
6. Widget shows birthday information (name, date, days until)
7. Documentation updated and obsolete docs removed
</success_criteria>

<output>
After completion, create `.planning/phases/147-birthdate-field-widget/147-01-SUMMARY.md`
</output>
