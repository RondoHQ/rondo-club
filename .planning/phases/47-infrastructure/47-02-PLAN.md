---
phase: 47-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["47-01"]
files_modified:
  - includes/class-rest-calendar.php
  - functions.php
autonomous: true
---

<objective>
Create REST API skeleton for calendar endpoints with route registration and permission callbacks.

Purpose: Establish the REST structure that Google OAuth, CalDAV, sync, and events phases will extend.
Output: RONDO_REST_Calendar class with registered routes and stub handlers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-infrastructure/47-01-SUMMARY.md

# Implementation reference
@Calendar-Integration-Implementation-Plan.md (section 3)

# Existing patterns to follow
@includes/class-rest-base.php (base class with permission methods)
@includes/class-rest-workspaces.php (example of REST class structure)
@functions.php (REST initialization in rondo_init)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RONDO_REST_Calendar class with connection endpoints</name>
  <files>includes/class-rest-calendar.php</files>
  <action>
Create new class `RONDO_REST_Calendar` extending `RONDO_REST_Base`.

Namespace: `/rondo/v1/calendar`

Register these routes in constructor via `rest_api_init` action:

**Connection CRUD endpoints:**
```php
// GET /rondo/v1/calendar/connections - List user's connections
register_rest_route('rondo/v1', '/calendar/connections', [
    'methods' => 'GET',
    'callback' => [$this, 'get_connections'],
    'permission_callback' => [$this, 'check_user_approved'],
]);

// POST /rondo/v1/calendar/connections - Add new connection
register_rest_route('rondo/v1', '/calendar/connections', [
    'methods' => 'POST',
    'callback' => [$this, 'create_connection'],
    'permission_callback' => [$this, 'check_user_approved'],
]);

// GET /rondo/v1/calendar/connections/(?P<id>[a-z0-9_]+) - Get single
register_rest_route('rondo/v1', '/calendar/connections/(?P<id>[a-z0-9_]+)', [
    'methods' => 'GET',
    'callback' => [$this, 'get_connection'],
    'permission_callback' => [$this, 'check_user_approved'],
]);

// PUT /rondo/v1/calendar/connections/(?P<id>[a-z0-9_]+) - Update
register_rest_route('rondo/v1', '/calendar/connections/(?P<id>[a-z0-9_]+)', [
    'methods' => 'PUT',
    'callback' => [$this, 'update_connection'],
    'permission_callback' => [$this, 'check_user_approved'],
]);

// DELETE /rondo/v1/calendar/connections/(?P<id>[a-z0-9_]+) - Delete
register_rest_route('rondo/v1', '/calendar/connections/(?P<id>[a-z0-9_]+)', [
    'methods' => 'DELETE',
    'callback' => [$this, 'delete_connection'],
    'permission_callback' => [$this, 'check_user_approved'],
]);

// POST /rondo/v1/calendar/connections/(?P<id>[a-z0-9_]+)/sync - Trigger sync
register_rest_route('rondo/v1', '/calendar/connections/(?P<id>[a-z0-9_]+)/sync', [
    'methods' => 'POST',
    'callback' => [$this, 'trigger_sync'],
    'permission_callback' => [$this, 'check_user_approved'],
]);
```

**OAuth endpoints (stubs for Phase 48):**
```php
// GET /rondo/v1/calendar/auth/google - Initiate OAuth
register_rest_route('rondo/v1', '/calendar/auth/google', [
    'methods' => 'GET',
    'callback' => [$this, 'google_auth_init'],
    'permission_callback' => [$this, 'check_user_approved'],
]);

// GET /rondo/v1/calendar/auth/google/callback - OAuth callback
register_rest_route('rondo/v1', '/calendar/auth/google/callback', [
    'methods' => 'GET',
    'callback' => [$this, 'google_auth_callback'],
    'permission_callback' => '__return_true', // Public for OAuth redirect
]);

// POST /rondo/v1/calendar/auth/caldav/test - Test CalDAV credentials
register_rest_route('rondo/v1', '/calendar/auth/caldav/test', [
    'methods' => 'POST',
    'callback' => [$this, 'test_caldav'],
    'permission_callback' => [$this, 'check_user_approved'],
]);
```

**Events and meetings endpoints (stubs for Phase 51+):**
```php
// GET /rondo/v1/calendar/events - List cached events
register_rest_route('rondo/v1', '/calendar/events', [
    'methods' => 'GET',
    'callback' => [$this, 'get_events'],
    'permission_callback' => [$this, 'check_user_approved'],
    'args' => [
        'from' => ['type' => 'string', 'format' => 'date'],
        'to' => ['type' => 'string', 'format' => 'date'],
        'person_id' => ['type' => 'integer'],
    ],
]);

// GET /rondo/v1/people/(?P<person_id>\d+)/meetings - Person meetings
register_rest_route('rondo/v1', '/people/(?P<person_id>\d+)/meetings', [
    'methods' => 'GET',
    'callback' => [$this, 'get_person_meetings'],
    'permission_callback' => [$this, 'check_person_access'],
    'args' => [
        'upcoming' => ['type' => 'boolean', 'default' => true],
        'past' => ['type' => 'boolean', 'default' => true],
        'limit' => ['type' => 'integer', 'default' => 10],
    ],
]);

// POST /rondo/v1/calendar/events/(?P<id>\d+)/log - Log as activity
register_rest_route('rondo/v1', '/calendar/events/(?P<id>\d+)/log', [
    'methods' => 'POST',
    'callback' => [$this, 'log_event_as_activity'],
    'permission_callback' => [$this, 'check_user_approved'],
]);
```
  </action>
  <verify>
- `curl -s /wp-json/rondo/v1/calendar/connections` returns 401 when logged out
- Routes appear in `curl -s /wp-json/rondo/v1` route listing
  </verify>
  <done>All calendar REST routes registered with correct patterns and permissions</done>
</task>

<task type="auto">
  <name>Task 2: Implement connection CRUD handlers</name>
  <files>includes/class-rest-calendar.php</files>
  <action>
Implement the connection CRUD methods using RONDO_Calendar_Connections helper.

**get_connections($request):**
```php
public function get_connections($request) {
    $user_id = get_current_user_id();
    $connections = RONDO_Calendar_Connections::get_user_connections($user_id);

    // Remove sensitive credentials from response
    return array_map(function($conn) {
        unset($conn['credentials']);
        return $conn;
    }, $connections);
}
```

**create_connection($request):**
```php
public function create_connection($request) {
    $user_id = get_current_user_id();
    $data = $request->get_json_params();

    // Validate required fields
    if (empty($data['provider']) || !in_array($data['provider'], ['google', 'caldav'])) {
        return new WP_Error('invalid_provider', 'Invalid provider', ['status' => 400]);
    }
    if (empty($data['name'])) {
        return new WP_Error('missing_name', 'Connection name required', ['status' => 400]);
    }

    // Encrypt credentials if provided
    if (!empty($data['credentials'])) {
        $data['credentials'] = RONDO_Credential_Encryption::encrypt($data['credentials']);
    }

    // Set defaults
    $connection = array_merge([
        'provider' => $data['provider'],
        'name' => sanitize_text_field($data['name']),
        'calendar_id' => sanitize_text_field($data['calendar_id'] ?? ''),
        'credentials' => $data['credentials'] ?? '',
        'sync_enabled' => true,
        'auto_log' => true,
        'sync_from_days' => 90,
        'last_sync' => null,
        'last_error' => null,
    ], $data);

    $id = RONDO_Calendar_Connections::add_connection($user_id, $connection);

    return rest_ensure_response([
        'id' => $id,
        'message' => 'Connection created',
    ]);
}
```

**get_connection($request):**
```php
public function get_connection($request) {
    $user_id = get_current_user_id();
    $id = $request->get_param('id');
    $connection = RONDO_Calendar_Connections::get_connection($user_id, $id);

    if (!$connection) {
        return new WP_Error('not_found', 'Connection not found', ['status' => 404]);
    }

    unset($connection['credentials']);
    return $connection;
}
```

**update_connection($request):**
```php
public function update_connection($request) {
    $user_id = get_current_user_id();
    $id = $request->get_param('id');
    $data = $request->get_json_params();

    $connection = RONDO_Calendar_Connections::get_connection($user_id, $id);
    if (!$connection) {
        return new WP_Error('not_found', 'Connection not found', ['status' => 404]);
    }

    // Sanitize updatable fields
    $updates = [];
    if (isset($data['name'])) $updates['name'] = sanitize_text_field($data['name']);
    if (isset($data['sync_enabled'])) $updates['sync_enabled'] = (bool) $data['sync_enabled'];
    if (isset($data['auto_log'])) $updates['auto_log'] = (bool) $data['auto_log'];
    if (isset($data['sync_from_days'])) $updates['sync_from_days'] = absint($data['sync_from_days']);
    if (isset($data['calendar_id'])) $updates['calendar_id'] = sanitize_text_field($data['calendar_id']);

    // Handle credential updates (re-encrypt)
    if (!empty($data['credentials'])) {
        $updates['credentials'] = RONDO_Credential_Encryption::encrypt($data['credentials']);
    }

    RONDO_Calendar_Connections::update_connection($user_id, $id, $updates);

    return rest_ensure_response(['message' => 'Connection updated']);
}
```

**delete_connection($request):**
```php
public function delete_connection($request) {
    $user_id = get_current_user_id();
    $id = $request->get_param('id');

    $connection = RONDO_Calendar_Connections::get_connection($user_id, $id);
    if (!$connection) {
        return new WP_Error('not_found', 'Connection not found', ['status' => 404]);
    }

    RONDO_Calendar_Connections::delete_connection($user_id, $id);

    return rest_ensure_response(['message' => 'Connection deleted']);
}
```

**trigger_sync($request):** (stub for now)
```php
public function trigger_sync($request) {
    // Will be implemented in Phase 49/50
    return new WP_Error('not_implemented', 'Sync not yet implemented', ['status' => 501]);
}
```
  </action>
  <verify>
- Create connection via POST, verify it appears in GET list
- Update connection settings, verify changes persist
- Delete connection, verify it's removed
  </verify>
  <done>Connection CRUD endpoints fully functional</done>
</task>

<task type="auto">
  <name>Task 3: Add stub handlers and register class</name>
  <files>includes/class-rest-calendar.php, functions.php</files>
  <action>
Add stub implementations for OAuth and events endpoints that return 501 Not Implemented:

```php
// OAuth stubs (Phase 48)
public function google_auth_init($request) {
    return new WP_Error('not_implemented', 'Google OAuth not yet configured', ['status' => 501]);
}

public function google_auth_callback($request) {
    return new WP_Error('not_implemented', 'Google OAuth not yet configured', ['status' => 501]);
}

public function test_caldav($request) {
    return new WP_Error('not_implemented', 'CalDAV test not yet implemented', ['status' => 501]);
}

// Events stubs (Phase 49-51)
public function get_events($request) {
    return new WP_Error('not_implemented', 'Events sync not yet implemented', ['status' => 501]);
}

public function get_person_meetings($request) {
    // Return empty structure for now so UI can be built
    return rest_ensure_response([
        'upcoming' => [],
        'past' => [],
        'total_upcoming' => 0,
        'total_past' => 0,
    ]);
}

public function log_event_as_activity($request) {
    return new WP_Error('not_implemented', 'Activity logging not yet implemented', ['status' => 501]);
}
```

**Update functions.php:**

Add to autoloader map:
```php
'RONDO_REST_Calendar' => 'class-rest-calendar.php',
```

Add initialization in rondo_init() with other REST classes (around line 165):
```php
// Calendar REST endpoints
if (stadion_is_rest_request()) {
    new RONDO_REST_Calendar();
}
```
  </action>
  <verify>
- `curl -s /wp-json/rondo/v1/people/1/meetings` returns empty structure (not error)
- `curl -s /wp-json/rondo/v1/calendar/auth/google` returns 501 with message
  </verify>
  <done>All calendar endpoints registered with appropriate stub responses</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All routes appear in `/wp-json/rondo/v1` discovery document
- [ ] Connection CRUD works: create, read, update, delete
- [ ] Credentials are encrypted in storage, not returned in responses
- [ ] Stub endpoints return 501 with descriptive messages
- [ ] `/people/{id}/meetings` returns empty structure (for UI development)
- [ ] `npm run build` succeeds
</verification>

<success_criteria>
- RONDO_REST_Calendar class with all routes registered
- Connection CRUD fully functional with encryption
- OAuth and events stubs return 501
- `/people/{id}/meetings` returns empty but valid response structure
- Class integrated into autoloader and initialization
</success_criteria>

<output>
After completion, create `.planning/phases/47-infrastructure/47-02-SUMMARY.md`
</output>
