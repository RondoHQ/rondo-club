---
phase: 47-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-post-types.php
  - includes/class-calendar-connections.php
  - includes/class-credential-encryption.php
  - functions.php
autonomous: true
---

<objective>
Create calendar infrastructure: calendar_event CPT for caching events, user meta helpers for managing calendar connections, and credential encryption for storing OAuth tokens securely.

Purpose: Establish the data model and helper classes that all subsequent calendar phases will build upon.
Output: calendar_event CPT registered, PRM_Calendar_Connections helper class, PRM_Credential_Encryption class.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Implementation reference
@Calendar-Integration-Implementation-Plan.md (sections 1, 8)

# Existing patterns to follow
@includes/class-post-types.php (CPT registration pattern)
@includes/class-rest-slack.php (sodium encryption pattern for reference)
@functions.php (autoloader registration)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register calendar_event CPT</name>
  <files>includes/class-post-types.php</files>
  <action>
Add `register_calendar_event_post_type()` method to PRM_Post_Types class following existing pattern.

CPT configuration:
- Post type slug: `calendar_event`
- public: false
- show_in_rest: false (custom endpoints only)
- show_ui: false (no admin UI needed)
- supports: ['title', 'author']
- capability_type: 'post'
- map_meta_cap: true

Call the new method from `register_post_types()`.

Do NOT create admin menu or REST base - events are managed via custom endpoints only.
  </action>
  <verify>
- PHPUnit test: `new WP_Query(['post_type' => 'calendar_event'])` runs without error
- `get_post_type_object('calendar_event')` returns object
  </verify>
  <done>calendar_event CPT registered and queryable</done>
</task>

<task type="auto">
  <name>Task 2: Create PRM_Calendar_Connections helper class</name>
  <files>includes/class-calendar-connections.php, functions.php</files>
  <action>
Create new class `PRM_Calendar_Connections` with static methods for managing calendar connections stored in user meta.

User meta key: `_prm_calendar_connections`
Connection structure (array of connection objects):
```php
[
    'id' => 'conn_' . uniqid(),
    'provider' => 'google|caldav',
    'name' => 'Work Calendar',
    'calendar_id' => 'primary',
    'credentials' => '...encrypted...',
    'sync_enabled' => true,
    'auto_log' => true,
    'sync_from_days' => 90,
    'last_sync' => null,
    'last_error' => null,
    'created_at' => current_time('c'),
]
```

Static methods to implement:
- `get_user_connections(int $user_id): array` - Get all connections for user
- `get_connection(int $user_id, string $connection_id): ?array` - Get single connection
- `add_connection(int $user_id, array $connection): string` - Add new, returns ID
- `update_connection(int $user_id, string $connection_id, array $updates): bool` - Update
- `delete_connection(int $user_id, string $connection_id): bool` - Delete connection and its events

The delete_connection method should also delete all calendar_event posts for that connection:
```php
$events = get_posts([
    'post_type' => 'calendar_event',
    'author' => $user_id,
    'meta_key' => '_connection_id',
    'meta_value' => $connection_id,
    'posts_per_page' => -1,
    'fields' => 'ids',
]);
foreach ($events as $event_id) {
    wp_delete_post($event_id, true);
}
```

Add to autoloader in functions.php:
'PRM_Calendar_Connections' => 'class-calendar-connections.php'
  </action>
  <verify>
- PHPUnit test: Add connection, retrieve it, update it, delete it
- Verify delete_connection removes associated calendar_event posts
  </verify>
  <done>PRM_Calendar_Connections class with CRUD methods for user meta connections</done>
</task>

<task type="auto">
  <name>Task 3: Create PRM_Credential_Encryption class</name>
  <files>includes/class-credential-encryption.php, functions.php</files>
  <action>
Create new class `PRM_Credential_Encryption` for securely storing OAuth tokens and CalDAV credentials.

Use sodium encryption (already available via WordPress/PHP). Pattern reference: class-rest-slack.php uses sodium for Slack token encryption.

Static methods to implement:
- `encrypt(array $data): string` - Encrypt credentials array to base64 string
- `decrypt(string $encrypted): ?array` - Decrypt back to array, returns null on failure

Implementation approach:
```php
class PRM_Credential_Encryption {
    private static function get_key(): string {
        // Use WordPress AUTH_KEY as basis, hash to proper length
        return hash('sha256', AUTH_KEY . 'prm_calendar', true);
    }

    public static function encrypt(array $data): string {
        $json = wp_json_encode($data);
        $nonce = random_bytes(SODIUM_CRYPTO_SECRETBOX_NONCEBYTES);
        $ciphertext = sodium_crypto_secretbox($json, $nonce, self::get_key());
        return base64_encode($nonce . $ciphertext);
    }

    public static function decrypt(string $encrypted): ?array {
        try {
            $decoded = base64_decode($encrypted, true);
            if ($decoded === false) return null;

            $nonce = substr($decoded, 0, SODIUM_CRYPTO_SECRETBOX_NONCEBYTES);
            $ciphertext = substr($decoded, SODIUM_CRYPTO_SECRETBOX_NONCEBYTES);

            $plaintext = sodium_crypto_secretbox_open($ciphertext, $nonce, self::get_key());
            if ($plaintext === false) return null;

            return json_decode($plaintext, true);
        } catch (Exception $e) {
            return null;
        }
    }
}
```

Add to autoloader in functions.php:
'PRM_Credential_Encryption' => 'class-credential-encryption.php'
  </action>
  <verify>
- PHPUnit test: Encrypt test data, decrypt it, verify match
- Test that decrypt returns null for invalid/corrupted data
  </verify>
  <done>PRM_Credential_Encryption class with encrypt/decrypt methods using sodium</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `get_post_type_object('calendar_event')` returns valid object
- [ ] PRM_Calendar_Connections::add_connection() creates connection in user meta
- [ ] PRM_Calendar_Connections::delete_connection() removes connection and events
- [ ] PRM_Credential_Encryption::encrypt() and decrypt() round-trip correctly
- [ ] Classes autoload correctly (no require errors)
- [ ] `npm run build` succeeds (no PHP syntax errors breaking the theme)
</verification>

<success_criteria>
- calendar_event CPT registered
- PRM_Calendar_Connections helper class with full CRUD
- PRM_Credential_Encryption with sodium-based encrypt/decrypt
- All classes registered in autoloader
- PHPUnit tests pass for new functionality
</success_criteria>

<output>
After completion, create `.planning/phases/47-infrastructure/47-01-SUMMARY.md`
</output>
