---
phase: 66-psr4-autoloader
plan: 04
type: execute
wave: 2
depends_on: ["66-01", "66-02", "66-03"]
files_modified: [functions.php, includes/class-wp-cli.php, tests/wpunit/AccessControlTest.php, tests/wpunit/RestApiTest.php, tests/wpunit/TodoTest.php]
autonomous: true
---

<objective>
Update all class references to use namespaced classes, add backward compatibility aliases, and finalize the Composer autoloader.

Purpose: Complete the PSR-4 migration by updating all instantiation sites, adding class aliases for backward compatibility, and removing the manual autoloader.
Output: Working Composer autoloading with backward-compatible class aliases.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/64-audit-planning/AUDIT.md

After Plans 66-01, 66-02, 66-03 complete, all classes have namespaces:
- Caelis\Core\* (6 classes)
- Caelis\REST\* (9 classes)
- Caelis\Calendar\* (6 classes)
- Caelis\Notifications\* (3 classes)
- Caelis\Collaboration\* (5 classes)
- Caelis\Import\* (3 classes)
- Caelis\Export\* (2 classes)
- Caelis\CardDAV\* (1 class - Server; 3 already exist)
- Caelis\Data\* (3 classes)

Relevant source files:
@functions.php (main file to update)
@composer.json (already has PSR-4 config)
@includes/class-wp-cli.php (references many classes)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update functions.php with use statements and namespaced instantiations</name>
  <files>functions.php</files>
  <action>
1. Add `use` statements at the top of functions.php (after the opening PHP and before any code):
```php
use Caelis\Core\PostTypes;
use Caelis\Core\Taxonomies;
use Caelis\Core\AutoTitle;
use Caelis\Core\AccessControl;
use Caelis\Core\Visibility;
use Caelis\Core\UserRoles;
use Caelis\REST\Api;
use Caelis\REST\Base;
use Caelis\REST\People;
use Caelis\REST\Companies;
use Caelis\REST\Todos;
use Caelis\REST\Workspaces;
use Caelis\REST\Slack;
use Caelis\REST\ImportExport;
use Caelis\REST\Calendar;
use Caelis\Calendar\Connections;
use Caelis\Calendar\Matcher;
use Caelis\Calendar\Sync;
use Caelis\Calendar\GoogleProvider;
use Caelis\Calendar\CalDAVProvider;
use Caelis\Calendar\GoogleOAuth;
use Caelis\Notifications\Channel;
use Caelis\Notifications\EmailChannel;
use Caelis\Notifications\SlackChannel;
use Caelis\Collaboration\CommentTypes;
use Caelis\Collaboration\WorkspaceMembers;
use Caelis\Collaboration\Mentions;
use Caelis\Collaboration\MentionNotifications;
use Caelis\Collaboration\Reminders;
use Caelis\Import\Monica;
use Caelis\Import\VCard as VCardImport;
use Caelis\Import\GoogleContacts;
use Caelis\Export\VCard as VCardExport;
use Caelis\Export\ICalFeed;
use Caelis\CardDAV\Server as CardDAVServer;
use Caelis\Data\InverseRelationships;
use Caelis\Data\TodoMigration;
use Caelis\Data\CredentialEncryption;
```

2. Update all class instantiations in prm_init() and other functions:
   - `new PRM_Post_Types()` → `new PostTypes()`
   - `new PRM_Taxonomies()` → `new Taxonomies()`
   - `new PRM_Access_Control()` → `new AccessControl()`
   - etc. for all classes

3. Update any static method calls or class references throughout the file.

4. Note: VCard appears in both Import and Export namespaces, so use aliases:
   - `use Caelis\Import\VCard as VCardImport;`
   - `use Caelis\Export\VCard as VCardExport;`
  </action>
  <verify>`php -l functions.php` passes, and grep for "new PRM_" returns no results in functions.php</verify>
  <done>All class references in functions.php use namespaced classes via use statements</done>
</task>

<task type="auto">
  <name>Task 2: Add class aliases and remove manual autoloader</name>
  <files>functions.php</files>
  <action>
1. Remove the entire `prm_autoloader()` function and its `spl_autoload_register()` call (lines ~52-104).

2. Add class aliases AFTER the use statements for backward compatibility. This ensures any code using old PRM_* names still works:

```php
// Backward compatibility class aliases
// These allow code using old PRM_* names to continue working
if ( ! class_exists( 'PRM_Post_Types' ) ) {
    class_alias( PostTypes::class, 'PRM_Post_Types' );
}
if ( ! class_exists( 'PRM_Taxonomies' ) ) {
    class_alias( Taxonomies::class, 'PRM_Taxonomies' );
}
if ( ! class_exists( 'PRM_Auto_Title' ) ) {
    class_alias( AutoTitle::class, 'PRM_Auto_Title' );
}
if ( ! class_exists( 'PRM_Access_Control' ) ) {
    class_alias( AccessControl::class, 'PRM_Access_Control' );
}
if ( ! class_exists( 'PRM_Visibility' ) ) {
    class_alias( Visibility::class, 'PRM_Visibility' );
}
if ( ! class_exists( 'PRM_User_Roles' ) ) {
    class_alias( UserRoles::class, 'PRM_User_Roles' );
}
if ( ! class_exists( 'PRM_Comment_Types' ) ) {
    class_alias( CommentTypes::class, 'PRM_Comment_Types' );
}
if ( ! class_exists( 'PRM_REST_API' ) ) {
    class_alias( Api::class, 'PRM_REST_API' );
}
if ( ! class_exists( 'PRM_REST_Base' ) ) {
    class_alias( Base::class, 'PRM_REST_Base' );
}
if ( ! class_exists( 'PRM_REST_People' ) ) {
    class_alias( People::class, 'PRM_REST_People' );
}
if ( ! class_exists( 'PRM_REST_Companies' ) ) {
    class_alias( Companies::class, 'PRM_REST_Companies' );
}
if ( ! class_exists( 'PRM_REST_Todos' ) ) {
    class_alias( Todos::class, 'PRM_REST_Todos' );
}
if ( ! class_exists( 'PRM_REST_Workspaces' ) ) {
    class_alias( Workspaces::class, 'PRM_REST_Workspaces' );
}
if ( ! class_exists( 'PRM_REST_Slack' ) ) {
    class_alias( Slack::class, 'PRM_REST_Slack' );
}
if ( ! class_exists( 'PRM_REST_Import_Export' ) ) {
    class_alias( ImportExport::class, 'PRM_REST_Import_Export' );
}
if ( ! class_exists( 'PRM_REST_Calendar' ) ) {
    class_alias( Calendar::class, 'PRM_REST_Calendar' );
}
if ( ! class_exists( 'PRM_Reminders' ) ) {
    class_alias( Reminders::class, 'PRM_Reminders' );
}
if ( ! class_exists( 'PRM_Monica_Import' ) ) {
    class_alias( Monica::class, 'PRM_Monica_Import' );
}
if ( ! class_exists( 'PRM_VCard_Import' ) ) {
    class_alias( VCardImport::class, 'PRM_VCard_Import' );
}
if ( ! class_exists( 'PRM_VCard_Export' ) ) {
    class_alias( VCardExport::class, 'PRM_VCard_Export' );
}
if ( ! class_exists( 'PRM_Google_Contacts_Import' ) ) {
    class_alias( GoogleContacts::class, 'PRM_Google_Contacts_Import' );
}
if ( ! class_exists( 'PRM_Inverse_Relationships' ) ) {
    class_alias( InverseRelationships::class, 'PRM_Inverse_Relationships' );
}
if ( ! class_exists( 'PRM_ICal_Feed' ) ) {
    class_alias( ICalFeed::class, 'PRM_ICal_Feed' );
}
if ( ! class_exists( 'PRM_CardDAV_Server' ) ) {
    class_alias( CardDAVServer::class, 'PRM_CardDAV_Server' );
}
if ( ! class_exists( 'PRM_Workspace_Members' ) ) {
    class_alias( WorkspaceMembers::class, 'PRM_Workspace_Members' );
}
if ( ! class_exists( 'PRM_Mentions' ) ) {
    class_alias( Mentions::class, 'PRM_Mentions' );
}
if ( ! class_exists( 'PRM_Mention_Notifications' ) ) {
    class_alias( MentionNotifications::class, 'PRM_Mention_Notifications' );
}
if ( ! class_exists( 'PRM_Todo_Migration' ) ) {
    class_alias( TodoMigration::class, 'PRM_Todo_Migration' );
}
if ( ! class_exists( 'PRM_Calendar_Connections' ) ) {
    class_alias( Connections::class, 'PRM_Calendar_Connections' );
}
if ( ! class_exists( 'PRM_Credential_Encryption' ) ) {
    class_alias( CredentialEncryption::class, 'PRM_Credential_Encryption' );
}
if ( ! class_exists( 'PRM_Google_OAuth' ) ) {
    class_alias( GoogleOAuth::class, 'PRM_Google_OAuth' );
}
if ( ! class_exists( 'PRM_Google_Calendar_Provider' ) ) {
    class_alias( GoogleProvider::class, 'PRM_Google_Calendar_Provider' );
}
if ( ! class_exists( 'PRM_CalDAV_Provider' ) ) {
    class_alias( CalDAVProvider::class, 'PRM_CalDAV_Provider' );
}
if ( ! class_exists( 'PRM_Calendar_Matcher' ) ) {
    class_alias( Matcher::class, 'PRM_Calendar_Matcher' );
}
if ( ! class_exists( 'PRM_Calendar_Sync' ) ) {
    class_alias( Sync::class, 'PRM_Calendar_Sync' );
}
if ( ! class_exists( 'PRM_Notification_Channel' ) ) {
    class_alias( Channel::class, 'PRM_Notification_Channel' );
}
if ( ! class_exists( 'PRM_Email_Channel' ) ) {
    class_alias( EmailChannel::class, 'PRM_Email_Channel' );
}
if ( ! class_exists( 'PRM_Slack_Channel' ) ) {
    class_alias( SlackChannel::class, 'PRM_Slack_Channel' );
}
```

3. Ensure Composer autoloader is loaded at the start of functions.php (should already be there via WordPress, but verify):
```php
require_once __DIR__ . '/vendor/autoload.php';
```
  </action>
  <verify>Manual autoloader function removed: `grep -c "function prm_autoloader" functions.php` returns 0. Class aliases present: `grep -c "class_alias" functions.php` returns 38+</verify>
  <done>Manual autoloader removed, class aliases added for all 38 classes, Composer autoloader verified</done>
</task>

<task type="auto">
  <name>Task 3: Update WP-CLI and tests, run verification</name>
  <files>includes/class-wp-cli.php, tests/wpunit/AccessControlTest.php, tests/wpunit/RestApiTest.php, tests/wpunit/TodoTest.php</files>
  <action>
1. Update class-wp-cli.php to add use statements for any PRM_* classes it references:
   - Search for `new PRM_` and `PRM_*::` patterns
   - Add appropriate `use` statements at the top
   - Update instantiations to use short names

2. Update test files to use namespaced classes:
   - Add `use` statements for any classes directly instantiated
   - Tests that use old class names will still work via aliases

3. Run Composer dump-autoload to regenerate autoloader:
   ```bash
   composer dump-autoload -o
   ```

4. Run full test suite:
   ```bash
   ./vendor/bin/phpunit
   ```

5. Run PHPCS to ensure no new issues:
   ```bash
   composer lint
   ```
  </action>
  <verify>All tests pass: `./vendor/bin/phpunit` shows 120+ tests passing. PHPCS clean: `composer lint` shows no errors.</verify>
  <done>WP-CLI updated, tests updated and passing, Composer autoloader regenerated, PHPCS passing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] No `prm_autoloader` function in functions.php
- [ ] All class aliases present (38 aliases)
- [ ] `composer dump-autoload -o` runs successfully
- [ ] All 120+ PHPUnit tests pass
- [ ] `composer lint` passes
- [ ] Manual smoke test: site loads, REST API works
</verification>

<success_criteria>
- All tasks completed
- Manual autoloader completely removed
- Composer PSR-4 autoloading working
- All 38 class aliases in place for backward compatibility
- All tests pass (120+ tests)
- PHPCS passes
- No breaking changes to functionality
</success_criteria>

<output>
After completion, create `.planning/phases/66-psr4-autoloader/66-04-SUMMARY.md`
</output>
