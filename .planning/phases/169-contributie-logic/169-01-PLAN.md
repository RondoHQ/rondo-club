---
phase: 169-contributie-logic
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-membership-fees.php
  - includes/class-rest-api.php
  - includes/class-rest-google-sheets.php
  - includes/class-fee-cache-invalidator.php
  - ../developer/src/content/docs/features/former-members.md
  - CHANGELOG.md
  - package.json
  - style.css
autonomous: true

must_haves:
  truths:
    - "Former members with lid-sinds before season end appear in the contributie list"
    - "Former members use normal pro-rata based on lid-sinds (leaving doesn't change fee)"
    - "Former members with lid-sinds after season end are excluded from the contributie list"
    - "Fee calculation diagnostics correctly explain former member treatment"
    - "Family discount calculation excludes former members who should not be on the fee list"
    - "Google Sheets export applies the same former member fee rules"
  artifacts:
    - path: "includes/class-membership-fees.php"
      provides: "Former member fee logic: lid-sinds season check"
      contains: "is_former_member_in_season"
    - path: "includes/class-rest-api.php"
      provides: "Fee list endpoint filters former members by lid-sinds season eligibility"
      contains: "former_member"
    - path: "includes/class-rest-google-sheets.php"
      provides: "Google Sheets export applies former member fee rules"
      contains: "former_member"
  key_links:
    - from: "includes/class-rest-api.php (get_fee_list)"
      to: "includes/class-membership-fees.php (is_former_member_in_season)"
      via: "Season eligibility check before fee calculation"
      pattern: "is_former_member_in_season"
---

<objective>
Make fee calculations correctly handle former members: include them if they were active during the season (lid-sinds before season end), use normal pro-rata based on lid-sinds (leaving doesn't change the fee), and exclude them if they joined after the season ended.

Purpose: Complete the v23.0 Former Members milestone by ensuring the contributie system properly accounts for members who left during the season.
Output: Updated fee calculation engine, REST API fee list, Google Sheets export, diagnostics, and documentation.
</objective>

<execution_context>
@/Users/joostdevald/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/166-backend-foundation/166-01-SUMMARY.md
@.planning/phases/167-core-filtering/167-01-SUMMARY.md
@.planning/phases/168-visibility-controls/168-01-SUMMARY.md
@includes/class-membership-fees.php
@includes/class-rest-api.php
@includes/class-rest-google-sheets.php
@includes/class-fee-cache-invalidator.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add former member fee logic to backend</name>
  <files>
    includes/class-membership-fees.php
    includes/class-rest-api.php
    includes/class-rest-google-sheets.php
    includes/class-fee-cache-invalidator.php
  </files>
  <action>
**In `includes/class-membership-fees.php`:**

1. Add a new public method `is_former_member_in_season()` that determines if a former member should be included in the fee list for a given season:
   ```php
   public function is_former_member_in_season( int $person_id, ?string $season = null ): bool
   ```
   - Check if person has `former_member` field set to true (use `get_field('former_member', $person_id) == true` for loose comparison, same pattern as phase 168).
   - If not a former member, return false (this method is only for former members).
   - Get the person's `lid-sinds` field value (ACF field on person post).
   - If `lid-sinds` is empty/null, return false (cannot determine season eligibility without membership date).
   - A former member qualifies if their `lid-sinds` date is BEFORE the end of the season (< July 1 of season_end_year). This covers:
     - Members who joined before season start and left during it (normal fee, no pro-rata)
     - Members who joined mid-season and left during it (pro-rata based on lid-sinds, as normal)

   Implementation:
   ```php
   $season = $season ?? $this->get_season_key();
   $season_end_year = (int) substr($season, 5, 4);
   $season_end_date = strtotime($season_end_year . '-07-01');
   $lid_sinds_ts = strtotime($lid_sinds);
   return ($lid_sinds_ts !== false && $lid_sinds_ts < $season_end_date);
   ```

   **NOTE:** No pro-rata override is needed. Former members use the same pro-rata calculation as active members — their fee is based on when they joined (lid-sinds), not when they left. Leaving the club doesn't change their fee amount.

2. Add `'is_former_member'` flag to the return arrays of `get_fee_for_person_cached()` and `calculate_full_fee()` for diagnostics/display purposes only. No change to the fee calculation logic itself — former members are calculated the same as active members.

   In `get_fee_for_person_cached()`, add:
   ```php
   $is_former = ( get_field( 'former_member', $person_id ) == true );
   ```
   Include `'is_former_member' => $is_former` in the return data.

3. Modify `get_calculation_status()` to include former member information in diagnostics:
   - Add `'is_former_member'` boolean to the returned array.
   - Add `'former_member_in_season'` boolean to indicate if former member qualifies for season.
   - If former member and not in season, set reason to `'former_member_not_in_season'`.

5. Modify `build_family_groups()` to exclude former members who are NOT eligible for the current season's fee list. Before calculating fee for each person, check:
   ```php
   $is_former = ( get_field( 'former_member', $person_id ) == true );
   if ( $is_former && ! $this->is_former_member_in_season( $person_id, $season ) ) {
       continue; // Skip former members not in this season
   }
   ```
   This prevents former members from incorrectly affecting family discount calculations.

**In `includes/class-rest-api.php`:**

6. Modify `get_fee_list()` (around line 2948-2987): In the foreach loop over query results, add former member handling BEFORE the fee calculation:
   ```php
   $is_former = ( get_field( 'former_member', $person->ID ) == true );

   // Former members: only include if they have lid-sinds in current season
   if ( $is_former && ! $fees->is_former_member_in_season( $person->ID, $season ) ) {
       continue;
   }
   ```

   Also add `'is_former_member'` to the result array for each member:
   ```php
   'is_former_member' => $is_former,
   ```

   For the forecast path: former members should be EXCLUDED from forecast entirely (they won't be members next season). Add a check:
   ```php
   if ( $forecast && $is_former ) {
       continue; // Former members excluded from forecast
   }
   ```

7. Modify `get_person_fee()` (around line 3065): Add `'is_former_member'` to the response. Also, if the person is a former member not in the requested season, return a specific message:
   ```php
   $is_former = ( get_field( 'former_member', $person->ID ) == true );
   if ( $is_former && ! $fees->is_former_member_in_season( $person_id, $season ) ) {
       return rest_ensure_response([
           'person_id'  => $person_id,
           'season'     => $season,
           'calculable' => false,
           'is_former_member' => true,
           'message'    => 'Oud-lid valt niet binnen dit seizoen.',
       ]);
   }
   ```
   Add `'is_former_member' => $is_former` to the successful response array.

**In `includes/class-rest-google-sheets.php`:**

8. Modify `fetch_fee_data()` (around line 876): Add the same former member filtering as the REST API fee list. Before calculating fees:
   ```php
   $is_former = ( get_field( 'former_member', $person->ID ) == true );

   // Former members: only include if in current season, exclude from forecast
   if ( $is_former ) {
       if ( $forecast || ! $fees->is_former_member_in_season( $person->ID, $season ) ) {
           continue;
       }
   }
   ```
   Also add `'is_former_member'` to the result data if it's included in the export.

**In `includes/class-fee-cache-invalidator.php`:**

9. Add a hook for `former_member` field changes to invalidate the fee cache:
   ```php
   add_filter( 'acf/update_value/name=former_member', [ $this, 'invalidate_person_cache' ], 10, 3 );
   ```
   This ensures that when rondo-sync marks a member as former, their fee cache is cleared and recalculated with the new former member logic.
  </action>
  <verify>
Run `npm run build` to ensure no PHP syntax errors break the build process. Verify that `includes/class-membership-fees.php` contains the new `is_former_member_in_season` method. Verify that `includes/class-rest-api.php` contains `is_former_member` in the fee list response. Verify that `includes/class-fee-cache-invalidator.php` has the new `former_member` hook. Deploy to production with `bin/deploy.sh` and verify the fee list endpoint returns data.
  </verify>
  <done>
Fee calculation engine correctly handles former members: eligible former members (lid-sinds before season end) appear in fee list with normal pro-rata based on lid-sinds, ineligible former members are excluded, family discount calculation excludes ineligible former members, Google Sheets export applies same rules, and cache invalidation triggers on former_member field changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update documentation and version</name>
  <files>
    ../developer/src/content/docs/features/former-members.md
    CHANGELOG.md
    package.json
    style.css
  </files>
  <action>
**In `../developer/src/content/docs/features/former-members.md`:**

Add a new "## Contributie Logic" section documenting:
- Former member fee eligibility criteria (lid-sinds before season end)
- Pro-rata uses normal lid-sinds-based calculation (leaving doesn't change fee)
- Forecast exclusion (former members not included in next season forecast)
- Family discount handling (ineligible former members excluded from family groups)
- API response includes `is_former_member` field
- Cache invalidation on former_member field changes
- Example: a member with lid-sinds 2025-09-15 who leaves in January 2026 appears in 2025-2026 fee list with pro-rata from September

**Version bump:**
- Bump version to 23.2.0 in `style.css` and `package.json` (minor version for new fee logic feature)

**Changelog:**
- Add `[23.2.0]` entry under `## [Unreleased]` (or create new section):
  - Added: Former member fee calculation logic - eligible former members appear in contributie list
  - Added: Former members use normal pro-rata based on lid-sinds (leaving doesn't affect fee)
  - Added: Former member exclusion from fee forecast
  - Added: `is_former_member` field in fee API responses
  - Added: Fee cache invalidation on former_member field changes
  </action>
  <verify>
Verify that `../developer/src/content/docs/features/former-members.md` contains the new "Contributie Logic" section. Verify version is 23.2.0 in both `package.json` and `style.css`. Verify CHANGELOG.md has the 23.2.0 entry. Run `npm run build` to ensure everything builds correctly.
  </verify>
  <done>
Documentation updated with former member fee logic details, version bumped to 23.2.0, changelog entry added with all changes.
  </done>
</task>

</tasks>

<verification>
1. Fee list endpoint (`/rondo/v1/fees`) includes former members who have lid-sinds before season end
2. Fee list endpoint excludes former members whose lid-sinds is after the season end or who have no lid-sinds
3. Former members in the fee list have `is_former_member: true` in the response
4. Former members use normal pro-rata based on lid-sinds (same as active members)
5. Forecast endpoint (`/rondo/v1/fees?forecast=true`) excludes all former members
6. Single person fee endpoint (`/rondo/v1/fees/person/{id}`) correctly handles former members
7. Google Sheets export applies the same former member rules
8. Family discount calculation excludes ineligible former members
9. Fee cache is invalidated when former_member field changes
10. `npm run build` succeeds without errors
11. Documentation updated with contributie logic section
12. Version bumped to 23.2.0
</verification>

<success_criteria>
- Former members with lid-sinds before season end appear in contributie list with normal pro-rata
- Former members with lid-sinds after season end or no lid-sinds are excluded
- Pro-rata is based on lid-sinds date (leaving doesn't change fee)
- Forecast excludes former members entirely
- All fee endpoints return is_former_member flag
- Documentation describes former member fee treatment
</success_criteria>

<output>
After completion, create `.planning/phases/169-contributie-logic/169-01-SUMMARY.md`
</output>
