# Plan 123-01: Settings backend and calculation service class

---
wave: 1
depends_on: []
files_modified:
  - includes/class-membership-fees.php (NEW)
  - includes/class-rest-api.php
  - functions.php
  - src/api/client.js
autonomous: true
---

## Goal

Create the PHP backend infrastructure for membership fee settings: a MembershipFees service class that stores/retrieves fee amounts using the WordPress Options API, and REST API endpoints for reading and updating these settings.

## Context

- Phase 123 establishes the settings foundation for v12.0 Membership Fees
- Requirements SET-01 through SET-06 define six configurable fee types
- Use single option array pattern (like VOGEmail) for efficient storage
- REST API pattern follows `/rondo/v1/vog/settings` example (GET + POST on same route)
- Admin-only endpoints using `check_admin_permission` callback

## Tasks

<task id="1">
Create the MembershipFees service class file at `includes/class-membership-fees.php` following the VOGEmail pattern:

Namespace: `Stadion\Fees`
Class: `MembershipFees`

Option storage (single array for efficiency):
```php
const OPTION_KEY = 'stadion_membership_fees';
```

Default values:
- mini: 130
- pupil: 180
- junior: 230
- senior: 255
- recreant: 65
- donateur: 55

Methods to implement:
- `get_all_settings(): array` - Return all fee amounts with defaults
- `get_fee(string $type): int` - Get single fee amount by type
- `update_settings(array $fees): bool` - Update all fee amounts (with validation)

Use `get_option()` with defaults and `update_option()` for persistence.
Include validation that all values are non-negative integers.
</task>

<task id="2">
Register REST API endpoints in `includes/class-rest-api.php` for membership fee settings:

Add to `register_routes()` method (after VOG settings routes):
```php
// Membership fee settings (admin only)
register_rest_route(
    'rondo/v1',
    '/membership-fees/settings',
    [
        [
            'methods'             => \WP_REST_Server::READABLE,
            'callback'            => [ $this, 'get_membership_fee_settings' ],
            'permission_callback' => [ $this, 'check_admin_permission' ],
        ],
        [
            'methods'             => \WP_REST_Server::CREATABLE,
            'callback'            => [ $this, 'update_membership_fee_settings' ],
            'permission_callback' => [ $this, 'check_admin_permission' ],
            'args'                => [
                'mini'     => [ 'required' => false, 'validate_callback' => fn($p) => is_numeric($p) && $p >= 0 ],
                'pupil'    => [ 'required' => false, 'validate_callback' => fn($p) => is_numeric($p) && $p >= 0 ],
                'junior'   => [ 'required' => false, 'validate_callback' => fn($p) => is_numeric($p) && $p >= 0 ],
                'senior'   => [ 'required' => false, 'validate_callback' => fn($p) => is_numeric($p) && $p >= 0 ],
                'recreant' => [ 'required' => false, 'validate_callback' => fn($p) => is_numeric($p) && $p >= 0 ],
                'donateur' => [ 'required' => false, 'validate_callback' => fn($p) => is_numeric($p) && $p >= 0 ],
            ],
        ],
    ]
);
```

Add callback methods:
- `get_membership_fee_settings()` - Instantiate MembershipFees, call get_all_settings()
- `update_membership_fee_settings($request)` - Collect params, update settings, return updated values
</task>

<task id="3">
Add use statement in `functions.php` to import the new class:
```php
use Stadion\Fees\MembershipFees;
```

The class is auto-loaded via Composer PSR-4, no explicit instantiation needed (used on-demand in REST callbacks).
</task>

<task id="4">
Add API client methods in `src/api/client.js` in the prmApi object:

```javascript
// Membership Fee Settings (admin only)
getMembershipFeeSettings: () => api.get('/rondo/v1/membership-fees/settings'),
updateMembershipFeeSettings: (settings) => api.post('/rondo/v1/membership-fees/settings', settings),
```

Add these after the VOG settings methods (around line 294-295).
</task>

<task id="5">
Test the backend implementation:
1. Run `npm run build` to ensure frontend changes compile
2. Deploy to production using `bin/deploy.sh`
3. Verify REST API endpoints respond correctly using browser dev tools or curl:
   - GET `/wp-json/rondo/v1/membership-fees/settings` should return default values
   - POST with updated values should persist and return new values
</task>

## Verification

After completing all tasks:
- [ ] `includes/class-membership-fees.php` exists with MembershipFees class
- [ ] REST endpoint GET `/rondo/v1/membership-fees/settings` returns fee defaults
- [ ] REST endpoint POST `/rondo/v1/membership-fees/settings` updates and persists fees
- [ ] Only admin users can access these endpoints (non-admin returns 403)
- [ ] API client has `getMembershipFeeSettings` and `updateMembershipFeeSettings` methods
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes

## must_haves

These criteria verify the phase goal "Admin can configure all fee amounts through settings UI" from the backend side:

1. MembershipFees service class exists with get/update methods
2. REST API endpoints registered under `/rondo/v1/membership-fees/settings`
3. Default fee values returned: mini=130, pupil=180, junior=230, senior=255, recreant=65, donateur=55
4. Fee amounts persist after update (survive page reload)
5. Endpoints restricted to admin users only
