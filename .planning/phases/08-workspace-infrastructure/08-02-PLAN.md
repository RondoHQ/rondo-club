---
phase: 08-workspace-infrastructure
plan: 02
type: execute
depends_on: ["08-01"]
files_modified: [includes/class-post-types.php, includes/class-rest-workspaces.php]
---

<objective>
Implement workspace invitation system - CPT for tracking invites, REST endpoints for invite management, and email notifications.

Purpose: Enable workspace admins to invite users by email with secure token-based acceptance.
Output: workspace_invite CPT, invite REST endpoints, and email delivery.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-workspace-infrastructure/08-01-SUMMARY.md

**Key files to understand:**
@includes/class-post-types.php
@includes/class-rest-workspaces.php (after 08-01)

**Tech stack available:** WordPress CPT, wp_mail(), wp_generate_password()
**Established patterns:** CPT registration in RONDO_Post_Types, REST endpoints in domain classes
**Constraining decisions:**
- Phase 7: Workspace membership via RONDO_Workspace_Members
- Phase 8-01: RONDO_REST_Workspaces class exists
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register workspace_invite CPT</name>
  <files>includes/class-post-types.php</files>
  <action>
Add register_workspace_invite_post_type() method to RONDO_Post_Types:

1. Post type slug: workspace_invite
2. Labels: Workspace Invites / Workspace Invite
3. Settings:
   - public: false
   - publicly_queryable: false
   - show_ui: true (for admin debugging)
   - show_in_menu: 'edit.php?post_type=workspace' (submenu under Workspaces)
   - show_in_rest: false (custom endpoints only, not wp/v2)
   - supports: ['title'] (title = email address for easy identification)

4. Call in constructor via add_action('init', ...)

5. Add ACF field group (JSON in acf-json/) with fields:
   - _invite_workspace_id (number) - The workspace being invited to
   - _invite_email (email) - Invitee email address
   - _invite_role (select: admin|member|viewer) - Role to assign
   - _invite_token (text) - Secure random token for URL
   - _invite_status (select: pending|accepted|expired|revoked) - Current status
   - _invite_expires_at (text) - ISO 8601 expiration timestamp
   - _invite_accepted_by (number) - User ID who accepted (after acceptance)

Note: Title will auto-generate as email address for easy admin identification.
  </action>
  <verify>WP CLI: wp post-type list --format=table | grep workspace_invite</verify>
  <done>
    - workspace_invite CPT registered
    - ACF field group created in acf-json/
    - Shows in admin under Workspaces menu
  </done>
</task>

<task type="auto">
  <name>Task 2: Add invite REST endpoints to RONDO_REST_Workspaces</name>
  <files>includes/class-rest-workspaces.php</files>
  <action>
Add invite management endpoints to RONDO_REST_Workspaces:

1. POST /rondo/v1/workspaces/(?P<id>\d+)/invites - Create & send invite
   - Permission: check_workspace_admin
   - Args: email (required), role (optional, default 'member')
   - Validation:
     - Email format valid
     - User with email not already workspace member
     - No pending invite for same email+workspace exists
   - Creates workspace_invite post with:
     - title = email
     - _invite_workspace_id = workspace ID
     - _invite_email = email
     - _invite_role = role
     - _invite_token = wp_generate_password(32, false) (alphanumeric)
     - _invite_status = 'pending'
     - _invite_expires_at = 7 days from now (ISO 8601)
   - Sends invitation email (see send_invite_email() helper)
   - Returns invite data (id, email, role, status, expires_at)

2. GET /rondo/v1/workspaces/(?P<id>\d+)/invites - List pending invites
   - Permission: check_workspace_admin
   - Returns array of pending invites for workspace

3. DELETE /rondo/v1/workspaces/(?P<id>\d+)/invites/(?P<invite_id>\d+) - Revoke invite
   - Permission: check_workspace_admin
   - Sets _invite_status = 'revoked'
   - Returns success

4. GET /rondo/v1/invites/(?P<token>[a-zA-Z0-9]+) - Validate invite (PUBLIC)
   - Permission: __return_true (public endpoint)
   - Finds invite by token
   - Checks status = 'pending' and not expired
   - Returns workspace name, role, inviter info (or error)
   - Does NOT require auth (user may not have account yet)

5. POST /rondo/v1/invites/(?P<token>[a-zA-Z0-9]+)/accept - Accept invite
   - Permission: check_user_approved
   - Validates token, status, expiry
   - Validates current user's email matches invite email OR user is admin
   - Adds user to workspace via RONDO_Workspace_Members::add()
   - Updates invite: _invite_status = 'accepted', _invite_accepted_by = user ID
   - Returns workspace data

Helper method send_invite_email($invite_id):
- Gets invite data
- Gets workspace title
- Gets inviter name (post_author of invite)
- Builds accept URL: site_url() . '/workspace-invite/' . token (React route)
- Sends via wp_mail() with HTML template:
  Subject: "You've been invited to [Workspace Name] on Stadion"
  Body: Inviter invited you, click to accept, expires in 7 days
  </action>
  <verify>Test: Create invite via curl POST, check email in server logs/mailhog</verify>
  <done>
    - 5 invite endpoints functional
    - Public token validation works without auth
    - Email sends on invite creation
    - Accept adds user to workspace
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] workspace_invite CPT shows in admin
- [ ] ACF fields editable on invite posts
- [ ] Create invite via API sends email
- [ ] Token validation returns workspace info
- [ ] Accept invite adds user to workspace membership
- [ ] `npm run build` succeeds
- [ ] Deployed to production
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Invitations can be created, validated, and accepted via API
- Email delivery working
</success_criteria>

<output>
After completion, create `.planning/phases/08-workspace-infrastructure/08-02-SUMMARY.md`
</output>
