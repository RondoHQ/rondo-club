---
phase: 08-workspace-infrastructure
plan: 01
type: execute
depends_on: []
files_modified: [includes/class-rest-workspaces.php, functions.php]
---

<objective>
Create REST API endpoints for workspace management - listing workspaces, viewing details, and managing members.

Purpose: Enable the frontend to interact with workspaces and manage team membership through the API.
Output: New PRM_REST_Workspaces class with CRUD endpoints for workspaces and members.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-data-model-visibility/07-03-SUMMARY.md
@.planning/phases/07-data-model-visibility/07-04-SUMMARY.md

**Key files to understand:**
@includes/class-rest-base.php
@includes/class-workspace-members.php
@includes/class-rest-people.php

**Tech stack available:** WordPress REST API, PRM_REST_Base pattern
**Established patterns:** Domain-specific REST classes extend PRM_REST_Base
**Constraining decisions:**
- Phase 7: Workspace membership stored in user meta via PRM_Workspace_Members
- Phase 7: Workspace CPT registered at rest_base='workspaces'
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PRM_REST_Workspaces class with member endpoints</name>
  <files>includes/class-rest-workspaces.php, functions.php</files>
  <action>
Create new PRM_REST_Workspaces class extending PRM_REST_Base:

1. In constructor, register routes via `add_action('rest_api_init', [$this, 'register_routes'])`:

   - GET /prm/v1/workspaces - List user's workspaces
     - Permission: check_user_approved
     - Returns array of workspaces with id, title, role, member_count
     - Uses PRM_Workspace_Members::get_user_workspaces() + enriches with post data

   - GET /prm/v1/workspaces/(?P<id>\d+) - Get workspace details
     - Permission: check_workspace_access (new method - user must be member)
     - Returns workspace data + full member list with user info
     - Uses PRM_Workspace_Members::get_members()

   - POST /prm/v1/workspaces/(?P<id>\d+)/members - Add member
     - Permission: check_workspace_admin (new method - user must be admin)
     - Args: user_id (required), role (optional, default 'member')
     - Validates user exists, uses PRM_Workspace_Members::add()
     - Returns success with member data

   - DELETE /prm/v1/workspaces/(?P<id>\d+)/members/(?P<user_id>\d+) - Remove member
     - Permission: check_workspace_admin
     - Uses PRM_Workspace_Members::remove()
     - Prevent removing workspace owner (handled by class)

   - PUT /prm/v1/workspaces/(?P<id>\d+)/members/(?P<user_id>\d+) - Update role
     - Permission: check_workspace_admin
     - Args: role (required, one of admin|member|viewer)
     - Uses PRM_Workspace_Members::update_role()

2. Add permission methods:
   - check_workspace_access($request) - Is user member of workspace from request?
   - check_workspace_admin($request) - Is user admin of workspace from request?

3. Update functions.php autoloader to map 'PRM_REST_Workspaces' => 'class-rest-workspaces.php'

4. Update prm_init() to instantiate PRM_REST_Workspaces after other REST classes.

Follow existing pattern from PRM_REST_People: extend PRM_REST_Base, register routes in constructor.
  </action>
  <verify>Check route registration via: curl -X OPTIONS https://cael.is/wp-json/prm/v1/workspaces (should show GET method)</verify>
  <done>
    - PRM_REST_Workspaces class created with all 5 endpoints
    - Permission callbacks check workspace membership/admin status
    - Class registered in autoloader and instantiated in prm_init()
    - All endpoints respond (OPTIONS check shows methods)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add workspace creation and update endpoints</name>
  <files>includes/class-rest-workspaces.php</files>
  <action>
Add CRUD endpoints for workspace posts themselves:

1. POST /prm/v1/workspaces - Create workspace
   - Permission: check_user_approved
   - Args: title (required), description (optional)
   - Creates workspace CPT post with current user as author
   - PRM_Workspace_Members hook auto-adds author as admin (from 07-03)
   - Returns workspace data

2. PUT /prm/v1/workspaces/(?P<id>\d+) - Update workspace
   - Permission: check_workspace_admin
   - Args: title (optional), description (optional)
   - Updates workspace post
   - Returns updated workspace data

3. DELETE /prm/v1/workspaces/(?P<id>\d+) - Delete workspace
   - Permission: Must be workspace owner (post_author)
   - Moves workspace to trash
   - Returns success

Note: Use wp_insert_post(), wp_update_post(), wp_trash_post() - standard WordPress functions.
  </action>
  <verify>Test create: curl -X POST https://cael.is/wp-json/prm/v1/workspaces -H "X-WP-Nonce: ..." -d "title=Test"</verify>
  <done>
    - POST/PUT/DELETE endpoints for workspace CRUD
    - Only owner can delete (stricter than admin)
    - npm run build succeeds
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] All 8 REST endpoints registered (OPTIONS /prm/v1/workspaces shows methods)
- [ ] GET /prm/v1/workspaces returns user's workspaces
- [ ] Workspace member operations work via API
- [ ] Non-members cannot access workspace endpoints
- [ ] Deployed to production
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript/PHP errors
- Workspace management API fully functional
</success_criteria>

<output>
After completion, create `.planning/phases/08-workspace-infrastructure/08-01-SUMMARY.md`
</output>
