---
phase: 08-workspace-infrastructure
plan: 03
type: execute
depends_on: []
files_modified: [includes/class-taxonomies.php]
---

<objective>
Auto-sync workspace_access taxonomy terms when contacts are assigned to workspaces, ensuring the taxonomy reflects workspace assignments.

Purpose: Keep workspace_access terms in sync with visibility settings for efficient WordPress queries.
Output: Hook that creates/manages workspace-{ID} terms and assigns them to contacts.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-data-model-visibility/07-01-SUMMARY.md
@.planning/phases/07-data-model-visibility/07-04-SUMMARY.md

**Key files to understand:**
@includes/class-taxonomies.php
@includes/class-access-control.php

**Tech stack available:** WordPress taxonomy API, ACF hooks
**Established patterns:** Taxonomy registration in STADION_Taxonomies
**Constraining decisions:**
- Phase 7: workspace_access taxonomy with term slugs `workspace-{ID}`
- Phase 7: Access control queries workspace_access terms for visibility checks
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create workspace term sync functionality</name>
  <files>includes/class-taxonomies.php</files>
  <action>
Add workspace term sync to STADION_Taxonomies:

1. In constructor, register hooks:
   - add_action('save_post_workspace', [$this, 'ensure_workspace_term'], 10, 3)
   - add_action('before_delete_post', [$this, 'cleanup_workspace_term'])
   - add_action('acf/save_post', [$this, 'sync_contact_workspace_terms'], 20)

2. ensure_workspace_term($post_id, $post, $update):
   - When workspace created/published, ensure term exists
   - Term slug: 'workspace-' . $post_id
   - Term name: $post->post_title
   - If term exists, update name to match workspace title
   - Use wp_insert_term() or wp_update_term()

3. cleanup_workspace_term($post_id):
   - When workspace permanently deleted
   - Get post, check if post_type === 'workspace'
   - Delete the workspace-{ID} term via wp_delete_term()
   - This also removes term relationships from contacts

4. sync_contact_workspace_terms($post_id):
   - Only run for person, company, important_date post types
   - Get current _visibility value
   - If visibility === 'workspace':
     - Get assigned workspaces (how? need to add _assigned_workspaces meta)
     - Assign workspace-{ID} terms to contact
   - If visibility !== 'workspace':
     - Remove all workspace_access terms from contact
   - Use wp_set_object_terms()

Note: We need a way to assign contacts to workspaces. Options:
   a) Use workspace_access taxonomy directly (let ACF manage term selection)
   b) Add _assigned_workspaces post meta (array of workspace IDs)

Option (a) is cleaner - ACF already supports taxonomy fields. Add ACF field for workspace_access taxonomy selection that shows when visibility = 'workspace'.

5. Add ACF field to visibility group:
   - _assigned_workspaces (taxonomy field for workspace_access)
   - Conditional: only show when _visibility = 'workspace'
   - Multiple selection allowed
   - Return format: term ID array

The taxonomy assignment will be handled by ACF automatically, but we need to ensure terms exist first.
  </action>
  <verify>Create workspace, verify term exists: wp term list workspace_access --format=table</verify>
  <done>
    - Workspace terms auto-created when workspace published
    - Term names stay in sync with workspace titles
    - Term cleanup on workspace deletion
    - ACF field allows workspace selection for contacts
  </done>
</task>

<task type="auto">
  <name>Task 2: Update visibility ACF field group</name>
  <files>acf-json/group_visibility_settings.json</files>
  <action>
Update the visibility settings ACF field group (created in 07-02):

1. Add new field after _visibility:
   - Field name: _assigned_workspaces
   - Field type: taxonomy
   - Taxonomy: workspace_access
   - Appearance: Checkbox (for easy multi-select)
   - Allow null: yes
   - Save terms: yes (ACF will handle term relationships)
   - Load terms: yes
   - Return format: id

2. Add conditional logic to _assigned_workspaces:
   - Show this field if: _visibility equals 'workspace'

This way:
- User sets visibility to 'workspace'
- Workspace selection field appears
- User selects which workspaces can see this contact
- ACF automatically manages the term relationships
- Access control queries already look for these terms (from 07-04)

No need for sync_contact_workspace_terms hook - ACF handles it with save_terms: true.
  </action>
  <verify>Edit a person in WP admin, set visibility=workspace, verify workspace checkboxes appear</verify>
  <done>
    - ACF field shows workspace selection when visibility=workspace
    - Term relationships saved automatically
    - Existing access control queries work with assigned terms
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] New workspace creates workspace-{ID} term
- [ ] Workspace title change updates term name
- [ ] Workspace deletion removes term
- [ ] ACF shows workspace selection for contacts with visibility=workspace
- [ ] Contact assigned to workspace appears in workspace_access terms
- [ ] Access control respects workspace assignment (from 07-04)
- [ ] `npm run build` succeeds
- [ ] Deployed to production
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Workspace terms auto-sync with workspace posts
- Contacts can be assigned to workspaces via ACF
- Phase 8: Workspace & Team Infrastructure complete
</success_criteria>

<output>
After completion, create `.planning/phases/08-workspace-infrastructure/08-03-SUMMARY.md`
</output>
