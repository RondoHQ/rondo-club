---
phase: 118-custom-field-edit-control
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/customfields/class-manager.php
  - includes/class-rest-custom-fields.php
  - src/components/FieldFormPanel.jsx
  - src/components/CustomFieldsSection.jsx
  - src/components/CustomFieldsEditModal.jsx
autonomous: true

must_haves:
  truths:
    - "Custom field settings UI shows 'Bewerkbaar in UI' checkbox"
    - "Fields with editable_in_ui=true show normal edit button on detail pages"
    - "Fields with editable_in_ui=false display value but no edit button"
    - "Fields with editable_in_ui=false can still be updated via REST API"
    - "New fields default to editable_in_ui=true (backward compatible)"
  artifacts:
    - path: "includes/customfields/class-manager.php"
      provides: "editable_in_ui property in UPDATABLE_PROPERTIES"
      contains: "editable_in_ui"
    - path: "includes/class-rest-custom-fields.php"
      provides: "editable_in_ui in metadata response and API params"
      contains: "editable_in_ui"
    - path: "src/components/FieldFormPanel.jsx"
      provides: "Bewerkbaar in UI toggle in validation section"
      contains: "editable_in_ui"
    - path: "src/components/CustomFieldsSection.jsx"
      provides: "Conditional edit button based on editable fields"
      contains: "editable_in_ui"
    - path: "src/components/CustomFieldsEditModal.jsx"
      provides: "Read-only display for non-editable fields"
      contains: "editable_in_ui"
  key_links:
    - from: "FieldFormPanel.jsx"
      to: "REST API"
      via: "onSubmit includes editable_in_ui"
      pattern: "editable_in_ui"
    - from: "CustomFieldsSection.jsx"
      to: "metadata API"
      via: "field.editable_in_ui check"
      pattern: "editable_in_ui.*false"
    - from: "CustomFieldsEditModal.jsx"
      to: "field definition"
      via: "read-only rendering for non-editable"
      pattern: "editable_in_ui.*false"
---

<objective>
Add UI-level editability control to custom fields, allowing admins to mark fields as read-only in the UI while keeping them accessible via REST API.

Purpose: Enables Sportlink-managed fields to be visible in the UI but not editable by users, preserving API automation while preventing manual edits.
Output: Complete editable_in_ui feature across backend (PHP) and frontend (React).
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/118-custom-field-edit-control/118-CONTEXT.md
@.planning/phases/118-custom-field-edit-control/118-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add editable_in_ui property to PHP backend</name>
  <files>
    includes/customfields/class-manager.php
    includes/class-rest-custom-fields.php
  </files>
  <action>
    1. In `class-manager.php`:
       - Add `'editable_in_ui'` to the `UPDATABLE_PROPERTIES` array (after 'unique' on line ~103)

    2. In `class-rest-custom-fields.php`:
       - In `get_field_metadata()` method (around line 250-300):
         - Add `'editable_in_ui' => $field['editable_in_ui'] ?? true` to the `$display_props` array
         - This ensures the property is exposed to the frontend, defaulting to true for backward compatibility

       - In `get_create_params()` method (around line 516):
         - Add parameter definition for `editable_in_ui`:
           ```php
           'editable_in_ui' => array(
               'type'        => 'boolean',
               'default'     => true,
               'description' => 'Whether field can be edited in UI (API access unaffected)',
           ),
           ```

       - In `create_item()` method optional params list (around line 320-340):
         - Add `'editable_in_ui'` to the `$optional_params` array

       - In `update_item()` method updatable params list (around line 397-420):
         - Add `'editable_in_ui'` to the `$updatable_params` array

    IMPORTANT: The REST API for person/team values (/wp/v2/people/{id}, /wp/v2/teams/{id}) remains unchanged - it continues to accept all field updates regardless of editable_in_ui setting. Only the UI respects this flag.
  </action>
  <verify>
    - Run `grep -n "editable_in_ui" includes/customfields/class-manager.php` - should show line in UPDATABLE_PROPERTIES
    - Run `grep -n "editable_in_ui" includes/class-rest-custom-fields.php` - should show multiple lines in metadata, params, and method lists
  </verify>
  <done>
    - editable_in_ui is a valid field property that can be created, updated, and retrieved
    - Metadata endpoint returns editable_in_ui for each field (defaulting to true if not set)
    - REST API properly validates editable_in_ui as a boolean parameter
  </done>
</task>

<task type="auto">
  <name>Task 2: Add "Bewerkbaar in UI" toggle to FieldFormPanel</name>
  <files>src/components/FieldFormPanel.jsx</files>
  <action>
    1. In `getDefaultFormData()` (around line 30-75):
       - Add `editable_in_ui: true,` to the defaults (near the validation options section with `required` and `unique`)

    2. In the useEffect that handles field editing (around line 118-190):
       - When loading an existing field, add:
         `editable_in_ui: field.editable_in_ui ?? true,`
       - This ensures backward compatibility - existing fields without the property are treated as editable

    3. In the Validation Options section (around line 1243-1276, after the "Unieke waarde" checkbox):
       - Add a new checkbox for editable_in_ui:
         ```jsx
         <div className="flex items-center gap-2 mt-4">
           <input
             id="editable_in_ui"
             name="editable_in_ui"
             type="checkbox"
             checked={formData.editable_in_ui}
             onChange={handleChange}
             className="w-4 h-4 rounded border-gray-300 dark:border-gray-600 text-accent-600 focus:ring-accent-500"
           />
           <label htmlFor="editable_in_ui" className="text-sm text-gray-700 dark:text-gray-300">
             Bewerkbaar in UI
           </label>
         </div>
         <p className={hintClass}>Schakel uit voor velden die via API worden beheerd (bijv. Sportlink)</p>
         ```

    4. In `handleSubmit()` (around line 256-353):
       - Add `editable_in_ui` to the `submitData` object (with validation options section):
         `submitData.editable_in_ui = formData.editable_in_ui;`
  </action>
  <verify>
    - Run `grep -n "editable_in_ui" src/components/FieldFormPanel.jsx` - should show lines for default, state load, checkbox, and submit
  </verify>
  <done>
    - FieldFormPanel shows "Bewerkbaar in UI" checkbox in the validation options section
    - Checkbox defaults to checked (true) for new fields
    - Checkbox reflects current value when editing existing fields
    - Checkbox value is submitted to API when saving
  </done>
</task>

<task type="auto">
  <name>Task 3: Update display components for non-editable fields</name>
  <files>
    src/components/CustomFieldsSection.jsx
    src/components/CustomFieldsEditModal.jsx
  </files>
  <action>
    1. In `CustomFieldsSection.jsx`:
       - Add import for Lock icon: Update the lucide-react import line to include `Lock`
       - Before the edit button JSX (around line 447-457), calculate whether any fields are editable:
         ```jsx
         const hasEditableFields = fieldDefs.some(field => field.editable_in_ui !== false);
         ```
       - Wrap the edit button in a conditional:
         ```jsx
         {hasEditableFields && (
           <button
             onClick={() => setShowModal(true)}
             className="btn-secondary text-sm"
           >
             <Pencil className="w-4 h-4 md:mr-1" />
             <span className="hidden md:inline">Bewerken</span>
           </button>
         )}
         ```

    2. In `CustomFieldsEditModal.jsx`:
       - Add import for Lock icon: Update the lucide-react import line to include `Lock`
       - In `renderFieldInput()` function (around line 523), add a check at the very beginning:
         ```jsx
         const renderFieldInput = (field) => {
           // Check if field is editable (treat missing property as true for backward compatibility)
           if (field.editable_in_ui === false) {
             const currentValue = watch(field.name);
             return (
               <div className="p-3 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                 <div className="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 mb-2">
                   <Lock className="w-3.5 h-3.5" />
                   <span>Wordt beheerd via API</span>
                 </div>
                 <div className="text-gray-900 dark:text-gray-100">
                   {renderReadOnlyValue(field, currentValue)}
                 </div>
               </div>
             );
           }

           // Existing input rendering code continues here...
           const inputClass = ...
         ```
       - Add a helper function `renderReadOnlyValue()` before `renderFieldInput()`:
         ```jsx
         // Render read-only display of a field value for non-editable fields
         const renderReadOnlyValue = (field, value) => {
           if (value === null || value === undefined || value === '') {
             return <span className="text-gray-400 dark:text-gray-500 italic">Niet ingesteld</span>;
           }

           switch (field.type) {
             case 'true_false':
               return <span>{value ? (field.ui_on_text || 'Ja') : (field.ui_off_text || 'Nee')}</span>;
             case 'checkbox':
               if (Array.isArray(value) && value.length > 0) {
                 return <span>{value.join(', ')}</span>;
               }
               return <span className="text-gray-400 dark:text-gray-500 italic">Niets geselecteerd</span>;
             case 'image':
               if (typeof value === 'object' && value?.url) {
                 return <img src={value.sizes?.thumbnail || value.url} alt="" className="w-12 h-12 rounded object-cover" />;
               }
               return <span>Afbeelding #{typeof value === 'number' ? value : 'geladen'}</span>;
             case 'file':
               if (typeof value === 'object' && value?.filename) {
                 return <span>{value.filename}</span>;
               }
               return <span>Bestand geladen</span>;
             case 'link':
               if (typeof value === 'object' && value?.url) {
                 return <span>{value.title || value.url}</span>;
               }
               return <span className="text-gray-400 dark:text-gray-500 italic">Niet ingesteld</span>;
             case 'color_picker':
               return (
                 <div className="flex items-center gap-2">
                   <div className="w-5 h-5 rounded border border-gray-300 dark:border-gray-600" style={{ backgroundColor: value }} />
                   <span className="font-mono text-sm">{value}</span>
                 </div>
               );
             case 'relationship':
               if (Array.isArray(value) && value.length > 0) {
                 return <span>{value.length} item(s) gekoppeld</span>;
               }
               return <span className="text-gray-400 dark:text-gray-500 italic">Niet gekoppeld</span>;
             default:
               return <span>{String(value)}</span>;
           }
         };
         ```
  </action>
  <verify>
    - Run `grep -n "editable_in_ui" src/components/CustomFieldsSection.jsx` - should show hasEditableFields and conditional
    - Run `grep -n "editable_in_ui" src/components/CustomFieldsEditModal.jsx` - should show check in renderFieldInput
    - Run `grep -n "Lock" src/components/CustomFieldsEditModal.jsx` - should show import and usage
    - Run `npm run lint` - should pass with no errors
    - Run `npm run build` - should build successfully
  </verify>
  <done>
    - CustomFieldsSection hides edit button when all fields have editable_in_ui=false
    - CustomFieldsEditModal shows read-only display with lock icon for non-editable fields
    - Non-editable fields display their current value but cannot be modified in the UI
    - All lint checks pass
    - Production build completes successfully
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Backend verification:**
   - `grep -rn "editable_in_ui" includes/` shows property in both PHP files
   - REST API `/stadion/v1/custom-fields/person/metadata` returns `editable_in_ui` for each field

2. **Frontend verification:**
   - `grep -rn "editable_in_ui" src/components/` shows usage in all 3 components
   - `npm run lint` passes
   - `npm run build` produces successful build

3. **Functional verification (after deploy):**
   - Settings > Velden: Creating a new field shows "Bewerkbaar in UI" checkbox (checked by default)
   - Settings > Velden: Editing a field allows toggling "Bewerkbaar in UI"
   - Person/Team detail: Fields with editable_in_ui=true show edit button
   - Person/Team detail: If ALL fields have editable_in_ui=false, no edit button is shown
   - Edit modal: Non-editable fields show lock icon and "Wordt beheerd via API" text with current value
</verification>

<success_criteria>
1. Custom field settings UI shows "Bewerkbaar in UI" checkbox for each field
2. Fields with editable_in_ui=true show normal edit button on person/team detail
3. Fields with editable_in_ui=false display their value but show no edit button (when ALL are non-editable)
4. Fields with editable_in_ui=false can still be updated via REST API (API-01 constraint)
5. Default value for new fields is editable_in_ui=true (backward compatible)
6. All linting and build checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/118-custom-field-edit-control/118-01-SUMMARY.md`
</output>
