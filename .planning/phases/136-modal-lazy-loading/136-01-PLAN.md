---
phase: 136-modal-lazy-loading
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/usePeople.js
  - src/components/Timeline/QuickActivityModal.jsx
  - src/components/Timeline/TodoModal.jsx
  - src/components/Timeline/GlobalTodoModal.jsx
autonomous: true

must_haves:
  truths:
    - "Dashboard loads without fetching /people endpoint"
    - "QuickActivityModal fetches people only when opened"
    - "TodoModal fetches people only when opened"
    - "GlobalTodoModal fetches people only when opened"
  artifacts:
    - path: "src/hooks/usePeople.js"
      provides: "usePeople hook with enabled option"
      contains: "enabled = true"
    - path: "src/components/Timeline/QuickActivityModal.jsx"
      provides: "Lazy-loaded people data"
      contains: "enabled: isOpen"
    - path: "src/components/Timeline/TodoModal.jsx"
      provides: "Lazy-loaded people data"
      contains: "enabled: isOpen"
    - path: "src/components/Timeline/GlobalTodoModal.jsx"
      provides: "Lazy-loaded people data"
      contains: "enabled: isOpen"
  key_links:
    - from: "QuickActivityModal.jsx"
      to: "usePeople hook"
      via: "enabled: isOpen option"
      pattern: "usePeople\\(\\{\\}.*enabled:\\s*isOpen"
    - from: "TodoModal.jsx"
      to: "usePeople hook"
      via: "enabled: isOpen option"
      pattern: "usePeople\\(\\{\\}.*enabled:\\s*isOpen"
    - from: "GlobalTodoModal.jsx"
      to: "usePeople hook"
      via: "enabled: isOpen option"
      pattern: "usePeople\\(\\{\\}.*enabled:\\s*isOpen"
---

<objective>
Add conditional data fetching to modals with people selectors so they only load 1400+ people records when actually opened.

Purpose: Eliminate unnecessary API calls on dashboard load - currently QuickActivityModal triggers a people fetch on every page load even when the modal is never opened.

Output: Modified usePeople hook with enabled option and updated modals using enabled: isOpen pattern.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/136-modal-lazy-loading/136-RESEARCH.md

# Source files to modify
@src/hooks/usePeople.js
@src/components/Timeline/QuickActivityModal.jsx
@src/components/Timeline/TodoModal.jsx
@src/components/Timeline/GlobalTodoModal.jsx

# Existing pattern examples (read for reference)
@src/components/CommissieEditModal.jsx
@src/components/TeamEditModal.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add enabled option to usePeople hook</name>
  <files>src/hooks/usePeople.js</files>
  <action>
Modify the usePeople hook to accept an optional second parameter for options:

1. Change function signature from `usePeople(params = {})` to `usePeople(params = {}, options = {})`
2. Destructure `enabled = true` from options (default true for backward compatibility)
3. Add `enabled` to the useQuery options

The change should look like:
```javascript
export function usePeople(params = {}, options = {}) {
  const { enabled = true } = options;

  return useQuery({
    queryKey: peopleKeys.list(params),
    queryFn: async () => {
      // ... existing fetch logic unchanged
    },
    enabled, // Add this line
  });
}
```

Important: Default `enabled` to `true` so all existing usages continue to work unchanged.
  </action>
  <verify>
Run `npm run lint` - should pass with no errors.
Existing usePeople usages (PeopleList.jsx, etc.) should still work because enabled defaults to true.
  </verify>
  <done>usePeople hook accepts { enabled } option, defaults to true for backward compatibility</done>
</task>

<task type="auto">
  <name>Task 2: Update QuickActivityModal to fetch people only when open</name>
  <files>src/components/Timeline/QuickActivityModal.jsx</files>
  <action>
Modify the usePeople call in QuickActivityModal to pass enabled: isOpen:

Change from:
```javascript
const { data: allPeople } = usePeople();
```

To:
```javascript
const { data: allPeople } = usePeople({}, { enabled: isOpen });
```

The modal already has an early return `if (!isOpen) return null;` AFTER this hook call, which is correct per React rules of hooks. Adding `enabled: isOpen` means the API call only happens when isOpen is true.
  </action>
  <verify>
1. Run `npm run lint` - should pass
2. Run `npm run build` - should succeed
  </verify>
  <done>QuickActivityModal passes enabled: isOpen to usePeople</done>
</task>

<task type="auto">
  <name>Task 3: Update TodoModal and GlobalTodoModal to fetch people only when open</name>
  <files>
    src/components/Timeline/TodoModal.jsx
    src/components/Timeline/GlobalTodoModal.jsx
  </files>
  <action>
Apply the same pattern to both todo modals:

In TodoModal.jsx, change from:
```javascript
const { data: people = [], isLoading: isPeopleLoading } = usePeople();
```

To:
```javascript
const { data: people = [], isLoading: isPeopleLoading } = usePeople({}, { enabled: isOpen });
```

In GlobalTodoModal.jsx, change from:
```javascript
const { data: people = [], isLoading: isPeopleLoading } = usePeople();
```

To:
```javascript
const { data: people = [], isLoading: isPeopleLoading } = usePeople({}, { enabled: isOpen });
```

Both modals have early returns after the hook call which is correct. The enabled option ensures API calls only fire when modal is open.
  </action>
  <verify>
1. Run `npm run lint` - should pass
2. Run `npm run build` - should succeed
  </verify>
  <done>TodoModal and GlobalTodoModal both pass enabled: isOpen to usePeople</done>
</task>

</tasks>

<verification>
1. **Build verification:**
   - `npm run lint` passes with no errors
   - `npm run build` succeeds

2. **Functional verification (after deploy):**
   - Open browser DevTools Network tab
   - Navigate to Dashboard
   - Verify NO /wp/v2/person requests appear on initial load
   - Click to open QuickActivityModal
   - Verify /wp/v2/person request NOW appears
   - Verify people selector shows data
   - Close modal, open TodoModal from sidebar
   - Verify another /wp/v2/person request (React Query may dedupe if cached)

3. **Backward compatibility:**
   - Navigate to People list page
   - Verify people still load (usePeople called without options)
   - Navigate to other pages using usePeople
   - Verify they still work as expected
</verification>

<success_criteria>
- Dashboard loads without any /wp/v2/person or /rondo/v1/people/filtered API calls in network panel
- Opening any modal with people selector triggers the people fetch
- People selector in modals shows loading state then data
- Existing pages (PeopleList, etc.) continue to work unchanged
- All lint and build checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/136-modal-lazy-loading/136-01-SUMMARY.md`
</output>
