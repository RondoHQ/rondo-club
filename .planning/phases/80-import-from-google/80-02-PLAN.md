---
phase: 80-import-from-google
plan: 02
type: execute
wave: 2
depends_on: ["80-01"]
files_modified:
  - includes/class-rest-google-contacts.php
  - src/api/client.js
autonomous: true

must_haves:
  truths:
    - "Import can be triggered via REST API endpoint"
    - "Import progress and results are returned to the caller"
    - "Errors during import are captured and reported"
    - "Connection stats are updated after import"
  artifacts:
    - path: "includes/class-rest-google-contacts.php"
      provides: "POST /rondo/v1/google-contacts/import endpoint"
      contains: "trigger_import"
    - path: "src/api/client.js"
      provides: "triggerGoogleContactsImport API method"
      contains: "google-contacts/import"
  key_links:
    - from: "includes/class-rest-google-contacts.php"
      to: "GoogleContactsAPIImport::import_all"
      via: "REST endpoint callback"
      pattern: "import_all"
---

<objective>
Add REST endpoint to trigger Google Contacts import and update the API client.

Purpose: Enable the frontend to trigger and monitor the import process, receiving real-time progress and final results.

Output: REST endpoint at `POST /rondo/v1/google-contacts/import` and updated API client
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/80-import-from-google/80-CONTEXT.md
@.planning/phases/80-import-from-google/80-01-SUMMARY.md
@includes/class-rest-google-contacts.php
@src/api/client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add import trigger REST endpoint</name>
  <files>includes/class-rest-google-contacts.php</files>
  <action>
Add import endpoint to the existing GoogleContacts REST class:

1. **Add route registration in register_routes():**
   ```php
   // POST /rondo/v1/google-contacts/import - Trigger import
   register_rest_route(
       'rondo/v1',
       '/google-contacts/import',
       [
           'methods'             => \WP_REST_Server::CREATABLE,
           'callback'            => [ $this, 'trigger_import' ],
           'permission_callback' => [ $this, 'check_user_approved' ],
       ]
   );
   ```

2. **Add use statement at top of file:**
   ```php
   use Stadion\Import\GoogleContactsAPI;
   ```

3. **Implement trigger_import() method:**
   ```php
   /**
    * Trigger Google Contacts import
    *
    * Imports all contacts from the user's connected Google account.
    * This is a synchronous operation that returns when complete.
    *
    * @param WP_REST_Request $request The REST request object.
    * @return WP_REST_Response|WP_Error Response with import stats or error.
    */
   public function trigger_import( $request ) {
       $user_id = get_current_user_id();

       // Check if connected
       if ( ! GoogleContactsConnection::is_connected( $user_id ) ) {
           return new \WP_Error(
               'not_connected',
               __( 'Google Contacts is not connected. Please connect first.', 'stadion' ),
               [ 'status' => 400 ]
           );
       }

       try {
           // Create importer and run
           $importer = new GoogleContactsAPI( $user_id );
           $stats = $importer->import_all();

           return rest_ensure_response( [
               'success' => true,
               'stats'   => $stats,
               'message' => sprintf(
                   __( 'Import complete: %d imported, %d updated, %d skipped', 'stadion' ),
                   $stats['contacts_imported'],
                   $stats['contacts_updated'],
                   $stats['contacts_skipped']
               ),
           ] );

       } catch ( \Exception $e ) {
           // Log error
           if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
               error_log( 'Google Contacts import error: ' . $e->getMessage() );
           }

           // Store error in connection
           GoogleContactsConnection::update_connection( $user_id, [
               'last_error' => $e->getMessage(),
           ] );

           return new \WP_Error(
               'import_failed',
               $e->getMessage(),
               [ 'status' => 500 ]
           );
       }
   }
   ```

4. **Update get_status() to include more import-relevant info:**
   Add `sync_in_progress` field (for future async support) - for now always false:
   ```php
   $response = [
       'connected'          => $connected,
       'google_configured'  => GoogleOAuth::is_configured(),
       'access_mode'        => $connection['access_mode'] ?? 'none',
       'email'              => $connection['email'] ?? '',
       'last_sync'          => $connection['last_sync'] ?? null,
       'contact_count'      => $connection['contact_count'] ?? 0,
       'last_error'         => $connection['last_error'] ?? null,
       'has_pending_import' => GoogleContactsConnection::has_pending_import( $user_id ),
       'connected_at'       => $connection['connected_at'] ?? null,
       'sync_in_progress'   => false, // Future: track async imports
   ];
   ```
  </action>
  <verify>`grep -n "trigger_import" includes/class-rest-google-contacts.php` shows method exists; `grep "google-contacts/import" includes/class-rest-google-contacts.php` shows route registered</verify>
  <done>REST endpoint registered at POST /rondo/v1/google-contacts/import with proper error handling and stats return</done>
</task>

<task type="auto">
  <name>Task 2: Update API client with import method</name>
  <files>src/api/client.js</files>
  <action>
Add the import trigger method to the API client in the Google Contacts section:

Find the Google Contacts API methods section (around line 257) and add:

```javascript
// Google Contacts API
getGoogleContactsStatus: () => api.get('/rondo/v1/google-contacts/status'),
initiateGoogleContactsAuth: (readonly = true) => api.get('/rondo/v1/google-contacts/auth', { params: { readonly } }),
disconnectGoogleContacts: () => api.delete('/rondo/v1/google-contacts'),
triggerGoogleContactsImport: () => api.post('/rondo/v1/google-contacts/import'),
```

The method is simple because:
- No parameters needed (imports all contacts)
- Returns promise with { success, stats, message }
- Errors are thrown by axios interceptors
  </action>
  <verify>`grep "triggerGoogleContactsImport" src/api/client.js` shows method defined</verify>
  <done>API client extended with triggerGoogleContactsImport() method</done>
</task>

<task type="auto">
  <name>Task 3: Build and test endpoint</name>
  <files>None (verification only)</files>
  <action>
1. Run `npm run build` to compile frontend changes

2. Run `npm run lint` to ensure no linting errors

3. Verify PHP syntax:
   ```bash
   php -l includes/class-rest-google-contacts.php
   ```

4. Quick endpoint test (requires connected Google account):
   ```bash
   # Get status to verify endpoint is registered
   curl -s "https://cael.is/wp-json/rondo/v1/google-contacts/status" | jq .
   ```

Note: Full import testing requires a connected Google account with contacts. The endpoint will return an error if not connected, which is expected behavior.
  </action>
  <verify>`npm run build` succeeds; `npm run lint` passes; PHP syntax check passes</verify>
  <done>Frontend built, linting passes, PHP syntax valid, endpoint ready for integration testing</done>
</task>

</tasks>

<verification>
1. REST endpoint registered: `grep -A5 "google-contacts/import" includes/class-rest-google-contacts.php`
2. API client method exists: `grep "triggerGoogleContactsImport" src/api/client.js`
3. Build succeeds: `npm run build` completes without errors
4. Lint passes: `npm run lint` completes without errors
5. PHP valid: `php -l includes/class-rest-google-contacts.php` returns no errors
</verification>

<success_criteria>
- POST /rondo/v1/google-contacts/import endpoint exists and returns import stats
- API client has triggerGoogleContactsImport method
- Error handling returns appropriate error messages
- Connection stats are updated after import
- Frontend build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/80-import-from-google/80-02-SUMMARY.md`
</output>
