---
phase: 80-import-from-google
plan: 03
type: execute
wave: 3
depends_on: ["80-02"]
files_modified:
  - src/pages/Settings/Settings.jsx
autonomous: false

must_haves:
  truths:
    - "After connecting Google Contacts, import starts automatically"
    - "User sees progress indicator during import"
    - "User sees summary of imported/updated/skipped contacts after import"
    - "User can trigger manual re-import via button"
    - "Errors during import are displayed to user"
  artifacts:
    - path: "src/pages/Settings/Settings.jsx"
      provides: "Import trigger, progress UI, and results display"
      contains: "triggerGoogleContactsImport"
  key_links:
    - from: "src/pages/Settings/Settings.jsx"
      to: "api.triggerGoogleContactsImport"
      via: "useEffect on has_pending_import"
      pattern: "triggerGoogleContactsImport"
---

<objective>
Update Settings UI to automatically trigger import after OAuth connection and display progress/results.

Purpose: Provide seamless user experience where connecting Google Contacts automatically imports all contacts with clear feedback.

Output: Updated Settings.jsx with auto-import trigger, progress display, and import results UI
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/80-import-from-google/80-CONTEXT.md
@.planning/phases/80-import-from-google/80-02-SUMMARY.md
@src/pages/Settings/Settings.jsx
@src/api/client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add import state and auto-trigger logic</name>
  <files>src/pages/Settings/Settings.jsx</files>
  <action>
Update the Settings component to handle Google Contacts import:

1. **Add new state variables** (near the existing googleContactsStatus state around line 98):
   ```javascript
   const [googleContactsImporting, setGoogleContactsImporting] = useState(false);
   const [googleContactsImportResult, setGoogleContactsImportResult] = useState(null);
   ```

2. **Create import handler function** (near handleConnectGoogleContacts around line 293):
   ```javascript
   const handleImportGoogleContacts = async () => {
     setGoogleContactsImporting(true);
     setGoogleContactsImportResult(null);
     setGoogleContactsMessage('Importing contacts from Google...');

     try {
       const response = await prmApi.triggerGoogleContactsImport();
       setGoogleContactsImportResult(response.data);
       setGoogleContactsMessage('');

       // Refresh status to get updated contact count
       const statusResponse = await prmApi.getGoogleContactsStatus();
       setGoogleContactsStatus(statusResponse.data);

       // Invalidate queries to refresh contact lists
       queryClient.invalidateQueries({ queryKey: ['people'] });
       queryClient.invalidateQueries({ queryKey: ['companies'] });
       queryClient.invalidateQueries({ queryKey: ['dates'] });
       queryClient.invalidateQueries({ queryKey: ['dashboard'] });
     } catch (error) {
       setGoogleContactsMessage(`Import failed: ${error.response?.data?.message || error.message}`);
       setGoogleContactsImportResult(null);
     } finally {
       setGoogleContactsImporting(false);
     }
   };
   ```

3. **Add auto-import trigger on pending flag** (in the useEffect that handles URL params, around line 220-235):
   After the existing `if (connected === 'google-contacts')` block, add:
   ```javascript
   // Auto-trigger import if pending
   if (googleContactsStatus?.has_pending_import && !googleContactsImporting) {
     handleImportGoogleContacts();
   }
   ```

   Make sure this effect has googleContactsStatus in its dependency array. You may need to adjust the useEffect or create a new one specifically for auto-import:
   ```javascript
   // Auto-import when pending flag is set
   useEffect(() => {
     if (googleContactsStatus?.has_pending_import && !googleContactsImporting && !googleContactsImportResult) {
       handleImportGoogleContacts();
     }
   }, [googleContactsStatus?.has_pending_import]);
   ```

4. **Ensure queryClient is available** - add to imports if not present:
   ```javascript
   import { useQueryClient } from '@tanstack/react-query';
   ```
   And in component:
   ```javascript
   const queryClient = useQueryClient();
   ```
  </action>
  <verify>`grep "googleContactsImporting" src/pages/Settings/Settings.jsx` shows state variable; `grep "handleImportGoogleContacts" src/pages/Settings/Settings.jsx` shows handler function</verify>
  <done>Import state, handler function, and auto-trigger logic added to Settings component</done>
</task>

<task type="auto">
  <name>Task 2: Update GoogleContactsCard UI with import status and results</name>
  <files>src/pages/Settings/Settings.jsx</files>
  <action>
Update the GoogleContactsCard component (around line 2039) to show import progress and results:

1. **Add new props to GoogleContactsCard:**
   ```javascript
   function GoogleContactsCard({
     googleContactsStatus, googleContactsLoading, connectingGoogleContacts,
     disconnectingGoogleContacts, googleContactsMessage,
     handleConnectGoogleContacts, handleDisconnectGoogleContacts,
     googleContactsImporting, googleContactsImportResult, handleImportGoogleContacts,
   }) {
   ```

2. **Add import status display** - after the connection status section, before the disconnect button:
   ```jsx
   {/* Import Progress */}
   {googleContactsImporting && (
     <div className="mt-4 flex items-center gap-2 text-accent-600 dark:text-accent-400">
       <Loader2 className="h-4 w-4 animate-spin" />
       <span>Importing contacts from Google...</span>
     </div>
   )}

   {/* Import Results */}
   {googleContactsImportResult && (
     <div className="mt-4 p-3 rounded-lg bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800">
       <div className="flex items-start gap-2">
         <CheckCircle className="h-5 w-5 text-green-600 dark:text-green-400 mt-0.5 flex-shrink-0" />
         <div className="text-sm text-green-800 dark:text-green-200">
           <p className="font-medium">Import complete!</p>
           <ul className="mt-1 space-y-0.5">
             <li>{googleContactsImportResult.stats.contacts_imported} contacts imported</li>
             <li>{googleContactsImportResult.stats.contacts_updated} contacts updated</li>
             {googleContactsImportResult.stats.contacts_skipped > 0 && (
               <li>{googleContactsImportResult.stats.contacts_skipped} contacts skipped</li>
             )}
             {googleContactsImportResult.stats.contacts_no_email > 0 && (
               <li className="text-green-600 dark:text-green-300">
                 {googleContactsImportResult.stats.contacts_no_email} skipped (no email)
               </li>
             )}
             {googleContactsImportResult.stats.companies_created > 0 && (
               <li>{googleContactsImportResult.stats.companies_created} organizations created</li>
             )}
             {googleContactsImportResult.stats.dates_created > 0 && (
               <li>{googleContactsImportResult.stats.dates_created} birthdays added</li>
             )}
             {googleContactsImportResult.stats.photos_imported > 0 && (
               <li>{googleContactsImportResult.stats.photos_imported} photos imported</li>
             )}
           </ul>
           {googleContactsImportResult.stats.errors?.length > 0 && (
             <div className="mt-2 pt-2 border-t border-green-200 dark:border-green-700">
               <p className="font-medium text-amber-700 dark:text-amber-300">Warnings:</p>
               <ul className="list-disc list-inside">
                 {googleContactsImportResult.stats.errors.slice(0, 5).map((error, i) => (
                   <li key={i} className="text-amber-600 dark:text-amber-400">{error}</li>
                 ))}
                 {googleContactsImportResult.stats.errors.length > 5 && (
                   <li className="text-amber-600 dark:text-amber-400">
                     ...and {googleContactsImportResult.stats.errors.length - 5} more
                   </li>
                 )}
               </ul>
             </div>
           )}
         </div>
       </div>
     </div>
   )}
   ```

3. **Add import button for connected state** - in the connected UI section, add a re-import button:
   ```jsx
   {/* Re-import button */}
   {googleContactsStatus.connected && !googleContactsImporting && (
     <button
       onClick={handleImportGoogleContacts}
       disabled={googleContactsImporting}
       className="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-accent-700 dark:text-accent-300 hover:text-accent-800 dark:hover:text-accent-200"
     >
       <RefreshCw className="h-4 w-4" />
       Re-import contacts
     </button>
   )}
   ```

4. **Add CheckCircle and RefreshCw to imports** if not already present at top of file:
   ```javascript
   import { CheckCircle, RefreshCw } from 'lucide-react';
   ```

5. **Update where GoogleContactsCard is rendered** (around line 509 and 1984) to pass new props:
   ```jsx
   <GoogleContactsCard
     googleContactsStatus={googleContactsStatus}
     googleContactsLoading={googleContactsLoading}
     connectingGoogleContacts={connectingGoogleContacts}
     disconnectingGoogleContacts={disconnectingGoogleContacts}
     googleContactsMessage={googleContactsMessage}
     handleConnectGoogleContacts={handleConnectGoogleContacts}
     handleDisconnectGoogleContacts={handleDisconnectGoogleContacts}
     googleContactsImporting={googleContactsImporting}
     googleContactsImportResult={googleContactsImportResult}
     handleImportGoogleContacts={handleImportGoogleContacts}
   />
   ```
  </action>
  <verify>`grep "googleContactsImportResult" src/pages/Settings/Settings.jsx` shows the result display code; `grep "Re-import contacts" src/pages/Settings/Settings.jsx` shows the button</verify>
  <done>GoogleContactsCard updated with import progress, results display, and re-import button</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    - Automatic import trigger after Google Contacts OAuth connection
    - Progress indicator during import
    - Import results summary with counts for imported/updated/skipped contacts
    - Re-import button for manual re-sync
  </what-built>
  <how-to-verify>
    1. Go to https://cael.is/settings?tab=connections&subtab=contacts
    2. If already connected, click "Disconnect" first
    3. Click "Connect Google Contacts"
    4. Complete OAuth flow with a Google account that has contacts
    5. After redirect, verify:
       - Progress message shows "Importing contacts from Google..."
       - After completion, results summary appears showing counts
       - "Re-import contacts" button is visible
    6. Click "Re-import contacts" and verify it runs again
    7. Navigate to People list and verify imported contacts appear
    8. Check that contacts with photos have their photos
    9. Check that birthdays appear on the Important Dates page
  </how-to-verify>
  <resume-signal>Type "approved" if import works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Import auto-triggers: Connect Google account, verify import starts automatically
2. Progress shows: "Importing contacts from Google..." message appears during import
3. Results display: Summary shows imported/updated/skipped counts
4. Re-import works: Button triggers new import
5. Data appears: Contacts visible in People list, birthdays in Dates
6. Lint passes: `npm run lint` completes without errors
</verification>

<success_criteria>
- Auto-import triggers after OAuth connection via has_pending_import flag
- Progress indicator visible during import
- Results summary displays accurate counts
- Re-import button available for manual sync
- Imported contacts appear in People list with photos
- Birthdays created as important_date entries
- No console errors during flow
</success_criteria>

<output>
After completion, create `.planning/phases/80-import-from-google/80-03-SUMMARY.md`
</output>
