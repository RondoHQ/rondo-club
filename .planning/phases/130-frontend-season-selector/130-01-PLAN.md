---
phase: 130-frontend-season-selector
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/Contributie/ContributieList.jsx
autonomous: true

must_haves:
  truths:
    - "Season dropdown shows current season (with huidig label) and next season (with prognose label)"
    - "Selecting forecast updates table to show projected fees from API"
    - "Forecast view hides Nikki and Saldo columns entirely"
    - "Forecast view shows clear visual indicator badge"
    - "Filter buttons (Geen Nikki, Afwijking) hidden in forecast mode"
    - "Totals row excludes Nikki columns in forecast mode"
  artifacts:
    - path: "src/pages/Contributie/ContributieList.jsx"
      provides: "Season selector dropdown, conditional column rendering, forecast indicator"
      contains: "isForecast"
  key_links:
    - from: "isForecast state"
      to: "useFeeList({ forecast: true })"
      via: "params object passed to hook"
      pattern: "useFeeList\\(.*forecast.*\\)"
    - from: "isForecast state"
      to: "column visibility"
      via: "conditional rendering"
      pattern: "!isForecast &&"
---

<objective>
Add season selector dropdown to ContributieList that toggles between current season (actual billing data) and forecast view (projected fees for next season). Includes visual distinction for forecast mode and automatic column hiding for Nikki fields that don't exist in forecast response.

Purpose: Enable budget planning by viewing projected fees based on current membership
Output: Updated ContributieList.jsx with dropdown, conditional rendering, and forecast indicator
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/130-frontend-season-selector/130-CONTEXT.md
@.planning/phases/130-frontend-season-selector/130-RESEARCH.md
@.planning/phases/129-backend-forecast-calculation/129-01-SUMMARY.md
@src/pages/Contributie/ContributieList.jsx
@src/hooks/useFees.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add season selector dropdown with isForecast state</name>
  <files>src/pages/Contributie/ContributieList.jsx</files>
  <action>
Add controlled season dropdown to ContributieList:

1. Add isForecast state: `const [isForecast, setIsForecast] = useState(false);`

2. Pass forecast param to useFeeList hook:
   ```jsx
   const { data, isLoading, error } = useFeeList(
     isForecast ? { forecast: true } : {}
   );
   ```

3. Add helper function for next season label:
   ```jsx
   const getNextSeasonLabel = (currentSeason) => {
     const startYear = parseInt(currentSeason.substring(0, 4));
     return `${startYear + 1}-${startYear + 2}`;
   };
   ```

4. Add dropdown in the toolbar area (after "Seizoen:" text, replace the static season display):
   - Use native `<select>` with btn-secondary styling
   - Current season option with "(huidig)" suffix
   - Next season option with "(prognose)" suffix
   - Use data?.season for current season label, getNextSeasonLabel() for forecast

5. Add useEffect to reset sortField if switching to forecast while sorting by nikki columns:
   ```jsx
   useEffect(() => {
     if (isForecast && (sortField === 'nikki_total' || sortField === 'nikki_saldo')) {
       setSortField('last_name');
     }
   }, [isForecast, sortField]);
   ```

Note: Import TrendingUp from lucide-react (will be used in Task 2 for forecast indicator).
  </action>
  <verify>
`npm run lint` passes.
Component renders with dropdown showing two season options.
Selecting forecast triggers useFeeList refetch (visible in Network tab).
  </verify>
  <done>
Dropdown toggles isForecast state, API refetch happens on selection change, sort resets when entering forecast if sorting by Nikki columns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add conditional column rendering and forecast indicator</name>
  <files>src/pages/Contributie/ContributieList.jsx</files>
  <action>
Update ContributieList to conditionally render columns and show forecast indicator:

1. In table header (`<thead>`), wrap Nikki and Saldo SortableHeader components:
   ```jsx
   {!isForecast && (
     <>
       <SortableHeader label="Nikki" columnId="nikki_total" ... />
       <SortableHeader label="Saldo" columnId="nikki_saldo" ... />
     </>
   )}
   ```

2. In FeeRow component, accept isForecast prop and conditionally render Nikki/Saldo cells:
   ```jsx
   function FeeRow({ member, isOdd, isForecast }) {
     // ... existing code ...
     {!isForecast && (
       <>
         <td className="...">{/* Nikki total cell */}</td>
         <td className="...">{/* Nikki saldo cell */}</td>
       </>
     )}
   }
   ```
   Pass isForecast to each FeeRow: `<FeeRow member={member} isOdd={...} isForecast={isForecast} />`

3. In table footer (`<tfoot>`), conditionally render Nikki/Saldo totals cells:
   ```jsx
   {!isForecast && (
     <>
       <td className="...">{formatCurrency(totals.nikkiTotal, 2)}</td>
       <td className="...">{formatCurrency(totals.nikkiSaldo, 2)}</td>
     </>
   )}
   ```
   Also update colSpan on "Totaal" td accordingly (will be dynamic based on isForecast).

4. Hide filter buttons in forecast mode (Geen Nikki, Afwijking):
   ```jsx
   {!isForecast && mismatchCount > 0 && (
     <button>Afwijking...</button>
   )}
   {!isForecast && noNikkiCount > 0 && (
     <button>Geen Nikki...</button>
   )}
   ```

5. Hide "Nog te ontvangen" total in forecast mode (nikki_saldo doesn't exist).

6. Add forecast indicator badge when isForecast is true (place after dropdown):
   ```jsx
   {isForecast && (
     <div className="inline-flex items-center gap-2 px-3 py-1.5 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-700 dark:bg-blue-900/30 dark:border-blue-700 dark:text-blue-300">
       <TrendingUp className="w-4 h-4" />
       <span className="font-medium">Prognose</span>
       <span className="text-blue-600 dark:text-blue-400">
         (o.b.v. huidige ledenstand)
       </span>
     </div>
   )}
   ```

IMPORTANT per 130-CONTEXT.md decisions:
- Columns hide INSTANTLY (not rendered, table reflows)
- Remaining columns EXPAND to fill freed space (automatic with CSS table layout)
- NO tooltip explanation for missing columns (forecast indicator is sufficient)
  </action>
  <verify>
`npm run lint` passes.
`npm run build` succeeds.
Switching to forecast: Nikki/Saldo columns disappear, table reflows, badge appears.
Switching to current: Columns reappear, badge disappears.
Filter buttons only visible in current mode.
Totals row correct in both modes.
  </verify>
  <done>
Nikki/Saldo columns conditionally rendered in header, body, and footer.
Forecast indicator badge visible when in forecast mode.
Filter buttons hidden in forecast mode.
Table reflows correctly on toggle.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Season selector dropdown with forecast toggle and conditional column visibility</what-built>
  <how-to-verify>
1. Visit https://stadion.svawc.nl/contributie (or DEPLOY_PRODUCTION_URL from .env)

2. Verify current season view (default):
   - Dropdown shows "2025-2026 (huidig)" selected
   - All 10 columns visible (including Nikki and Saldo)
   - Filter buttons visible (Geen Nikki, Afwijking if counts > 0)
   - "Nog te ontvangen" total visible

3. Switch to forecast:
   - Select "2026-2027 (prognose)" from dropdown
   - Nikki and Saldo columns INSTANTLY disappear
   - Remaining columns expand to fill table width
   - Blue "Prognose (o.b.v. huidige ledenstand)" badge appears
   - Filter buttons disappear
   - "Nog te ontvangen" total disappears
   - Member count and total fee updates (should be slightly different due to 100% pro-rata)

4. Switch back to current:
   - Nikki and Saldo columns reappear
   - Badge disappears
   - Filter buttons reappear
   - All totals visible

5. Test sort reset:
   - In current mode, click Nikki column header to sort by Nikki
   - Switch to forecast
   - Table should reset to last_name sort (not error or empty)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] `npm run lint` passes with no errors
- [ ] `npm run build` succeeds
- [ ] Dropdown toggles between current and forecast views
- [ ] API refetch happens on season change (verify in Network tab)
- [ ] Nikki/Saldo columns hidden in forecast mode
- [ ] Forecast indicator badge visible in forecast mode
- [ ] Filter buttons hidden in forecast mode
- [ ] Totals row correct in both modes
- [ ] Sort resets when entering forecast if sorting by Nikki columns
</verification>

<success_criteria>
- Season dropdown shows current season "(huidig)" and next season "(prognose)"
- Selecting forecast updates table with projected fee data
- Nikki and Saldo columns instantly hide in forecast mode
- Visual indicator clearly shows user is viewing a projection
- Filter buttons only show in current mode
- Totals row adapts to show only relevant columns
</success_criteria>

<output>
After completion, create `.planning/phases/130-frontend-season-selector/130-01-SUMMARY.md`
</output>
