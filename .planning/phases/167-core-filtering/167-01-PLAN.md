---
phase: 167-core-filtering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-people.php
  - includes/class-rest-api.php
  - includes/class-rest-teams.php
autonomous: true

must_haves:
  truths:
    - "Leden list API endpoint excludes former members by default"
    - "Dashboard member count does not include former members"
    - "Dashboard recent people does not show former members"
    - "Team roster 'current' list does not include former members"
  artifacts:
    - path: "includes/class-rest-people.php"
      provides: "Former member exclusion in filtered people SQL query"
      contains: "former_member"
    - path: "includes/class-rest-api.php"
      provides: "Former member exclusion in dashboard stats and recent people"
      contains: "former_member"
    - path: "includes/class-rest-teams.php"
      provides: "Former member exclusion in team roster query"
      contains: "former_member"
  key_links:
    - from: "includes/class-rest-people.php"
      to: "postmeta table"
      via: "SQL WHERE clause on former_member meta"
      pattern: "former_member.*!=.*1|former_member.*IS NULL"
    - from: "includes/class-rest-api.php"
      to: "WP_Query meta_query"
      via: "meta_query parameter in get_posts and custom count"
      pattern: "former_member"
    - from: "includes/class-rest-teams.php"
      to: "WP_Query meta_query"
      via: "meta_query parameter in get_posts"
      pattern: "former_member"
---

<objective>
Exclude former members from default views across the Leden list, dashboard, and team rosters.

Purpose: Former members (marked by rondo-sync in Phase 166) should be hidden from everyday views so the app shows only active club members. This is the core filtering layer that all subsequent phases (168: visibility controls, 169: contributie) build on.

Output: Three PHP files updated with former_member exclusion logic.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevald/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/166-backend-foundation/166-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Exclude former members from filtered people endpoint and dashboard</name>
  <files>includes/class-rest-people.php, includes/class-rest-api.php</files>
  <action>
**In `includes/class-rest-people.php` — `get_filtered_people()` method (around line 1013-1020):**

Add a WHERE clause to exclude former members by default. After the existing `$where_clauses` array initialization (which has `p.post_type = 'person'` and `p.post_status = 'publish'`), add a LEFT JOIN and WHERE clause:

```php
$join_clauses[] = "LEFT JOIN {$wpdb->postmeta} fm ON p.ID = fm.post_id AND fm.meta_key = 'former_member'";
$where_clauses[] = "(fm.meta_value IS NULL OR fm.meta_value = '' OR fm.meta_value = '0')";
```

This excludes people where `former_member` is `1`/true. People without the meta key at all (NULL) or with empty/0 values are included (they are active members). Place this immediately after the existing `$where_clauses` initialization and before the `// VOG-only users can only see volunteers` block.

**In `includes/class-rest-api.php` — `get_dashboard_summary()` method (around line 1896):**

Replace the simple `wp_count_posts('person')->publish` with a WP_Query count that excludes former members:

```php
$people_query = new \WP_Query([
    'post_type'      => 'person',
    'post_status'    => 'publish',
    'posts_per_page' => 1,
    'fields'         => 'ids',
    'meta_query'     => [
        'relation' => 'OR',
        [
            'key'     => 'former_member',
            'compare' => 'NOT EXISTS',
        ],
        [
            'key'     => 'former_member',
            'value'   => '1',
            'compare' => '!=',
        ],
    ],
]);
$total_people = $people_query->found_posts;
```

Also update the `$recent_people` get_posts call to add the same `meta_query` filter, ensuring former members don't show in "recent people" on the dashboard:

```php
$recent_people = get_posts([
    'post_type'      => 'person',
    'posts_per_page' => 5,
    'post_status'    => 'publish',
    'orderby'        => 'modified',
    'order'          => 'DESC',
    'meta_query'     => [
        'relation' => 'OR',
        [
            'key'     => 'former_member',
            'compare' => 'NOT EXISTS',
        ],
        [
            'key'     => 'former_member',
            'value'   => '1',
            'compare' => '!=',
        ],
    ],
]);
```

Also update the `get_recently_contacted_people()` method's raw SQL query (around line 2076) to exclude former members. Add a LEFT JOIN to postmeta and a WHERE clause:

```sql
LEFT JOIN {$wpdb->postmeta} fm ON p.ID = fm.post_id AND fm.meta_key = 'former_member'
```

And add to the WHERE:
```sql
AND (fm.meta_value IS NULL OR fm.meta_value = '' OR fm.meta_value = '0')
```
  </action>
  <verify>
Deploy to production and test:
1. `curl` the `/rondo/v1/people/filtered` endpoint — response should not contain any people where `acf.former_member` is `1` (or true)
2. `curl` the `/rondo/v1/dashboard` endpoint — `stats.total_people` count should exclude former members
3. Check that `recent_people` in the dashboard response does not include any former members
  </verify>
  <done>
Filtered people endpoint returns only active members by default. Dashboard stats and recent people exclude former members. Recently contacted people exclude former members.
  </done>
</task>

<task type="auto">
  <name>Task 2: Exclude former members from team rosters</name>
  <files>includes/class-rest-teams.php</files>
  <action>
**In `includes/class-rest-teams.php` — `get_people_by_company()` method (around line 208):**

Add a meta_query clause to the `get_posts` call to exclude former members from the initial query. The current query fetches all people with `work_history > 0`. Add a combined meta_query that also excludes former members:

```php
$people = get_posts([
    'post_type'      => 'person',
    'posts_per_page' => -1,
    'post_status'    => 'publish',
    'meta_query'     => [
        'relation' => 'AND',
        [
            'key'     => 'work_history',
            'value'   => 0,
            'compare' => '>',
            'type'    => 'NUMERIC',
        ],
        [
            'relation' => 'OR',
            [
                'key'     => 'former_member',
                'compare' => 'NOT EXISTS',
            ],
            [
                'key'     => 'former_member',
                'value'   => '1',
                'compare' => '!=',
            ],
        ],
    ],
    'fields'         => 'ids',
]);
```

This preserves the existing work_history filter while also excluding people marked as former members. Former members will not appear in either the "current" or "former" (work history former) lists on team detail pages.

After making the change, run `npm run build` from the rondo-club directory, then deploy using `bin/deploy.sh`.
  </action>
  <verify>
Deploy to production and test:
1. `curl` the `/rondo/v1/teams/{id}/people` endpoint for a team that has members — former members should not appear in either `current` or `former` arrays
2. Visit a team detail page in the browser — staff and player lists should only show active members
  </verify>
  <done>
Team roster endpoint excludes former members from both current and former work history lists. Build artifacts are updated and deployed to production.
  </done>
</task>

</tasks>

<verification>
1. **LIST-01**: GET `/rondo/v1/people/filtered` returns only active members (former_member != 1)
2. **DASH-01**: GET `/rondo/v1/dashboard` — `stats.total_people` excludes former members, `recent_people` excludes former members
3. **TEAM-01**: GET `/rondo/v1/teams/{id}/people` — neither `current` nor `former` arrays contain former members
4. No regressions: active members (former_member = 0 or not set) still appear in all views
</verification>

<success_criteria>
- Leden list shows only active members by default (no former_member=1 in results)
- Dashboard total_people count is lower by the number of former members
- Dashboard recent_people does not include former members
- Team rosters exclude former members from player and staff lists
- All active members continue to appear normally in all views
</success_criteria>

<output>
After completion, create `.planning/phases/167-core-filtering/167-01-SUMMARY.md`
</output>
