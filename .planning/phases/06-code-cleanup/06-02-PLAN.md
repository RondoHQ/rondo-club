---
phase: 06-code-cleanup
plan: 02
type: execute
depends_on: []
files_modified:
  - .env.example
  - src/utils/familyTreeBuilder.js
---

<objective>
Create environment variable documentation and consolidate duplicated decodeHtml() logic.

Purpose: Improve developer onboarding with documented environment variables and apply DRY principles to HTML decoding.
Output: .env.example file created, decodeHtml() consolidated to single implementation in formatters.js.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Environment variables used in codebase:**
From includes/class-rest-slack.php:
- RONDO_ENCRYPTION_KEY - 32-byte key for sodium encryption of Slack tokens
- RONDO_SLACK_CLIENT_ID - Slack OAuth app client ID
- RONDO_SLACK_CLIENT_SECRET - Slack OAuth app client secret
- RONDO_SLACK_SIGNING_SECRET - Slack request signature verification

**Duplicated decodeHtml() logic:**
- src/utils/formatters.js:12-16 - canonical implementation (already used by 5 files)
- src/utils/familyTreeBuilder.js:43-47 - inline duplicate that should import from formatters.js

The formatters.js implementation:
```javascript
export function decodeHtml(html) {
  if (!html) return '';
  const txt = document.createElement('textarea');
  txt.innerHTML = html;
  return txt.value;
}
```

The familyTreeBuilder.js inline duplicate:
```javascript
if (personName && typeof personName === 'string' && typeof document !== 'undefined') {
  const txt = document.createElement('textarea');
  txt.innerHTML = personName;
  personName = txt.value;
}
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .env.example with documented environment variables</name>
  <files>.env.example</files>
  <action>
Create .env.example in the repository root documenting all required environment variables.

Format each variable with:
- The variable name
- A placeholder value or format hint
- A comment explaining what it's for

Variables to document:
1. RONDO_ENCRYPTION_KEY - must be exactly 32 bytes for sodium_crypto_secretbox
2. RONDO_SLACK_CLIENT_ID - from Slack app settings
3. RONDO_SLACK_CLIENT_SECRET - from Slack app settings
4. RONDO_SLACK_SIGNING_SECRET - from Slack app settings

Include a header comment explaining these go in wp-config.php as define() constants, not as environment variables, since this is a WordPress theme.
  </action>
  <verify>cat .env.example shows all 4 variables with descriptions</verify>
  <done>.env.example exists with all 4 environment variables documented</done>
</task>

<task type="auto">
  <name>Task 2: Consolidate decodeHtml() in familyTreeBuilder.js</name>
  <files>src/utils/familyTreeBuilder.js</files>
  <action>
Replace the inline HTML decoding logic in familyTreeBuilder.js with the shared decodeHtml() function from formatters.js.

Steps:
1. Add import at top of file: `import { decodeHtml } from './formatters';`
2. Find the extractPersonData function (around line 40)
3. Replace the inline decoding block:
   ```javascript
   if (personName && typeof personName === 'string' && typeof document !== 'undefined') {
     const txt = document.createElement('textarea');
     txt.innerHTML = personName;
     personName = txt.value;
   }
   ```
   With:
   ```javascript
   personName = decodeHtml(personName);
   ```

The decodeHtml function already handles null/undefined input by returning empty string.
  </action>
  <verify>grep -n "document.createElement.*textarea" src/utils/familyTreeBuilder.js returns no matches</verify>
  <done>familyTreeBuilder.js uses shared decodeHtml() function, no inline implementation</done>
</task>

<task type="auto">
  <name>Task 3: Verify no duplicate decodeHtml implementations remain</name>
  <files>src/</files>
  <action>
Search the entire src/ directory to confirm decodeHtml is only defined once (in formatters.js) and all usages import from there.

Check for:
1. No other function definitions with decodeHtml name
2. No inline textarea-based HTML decoding patterns
3. All imports of decodeHtml come from @/utils/formatters or ./formatters

Run build to ensure imports resolve correctly.
  </action>
  <verify>grep -r "function decodeHtml" src/ shows only formatters.js, npm run build succeeds</verify>
  <done>Single decodeHtml implementation in formatters.js, all usages import from there</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `.env.example` exists with all 4 variables documented
- [ ] `grep -n "document.createElement.*textarea" src/utils/familyTreeBuilder.js` returns no matches
- [ ] `grep -r "function decodeHtml" src/` shows only formatters.js
- [ ] `npm run build` succeeds
- [ ] `npm run lint` passes
</verification>

<success_criteria>

- .env.example created with all required environment variables
- familyTreeBuilder.js uses shared decodeHtml() function
- No duplicate HTML decoding implementations in codebase
- Build and lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-code-cleanup/06-02-SUMMARY.md`
</output>
