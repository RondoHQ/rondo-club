---
phase: 93-search-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-api.php
autonomous: true

must_haves:
  truths:
    - "Searching for text that exists in a Text custom field returns matching People"
    - "Searching for text that exists in an Email custom field returns matching People"
    - "Searching for text that exists in a URL custom field returns matching Teams"
    - "Custom field matches score lower than name matches in search results"
    - "Only active custom fields are searched"
  artifacts:
    - path: "includes/class-rest-api.php"
      provides: "get_searchable_custom_fields() and build_custom_field_meta_query() methods"
      contains: "get_searchable_custom_fields"
  key_links:
    - from: "includes/class-rest-api.php"
      to: "includes/customfields/class-manager.php"
      via: "Manager::get_fields() call"
      pattern: "Manager.*get_fields"
---

<objective>
Integrate custom field values into global search for People and Teams.

Purpose: Users can find records by searching text in custom fields (linkedin URL, team email, notes, etc.)
Output: Extended global_search() method that queries custom field meta values with scoring
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/93-search-integration/93-CONTEXT.md
@.planning/phases/93-search-integration/93-RESEARCH.md
@includes/class-rest-api.php (global_search method around line 1090)
@includes/customfields/class-manager.php (get_fields method)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add helper methods for custom field search</name>
  <files>includes/class-rest-api.php</files>
  <action>
Add two private helper methods to STADION_REST_API class:

1. `get_searchable_custom_fields( string $post_type ): array`
   - Use `\Stadion\CustomFields\Manager` to get active fields via `get_fields($post_type, false)`
   - Filter to searchable types: text, textarea, email, url, number, select, checkbox
   - Return array of field names (the `name` key, NOT `key` - this is the meta key)
   - Return empty array if no searchable fields

2. `build_custom_field_meta_query( array $field_names, string $query ): array`
   - If field_names is empty, return empty array
   - Build meta_query with `relation => 'OR'`
   - For each field name, add array with key, value (LIKE), compare
   - Return the complete meta_query array

Place these methods after the existing helper methods in the class (around line 380, after format_team_summary).
  </action>
  <verify>
PHP syntax check: `php -l includes/class-rest-api.php` passes without errors
  </verify>
  <done>
Two helper methods exist in STADION_REST_API class that can retrieve searchable field names and build meta queries
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate custom field search into global_search()</name>
  <files>includes/class-rest-api.php</files>
  <action>
Extend the `global_search()` method to include custom field queries:

**For People (after Query 3, before sorting):**
1. Get searchable custom field names: `$custom_field_names = $this->get_searchable_custom_fields('person');`
2. If not empty, build meta query and execute:
   ```php
   if ( ! empty( $custom_field_names ) ) {
       $custom_meta_query = $this->build_custom_field_meta_query( $custom_field_names, $query );
       $custom_field_matches = get_posts([
           'post_type'      => 'person',
           'posts_per_page' => 20,
           'post_status'    => 'publish',
           'meta_query'     => $custom_meta_query,
       ]);
       foreach ( $custom_field_matches as $person ) {
           if ( ! isset( $people_results[ $person->ID ] ) ) {
               $people_results[ $person->ID ] = [
                   'person' => $person,
                   'score'  => 30,
               ];
           }
       }
   }
   ```

**For Teams (replace simple 's' search with scored approach):**
1. Refactor team search to use same scoring pattern as people:
   - Query 1: Name field matches (score 60) - use `meta_query` on `name` field
   - Query 2: General WordPress search (score 20)
   - Query 3: Custom field matches (score 30)
2. Sort by score, take top 10

This ensures custom field search works consistently for both post types with appropriate scoring.
  </action>
  <verify>
1. PHP syntax check: `php -l includes/class-rest-api.php` passes
2. Start dev server if needed
3. Test search via browser or curl:
   - Search should still return normal results (no regression)
   - If a custom field exists with searchable content, searching that content should return the record
  </verify>
  <done>
1. Searching text in People custom fields (text, email, url, etc.) returns matching people with score 30
2. Searching text in Team custom fields returns matching teams
3. Custom field matches appear after name matches but before general matches in results
4. Empty custom field search (no fields defined) causes no errors
  </done>
</task>

</tasks>

<verification>
**Automated:**
- `php -l includes/class-rest-api.php` passes

**Manual (after deployment):**
1. Ensure a custom field exists (e.g., Text field "LinkedIn" on People)
2. Add a value to that field for a person (e.g., "linkedin.com/in/testuser")
3. Search for part of that value (e.g., "testuser")
4. Verify the person appears in search results
5. Repeat for Teams if custom fields are defined there
</verification>

<success_criteria>
- Custom field values are included in global search
- Text, Textarea, Email, URL, Number, Select, Checkbox types are searched
- Image, File, Color, Relationship, Link, Date, True/False are NOT searched
- Only active custom fields are searched
- Custom field matches score 30 (lower priority than name matches)
- No regression in existing search functionality
</success_criteria>

<output>
After completion, create `.planning/phases/93-search-integration/93-01-SUMMARY.md`
</output>
