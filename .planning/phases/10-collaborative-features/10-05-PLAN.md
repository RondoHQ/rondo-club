---
phase: 10-collaborative-features
plan: 05
type: execute
depends_on: ["10-03"]
files_modified: [includes/class-reminders.php, includes/class-email-channel.php]
---

<objective>
Integrate workspace activity (including mentions) into the existing daily reminder digest system.

Purpose: Include workspace activity in users' daily digests, so they stay informed about collaborative work.
Output: Extended STADION_Reminders with workspace activity section, mentions included in digest emails.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-collaborative-features/10-RESEARCH.md
@.planning/phases/10-collaborative-features/10-03-SUMMARY.md (when available)

**Relevant source files:**
@includes/class-reminders.php
@includes/class-email-channel.php
@includes/class-mention-notifications.php

**From RESEARCH.md:**
- Don't create separate workspace digests - include in existing user digest
- Continue using per-user cron (already implemented)
- Include workspace sections in digest (like existing today/tomorrow/week sections)
- Call STADION_Mention_Notifications::get_queued_mentions() to get pending mentions

**Constraining decisions:**
- Phase 10-03: Mentions queued in user meta via STADION_Mention_Notifications
- Existing: STADION_Reminders handles daily digest scheduling per user
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add workspace activity gathering to STADION_Reminders</name>
  <files>includes/class-reminders.php</files>
  <action>
  1. In process_user_reminders(), after gathering upcoming dates, gather workspace activity:

  ```php
  // After $reminders array is built with upcoming dates...

  // Get queued mention notifications
  $mentions = STADION_Mention_Notifications::get_queued_mentions($user_id);

  // Get recent workspace activity (notes on shared contacts in user's workspaces)
  $workspace_activity = $this->get_workspace_activity($user_id);

  // Add to data passed to notification channels
  $notification_data = [
      'reminders' => $reminders,
      'mentions' => $mentions,
      'workspace_activity' => $workspace_activity,
  ];
  ```

  2. Add get_workspace_activity() method:

  ```php
  /**
   * Get recent activity on contacts in user's workspaces (last 24 hours)
   *
   * @param int $user_id User ID
   * @return array Recent notes on workspace contacts by other users
   */
  private function get_workspace_activity($user_id) {
      // Get user's workspace memberships
      $memberships = get_user_meta($user_id, '_workspace_memberships', true);
      if (!is_array($memberships) || empty($memberships)) return [];

      $workspace_ids = array_keys($memberships);

      // Get workspace terms
      $term_slugs = array_map(fn($id) => 'workspace-' . $id, $workspace_ids);
      $terms = get_terms([
          'taxonomy' => 'workspace_access',
          'slug' => $term_slugs,
          'hide_empty' => false,
      ]);
      if (empty($terms) || is_wp_error($terms)) return [];
      $term_ids = wp_list_pluck($terms, 'term_id');

      // Get contacts in these workspaces
      $contacts = get_posts([
          'post_type' => ['person', 'team'],
          'posts_per_page' => -1,
          'tax_query' => [
              [
                  'taxonomy' => 'workspace_access',
                  'field' => 'term_id',
                  'terms' => $term_ids,
              ],
          ],
          'fields' => 'ids',
      ]);
      if (empty($contacts)) return [];

      // Get shared notes from last 24 hours by OTHER users
      $since = date('Y-m-d H:i:s', strtotime('-24 hours'));
      $comments = get_comments([
          'post__in' => $contacts,
          'type' => 'stadion_note',
          'author__not_in' => [$user_id], // Not user's own notes
          'date_query' => [
              'after' => $since,
          ],
          'meta_query' => [
              [
                  'key' => '_note_visibility',
                  'value' => 'shared',
              ],
          ],
          'number' => 10, // Limit to recent 10
      ]);

      $activity = [];
      foreach ($comments as $comment) {
          $author = get_userdata($comment->user_id);
          $post = get_post($comment->comment_post_ID);
          if (!$author || !$post) continue;

          $activity[] = [
              'author' => $author->display_name,
              'post_title' => $post->post_title,
              'post_type' => $post->post_type,
              'post_url' => home_url(($post->post_type === 'person' ? '/people/' : '/teams/') . $post->ID),
              'preview' => wp_trim_words(wp_strip_all_tags($comment->comment_content), 20),
              'date' => $comment->comment_date,
          ];
      }

      return $activity;
  }
  ```

  Do NOT change the existing reminder logic - only add new data collection.
  </action>
  <verify>
  - Check process_user_reminders() gathers mentions and workspace_activity
  - Check get_workspace_activity() method exists and returns activity array
  </verify>
  <done>STADION_Reminders collects workspace activity and queued mentions</done>
</task>

<task type="auto">
  <name>Task 2: Update email digest to include workspace activity section</name>
  <files>includes/class-email-channel.php</files>
  <action>
  1. In STADION_Email_Channel::send_notification(), update the email body generation to include new sections.

  After the existing reminders section, add:

  ```php
  // Mentions section
  if (!empty($data['mentions'])) {
      $body .= "\n<h3>You were mentioned</h3>\n";
      foreach ($data['mentions'] as $mention) {
          $body .= sprintf(
              "<p><strong>%s</strong> mentioned you on <a href=\"%s\">%s</a>:<br><em>%s</em></p>\n",
              esc_html($mention['author']),
              esc_url($mention['post_url']),
              esc_html($mention['post_title']),
              esc_html($mention['preview'])
          );
      }
  }

  // Workspace activity section
  if (!empty($data['workspace_activity'])) {
      $body .= "\n<h3>Workspace Activity</h3>\n";
      foreach ($data['workspace_activity'] as $activity) {
          $body .= sprintf(
              "<p><strong>%s</strong> added a note on <a href=\"%s\">%s</a>:<br><em>%s</em></p>\n",
              esc_html($activity['author']),
              esc_url($activity['post_url']),
              esc_html($activity['post_title']),
              esc_html($activity['preview'])
          );
      }
  }
  ```

  2. Update the subject line to indicate if there's collaborative activity:
  ```php
  $has_collab = !empty($data['mentions']) || !empty($data['workspace_activity']);
  $subject = $has_collab
      ? 'Your Stadion digest (including team activity)'
      : 'Your Stadion digest';
  ```

  Keep email formatting consistent with existing style.
  </action>
  <verify>
  - Check STADION_Email_Channel includes mentions and workspace_activity in email body
  - Check sections only appear when there's content
  </verify>
  <done>Email digest includes mentions and workspace activity sections</done>
</task>

<task type="auto">
  <name>Task 3: Skip digest if no content (avoid empty emails)</name>
  <files>includes/class-reminders.php</files>
  <action>
  1. In process_user_reminders(), check if there's any content before sending:

  ```php
  // Before calling notification channels
  $has_content = !empty($reminders) || !empty($mentions) || !empty($workspace_activity);

  if (!$has_content) {
      // Nothing to notify about - skip this user
      return;
  }
  ```

  2. This prevents sending empty digest emails when user has no:
     - Upcoming important dates
     - Pending mention notifications
     - Recent workspace activity

  This is a quality-of-life improvement - users shouldn't get empty digests.
  </action>
  <verify>Check process_user_reminders() returns early if no content</verify>
  <done>Empty digests are not sent</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Digest email includes mentions section (when mentions queued)
- [ ] Digest email includes workspace activity section (when activity exists)
- [ ] Empty digests are not sent
- [ ] Existing reminder functionality unchanged
- [ ] Queued mentions cleared after inclusion in digest
- [ ] `npm run build` succeeds (no PHP syntax errors break build)
</verification>

<success_criteria>

- All tasks completed
- Daily digest includes collaborative activity
- Mentions dequeued after email sent
- No duplicate notifications
- No empty emails sent
- Existing reminder functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/10-collaborative-features/10-05-SUMMARY.md`

Also create `.planning/phases/10-collaborative-features/SUMMARY.md` with phase overview:
- Phase 10: Collaborative Features complete
- 5 plans executed (01: Note visibility, 02: Mentions infra, 03: Mention notifications, 04: Workspace iCal, 05: Activity digest)
- Key deliverables: Note visibility, @mentions with notifications, workspace calendar feeds, activity digests
- Ready for Phase 11: Migration, Testing & Polish
</output>
