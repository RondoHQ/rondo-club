---
phase: 10-collaborative-features
plan: 01
type: execute
depends_on: []
files_modified: [includes/class-comment-types.php, acf-json/group_note_settings.json, src/components/Timeline/TimelineView.jsx, src/pages/People/PersonDetail.jsx]
---

<objective>
Add visibility controls to timeline notes, allowing users to mark notes as private (only visible to author) or shared (visible to all who can see the contact).

Purpose: Enable collaborative note-taking on shared contacts while preserving privacy for personal observations.
Output: Notes with visibility field, updated API response, UI indicator for shared vs private notes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-collaborative-features/10-RESEARCH.md

**Relevant source files:**
@includes/class-comment-types.php
@src/components/Timeline/TimelineView.jsx
@src/pages/People/PersonDetail.jsx

**Tech stack available (from Phase 9):**
- TanStack Query hooks for CRUD operations
- VisibilitySelector component pattern (can reference)
- Access control system checking visibility, workspace membership, shares

**Constraining decisions:**
- Phase 7: Default visibility = private (preserve this for notes)
- Phase 9: VisibilitySelector uses Private/Workspace toggle pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add visibility field to notes in PRM_Comment_Types</name>
  <files>includes/class-comment-types.php</files>
  <action>
  1. Add `_note_visibility` comment meta field with values 'private' (default) or 'shared'
  2. Update `create_note()` method to accept optional `visibility` parameter, default to 'private'
  3. Update `update_note()` method to accept `visibility` parameter
  4. Update `format_comment_for_response()` to include `visibility` field in response
  5. Update `get_notes_for_post()` to filter notes based on visibility:
     - Author always sees their own notes
     - Shared notes visible to anyone who can see the contact
     - Private notes only visible to author

  Use `get_comment_meta()` and `update_comment_meta()` for storage.
  Do NOT change existing note behavior - private by default preserves current single-user experience.
  </action>
  <verify>
  - Check `includes/class-comment-types.php` has visibility field in format_comment_for_response()
  - Check create_note() accepts visibility parameter
  - Check get_notes_for_post() filters by visibility
  </verify>
  <done>Notes have visibility field, API returns visibility in response, private notes filtered for non-authors</done>
</task>

<task type="auto">
  <name>Task 2: Add visibility toggle to note creation UI</name>
  <files>src/pages/People/PersonDetail.jsx</files>
  <action>
  1. Find the note creation form/textarea in PersonDetail.jsx
  2. Add a simple toggle below the textarea: "Share with others who can see this contact"
     - Default: off (private)
     - When on: passes visibility='shared' to API
  3. Use a checkbox with Lock/Unlock icon indicator
  4. Only show toggle when contact is shared (visibility='workspace' or 'shared')
     - If contact is private, all notes are private by default, no toggle needed

  Pattern reference from VisibilitySelector:
  ```jsx
  <label className="flex items-center gap-2 text-sm text-gray-600">
    <input
      type="checkbox"
      checked={noteVisibility === 'shared'}
      onChange={(e) => setNoteVisibility(e.target.checked ? 'shared' : 'private')}
      className="rounded border-gray-300"
    />
    <span>Share this note with others who can see this contact</span>
  </label>
  ```

  Do NOT add complex UI - a simple checkbox is sufficient for MVP.
  </action>
  <verify>Inspect PersonDetail.jsx for visibility toggle in note creation form</verify>
  <done>Note creation shows visibility toggle when contact is shared, passes visibility to API</done>
</task>

<task type="auto">
  <name>Task 3: Display visibility indicator on timeline notes</name>
  <files>src/components/Timeline/TimelineView.jsx</files>
  <action>
  1. Import Lock and Globe icons from lucide-react
  2. For notes (isNote), add visibility indicator after the date:
     - Private: small Lock icon with tooltip "Private note - only you can see this"
     - Shared: small Globe icon with tooltip "Shared note"
  3. Add subtle visual distinction:
     - Private notes: normal appearance
     - Shared notes: subtle left border (e.g., border-l-2 border-blue-200)

  Example in the date line section:
  ```jsx
  {isNote && (
    <span className="ml-2" title={item.visibility === 'shared' ? 'Shared note' : 'Private note'}>
      {item.visibility === 'shared'
        ? <Globe className="w-3 h-3 text-blue-500" />
        : <Lock className="w-3 h-3 text-gray-400" />
      }
    </span>
  )}
  ```

  Keep changes minimal - the visibility indicator should be informative but not distracting.
  </action>
  <verify>Check TimelineView.jsx renders Lock/Globe icons for notes based on visibility</verify>
  <done>Timeline shows visibility indicator for each note, shared notes have subtle visual distinction</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Notes created via API have visibility field in response
- [ ] Private notes only visible to author in API response
- [ ] Note creation UI shows visibility toggle on shared contacts
- [ ] Timeline displays visibility indicator (Lock/Globe) for notes
- [ ] `npm run build` succeeds
- [ ] `npm run lint` passes
</verification>

<success_criteria>

- All tasks completed
- Private notes remain private (only author sees them)
- Shared notes visible to all who can see the contact
- UI clearly indicates note visibility
- Default behavior unchanged (private by default)
</success_criteria>

<output>
After completion, create `.planning/phases/10-collaborative-features/10-01-SUMMARY.md`
</output>
