---
phase: 10-collaborative-features
plan: 04
type: execute
depends_on: []
files_modified: [includes/class-ical-feed.php, src/pages/Workspaces/WorkspaceDetail.jsx, src/api/client.js]
---

<objective>
Extend the iCal feed system to support workspace-scoped calendars, allowing workspace members to subscribe to important dates for all contacts visible to the workspace.

Purpose: Enable team calendar subscriptions that include all workspace contacts' important dates.
Output: Workspace iCal feed endpoint, UI for copying workspace calendar URL.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-collaborative-features/10-RESEARCH.md

**Relevant source files:**
@includes/class-ical-feed.php
@src/pages/Workspaces/WorkspaceDetail.jsx

**From RESEARCH.md:**
- Extend existing PRM_ICal_Feed with workspace scope
- Token must belong to user who is workspace member
- Check membership on every feed request
- URL format: /workspace/{workspace_id}/calendar/{token}.ics

**Tech stack available:**
- PRM_ICal_Feed with manual iCal generation
- PRM_Workspace_Members for membership checks
- Existing user iCal token system
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add workspace iCal rewrite rules and query vars</name>
  <files>includes/class-ical-feed.php</files>
  <action>
  1. In PRM_ICal_Feed::register_query_vars(), add new query vars:
  ```php
  $vars[] = 'prm_workspace_ical';
  $vars[] = 'prm_workspace_id';
  ```

  2. In PRM_ICal_Feed::register_rewrite_rules(), add workspace calendar rule:
  ```php
  add_rewrite_rule(
      '^workspace/([0-9]+)/calendar/([a-f0-9]+)\.ics$',
      'index.php?prm_workspace_ical=1&prm_workspace_id=$matches[1]&prm_ical_token=$matches[2]',
      'top'
  );
  ```

  3. In PRM_ICal_Feed::maybe_handle_feed_request(), add workspace feed handling BEFORE the existing personal feed check:
  ```php
  if (get_query_var('prm_workspace_ical')) {
      $this->handle_workspace_feed();
      exit;
  }
  ```

  Keep the order: workspace feed check first, then personal feed check.
  </action>
  <verify>Check class-ical-feed.php has workspace query vars and rewrite rule</verify>
  <done>WordPress routes /workspace/{id}/calendar/{token}.ics to workspace feed handler</done>
</task>

<task type="auto">
  <name>Task 2: Implement workspace iCal feed handler</name>
  <files>includes/class-ical-feed.php</files>
  <action>
  Add handle_workspace_feed() method to PRM_ICal_Feed:

  ```php
  /**
   * Handle workspace iCal feed request
   */
  private function handle_workspace_feed() {
      $workspace_id = intval(get_query_var('prm_workspace_id'));
      $token = sanitize_text_field(get_query_var('prm_ical_token'));

      // Verify token belongs to a valid user
      $user_id = $this->get_user_by_token($token);
      if (!$user_id) {
          status_header(403);
          echo 'Invalid token';
          exit;
      }

      // Verify workspace exists
      $workspace = get_post($workspace_id);
      if (!$workspace || $workspace->post_type !== 'workspace' || $workspace->post_status !== 'publish') {
          status_header(404);
          echo 'Workspace not found';
          exit;
      }

      // Verify user is a member of the workspace
      if (!PRM_Workspace_Members::is_member($workspace_id, $user_id)) {
          status_header(403);
          echo 'Access denied - not a workspace member';
          exit;
      }

      // Get all important dates for contacts in this workspace
      $important_dates = $this->get_workspace_important_dates($workspace_id);

      // Generate iCal output
      $this->output_ical($important_dates, 'Caelis - ' . $workspace->post_title);
  }

  /**
   * Get important dates for contacts in a workspace
   */
  private function get_workspace_important_dates($workspace_id) {
      // Get term ID for this workspace
      $term = get_term_by('slug', 'workspace-' . $workspace_id, 'workspace_access');
      if (!$term) return [];

      // Get all contacts (people) in this workspace
      $people = get_posts([
          'post_type' => 'person',
          'posts_per_page' => -1,
          'tax_query' => [
              [
                  'taxonomy' => 'workspace_access',
                  'field' => 'term_id',
                  'terms' => $term->term_id,
              ],
          ],
          'fields' => 'ids',
      ]);

      if (empty($people)) return [];

      // Get important dates linked to these people
      return get_posts([
          'post_type' => 'important_date',
          'posts_per_page' => -1,
          'meta_query' => [
              [
                  'key' => 'person',
                  'value' => $people,
                  'compare' => 'IN',
              ],
          ],
      ]);
  }
  ```

  Note: The output_ical() method should already exist from personal feed implementation. If it's currently private to a different method, refactor to make it reusable.
  </action>
  <verify>
  - Check handle_workspace_feed() method exists
  - Check membership verification happens before generating feed
  - Check get_workspace_important_dates() queries correctly
  </verify>
  <done>Workspace iCal feed generates calendar with all workspace contact dates</done>
</task>

<task type="auto">
  <name>Task 3: Add workspace calendar URL to WorkspaceDetail UI</name>
  <files>src/pages/Workspaces/WorkspaceDetail.jsx, src/api/client.js</files>
  <action>
  1. The user already has an iCal token (stored in user meta from existing personal feed).
     Use the same token for workspace feeds to avoid managing multiple tokens.

  2. In WorkspaceDetail.jsx, add a "Calendar Subscription" section:

  ```jsx
  // Add to imports
  import { Calendar, Copy, Check } from 'lucide-react';

  // Add state for copy feedback
  const [calendarCopied, setCalendarCopied] = useState(false);

  // Get user's iCal token from settings or fetch
  const { data: settings } = useUserSettings();
  const icalToken = settings?.ical_token;

  // Construct workspace calendar URL
  const workspaceCalendarUrl = icalToken
    ? `${window.location.origin}/workspace/${workspace.id}/calendar/${icalToken}.ics`
    : null;

  // Copy handler
  const handleCopyCalendarUrl = () => {
    if (workspaceCalendarUrl) {
      navigator.clipboard.writeText(workspaceCalendarUrl);
      setCalendarCopied(true);
      setTimeout(() => setCalendarCopied(false), 2000);
    }
  };

  // In the workspace detail UI, add after member list:
  <div className="bg-gray-50 rounded-lg p-4 mt-6">
    <h3 className="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
      <Calendar className="w-4 h-4" />
      Calendar Subscription
    </h3>
    <p className="text-xs text-gray-500 mb-3">
      Subscribe to important dates for all contacts in this workspace.
    </p>
    {icalToken ? (
      <div className="flex items-center gap-2">
        <input
          type="text"
          value={workspaceCalendarUrl}
          readOnly
          className="flex-1 text-xs px-2 py-1 bg-white border border-gray-300 rounded"
        />
        <button
          onClick={handleCopyCalendarUrl}
          className="px-3 py-1 text-xs bg-primary-600 text-white rounded hover:bg-primary-700 flex items-center gap-1"
        >
          {calendarCopied ? <Check className="w-3 h-3" /> : <Copy className="w-3 h-3" />}
          {calendarCopied ? 'Copied!' : 'Copy'}
        </button>
      </div>
    ) : (
      <p className="text-xs text-gray-500">
        Enable iCal feed in Settings to subscribe to workspace calendars.
      </p>
    )}
  </div>
  ```

  3. If useUserSettings hook doesn't exist, check how Settings.jsx fetches user settings and reuse that pattern, or create a simple fetch in WorkspaceDetail.

  Keep UI minimal - just the URL and copy button.
  </action>
  <verify>
  - Check WorkspaceDetail.jsx shows calendar subscription section
  - Check URL is correctly constructed with workspace ID and user token
  </verify>
  <done>Users can copy workspace calendar URL from WorkspaceDetail page</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Flush rewrite rules: `wp rewrite flush`
- [ ] Access /workspace/{id}/calendar/{valid_token}.ics returns iCal content
- [ ] Access with invalid token returns 403
- [ ] Access as non-member returns 403
- [ ] Calendar contains dates from workspace contacts only
- [ ] WorkspaceDetail shows calendar URL with copy button
- [ ] `npm run build` succeeds
</verification>

<success_criteria>

- All tasks completed
- Workspace calendar feed works end-to-end
- Permission checks prevent unauthorized access
- UI makes it easy to copy calendar URL
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/10-collaborative-features/10-04-SUMMARY.md`
</output>
