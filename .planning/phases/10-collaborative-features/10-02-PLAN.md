---
phase: 10-collaborative-features
plan: 02
type: execute
depends_on: []
files_modified: [src/components/MentionInput/MentionInput.jsx, src/components/MentionInput/index.js, includes/class-mentions.php, src/api/client.js, src/hooks/useWorkspaces.js, functions.php, package.json]
---

<objective>
Implement @mentions infrastructure - react-mentions frontend component, PHP parsing/storage, and workspace member search endpoint.

Purpose: Enable users to @mention team members in notes, with the mention displayed as a link.
Output: MentionInput component, STADION_Mentions class for parsing/rendering, workspace member search API.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-collaborative-features/10-RESEARCH.md

**Relevant source files:**
@includes/class-comment-types.php
@src/pages/People/PersonDetail.jsx
@src/api/client.js
@src/hooks/useWorkspaces.js

**From RESEARCH.md:**
- Use react-mentions library (npm install react-mentions)
- Markup format: @[Display Name](user_id)
- Store mentioned user IDs in comment meta `_mentioned_users`
- Parse mentions on save, not on render (performance)

**Constraining decisions:**
- Phase 8: Workspace membership stored in user meta
- Phase 9: useWorkspaces.js has hooks for workspace operations
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-mentions and create MentionInput component</name>
  <files>package.json, src/components/MentionInput/MentionInput.jsx, src/components/MentionInput/index.js</files>
  <action>
  1. Install react-mentions: `npm install react-mentions`
  2. Create `src/components/MentionInput/` directory
  3. Create MentionInput.jsx:

  ```jsx
  import { MentionsInput, Mention } from 'react-mentions';
  import { prmApi } from '@/api/client';

  const mentionStyle = {
    backgroundColor: '#e0f2fe', // light blue highlight
    borderRadius: '2px',
    padding: '1px 2px',
  };

  const defaultStyle = {
    control: {
      minHeight: 80,
    },
    input: {
      padding: 9,
      border: '1px solid #d1d5db',
      borderRadius: '0.375rem',
    },
    suggestions: {
      list: {
        backgroundColor: 'white',
        border: '1px solid #e5e7eb',
        borderRadius: '0.375rem',
        boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)',
      },
      item: {
        padding: '8px 12px',
        '&focused': {
          backgroundColor: '#f3f4f6',
        },
      },
    },
  };

  export default function MentionInput({ value, onChange, placeholder, workspaceIds = [] }) {
    const fetchUsers = async (query, callback) => {
      if (!query || workspaceIds.length === 0) {
        callback([]);
        return;
      }
      try {
        const members = await prmApi.searchWorkspaceMembers(workspaceIds, query);
        callback(members.map(u => ({ id: u.id, display: u.name })));
      } catch {
        callback([]);
      }
    };

    return (
      <MentionsInput
        value={value}
        onChange={(e, newValue) => onChange(newValue)}
        placeholder={placeholder || "Add a note... Use @ to mention someone"}
        style={defaultStyle}
      >
        <Mention
          trigger="@"
          data={fetchUsers}
          markup="@[__display__](__id__)"
          style={mentionStyle}
          appendSpaceOnAdd
        />
      </MentionsInput>
    );
  }
  ```

  4. Create index.js: `export { default } from './MentionInput';`

  Do NOT over-engineer - this is the MVP. Styling can be refined later.
  </action>
  <verify>Check package.json has react-mentions, check MentionInput.jsx exists with correct structure</verify>
  <done>react-mentions installed, MentionInput component created with autocomplete functionality</done>
</task>

<task type="auto">
  <name>Task 2: Add workspace member search API endpoint and client method</name>
  <files>includes/class-rest-workspaces.php, src/api/client.js, src/hooks/useWorkspaces.js</files>
  <action>
  1. In class-rest-workspaces.php, add endpoint for member search:

  Register route in register_routes():
  ```php
  register_rest_route('stadion/v1', '/workspaces/members/search', [
      'methods' => 'GET',
      'callback' => [$this, 'search_workspace_members'],
      'permission_callback' => [$this, 'check_permissions'],
      'args' => [
          'workspace_ids' => [
              'required' => true,
              'type' => 'string',
              'description' => 'Comma-separated workspace IDs',
          ],
          'query' => [
              'required' => true,
              'type' => 'string',
              'description' => 'Search query',
              'minLength' => 1,
          ],
      ],
  ]);
  ```

  Add search_workspace_members method:
  ```php
  public function search_workspace_members($request) {
      $workspace_ids = array_map('intval', explode(',', $request->get_param('workspace_ids')));
      $query = sanitize_text_field($request->get_param('query'));

      // Get all members of these workspaces
      $member_ids = [];
      foreach ($workspace_ids as $workspace_id) {
          $members = STADION_Workspace_Members::get_workspace_members($workspace_id);
          foreach ($members as $member) {
              $member_ids[$member['user_id']] = true;
          }
      }

      // Search users by display name
      $users = get_users([
          'include' => array_keys($member_ids),
          'search' => '*' . $query . '*',
          'search_columns' => ['display_name', 'user_email'],
          'number' => 10,
      ]);

      $results = [];
      foreach ($users as $user) {
          $results[] = [
              'id' => $user->ID,
              'name' => $user->display_name,
              'email' => $user->user_email,
          ];
      }

      return rest_ensure_response($results);
  }
  ```

  2. In src/api/client.js, add prmApi method:
  ```js
  searchWorkspaceMembers: async (workspaceIds, query) => {
    const { data } = await api.get('/stadion/v1/workspaces/members/search', {
      params: { workspace_ids: workspaceIds.join(','), query },
    });
    return data;
  },
  ```

  Do NOT add TanStack Query hook - direct API call is fine for autocomplete.
  </action>
  <verify>
  - Check class-rest-workspaces.php has search_workspace_members method
  - Check src/api/client.js has searchWorkspaceMembers method
  </verify>
  <done>Workspace member search endpoint works, client method available for MentionInput</done>
</task>

<task type="auto">
  <name>Task 3: Create STADION_Mentions class for parsing and rendering</name>
  <files>includes/class-mentions.php, functions.php</files>
  <action>
  1. Create includes/class-mentions.php:

  ```php
  <?php
  /**
   * Handles @mention parsing, storage, and rendering
   */
  class STADION_Mentions {

      /**
       * Parse user IDs from mention markup
       * Markup format: @[Display Name](user_id)
       *
       * @param string $content Content with mention markup
       * @return int[] Array of mentioned user IDs
       */
      public static function parse_mention_ids($content) {
          $pattern = '/@\[[^\]]+\]\((\d+)\)/';
          preg_match_all($pattern, $content, $matches);
          return array_map('intval', $matches[1] ?? []);
      }

      /**
       * Convert mention markup to linked HTML for display
       *
       * @param string $content Content with mention markup
       * @return string Content with mentions as links
       */
      public static function render_mentions($content) {
          $pattern = '/@\[([^\]]+)\]\((\d+)\)/';
          return preg_replace_callback($pattern, function($matches) {
              $name = esc_html($matches[1]);
              $user_id = intval($matches[2]);
              $user = get_userdata($user_id);
              if (!$user) {
                  return '@' . $name; // User deleted, show plain text
              }
              return sprintf(
                  '<span class="mention" data-user-id="%d">@%s</span>',
                  $user_id,
                  $name
              );
          }, $content);
      }

      /**
       * Store mentioned user IDs as comment meta
       *
       * @param int $comment_id Comment ID
       * @param string $content Comment content
       * @return int[] Mentioned user IDs
       */
      public static function save_mentions($comment_id, $content) {
          $mentioned_ids = self::parse_mention_ids($content);
          if (!empty($mentioned_ids)) {
              update_comment_meta($comment_id, '_mentioned_users', $mentioned_ids);
          } else {
              delete_comment_meta($comment_id, '_mentioned_users');
          }
          return $mentioned_ids;
      }

      /**
       * Get mentioned user IDs from comment
       *
       * @param int $comment_id Comment ID
       * @return int[] Mentioned user IDs
       */
      public static function get_mentions($comment_id) {
          $mentions = get_comment_meta($comment_id, '_mentioned_users', true);
          return is_array($mentions) ? $mentions : [];
      }
  }
  ```

  2. In functions.php, load the class in stadion_init():
  ```php
  require_once get_template_directory() . '/includes/class-mentions.php';
  ```

  3. In class-comment-types.php create_note() method, call STADION_Mentions::save_mentions() after creating the comment, and trigger action hook:
  ```php
  // After wp_insert_comment()
  $mentioned_ids = STADION_Mentions::save_mentions($comment_id, $content);
  if (!empty($mentioned_ids)) {
      do_action('stadion_user_mentioned', $comment_id, $mentioned_ids, get_current_user_id());
  }
  ```

  4. In format_comment_for_response(), render mentions in content:
  ```php
  'content' => STADION_Mentions::render_mentions(wp_kses_post($comment->comment_content)),
  ```

  Do NOT add notification logic here - that's Plan 03.
  </action>
  <verify>
  - Check includes/class-mentions.php exists with parse_mention_ids, render_mentions, save_mentions methods
  - Check functions.php loads class-mentions.php
  - Check class-comment-types.php calls STADION_Mentions::save_mentions()
  </verify>
  <done>STADION_Mentions class parses and stores mentions, hook fired on mention save</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm install` succeeds with react-mentions
- [ ] MentionInput component renders with autocomplete
- [ ] /stadion/v1/workspaces/members/search returns matching users
- [ ] STADION_Mentions::parse_mention_ids() extracts user IDs from markup
- [ ] Notes with mentions have _mentioned_users meta saved
- [ ] `npm run build` succeeds
- [ ] `npm run lint` passes
</verification>

<success_criteria>

- All tasks completed
- @mentions autocomplete works in isolation (can be tested with hardcoded workspaceIds)
- Mention markup stored correctly in database
- stadion_user_mentioned action fires when mentions saved
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/10-collaborative-features/10-02-SUMMARY.md`
</output>
