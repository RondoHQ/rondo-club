---
phase: 112-birthdate-denormalization
plan: 02
type: execute
wave: 2
depends_on: ["112-01"]
files_modified:
  - includes/class-rest-people.php
autonomous: true

must_haves:
  truths:
    - "User can filter people by birth year range (birth_year_from/birth_year_to) via filtered endpoint"
    - "Birth year filter uses YEAR() function on _birthdate meta for range comparison"
    - "People without _birthdate meta are excluded from birth year filter results"
    - "Birth year filter combines with other filters using AND logic"
  artifacts:
    - path: "includes/class-rest-people.php"
      provides: "Birth year range filter parameters and SQL implementation"
      contains: "birth_year_from"
  key_links:
    - from: "birth_year_from/birth_year_to parameters"
      to: "YEAR(bd.meta_value) BETWEEN %d AND %d"
      via: "get_filtered_people method WHERE clause"
      pattern: "YEAR.*BETWEEN.*AND"
---

<objective>
Add birth year filtering to the people filtered endpoint.

Purpose: Enable users to filter the people list by birth year, completing the DATA-05 requirement.

Output:
- `/stadion/v1/people/filtered` endpoint accepts `birth_year_from` and `birth_year_to` parameters
- SQL query includes LEFT JOIN on _birthdate meta with YEAR() filter
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/112-birthdate-denormalization/112-CONTEXT.md
@.planning/phases/112-birthdate-denormalization/112-RESEARCH.md
@.planning/phases/111-server-side-foundation/111-01-SUMMARY.md
@includes/class-rest-people.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add birth year filter parameters to filtered endpoint</name>
  <files>includes/class-rest-people.php</files>
  <action>
In the `register_rest_routes` method, add two new parameters to the `/filtered` endpoint registration:

1. **Add birth_year_from parameter:**
   ```php
   'birth_year_from' => [
       'description'       => 'Filter by birth year (minimum year, inclusive)',
       'type'              => 'integer',
       'sanitize_callback' => 'absint',
       'validate_callback' => function($value) {
           return $value >= 1900 && $value <= 2100;
       },
   ],
   ```

2. **Add birth_year_to parameter:**
   ```php
   'birth_year_to' => [
       'description'       => 'Filter by birth year (maximum year, inclusive)',
       'type'              => 'integer',
       'sanitize_callback' => 'absint',
       'validate_callback' => function($value) {
           return $value >= 1900 && $value <= 2100;
       },
   ],
   ```

Note: Both parameters are optional. If only one is provided, filter by exact year. If both provided, filter by range.
  </action>
  <verify>
1. Check syntax: `php -l includes/class-rest-people.php`
2. Verify parameters appear in route definition
  </verify>
  <done>
Endpoint accepts birth_year_from and birth_year_to parameters with validation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement birth year filter in get_filtered_people</name>
  <files>includes/class-rest-people.php</files>
  <action>
In the `get_filtered_people` method, add birth year filtering:

1. **Extract parameters after existing param extraction:**
   ```php
   $birth_year_from = $request->get_param('birth_year_from');
   $birth_year_to   = $request->get_param('birth_year_to');
   ```

2. **Add LEFT JOIN and WHERE clause for birth year filter** (after the label filter section, before ORDER BY):
   ```php
   // Birth year filter (uses denormalized _birthdate meta from Phase 112)
   if ($birth_year_from !== null || $birth_year_to !== null) {
       $join_clauses[] = "LEFT JOIN {$wpdb->postmeta} bd ON p.ID = bd.post_id AND bd.meta_key = '_birthdate'";

       if ($birth_year_from !== null && $birth_year_to !== null) {
           // Range filter
           $where_clauses[]  = "YEAR(bd.meta_value) BETWEEN %d AND %d";
           $prepare_values[] = $birth_year_from;
           $prepare_values[] = $birth_year_to;
       } elseif ($birth_year_from !== null) {
           // Minimum year only (treat as exact match for single year)
           $where_clauses[]  = "YEAR(bd.meta_value) = %d";
           $prepare_values[] = $birth_year_from;
       } else {
           // Maximum year only (treat as exact match for single year)
           $where_clauses[]  = "YEAR(bd.meta_value) = %d";
           $prepare_values[] = $birth_year_to;
       }
   }
   ```

Note: YEAR() on NULL returns NULL, which fails the comparison, so people without _birthdate are automatically excluded from results when this filter is active.

Note: LEFT JOIN (not INNER) because we're adding WHERE that effectively makes it inner - using LEFT keeps query structure consistent with other meta JOINs.
  </action>
  <verify>
1. Check syntax: `php -l includes/class-rest-people.php`
2. Verify JOIN and WHERE are correctly placed in query building
  </verify>
  <done>
Birth year filter implemented using LEFT JOIN on _birthdate meta with YEAR() function in WHERE clause.
  </done>
</task>

<task type="auto">
  <name>Task 3: Deploy and test birth year filter</name>
  <files></files>
  <action>
1. **Deploy to production:**
   ```bash
   bin/deploy.sh
   ```

2. **Obtain auth credentials for API testing:**

   Option A - Browser DevTools (easiest):
   - Log in to production WordPress admin
   - Open browser DevTools (F12) > Network tab
   - Navigate to any page that makes REST API calls (e.g., People list)
   - Find a request to `/wp-json/` endpoint
   - Right-click > Copy as cURL to get full auth headers

   Option B - WP-CLI nonce generation (for local testing):
   ```bash
   source .env && ssh -p "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" \
     "cd ~/www/stadion.svawc.nl/public_html/wp-content/themes/stadion && wp eval 'echo wp_create_nonce(\"wp_rest\");'"
   ```
   Note: Nonce requires matching auth cookie to work, so Option A is more practical.

3. **Test birth year filter via curl:**

   Test single year filter (birth_year_from only):
   ```bash
   # Replace <auth_cookie> and <nonce> with values from step 2
   curl -s "https://stadion.svawc.nl/wp-json/stadion/v1/people/filtered?birth_year_from=1985" \
     -H "Cookie: <auth_cookie>" \
     -H "X-WP-Nonce: <nonce>" | jq '.total, .people[0:3] | {id, first_name, last_name}'
   ```

4. **Test year range filter:**
   ```bash
   curl -s "https://stadion.svawc.nl/wp-json/stadion/v1/people/filtered?birth_year_from=1980&birth_year_to=1990" \
     -H "Cookie: <auth_cookie>" \
     -H "X-WP-Nonce: <nonce>" | jq '.total'
   ```

5. **Verify filter combines with other filters (AND logic):**
   ```bash
   curl -s "https://stadion.svawc.nl/wp-json/stadion/v1/people/filtered?birth_year_from=1985&ownership=mine" \
     -H "Cookie: <auth_cookie>" \
     -H "X-WP-Nonce: <nonce>" | jq '.total'
   ```

6. **Test validation rejects invalid years:**
   ```bash
   curl -s "https://stadion.svawc.nl/wp-json/stadion/v1/people/filtered?birth_year_from=1800" \
     -H "Cookie: <auth_cookie>" \
     -H "X-WP-Nonce: <nonce>" | jq '.code'
   # Should return error code
   ```

Note: If testing without auth cookies, the endpoint should still reject/return empty due to access control.
  </action>
  <verify>
1. Deploy completes without errors
2. Birth year filter returns filtered results (non-zero total for valid years)
3. Combined filters work (AND logic)
4. Invalid year values are rejected
  </verify>
  <done>
Birth year filter deployed and functional. Endpoint filters by birth year using _birthdate meta.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Parameter validation:**
   - Request with `birth_year_from=1800` returns 400 error (outside 1900-2100 range)
   - Request with `birth_year_from=abc` returns 400 error (not integer)

2. **Filter functionality:**
   - Request with valid birth year returns people with matching birth years
   - Empty result when filtering by year with no matching people

3. **Performance:**
   - Query executes in <0.1s (verify with Query Monitor if available)
   - No full table scans (YEAR() uses index on meta_value)

4. **Edge cases:**
   - People without _birthdate are excluded from filtered results
   - Filter combines with labels, ownership, modified_days filters using AND
</verification>

<success_criteria>
1. PHP syntax valid
2. birth_year_from and birth_year_to parameters registered on endpoint
3. Filter uses LEFT JOIN with YEAR() function
4. Production deployment successful
5. Filter returns correct results for test queries
6. Filter performance <0.1s
</success_criteria>

<output>
After completion, create `.planning/phases/112-birthdate-denormalization/112-02-SUMMARY.md`
</output>
