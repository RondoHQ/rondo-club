---
phase: 112-birthdate-denormalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-auto-title.php
  - includes/class-wp-cli.php
autonomous: true

must_haves:
  truths:
    - "Birthday important_date save syncs date to _birthdate meta on related persons"
    - "Birthday important_date delete clears _birthdate meta from related persons"
    - "WP-CLI migration backfills all existing birthdays to _birthdate meta"
    - "Persons with year_unknown birthdays have no _birthdate meta"
  artifacts:
    - path: "includes/class-auto-title.php"
      provides: "Birthdate sync hooks (save_post_important_date, before_delete_post)"
      contains: "sync_birthdate_to_person"
    - path: "includes/class-wp-cli.php"
      provides: "WP-CLI migrate-birthdates command"
      contains: "migrate_birthdates"
  key_links:
    - from: "save_post_important_date hook"
      to: "update_post_meta(_birthdate)"
      via: "sync_birthdate_to_person method"
      pattern: "update_post_meta.*_birthdate"
    - from: "save_post_important_date hook"
      to: "delete_post_meta(_birthdate)"
      via: "sync_birthdate_to_person when year_unknown=true"
      pattern: "year_unknown.*delete_post_meta"
    - from: "before_delete_post hook"
      to: "delete_post_meta(_birthdate)"
      via: "clear_birthdate_on_delete method"
      pattern: "delete_post_meta.*_birthdate"
---

<objective>
Implement birthdate denormalization infrastructure: sync hooks and migration command.

Purpose: Enable fast birth year filtering by storing birthdate directly on person posts instead of querying related important_date posts.

Output:
- AutoTitle class extended with birthdate sync hooks
- WP-CLI `wp stadion migrate-birthdates` command for backfilling existing data
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/112-birthdate-denormalization/112-CONTEXT.md
@.planning/phases/112-birthdate-denormalization/112-RESEARCH.md
@includes/class-auto-title.php
@includes/class-wp-cli.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add birthdate sync hooks to AutoTitle class</name>
  <files>includes/class-auto-title.php</files>
  <action>
Add two new hooks and methods to the AutoTitle class:

1. **In constructor, add hooks (priority 20, after ACF saves fields):**
   ```php
   add_action('save_post_important_date', [$this, 'sync_birthdate_to_person'], 20, 3);
   add_action('before_delete_post', [$this, 'clear_birthdate_on_delete'], 10, 2);
   ```

2. **Add sync_birthdate_to_person method:**
   - Check for DOING_AUTOSAVE and post_status === 'publish'
   - Use wp_get_post_terms() to check if date_type taxonomy includes 'birthday' slug
   - If not birthday type, return early
   - Get date_value via get_field('date_value', $post_id)
   - Get year_unknown via get_field('year_unknown', $post_id)
   - Get related_people via get_field('related_people', $post_id)
   - If related_people is empty, return early
   - If year_unknown is true OR date_value is empty, delete_post_meta() for all related people
   - Otherwise, update_post_meta($person_id, '_birthdate', $date_value) for all related people
   - Date format is YYYY-MM-DD (ACF date_picker native format)

3. **Add clear_birthdate_on_delete method:**
   - Check post_type === 'important_date'
   - Check if date_type taxonomy includes 'birthday' slug
   - Get related_people and delete_post_meta() for each person

Important: Use underscore prefix `_birthdate` to hide from custom fields UI.
Important: Handle multiple related_people (twins/shared birthdays) with foreach loop.
Important: This only clears on permanent delete (before_delete_post), not trash.
  </action>
  <verify>
1. Check syntax: `php -l includes/class-auto-title.php`
2. Verify hooks are registered with correct priorities
3. Verify methods exist and have correct PHPDoc
  </verify>
  <done>
AutoTitle class has sync_birthdate_to_person and clear_birthdate_on_delete methods hooked to save_post_important_date and before_delete_post respectively.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add WP-CLI migrate-birthdates command</name>
  <files>includes/class-wp-cli.php</files>
  <action>
Add a new WP-CLI command `wp stadion migrate-birthdates` to the existing RONDO_Migration_CLI_Command class (class exists at line 291-418 in class-wp-cli.php, currently has `addresses` method):

1. **Add the method to existing RONDO_Migration_CLI_Command class** (after the `addresses` method, around line 418):
   The command will be registered as part of the existing `prm migrate` namespace (see line 2304).

2. **Add migrate_birthdates static method:**
   - Support `--dry-run` flag for preview mode
   - Display banner explaining what migration does
   - Query all birthday important_dates using WP_Query:
     ```php
     $birthdays = new \WP_Query([
         'post_type'        => 'important_date',
         'post_status'      => 'publish',
         'posts_per_page'   => -1,
         'tax_query'        => [[
             'taxonomy' => 'date_type',
             'field'    => 'slug',
             'terms'    => 'birthday',
         ]],
         'suppress_filters' => true, // Bypass access control for migration
     ]);
     ```
   - Loop through results:
     - Get date_value, year_unknown, related_people via get_field()
     - Skip if no related_people (log and count as skipped)
     - If year_unknown or empty date_value: delete_post_meta() and count as cleared
     - Otherwise: update_post_meta() and count as migrated
   - Display person names in log output for visibility
   - Show summary: migrated count, cleared count, skipped count
   - Use WP_CLI::log() for progress, WP_CLI::success() for completion

3. **Use idempotent update_post_meta()** - safe to re-run, overwrites existing values.

4. **Command documentation** with ## OPTIONS, ## EXAMPLES sections following existing patterns in class-wp-cli.php.
  </action>
  <verify>
1. Check syntax: `php -l includes/class-wp-cli.php`
2. Verify command is registered: search for `WP_CLI::add_command('stadion migrate-birthdates'`
3. Check method follows existing WP-CLI patterns in the file
  </verify>
  <done>
WP-CLI command `wp stadion migrate-birthdates` exists with --dry-run support, queries all birthday dates, and updates _birthdate meta on related persons.
  </done>
</task>

<task type="auto">
  <name>Task 3: Deploy and run migration on production</name>
  <files></files>
  <action>
1. **Deploy to production:**
   ```bash
   bin/deploy.sh
   ```

2. **Run migration in dry-run mode first:**
   ```bash
   source .env && ssh -p "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" \
     "cd ~/www/stadion.svawc.nl/public_html/wp-content/themes/stadion && wp stadion migrate-birthdates --dry-run"
   ```

3. **Review dry-run output** - verify it shows expected number of birthdays to migrate

4. **Run actual migration:**
   ```bash
   source .env && ssh -p "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" \
     "cd ~/www/stadion.svawc.nl/public_html/wp-content/themes/stadion && wp stadion migrate-birthdates"
   ```

5. **Verify migration success** - check that _birthdate meta values exist:
   ```bash
   source .env && ssh -p "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" \
     "cd ~/www/stadion.svawc.nl/public_html/wp-content/themes/stadion && wp db query \"SELECT COUNT(*) FROM wp_postmeta WHERE meta_key = '_birthdate'\""
   ```
  </action>
  <verify>
1. Deploy script completes without errors
2. Dry-run shows expected migration plan
3. Actual migration completes successfully
4. Database query confirms _birthdate meta values exist
  </verify>
  <done>
Migration deployed and executed on production. Database contains _birthdate meta values for persons with known birthdays.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Sync hook verification (manual test):**
   - Edit a birthday important_date in WordPress admin
   - Check that related person's _birthdate meta is updated
   - Verify via wp db query or post meta in admin

2. **Migration verification:**
   - Run `wp stadion migrate-birthdates --dry-run` shows 0 changes (already migrated)
   - Database contains expected number of _birthdate meta entries

3. **Edge case verification:**
   - Person with year_unknown birthday should have NO _birthdate meta
   - Person with multiple birthdays (data error) has one _birthdate value (last one saved)
</verification>

<success_criteria>
1. PHP syntax valid for both modified files
2. Birthdate sync hooks registered in AutoTitle constructor
3. WP-CLI migrate-birthdates command registered and functional
4. Production migration completed successfully
5. Database contains _birthdate meta values for persons with known birthdays
</success_criteria>

<output>
After completion, create `.planning/phases/112-birthdate-denormalization/112-01-SUMMARY.md`
</output>
