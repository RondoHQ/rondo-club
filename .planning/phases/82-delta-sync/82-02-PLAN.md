---
phase: 82-delta-sync
plan: 02
type: execute
wave: 2
depends_on: ["82-01"]
files_modified:
  - includes/class-google-contacts-sync.php
  - includes/class-google-contacts-api-import.php
autonomous: true

must_haves:
  truths:
    - "Sync pulls only changed contacts from Google using syncToken"
    - "Sync pushes only changed contacts to Google based on post_modified timestamp"
    - "Expired syncToken falls back to full sync and stores new token"
    - "Deleted contacts in Google are detected and unlinked in Stadion"
  artifacts:
    - path: "includes/class-google-contacts-sync.php"
      provides: "Delta sync logic for bidirectional sync"
      contains: "delta_sync"
    - path: "includes/class-google-contacts-api-import.php"
      provides: "Delta import method using syncToken"
      contains: "import_delta"
  key_links:
    - from: "includes/class-google-contacts-sync.php"
      to: "includes/class-google-contacts-api-import.php"
      via: "calls import_delta()"
      pattern: "import_delta"
    - from: "includes/class-google-contacts-sync.php"
      to: "includes/class-google-contacts-export.php"
      via: "calls export_contact() for changed contacts"
      pattern: "export_contact"
---

<objective>
Implement delta sync logic for bidirectional synchronization.

Purpose: Enables efficient sync that only processes changed contacts rather than full re-import/export every time. Uses Google's syncToken for pull operations and post_modified timestamps for push operations.

Output: Working delta sync that detects changes in both directions and propagates them.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/82-delta-sync/82-RESEARCH.md
@.planning/phases/82-delta-sync/82-01-SUMMARY.md

# Existing classes to extend/use
@includes/class-google-contacts-sync.php
@includes/class-google-contacts-api-import.php
@includes/class-google-contacts-export.php
@includes/class-google-contacts-connection.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add delta import method to GoogleContactsAPI class</name>
  <files>includes/class-google-contacts-api-import.php</files>
  <action>
Add a new `import_delta()` method to the GoogleContactsAPI class that uses syncToken for efficient change detection.

1. **Add new method** `import_delta(): array`:
   ```php
   /**
    * Import only changed contacts from Google using syncToken
    *
    * @return array Import statistics with keys: imported, updated, unlinked, skipped, errors
    * @throws \Exception On API or authentication errors.
    */
   public function import_delta(): array
   ```

2. **Implementation logic**:
   a. Get stored syncToken from connection: `GoogleContactsConnection::get_connection($this->user_id)['sync_token']`

   b. If no syncToken exists, fall back to `import_all()` which will store a new token

   c. Call `fetch_contacts_delta($sync_token)` - new method that:
      - Sets `syncToken` parameter instead of `requestSyncToken`
      - Uses same personFields as full import
      - Handles pagination with nextPageToken

   d. Handle 410 Gone error (expired syncToken):
      - Catch `\Google\Service\Exception` with code 410
      - Clear syncToken: `GoogleContactsConnection::update_connection($this->user_id, ['sync_token' => null])`
      - Fall back to full sync: `return $this->import_all()`

   e. Process each returned contact:
      - Check `$person->getMetadata()->getDeleted()` - if true, unlink contact
      - Otherwise, call existing `process_contact($person)`

   f. Store new syncToken from response: `$response->getNextSyncToken()`

   g. Return stats array with counts

3. **Add helper method** `fetch_contacts_delta(string $sync_token, ?string $page_token = null): object`:
   ```php
   private function fetch_contacts_delta(string $sync_token, ?string $page_token = null): object {
       $service = $this->get_people_service();

       $params = [
           'personFields' => 'names,emailAddresses,phoneNumbers,addresses,organizations,birthdays,photos,urls,metadata',
           'syncToken'    => $sync_token,
           'pageSize'     => 100,
       ];

       if ($page_token) {
           $params['pageToken'] = $page_token;
       }

       return $service->people_connections->listPeopleConnections('people/me', $params);
   }
   ```

4. **Add helper method** `unlink_contact(string $resource_name): void`:
   - Find person post by `_google_contact_id` meta
   - Delete `_google_contact_id`, `_google_etag`, `_google_last_import`, `_google_last_export` meta
   - Preserves all Stadion data, just removes Google link
   - Log the unlink for debugging

5. **Modify `import_all()` method** to request and store syncToken:
   - Add `'requestSyncToken' => true` to fetch_contacts params
   - After pagination completes, get `$response->getNextSyncToken()`
   - Store it: `GoogleContactsConnection::update_connection($this->user_id, ['sync_token' => $sync_token])`

6. **Add stats tracking** for delta operations:
   - Add `'contacts_unlinked' => 0` to stats array
   - Increment when unlinking deleted contacts
  </action>
  <verify>
Run `php -l includes/class-google-contacts-api-import.php` - no syntax errors.
Run `grep -n "import_delta" includes/class-google-contacts-api-import.php` - shows new method.
Run `grep -n "unlink_contact" includes/class-google-contacts-api-import.php` - shows unlink method.
Run `grep -n "requestSyncToken" includes/class-google-contacts-api-import.php` - shows token request.
  </verify>
  <done>
GoogleContactsAPI class has import_delta() method that uses syncToken, handles expired tokens, processes deleted contacts, and stores new syncToken.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement full sync_user method in GoogleContactsSync</name>
  <files>includes/class-google-contacts-sync.php</files>
  <action>
Replace the placeholder `sync_user()` method with full delta sync implementation.

1. **Update sync_user() method**:
   ```php
   /**
    * Sync contacts for a specific user
    *
    * Pulls changes from Google (using syncToken) and pushes local changes.
    *
    * @param int $user_id User ID to sync.
    * @return array Sync results with pull_stats and push_stats.
    */
   private function sync_user(int $user_id): array
   ```

2. **Implementation logic**:
   a. Check if sync is due via `is_sync_due($user_id)` - return early if not

   b. Verify user has Google Contacts connected with readwrite access

   c. **Pull phase** (Google -> Stadion):
      - Create `GoogleContactsAPI` instance
      - Call `import_delta()` to pull changes
      - Store pull stats

   d. **Push phase** (Stadion -> Google):
      - Get contacts modified since last export
      - Call `push_changed_contacts($user_id)` - new method
      - Store push stats

   e. Update connection with sync results:
      ```php
      GoogleContactsConnection::update_connection($user_id, [
          'last_sync'     => current_time('c'),
          'last_error'    => null,
          'contact_count' => $pull_stats['imported'] + $pull_stats['updated'],
      ]);
      ```

   f. Return combined stats

3. **Add push_changed_contacts() method**:
   ```php
   /**
    * Push contacts modified in Stadion since last export to Google
    *
    * @param int $user_id User ID.
    * @return array Stats with pushed count and errors.
    */
   private function push_changed_contacts(int $user_id): array
   ```

   Implementation:
   a. Query person posts where:
      - `post_author = $user_id`
      - `_google_contact_id EXISTS` (linked contacts only)
      - `post_modified > _google_last_export` OR `_google_last_export NOT EXISTS`

   b. For each changed contact:
      - Create `GoogleContactsExport` instance
      - Call `export_contact($post_id)`
      - Track success/failure counts
      - Add 100ms delay between requests (match bulk export pattern)

   c. Return stats array

4. **Add use statements** at top of file:
   ```php
   use Stadion\Import\GoogleContactsAPI;
   use Stadion\Export\GoogleContactsExport;
   ```

5. **Update run_background_sync()** to capture and log sync results:
   - Wrap sync_user() call in try/catch
   - Log success with stats: `error_log(sprintf('STADION_Contacts_Sync: User %d - pulled %d, pushed %d', ...))`
   - On error, update connection with error message
  </action>
  <verify>
Run `php -l includes/class-google-contacts-sync.php` - no syntax errors.
Run `grep -n "push_changed_contacts" includes/class-google-contacts-sync.php` - shows method.
Run `grep -n "import_delta" includes/class-google-contacts-sync.php` - shows call to import class.
Run `grep -n "GoogleContactsAPI\|GoogleContactsExport" includes/class-google-contacts-sync.php` - shows use statements.
  </verify>
  <done>
sync_user() performs bidirectional delta sync: pulls changes from Google using import_delta(), pushes local changes using post_modified comparison.
  </done>
</task>

<task type="auto">
  <name>Task 3: Build, deploy, and verify sync functionality</name>
  <files>dist/</files>
  <action>
Build and deploy, then verify the sync logic works.

1. Run `npm run build` from /Users/joostdevalk/Code/stadion/

2. Deploy using rsync commands:
   ```bash
   rsync -avz --delete -e "ssh -p 18765" /Users/joostdevalk/Code/stadion/dist/ u25-eninwxjgiulh@c1130624.sgvps.net:~/www/cael.is/public_html/wp-content/themes/stadion/dist/
   rsync -avz --exclude='.git' --exclude='node_modules' --exclude='dist' -e "ssh -p 18765" /Users/joostdevalk/Code/stadion/ u25-eninwxjgiulh@c1130624.sgvps.net:~/www/cael.is/public_html/wp-content/themes/stadion/
   ```

3. Clear caches:
   ```bash
   ssh u25-eninwxjgiulh@c1130624.sgvps.net -p 18765 "cd ~/www/cael.is/public_html && wp cache flush && wp sg purge"
   ```

4. Verify no PHP errors on production by checking the home page loads correctly (no 500 errors).
  </action>
  <verify>
Production site loads without errors. PHP files deployed successfully.
  </verify>
  <done>
Delta sync logic deployed to production.
  </done>
</task>

</tasks>

<verification>
- [ ] GoogleContactsAPI has `import_delta()` method using syncToken
- [ ] GoogleContactsAPI has `unlink_contact()` method for deleted contacts
- [ ] GoogleContactsAPI `import_all()` requests and stores syncToken
- [ ] GoogleContactsSync `sync_user()` pulls changes via import_delta()
- [ ] GoogleContactsSync `push_changed_contacts()` pushes modified contacts
- [ ] No PHP syntax errors in modified files
- [ ] Code deployed to production
</verification>

<success_criteria>
- Delta sync uses syncToken for efficient Google -> Stadion sync
- Expired syncToken gracefully falls back to full sync
- Deleted contacts in Google are detected and unlinked in Stadion
- Modified Stadion contacts are pushed to Google
- Push uses post_modified vs _google_last_export comparison
- 100ms delay between push requests to respect rate limits
</success_criteria>

<output>
After completion, create `.planning/phases/82-delta-sync/82-02-SUMMARY.md`
</output>
