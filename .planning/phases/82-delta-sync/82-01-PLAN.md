---
phase: 82-delta-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-google-contacts-sync.php
  - functions.php
autonomous: true

must_haves:
  truths:
    - "Background sync job runs every 15 minutes via WP-Cron"
    - "Users are processed round-robin (one per cron run)"
    - "Sync only runs when due based on user's frequency setting"
  artifacts:
    - path: "includes/class-google-contacts-sync.php"
      provides: "GoogleContactsSync class with cron scheduling"
      min_lines: 150
      contains: "class GoogleContactsSync"
    - path: "functions.php"
      provides: "GoogleContactsSync initialization"
      contains: "GoogleContactsSync"
  key_links:
    - from: "functions.php"
      to: "class-google-contacts-sync.php"
      via: "class instantiation in rondo_init()"
      pattern: "new.*GoogleContactsSync"
---

<objective>
Create the core GoogleContactsSync class with WP-Cron scheduling infrastructure.

Purpose: Establishes the background sync framework following the proven calendar sync pattern. This provides the scheduling backbone that delta sync logic (Plan 02) will plug into.

Output: A working cron job that processes users round-robin, checks frequency settings, and has placeholder sync method ready for delta logic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/82-delta-sync/82-RESEARCH.md

# Existing pattern to follow
@includes/class-calendar-sync.php
@includes/class-google-contacts-connection.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GoogleContactsSync class with cron infrastructure</name>
  <files>includes/class-google-contacts-sync.php</files>
  <action>
Create a new `GoogleContactsSync` class in the `Stadion\Contacts` namespace following the `Stadion\Calendar\Sync` pattern exactly.

Key implementation details:
1. **Constants** (match calendar sync naming pattern):
   - `CRON_HOOK = 'stadion_google_contacts_sync'`
   - `CRON_SCHEDULE = 'every_15_minutes'`
   - `USER_INDEX_TRANSIENT = 'stadion_contacts_sync_last_user_index'`

2. **Constructor hooks**:
   - `add_filter('cron_schedules', ...)` - Register 15-min schedule if not already registered (calendar sync may have added it)
   - `add_action(self::CRON_HOOK, ...)` - Register cron callback
   - `add_action('after_switch_theme', ...)` - Schedule on theme activation
   - `add_action('switch_theme', ...)` - Unschedule on theme deactivation

3. **Cron schedule method** `add_cron_schedules($schedules)`:
   - Check if 'every_15_minutes' already exists before adding
   - Return schedules unchanged if already present
   - This prevents conflict with calendar sync registration

4. **Schedule/unschedule methods**:
   - `schedule_sync()` - Schedule if not already scheduled
   - `unschedule_sync()` - Unschedule cron event

5. **Round-robin user processing** `run_background_sync()`:
   - Get users with Google Contacts connections via `get_users_with_connections()`
   - Get last processed user index from transient
   - Calculate next index with modulo
   - Update transient for next run
   - Call `sync_user($user_id)` for selected user

6. **Get users with connections** `get_users_with_connections()`:
   - Query users with `_stadion_google_contacts_connection` meta key
   - Filter to users who have credentials (actually connected)
   - Return array of user IDs

7. **Frequency check** `is_sync_due($user_id)`:
   - Get connection via `GoogleContactsConnection::get_connection($user_id)`
   - Check `last_sync` timestamp against `sync_frequency` setting
   - Default frequency: 60 minutes (hourly)
   - Return true if enough time has passed or no last_sync

8. **Placeholder sync method** `sync_user($user_id)`:
   - Check if sync is due first
   - For now, just log that sync would happen
   - Update `last_sync` timestamp via `GoogleContactsConnection::update_connection()`
   - Will be replaced with real delta sync logic in Plan 02

9. **Static status method** `get_sync_status()`:
   - Return array with: next_scheduled, is_scheduled, total_users_with_connections, current_user_index, cron_schedule

Include proper docblocks and follow existing code style.
  </action>
  <verify>
Run `php -l includes/class-google-contacts-sync.php` - no syntax errors.
Grep for class definition: `grep -n "class GoogleContactsSync" includes/class-google-contacts-sync.php`
  </verify>
  <done>
GoogleContactsSync class exists with all methods: constructor, add_cron_schedules, schedule_sync, unschedule_sync, run_background_sync, get_users_with_connections, is_sync_due, sync_user, get_sync_status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register GoogleContactsSync in functions.php</name>
  <files>functions.php</files>
  <action>
Add the GoogleContactsSync class to the theme initialization.

1. **Add require statement** in the file loading section (around line 30-50, where other includes are):
   ```php
   require_once get_template_directory() . '/includes/class-google-contacts-sync.php';
   ```

2. **Instantiate in rondo_init()** function (where other classes are instantiated):
   ```php
   new \Stadion\Contacts\GoogleContactsSync();
   ```

Place it near the other Google Contacts classes for logical grouping.
  </action>
  <verify>
Run `grep -n "class-google-contacts-sync" functions.php` - shows require line.
Run `grep -n "GoogleContactsSync" functions.php` - shows instantiation.
Run `php -l functions.php` - no syntax errors.
  </verify>
  <done>
functions.php includes and instantiates GoogleContactsSync class.
  </done>
</task>

<task type="auto">
  <name>Task 3: Build, deploy, and verify cron registration</name>
  <files>dist/</files>
  <action>
Build frontend assets and deploy to production.

1. Run `npm run build` from /Users/joostdevalk/Code/stadion/
2. Deploy using the rsync commands from AGENTS.md (without node_modules since we didn't change packages):
   ```bash
   rsync -avz --delete -e "ssh -p 18765" /Users/joostdevalk/Code/stadion/dist/ u25-eninwxjgiulh@c1130624.sgvps.net:~/www/cael.is/public_html/wp-content/themes/stadion/dist/
   rsync -avz --exclude='.git' --exclude='node_modules' --exclude='dist' -e "ssh -p 18765" /Users/joostdevalk/Code/stadion/ u25-eninwxjgiulh@c1130624.sgvps.net:~/www/cael.is/public_html/wp-content/themes/stadion/
   ```
3. Clear caches:
   ```bash
   ssh u25-eninwxjgiulh@c1130624.sgvps.net -p 18765 "cd ~/www/cael.is/public_html && wp cache flush && wp sg purge"
   ```
4. Verify cron is registered:
   ```bash
   ssh u25-eninwxjgiulh@c1130624.sgvps.net -p 18765 "cd ~/www/cael.is/public_html && wp cron event list | grep google_contacts_sync"
   ```
  </action>
  <verify>
The cron event `stadion_google_contacts_sync` appears in the WP-CLI cron event list output.
If not scheduled yet (theme not reactivated), that's expected - it will be scheduled on next theme activation or can be manually scheduled.
  </verify>
  <done>
Code deployed to production, PHP files loaded without errors, cron event is either scheduled or can be scheduled.
  </done>
</task>

</tasks>

<verification>
- [ ] `class-google-contacts-sync.php` exists with GoogleContactsSync class
- [ ] Class has all required methods: constructor, add_cron_schedules, schedule_sync, unschedule_sync, run_background_sync, get_users_with_connections, is_sync_due, sync_user, get_sync_status
- [ ] `functions.php` requires and instantiates GoogleContactsSync
- [ ] No PHP syntax errors in either file
- [ ] Code deployed to production
</verification>

<success_criteria>
- GoogleContactsSync class implements the cron scheduling infrastructure
- Round-robin user processing is in place
- Frequency checking works based on connection settings
- Code follows existing calendar sync patterns exactly
- Production deployment successful
</success_criteria>

<output>
After completion, create `.planning/phases/82-delta-sync/82-01-SUMMARY.md`
</output>
