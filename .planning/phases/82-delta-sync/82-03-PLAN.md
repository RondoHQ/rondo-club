---
phase: 82-delta-sync
plan: 03
type: execute
wave: 2
depends_on: ["82-01"]
files_modified:
  - includes/class-rest-api.php
  - includes/class-google-contacts-connection.php
  - src/pages/Settings.jsx
  - src/api/client.js
autonomous: true

must_haves:
  truths:
    - "User can trigger manual sync from Settings > Connections"
    - "User can select sync frequency (15min, hourly, 6hr, daily)"
    - "Settings shows last sync time and contact count"
  artifacts:
    - path: "includes/class-rest-api.php"
      provides: "REST endpoint for manual sync and frequency update"
      contains: "google-contacts/sync"
    - path: "src/pages/Settings.jsx"
      provides: "Sync frequency dropdown and Sync Now button"
      contains: "syncFrequency"
  key_links:
    - from: "src/pages/Settings.jsx"
      to: "/prm/v1/google-contacts/sync"
      via: "fetch call on Sync Now button click"
      pattern: "google-contacts/sync"
---

<objective>
Add REST endpoint for manual sync trigger and Settings UI for sync frequency configuration.

Purpose: Gives users control over sync timing - they can trigger immediate sync and choose how often background sync runs.

Output: Working "Sync Now" button in Settings and frequency dropdown that persists user preference.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/82-delta-sync/82-RESEARCH.md
@.planning/phases/82-delta-sync/82-01-SUMMARY.md

# Files to modify
@includes/class-rest-api.php
@includes/class-google-contacts-connection.php
@src/pages/Settings.jsx
@src/api/client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sync_frequency field to GoogleContactsConnection</name>
  <files>includes/class-google-contacts-connection.php</files>
  <action>
Update the connection data structure documentation and add a helper method for frequency.

1. **Update class docblock** to include sync_frequency in the connection data structure:
   ```php
   * - sync_frequency: int - Sync frequency in minutes (15, 60, 360, 1440)
   ```

2. **Add static method** `get_default_frequency()`:
   ```php
   /**
    * Get the default sync frequency in minutes
    *
    * @return int Default frequency (60 = hourly)
    */
   public static function get_default_frequency(): int {
       return 60;
   }
   ```

3. **Add static method** `get_frequency_options()`:
   ```php
   /**
    * Get available sync frequency options
    *
    * @return array Associative array of minutes => label
    */
   public static function get_frequency_options(): array {
       return [
           15   => __('Every 15 minutes', 'caelis'),
           60   => __('Every hour', 'caelis'),
           360  => __('Every 6 hours', 'caelis'),
           1440 => __('Daily', 'caelis'),
       ];
   }
   ```

4. **Add static method** `get_sync_frequency(int $user_id)`:
   ```php
   /**
    * Get sync frequency for a user
    *
    * @param int $user_id WordPress user ID.
    * @return int Frequency in minutes.
    */
   public static function get_sync_frequency(int $user_id): int {
       $connection = self::get_connection($user_id);
       if (!$connection || !isset($connection['sync_frequency'])) {
           return self::get_default_frequency();
       }
       return (int) $connection['sync_frequency'];
   }
   ```
  </action>
  <verify>
Run `php -l includes/class-google-contacts-connection.php` - no syntax errors.
Run `grep -n "sync_frequency" includes/class-google-contacts-connection.php` - shows new methods and docblock.
  </verify>
  <done>
GoogleContactsConnection has sync_frequency field documented and helper methods for frequency options and defaults.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add REST endpoints for sync trigger and frequency update</name>
  <files>includes/class-rest-api.php</files>
  <action>
Add two new REST endpoints in PRM_REST_API class.

1. **Register routes** in `register_routes()` method:
   ```php
   // Google Contacts sync trigger
   register_rest_route(
       $this->namespace,
       '/google-contacts/sync',
       [
           'methods'             => 'POST',
           'callback'            => [ $this, 'trigger_contacts_sync' ],
           'permission_callback' => [ $this, 'check_logged_in' ],
       ]
   );

   // Google Contacts sync frequency update
   register_rest_route(
       $this->namespace,
       '/google-contacts/sync-frequency',
       [
           'methods'             => 'POST',
           'callback'            => [ $this, 'update_contacts_sync_frequency' ],
           'permission_callback' => [ $this, 'check_logged_in' ],
           'args'                => [
               'frequency' => [
                   'required'          => true,
                   'type'              => 'integer',
                   'sanitize_callback' => 'absint',
                   'validate_callback' => function($value) {
                       $valid = array_keys(\Caelis\Contacts\GoogleContactsConnection::get_frequency_options());
                       return in_array((int) $value, $valid, true);
                   },
               ],
           ],
       ]
   );
   ```

2. **Add callback method** `trigger_contacts_sync()`:
   ```php
   /**
    * Trigger manual Google Contacts sync for current user
    *
    * @param \WP_REST_Request $request Request object.
    * @return \WP_REST_Response|\WP_Error Response or error.
    */
   public function trigger_contacts_sync(\WP_REST_Request $request) {
       $user_id = get_current_user_id();

       // Check if user has Google Contacts connected
       $connection = \Caelis\Contacts\GoogleContactsConnection::get_connection($user_id);
       if (!$connection || empty($connection['credentials'])) {
           return new \WP_Error(
               'not_connected',
               __('Google Contacts is not connected.', 'caelis'),
               ['status' => 400]
           );
       }

       try {
           // Run delta sync
           $sync = new \Caelis\Contacts\GoogleContactsSync();
           $result = $sync->sync_user_manual($user_id);

           return rest_ensure_response([
               'success' => true,
               'stats'   => $result,
               'message' => __('Sync completed successfully.', 'caelis'),
           ]);
       } catch (\Exception $e) {
           return new \WP_Error(
               'sync_failed',
               $e->getMessage(),
               ['status' => 500]
           );
       }
   }
   ```

3. **Add callback method** `update_contacts_sync_frequency()`:
   ```php
   /**
    * Update Google Contacts sync frequency for current user
    *
    * @param \WP_REST_Request $request Request object.
    * @return \WP_REST_Response|\WP_Error Response or error.
    */
   public function update_contacts_sync_frequency(\WP_REST_Request $request) {
       $user_id   = get_current_user_id();
       $frequency = $request->get_param('frequency');

       // Check if user has Google Contacts connected
       $connection = \Caelis\Contacts\GoogleContactsConnection::get_connection($user_id);
       if (!$connection) {
           return new \WP_Error(
               'not_connected',
               __('Google Contacts is not connected.', 'caelis'),
               ['status' => 400]
           );
       }

       // Update frequency
       \Caelis\Contacts\GoogleContactsConnection::update_connection($user_id, [
           'sync_frequency' => $frequency,
       ]);

       $options = \Caelis\Contacts\GoogleContactsConnection::get_frequency_options();

       return rest_ensure_response([
           'success'   => true,
           'frequency' => $frequency,
           'label'     => $options[$frequency] ?? '',
       ]);
   }
   ```

4. **Add `sync_user_manual()` method to GoogleContactsSync** in `includes/class-google-contacts-sync.php`:
   This is a public method that bypasses the is_sync_due() check for manual triggers.
   ```php
   /**
    * Manually sync a user's contacts (bypasses frequency check)
    *
    * @param int $user_id User ID to sync.
    * @return array Sync results.
    * @throws \Exception On sync failure.
    */
   public function sync_user_manual(int $user_id): array {
       // Same as sync_user but without is_sync_due check
       // Pull changes from Google
       $importer = new \Caelis\Import\GoogleContactsAPI($user_id);
       $pull_stats = $importer->import_delta();

       // Push changes to Google
       $push_stats = $this->push_changed_contacts($user_id);

       // Update last sync
       \Caelis\Contacts\GoogleContactsConnection::update_connection($user_id, [
           'last_sync'  => current_time('c'),
           'last_error' => null,
       ]);

       return [
           'pull' => $pull_stats,
           'push' => $push_stats,
       ];
   }
   ```
  </action>
  <verify>
Run `php -l includes/class-rest-api.php` - no syntax errors.
Run `grep -n "google-contacts/sync" includes/class-rest-api.php` - shows route registration.
Run `grep -n "trigger_contacts_sync\|update_contacts_sync_frequency" includes/class-rest-api.php` - shows callback methods.
Run `grep -n "sync_user_manual" includes/class-google-contacts-sync.php` - shows manual sync method.
  </verify>
  <done>
REST API has endpoints for /google-contacts/sync (POST) and /google-contacts/sync-frequency (POST). GoogleContactsSync has sync_user_manual() method.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Settings UI with sync controls</name>
  <files>src/pages/Settings.jsx, src/api/client.js</files>
  <action>
Add sync frequency dropdown and "Sync Now" button to the Google Contacts section in Settings.

1. **Add API functions to client.js**:
   ```javascript
   // Google Contacts sync
   export const triggerContactsSync = () =>
     api.post('/prm/v1/google-contacts/sync');

   export const updateContactsSyncFrequency = (frequency) =>
     api.post('/prm/v1/google-contacts/sync-frequency', { frequency });
   ```

2. **Update Settings.jsx** in the Google Contacts connection section (find the existing contacts connection display):

   a. Add state for sync operations:
   ```javascript
   const [isSyncing, setIsSyncing] = useState(false);
   const [syncError, setSyncError] = useState(null);
   const [syncSuccess, setSyncSuccess] = useState(null);
   ```

   b. Add frequency options constant:
   ```javascript
   const syncFrequencyOptions = [
     { value: 15, label: 'Every 15 minutes' },
     { value: 60, label: 'Every hour' },
     { value: 360, label: 'Every 6 hours' },
     { value: 1440, label: 'Daily' },
   ];
   ```

   c. Add sync handler function:
   ```javascript
   const handleContactsSync = async () => {
     setIsSyncing(true);
     setSyncError(null);
     setSyncSuccess(null);
     try {
       const response = await triggerContactsSync();
       setSyncSuccess(`Sync completed: ${response.data.stats?.pull?.contacts_imported || 0} imported, ${response.data.stats?.push?.pushed || 0} pushed`);
       // Invalidate contacts status query to refresh last_sync display
       queryClient.invalidateQueries(['contacts-status']);
     } catch (error) {
       setSyncError(error.response?.data?.message || 'Sync failed');
     } finally {
       setIsSyncing(false);
     }
   };
   ```

   d. Add frequency change handler:
   ```javascript
   const handleFrequencyChange = async (e) => {
     const frequency = parseInt(e.target.value, 10);
     try {
       await updateContactsSyncFrequency(frequency);
       queryClient.invalidateQueries(['contacts-status']);
     } catch (error) {
       console.error('Failed to update sync frequency:', error);
     }
   };
   ```

   e. In the contacts connection JSX, AFTER the existing connection status display, add:
   ```jsx
   {/* Show sync controls when connected */}
   {contactsStatus?.connected && (
     <div className="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
       <div className="flex items-center justify-between mb-3">
         <div>
           <h4 className="text-sm font-medium text-gray-900 dark:text-gray-100">Background Sync</h4>
           {contactsStatus.last_sync && (
             <p className="text-xs text-gray-500 dark:text-gray-400">
               Last sync: {new Date(contactsStatus.last_sync).toLocaleString()}
             </p>
           )}
         </div>
         <button
           onClick={handleContactsSync}
           disabled={isSyncing}
           className="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
         >
           {isSyncing ? 'Syncing...' : 'Sync Now'}
         </button>
       </div>

       {syncError && (
         <p className="text-sm text-red-600 dark:text-red-400 mb-3">{syncError}</p>
       )}
       {syncSuccess && (
         <p className="text-sm text-green-600 dark:text-green-400 mb-3">{syncSuccess}</p>
       )}

       <div className="flex items-center gap-3">
         <label htmlFor="sync-frequency" className="text-sm text-gray-700 dark:text-gray-300">
           Sync frequency:
         </label>
         <select
           id="sync-frequency"
           value={contactsStatus.sync_frequency || 60}
           onChange={handleFrequencyChange}
           className="text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-md"
         >
           {syncFrequencyOptions.map((option) => (
             <option key={option.value} value={option.value}>
               {option.label}
             </option>
           ))}
         </select>
       </div>
     </div>
   )}
   ```

3. **Update contacts status endpoint** to return sync_frequency and last_sync (if not already returned):
   Check if `/prm/v1/google-contacts/status` endpoint returns these fields. If not, update it in class-rest-api.php to include:
   ```php
   'sync_frequency' => $connection['sync_frequency'] ?? 60,
   'last_sync'      => $connection['last_sync'] ?? null,
   'last_error'     => $connection['last_error'] ?? null,
   ```
  </action>
  <verify>
Run `npm run lint` - no ESLint errors.
Run `grep -n "triggerContactsSync\|updateContactsSyncFrequency" src/api/client.js` - shows API functions.
Run `grep -n "Sync Now\|sync-frequency" src/pages/Settings.jsx` - shows UI elements.
  </verify>
  <done>
Settings page has "Sync Now" button and sync frequency dropdown that work with REST API.
  </done>
</task>

<task type="auto">
  <name>Task 4: Build, deploy, and verify</name>
  <files>dist/</files>
  <action>
Build and deploy all changes.

1. Run `npm run build` from /Users/joostdevalk/Code/caelis/

2. Deploy using rsync commands:
   ```bash
   rsync -avz --delete -e "ssh -p 18765" /Users/joostdevalk/Code/caelis/dist/ u25-eninwxjgiulh@c1130624.sgvps.net:~/www/cael.is/public_html/wp-content/themes/caelis/dist/
   rsync -avz --exclude='.git' --exclude='node_modules' --exclude='dist' -e "ssh -p 18765" /Users/joostdevalk/Code/caelis/ u25-eninwxjgiulh@c1130624.sgvps.net:~/www/cael.is/public_html/wp-content/themes/caelis/
   ```

3. Clear caches:
   ```bash
   ssh u25-eninwxjgiulh@c1130624.sgvps.net -p 18765 "cd ~/www/cael.is/public_html && wp cache flush && wp sg purge"
   ```

4. Visit https://cael.is/settings and navigate to Connections tab to verify:
   - Google Contacts section shows sync controls when connected
   - "Sync Now" button is visible
   - Frequency dropdown is visible with correct options
  </action>
  <verify>
Production site loads Settings page with sync controls visible in Google Contacts section.
  </verify>
  <done>
Sync controls deployed and visible in Settings UI.
  </done>
</task>

</tasks>

<verification>
- [ ] GoogleContactsConnection has sync_frequency helpers
- [ ] REST API has /google-contacts/sync endpoint
- [ ] REST API has /google-contacts/sync-frequency endpoint
- [ ] Settings.jsx has "Sync Now" button
- [ ] Settings.jsx has frequency dropdown
- [ ] client.js has triggerContactsSync and updateContactsSyncFrequency functions
- [ ] No PHP or JS errors
- [ ] Code deployed to production
</verification>

<success_criteria>
- "Sync Now" button triggers immediate delta sync
- Frequency dropdown updates user preference
- Last sync time displays in Settings
- Sync errors are shown to user
- UI matches existing Settings design patterns
</success_criteria>

<output>
After completion, create `.planning/phases/82-delta-sync/82-03-SUMMARY.md`
</output>
