---
phase: 52-settings-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/Settings/Settings.jsx
  - src/api/client.js
autonomous: true
---

<objective>
Build the calendar connections settings UI as a new "Calendars" tab in the Settings page.

Purpose: Enable users to connect their Google Calendar or CalDAV accounts (iCloud, Fastmail, Nextcloud) and manage sync settings.
Output: Working calendar connections UI with add/edit/delete/sync functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-google-oauth/48-01-SUMMARY.md
@.planning/phases/50-caldav-provider/50-01-SUMMARY.md

# Key backend files:
@includes/class-rest-calendar.php
@includes/class-calendar-connections.php

# Settings page structure to extend:
@src/pages/Settings/Settings.jsx
@src/api/client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add calendar API functions to client.js</name>
  <files>src/api/client.js</files>
  <action>
Add calendar API helper functions to prmApi object:
- `getCalendarConnections: () => api.get('/prm/v1/calendar/connections')`
- `createCalendarConnection: (data) => api.post('/prm/v1/calendar/connections', data)`
- `updateCalendarConnection: (id, data) => api.put(\`/prm/v1/calendar/connections/\${id}\`, data)`
- `deleteCalendarConnection: (id) => api.delete(\`/prm/v1/calendar/connections/\${id}\`)`
- `triggerCalendarSync: (id) => api.post(\`/prm/v1/calendar/connections/\${id}/sync\`)`
- `getGoogleAuthUrl: () => api.get('/prm/v1/calendar/auth/google')`
- `testCalDAVConnection: (credentials) => api.post('/prm/v1/calendar/auth/caldav/test', credentials)`

Add these in the prmApi object near the existing API functions, maintaining alphabetical grouping.
  </action>
  <verify>Grep for `getCalendarConnections` in src/api/client.js shows the new functions</verify>
  <done>All 7 calendar API functions added to prmApi object</done>
</task>

<task type="auto">
  <name>Task 2: Add Calendars tab to Settings page</name>
  <files>src/pages/Settings/Settings.jsx</files>
  <action>
1. Add Calendar icon import from lucide-react (already imported icons at top of file)
2. Add new tab to TABS array: `{ id: 'calendars', label: 'Calendars', icon: Calendar }`
3. Add case in renderTabContent switch: `case 'calendars': return <CalendarsTab />;`
4. Create CalendarsTab component with:
   - State: connections (array), loading (bool), syncing (map of connection_id -> bool), error (string), showAddModal (string|null: 'google'|'caldav')
   - useEffect to fetch connections on mount via prmApi.getCalendarConnections()
   - Handle OAuth callback params from URL: ?connected=google or ?error=...
   - Show success/error toast when redirected back from OAuth
   - Connection list display with:
     * Provider icon (Google or CalDAV)
     * Connection name
     * Last sync time (or "Never synced")
     * Sync status (last_error shown as red badge if present)
     * "Sync Now" button (calls triggerCalendarSync, shows spinner while syncing)
     * Edit button (opens modal for that connection type)
     * Delete button (confirms, then calls deleteCalendarConnection)
   - "Add Connection" section with two buttons:
     * "Connect Google Calendar" - calls getGoogleAuthUrl() and redirects to auth_url
     * "Add CalDAV Calendar" - opens CalDAV modal form
5. Create CalDAVModal component (inline in same file) with:
   - Form fields: Name, Server URL, Username, Password, Calendar dropdown (populated after test)
   - "Test Connection" button that calls testCalDAVConnection() and populates calendar dropdown
   - Save button that calls createCalendarConnection() with provider='caldav'
   - Cancel button to close modal

Style using existing card/input/btn-primary/btn-secondary classes from the codebase.
Use dark mode classes (dark:bg-gray-800, dark:text-gray-100, etc.) consistently with other tabs.
Format dates using date-fns format function for last_sync display.
  </action>
  <verify>npm run build succeeds without errors</verify>
  <done>Calendars tab visible in Settings, can list connections, connect Google, add CalDAV, sync, edit, delete</done>
</task>

<task type="auto">
  <name>Task 3: Add edit connection functionality</name>
  <files>src/pages/Settings/Settings.jsx</files>
  <action>
1. Add EditConnectionModal component with:
   - Props: connection (object), onSave (function), onClose (function)
   - Form fields based on provider:
     * Common: Name, Sync Enabled (toggle), Auto-log meetings (toggle), Sync from (days dropdown: 30/60/90/180)
     * CalDAV only: Can update Server URL, Username, Password (with "Test" button)
     * Google: Cannot change credentials (must disconnect and reconnect)
   - Save button calls updateCalendarConnection() with changed fields
   - Cancel button closes modal
2. Wire Edit button in connection list to open EditConnectionModal with selected connection
3. After save, refresh connections list

Use existing toggle switch pattern from NotificationsTab (the peer-checked Tailwind toggle).
  </action>
  <verify>npm run build succeeds; can click Edit on a connection and modal opens</verify>
  <done>Edit modal works for both Google and CalDAV connections, saves changes correctly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes (max-warnings: 0)
- [ ] Calendars tab appears in Settings
- [ ] Can connect Google Calendar (redirects to Google OAuth)
- [ ] Can add CalDAV connection (test shows calendars, save creates connection)
- [ ] Connections list shows all connections with correct provider icon
- [ ] Sync Now button triggers sync and shows result
- [ ] Edit button opens modal with current values
- [ ] Delete button removes connection after confirmation
- [ ] Dark mode styling is correct
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Calendar connections UI is fully functional
- Both Google and CalDAV providers work end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/52-settings-ui/52-01-SUMMARY.md`
</output>
