---
phase: 54-background-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-calendar-sync.php
  - functions.php
autonomous: true
---

<objective>
Implement WP-Cron background sync for calendar events with rate limiting and auto-logging of past meetings as activities.

Purpose: Enable hands-off calendar synchronization so users don't need to manually trigger syncs, with automatic activity creation for past meetings with matched contacts.
Output: Working background sync system with 15-minute interval, user-based rate limiting, and auto-logging
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Prior phase context:
@.planning/phases/49-google-calendar-provider/49-01-SUMMARY.md
@.planning/phases/50-caldav-provider/50-01-SUMMARY.md
@.planning/phases/51-contact-matching/51-01-SUMMARY.md
@.planning/phases/53-person-meetings-section/53-01-SUMMARY.md

Source files:
@includes/class-reminders.php (WP-Cron pattern reference)
@includes/class-google-calendar-provider.php
@includes/class-caldav-provider.php
@includes/class-rest-calendar.php (log_event_as_activity endpoint)
@Calendar-Integration-Implementation-Plan.md (Section 7: Background Sync)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PRM_Calendar_Sync class with WP-Cron scheduling</name>
  <files>includes/class-calendar-sync.php, functions.php</files>
  <action>
Create new PRM_Calendar_Sync class that:

1. Registers custom cron schedule 'every_15_minutes' via cron_schedules filter (interval: 900)

2. Schedules 'prm_calendar_sync' cron event on theme activation if not already scheduled:
   - Check wp_next_scheduled('prm_calendar_sync')
   - If not scheduled, wp_schedule_event(time(), 'every_15_minutes', 'prm_calendar_sync')

3. Implements run_background_sync() callback that:
   - Gets all users with _prm_calendar_connections meta (meta_compare EXISTS)
   - Rate limits to 1 user per cron run using a transient lock
   - For selected user, iterates their connections where sync_enabled = true
   - Calls appropriate provider sync() method (PRM_Google_Calendar_Provider or PRM_CalDAV_Provider)
   - Updates last_sync and last_error on connection after sync
   - Logs errors but doesn't fail entire run
   - Uses set_transient('prm_calendar_sync_last_user_index', $index, HOUR_IN_SECONDS) to rotate users

4. Rate limiting strategy:
   - Process one user per 15-minute cron tick to spread load
   - Track last processed user index in transient
   - Round-robin through all users with connections
   - This means all users get synced within (num_users * 15) minutes

5. Unschedule cron on theme deactivation via switch_theme hook

Add class to functions.php autoloader and instantiate in prm_init().
  </action>
  <verify>
- Check cron schedule exists: wp cron event list | grep prm_calendar_sync
- Verify class loads without fatal errors
  </verify>
  <done>
- PRM_Calendar_Sync class created with WP-Cron scheduling
- 15-minute sync interval registered
- Rate limiting via user round-robin implemented
- Cron schedules/unschedules on theme activation/deactivation
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement auto-logging of past meetings</name>
  <files>includes/class-calendar-sync.php</files>
  <action>
Add auto_log_past_meetings() method to PRM_Calendar_Sync class that:

1. Queries for calendar events where:
   - _end_time < current_time() (past events)
   - logged_as_activity meta is NOT set or empty
   - _matched_people meta is NOT empty
   - Connection has auto_log = true
   - Limited to 10 events per run (spread load)

2. For each qualifying event:
   - Decode _matched_people JSON
   - Skip if no matches (confidence > 50% filter)
   - Call existing log_event_as_activity() REST endpoint logic
   - Actually reuse the logic from PRM_REST_Calendar::log_event_as_activity()
   - Extract method from REST class to PRM_Calendar_Sync::create_activity_from_event()
   - Mark event with logged_as_activity = 1 after success

3. Activity creation (extracted from existing endpoint):
   - Create wp_insert_comment() with:
     - comment_type = 'activity'
     - comment_post_ID = matched person_id
     - comment_author = current user display_name
     - comment_content = "Meeting: {event_title}"
     - comment_date = event start_time
   - Set comment meta:
     - activity_type = 'meeting'
     - calendar_event_id = event post ID
     - duration_minutes = calculated from start/end
     - location = _location meta
     - meeting_url = _meeting_url meta

4. Call auto_log_past_meetings() at end of run_background_sync() after sync completes

Note: The existing log_event_as_activity endpoint in class-rest-calendar.php already does this. Extract the core logic to a static method that both the REST endpoint and auto-logger can call.
  </action>
  <verify>
- Manual test: Create a past event with matched people, run sync, verify activity created
- Verify logged_as_activity meta is set after logging
- Verify auto_log = false connections don't create activities
  </verify>
  <done>
- Auto-logging creates activities for past meetings with matched contacts
- Respects auto_log connection setting
- Prevents duplicate logging via logged_as_activity flag
- Rate limited to 10 events per sync run
  </done>
</task>

<task type="auto">
  <name>Task 3: Add manual sync status endpoint and sync-all CLI command</name>
  <files>includes/class-calendar-sync.php</files>
  <action>
Add utility methods to PRM_Calendar_Sync:

1. get_sync_status() static method returning:
   - next_scheduled: wp_next_scheduled('prm_calendar_sync')
   - total_users_with_connections: count of users with meta
   - current_user_index: from transient
   - estimated_full_cycle: total_users * 15 minutes

2. WP-CLI command (if WP_CLI defined):
   - Register 'wp prm calendar sync' command
   - Options: --user=ID (sync specific user), --all (sync all immediately)
   - Useful for testing and manual catch-up
   - Calls run_background_sync() directly

3. Force sync method for testing:
   - force_sync_all() - ignores rate limiting, syncs all users immediately
   - Only callable via CLI or direct PHP (not REST)
  </action>
  <verify>
- wp prm calendar sync --help shows command
- wp prm calendar sync --all runs full sync
- Verify sync completes without errors
  </verify>
  <done>
- Sync status method available for debugging
- WP-CLI command for manual sync operations
- Testing and maintenance utilities available
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] WP-Cron 'prm_calendar_sync' event is scheduled (wp cron event list)
- [ ] 15-minute interval registered in cron_schedules
- [ ] Background sync processes connections for enabled users
- [ ] Auto-logging creates activities for past meetings
- [ ] Duplicate activities prevented via logged_as_activity flag
- [ ] WP-CLI command works: wp prm calendar sync
- [ ] No PHP errors in debug.log during sync
</verification>

<success_criteria>
- Background sync runs automatically every 15 minutes
- User connections are synced in round-robin fashion
- Past meetings with matched contacts are auto-logged as activities
- Rate limiting prevents API quota issues
- CLI available for manual sync operations
</success_criteria>

<output>
After completion, create `.planning/phases/54-background-sync/54-01-SUMMARY.md`
</output>
