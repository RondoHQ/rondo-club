---
phase: 79-oauth-foundation
plan: 02
type: execute
wave: 2
depends_on: ["79-01"]
files_modified:
  - src/pages/Settings/Settings.jsx
  - src/api/client.js
autonomous: false

must_haves:
  truths:
    - "User can see Google Contacts connection status in Settings > Connections > Contacts"
    - "User can initiate Google Contacts OAuth by clicking Connect button"
    - "User sees connected state after successful OAuth (email, status)"
    - "User can disconnect Google Contacts"
    - "User sees helpful error message if OAuth fails"
  artifacts:
    - path: "src/pages/Settings/Settings.jsx"
      provides: "Google Contacts connection card in Settings"
      contains: "google-contacts"
    - path: "src/api/client.js"
      provides: "API methods for Google Contacts OAuth"
      contains: "getGoogleContactsStatus"
  key_links:
    - from: "src/pages/Settings/Settings.jsx"
      to: "/prm/v1/google-contacts/status"
      via: "prmApi.getGoogleContactsStatus()"
      pattern: "getGoogleContactsStatus"
    - from: "src/pages/Settings/Settings.jsx"
      to: "/prm/v1/google-contacts/auth"
      via: "prmApi.initiateGoogleContactsAuth()"
      pattern: "initiateGoogleContactsAuth"
---

<objective>
Implement frontend UI for Google Contacts connection in Settings.

Purpose: Allow users to connect and disconnect Google Contacts through the Settings > Connections interface. This completes the OAuth Foundation phase by providing user-facing controls for the backend infrastructure built in Plan 01.

Output: New "Contacts" subtab in Settings with Google Contacts connection card showing status, connect/disconnect buttons, and OAuth flow integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/79-oauth-foundation/79-CONTEXT.md
@.planning/phases/79-oauth-foundation/79-01-SUMMARY.md

# Existing Settings and API patterns
@src/pages/Settings/Settings.jsx
@src/api/client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Google Contacts API methods to client.js</name>
  <files>src/api/client.js</files>
  <action>
Add new API methods to the prmApi object for Google Contacts OAuth:

1. `getGoogleContactsStatus: () => apiClient.get('/prm/v1/google-contacts/status')`
   - Returns: {connected, access_mode, email, last_sync, contact_count, last_error, has_pending_import, google_configured}

2. `initiateGoogleContactsAuth: (readonly = true) => apiClient.get('/prm/v1/google-contacts/auth', { params: { readonly } })`
   - Returns: {auth_url} - Frontend will redirect to this URL

3. `disconnectGoogleContacts: () => apiClient.delete('/prm/v1/google-contacts')`
   - Returns: {message}

Add these methods alphabetically within the prmApi object, following existing patterns like getSlackStatus, etc.
  </action>
  <verify>
1. `npm run lint` passes
2. Methods are exported in prmApi object
  </verify>
  <done>
prmApi has getGoogleContactsStatus, initiateGoogleContactsAuth, and disconnectGoogleContacts methods
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Contacts subtab and Google Contacts card to Settings</name>
  <files>src/pages/Settings/Settings.jsx</files>
  <action>
Add a "Contacts" subtab to the Connections tab in Settings with a Google Contacts connection card:

1. **Update CONNECTION_SUBTABS array** (around line 25):
   Add new subtab entry after 'calendars':
   ```javascript
   { id: 'contacts', label: 'Contacts', icon: Users },
   ```
   (Users icon already imported from lucide-react)

2. **Add state variables** in the Settings component (around line 60-95):
   ```javascript
   // Google Contacts connection state
   const [googleContactsStatus, setGoogleContactsStatus] = useState(null);
   const [googleContactsLoading, setGoogleContactsLoading] = useState(true);
   const [connectingGoogleContacts, setConnectingGoogleContacts] = useState(false);
   const [disconnectingGoogleContacts, setDisconnectingGoogleContacts] = useState(false);
   const [googleContactsMessage, setGoogleContactsMessage] = useState('');
   ```

3. **Add useEffect to fetch Google Contacts status** (after existing useEffects):
   ```javascript
   useEffect(() => {
     const fetchGoogleContactsStatus = async () => {
       try {
         const response = await prmApi.getGoogleContactsStatus();
         setGoogleContactsStatus(response.data);
       } catch {
         // Status fetch failed silently
       } finally {
         setGoogleContactsLoading(false);
       }
     };
     fetchGoogleContactsStatus();
   }, []);
   ```

4. **Handle OAuth callback URL params** (extend existing useEffect around line 173):
   Add handling for `connected=google-contacts` param:
   ```javascript
   const googleContactsConnected = params.get('connected');
   if (googleContactsConnected === 'google-contacts') {
     setGoogleContactsMessage('Google Contacts connected successfully!');
     // Refresh status
     prmApi.getGoogleContactsStatus().then(response => {
       setGoogleContactsStatus(response.data);
     });
     setSearchParams({ tab: 'connections', subtab: 'contacts' });
   }
   ```
   Also handle error params for contacts (check if subtab=contacts).

5. **Add handler functions** (near other handlers):
   ```javascript
   const handleConnectGoogleContacts = async (readonly = true) => {
     setConnectingGoogleContacts(true);
     setGoogleContactsMessage('');
     try {
       const response = await prmApi.initiateGoogleContactsAuth(readonly);
       if (response.data.auth_url) {
         window.location.href = response.data.auth_url;
       }
     } catch (error) {
       setGoogleContactsMessage(error.response?.data?.message || 'Failed to initiate connection');
       setConnectingGoogleContacts(false);
     }
   };

   const handleDisconnectGoogleContacts = async () => {
     if (!confirm('Disconnect Google Contacts? This will stop syncing contacts.')) return;
     setDisconnectingGoogleContacts(true);
     try {
       await prmApi.disconnectGoogleContacts();
       setGoogleContactsStatus({ ...googleContactsStatus, connected: false });
       setGoogleContactsMessage('Google Contacts disconnected.');
     } catch (error) {
       setGoogleContactsMessage(error.response?.data?.message || 'Failed to disconnect');
     } finally {
       setDisconnectingGoogleContacts(false);
     }
   };
   ```

6. **Update ConnectionsTab component** to pass new props and render contacts subtab:
   - Add props: googleContactsStatus, googleContactsLoading, connectingGoogleContacts, disconnectingGoogleContacts, googleContactsMessage, handleConnectGoogleContacts, handleDisconnectGoogleContacts
   - Add subtab content: `{activeSubtab === 'contacts' && <ConnectionsContactsSubtab ... />}`

7. **Create ConnectionsContactsSubtab component** (new function component after ConnectionsSlackSubtab):
   ```jsx
   function ConnectionsContactsSubtab({
     googleContactsStatus, googleContactsLoading, connectingGoogleContacts,
     disconnectingGoogleContacts, googleContactsMessage,
     handleConnectGoogleContacts, handleDisconnectGoogleContacts,
   }) {
     const isConnected = googleContactsStatus?.connected;
     const isConfigured = googleContactsStatus?.google_configured;

     return (
       <div className="card p-6">
         <h2 className="text-lg font-semibold mb-4 dark:text-gray-100">Google Contacts</h2>
         <p className="text-sm text-gray-600 mb-4 dark:text-gray-400">
           Sync your contacts with Google Contacts for seamless access across devices.
         </p>

         {googleContactsLoading ? (
           <div className="animate-pulse">
             <div className="h-10 bg-gray-200 rounded dark:bg-gray-700"></div>
           </div>
         ) : !isConfigured ? (
           <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-lg dark:bg-yellow-900/20 dark:border-yellow-800">
             <p className="text-sm text-yellow-800 dark:text-yellow-300">
               Google integration is not configured. Contact your administrator to set up GOOGLE_CALENDAR_CLIENT_ID and GOOGLE_CALENDAR_CLIENT_SECRET.
             </p>
           </div>
         ) : isConnected ? (
           <div className="space-y-4">
             <div className="p-4 bg-green-50 border border-green-200 rounded-lg dark:bg-green-900/20 dark:border-green-800">
               <div className="flex items-center justify-between">
                 <div>
                   <p className="font-medium text-green-900 dark:text-green-300">Connected to Google Contacts</p>
                   {googleContactsStatus.email && (
                     <p className="text-sm text-green-700 dark:text-green-400">{googleContactsStatus.email}</p>
                   )}
                   {googleContactsStatus.last_sync && (
                     <p className="text-xs text-green-600 dark:text-green-500 mt-1">
                       Last synced: {formatDistanceToNow(new Date(googleContactsStatus.last_sync), { addSuffix: true })}
                     </p>
                   )}
                   {googleContactsStatus.contact_count > 0 && (
                     <p className="text-xs text-green-600 dark:text-green-500">
                       {googleContactsStatus.contact_count} contacts synced
                     </p>
                   )}
                   {googleContactsStatus.access_mode && (
                     <p className="text-xs text-green-600 dark:text-green-500">
                       Access: {googleContactsStatus.access_mode === 'readwrite' ? 'Read & Write' : 'Read Only'}
                     </p>
                   )}
                 </div>
                 <button
                   onClick={handleDisconnectGoogleContacts}
                   disabled={disconnectingGoogleContacts}
                   className="btn-secondary text-sm"
                 >
                   {disconnectingGoogleContacts ? 'Disconnecting...' : 'Disconnect'}
                 </button>
               </div>
             </div>
             {googleContactsStatus.last_error && (
               <div className="p-3 bg-red-50 border border-red-200 rounded-lg dark:bg-red-900/20 dark:border-red-800">
                 <p className="text-sm text-red-700 dark:text-red-300">
                   Last sync error: {googleContactsStatus.last_error}
                 </p>
               </div>
             )}
           </div>
         ) : (
           <div className="space-y-4">
             <button
               onClick={() => handleConnectGoogleContacts(false)}
               disabled={connectingGoogleContacts}
               className="btn-primary"
             >
               {connectingGoogleContacts ? 'Connecting...' : 'Connect Google Contacts'}
             </button>
             <p className="text-xs text-gray-500 dark:text-gray-400">
               Grants read and write access to sync contacts bidirectionally.
             </p>
           </div>
         )}

         {googleContactsMessage && (
           <p className={`mt-4 text-sm ${googleContactsMessage.includes('successfully') || googleContactsMessage.includes('disconnected') ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>
             {googleContactsMessage}
           </p>
         )}
       </div>
     );
   }
   ```

Note: Import `formatDistanceToNow` from 'date-fns' if not already imported at top of file.
  </action>
  <verify>
1. `npm run lint` passes
2. `npm run build` succeeds
3. Navigate to Settings > Connections > Contacts in browser
  </verify>
  <done>
Google Contacts subtab appears in Settings > Connections with connection card showing status, connect button (when disconnected), and disconnect button (when connected)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Google Contacts OAuth connection flow integrated into Settings UI:
- New "Contacts" subtab in Settings > Connections
- Google Contacts connection card with status display
- Connect button initiates OAuth flow with Google
- After OAuth, redirects back with connection established
- Disconnect button removes connection
  </what-built>
  <how-to-verify>
1. Deploy to production (use standard deployment command)
2. Visit https://cael.is/settings?tab=connections
3. Verify "Contacts" subtab appears next to "Calendars", "CardDAV", "Slack"
4. Click "Contacts" subtab
5. Verify Google Contacts card shows with "Connect Google Contacts" button
6. Click "Connect Google Contacts"
7. Should redirect to Google OAuth consent screen
8. Grant access to contacts
9. Should redirect back to Settings > Connections > Contacts
10. Verify card now shows "Connected to Google Contacts" with email address
11. Click "Disconnect" and confirm
12. Verify card returns to disconnected state
  </how-to-verify>
  <resume-signal>Type "approved" if OAuth flow works end-to-end, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Code quality:**
   - `npm run lint` passes
   - `npm run build` produces dist/ without errors

2. **UI presence:**
   - Contacts subtab visible in Settings > Connections
   - Google Contacts card renders correctly in both connected/disconnected states

3. **OAuth flow (manual):**
   - Connect button initiates Google OAuth
   - Callback returns to correct page with success message
   - Disconnect removes connection and updates UI
</verification>

<success_criteria>
- Google Contacts subtab appears in Settings > Connections
- Connection card shows correct state (connected/disconnected)
- Connect button initiates OAuth flow with Google
- OAuth callback creates connection and shows success
- Disconnect button removes connection
- Error messages display appropriately
- User can complete full connect/disconnect cycle
</success_criteria>

<output>
After completion, create `.planning/phases/79-oauth-foundation/79-02-SUMMARY.md`
</output>
