---
phase: 79-oauth-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-google-oauth.php
  - includes/class-google-contacts-connection.php
  - includes/class-rest-google-contacts.php
  - functions.php
autonomous: true

must_haves:
  truths:
    - "GoogleOAuth class can create auth URLs for contacts scope"
    - "GoogleOAuth preserves existing scopes when adding contacts scope (incremental auth)"
    - "Connection data can be stored and retrieved from user meta"
    - "REST endpoints respond with correct status codes"
    - "OAuth callback creates connection and redirects to settings"
  artifacts:
    - path: "includes/class-google-oauth.php"
      provides: "Contacts scope constants and get_contacts_client method"
      contains: "CONTACTS_SCOPE_READONLY"
    - path: "includes/class-google-contacts-connection.php"
      provides: "User meta storage for Google Contacts connection"
      exports: ["get_connection", "save_connection", "delete_connection", "is_connected"]
    - path: "includes/class-rest-google-contacts.php"
      provides: "REST API endpoints for contacts OAuth"
      contains: "register_rest_route"
  key_links:
    - from: "includes/class-rest-google-contacts.php"
      to: "includes/class-google-oauth.php"
      via: "GoogleOAuth::get_contacts_client()"
      pattern: "GoogleOAuth::get_contacts_client"
    - from: "includes/class-rest-google-contacts.php"
      to: "includes/class-google-contacts-connection.php"
      via: "GoogleContactsConnection::save_connection()"
      pattern: "GoogleContactsConnection::save_connection"
    - from: "functions.php"
      to: "includes/class-rest-google-contacts.php"
      via: "new GoogleContacts() in REST loading"
      pattern: "new GoogleContacts"
---

<objective>
Implement backend OAuth infrastructure for Google Contacts integration.

Purpose: Enable users to authenticate with Google and grant Contacts API access, building on existing Calendar OAuth infrastructure. This phase creates the foundation for all contacts sync functionality in subsequent phases.

Output: PHP classes for OAuth flow (scope extension, connection storage, REST endpoints) that allow users to connect Google Contacts from the frontend.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/79-oauth-foundation/79-CONTEXT.md
@.planning/phases/79-oauth-foundation/79-RESEARCH.md

# Existing OAuth infrastructure to extend
@includes/class-google-oauth.php
@includes/class-calendar-connections.php
@includes/class-rest-calendar.php
@includes/class-credential-encryption.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend GoogleOAuth class for contacts scope</name>
  <files>includes/class-google-oauth.php</files>
  <action>
Extend the existing GoogleOAuth class in `Stadion\Calendar` namespace to support contacts scope:

1. Add public constants for contacts scopes:
   - `CONTACTS_SCOPE_READONLY = 'https://www.googleapis.com/auth/contacts.readonly'`
   - `CONTACTS_SCOPE_READWRITE = 'https://www.googleapis.com/auth/contacts'`

2. Add new public static method `get_contacts_client(bool $include_granted_scopes = true, bool $readonly = true): ?\Google\Client`:
   - Return null if not configured (use existing is_configured check)
   - Create new Google\Client with same credentials (GOOGLE_CALENDAR_CLIENT_ID, GOOGLE_CALENDAR_CLIENT_SECRET)
   - Set redirect URI to `rest_url('stadion/v1/google-contacts/callback')`
   - Set scope based on $readonly param (CONTACTS_SCOPE_READONLY or CONTACTS_SCOPE_READWRITE)
   - CRITICAL: Call `$client->setIncludeGrantedScopes($include_granted_scopes)` to enable incremental auth
   - Set `setAccessType('offline')` and `setPrompt('consent')` to ensure refresh token
   - Return configured client

3. Add helper method `get_contacts_auth_url(int $user_id, bool $readonly = true): string`:
   - Call get_contacts_client() with incremental auth enabled
   - Generate state token and store in transient (pattern from existing get_auth_url)
   - Use transient key `google_contacts_oauth_{$token}` to distinguish from calendar
   - Store both user_id and readonly flag in transient value array
   - Return createAuthUrl() or empty string on failure

4. Add helper methods for scope checking:
   - `has_contacts_scope(array $credentials): bool` - Check if credentials include contacts scope
   - `get_contacts_access_mode(array $credentials): string` - Return 'readwrite', 'readonly', or 'none'
  </action>
  <verify>
1. Run `npm run lint` - no PHP syntax errors in includes/
2. Verify class loads: `wp eval "var_dump(class_exists('Stadion\Calendar\GoogleOAuth'));"`
3. Verify constants exist: `wp eval "var_dump(Stadion\Calendar\GoogleOAuth::CONTACTS_SCOPE_READONLY);"`
  </verify>
  <done>
GoogleOAuth class has contacts scope constants and get_contacts_client/get_contacts_auth_url methods that enable incremental authorization
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GoogleContactsConnection class for user meta storage</name>
  <files>includes/class-google-contacts-connection.php</files>
  <action>
Create new class `GoogleContactsConnection` in `Stadion\Contacts` namespace for managing Google Contacts connection state in user meta. Follow the pattern from `Stadion\Calendar\Connections` but adapted for single-connection-per-user:

1. Define constants:
   - `META_KEY = '_stadion_google_contacts_connection'`
   - `PENDING_IMPORT_KEY = '_stadion_google_contacts_pending_import'`

2. Implement static methods:

`get_connection(int $user_id): ?array`
- Get user meta, return null if not array
- Structure: `{enabled, access_mode, credentials (encrypted), email, connected_at, last_sync, last_error, contact_count, sync_token}`

`save_connection(int $user_id, array $connection): void`
- If credentials array present and not already encrypted, encrypt with CredentialEncryption::encrypt()
- update_user_meta with META_KEY

`delete_connection(int $user_id): void`
- delete_user_meta for META_KEY
- Also delete PENDING_IMPORT_KEY

`is_connected(int $user_id): bool`
- Return !empty(connection['credentials'])

`get_decrypted_credentials(int $user_id): ?array`
- Get connection, decrypt credentials if present, return null on failure

`update_connection(int $user_id, array $updates): bool`
- Get existing connection, merge updates, save
- Handle credential encryption if credentials being updated

`set_pending_import(int $user_id, bool $pending): void`
- update_user_meta PENDING_IMPORT_KEY with boolean

`has_pending_import(int $user_id): bool`
- Return (bool) get_user_meta PENDING_IMPORT_KEY

Add file header comment explaining this stores Google Contacts sync connection data (separate from calendar connections which are per-calendar).
  </action>
  <verify>
1. File exists and has no syntax errors: `php -l includes/class-google-contacts-connection.php`
2. Class is autoloadable (check namespace matches directory convention or add to functions.php)
  </verify>
  <done>
GoogleContactsConnection class provides user meta storage for contacts connection with encryption, pending import flag, and CRUD operations
  </done>
</task>

<task type="auto">
  <name>Task 3: Create REST API endpoints for Google Contacts OAuth</name>
  <files>includes/class-rest-google-contacts.php, functions.php</files>
  <action>
Create new REST controller class `Stadion\REST\GoogleContacts` extending Base (follow pattern from class-rest-calendar.php):

1. Register routes in `register_routes()`:

`GET /stadion/v1/google-contacts/status` - Check connection status
- Permission: check_user_approved (existing method from Base)
- Return: `{connected: bool, access_mode: string, email: string, last_sync: string|null, contact_count: int, last_error: string|null, has_pending_import: bool}`
- Also return `google_configured: bool` (GoogleOAuth::is_configured())

`GET /stadion/v1/google-contacts/auth` - Initiate OAuth flow
- Permission: check_user_approved
- Params: `readonly` (bool, default true)
- Check if already connected - return error if so
- Generate auth URL via GoogleOAuth::get_contacts_auth_url()
- Return `{auth_url: string}` or WP_Error

`GET /stadion/v1/google-contacts/callback` - OAuth callback (public for redirect)
- Permission: __return_true (public endpoint for OAuth redirect)
- Validate state from transient (google_contacts_oauth_{$token})
- Delete transient after use
- Handle error param from Google (user denied)
- Exchange code for tokens via GoogleOAuth::handle_callback()
- Check granted scopes and determine access_mode
- Get user email from token (decode JWT or make userinfo call)
- Create connection via GoogleContactsConnection::save_connection()
- Set pending_import flag to true (Phase 80 will check this)
- Use html_redirect (pattern from calendar callback) to `/settings?tab=connections&subtab=contacts&connected=google-contacts`

`DELETE /stadion/v1/google-contacts` - Disconnect
- Permission: check_user_approved
- Delete connection via GoogleContactsConnection::delete_connection()
- Return success message
- Do NOT revoke token at Google (user might still have Calendar connected with same account)

2. Helper method `get_user_email_from_token(array $credentials): string`:
- Create Google Client, set access token
- Make call to oauth2/userinfo endpoint or decode id_token if present
- Return email address

3. Update functions.php to instantiate the new class:
- In the REST API section (around line 308-318), add:
  `new RESTGoogleContacts();` (or whatever alias you use)
- Add the use statement at top: `use Stadion\REST\GoogleContacts as RESTGoogleContacts;`

4. Use the html_redirect pattern from class-rest-calendar.php for the callback redirect (REST API endpoints don't handle wp_redirect properly).
  </action>
  <verify>
1. Syntax check: `php -l includes/class-rest-google-contacts.php`
2. Routes registered: `wp rest list --path=/stadion/v1/google-contacts` shows status, auth, callback
3. Status endpoint works: `curl -s "https://cael.is/wp-json/stadion/v1/google-contacts/status" -H "X-WP-Nonce: ..."` returns JSON
  </verify>
  <done>
REST API endpoints for Google Contacts OAuth are functional: status returns connection state, auth initiates OAuth, callback completes flow, disconnect removes connection
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Unit verification:**
   - `php -l includes/class-google-oauth.php` - no syntax errors
   - `php -l includes/class-google-contacts-connection.php` - no syntax errors
   - `php -l includes/class-rest-google-contacts.php` - no syntax errors

2. **Integration verification:**
   - WordPress loads without errors
   - REST routes are registered (`wp rest list --path=/stadion/v1/google-contacts`)
   - Status endpoint returns expected structure

3. **OAuth flow verification (manual in Phase 79-02):**
   - Will be verified through frontend integration
</verification>

<success_criteria>
- GoogleOAuth class extended with contacts scope support and incremental auth
- GoogleContactsConnection class stores connection data in user meta with encryption
- REST endpoints registered and respond correctly
- OAuth callback handles token exchange and creates connection
- functions.php loads new classes
- All PHP files have no syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/79-oauth-foundation/79-01-SUMMARY.md`
</output>
