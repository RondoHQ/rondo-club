---
phase: 114-user-preferences-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-api.php
autonomous: true

must_haves:
  truths:
    - "GET /stadion/v1/user/list-preferences returns user's visible_columns array"
    - "GET endpoint returns available_columns metadata for UI rendering"
    - "PATCH endpoint saves visible_columns to user_meta"
    - "PATCH with empty array resets to default columns"
    - "PATCH with { reset: true } clears preferences"
    - "Invalid column IDs are filtered silently (not rejected)"
    - "Different users have independent preferences"
  artifacts:
    - path: "includes/class-rest-api.php"
      provides: "list-preferences endpoints and helper methods"
      contains: "get_list_preferences"
      exports: ["get_list_preferences", "update_list_preferences"]
  key_links:
    - from: "includes/class-rest-api.php"
      to: "includes/customfields/class-manager.php"
      via: "get_fields() for validation"
      pattern: "CustomFields\\\\Manager"
    - from: "includes/class-rest-api.php"
      to: "wp_usermeta"
      via: "get_user_meta/update_user_meta"
      pattern: "stadion_people_list_preferences"
---

<objective>
Add REST API endpoints for storing and retrieving per-user People list column preferences.

Purpose: Enable Phase 115 (Column Preferences UI) to persist user choices server-side, allowing preferences to sync across devices and survive browser cache clears.

Output: Two endpoints at `/stadion/v1/user/list-preferences`:
- GET: Returns visible_columns (user's saved columns) and available_columns (all valid options with metadata)
- PATCH: Updates visible_columns with validation against active custom fields
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/114-user-preferences-backend/114-CONTEXT.md
@.planning/phases/114-user-preferences-backend/114-RESEARCH.md
@includes/class-rest-api.php (existing patterns: get_dashboard_settings, update_dashboard_settings)
@includes/customfields/class-manager.php (get_fields method for validation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register list-preferences endpoints</name>
  <files>includes/class-rest-api.php</files>
  <action>
Add two new REST route registrations to `register_routes()` method, following the dashboard-settings pattern:

1. GET `/stadion/v1/user/list-preferences`:
   - methods: \WP_REST_Server::READABLE
   - callback: [ $this, 'get_list_preferences' ]
   - permission_callback: 'is_user_logged_in'

2. PATCH `/stadion/v1/user/list-preferences`:
   - methods: 'PATCH'
   - callback: [ $this, 'update_list_preferences' ]
   - permission_callback: 'is_user_logged_in'
   - args:
     - visible_columns: required=false, validate_callback checks is_array or null
     - reset: required=false, validate_callback checks is_bool

Place these route registrations after the existing dashboard-settings routes (around line 210).
  </action>
  <verify>
Check route registration syntax matches existing patterns. Verify no PHP syntax errors:
`php -l includes/class-rest-api.php`
  </verify>
  <done>Two route registrations added to register_routes() method with correct permission callbacks and argument validators.</done>
</task>

<task type="auto">
  <name>Task 2: Implement GET and PATCH handler methods</name>
  <files>includes/class-rest-api.php</files>
  <action>
Add four new methods to the Api class, following patterns from get_dashboard_settings/update_dashboard_settings:

**Constants (add near VALID_DASHBOARD_CARDS constant):**
```php
/**
 * Default visible columns for People list.
 * Name column is always visible and first - not included here.
 */
private const DEFAULT_LIST_COLUMNS = [ 'team', 'labels', 'modified' ];

/**
 * Core columns (non-custom-field columns).
 */
private const CORE_LIST_COLUMNS = [
    [ 'id' => 'team', 'label' => 'Team', 'type' => 'core' ],
    [ 'id' => 'labels', 'label' => 'Labels', 'type' => 'core' ],
    [ 'id' => 'modified', 'label' => 'Last Modified', 'type' => 'core' ],
];
```

**Method 1: get_list_preferences($request)**
- Get current user ID via get_current_user_id()
- Retrieve stored preferences: get_user_meta($user_id, 'stadion_people_list_preferences', true)
- If empty or not array, use DEFAULT_LIST_COLUMNS
- Get available columns metadata via helper method
- Return rest_ensure_response with 'visible_columns' and 'available_columns'

**Method 2: update_list_preferences($request)**
- Get current user ID
- Handle reset: true case - delete_user_meta and return defaults
- Get visible_columns param
- If empty array or not array, delete_user_meta and return defaults (per CONTEXT.md)
- Get valid column IDs via helper method
- Filter columns with array_values(array_intersect($columns, $valid))
- Log warning if columns were filtered (deleted fields)
- update_user_meta with validated columns
- Return rest_ensure_response with updated visible_columns and available_columns

**Method 3: get_valid_column_ids() (private)**
- Return array of core column IDs: ['team', 'labels', 'modified']
- Get active custom fields: new \Stadion\CustomFields\Manager() then get_fields('person', false)
- Extract field names with array_column($fields, 'name')
- Return array_merge of core and custom field names

**Method 4: get_available_columns_metadata() (private)**
- Start with CORE_LIST_COLUMNS constant
- Get active custom fields via CustomFields\Manager::get_fields('person', false)
- Loop through custom fields, add each as: ['id' => name, 'label' => label, 'type' => type, 'custom' => true]
- Return merged array

Place these methods after the existing update_dashboard_settings method (around line 1020).
  </action>
  <verify>
1. Check PHP syntax: `php -l includes/class-rest-api.php`
2. Verify class compiles by running: `wp eval "new \Stadion\REST\Api();"` (or check no fatal errors on page load)
  </verify>
  <done>
- get_list_preferences returns visible_columns array and available_columns metadata
- update_list_preferences validates against active custom fields, handles reset and empty array cases
- Helper methods correctly build valid column lists from core + custom fields
- Storage uses 'stadion_people_list_preferences' user meta key
  </done>
</task>

<task type="auto">
  <name>Task 3: Test endpoints via curl</name>
  <files>None (testing only)</files>
  <action>
Deploy to production and test endpoints with curl commands. Create test sequence:

1. GET with no saved preferences (should return defaults):
```bash
curl -X GET "https://[production-url]/wp-json/stadion/v1/user/list-preferences" \
  -H "Cookie: [auth-cookie]" \
  -H "X-WP-Nonce: [nonce]"
```
Expected: visible_columns = ['team', 'labels', 'modified'], available_columns includes custom fields

2. PATCH to save custom columns:
```bash
curl -X PATCH "https://[production-url]/wp-json/stadion/v1/user/list-preferences" \
  -H "Content-Type: application/json" \
  -H "Cookie: [auth-cookie]" \
  -H "X-WP-Nonce: [nonce]" \
  -d '{"visible_columns": ["labels", "modified"]}'
```
Expected: visible_columns = ['labels', 'modified']

3. GET after save (should return saved columns):
Expected: visible_columns = ['labels', 'modified']

4. PATCH with invalid column (should filter silently):
```bash
curl -X PATCH ... -d '{"visible_columns": ["labels", "invalid_field", "modified"]}'
```
Expected: visible_columns = ['labels', 'modified'] (invalid_field filtered out)

5. PATCH with reset flag:
```bash
curl -X PATCH ... -d '{"reset": true}'
```
Expected: visible_columns = ['team', 'labels', 'modified'], reset = true

6. PATCH with empty array (should reset):
```bash
curl -X PATCH ... -d '{"visible_columns": []}'
```
Expected: visible_columns = ['team', 'labels', 'modified']

Document actual responses in verification. Tests require authentication - use browser network tab to capture valid cookie/nonce if curl is impractical.
  </action>
  <verify>
All 6 test cases pass:
- GET returns defaults when no preferences saved
- PATCH saves valid columns
- GET returns saved columns after PATCH
- Invalid columns are filtered (not rejected)
- reset: true clears preferences
- Empty array resets to defaults
  </verify>
  <done>
All endpoints work correctly:
- Permission denied for unauthenticated requests (401/403)
- GET returns visible_columns and available_columns
- PATCH validates and persists preferences
- Reset behaviors work as specified in CONTEXT.md
  </done>
</task>

</tasks>

<verification>
## Phase Verification

After all tasks complete:

1. **Endpoint availability:**
   - GET /stadion/v1/user/list-preferences returns 200 for logged-in users
   - PATCH /stadion/v1/user/list-preferences returns 200 for logged-in users
   - Both return 401 for unauthenticated requests

2. **Data persistence:**
   - Preferences stored in wp_usermeta with key 'stadion_people_list_preferences'
   - Each user has independent preferences (test with two accounts if possible)

3. **Validation:**
   - Invalid column IDs filtered from PATCH requests (not rejected)
   - Custom field names from Manager::get_fields() appear in available_columns
   - Core columns (team, labels, modified) always available

4. **Default behavior:**
   - New users (no saved prefs) get ['team', 'labels', 'modified']
   - Empty array submission resets to defaults
   - reset: true flag clears preferences and returns defaults

5. **Code quality:**
   - No PHP syntax errors
   - Follows existing patterns (dashboard-settings, theme-preferences)
   - Uses established constants pattern
</verification>

<success_criteria>
1. GET endpoint returns visible_columns array and available_columns metadata
2. PATCH endpoint saves visible_columns to wp_usermeta
3. Invalid column IDs (deleted custom fields) are filtered silently
4. Empty array and reset:true both reset to defaults
5. Each user has independent preferences
6. Code follows existing class-rest-api.php patterns
</success_criteria>

<output>
After completion, create `.planning/phases/114-user-preferences-backend/114-01-SUMMARY.md`
</output>
