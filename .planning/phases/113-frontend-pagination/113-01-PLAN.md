---
phase: 113-frontend-pagination
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-people.php
autonomous: true

must_haves:
  truths:
    - "User can sort people by custom text field via API"
    - "User can sort people by custom number field via API (numeric sort, not alphabetic)"
    - "User can sort people by custom date field via API (chronological order)"
    - "Invalid custom field names are rejected with validation error"
    - "Only active custom fields are accepted for sorting"
  artifacts:
    - path: "includes/class-rest-people.php"
      provides: "Custom field sorting in filtered endpoint"
      contains: "custom_"
  key_links:
    - from: "includes/class-rest-people.php"
      to: "Stadion\\CustomFields\\Manager"
      via: "Field validation and type lookup"
      pattern: "Stadion\\\\CustomFields\\\\Manager"
---

<objective>
Add custom ACF field sorting to the `/stadion/v1/people/filtered` endpoint.

Purpose: Enable users to sort the people list by any active custom field (text, number, date types), completing DATA-09 requirement.

Output: Extended orderby parameter accepts `custom_{field_name}` values with type-appropriate sorting (numeric, date, text).
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/111-server-side-foundation/111-01-SUMMARY.md
@includes/class-rest-people.php
@includes/class-custom-fields-manager.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend orderby validation to accept custom fields</name>
  <files>includes/class-rest-people.php</files>
  <action>
Modify the `orderby` parameter validation in the `/people/filtered` route registration (around line 260-265):

1. Change the validate_callback from simple whitelist to a function that:
   - First checks if value is in built-in list: ['first_name', 'last_name', 'modified']
   - If not, checks if value starts with 'custom_'
   - If custom_, extracts field name (remove 'custom_' prefix)
   - Uses `Stadion\CustomFields\Manager` to validate:
     - Field exists for 'person' entity type
     - Field is active (not disabled)
     - Field type is sortable: ['text', 'textarea', 'number', 'date', 'select']
   - Return true only if all validations pass

2. Add a use statement at top if needed for the CustomFields Manager namespace

The validation should reject:
- Non-existent custom fields
- Inactive custom fields
- Non-sortable field types (checkbox, wysiwyg, repeater, etc.)

Example valid values: 'first_name', 'last_name', 'modified', 'custom_vog_status', 'custom_sportlink_id'
Example invalid values: 'invalid_column', 'custom_nonexistent', 'custom_inactive_field'
  </action>
  <verify>
Deploy and test validation:
```bash
# Should reject invalid custom field
curl -s "https://[production-url]/wp-json/stadion/v1/people/filtered?orderby=custom_nonexistent" | jq '.code'
# Expected: "rest_invalid_param"

# Should reject non-sortable types (if any wysiwyg fields exist)
# Should accept valid custom field names (test after Task 2)
```
  </verify>
  <done>
- Built-in sort fields (first_name, last_name, modified) still work
- Custom field names starting with 'custom_' are validated against CustomFields Manager
- Invalid custom fields return 400 validation error
- Only sortable field types (text, textarea, number, date, select) are accepted
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement custom field ORDER BY clause</name>
  <files>includes/class-rest-people.php</files>
  <action>
Extend the `get_filtered_people` method (around line 1011-1025) to handle custom field sorting:

1. After the existing switch statement for orderby, add an else-if check for custom fields:
   - If `$orderby` starts with 'custom_', extract the field name
   - Look up the field definition using `Stadion\CustomFields\Manager` to get the field type
   - Add a LEFT JOIN for the custom field meta: `LEFT JOIN {$wpdb->postmeta} cf ON p.ID = cf.post_id AND cf.meta_key = %s`
   - Add the field name to $prepare_values

2. Build type-appropriate ORDER BY clause:
   - For 'number' type: `ORDER BY CAST(cf.meta_value AS DECIMAL(10,2)) $order, fn.meta_value $order`
   - For 'date' type: `ORDER BY STR_TO_DATE(cf.meta_value, '%Y%m%d') $order, fn.meta_value $order` (ACF stores dates as Ymd format)
   - For text-based types (text, textarea, select): `ORDER BY cf.meta_value $order, fn.meta_value $order`

3. Handle NULL values gracefully:
   - Use COALESCE or NULLS LAST pattern so people without the custom field value sort last
   - Example for text: `ORDER BY COALESCE(cf.meta_value, 'zzzzz') $order, fn.meta_value $order`
   - Example for number: `ORDER BY COALESCE(CAST(cf.meta_value AS DECIMAL(10,2)), -999999) $order`

4. Add the secondary sort by first_name to maintain consistent ordering within groups

Ensure you use $wpdb->prepare() for the meta_key value to prevent SQL injection.
  </action>
  <verify>
Deploy and test sorting:
```bash
# Test text field sorting (assuming vog_status exists)
curl -s "https://[production-url]/wp-json/stadion/v1/people/filtered?orderby=custom_vog_status&order=asc&per_page=5" | jq '.people[].first_name'

# Test with desc order
curl -s "https://[production-url]/wp-json/stadion/v1/people/filtered?orderby=custom_vog_status&order=desc&per_page=5" | jq '.people[].first_name'

# Verify pagination still works with custom sort
curl -s "https://[production-url]/wp-json/stadion/v1/people/filtered?orderby=custom_vog_status&page=2&per_page=10" | jq '.page'
```
  </verify>
  <done>
- Custom text fields sort alphabetically
- Custom number fields sort numerically (not as strings)
- Custom date fields sort chronologically
- People without the custom field value appear last
- Pagination works correctly with custom field sorting
- Combined with filters (labels, ownership) works correctly
  </done>
</task>

<task type="auto">
  <name>Task 3: Deploy and verify custom field sorting</name>
  <files></files>
  <action>
1. Run `npm run build` to ensure no frontend changes break the build
2. Deploy to production using `bin/deploy.sh`
3. Test custom field sorting on production:
   - Identify an active custom field name from the database or settings
   - Test sorting by that field in both asc and desc order
   - Verify pagination metadata is correct
   - Verify combined with other filters (labels, birth_year) works

Test with curl or browser console:
```javascript
// In browser console on production
fetch('/wp-json/stadion/v1/people/filtered?orderby=custom_[field_name]&per_page=10')
  .then(r => r.json())
  .then(d => console.log('Total:', d.total, 'People:', d.people.map(p => p.first_name)))
```
  </action>
  <verify>
Production verification:
- Endpoint accepts custom field orderby parameter
- Results are sorted by custom field value
- Pagination info is correct (total, total_pages)
- No PHP errors in logs
- Response time acceptable (<200ms)
  </verify>
  <done>
- Custom field sorting deployed to production
- API returns correctly sorted results
- No regressions in existing functionality (built-in sorts, filters, pagination)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Validation tests:**
   - Invalid custom field name returns 400 error
   - Inactive custom field returns 400 error
   - Valid custom field is accepted

2. **Sorting tests:**
   - Text field sorts A-Z (asc) and Z-A (desc)
   - Number field sorts numerically (1, 2, 10 not 1, 10, 2)
   - Date field sorts chronologically
   - Null/empty values sort last

3. **Integration tests:**
   - Pagination works with custom sort
   - Filters (labels, ownership, birth_year) combine with custom sort
   - Performance acceptable with 1400+ records

4. **No regressions:**
   - Built-in sorts (first_name, last_name, modified) still work
   - Existing filters unchanged
</verification>

<success_criteria>
- DATA-09 requirement complete: Server sorts people by custom ACF fields (text, number, date types)
- Custom field orderby parameter validates against CustomFields Manager
- Type-appropriate sorting (numeric, date, text) implemented
- NULL values handled gracefully (sort last)
- No SQL injection vulnerabilities (all values prepared)
- Performance acceptable (<200ms response time)
</success_criteria>

<output>
After completion, create `.planning/phases/113-frontend-pagination/113-01-SUMMARY.md`
</output>
