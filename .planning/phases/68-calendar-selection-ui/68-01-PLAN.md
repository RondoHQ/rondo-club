---
phase: 68-calendar-selection-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [includes/class-rest-calendar.php, includes/class-google-calendar-provider.php, src/pages/Settings/Settings.jsx]
autonomous: true
---

<objective>
Add calendar selection UI allowing users to choose which calendars to sync per connection.

Purpose: Currently Google connections default to "primary" calendar and CalDAV connections require recreation to change calendars. Users need ability to view available calendars and select which one to sync for each connection.

Output: REST endpoint for listing calendars, updated EditConnectionModal with calendar picker, updated connection display showing selected calendar.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/67-sync-range-frequency/67-01-SUMMARY.md
@.planning/phases/67-sync-range-frequency/67-02-SUMMARY.md

# Source files to reference
@includes/class-rest-calendar.php
@includes/class-google-calendar-provider.php
@includes/class-caldav-provider.php
@includes/class-google-oauth.php
@src/pages/Settings/Settings.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add list calendars REST endpoint and Google calendar list method</name>
  <files>includes/class-rest-calendar.php, includes/class-google-calendar-provider.php</files>
  <action>
1. In class-google-calendar-provider.php, add a static method `list_calendars(array $connection): array` that:
   - Gets access token via `\RONDO_Google_OAuth::get_access_token($connection)`
   - Creates Google Calendar service using same pattern as sync() method
   - Calls `$service->calendarList->listCalendarList()` to get all calendars
   - Returns array of `['id' => string, 'name' => string, 'color' => string, 'primary' => bool]`
   - Primary calendar should be marked with `'primary' => true`
   - Handle errors gracefully, return empty array on failure

2. In class-rest-calendar.php, add endpoint `GET /rondo/v1/calendar/connections/{id}/calendars`:
   - Route: `/calendar/connections/(?P<id>[a-z0-9_]+)/calendars`
   - Permission: `check_user_approved`
   - Gets connection by ID for current user
   - Routes to appropriate provider:
     - For Google: `\RONDO_Google_Calendar_Provider::list_calendars($connection)`
     - For CalDAV: `\RONDO_CalDAV_Provider::discover_calendars($url, $username, $password)` (decrypt credentials first)
   - Returns `{ calendars: [...], current: string }` where current is the connection's `calendar_id`
   - Handle errors with appropriate WP_Error responses

Note: CalDAV's `discover_calendars()` already exists and returns the right format. Google needs the new method.
  </action>
  <verify>
- `php -l includes/class-google-calendar-provider.php` passes
- `php -l includes/class-rest-calendar.php` passes
- Verify the new method signature matches what the endpoint expects
  </verify>
  <done>
- GET /rondo/v1/calendar/connections/{id}/calendars returns list of available calendars
- Google and CalDAV providers both return calendar lists in consistent format
  </done>
</task>

<task type="auto">
  <name>Task 2: Add calendar selector to EditConnectionModal</name>
  <files>src/pages/Settings/Settings.jsx</files>
  <action>
1. In EditConnectionModal component, add state:
   - `const [calendars, setCalendars] = useState([]);`
   - `const [loadingCalendars, setLoadingCalendars] = useState(false);`
   - `const [selectedCalendarId, setSelectedCalendarId] = useState(connection.calendar_id || '');`

2. Add useEffect to fetch calendars when modal opens:
   ```javascript
   useEffect(() => {
     const fetchCalendars = async () => {
       setLoadingCalendars(true);
       try {
         const response = await prmApi.getConnectionCalendars(connection.id);
         setCalendars(response.data.calendars || []);
         // Keep current selection if valid
         if (!selectedCalendarId && response.data.current) {
           setSelectedCalendarId(response.data.current);
         }
       } catch (err) {
         // Silently fail - calendar list is optional enhancement
         console.error('Failed to fetch calendars:', err);
       } finally {
         setLoadingCalendars(false);
       }
     };
     fetchCalendars();
   }, [connection.id]);
   ```

3. Add API method in src/api/client.js (prmApi object):
   - `getConnectionCalendars: (connectionId) => apiClient.get(\`/rondo/v1/calendar/connections/\${connectionId}/calendars\`)`

4. Add calendar selector UI in EditConnectionModal after the connection name field:
   ```jsx
   {/* Calendar selector - show when calendars loaded */}
   {calendars.length > 0 && (
     <div>
       <label className="label mb-1">Calendar to sync</label>
       <select
         value={selectedCalendarId}
         onChange={(e) => setSelectedCalendarId(e.target.value)}
         className="input"
       >
         {calendars.map((cal) => (
           <option key={cal.id} value={cal.id}>
             {cal.name}{cal.primary ? ' (Primary)' : ''}
           </option>
         ))}
       </select>
       <p className="text-xs text-gray-500 mt-1 dark:text-gray-400">
         Select which calendar to sync events from
       </p>
     </div>
   )}
   {loadingCalendars && (
     <p className="text-sm text-gray-500 dark:text-gray-400">
       Loading available calendars...
     </p>
   )}
   ```

5. Update handleSave to include `calendar_id: selectedCalendarId` in the data object sent to API

6. In the connection card display (CalendarsTab), show the calendar name if available:
   - Currently shows `connection.name` as the connection title
   - Add calendar_id display below as subtitle if it exists and differs from 'primary'
  </action>
  <verify>
- `npm run build` completes without errors
- `npm run lint` passes with no warnings
  </verify>
  <done>
- EditConnectionModal shows calendar dropdown when calendars are available
- Users can change which calendar is synced for existing connections
- Selected calendar is saved via PUT /calendar/connections/{id}
- Connection cards show which calendar is selected
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] PHP syntax validation passes for all modified files
- [ ] REST endpoint returns calendar list for Google connections
- [ ] REST endpoint returns calendar list for CalDAV connections
- [ ] EditConnectionModal displays calendar picker
- [ ] Changing calendar in EditConnectionModal saves correctly
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Users can view available calendars for each connection
- Users can change which calendar to sync
- Changes persist via PUT endpoint
</success_criteria>

<output>
After completion, create `.planning/phases/68-calendar-selection-ui/68-01-SUMMARY.md`
</output>
