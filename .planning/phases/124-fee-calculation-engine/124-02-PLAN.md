---
phase: 124-fee-calculation-engine
plan: 02
type: execute
wave: 2
depends_on: ["124-01"]
files_modified:
  - includes/class-membership-fees.php
autonomous: true

must_haves:
  truths:
    - "Season key follows YYYY-YYYY format (e.g., 2025-2026)"
    - "July 1 starts new season (month 7+)"
    - "Fee snapshots stored in post meta with season key"
    - "Snapshot includes category, base_fee, calculated_at timestamp"
    - "get_fee_for_person retrieves snapshot or calculates fresh"
    - "Unknown leeftijdsgroep values flagged in result"
  artifacts:
    - path: "includes/class-membership-fees.php"
      provides: "Season key calculation"
      contains: "get_season_key"
    - path: "includes/class-membership-fees.php"
      provides: "Snapshot storage"
      contains: "save_fee_snapshot"
    - path: "includes/class-membership-fees.php"
      provides: "Fee retrieval with caching"
      contains: "get_fee_for_person"
  key_links:
    - from: "get_fee_for_person"
      to: "calculate_fee"
      via: "method call"
      pattern: "calculate_fee"
    - from: "get_fee_for_person"
      to: "get_season_key"
      via: "method call"
      pattern: "get_season_key"
    - from: "save_fee_snapshot"
      to: "update_post_meta"
      via: "WordPress function"
      pattern: "update_post_meta"
---

<objective>
Add season snapshot storage and fee retrieval methods to the MembershipFees service class.

Purpose: Enable fee locking at season start (July 1) by storing calculated fees in post meta. This allows fees to remain stable throughout the season even if member data changes, with admin ability to recalculate if needed.

Output: MembershipFees class extended with season key calculation, snapshot storage, and a get_fee_for_person method that retrieves cached or fresh fee calculations.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/124-fee-calculation-engine/124-CONTEXT.md
@.planning/phases/124-fee-calculation-engine/124-RESEARCH.md
@.planning/phases/124-fee-calculation-engine/124-01-SUMMARY.md
@includes/class-membership-fees.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add season key and snapshot methods</name>
  <files>includes/class-membership-fees.php</files>
  <action>
Add the following methods to the MembershipFees class:

1. **get_season_key(?string $date = null): string**
   - If $date provided, parse with strtotime(); otherwise use current time
   - Extract month (n format, 1-12) and year (Y format)
   - Season starts July 1: if month >= 7, season is current year to next year
   - If month < 7, season is previous year to current year
   - Return format: "YYYY-YYYY" (e.g., "2025-2026")

   Example implementation:
   ```php
   $timestamp = $date ? strtotime( $date ) : time();
   $month = (int) date( 'n', $timestamp );
   $year = (int) date( 'Y', $timestamp );

   $season_start_year = $month >= 7 ? $year : $year - 1;
   return $season_start_year . '-' . ( $season_start_year + 1 );
   ```

2. **get_snapshot_meta_key(?string $season = null): string**
   - Return 'fee_snapshot_' . ($season ?: $this->get_season_key())
   - Used as post meta key for storing/retrieving snapshots

3. **save_fee_snapshot(int $person_id, array $fee_data, ?string $season = null): bool**
   - $fee_data should be result from calculate_fee (category, base_fee, etc.)
   - Add 'calculated_at' timestamp: current_time('Y-m-d H:i:s')
   - Store in post meta using get_snapshot_meta_key($season)
   - Return result of update_post_meta

4. **get_fee_snapshot(int $person_id, ?string $season = null): ?array**
   - Retrieve from post meta using get_snapshot_meta_key($season)
   - Return array if exists, null if not

5. **clear_fee_snapshot(int $person_id, ?string $season = null): bool**
   - Delete the snapshot meta for given person and season
   - Return result of delete_post_meta

Add PHPDoc comments for each method.
  </action>
  <verify>
Read includes/class-membership-fees.php and verify:
- get_season_key method exists with correct July boundary logic
- get_snapshot_meta_key returns properly formatted key
- save_fee_snapshot stores data with timestamp
- get_fee_snapshot retrieves stored data
- clear_fee_snapshot removes the meta
  </verify>
  <done>
Five season/snapshot methods added with proper meta key handling and season boundary logic.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add get_fee_for_person public API method</name>
  <files>includes/class-membership-fees.php</files>
  <action>
Add the main public API method for retrieving a person's fee:

**get_fee_for_person(int $person_id, array $options = []): ?array**

Options:
- 'use_cache' => true (default): Check for existing snapshot first
- 'save_snapshot' => true (default): Save calculation result to snapshot
- 'season' => null (default): Use current season
- 'force_recalculate' => false (default): If true, ignore cache and recalculate

Return format (same as calculate_fee, with additions):
```php
[
    'category'       => 'junior',
    'base_fee'       => 230,
    'leeftijdsgroep' => 'Onder 14',
    'person_id'      => $person_id,
    'season'         => '2025-2026',
    'from_cache'     => true|false,
    'calculated_at'  => '2025-07-01 00:00:00',
]
```

Return null if person has no calculable fee (same as calculate_fee).

Implementation:
1. Determine season from options or current
2. If use_cache and not force_recalculate:
   - Try get_fee_snapshot($person_id, $season)
   - If found, add 'from_cache' => true, 'season' => $season, return
3. Calculate fresh: $result = $this->calculate_fee($person_id)
4. If null, return null
5. Add 'season' => $season, 'from_cache' => false
6. If save_snapshot: save_fee_snapshot($person_id, $result, $season)
7. Return result

This method is the primary API that Phase 125/126 and the UI will use.
  </action>
  <verify>
Read includes/class-membership-fees.php and verify:
- get_fee_for_person method exists
- Accepts $options array with documented keys
- Returns array with season and from_cache fields
- Uses caching when use_cache is true
- Saves snapshot when save_snapshot is true
  </verify>
  <done>
get_fee_for_person method implemented as the primary public API for fee retrieval with caching support.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add bulk operations and edge case handling</name>
  <files>includes/class-membership-fees.php</files>
  <action>
Add utility methods for bulk operations and edge case handling:

1. **clear_all_snapshots_for_season(string $season): int**
   - Delete all fee snapshots for a given season across all people
   - Use WP_Query to find all person posts
   - Delete meta with get_snapshot_meta_key($season)
   - Return count of deleted snapshots
   - Note: This enables admin "recalculate all" functionality

2. **get_calculation_status(int $person_id): array**
   - Helper method to understand why a person might be excluded
   - Return array with diagnostic info:
   ```php
   [
       'has_leeftijdsgroep' => bool,
       'leeftijdsgroep_value' => string|null,
       'parsed_category' => string|null, // result of parse_age_group
       'has_teams' => bool,
       'team_count' => int,
       'is_donateur' => bool,
       'calculable' => bool, // whether calculate_fee would return non-null
       'reason' => string, // human-readable reason if not calculable
   ]
   ```
   - Reasons: 'no_age_group_no_team_not_donateur', 'has_team_but_no_age_group', 'unknown_age_group'

3. Update calculate_fee to add 'unknown_category' => true flag when leeftijdsgroep exists but doesn't parse to known category (for flagging in UI).
  </action>
  <verify>
Read includes/class-membership-fees.php and verify:
- clear_all_snapshots_for_season method exists with WP_Query
- get_calculation_status returns diagnostic array
- calculate_fee adds unknown_category flag for unparseable age groups
  </verify>
  <done>
Bulk operations and diagnostic methods added for admin functionality and debugging.
  </done>
</task>

<task type="auto">
  <name>Task 4: Build and deploy</name>
  <files>dist/</files>
  <action>
1. Run npm run build to ensure frontend still compiles
2. Deploy to production using bin/deploy.sh
3. Clear caches on production
4. Verify production site loads correctly
  </action>
  <verify>
- npm run build completes without errors
- bin/deploy.sh completes successfully
- Production site loads without errors
  </verify>
  <done>
Build succeeds, deployed to production, all Phase 124 calculation logic available on production.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Read includes/class-membership-fees.php and confirm all new methods exist
2. Verify season key logic handles July boundary correctly
3. Verify get_fee_for_person caching behavior
4. Verify bulk clear method exists for admin recalculation
5. Production deployment successful
</verification>

<success_criteria>
- get_season_key returns correct season string for any date
- Fee snapshots stored in post meta with season-specific keys
- get_fee_for_person returns cached results when available
- get_fee_for_person calculates fresh when cache miss or forced
- clear_all_snapshots_for_season enables admin recalculation
- get_calculation_status provides diagnostic info for excluded members
- Unknown age groups flagged for review
- Production deployment successful
</success_criteria>

<output>
After completion, create `.planning/phases/124-fee-calculation-engine/124-02-SUMMARY.md`
</output>
