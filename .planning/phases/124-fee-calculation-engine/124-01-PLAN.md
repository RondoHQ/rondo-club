---
phase: 124-fee-calculation-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-membership-fees.php
autonomous: true

must_haves:
  truths:
    - "Mini members (Onder 6-7) get mini fee category"
    - "Pupil members (Onder 8-11) get pupil fee category"
    - "Junior members (Onder 12-19) get junior fee category"
    - "Senior members (Senioren) get senior fee category"
    - "Meiden and Vrouwen suffixes are stripped before matching"
    - "Recreant fee applies when senior is in recreational team"
    - "Donateur fee applies when only werkfunctie is Donateur"
    - "calculate_fee returns fee amount with category info"
  artifacts:
    - path: "includes/class-membership-fees.php"
      provides: "Fee calculation methods"
      contains: "parse_age_group"
    - path: "includes/class-membership-fees.php"
      provides: "Member type detection"
      contains: "get_current_teams"
    - path: "includes/class-membership-fees.php"
      provides: "Main calculation method"
      contains: "calculate_fee"
  key_links:
    - from: "calculate_fee"
      to: "parse_age_group"
      via: "method call"
      pattern: "parse_age_group"
    - from: "calculate_fee"
      to: "get_current_teams"
      via: "method call"
      pattern: "get_current_teams"
    - from: "calculate_fee"
      to: "get_fee"
      via: "method call"
      pattern: "get_fee"
---

<objective>
Implement fee calculation logic in the MembershipFees service class.

Purpose: Enable the system to determine the correct base fee for any member based on their age group (leeftijdsgroep), team membership, and work functions. This is the core calculation engine that Phase 125 (family discount) and Phase 126 (pro-rata) will build upon.

Output: Extended MembershipFees class with calculate_fee() method that returns fee category and amount for any person.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/124-fee-calculation-engine/124-CONTEXT.md
@.planning/phases/124-fee-calculation-engine/124-RESEARCH.md
@.planning/phases/123-settings-backend-foundation/123-01-SUMMARY.md
@includes/class-membership-fees.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add age group parsing and team detection methods</name>
  <files>includes/class-membership-fees.php</files>
  <action>
Add the following methods to the MembershipFees class:

1. **parse_age_group(string $leeftijdsgroep): ?string**
   - Normalize input: strip " Meiden" and " Vrouwen" suffixes using preg_replace('/\s+(Meiden|Vrouwen)$/i', '', trim($leeftijdsgroep))
   - Handle "Senioren" (case-insensitive) -> return 'senior'
   - Extract number from "Onder X" format using preg_match('/^Onder\s+(\d+)$/i', $normalized, $matches)
   - Map age ranges:
     - 6-7 -> 'mini'
     - 8-11 -> 'pupil'
     - 12-19 -> 'junior'
   - Return null for unrecognized formats

2. **get_current_teams(int $person_id): array**
   - Get work_history ACF repeater field: get_field('work_history', $person_id) ?: []
   - Loop through entries, check for 'team' key
   - Check is_current flag and end_date (if set, must be in future)
   - Return array of unique team IDs (integers)
   - Use existing pattern from class-rest-commissies.php lines 219-240

3. **is_recreational_team(int $team_id): bool**
   - Get post: get_post($team_id)
   - Validate it exists and is 'team' post type
   - Check if post_title contains "recreant" OR "walking football" (case-insensitive using stripos)
   - Return boolean

4. **is_donateur(int $person_id): bool**
   - Get werkfuncties: get_field('werkfuncties', $person_id) ?: []
   - Return false if empty
   - Return true only if count is 1 AND contains 'Donateur'
   - Pattern from PersonDetail.jsx lines 91-92

Add PHPDoc comments for each method following existing class style.
  </action>
  <verify>
Manually verify by reading the file:
- parse_age_group method exists with preg_match for "Onder X" format
- get_current_teams method exists with work_history field access
- is_recreational_team method exists with stripos checks
- is_donateur method exists with werkfuncties check
  </verify>
  <done>
Four helper methods added to MembershipFees class with proper PHPDoc comments and following established patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add main calculate_fee method</name>
  <files>includes/class-membership-fees.php</files>
  <action>
Add the calculate_fee method to the MembershipFees class:

**calculate_fee(int $person_id): ?array**

Return format (on success):
```php
[
    'category'     => 'junior', // mini|pupil|junior|senior|recreant|donateur
    'base_fee'     => 230,      // amount from settings
    'leeftijdsgroep' => 'Onder 14', // original value
    'person_id'    => $person_id,
]
```

Return null if person cannot be calculated (no category applies).

Implementation logic (following CONTEXT.md priority: Youth > Recreant > Donateur):

1. Get leeftijdsgroep: get_field('leeftijdsgroep', $person_id)

2. Parse age group: $category = $this->parse_age_group($leeftijdsgroep)

3. If $category is 'mini', 'pupil', or 'junior':
   - Return immediately with that category and corresponding fee
   - Youth always wins regardless of other factors

4. If $category is 'senior':
   - Get current teams: $teams = $this->get_current_teams($person_id)
   - If no teams, check donateur status (step 6)
   - Check each team: if ANY is recreational -> candidate for recreant fee
   - But if ANY is non-recreational (regular senior team) -> use senior fee (higher fee wins)
   - Only if ALL teams are recreational -> use recreant fee
   - Return with 'senior' or 'recreant' category

5. If no leeftijdsgroep or parse failed ($category is null):
   - Get current teams
   - If has teams -> cannot calculate (no age group but has team = data issue, exclude)
   - If no teams and is_donateur() -> use donateur fee
   - Otherwise -> return null (exclude from calculations)

6. For donateur path:
   - Only applies if no valid age group
   - Return with 'donateur' category and donateur fee

Use $this->get_fee($category) to retrieve the configured fee amount.
  </action>
  <verify>
Read includes/class-membership-fees.php and verify:
- calculate_fee method exists
- Returns array with category, base_fee, leeftijdsgroep, person_id keys
- Returns null for excluded members
- Priority order: Youth > Recreant > Donateur is respected
  </verify>
  <done>
calculate_fee method implemented with correct priority logic, returning category and fee amount or null for excluded members.
  </done>
</task>

<task type="auto">
  <name>Task 3: Build and deploy</name>
  <files>dist/</files>
  <action>
1. Run npm run build to ensure frontend still compiles (no changes to frontend, but verify no regressions)
2. Deploy to production using bin/deploy.sh
3. Clear caches on production
  </action>
  <verify>
- npm run build completes without errors
- bin/deploy.sh completes successfully
- Production site loads without errors
  </verify>
  <done>
Build succeeds, deployed to production, caches cleared.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Read includes/class-membership-fees.php and confirm all new methods exist
2. Verify method signatures match specifications
3. Verify priority logic in calculate_fee is correct
4. Production deployment successful
</verification>

<success_criteria>
- parse_age_group correctly maps all age group formats to fee categories
- get_current_teams retrieves teams from work_history ACF field
- is_recreational_team detects recreant/walking football teams
- is_donateur detects members with only Donateur function
- calculate_fee returns correct category and fee for all member types
- calculate_fee returns null for excluded members (no leeftijdsgroep + no teams + not donateur)
- Production deployment successful
</success_criteria>

<output>
After completion, create `.planning/phases/124-fee-calculation-engine/124-01-SUMMARY.md`
</output>
