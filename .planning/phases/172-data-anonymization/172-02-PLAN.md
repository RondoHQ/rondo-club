---
phase: 172-data-anonymization
plan: 02
type: execute
wave: 2
depends_on: ["172-01"]
files_modified:
  - includes/class-demo-export.php
autonomous: true

must_haves:
  truths:
    - "All person first_name, infix, and last_name fields contain fake Dutch names"
    - "All person email addresses in contact_info are replaced with fake emails"
    - "All person phone numbers in contact_info are replaced with fake Dutch phones"
    - "All person addresses are replaced with fake Dutch addresses"
    - "Person titles are regenerated from fake name fields"
    - "Discipline case titles containing person names are anonymized"
    - "Email comments have anonymized recipient addresses and content"
    - "Relationships between persons are preserved (refs unchanged)"
    - "Consistent identity: same person ref always gets the same fake data"
  artifacts:
    - path: "includes/class-demo-export.php"
      provides: "Anonymized export pipeline"
      contains: "anonymize_person"
  key_links:
    - from: "includes/class-demo-export.php"
      to: "includes/class-demo-anonymizer.php"
      via: "DemoAnonymizer instance used during export"
      pattern: "DemoAnonymizer"
    - from: "includes/class-demo-export.php"
      to: "export_people"
      via: "Anonymization applied inside export_people loop"
      pattern: "anonymize_person"
---

<objective>
Integrate the DemoAnonymizer into the export pipeline to replace all person PII with realistic Dutch fake data.

Purpose: The exported fixture must contain zero real personal information while maintaining realistic data structure and relationships. Every name, email, phone, and address must be fake.

Output: Modified DemoExport class that applies anonymization to all person PII during export, including derived data in discipline cases and comments.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/172-data-anonymization/172-01-SUMMARY.md
@includes/class-demo-export.php
@includes/class-demo-anonymizer.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Anonymize person PII in export_people</name>
  <files>includes/class-demo-export.php</files>
  <action>
Modify the DemoExport class to integrate the DemoAnonymizer:

**1. Add anonymizer instance:**
- Add `private $anonymizer;` property.
- In the `export()` method, right after the ref maps are built, instantiate the anonymizer: `$this->anonymizer = new \Rondo\Demo\DemoAnonymizer();`
- Add a WP_CLI log line: "Anonymizer initialized with seed..."

**2. Create `anonymize_person( array $person ): array` private method:**

This method takes a person array (as built by export_people) and replaces all PII:

```php
private function anonymize_person( $person ) {
    $ref = $person['_ref'];
    $gender = $person['acf']['gender'] ?? null;

    // Generate consistent fake identity for this person
    $identity = $this->anonymizer->generate_identity( $ref, $gender );

    // Replace name fields
    $person['acf']['first_name'] = $identity['first_name'];
    $person['acf']['infix'] = $identity['infix'];
    $person['acf']['last_name'] = $identity['last_name'];
    $person['acf']['nickname'] = null; // Strip nicknames

    // Rebuild title from fake name
    $name_parts = array_filter([ $identity['first_name'], $identity['infix'], $identity['last_name'] ]);
    $person['title'] = implode( ' ', $name_parts );

    // Replace contact_info
    $person['acf']['contact_info'] = $this->anonymize_contact_info( $person['acf']['contact_info'], $identity );

    // Replace addresses
    $person['acf']['addresses'] = $this->anonymize_addresses( $person['acf']['addresses'] );

    // Replace Sportlink fields that contain PII
    $person['acf']['relatiecode'] = $this->anonymizer->generate_relatiecode();
    $person['acf']['freescout-id'] = null; // Strip external system ID
    $person['acf']['factuur-adres'] = null; // Strip invoice address (real address)
    $person['acf']['factuur-email'] = null; // Strip invoice email
    $person['acf']['factuur-referentie'] = null; // Strip invoice reference

    return $person;
}
```

**3. Create `anonymize_contact_info( array $contact_info, array $identity ): array` private method:**

Rebuild contact_info array with fake values:
- For each contact_info row:
  - If contact_type is "email": replace contact_value with `$identity['email']`. If there's a second email, generate a variant (e.g., first.last@voorbeeld.nl).
  - If contact_type is "phone" or "mobile": replace contact_value with a fake phone from the anonymizer.
  - If contact_type is "website", "linkedin", "twitter", "bluesky", "threads", "instagram", "facebook", or "other": set contact_value to null (strip social media links).
  - Preserve contact_type and contact_label.

**4. Create `anonymize_addresses( array $addresses ): array` private method:**

Replace each address with a fake Dutch address:
- For each address row:
  - Generate a new fake address from the anonymizer
  - Replace street with fake street + house number
  - Replace postal_code with fake Dutch postal code
  - Replace city with fake Dutch city
  - Keep address_label unchanged
  - Set state to null (not commonly used in Netherlands)
  - Set country to "Nederland"

**5. Apply anonymization in export_people loop:**

After building the `$person` array in the `export_people()` foreach loop, add:
```php
$person = $this->anonymize_person( $person );
```

This should be added right before `$people[] = $person;`.

**Important: Do NOT change the export_people method's query or field loading logic.** Only add the anonymization call at the end of each person's processing.
  </action>
  <verify>
Run `php -l includes/class-demo-export.php` to check for syntax errors. Grep for "anonymize_person" to confirm the method exists and is called.
  </verify>
  <done>
All person PII is anonymized during export: names, emails, phones, addresses, and Sportlink-specific fields are replaced with fake Dutch data. Person titles are rebuilt from fake names. The anonymizer is called for every person record.
  </done>
</task>

<task type="auto">
  <name>Task 2: Anonymize PII in discipline cases, comments, and todos</name>
  <files>includes/class-demo-export.php</files>
  <action>
Extend anonymization to entity types that contain or derive from person PII:

**1. Discipline case titles:**

Discipline case titles contain person names (format: "PersonName - TeamName - OpponentName - Date"). In the `export_discipline_cases()` method, after building the case object:

Create `anonymize_discipline_case( array $case ): array` private method:
- Extract the person ref from `$case['acf']['person']`
- If person ref exists, get the cached identity from the anonymizer: `$this->anonymizer->generate_identity( $person_ref )`
- Rebuild the title: replace the original person name part with the fake name, keep the rest (team name, opponent, date).
- Actually, since parsing the title is fragile, simply generate a new title from the fake name + match_description + match_date:
  ```php
  $name_parts = array_filter([ $identity['first_name'], $identity['infix'], $identity['last_name'] ]);
  $fake_name = implode( ' ', $name_parts );
  $case['title'] = sprintf( '%s - %s - %s', $fake_name, $case['acf']['match_description'] ?? '', $case['acf']['match_date'] ?? '' );
  ```
- Also randomize the `dossier_id` by generating a fake numeric string (7 digits + ".0").

Apply after building each case: `$case = $this->anonymize_discipline_case( $case );`

**2. Comment anonymization:**

Create `anonymize_comment( array $comment ): array` private method:

For `rondo_email` type comments:
- Replace `meta.email_recipient` with a fake email (get from the person's identity using the comment's `person` ref)
- Replace `meta.email_subject` with a generic subject (keep as-is if it's a template like "VOG herinnering" - these are template names, not PII)
- Replace `meta.email_content_snapshot` with a placeholder: "Demo email content" (the full rendered HTML contains real names and details)

For `rondo_note` type comments:
- Replace `content` with "Demo notitie" (notes may contain real information about people)

For `rondo_activity` type comments:
- Replace `content` with a generic activity description based on activity_type: "Activiteit gelogd" (activities may contain real details)

Apply after building each comment in export_comments: `$exported_comment = $this->anonymize_comment( $exported_comment );`

**3. Todo anonymization:**

Create `anonymize_todo( array $todo ): array` private method:
- Replace `title` with a generic todo title from a small list of Dutch task descriptions (e.g., "Terugbellen", "Opvolgen", "Mail sturen", "Afspraak maken", "Documenten checken", "Gegevens bijwerken", "Contact opnemen", "Uitnodiging sturen", "Formulier invullen", "Betaling controleren"). Pick based on seeded random using the todo's ref.
- Replace `content` with null (may contain PII)
- Replace `acf.notes` with null (WYSIWYG content may contain PII)

Apply after building each todo in export_todos: `$todo = $this->anonymize_todo( $todo );`

**4. Update meta.source:**

In the export() method where the meta section is built, change `'source'` from `'Production export'` to `'Production export, anonymized'` to indicate the fixture contains anonymized data.
  </action>
  <verify>
Run `php -l includes/class-demo-export.php` to check for syntax errors. Grep for "anonymize_discipline_case", "anonymize_comment", "anonymize_todo" to confirm all methods exist and are called.
  </verify>
  <done>
All entity types that may contain or derive from person PII are anonymized: discipline case titles rebuilt with fake names, email comment recipients and content anonymized, note content replaced, activity content replaced, todo titles and content replaced. The meta.source field indicates anonymization was applied.
  </done>
</task>

</tasks>

<verification>
1. `php -l includes/class-demo-export.php` returns "No syntax errors"
2. All anonymization methods exist: anonymize_person, anonymize_contact_info, anonymize_addresses, anonymize_discipline_case, anonymize_comment, anonymize_todo
3. Each anonymization method is called in its corresponding export method
4. The anonymizer is instantiated in the export() method
5. Person titles are rebuilt from fake name fields (not using real names)
6. Contact info emails and phones are replaced with fake values
7. Social media links are stripped (set to null)
8. Addresses are replaced with fake Dutch addresses
9. Discipline case titles use fake person names
10. Email comment recipients are anonymized
11. Note and activity content is replaced with generic text
12. Todo titles and content are anonymized
13. meta.source says "Production export, anonymized"
</verification>

<success_criteria>
The export pipeline produces a fixture where all person PII is replaced with realistic Dutch fake data. No real names, emails, phone numbers, or addresses appear anywhere in the fixture. Discipline case titles, email recipients, note content, and todo content are all anonymized. Data relationships (refs) are preserved unchanged.
</success_criteria>

<output>
After completion, create `.planning/phases/172-data-anonymization/172-02-SUMMARY.md`
</output>
