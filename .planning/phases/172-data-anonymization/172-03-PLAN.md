---
phase: 172-data-anonymization
plan: 03
type: execute
wave: 2
depends_on: ["172-01"]
files_modified:
  - includes/class-demo-export.php
autonomous: true

must_haves:
  truths:
    - "No photo or avatar references appear in the exported fixture"
    - "Nikki financial amounts are replaced with plausible fake values"
    - "Fee snapshot and forecast data uses fake amounts"
    - "Discipline case administrative fees are replaced with fake values"
    - "VOG email templates in settings have PII stripped"
    - "The fixture contains no real financial data"
  artifacts:
    - path: "includes/class-demo-export.php"
      provides: "Photo stripping and financial anonymization"
      contains: "anonymize_financials"
  key_links:
    - from: "includes/class-demo-export.php"
      to: "export_person_post_meta"
      via: "Financial anonymization applied to nikki and fee data"
      pattern: "anonymize_financials"
---

<objective>
Strip photos/avatars from the export and replace all financial amounts with plausible fake values.

Purpose: Photos cannot be anonymized (they ARE the person's identity) so they must be excluded entirely. Financial data (Nikki billing amounts, fee snapshots, discipline case fees) must be replaced with plausible fake values so the demo looks realistic without exposing real billing information.

Output: Modified export pipeline that excludes all photo references and replaces financial data with fake amounts.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/172-data-anonymization/172-01-SUMMARY.md
@.planning/phases/172-data-anonymization/172-02-SUMMARY.md
@includes/class-demo-export.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Strip photos and avatars from export</name>
  <files>includes/class-demo-export.php</files>
  <action>
Ensure no photo or media attachment data appears in the exported fixture:

**1. Person photo fields:**

In the `anonymize_person()` method (created in plan 02), add these fields to be explicitly nulled:
- `$person['acf']['datum-foto'] = null;` — Strip photo date (no photo = no photo date)

Note: The current export already does NOT include a photo/image field in the ACF export (there's no `photo` or `featured_image` field being exported). Verify this by checking the export_people method. The WordPress featured image (post thumbnail) is also not exported. However, to be safe and future-proof, add explicit exclusion.

After the `anonymize_person()` call in export_people, also ensure:
- If there's any `_thumbnail_id` in post_meta, it should NOT be exported. Check `export_person_post_meta()` and verify it does not export `_thumbnail_id`. If it does, remove it.

**2. Team/Commissie contact info cleanup:**

In `export_teams()` and `export_commissies()`, the contact_info repeater may contain email/phone for team contacts. These are organizational contacts, not personal PII, but for safety:
- Team and commissie names are preserved per EXPORT-06 (no anonymization needed)
- Team/commissie contact_info: strip any email/phone values (replace with null) since they may be personal contacts of team leaders
- Create a helper `strip_org_contact_info( array $contact_info ): array` that:
  - For each contact row:
    - If contact_type is "email": replace value with "team@rondo-demo.nl" (generic)
    - If contact_type is "phone" or "mobile": replace value with "06-00000000"
    - If contact_type is "website": keep as-is (websites are public)
    - Otherwise: set value to null
  - Return the modified array
- Apply to both teams and commissies after building their objects.
  </action>
  <verify>
Grep the export file for "datum-foto" to confirm it's set to null in anonymize_person. Grep for "strip_org_contact_info" to confirm the method exists and is called for teams and commissies.
  </verify>
  <done>
No photo references, photo dates, or real contact information for teams/commissies appear in the export. Person photos are excluded (no photo field exported, datum-foto nulled). Team/commissie contact info is genericized.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fake financial amounts for Nikki data, fee snapshots, and discipline fees</name>
  <files>includes/class-demo-export.php</files>
  <action>
Replace all financial data with plausible fake values:

**1. Create `anonymize_financials( array $post_meta ): array` private method:**

This method processes the post_meta array from export_person_post_meta and replaces financial fields:

For Nikki fields (`_nikki_YYYY_total` and `_nikki_YYYY_saldo`):
- `_nikki_YYYY_total`: Replace with a random plausible amount. Use `mt_rand()` to pick from a realistic range:
  - 70% chance: amount between 100 and 300 (typical fee range)
  - 20% chance: amount between 50 and 100 (lower fees like donateur/recreant)
  - 10% chance: 0 (no billing)
  - Format as string (matching original format)
- `_nikki_YYYY_saldo`: Replace with a plausible balance:
  - 80% chance: "0" (most people pay)
  - 15% chance: positive amount 10-100 (owes money)
  - 5% chance: negative amount -10 to -50 (overpaid)
  - Format as string

For fee snapshot fields (`_fee_snapshot_SEASON`):
- These contain serialized PHP arrays with fee calculation details
- Replace with a fake serialized array containing:
  ```php
  [
      'category' => 'demo',
      'base_amount' => mt_rand(50, 300),
      'pro_rata_factor' => 1.0,
      'family_discount' => 0,
      'final_amount' => mt_rand(50, 300),
  ]
  ```
  - Serialize with `maybe_serialize()` or `serialize()` to match the original format

For fee forecast fields (`_fee_forecast_SEASON`):
- Same approach as fee snapshots but with slightly different amounts

**2. Apply anonymize_financials in export_people:**

In the `anonymize_person()` method (from plan 02), add:
```php
$person['post_meta'] = $this->anonymize_financials( $person['post_meta'] );
```

**3. Discipline case administrative fees:**

In the `anonymize_discipline_case()` method (from plan 02), add:
- Replace `$case['acf']['administrative_fee']` with a random plausible fee: mt_rand(1, 5) * 10 + mt_rand(0, 1) * 0.60 — typical values like 10.00, 19.60, 30.00, 40.60, 50.00

**4. VOG email settings anonymization:**

In `export_settings()`, after building the settings array, strip PII from VOG email templates and sender info:
- Replace `rondo_vog_from_email` with "vog@rondo-demo.nl"
- Replace `rondo_vog_from_name` with the club name from `rondo_club_name` setting (or "Demo Club")
- For the 4 VOG email templates (`rondo_vog_template_new`, `rondo_vog_template_renewal`, `rondo_vog_reminder_template_new`, `rondo_vog_reminder_template_renewal`):
  - If the value is not null, replace with a generic HTML template: `"<p>Dit is een demo e-mailtemplate.</p>"` (keeps the structure but removes real content that may contain names/addresses)
  </action>
  <verify>
Run `php -l includes/class-demo-export.php` to check for syntax errors. Grep for "anonymize_financials" to confirm the method exists and is called. Grep for "rondo-demo.nl" to confirm VOG email settings are anonymized.
  </verify>
  <done>
All financial data is replaced with plausible fake values: Nikki totals and balances use random realistic amounts, fee snapshots/forecasts contain fake calculation data, discipline case fees are randomized, and VOG email settings have PII stripped.
  </done>
</task>

</tasks>

<verification>
1. `php -l includes/class-demo-export.php` returns "No syntax errors"
2. datum-foto is set to null in anonymize_person
3. No _thumbnail_id or photo-related post_meta is exported
4. Team/commissie contact info uses generic values (team@rondo-demo.nl, 06-00000000)
5. Nikki _total fields contain random plausible amounts (not original values)
6. Nikki _saldo fields contain random plausible balances
7. Fee snapshot/forecast fields contain fake serialized data
8. Discipline case administrative_fee fields contain random amounts
9. VOG email sender uses "vog@rondo-demo.nl"
10. VOG email templates replaced with demo placeholder
11. The complete fixture contains no real financial amounts or photo data
</verification>

<success_criteria>
The exported fixture is completely free of real photos and real financial data. All Nikki billing amounts, fee calculations, and discipline case fees are replaced with plausible fake values. VOG email templates and settings are anonymized. Team/commissie contact info is genericized.
</success_criteria>

<output>
After completion, create `.planning/phases/172-data-anonymization/172-03-SUMMARY.md`
</output>
