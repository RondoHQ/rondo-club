# Plan 69-01: Dashboard Customization

## Objective

Implement user-configurable dashboard with card visibility toggles and drag-and-drop reordering, persisted to WordPress user meta.

## Scope

- Add REST API endpoints for reading/writing dashboard settings
- Create React hook for dashboard settings management
- Add settings gear icon to Dashboard that opens customization modal
- Implement show/hide toggles for each card type
- Implement drag-and-drop reordering with @dnd-kit
- Apply user settings to Dashboard rendering
- Handle defaults when no settings exist

## Current State

The Dashboard (`src/pages/Dashboard.jsx`) renders 6 card types in a fixed layout:
1. **Stats row** (5 stat cards) - Total people, Organizations, Events, Open todos, Awaiting
2. **Row 1** - Upcoming Reminders, Open Todos, Awaiting Response
3. **Row 2** - Today's Meetings (conditional), Recently Contacted, Recently Edited
4. **Row 3** - Favorites

Cards are hardcoded in JSX. No existing settings for card visibility or order.

## Tasks

### Task 1: Backend - Dashboard Settings API

**Files:** `includes/class-rest-api.php`

Add two REST endpoints following the theme-preferences pattern:

1. `GET /stadion/v1/user/dashboard-settings` - Return user's dashboard settings:
   ```json
   {
     "visible_cards": ["stats", "reminders", "todos", "awaiting", "meetings", "recent-contacted", "recent-edited", "favorites"],
     "card_order": ["stats", "reminders", "todos", "awaiting", "meetings", "recent-contacted", "recent-edited", "favorites"]
   }
   ```

2. `PATCH /stadion/v1/user/dashboard-settings` - Update settings:
   - Accept `visible_cards` array (strings)
   - Accept `card_order` array (strings)
   - Validate card IDs against allowed list
   - Store in user meta: `stadion_dashboard_visible_cards`, `stadion_dashboard_card_order`

**Validation:** Card IDs must be from: `stats`, `reminders`, `todos`, `awaiting`, `meetings`, `recent-contacted`, `recent-edited`, `favorites`

### Task 2: Frontend API Client

**Files:** `src/api/client.js`

Add to `prmApi` object:
```javascript
getDashboardSettings: () => api.get('/stadion/v1/user/dashboard-settings'),
updateDashboardSettings: (settings) => api.patch('/stadion/v1/user/dashboard-settings', settings),
```

### Task 3: Dashboard Settings Hook

**Files:** `src/hooks/useDashboard.js`

Add new hooks:
```javascript
export function useDashboardSettings() {
  return useQuery({
    queryKey: ['dashboardSettings'],
    queryFn: async () => {
      const response = await prmApi.getDashboardSettings();
      return response.data;
    },
  });
}

export function useUpdateDashboardSettings() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: (settings) => prmApi.updateDashboardSettings(settings),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['dashboardSettings'] });
    },
  });
}
```

### Task 4: Install @dnd-kit

**Command:** `npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities`

This library is lightweight, accessible, and supports touch/mobile.

### Task 5: Dashboard Customization Modal

**Files:** `src/components/DashboardCustomizeModal.jsx` (new file)

Create modal component with:
- List of cards with checkboxes for visibility
- Drag handles for reordering (using @dnd-kit)
- Card labels matching dashboard section titles
- "Reset to defaults" button
- Save/Cancel buttons

Card definitions:
```javascript
const CARD_DEFINITIONS = [
  { id: 'stats', label: 'Statistics', description: 'People, organizations, events counts' },
  { id: 'reminders', label: 'Upcoming Reminders', description: 'Important dates coming up' },
  { id: 'todos', label: 'Open Todos', description: 'Tasks to complete' },
  { id: 'awaiting', label: 'Awaiting Response', description: 'Waiting for replies' },
  { id: 'meetings', label: "Today's Meetings", description: 'Calendar events for today' },
  { id: 'recent-contacted', label: 'Recently Contacted', description: 'Recent activity contacts' },
  { id: 'recent-edited', label: 'Recently Edited', description: 'Recently modified people' },
  { id: 'favorites', label: 'Favorites', description: 'Starred contacts' },
];
```

### Task 6: Add Settings Button to Dashboard

**Files:** `src/pages/Dashboard.jsx`

Add gear icon button to Dashboard header area that opens the customization modal:
- Import Settings icon from lucide-react
- Add DashboardCustomizeModal component
- Add state for modal open/close

### Task 7: Refactor Dashboard to Use Settings

**Files:** `src/pages/Dashboard.jsx`

1. Fetch dashboard settings with `useDashboardSettings()`
2. Create a card rendering map keyed by card ID
3. Filter and sort cards based on settings
4. Render cards in user-specified order, skipping hidden ones
5. Default behavior when no settings: show all cards in original order

Structure change:
```jsx
const cardRenderers = {
  'stats': () => <StatsRow stats={stats} />,
  'reminders': () => <RemindersCard reminders={upcoming_reminders} />,
  'todos': () => <TodosCard todos={dashboardTodos} onToggle={...} onView={...} />,
  // ... etc
};

// Render based on settings
const cardsToRender = (settings?.visible_cards || Object.keys(cardRenderers))
  .filter(id => cardRenderers[id]);

const orderedCards = (settings?.card_order || cardsToRender)
  .filter(id => cardsToRender.includes(id));
```

### Task 8: Extract Card Components

**Files:** `src/pages/Dashboard.jsx`

Extract each dashboard section into its own component for cleaner rendering:
- `StatsRow` - The 5 stat cards
- `RemindersCard` - Upcoming reminders section
- `TodosCard` - Open todos section
- `AwaitingCard` - Awaiting response section
- `MeetingsCard` - Today's meetings section
- `RecentContactedCard` - Recently contacted section
- `RecentEditedCard` - Recently edited section
- `FavoritesCard` - Favorites section

Keep these in Dashboard.jsx to avoid unnecessary file proliferation.

## Verification

1. Dashboard loads with default layout when no settings saved
2. Gear icon visible and opens customization modal
3. Modal shows all 8 card types with checkboxes and drag handles
4. Toggling checkbox hides/shows corresponding card
5. Dragging reorders cards
6. Settings persist after page refresh
7. Reset to defaults works
8. Works on both desktop and mobile (touch drag)
9. `npm run build` succeeds
10. `npm run lint` passes

## Success Criteria

- Users can hide any dashboard card
- Users can reorder dashboard cards via drag-and-drop
- Settings persist per-user via WordPress user meta
- Dashboard respects saved settings on load
- No regression in dashboard functionality
- Mobile-friendly drag-and-drop

## Output

- Modified: `includes/class-rest-api.php`
- Modified: `src/api/client.js`
- Modified: `src/hooks/useDashboard.js`
- Modified: `src/pages/Dashboard.jsx`
- Created: `src/components/DashboardCustomizeModal.jsx`
- Updated: `package.json` (new dependency)
