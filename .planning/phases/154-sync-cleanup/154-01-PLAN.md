---
phase: 154-sync-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /Users/joostdevalk/Code/rondo/rondo-sync/lib/rondo-club-db.js
  - /Users/joostdevalk/Code/rondo/rondo-sync/steps/download-teams-from-sportlink.js
  - /Users/joostdevalk/Code/rondo/rondo-sync/steps/submit-rondo-club-work-history.js
  - /Users/joostdevalk/Code/rondo/rondo-sync/steps/submit-rondo-club-commissie-work-history.js
  - /Users/joostdevalk/Code/rondo/rondo-sync/pipelines/sync-individual.js
  - /Users/joostdevalk/Code/rondo/rondo-sync/docs/database-schema.md
  - /Users/joostdevalk/Code/rondo/rondo-sync/docs/pipeline-teams.md
autonomous: true

must_haves:
  truths:
    - "The rondo-sync codebase contains zero occurrences of 'Speler', 'Staflid', or 'Lid' as default/fallback values in JavaScript files"
    - "The sportlink_team_members table no longer has a member_type column"
    - "The sync passes through Sportlink-provided role descriptions without modification or classification"
    - "Entries with missing role descriptions are skipped with a logged warning instead of silently using a fallback"
  artifacts:
    - path: "/Users/joostdevalk/Code/rondo/rondo-sync/lib/rondo-club-db.js"
      provides: "Simplified getTeamMemberRole returning role_description or null, upsertTeamMembers without member_type, migration to drop member_type column"
      contains: "DROP COLUMN member_type"
    - path: "/Users/joostdevalk/Code/rondo/rondo-sync/steps/download-teams-from-sportlink.js"
      provides: "Team member download without member_type field or role fallbacks"
    - path: "/Users/joostdevalk/Code/rondo/rondo-sync/steps/submit-rondo-club-work-history.js"
      provides: "Work history sync without determineJobTitleFallback or fallback parameters"
    - path: "/Users/joostdevalk/Code/rondo/rondo-sync/steps/submit-rondo-club-commissie-work-history.js"
      provides: "Commissie work history without 'Lid' fallback values"
  key_links:
    - from: "steps/download-teams-from-sportlink.js"
      to: "lib/rondo-club-db.js upsertTeamMembers"
      via: "allMembers array without member_type field"
      pattern: "role_description.*RoleFunctionDescription"
    - from: "steps/submit-rondo-club-work-history.js"
      to: "lib/rondo-club-db.js getTeamMemberRole"
      via: "getJobTitleForTeam calls getTeamMemberRole directly"
      pattern: "return getTeamMemberRole"
---

<objective>
Remove all hardcoded role fallback values ("Speler", "Staflid", "Lid") from the rondo-sync codebase. After this cleanup, rondo-sync passes through whatever role descriptions Sportlink provides without modification or classification. Rondo Club handles role classification on its end via configured settings (Phase 152/153).

Purpose: This is the final phase of v20.0 Configurable Roles. It completes the decoupling of role classification from the sync layer, ensuring rondo-sync is club-agnostic.

Output: Clean rondo-sync codebase with no hardcoded role values, simplified database schema (no member_type column), and updated documentation.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/joostdevalk/Code/rondo/rondo-club/.planning/ROADMAP.md
@/Users/joostdevalk/Code/rondo/rondo-club/.planning/phases/154-sync-cleanup/154-CONTEXT.md
@/Users/joostdevalk/Code/rondo/rondo-club/.planning/phases/154-sync-cleanup/154-RESEARCH.md
@/Users/joostdevalk/Code/rondo/rondo-sync/CLAUDE.md
@/Users/joostdevalk/Code/rondo/rondo-sync/lib/rondo-club-db.js
@/Users/joostdevalk/Code/rondo/rondo-sync/steps/download-teams-from-sportlink.js
@/Users/joostdevalk/Code/rondo/rondo-sync/steps/submit-rondo-club-work-history.js
@/Users/joostdevalk/Code/rondo/rondo-sync/steps/submit-rondo-club-commissie-work-history.js
@/Users/joostdevalk/Code/rondo/rondo-sync/pipelines/sync-individual.js
</context>

<important>
This plan modifies the rondo-sync project at /Users/joostdevalk/Code/rondo/rondo-sync/ — NOT rondo-club.
All git operations (add, commit, push) must run from /Users/joostdevalk/Code/rondo/rondo-sync/.
The planning directory (.planning/) is in rondo-club, but all code changes are in rondo-sync.
</important>

<tasks>

<task type="auto">
  <name>Task 1: Clean up database layer — remove member_type and simplify role lookup</name>
  <files>
    /Users/joostdevalk/Code/rondo/rondo-sync/lib/rondo-club-db.js
  </files>
  <action>
    Modify lib/rondo-club-db.js to remove all member_type references and simplify role handling:

    1. **CREATE TABLE statement (line ~119):** Remove `member_type TEXT NOT NULL,` from the `sportlink_team_members` CREATE TABLE statement. The column is no longer stored. Note: existing databases already have this column — the migration (step 2) handles removal.

    2. **Migration in initDb() (after line ~264, after existing migrations):** Add a migration block to drop the member_type column from existing databases:
       ```javascript
       // Remove deprecated member_type column (v20.0 Phase 154)
       const teamMemberColumns = db.prepare('PRAGMA table_info(sportlink_team_members)').all();
       if (teamMemberColumns.some(col => col.name === 'member_type')) {
         db.exec('ALTER TABLE sportlink_team_members DROP COLUMN member_type');
       }
       ```

    3. **computeTeamMemberHash() (line ~1403):** Remove the `memberType` parameter and the `member_type` field from the hash payload. New signature: `computeTeamMemberHash(sportlinkTeamId, sportlinkPersonId, roleDescription)`. Hash payload becomes `{ sportlink_team_id, sportlink_person_id, role_description }`.

    4. **upsertTeamMembers() (line ~1417):** Remove all `member_type` references:
       - Remove `member_type` from the INSERT column list, VALUES list, and ON CONFLICT UPDATE SET clause
       - Remove `member_type` from the row mapping (line ~1452)
       - Update the computeTeamMemberHash call to drop the member_type argument (line ~1454-1458)
       - Update the JSDoc to remove member_type from the member object description

    5. **getTeamMemberRole() (line ~1475):** Simplify to:
       ```javascript
       function getTeamMemberRole(db, knvbId, teamName) {
         const stmt = db.prepare(`
           SELECT tm.role_description
           FROM sportlink_team_members tm
           JOIN stadion_teams t ON tm.sportlink_team_id = t.sportlink_id
           WHERE tm.sportlink_person_id = ?
             AND t.team_name = ? COLLATE NOCASE
         `);
         const row = stmt.get(knvbId, teamName);
         return row?.role_description || null;
       }
       ```
       Remove the `member_type` from the SELECT and delete all fallback logic (lines ~1487-1494).

    6. **getTeamMemberCounts() (line ~1526-1539):** Delete this entire function. It is exported but never imported or called anywhere in the codebase — confirmed dead code. The player/staff distinction is now handled by Rondo Club's configured role settings.

    7. **Module exports (line ~2824):** Remove `getTeamMemberCounts` from the exports object. Keep `computeTeamMemberHash`, `upsertTeamMembers`, and `getTeamMemberRole`.
  </action>
  <verify>
    Run these grep checks from /Users/joostdevalk/Code/rondo/rondo-sync/:
    - `grep -n "member_type" lib/rondo-club-db.js` should return zero results
    - `grep -n "getTeamMemberCounts" lib/rondo-club-db.js` should return zero results
    - `grep -n "'Speler'" lib/rondo-club-db.js` should return zero results
    - `grep -n "'Staflid'" lib/rondo-club-db.js` should return zero results
    - Verify the file has no syntax errors: `node -e "require('./lib/rondo-club-db')"` from /Users/joostdevalk/Code/rondo/rondo-sync/
  </verify>
  <done>
    - sportlink_team_members CREATE TABLE has no member_type column
    - Migration code exists to DROP COLUMN member_type on existing databases
    - computeTeamMemberHash takes 3 params (no memberType)
    - upsertTeamMembers processes members without member_type field
    - getTeamMemberRole returns role_description or null (no fallbacks)
    - getTeamMemberCounts is fully removed (function + export)
    - File loads without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean up sync scripts — remove fallbacks, update callers, update docs</name>
  <files>
    /Users/joostdevalk/Code/rondo/rondo-sync/steps/download-teams-from-sportlink.js
    /Users/joostdevalk/Code/rondo/rondo-sync/steps/submit-rondo-club-work-history.js
    /Users/joostdevalk/Code/rondo/rondo-sync/steps/submit-rondo-club-commissie-work-history.js
    /Users/joostdevalk/Code/rondo/rondo-sync/pipelines/sync-individual.js
    /Users/joostdevalk/Code/rondo/rondo-sync/docs/database-schema.md
    /Users/joostdevalk/Code/rondo/rondo-sync/docs/pipeline-teams.md
  </files>
  <action>
    **A. steps/download-teams-from-sportlink.js:**

    1. Players section (line ~168-177): Remove `member_type: 'player'` from the object pushed to allMembers. Replace `role_description: player.RoleFunctionDescription || 'Speler'` with a skip-and-warn pattern:
       ```javascript
       if (!player.RoleFunctionDescription) {
         logDebug(`Warning: Player ${personId} in team ${team.team_name} has no role description, skipping`);
         continue;
       }
       allMembers.push({
         sportlink_team_id: team.sportlink_id,
         sportlink_person_id: personId,
         role_description: player.RoleFunctionDescription
       });
       ```

    2. Staff section (line ~194-203): Same pattern — remove `member_type: 'staff'`, replace `role_description: person.FunctionDescription || 'Staflid'` with skip-and-warn:
       ```javascript
       if (!person.FunctionDescription) {
         logDebug(`Warning: Staff ${personId} in team ${team.team_name} has no role description, skipping`);
         continue;
       }
       allMembers.push({
         sportlink_team_id: team.sportlink_id,
         sportlink_person_id: personId,
         role_description: person.FunctionDescription
       });
       ```
       Note: Use `logDebug` (the existing logging function in this file), not `logVerbose`.

    **B. steps/submit-rondo-club-work-history.js:**

    1. Delete `determineJobTitleFallback()` function entirely (lines ~77-84, including JSDoc).

    2. Simplify `getJobTitleForTeam()` (lines ~86-103): Remove `fallbackKernelGameActivities` parameter. Body becomes:
       ```javascript
       function getJobTitleForTeam(db, knvbId, teamName) {
         return getTeamMemberRole(db, knvbId, teamName);
       }
       ```
       Update JSDoc to reflect new signature (no fallback param, returns string or null).

    3. Update `buildWorkHistoryEntry()` (line ~112): Remove the default parameter `jobTitle = 'Speler'`. Make jobTitle required (no default). Update JSDoc.

    4. Update `syncWorkHistoryForMember()` function signature (line ~178): Remove the `fallbackKernelGameActivities = ''` parameter. Update JSDoc.

    5. Update call sites of `getJobTitleForTeam` at lines ~247 and ~272: Remove the `fallbackKernelGameActivities` argument. Add null-check with skip-and-warn after getting jobTitle:
       ```javascript
       const jobTitle = getJobTitleForTeam(db, knvb_id, teamName);
       if (!jobTitle) {
         logVerbose(`Warning: No role description for ${knvb_id} in team ${teamName}, skipping`);
         continue;
       }
       ```

    6. Check ALL callers of `syncWorkHistoryForMember` across the codebase (grep for it) and remove the `fallbackKernelGameActivities` argument from each call site.

    **C. steps/submit-rondo-club-commissie-work-history.js:**

    1. `buildWorkHistoryEntry()` (line ~55): Remove the `|| 'Lid'` fallback. The function should require jobTitle. Add a guard at the top of the function:
       ```javascript
       if (!jobTitle) {
         return null;  // Caller handles skip
       }
       ```

    2. Call sites at lines ~169, ~207: Replace `commissie.role_name || 'Lid'` with just `commissie.role_name`. Add skip-and-warn before the call when role_name is missing:
       ```javascript
       if (!commissie.role_name) {
         logVerbose(`Warning: Commissie "${commissie.commissie_name}" has no role_name for ${knvb_id}, skipping`);
         continue;
       }
       ```

    3. Log message at line ~214: Replace `commissie.role_name || 'Lid'` with just `commissie.role_name` in the logVerbose call. Since we now skip entries without role_name before reaching this line, it will always have a value.

    **D. pipelines/sync-individual.js (line ~319):**

    Replace `c.role_name || 'Lid'` with `c.role_name || '(no role)'` in the console.log display line. This is a dry-run display line, not a data submission — use a descriptive placeholder instead of a hardcoded role name.

    **E. Documentation updates:**

    1. docs/database-schema.md: Remove the `member_type` row from the sportlink_team_members table documentation (line ~277). Update the example query (line ~648) to remove `member_type` from the SELECT.

    2. docs/pipeline-teams.md: Update the bullet point (line ~41) that mentions `member_type (player/staff)` — remove it from the field list.
  </action>
  <verify>
    Run these grep checks from /Users/joostdevalk/Code/rondo/rondo-sync/:
    - `grep -rn "'Speler'" steps/ lib/ pipelines/` should return zero results
    - `grep -rn "'Staflid'" steps/ lib/ pipelines/` should return zero results
    - `grep -rn "|| 'Lid'" steps/ lib/ pipelines/` should return zero results
    - `grep -rn "member_type" steps/ lib/ pipelines/` should return zero results
    - `grep -rn "determineJobTitleFallback" steps/` should return zero results
    - `grep -rn "fallbackKernelGameActivities" steps/` should return zero results
    - Verify all files load without syntax errors:
      - `node -e "require('./steps/download-teams-from-sportlink')"`
      - `node -e "require('./steps/submit-rondo-club-work-history')"`
      - `node -e "require('./steps/submit-rondo-club-commissie-work-history')"`
    - `grep -n "member_type" docs/database-schema.md` should return zero results
  </verify>
  <done>
    - download-teams-from-sportlink.js: No member_type field, no 'Speler'/'Staflid' fallbacks, skips entries without role descriptions
    - submit-rondo-club-work-history.js: No determineJobTitleFallback function, no fallbackKernelGameActivities parameter, getJobTitleForTeam delegates directly to getTeamMemberRole, buildWorkHistoryEntry has no default jobTitle
    - submit-rondo-club-commissie-work-history.js: No 'Lid' fallback values, skips entries without role_name
    - sync-individual.js: No 'Lid' fallback in display output
    - database-schema.md and pipeline-teams.md updated to reflect removed member_type column
    - All files load without syntax errors
  </done>
</task>

</tasks>

<verification>
Final codebase-wide verification from /Users/joostdevalk/Code/rondo/rondo-sync/:

1. `grep -rn "'Speler'" --include="*.js" .` returns zero results (no .planning/ or docs hits expected)
2. `grep -rn "'Staflid'" --include="*.js" .` returns zero results
3. `grep -rn "|| 'Lid'" --include="*.js" .` returns zero results
4. `grep -rn "member_type" --include="*.js" .` returns zero results
5. `grep -rn "determineJobTitleFallback" --include="*.js" .` returns zero results
6. `grep -rn "getTeamMemberCounts" --include="*.js" .` returns zero results
7. All modified files load without Node.js syntax errors
8. Documentation reflects the schema change
</verification>

<success_criteria>
- The rondo-sync codebase contains zero hardcoded fallback values for Speler, Staflid, or Lid roles in JavaScript files
- The member_type column is removed from CREATE TABLE and has a migration to DROP it from existing databases
- The sync passes through Sportlink-provided role descriptions without modification
- Missing role descriptions trigger skip-and-warn behavior (logged warning, entry skipped, sync continues)
- The dead getTeamMemberCounts function is removed
- Documentation updated to reflect schema changes
- All files load without syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/154-sync-cleanup/154-01-SUMMARY.md` using the summary template.
Remember: git operations must run from /Users/joostdevalk/Code/rondo/rondo-sync/ (not rondo-club).
</output>
