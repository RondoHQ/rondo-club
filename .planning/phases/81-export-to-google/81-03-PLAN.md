---
phase: 81-export-to-google
plan: 03
type: execute
wave: 3
depends_on: ["81-01", "81-02"]
files_modified:
  - includes/class-google-contacts-export.php
  - includes/class-rest-google-contacts.php
  - src/pages/SettingsPage.jsx
autonomous: true

must_haves:
  truths:
    - "User can bulk export all unlinked contacts to Google with one action"
    - "Progress is shown during bulk export (X of Y exported)"
    - "Results summary shows counts (exported, skipped, failed)"
    - "Sequential processing avoids Google API rate limits"
  artifacts:
    - path: "includes/class-google-contacts-export.php"
      provides: "Bulk export method for all unlinked contacts"
      contains: "bulk_export_unlinked"
    - path: "includes/class-rest-google-contacts.php"
      provides: "REST endpoint for bulk export"
      contains: "register_rest_route.*bulk-export"
    - path: "src/pages/SettingsPage.jsx"
      provides: "Bulk export button in Google Contacts card"
      contains: "bulk-export"
  key_links:
    - from: "src/pages/SettingsPage.jsx"
      to: "/rondo/v1/google-contacts/bulk-export"
      via: "fetch/axios POST request"
      pattern: "google-contacts/bulk-export"
    - from: "includes/class-rest-google-contacts.php"
      to: "includes/class-google-contacts-export.php"
      via: "GoogleContactsExport::bulk_export_unlinked()"
      pattern: "bulk_export_unlinked"
---

<objective>
Add bulk export functionality that allows users to export all their existing unlinked Stadion contacts to Google Contacts in a single operation.

Purpose: Users may have existing contacts in Stadion that were created before connecting Google Contacts. This feature lets them push those contacts to Google without editing each one individually.
Output: REST endpoint for bulk export, backend bulk export method, and frontend button with progress display.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/81-export-to-google/81-CONTEXT.md
@.planning/phases/81-export-to-google/81-RESEARCH.md
@.planning/phases/81-export-to-google/81-01-SUMMARY.md
@.planning/phases/81-export-to-google/81-02-SUMMARY.md
@includes/class-google-contacts-export.php
@includes/class-rest-google-contacts.php
@src/pages/SettingsPage.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bulk export method to GoogleContactsExport class</name>
  <files>includes/class-google-contacts-export.php</files>
  <action>
Add a method to export all unlinked contacts for a user. This will be used by both the REST API and future WP-CLI commands (Phase 85).

**Add bulk_export_unlinked() method:**
```php
/**
 * Bulk export all contacts without a Google Contact ID for a user.
 *
 * Processes contacts sequentially to avoid rate limits.
 * Returns stats array with counts.
 *
 * @param callable|null $progress_callback Optional callback for progress updates.
 *                                         Receives (int $current, int $total, int $post_id).
 * @return array{total: int, exported: int, updated: int, skipped: int, failed: int, errors: array}
 */
public function bulk_export_unlinked( ?callable $progress_callback = null ): array {
    $stats = [
        'total'    => 0,
        'exported' => 0,  // New contacts created in Google
        'updated'  => 0,  // Existing contacts updated (shouldn't happen for unlinked, but track it)
        'skipped'  => 0,  // Already has google_contact_id (not unlinked)
        'failed'   => 0,
        'errors'   => [],
    ];

    // Verify user has readwrite access
    $connection = GoogleContactsConnection::get_connection( $this->user_id );
    if ( ! $connection || $connection['access_mode'] !== 'readwrite' ) {
        $stats['errors'][] = __( 'Google Contacts is not connected with read-write access.', 'stadion' );
        return $stats;
    }

    // Query all person posts for this user without _google_contact_id
    $args = [
        'post_type'      => 'person',
        'post_status'    => 'publish',
        'author'         => $this->user_id,
        'posts_per_page' => -1,
        'fields'         => 'ids',
        'meta_query'     => [
            'relation' => 'OR',
            [
                'key'     => '_google_contact_id',
                'compare' => 'NOT EXISTS',
            ],
            [
                'key'     => '_google_contact_id',
                'value'   => '',
                'compare' => '=',
            ],
        ],
    ];

    $query = new \WP_Query( $args );
    $post_ids = $query->posts;
    $stats['total'] = count( $post_ids );

    if ( $stats['total'] === 0 ) {
        return $stats;
    }

    // Process sequentially to avoid rate limits
    foreach ( $post_ids as $index => $post_id ) {
        // Progress callback
        if ( $progress_callback ) {
            $progress_callback( $index + 1, $stats['total'], $post_id );
        }

        // Double-check this contact doesn't have a google_contact_id
        // (could have been exported in parallel by save hook)
        $google_id = get_post_meta( $post_id, '_google_contact_id', true );
        if ( ! empty( $google_id ) ) {
            $stats['skipped']++;
            continue;
        }

        try {
            $result = $this->export_contact( $post_id );
            if ( $result ) {
                $stats['exported']++;
            } else {
                $stats['failed']++;
                $stats['errors'][] = sprintf(
                    __( 'Failed to export contact ID %d.', 'stadion' ),
                    $post_id
                );
            }
        } catch ( \Exception $e ) {
            $stats['failed']++;
            $stats['errors'][] = sprintf(
                __( 'Error exporting contact ID %d: %s', 'stadion' ),
                $post_id,
                $e->getMessage()
            );
        }

        // Small delay between requests to be nice to Google API
        // 100ms delay = max 10 requests/second, well under any rate limit
        usleep( 100000 );
    }

    return $stats;
}
```

**Add get_unlinked_count() helper method for UI display:**
```php
/**
 * Get count of contacts without a Google Contact ID.
 *
 * @return int Count of unlinked contacts.
 */
public function get_unlinked_count(): int {
    $args = [
        'post_type'      => 'person',
        'post_status'    => 'publish',
        'author'         => $this->user_id,
        'posts_per_page' => 1,
        'fields'         => 'ids',
        'meta_query'     => [
            'relation' => 'OR',
            [
                'key'     => '_google_contact_id',
                'compare' => 'NOT EXISTS',
            ],
            [
                'key'     => '_google_contact_id',
                'value'   => '',
                'compare' => '=',
            ],
        ],
    ];

    $query = new \WP_Query( $args );
    return $query->found_posts;
}
```
  </action>
  <verify>
Run `php -l includes/class-google-contacts-export.php` for syntax check.
Verify both methods exist in the class.
  </verify>
  <done>
GoogleContactsExport class has bulk_export_unlinked() and get_unlinked_count() methods.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add REST endpoint for bulk export</name>
  <files>includes/class-rest-google-contacts.php</files>
  <action>
Add a POST endpoint for bulk export and a GET endpoint to check unlinked count.

**Register routes in register_routes():**
```php
// POST /rondo/v1/google-contacts/bulk-export - Export all unlinked contacts
register_rest_route(
    'rondo/v1',
    '/google-contacts/bulk-export',
    [
        'methods'             => \WP_REST_Server::CREATABLE,
        'callback'            => [ $this, 'bulk_export' ],
        'permission_callback' => [ $this, 'check_user_approved' ],
    ]
);

// GET /rondo/v1/google-contacts/unlinked-count - Get count of unlinked contacts
register_rest_route(
    'rondo/v1',
    '/google-contacts/unlinked-count',
    [
        'methods'             => \WP_REST_Server::READABLE,
        'callback'            => [ $this, 'get_unlinked_count' ],
        'permission_callback' => [ $this, 'check_user_approved' ],
    ]
);
```

**Add bulk_export() callback method:**
```php
/**
 * Bulk export all unlinked contacts to Google
 *
 * @param WP_REST_Request $request The REST request object.
 * @return WP_REST_Response|WP_Error Response with export stats or error.
 */
public function bulk_export( $request ) {
    $user_id = get_current_user_id();

    // Check if connected with readwrite access
    $connection = GoogleContactsConnection::get_connection( $user_id );
    if ( ! $connection ) {
        return new \WP_Error(
            'not_connected',
            __( 'Google Contacts is not connected.', 'stadion' ),
            [ 'status' => 400 ]
        );
    }

    if ( $connection['access_mode'] !== 'readwrite' ) {
        return new \WP_Error(
            'readonly_access',
            __( 'Google Contacts is connected with read-only access. Please reconnect with read-write access to export contacts.', 'stadion' ),
            [ 'status' => 403 ]
        );
    }

    // Increase time limit for bulk operation
    set_time_limit( 300 ); // 5 minutes

    try {
        $exporter = new \Stadion\Export\GoogleContactsExport( $user_id );
        $stats = $exporter->bulk_export_unlinked();

        return rest_ensure_response( [
            'success' => true,
            'stats'   => $stats,
            'message' => sprintf(
                __( 'Bulk export complete: %d exported, %d skipped, %d failed out of %d total.', 'stadion' ),
                $stats['exported'],
                $stats['skipped'],
                $stats['failed'],
                $stats['total']
            ),
        ] );

    } catch ( \Exception $e ) {
        return new \WP_Error(
            'bulk_export_failed',
            $e->getMessage(),
            [ 'status' => 500 ]
        );
    }
}

/**
 * Get count of unlinked contacts
 *
 * @param WP_REST_Request $request The REST request object.
 * @return WP_REST_Response Response with unlinked count.
 */
public function get_unlinked_count( $request ) {
    $user_id = get_current_user_id();

    // Check if connected with readwrite access (needed to export)
    $connection = GoogleContactsConnection::get_connection( $user_id );
    $can_export = $connection && $connection['access_mode'] === 'readwrite';

    $exporter = new \Stadion\Export\GoogleContactsExport( $user_id );
    $count = $exporter->get_unlinked_count();

    return rest_ensure_response( [
        'unlinked_count' => $count,
        'can_export'     => $can_export,
    ] );
}
```
  </action>
  <verify>
Run `php -l includes/class-rest-google-contacts.php` for syntax check.
Verify endpoints are registered correctly.
  </verify>
  <done>
REST endpoints exist for bulk export and unlinked count. Endpoints enforce readwrite access.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add bulk export button to Settings UI</name>
  <files>src/pages/SettingsPage.jsx</files>
  <action>
Add a bulk export button to the Google Contacts card in Settings > Connections. The button should:
- Only appear when connected with readwrite access
- Show unlinked count before export
- Show progress during export
- Display results after completion

**Find the Google Contacts card in the Contacts subtab section and add bulk export UI.**

Add state variables (near other useState calls):
```jsx
const [unlinkedCount, setUnlinkedCount] = useState(null);
const [isBulkExporting, setIsBulkExporting] = useState(false);
const [bulkExportResult, setBulkExportResult] = useState(null);
```

Add a useEffect to fetch unlinked count when contacts are connected with readwrite:
```jsx
// Fetch unlinked count when connected with readwrite
useEffect(() => {
  if (contactsConnection?.access_mode === 'readwrite') {
    apiClient.get('/rondo/v1/google-contacts/unlinked-count')
      .then(response => {
        setUnlinkedCount(response.data.unlinked_count);
      })
      .catch(err => {
        console.error('Failed to fetch unlinked count:', err);
      });
  }
}, [contactsConnection]);
```

Add bulk export handler:
```jsx
const handleBulkExport = async () => {
  setIsBulkExporting(true);
  setBulkExportResult(null);

  try {
    const response = await apiClient.post('/rondo/v1/google-contacts/bulk-export');
    setBulkExportResult(response.data);
    // Refresh unlinked count after export
    setUnlinkedCount(0);
  } catch (error) {
    setBulkExportResult({
      success: false,
      message: error.response?.data?.message || 'Bulk export failed'
    });
  } finally {
    setIsBulkExporting(false);
  }
};
```

Add bulk export UI in the Google Contacts card (after the connected status display, before disconnect button):
```jsx
{/* Bulk Export Section - only show when connected with readwrite */}
{contactsConnection?.access_mode === 'readwrite' && (
  <div className="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
    <div className="flex items-center justify-between">
      <div>
        <h4 className="text-sm font-medium text-gray-900 dark:text-white">
          Bulk Export to Google
        </h4>
        {unlinkedCount !== null && unlinkedCount > 0 && !isBulkExporting && !bulkExportResult && (
          <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
            {unlinkedCount} contact{unlinkedCount !== 1 ? 's' : ''} not yet in Google
          </p>
        )}
        {unlinkedCount === 0 && !isBulkExporting && !bulkExportResult && (
          <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
            All contacts are synced to Google
          </p>
        )}
      </div>
      {unlinkedCount > 0 && !isBulkExporting && !bulkExportResult && (
        <button
          onClick={handleBulkExport}
          className="px-3 py-1.5 text-sm font-medium rounded-md bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800"
        >
          Export All
        </button>
      )}
    </div>

    {/* Progress indicator */}
    {isBulkExporting && (
      <div className="mt-3">
        <div className="flex items-center gap-2">
          <svg className="animate-spin h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span className="text-sm text-gray-600 dark:text-gray-400">
            Exporting contacts to Google...
          </span>
        </div>
      </div>
    )}

    {/* Results display */}
    {bulkExportResult && (
      <div className={`mt-3 p-3 rounded-md ${bulkExportResult.success ? 'bg-green-50 dark:bg-green-900/20' : 'bg-red-50 dark:bg-red-900/20'}`}>
        <p className={`text-sm ${bulkExportResult.success ? 'text-green-800 dark:text-green-200' : 'text-red-800 dark:text-red-200'}`}>
          {bulkExportResult.message}
        </p>
        {bulkExportResult.stats && (
          <div className="mt-2 text-xs text-gray-600 dark:text-gray-400">
            <span className="inline-block mr-3">Exported: {bulkExportResult.stats.exported}</span>
            {bulkExportResult.stats.skipped > 0 && (
              <span className="inline-block mr-3">Skipped: {bulkExportResult.stats.skipped}</span>
            )}
            {bulkExportResult.stats.failed > 0 && (
              <span className="inline-block text-red-600 dark:text-red-400">Failed: {bulkExportResult.stats.failed}</span>
            )}
          </div>
        )}
        <button
          onClick={() => setBulkExportResult(null)}
          className="mt-2 text-xs text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
        >
          Dismiss
        </button>
      </div>
    )}
  </div>
)}
```

Location: Place this inside the Google Contacts connection card, after the email/connection status display and before the Disconnect button.
  </action>
  <verify>
Run `npm run lint` to check for errors.
Run `npm run build` to verify React compiles.
Deploy and verify the button appears in Settings > Connections > Google Contacts when connected with readwrite access.
  </verify>
  <done>
Bulk export button appears in Settings UI. Shows unlinked count, progress during export, and results summary.
  </done>
</task>

</tasks>

<verification>
1. PHP syntax valid: `php -l includes/class-google-contacts-export.php && php -l includes/class-rest-google-contacts.php`
2. Frontend builds: `npm run build` succeeds
3. REST endpoints work:
   - GET `/rondo/v1/google-contacts/unlinked-count` returns count
   - POST `/rondo/v1/google-contacts/bulk-export` exports all unlinked contacts
4. UI shows bulk export button only when connected with readwrite access
5. Progress is shown during export (spinner)
6. Results summary displays after completion with counts
</verification>

<success_criteria>
- User can see how many contacts are not yet exported to Google
- User can click "Export All" to bulk export unlinked contacts
- Export runs sequentially with 100ms delay to avoid rate limits
- Results show exported/skipped/failed counts
- Endpoint can be called from WP-CLI in Phase 85 (bulk_export_unlinked method is public)
</success_criteria>

<output>
After completion, create `.planning/phases/81-export-to-google/81-03-SUMMARY.md`
</output>
