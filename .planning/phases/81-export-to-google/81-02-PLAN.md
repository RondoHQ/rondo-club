---
phase: 81-export-to-google
plan: 02
type: execute
wave: 2
depends_on: ["81-01"]
files_modified:
  - includes/class-google-contacts-export.php
  - includes/class-rest-google-contacts.php
autonomous: true

must_haves:
  truths:
    - "Saving a person triggers async export to Google if user has readwrite access"
    - "Export runs in background without blocking contact save"
    - "REST endpoint can trigger single contact export"
    - "Only published contacts from connected users are exported"
  artifacts:
    - path: "includes/class-google-contacts-export.php"
      provides: "save_post hook and async queue integration"
      contains: "add_action.*save_post_person"
    - path: "includes/class-rest-google-contacts.php"
      provides: "Export REST endpoint"
      contains: "register_rest_route.*export"
  key_links:
    - from: "includes/class-google-contacts-export.php"
      to: "WordPress save_post_person hook"
      via: "add_action in init()"
      pattern: "add_action.*save_post_person"
    - from: "includes/class-google-contacts-export.php"
      to: "WP-Cron async processing"
      via: "wp_schedule_single_event + spawn_cron"
      pattern: "wp_schedule_single_event.*stadion_google_contact_export"
---

<objective>
Add save_post hook integration to trigger async exports, implement the WP-Cron queue for background processing, and add REST endpoint for manual export triggering.

Purpose: Contacts should automatically sync to Google when saved in Stadion, without blocking the save operation.
Output: Updated export class with hooks/queue, new REST endpoint for export.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/81-export-to-google/81-CONTEXT.md
@.planning/phases/81-export-to-google/81-RESEARCH.md
@.planning/phases/81-export-to-google/81-01-SUMMARY.md
@includes/class-google-contacts-export.php
@includes/class-rest-google-contacts.php
@includes/class-auto-title.php (lines 270-308 for async cron pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add save_post hook and async queue to export class</name>
  <files>includes/class-google-contacts-export.php</files>
  <action>
Add WordPress hook integration and async queue processing to the GoogleContactsExport class.

**Add static init() method (called from functions.php):**
```php
public static function init(): void {
    $instance = new self( 0 ); // User ID set per-save
    add_action( 'save_post_person', [ $instance, 'on_person_saved' ], 20, 3 );
    add_action( 'stadion_google_contact_export', [ $instance, 'handle_async_export' ], 10, 2 );
}
```

**Add on_person_saved() method:**
```php
public function on_person_saved( int $post_id, \WP_Post $post, bool $update ): void {
    // Skip autosaves and revisions
    if ( wp_is_post_autosave( $post_id ) || wp_is_post_revision( $post_id ) ) {
        return;
    }

    // Skip non-published posts
    if ( $post->post_status !== 'publish' ) {
        return;
    }

    // Get post author (the user who owns this contact)
    $user_id = (int) $post->post_author;

    // Check if user has Google Contacts connected with readwrite access
    $connection = GoogleContactsConnection::get_connection( $user_id );
    if ( ! $connection || $connection['access_mode'] !== 'readwrite' ) {
        return;
    }

    // Queue for async export
    $this->queue_export( $post_id, $user_id );
}
```

**Add queue_export() method (following class-auto-title.php pattern):**
```php
private function queue_export( int $post_id, int $user_id ): void {
    static $queued = [];

    // Prevent duplicate scheduling in same request
    $key = $post_id . '-' . $user_id;
    if ( isset( $queued[ $key ] ) ) {
        return;
    }
    $queued[ $key ] = true;

    // Clear any existing scheduled event
    $timestamp = wp_next_scheduled( 'stadion_google_contact_export', [ $post_id, $user_id ] );
    if ( $timestamp ) {
        wp_unschedule_event( $timestamp, 'stadion_google_contact_export', [ $post_id, $user_id ] );
    }

    // Schedule immediate execution
    wp_schedule_single_event( time(), 'stadion_google_contact_export', [ $post_id, $user_id ] );
    spawn_cron();
}
```

**Add handle_async_export() method:**
```php
public function handle_async_export( int $post_id, int $user_id ): void {
    // Verify post still exists and is published
    $post = get_post( $post_id );
    if ( ! $post || $post->post_status !== 'publish' || $post->post_type !== 'person' ) {
        return;
    }

    // Verify user still has readwrite access
    $connection = GoogleContactsConnection::get_connection( $user_id );
    if ( ! $connection || $connection['access_mode'] !== 'readwrite' ) {
        return;
    }

    try {
        // Create exporter for this user
        $exporter = new self( $user_id );
        $exporter->export_contact( $post_id );
    } catch ( \Exception $e ) {
        // Log error but don't throw - this is async
        if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
            error_log( 'Google Contact export failed for post ' . $post_id . ': ' . $e->getMessage() );
        }
    }
}
```

**Update constructor to accept user_id = 0:**
The constructor should handle `$user_id = 0` for the static init case where we don't yet know the user.
  </action>
  <verify>
Run `php -l includes/class-google-contacts-export.php` for syntax check.
Verify hooks are registered correctly by checking the add_action calls.
  </verify>
  <done>
Saving a person post triggers async export queue. Export runs in background via WP-Cron.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update functions.php to call init()</name>
  <files>functions.php</files>
  <action>
After the require_once for class-google-contacts-export.php, add the init() call:

Find where other classes are initialized (likely in rondo_init() or a later hook like 'init') and add:
```php
\Stadion\Export\GoogleContactsExport::init();
```

This should be called on the 'init' hook or similar to ensure WordPress hooks are available.
  </action>
  <verify>
Run `php -l functions.php` for syntax check.
Verify init() is called at appropriate WordPress hook timing.
  </verify>
  <done>
Export class hooks are registered on WordPress init.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add REST endpoint for single contact export</name>
  <files>includes/class-rest-google-contacts.php</files>
  <action>
Add a POST endpoint to trigger export for a single contact. This is useful for:
- Manual re-export of a contact
- Testing export functionality
- Future bulk export implementation

**Register route in register_routes():**
```php
// POST /rondo/v1/google-contacts/export/{id} - Export single contact
register_rest_route(
    'rondo/v1',
    '/google-contacts/export/(?P<id>\d+)',
    [
        'methods'             => \WP_REST_Server::CREATABLE,
        'callback'            => [ $this, 'export_contact' ],
        'permission_callback' => [ $this, 'check_user_approved' ],
        'args'                => [
            'id' => [
                'required'          => true,
                'type'              => 'integer',
                'validate_callback' => function( $param ) {
                    return is_numeric( $param ) && $param > 0;
                },
            ],
        ],
    ]
);
```

**Add export_contact() callback method:**
```php
/**
 * Export a single contact to Google
 *
 * @param WP_REST_Request $request The REST request object.
 * @return WP_REST_Response|WP_Error Response with export result or error.
 */
public function export_contact( $request ) {
    $user_id = get_current_user_id();
    $post_id = (int) $request->get_param( 'id' );

    // Check if connected with readwrite access
    $connection = GoogleContactsConnection::get_connection( $user_id );
    if ( ! $connection ) {
        return new \WP_Error(
            'not_connected',
            __( 'Google Contacts is not connected.', 'stadion' ),
            [ 'status' => 400 ]
        );
    }

    if ( $connection['access_mode'] !== 'readwrite' ) {
        return new \WP_Error(
            'readonly_access',
            __( 'Google Contacts is connected with read-only access. Please reconnect with read-write access to export contacts.', 'stadion' ),
            [ 'status' => 403 ]
        );
    }

    // Verify post exists and user owns it
    $post = get_post( $post_id );
    if ( ! $post || $post->post_type !== 'person' ) {
        return new \WP_Error(
            'not_found',
            __( 'Contact not found.', 'stadion' ),
            [ 'status' => 404 ]
        );
    }

    // Check ownership (non-admins can only export their own contacts)
    if ( ! current_user_can( 'manage_options' ) && (int) $post->post_author !== $user_id ) {
        return new \WP_Error(
            'forbidden',
            __( 'You do not have permission to export this contact.', 'stadion' ),
            [ 'status' => 403 ]
        );
    }

    try {
        $exporter = new \Stadion\Export\GoogleContactsExport( $user_id );
        $result = $exporter->export_contact( $post_id );

        $google_id = get_post_meta( $post_id, '_google_contact_id', true );

        return rest_ensure_response( [
            'success'           => $result,
            'google_contact_id' => $google_id,
            'message'           => $result
                ? __( 'Contact exported to Google successfully.', 'stadion' )
                : __( 'Export failed. Check error logs for details.', 'stadion' ),
        ] );

    } catch ( \Exception $e ) {
        return new \WP_Error(
            'export_failed',
            $e->getMessage(),
            [ 'status' => 500 ]
        );
    }
}
```

Add the use statement at the top of the file:
```php
use Stadion\Export\GoogleContactsExport;
```
  </action>
  <verify>
Run `php -l includes/class-rest-google-contacts.php` for syntax check.
Test endpoint with curl (after deploying): `curl -X POST https://cael.is/wp-json/rondo/v1/google-contacts/export/123 -H "X-WP-Nonce: ..."` (will need auth)
  </verify>
  <done>
REST endpoint exists for exporting a single contact. Returns success/failure with google_contact_id.
  </done>
</task>

</tasks>

<verification>
1. PHP syntax valid for all modified files
2. Save a contact and verify cron job is scheduled: `wp cron event list` should show `stadion_google_contact_export`
3. Export hook only triggers for users with readwrite access
4. REST endpoint returns appropriate errors for unauthorized/readonly users
5. Async export doesn't block contact save operation
</verification>

<success_criteria>
- Saving a person post queues async export if user has readwrite Google access
- WP-Cron job processes export in background
- REST endpoint `/rondo/v1/google-contacts/export/{id}` triggers single contact export
- Errors are logged but don't crash the save operation
</success_criteria>

<output>
After completion, create `.planning/phases/81-export-to-google/81-02-SUMMARY.md`
</output>
