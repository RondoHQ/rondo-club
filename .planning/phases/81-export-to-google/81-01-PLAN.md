---
phase: 81-export-to-google
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-google-contacts-export.php
autonomous: true

must_haves:
  truths:
    - "Stadion person fields map correctly to Google Person object format"
    - "New contacts can be created in Google via People API"
    - "Existing linked contacts can be updated in Google with etag validation"
    - "Featured images can be uploaded as Google contact photos"
  artifacts:
    - path: "includes/class-google-contacts-export.php"
      provides: "Core export logic with field mapping and Google API integration"
      min_lines: 300
      exports: ["GoogleContactsExport class"]
  key_links:
    - from: "includes/class-google-contacts-export.php"
      to: "includes/class-google-contacts-connection.php"
      via: "GoogleContactsConnection::get_decrypted_credentials()"
      pattern: "GoogleContactsConnection::get_decrypted_credentials"
    - from: "includes/class-google-contacts-export.php"
      to: "Google PeopleService"
      via: "people->createContact() and people->updateContact()"
      pattern: "people->createContact|people->updateContact"
---

<objective>
Create the core Google Contacts export class that handles field mapping, contact creation, contact updates, and photo uploads via the Google People API.

Purpose: This is the reverse of the import class - maps Stadion ACF fields to Google Person objects and handles CRUD operations against the People API.
Output: `includes/class-google-contacts-export.php` with complete export logic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/81-export-to-google/81-CONTEXT.md
@.planning/phases/81-export-to-google/81-RESEARCH.md
@includes/class-google-contacts-api-import.php (mirror this structure)
@includes/class-google-contacts-connection.php
@includes/class-google-oauth.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GoogleContactsExport class with field mapping</name>
  <files>includes/class-google-contacts-export.php</files>
  <action>
Create a new class `Stadion\Export\GoogleContactsExport` that mirrors the import class structure:

**Class structure:**
- Namespace: `Stadion\Export`
- Uses: `Stadion\Calendar\GoogleOAuth`, `Stadion\Contacts\GoogleContactsConnection`, `Google\Service\PeopleService`
- Properties: `$user_id`, `$service` (PeopleService instance), `$stats` array

**Core methods:**

1. `__construct(int $user_id)` - Store user_id, raise memory limit for large exports

2. `get_people_service(): PeopleService` - Get authenticated PeopleService instance:
   - Use `GoogleContactsConnection::get_decrypted_credentials($user_id)`
   - Create client via `GoogleOAuth::get_contacts_client(false, false)`
   - Handle token refresh if expired
   - Cache service instance in `$this->service`

3. `export_contact(int $post_id): bool` - Main export method:
   - Check user has readwrite access: `GoogleContactsConnection::get_connection($user_id)['access_mode'] === 'readwrite'`
   - Check `_google_contact_id` meta exists -> update, else -> create
   - Return true on success, false on failure

4. `create_google_contact(int $post_id): ?string` - Create new contact:
   - Build Person object via `build_person_from_post($post_id)`
   - Call `$service->people->createContact($person, ['personFields' => ...])`
   - Store returned resourceName and etag as post meta
   - Return resourceName or null on failure

5. `update_google_contact(int $post_id, string $resource_name): bool` - Update existing:
   - Get current etag from `_google_etag` post meta
   - Build Person object with metadata including etag
   - Call `$service->people->updateContact($resource_name, $person, [...])`
   - Update stored etag with new value
   - Return true/false

6. `upload_photo(int $post_id, string $resource_name): bool` - Upload featured image:
   - Check `get_post_thumbnail_id($post_id)` exists
   - Get file path via `get_attached_file()`
   - Read and base64 encode: `base64_encode(file_get_contents($path))`
   - Create `UpdateContactPhotoRequest` and call `people->updateContactPhoto()`
   - Return true/false

**Field mapping methods (reverse of import):**

7. `build_person_from_post(int $post_id): Person` - Build Google Person object:
   - Create `new Google\Service\PeopleService\Person()`
   - Call helper methods to set each field type
   - Return Person object

8. `build_name(int $post_id): ?Name` - Map first_name/last_name to Name:
   - `$name->setGivenName(get_field('first_name', $post_id))`
   - `$name->setFamilyName(get_field('last_name', $post_id))`
   - Singleton field - only one allowed

9. `build_email_addresses(int $post_id): array` - Map contact_info emails:
   - Get `contact_info` repeater
   - Filter for `contact_type === 'email'`
   - Create `EmailAddress` objects with value and type

10. `build_phone_numbers(int $post_id): array` - Map contact_info phones:
    - Filter for `contact_type in ['phone', 'mobile']`
    - Create `PhoneNumber` objects
    - Map 'mobile' type to 'mobile', 'phone' to 'home'

11. `build_urls(int $post_id): array` - Map contact_info URLs:
    - Filter for `contact_type in ['website', 'linkedin', 'twitter', 'facebook', 'instagram']`
    - Create `Url` objects

12. `build_addresses(int $post_id): array` - Map addresses repeater:
    - Get `addresses` repeater
    - Create `Address` objects with street, city, region, postalCode, country

13. `build_teams(int $post_id): array` - Map work_history:
    - Get `work_history` repeater
    - For each entry, get team title and job_title
    - Create `Team` objects with name, title, current, startDate, endDate

14. `build_metadata_with_etag(string $etag): PersonMetadata` - For updates:
    - Required for update requests to prevent concurrent modification
    - Create Source object with type 'CONTACT' and etag

**Stat tracking:**
- `$stats` array: `contacts_exported`, `contacts_updated`, `photos_uploaded`, `errors`
- Increment stats in create/update methods
- Return stats from `get_stats()` method

**Error handling:**
- Catch Google API exceptions
- Log errors to `$stats['errors']` array
- Check for readonly access and throw exception
- Handle etag mismatch (409 conflict) by re-fetching and retrying once
  </action>
  <verify>
File exists and has all required methods. Run: `php -l includes/class-google-contacts-export.php` for syntax check.
Verify class can be instantiated (will be tested with real integration in Plan 02).
  </verify>
  <done>
GoogleContactsExport class exists with all field mapping and CRUD methods. Syntax is valid PHP 8.0+.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register class loading in functions.php</name>
  <files>functions.php</files>
  <action>
Add the new export class to the list of included files in `stadion_init()` function.

Find the section that loads includes (around line 80-100) and add:
```php
require_once __DIR__ . '/includes/class-google-contacts-export.php';
```

Place it after `class-google-contacts-api-import.php` for logical ordering.
  </action>
  <verify>
Run `php -l functions.php` to verify syntax.
Verify the require_once line is in the correct location within stadion_init().
  </verify>
  <done>
GoogleContactsExport class is loaded when theme initializes.
  </done>
</task>

</tasks>

<verification>
1. PHP syntax valid for both files: `php -l includes/class-google-contacts-export.php && php -l functions.php`
2. Class follows same patterns as GoogleContactsAPI import class
3. All required methods exist for field mapping, create, update, and photo upload
4. Etag handling is implemented for update operations
5. Access mode check (readwrite) is enforced before export
</verification>

<success_criteria>
- GoogleContactsExport class exists with complete field mapping (reverse of import)
- Class can create new Google contacts via People API createContact()
- Class can update existing Google contacts via People API updateContact() with etag
- Class can upload photos via updateContactPhoto()
- Class is loaded by WordPress theme
</success_criteria>

<output>
After completion, create `.planning/phases/81-export-to-google/81-01-SUMMARY.md`
</output>
