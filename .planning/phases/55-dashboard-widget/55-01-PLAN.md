---
phase: 55-dashboard-widget
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-calendar.php
  - src/api/client.js
  - src/hooks/useMeetings.js
  - src/pages/Dashboard.jsx
autonomous: true
---

<objective>
Add "Today's Meetings" dashboard widget showing calendar events for today with matched attendees.

Purpose: Surface today's meetings prominently on the dashboard so users see their scheduled meetings at a glance, completing the calendar integration feature set.
Output: Dashboard widget displaying today's meetings above the Favorites row, with links to matched people.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/53-person-meetings-section/53-01-SUMMARY.md
@.planning/phases/54-background-sync/54-01-SUMMARY.md

# Key source files
@includes/class-rest-calendar.php
@src/pages/Dashboard.jsx
@src/hooks/useMeetings.js
@src/api/client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add today's meetings REST endpoint</name>
  <files>includes/class-rest-calendar.php</files>
  <action>
Add new REST endpoint `GET /prm/v1/calendar/today-meetings` that returns today's calendar events with matched attendees.

In `register_routes()` add:
```php
register_rest_route('prm/v1', '/calendar/today-meetings', [
    'methods'             => WP_REST_Server::READABLE,
    'callback'            => [$this, 'get_today_meetings'],
    'permission_callback' => [$this, 'check_user_approved'],
]);
```

Implement `get_today_meetings()`:
1. Get current user ID
2. Query `calendar_event` posts where:
   - `author` = current user
   - `_start_time` >= today 00:00:00
   - `_start_time` <= today 23:59:59
3. Order by `_start_time` ASC
4. For each event, format with:
   - id, title, start_time, end_time, all_day
   - location, meeting_url
   - matched_people (from _matched_people meta, with person name and thumbnail)
   - calendar_name (from connection)
5. Return array of meetings

Use the existing `format_meeting_event()` pattern but add person details for matched people by looking up each person_id.

Return format:
```json
{
  "meetings": [...],
  "total": N,
  "has_connections": true/false
}
```

The `has_connections` flag helps frontend show appropriate message when user has no calendar connections set up.
  </action>
  <verify>
Test endpoint: `curl -X GET 'http://localhost/wp-json/prm/v1/calendar/today-meetings' -H 'X-WP-Nonce: [nonce]'`
Returns meetings array with matched_people containing person details.
  </verify>
  <done>
- Endpoint registered and responds
- Returns today's meetings with matched person details
- Includes has_connections flag
  </done>
</task>

<task type="auto">
  <name>Task 2: Add frontend API and hook for today's meetings</name>
  <files>src/api/client.js, src/hooks/useMeetings.js</files>
  <action>
In `src/api/client.js`, add to prmApi object:
```javascript
getTodayMeetings: () => api.get('/prm/v1/calendar/today-meetings'),
```

In `src/hooks/useMeetings.js`, add:
```javascript
export const meetingsKeys = {
  all: ['meetings'],
  today: ['meetings', 'today'],
  person: (personId) => ['person-meetings', personId],
};

export function useTodayMeetings() {
  return useQuery({
    queryKey: meetingsKeys.today,
    queryFn: async () => {
      const response = await prmApi.getTodayMeetings();
      return response.data;
    },
    staleTime: 5 * 60 * 1000, // 5 minutes - meetings don't change often
    refetchInterval: 15 * 60 * 1000, // Refetch every 15 minutes
  });
}
```
  </action>
  <verify>`npm run build` succeeds without errors.</verify>
  <done>
- getTodayMeetings API function added
- useTodayMeetings hook exported
- Query key pattern established
  </done>
</task>

<task type="auto">
  <name>Task 3: Add TodaysMeetings widget to Dashboard</name>
  <files>src/pages/Dashboard.jsx</files>
  <action>
Add a "Today's Meetings" widget to Dashboard.jsx positioned as a full-width card above the existing Row 2 (Favorites + Recently Contacted + Recently Edited).

1. Import useTodayMeetings:
```javascript
import { useTodayMeetings } from '@/hooks/useMeetings';
```

2. Add CalendarClock icon to lucide imports for the header.

3. Create MeetingCard component (inline, similar pattern to existing ReminderCard):
```javascript
function MeetingCard({ meeting }) {
  // Format time display
  const startTime = format(new Date(meeting.start_time), 'h:mm a');
  const endTime = meeting.end_time ? format(new Date(meeting.end_time), 'h:mm a') : null;

  // Get first matched person for link target
  const firstPerson = meeting.matched_people?.[0];

  // Card content shows: time, title, matched people avatars
  const cardContent = (
    <>
      <div className="text-sm font-medium text-accent-600 dark:text-accent-400 w-20 flex-shrink-0">
        {meeting.all_day ? 'All day' : startTime}
      </div>
      <div className="flex-1 min-w-0">
        <p className="text-sm font-medium text-gray-900 dark:text-gray-50 truncate">{meeting.title}</p>
        {meeting.location && (
          <p className="text-xs text-gray-500 dark:text-gray-400 truncate">{meeting.location}</p>
        )}
      </div>
      {meeting.matched_people?.length > 0 && (
        <div className="flex -space-x-2 ml-3 flex-shrink-0">
          {meeting.matched_people.slice(0, 3).map((person) => (
            person.thumbnail ? (
              <img key={person.person_id} src={person.thumbnail} alt={person.name} loading="lazy"
                className="w-8 h-8 rounded-full border-2 border-white dark:border-gray-800 object-cover" />
            ) : (
              <div key={person.person_id}
                className="w-8 h-8 bg-gray-300 dark:bg-gray-600 rounded-full border-2 border-white dark:border-gray-800 flex items-center justify-center">
                <span className="text-xs dark:text-gray-300">{person.name?.[0]}</span>
              </div>
            )
          ))}
        </div>
      )}
    </>
  );

  // Link to first matched person if available
  if (firstPerson?.person_id) {
    return (
      <Link to={`/people/${firstPerson.person_id}`}
        className="flex items-center p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
        {cardContent}
      </Link>
    );
  }

  return (
    <div className="flex items-center p-3 rounded-lg">
      {cardContent}
    </div>
  );
}
```

4. In Dashboard component, call the hook:
```javascript
const { data: todayMeetingsData } = useTodayMeetings();
const todayMeetings = todayMeetingsData?.meetings || [];
const hasCalendarConnections = todayMeetingsData?.has_connections ?? false;
```

5. Add widget between Row 1 (Reminders/Todos/Awaiting) and Row 2 (Favorites/Contacted/Edited):
```jsx
{/* Today's Meetings */}
{hasCalendarConnections && (
  <div className="card">
    <div className="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
      <h2 className="font-semibold flex items-center dark:text-gray-50">
        <CalendarClock className="w-5 h-5 mr-2 text-gray-500 dark:text-gray-400" />
        Today's meetings
      </h2>
      <Link to="/settings?tab=calendars"
        className="text-sm text-accent-600 hover:text-accent-700 dark:text-accent-400 dark:hover:text-accent-300 flex items-center">
        Settings
        <ArrowRight className="w-4 h-4 ml-1" />
      </Link>
    </div>
    <div className="divide-y divide-gray-100 dark:divide-gray-700">
      {todayMeetings.length > 0 ? (
        todayMeetings.map((meeting) => (
          <MeetingCard key={meeting.id} meeting={meeting} />
        ))
      ) : (
        <p className="p-4 text-sm text-gray-500 dark:text-gray-400 text-center">
          No meetings scheduled for today
        </p>
      )}
    </div>
  </div>
)}
```

Widget only renders when user has calendar connections. Links to Settings > Calendars for configuration.
  </action>
  <verify>
`npm run build` succeeds.
Navigate to Dashboard - widget shows today's meetings or "No meetings" if none.
Widget hidden when user has no calendar connections.
  </verify>
  <done>
- MeetingCard component renders meeting with time, title, location, attendee avatars
- Today's Meetings widget appears on Dashboard above Favorites row
- Widget conditionally rendered only when calendar connections exist
- Empty state message when no meetings today
- Proper dark mode styling
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes with no warnings
- [ ] REST endpoint returns today's meetings with matched person details
- [ ] Dashboard shows Today's Meetings widget when calendar connected
- [ ] Dashboard hides widget when no calendar connections
- [ ] Meeting cards display time, title, location, attendee avatars
- [ ] Meeting cards link to first matched person
- [ ] Dark mode styling is correct
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Today's meetings appear on dashboard with proper formatting
- Widget conditionally shown based on calendar connection status
</success_criteria>

<output>
After completion, create `.planning/phases/55-dashboard-widget/55-01-SUMMARY.md`
</output>
