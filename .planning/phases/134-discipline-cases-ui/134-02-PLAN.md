---
phase: 134-discipline-cases-ui
plan: 02
type: execute
wave: 2
depends_on: ["134-01"]
files_modified:
  - src/pages/DisciplineCases/DisciplineCasesList.jsx
  - src/components/DisciplineCaseTable.jsx
autonomous: true

must_haves:
  truths:
    - "Discipline cases list page displays at /discipline-cases route"
    - "Table shows Person, Match, Sanction, Fee columns"
    - "Season filter dropdown filters cases by seizoen taxonomy"
    - "Date column is sortable"
    - "Row click expands inline details (charges, full sanction)"
  artifacts:
    - path: "src/pages/DisciplineCases/DisciplineCasesList.jsx"
      provides: "Discipline cases list page with season filter"
      min_lines: 80
    - path: "src/components/DisciplineCaseTable.jsx"
      provides: "Reusable table component for discipline cases"
      exports: ["default"]
      min_lines: 100
  key_links:
    - from: "src/pages/DisciplineCases/DisciplineCasesList.jsx"
      to: "src/hooks/useDisciplineCases.js"
      via: "useDisciplineCases, useSeasons hooks"
      pattern: "useDisciplineCases|useSeasons"
    - from: "src/components/DisciplineCaseTable.jsx"
      to: "src/utils/formatters.js"
      via: "formatCurrency"
      pattern: "formatCurrency"
---

<objective>
Implement the discipline cases list page with table view and season filtering

Purpose: Allow fairplay users to view and filter discipline cases by season
Output: Full list page replacing placeholder, reusable table component
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/134-discipline-cases-ui/134-01-SUMMARY.md
@.planning/phases/134-discipline-cases-ui/134-CONTEXT.md
@.planning/phases/134-discipline-cases-ui/134-RESEARCH.md
@src/pages/DisciplineCases/DisciplineCasesList.jsx (current placeholder)
@src/pages/People/PeopleList.jsx (for table patterns)
@src/utils/formatters.js (for formatCurrency)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reusable DisciplineCaseTable component</name>
  <files>src/components/DisciplineCaseTable.jsx</files>
  <action>
Create a reusable table component for discipline cases. This will be used both on the list page and person detail tab.

```javascript
import { useState, useMemo } from 'react';
import { Link } from 'react-router-dom';
import { ChevronDown, ChevronUp, ArrowUp, ArrowDown } from 'lucide-react';
import PersonAvatar from '@/components/PersonAvatar';
import { formatCurrency, getPersonName } from '@/utils/formatters';
import { format } from '@/utils/dateFormat';

/**
 * Reusable table for discipline cases
 * @param {Object} props
 * @param {Array} props.cases - Array of discipline case objects
 * @param {boolean} props.showPersonColumn - Whether to show Person column (false on person tab)
 * @param {Map} props.personMap - Map of person ID to person data (for list view)
 * @param {boolean} props.isLoading - Loading state
 */
export default function DisciplineCaseTable({ cases, showPersonColumn = true, personMap = new Map(), isLoading = false }) {
  const [expandedId, setExpandedId] = useState(null);
  const [sortOrder, setSortOrder] = useState('desc'); // 'asc' or 'desc' for match_date

  // Sort cases by match_date
  const sortedCases = useMemo(() => {
    if (!cases) return [];
    return [...cases].sort((a, b) => {
      // ACF date picker returns Ymd format (e.g., "20241015")
      const dateA = a.acf?.match_date ? new Date(
        a.acf.match_date.slice(0, 4),
        parseInt(a.acf.match_date.slice(4, 6), 10) - 1,
        a.acf.match_date.slice(6, 8)
      ) : new Date(0);
      const dateB = b.acf?.match_date ? new Date(
        b.acf.match_date.slice(0, 4),
        parseInt(b.acf.match_date.slice(4, 6), 10) - 1,
        b.acf.match_date.slice(6, 8)
      ) : new Date(0);

      return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
    });
  }, [cases, sortOrder]);

  const toggleSort = () => {
    setSortOrder(prev => prev === 'asc' ? 'desc' : 'asc');
  };

  const toggleExpand = (id) => {
    setExpandedId(prev => prev === id ? null : id);
  };

  // Format ACF date (Ymd) to display format
  const formatAcfDate = (dateStr) => {
    if (!dateStr || dateStr.length !== 8) return '-';
    const year = dateStr.slice(0, 4);
    const month = parseInt(dateStr.slice(4, 6), 10) - 1;
    const day = dateStr.slice(6, 8);
    const date = new Date(year, month, day);
    return format(date, 'd-M-yyyy');
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-32">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-accent-600 dark:border-accent-400"></div>
      </div>
    );
  }

  if (!cases || cases.length === 0) {
    return (
      <div className="text-center py-8 text-gray-500 dark:text-gray-400">
        Geen tuchtzaken gevonden.
      </div>
    );
  }

  return (
    <div className="overflow-x-auto">
      <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
        <thead className="bg-gray-50 dark:bg-gray-800">
          <tr>
            {showPersonColumn && (
              <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Persoon
              </th>
            )}
            <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              <button
                onClick={toggleSort}
                className="flex items-center gap-1 hover:text-gray-700 dark:hover:text-gray-200"
              >
                Wedstrijd
                {sortOrder === 'asc' ? (
                  <ArrowUp className="w-3 h-3" />
                ) : (
                  <ArrowDown className="w-3 h-3" />
                )}
              </button>
            </th>
            <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Sanctie
            </th>
            <th scope="col" className="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Boete
            </th>
            <th scope="col" className="w-10"></th>
          </tr>
        </thead>
        <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
          {sortedCases.map((dc, index) => {
            const isExpanded = expandedId === dc.id;
            const person = personMap.get(dc.acf?.person);
            const acf = dc.acf || {};

            return (
              <>
                <tr
                  key={dc.id}
                  className={`hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer ${index % 2 === 1 ? 'bg-gray-50 dark:bg-gray-800/50' : ''}`}
                  onClick={() => toggleExpand(dc.id)}
                >
                  {showPersonColumn && (
                    <td className="px-4 py-3 whitespace-nowrap">
                      {person ? (
                        <Link
                          to={`/people/${dc.acf?.person}`}
                          onClick={(e) => e.stopPropagation()}
                          className="flex items-center gap-2 hover:text-accent-600"
                        >
                          <PersonAvatar
                            thumbnail={person.thumbnail}
                            name={getPersonName(person)}
                            firstName={person.first_name}
                            size="sm"
                          />
                          <span className="text-sm font-medium text-gray-900 dark:text-gray-100">
                            {getPersonName(person)}
                          </span>
                        </Link>
                      ) : (
                        <span className="text-sm text-gray-500 dark:text-gray-400">-</span>
                      )}
                    </td>
                  )}
                  <td className="px-4 py-3">
                    <div className="text-sm text-gray-900 dark:text-gray-100">
                      {acf.match_description || '-'}
                    </div>
                    <div className="text-xs text-gray-500 dark:text-gray-400">
                      {formatAcfDate(acf.match_date)}
                    </div>
                  </td>
                  <td className="px-4 py-3">
                    <div className="text-sm text-gray-900 dark:text-gray-100 max-w-xs truncate">
                      {acf.sanction_description || '-'}
                    </div>
                  </td>
                  <td className="px-4 py-3 text-right whitespace-nowrap">
                    <span className="text-sm font-medium text-gray-900 dark:text-gray-100">
                      {formatCurrency(parseFloat(acf.administrative_fee) || 0, 2)}
                    </span>
                  </td>
                  <td className="px-4 py-3 text-center">
                    {isExpanded ? (
                      <ChevronUp className="w-4 h-4 text-gray-400" />
                    ) : (
                      <ChevronDown className="w-4 h-4 text-gray-400" />
                    )}
                  </td>
                </tr>
                {isExpanded && (
                  <tr key={`${dc.id}-details`} className="bg-gray-50 dark:bg-gray-700/50">
                    <td colSpan={showPersonColumn ? 5 : 4} className="px-4 py-4">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                          <h4 className="font-medium text-gray-700 dark:text-gray-300 mb-1">Tenlastelegging</h4>
                          <p className="text-gray-600 dark:text-gray-400">
                            {acf.charge_description || 'Geen tenlastelegging beschikbaar'}
                          </p>
                          {acf.charge_codes && (
                            <p className="text-xs text-gray-500 dark:text-gray-500 mt-1">
                              Code: {acf.charge_codes}
                            </p>
                          )}
                        </div>
                        <div>
                          <h4 className="font-medium text-gray-700 dark:text-gray-300 mb-1">Sanctie (volledig)</h4>
                          <p className="text-gray-600 dark:text-gray-400">
                            {acf.sanction_description || 'Geen sanctie beschikbaar'}
                          </p>
                        </div>
                        <div>
                          <h4 className="font-medium text-gray-700 dark:text-gray-300 mb-1">Team</h4>
                          <p className="text-gray-600 dark:text-gray-400">
                            {acf.team_name || '-'}
                          </p>
                        </div>
                        <div>
                          <h4 className="font-medium text-gray-700 dark:text-gray-300 mb-1">Details</h4>
                          <p className="text-gray-600 dark:text-gray-400">
                            Dossier: {acf.dossier_id || '-'}
                          </p>
                          <p className="text-gray-600 dark:text-gray-400">
                            Verwerkingsdatum: {formatAcfDate(acf.processing_date)}
                          </p>
                          <p className="text-gray-600 dark:text-gray-400">
                            Doorbelast: {acf.is_charged ? 'Ja' : 'Nee'}
                          </p>
                        </div>
                      </div>
                    </td>
                  </tr>
                )}
              </>
            );
          })}
        </tbody>
      </table>
    </div>
  );
}
```

Key implementation notes:
- Accepts showPersonColumn prop (false on person detail tab)
- personMap provides person data for name/avatar display
- Row click expands inline details
- Sort by match_date (descending by default)
- ACF date format (Ymd) parsed correctly for sorting and display
- formatCurrency with 2 decimals for Dutch locale (e.g., "EUR 25,00")
- Dark mode support via Tailwind classes
  </action>
  <verify>npm run lint passes. File exports default DisciplineCaseTable component.</verify>
  <done>Reusable table component created with expandable rows, sorting, and proper formatting</done>
</task>

<task type="auto">
  <name>Task 2: Implement DisciplineCasesList page with season filter</name>
  <files>src/pages/DisciplineCases/DisciplineCasesList.jsx</files>
  <action>
Replace the placeholder DisciplineCasesList.jsx with full implementation:

```javascript
import { useState, useMemo, useEffect } from 'react';
import { Gavel, Filter } from 'lucide-react';
import { useQueryClient, useQuery } from '@tanstack/react-query';
import { useDisciplineCases, useSeasons, useCurrentSeason } from '@/hooks/useDisciplineCases';
import { wpApi } from '@/api/client';
import DisciplineCaseTable from '@/components/DisciplineCaseTable';
import PullToRefreshWrapper from '@/components/PullToRefreshWrapper';

export default function DisciplineCasesList() {
  const queryClient = useQueryClient();

  // Fetch current season to set as default
  const { data: currentSeason, isLoading: isCurrentSeasonLoading } = useCurrentSeason();

  // Season filter state - initialize to null (will be set after currentSeason loads)
  const [selectedSeasonId, setSelectedSeasonId] = useState(null);
  const [hasInitialized, setHasInitialized] = useState(false);

  // Set default season when currentSeason loads
  useEffect(() => {
    if (currentSeason && !hasInitialized) {
      setSelectedSeasonId(currentSeason.id);
      setHasInitialized(true);
    } else if (!currentSeason && !isCurrentSeasonLoading && !hasInitialized) {
      // No current season set, use null (all seasons)
      setHasInitialized(true);
    }
  }, [currentSeason, isCurrentSeasonLoading, hasInitialized]);

  // Fetch seasons for dropdown
  const { data: seasons = [] } = useSeasons();

  // Filter seasons to only show those with cases (client-side)
  // For now, show all seasons - filtering will happen after data loads

  // Fetch discipline cases (filtered by season if selected)
  const {
    data: cases,
    isLoading: isCasesLoading,
    error: casesError,
  } = useDisciplineCases({
    seizoen: selectedSeasonId,
    enabled: hasInitialized, // Wait until default season is determined
  });

  // Collect person IDs from cases
  const personIds = useMemo(() => {
    if (!cases) return [];
    const ids = cases
      .map(dc => dc.acf?.person)
      .filter(Boolean);
    return [...new Set(ids)];
  }, [cases]);

  // Batch fetch persons for table display
  const { data: personsData } = useQuery({
    queryKey: ['people', 'batch', personIds.sort().join(',')],
    queryFn: async () => {
      if (personIds.length === 0) return [];
      const response = await wpApi.getPeople({
        per_page: 100,
        include: personIds.join(','),
        _embed: true,
      });
      return response.data;
    },
    enabled: personIds.length > 0,
  });

  // Create person map for table
  const personMap = useMemo(() => {
    const map = new Map();
    if (personsData) {
      personsData.forEach(person => {
        map.set(person.id, {
          id: person.id,
          first_name: person.first_name,
          name: person.name || `${person.first_name || ''} ${person.last_name || ''}`.trim(),
          thumbnail: person.thumbnail,
        });
      });
    }
    return map;
  }, [personsData]);

  // Determine which seasons have cases (for hiding empty seasons)
  const seasonsWithCases = useMemo(() => {
    if (!cases || cases.length === 0) return new Set();
    const seasonIds = new Set();
    cases.forEach(dc => {
      // seizoen is array of term IDs from REST API
      if (dc.seizoen?.length > 0) {
        dc.seizoen.forEach(id => seasonIds.add(id));
      }
    });
    return seasonIds;
  }, [cases]);

  const handleRefresh = async () => {
    await queryClient.invalidateQueries({ queryKey: ['discipline-cases'] });
    await queryClient.invalidateQueries({ queryKey: ['seasons'] });
  };

  const handleSeasonChange = (e) => {
    const value = e.target.value;
    setSelectedSeasonId(value === '' ? null : parseInt(value, 10));
  };

  const isLoading = isCurrentSeasonLoading || (hasInitialized && isCasesLoading);

  return (
    <PullToRefreshWrapper onRefresh={handleRefresh}>
      <div className="max-w-7xl mx-auto space-y-6">
        {/* Header */}
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <h1 className="text-2xl font-bold text-gray-900 dark:text-gray-100">Tuchtzaken</h1>
            <p className="mt-1 text-sm text-gray-500 dark:text-gray-400">
              Overzicht van tuchtrechtelijke procedures en dossiers
            </p>
          </div>

          {/* Season Filter */}
          <div className="flex items-center gap-2">
            <Filter className="w-4 h-4 text-gray-400" />
            <select
              value={selectedSeasonId ?? ''}
              onChange={handleSeasonChange}
              className="text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-50 rounded-lg px-3 py-2 focus:ring-accent-500 focus:border-accent-500"
            >
              <option value="">Alle seizoenen</option>
              {seasons.map(season => (
                <option key={season.id} value={season.id}>
                  {season.name}
                </option>
              ))}
            </select>
          </div>
        </div>

        {/* Error state */}
        {casesError && (
          <div className="card p-6 text-center">
            <p className="text-red-600 dark:text-red-400">
              Tuchtzaken konden niet worden geladen.
            </p>
          </div>
        )}

        {/* Table */}
        <div className="card">
          <DisciplineCaseTable
            cases={cases}
            showPersonColumn={true}
            personMap={personMap}
            isLoading={isLoading}
          />
        </div>

        {/* Empty state for filtered view */}
        {!isLoading && !casesError && cases?.length === 0 && selectedSeasonId && (
          <div className="card p-12 text-center">
            <div className="flex justify-center mb-4">
              <div className="p-4 bg-gray-100 rounded-full dark:bg-gray-700">
                <Gavel className="w-12 h-12 text-gray-400 dark:text-gray-500" />
              </div>
            </div>
            <h2 className="text-xl font-semibold text-gray-900 mb-2 dark:text-gray-100">
              Geen tuchtzaken in dit seizoen
            </h2>
            <p className="text-gray-600 dark:text-gray-400">
              Selecteer een ander seizoen of bekijk alle seizoenen.
            </p>
          </div>
        )}
      </div>
    </PullToRefreshWrapper>
  );
}
```

Key implementation notes:
- Default to current season from useCurrentSeason hook
- "Alle seizoenen" option (value="") means no filter
- Person data fetched in batch for efficient display
- personMap passed to table for avatar/name display
- Empty state shows when filtered season has no cases
- Pull-to-refresh for mobile
- Dutch labels throughout
  </action>
  <verify>npm run lint passes. Navigate to /discipline-cases in browser (requires fairplay capability).</verify>
  <done>List page shows discipline cases with season filter dropdown, table with expandable rows</done>
</task>

</tasks>

<verification>
1. npm run lint passes with no errors
2. npm run build succeeds
3. Navigate to /discipline-cases route (as fairplay user)
4. Season dropdown shows seasons, defaults to current season
5. "Alle seizoenen" option shows all cases across seasons
6. Table shows Person, Match (with date), Sanction, Fee columns
7. Clicking row expands inline details
8. Sort icon on Match column toggles date sort order
9. Person column links to person profile
</verification>

<success_criteria>
- DisciplineCaseTable component is reusable (accepts showPersonColumn prop)
- List page displays at /discipline-cases route
- Table shows correct columns with proper formatting
- Season filter works (defaults to current, allows "Alle seizoenen")
- Row expansion shows charges, full sanction, team, dossier details
- Date sorting works (ascending/descending toggle)
- Dutch labels used throughout
</success_criteria>

<output>
After completion, create `.planning/phases/134-discipline-cases-ui/134-02-SUMMARY.md`
</output>
