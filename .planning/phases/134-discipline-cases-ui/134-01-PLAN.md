---
phase: 134-discipline-cases-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/client.js
  - src/hooks/useDisciplineCases.js
autonomous: true

must_haves:
  truths:
    - "Discipline cases can be fetched from REST API"
    - "Seasons (seizoen taxonomy) can be fetched from REST API"
    - "React hooks provide discipline cases data with loading/error states"
    - "Hooks support filtering by season and person"
  artifacts:
    - path: "src/api/client.js"
      provides: "getDisciplineCases, getSeasons API methods"
      contains: "getDisciplineCases"
    - path: "src/hooks/useDisciplineCases.js"
      provides: "useDisciplineCases, useSeasons, usePersonDisciplineCases hooks"
      exports: ["useDisciplineCases", "useSeasons", "usePersonDisciplineCases"]
  key_links:
    - from: "src/hooks/useDisciplineCases.js"
      to: "src/api/client.js"
      via: "wpApi.getDisciplineCases"
      pattern: "wpApi\\.getDisciplineCases"
---

<objective>
Create API integration and React hooks for discipline cases data fetching

Purpose: Provide reusable data layer for discipline cases list page and person tab
Output: API methods in client.js, custom hooks for discipline cases and seasons
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/132-data-foundation/132-01-SUMMARY.md
@src/api/client.js
@src/hooks/usePeople.js (for hook patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add discipline cases and seizoen API methods to client.js</name>
  <files>src/api/client.js</files>
  <action>
Add the following methods to the wpApi object in client.js:

```javascript
// Discipline Cases
getDisciplineCases: (params) => api.get('/wp/v2/discipline-cases', { params }),
getDisciplineCase: (id, params = {}) => api.get(`/wp/v2/discipline-cases/${id}`, { params }),

// Seizoen taxonomy (for season filter)
getSeasons: (params) => api.get('/wp/v2/seizoen', { params: { per_page: 100, orderby: 'name', order: 'desc', ...params } }),
```

The discipline-cases endpoint uses standard WordPress REST API (show_in_rest: true from Phase 132).
Seizoen terms sorted by name descending (most recent first like "2025-2026").

Add to prmApi object:

```javascript
// Current season helper
getCurrentSeason: () => api.get('/stadion/v1/current-season'),
```

Note: The current season helper uses the get_current_season() method from Phase 132.
  </action>
  <verify>Check client.js contains getDisciplineCases, getSeasons, and getCurrentSeason methods</verify>
  <done>API client has methods to fetch discipline cases, seasons, and current season</done>
</task>

<task type="auto">
  <name>Task 2: Create useDisciplineCases hook with season filtering</name>
  <files>src/hooks/useDisciplineCases.js</files>
  <action>
Create a new file src/hooks/useDisciplineCases.js with TanStack Query hooks:

```javascript
import { useQuery } from '@tanstack/react-query';
import { wpApi, prmApi } from '@/api/client';

// Query keys for cache management
export const disciplineCaseKeys = {
  all: ['discipline-cases'],
  lists: () => [...disciplineCaseKeys.all, 'list'],
  list: (filters) => [...disciplineCaseKeys.lists(), filters],
  byPerson: (personId) => [...disciplineCaseKeys.all, 'person', personId],
  seasons: ['seasons'],
  currentSeason: ['current-season'],
};

/**
 * Hook to fetch discipline cases with optional season filter
 * @param {Object} options
 * @param {number|null} options.seizoen - Season term ID to filter by (null for all seasons)
 * @param {boolean} options.enabled - Whether to enable the query
 */
export function useDisciplineCases({ seizoen = null, enabled = true } = {}) {
  return useQuery({
    queryKey: disciplineCaseKeys.list({ seizoen }),
    queryFn: async () => {
      const params = {
        per_page: 100,
        _embed: true, // Include person data
        orderby: 'date',
        order: 'desc',
      };

      // Filter by season if specified
      if (seizoen) {
        params.seizoen = seizoen;
      }

      const response = await wpApi.getDisciplineCases(params);
      return response.data;
    },
    enabled,
  });
}

/**
 * Hook to fetch discipline cases for a specific person
 * @param {number} personId - Person post ID
 * @param {Object} options
 * @param {boolean} options.enabled - Whether to enable the query
 */
export function usePersonDisciplineCases(personId, { enabled = true } = {}) {
  return useQuery({
    queryKey: disciplineCaseKeys.byPerson(personId),
    queryFn: async () => {
      const params = {
        per_page: 100,
        _embed: true,
        // ACF meta query for person field
        'filter[meta_key]': 'person',
        'filter[meta_value]': personId,
        orderby: 'date',
        order: 'desc',
      };

      // Note: If ACF filtering doesn't work, we may need to filter client-side
      // Fallback: fetch all and filter by acf.person === personId
      const response = await wpApi.getDisciplineCases(params);

      // Client-side filter as fallback (ACF post_object returns integer)
      return response.data.filter(dc => dc.acf?.person === parseInt(personId, 10));
    },
    enabled: !!personId && enabled,
  });
}

/**
 * Hook to fetch all seasons (seizoen taxonomy terms)
 */
export function useSeasons() {
  return useQuery({
    queryKey: disciplineCaseKeys.seasons,
    queryFn: async () => {
      const response = await wpApi.getSeasons();
      return response.data;
    },
  });
}

/**
 * Hook to get current season term
 */
export function useCurrentSeason() {
  return useQuery({
    queryKey: disciplineCaseKeys.currentSeason,
    queryFn: async () => {
      const response = await prmApi.getCurrentSeason();
      return response.data;
    },
  });
}
```

Key implementation notes:
- Uses _embed=true to include related data (though person is ACF post_object, needs client-side handling)
- Person filter uses client-side filtering as fallback (ACF meta queries can be unreliable)
- Seasons sorted by name desc (2025-2026 before 2024-2025)
- Current season uses Phase 132's get_current_season() helper
  </action>
  <verify>Run `npm run lint` to check for syntax errors. Verify file exports useDisciplineCases, usePersonDisciplineCases, useSeasons, useCurrentSeason</verify>
  <done>React hooks exist for fetching discipline cases with season filtering and person filtering</done>
</task>

<task type="auto">
  <name>Task 3: Add backend endpoint for current season</name>
  <files>includes/class-rest-api.php</files>
  <action>
Add a new REST endpoint to expose the current season term. In the register_routes() method:

```php
register_rest_route(
    $this->namespace,
    '/current-season',
    [
        'methods'             => 'GET',
        'callback'            => [ $this, 'get_current_season' ],
        'permission_callback' => [ $this, 'check_user_permissions' ],
    ]
);
```

Add the callback method:

```php
/**
 * Get the current season term
 *
 * @return WP_REST_Response
 */
public function get_current_season() {
    // Use the helper from STADION_Taxonomies
    $current_season = STADION_Taxonomies::get_current_season();

    if ( ! $current_season ) {
        return rest_ensure_response( null );
    }

    return rest_ensure_response( [
        'id'   => $current_season->term_id,
        'name' => $current_season->name,
        'slug' => $current_season->slug,
    ] );
}
```

Note: The get_current_season() static method was added in Phase 132 to STADION_Taxonomies class.
  </action>
  <verify>Test endpoint: `curl -s "https://[site]/wp-json/stadion/v1/current-season" -H "Cookie: [auth]"` returns current season or null</verify>
  <done>Backend REST endpoint returns current season term data</done>
</task>

</tasks>

<verification>
1. npm run lint passes with no errors
2. src/api/client.js contains getDisciplineCases, getSeasons methods
3. src/hooks/useDisciplineCases.js exports useDisciplineCases, useSeasons, useCurrentSeason, usePersonDisciplineCases
4. Backend /stadion/v1/current-season endpoint returns season data
</verification>

<success_criteria>
- API methods added to client.js for discipline cases and seasons
- React hooks created with TanStack Query patterns
- Hooks support season filtering and person filtering
- Backend current-season endpoint functional
- All code passes lint
</success_criteria>

<output>
After completion, create `.planning/phases/134-discipline-cases-ui/134-01-SUMMARY.md`
</output>
