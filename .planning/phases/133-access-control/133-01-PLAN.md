---
phase: 133-access-control
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-user-roles.php
  - includes/class-rest-api.php
  - src/App.jsx
  - src/components/layout/Layout.jsx
autonomous: true

must_haves:
  truths:
    - "Administrators have fairplay capability after theme activation"
    - "Users without fairplay capability cannot access /discipline-cases route"
    - "Users without fairplay capability do not see Tuchtzaken navigation item"
  artifacts:
    - path: "includes/class-user-roles.php"
      provides: "fairplay capability registration"
      contains: "add_cap.*fairplay"
    - path: "includes/class-rest-api.php"
      provides: "can_access_fairplay in user response"
      contains: "can_access_fairplay"
    - path: "src/App.jsx"
      provides: "FairplayRoute wrapper component"
      contains: "FairplayRoute"
    - path: "src/components/layout/Layout.jsx"
      provides: "Conditional Tuchtzaken navigation"
      contains: "can_access_fairplay"
  key_links:
    - from: "includes/class-user-roles.php"
      to: "administrator role"
      via: "get_role()->add_cap('fairplay')"
      pattern: "add_cap.*fairplay"
    - from: "includes/class-rest-api.php"
      to: "current_user_can('fairplay')"
      via: "capability check"
      pattern: "current_user_can.*fairplay"
    - from: "src/App.jsx"
      to: "/api/stadion/v1/user/me"
      via: "useQuery for current-user"
      pattern: "can_access_fairplay"
---

<objective>
Implement capability-based access control for discipline case data using the `fairplay` capability.

Purpose: Restrict sensitive disciplinary information to authorized users only. Users without fairplay capability cannot access discipline cases via the UI (both route and navigation hidden). Follows existing pattern for admin-only features.

Output: Backend capability registration, REST API capability exposure, React route protection, and conditional navigation rendering.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/133-access-control/133-RESEARCH.md

# Key existing files
@includes/class-user-roles.php
@includes/class-rest-api.php
@src/App.jsx
@src/components/layout/Layout.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register fairplay capability and expose in REST API</name>
  <files>
    includes/class-user-roles.php
    includes/class-rest-api.php
  </files>
  <action>
    **In class-user-roles.php:**

    1. Add constant for capability name at top of UserRoles class:
       ```php
       const FAIRPLAY_CAPABILITY = 'fairplay';
       ```

    2. In `register_role()` method, after existing role registration, add fairplay capability to administrator role:
       ```php
       // Add fairplay capability to administrator role
       $admin_role = get_role('administrator');
       if ($admin_role) {
           $admin_role->add_cap(self::FAIRPLAY_CAPABILITY);
       }
       ```

    3. In `remove_role()` method, before existing role removal code, remove fairplay capability:
       ```php
       // Remove fairplay capability from administrator role
       $admin_role = get_role('administrator');
       if ($admin_role) {
           $admin_role->remove_cap(self::FAIRPLAY_CAPABILITY);
       }
       ```

    **In class-rest-api.php:**

    1. In `get_current_user()` method (around line 2299), add `can_access_fairplay` to the response array:
       ```php
       return rest_ensure_response(
           [
               'id'                 => $user_id,
               'name'               => $user->display_name,
               'email'              => $user->user_email,
               'avatar_url'         => $avatar_url,
               'is_admin'           => $is_admin,
               'is_approved'        => $is_approved,
               'can_access_fairplay' => current_user_can('fairplay'),
               'profile_url'        => $profile_url,
               'admin_url'          => $admin_url,
           ]
       );
       ```
  </action>
  <verify>
    1. Check capability is added to admin role:
       ```bash
       source .env && ssh -p "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" \
         "cd ~/www/stadion.svawc.nl/public_html/wp-content/themes/stadion && \
         wp eval 'var_dump(get_role(\"administrator\")->has_cap(\"fairplay\"));'"
       ```
       Should output: bool(true)

    2. Test REST API returns capability:
       ```bash
       # After deployment, check the /user/me endpoint includes can_access_fairplay
       ```
  </verify>
  <done>
    - `fairplay` capability constant defined in UserRoles class
    - Capability added to administrator role in register_role()
    - Capability removed from administrator role in remove_role()
    - get_current_user() returns can_access_fairplay field
  </done>
</task>

<task type="auto">
  <name>Task 2: Add React route protection and conditional navigation</name>
  <files>
    src/App.jsx
    src/components/layout/Layout.jsx
  </files>
  <action>
    **In src/App.jsx:**

    1. Add `Shield` to lucide-react imports:
       ```jsx
       import { AlertCircle, RefreshCw, Shield } from 'lucide-react';
       ```

    2. Add `useNavigate` to react-router-dom imports (already imported in file).

    3. Create FairplayRoute component after ApprovalCheck component (around line 122):
       ```jsx
       function FairplayRoute({ children }) {
         const navigate = useNavigate();
         const { data: user, isLoading } = useQuery({
           queryKey: ['current-user'],
           queryFn: async () => {
             const response = await prmApi.getCurrentUser();
             return response.data;
           },
           retry: false,
         });

         if (isLoading) {
           return (
             <div className="flex items-center justify-center min-h-screen bg-gray-50">
               <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-accent-600"></div>
             </div>
           );
         }

         // User doesn't have fairplay capability
         if (!user?.can_access_fairplay) {
           return (
             <div className="flex items-center justify-center min-h-screen bg-gray-50 dark:bg-gray-900">
               <div className="max-w-md w-full mx-4">
                 <div className="card p-8 text-center">
                   <div className="flex justify-center mb-4">
                     <div className="p-3 bg-red-100 rounded-full dark:bg-red-900">
                       <Shield className="w-8 h-8 text-red-600 dark:text-red-400" />
                     </div>
                   </div>
                   <h2 className="text-2xl font-semibold text-gray-900 mb-2 dark:text-gray-100">
                     Geen toegang
                   </h2>
                   <p className="text-gray-600 mb-6 dark:text-gray-400">
                     Je hebt geen toestemming om deze pagina te bekijken.
                   </p>
                   <button
                     onClick={() => navigate(-1)}
                     className="btn btn-secondary"
                   >
                     Ga terug
                   </button>
                 </div>
               </div>
             </div>
           );
         }

         return children;
       }
       ```

    4. Add lazy import for DisciplineCasesList (add after other lazy imports around line 30):
       ```jsx
       const DisciplineCasesList = lazy(() => import('@/pages/DisciplineCases/DisciplineCasesList'));
       ```

    5. Add route for discipline cases inside the protected routes section (around line 203, after VOG route):
       ```jsx
       {/* Discipline Cases route - requires fairplay capability */}
       <Route path="/discipline-cases" element={
         <FairplayRoute>
           <DisciplineCasesList />
         </FairplayRoute>
       } />
       ```

    **In src/components/layout/Layout.jsx:**

    1. Add `Gavel` icon to lucide-react imports:
       ```jsx
       import { ..., Gavel } from 'lucide-react';
       ```

    2. The navigation array is static. To make it dynamic based on capabilities, modify the Sidebar component to filter navigation items. Update the Sidebar function to accept and use user capability:

       First, add a query for current user in the Sidebar component (after the existing useAuth hook):
       ```jsx
       function Sidebar({ mobile = false, onClose, stats }) {
         const { logoutUrl } = useAuth();
         const { count: vogCount } = useVOGCount();

         // Fetch current user for capability check
         const { data: currentUser } = useQuery({
           queryKey: ['current-user'],
           queryFn: async () => {
             const response = await prmApi.getCurrentUser();
             return response.data;
           },
         });

         const canAccessFairplay = currentUser?.can_access_fairplay ?? false;
       ```

    3. Add Tuchtzaken to the navigation array with a `requiresFairplay` flag:
       ```jsx
       const navigation = [
         { name: 'Dashboard', href: '/', icon: Home },
         { name: 'Leden', href: '/people', icon: Users },
         { name: 'Contributie', href: '/contributie', icon: Coins, indent: true },
         { name: 'VOG', href: '/vog', icon: FileCheck, indent: true },
         { name: 'Tuchtzaken', href: '/discipline-cases', icon: Gavel, indent: true, requiresFairplay: true },
         { name: 'Teams', href: '/teams', icon: Building2 },
         { name: 'Commissies', href: '/commissies', icon: UsersRound },
         { name: 'Datums', href: '/dates', icon: Calendar },
         { name: 'Taken', href: '/todos', icon: CheckSquare },
         { name: 'Feedback', href: '/feedback', icon: MessageSquare },
         { name: 'Instellingen', href: '/settings', icon: Settings },
       ];
       ```

    4. In the navigation map inside Sidebar, filter out items that require fairplay if user doesn't have it:
       ```jsx
       <nav className="flex-1 px-2 py-4 space-y-1 overflow-y-auto">
         {navigation
           .filter(item => !item.requiresFairplay || canAccessFairplay)
           .map((item) => {
             const count = getCounts(item.name);
             return (
               // ... existing NavLink code
             );
           })}
       </nav>
       ```
  </action>
  <verify>
    1. Run npm build to verify no compilation errors:
       ```bash
       npm run build
       ```

    2. After deployment, test:
       - Admin user: should see Tuchtzaken in navigation, can access /discipline-cases
       - Non-fairplay user: should NOT see Tuchtzaken, accessing /discipline-cases shows "Geen toegang"
  </verify>
  <done>
    - FairplayRoute component created in App.jsx
    - Shield icon imported for access denied page
    - DisciplineCasesList lazy import added (placeholder for Phase 134)
    - /discipline-cases route wrapped in FairplayRoute
    - Tuchtzaken navigation item added with requiresFairplay flag
    - Navigation filtered based on user's fairplay capability
  </done>
</task>

</tasks>

<verification>
## Phase Verification

1. **Capability Registration:**
   - Administrator role has `fairplay` capability
   - Capability persists after page refresh
   - Capability is removed on theme deactivation

2. **REST API:**
   - `/stadion/v1/user/me` returns `can_access_fairplay: true` for admins
   - `/stadion/v1/user/me` returns `can_access_fairplay: false` for users without capability

3. **Route Protection:**
   - `/discipline-cases` shows "Geen toegang" for users without fairplay
   - `/discipline-cases` loads page content for users with fairplay (will be placeholder until Phase 134)

4. **Navigation:**
   - Tuchtzaken nav item visible for users with fairplay
   - Tuchtzaken nav item hidden for users without fairplay
</verification>

<success_criteria>
- ACCESS-01: `fairplay` capability defined and registered
- ACCESS-02: Admins auto-assigned fairplay capability on theme activation
- ACCESS-03: Discipline case list page restricted to users with fairplay capability
- ACCESS-04: (partial) Navigation item restricted to fairplay users (tab on person detail is Phase 134 scope)
</success_criteria>

<output>
After completion, create `.planning/phases/133-access-control/133-01-SUMMARY.md`
</output>
