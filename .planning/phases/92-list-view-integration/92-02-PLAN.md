---
phase: 92-list-view-integration
plan: 02
type: execute
wave: 2
depends_on: ["92-01"]
files_modified:
  - src/components/FieldFormPanel.jsx
  - src/components/CustomFieldColumn.jsx
  - src/pages/People/PeopleList.jsx
  - src/pages/Companies/CompaniesList.jsx
autonomous: true

must_haves:
  truths:
    - "Admin can toggle 'Show in list view' when editing a custom field"
    - "Admin can set column order for list view fields"
    - "Custom field columns appear in People list when enabled"
    - "Custom field columns appear in Organizations list when enabled"
    - "Column values render appropriately for each field type"
  artifacts:
    - path: "src/components/FieldFormPanel.jsx"
      provides: "Show in list view toggle and order input"
      contains: "show_in_list_view"
    - path: "src/components/CustomFieldColumn.jsx"
      provides: "Type-aware column renderer for list views"
      exports: ["default"]
    - path: "src/pages/People/PeopleList.jsx"
      provides: "Custom field column integration"
      contains: "listViewFields"
    - path: "src/pages/Companies/CompaniesList.jsx"
      provides: "Custom field column integration"
      contains: "listViewFields"
  key_links:
    - from: "src/pages/People/PeopleList.jsx"
      to: "/stadion/v1/custom-fields/person/metadata"
      via: "useQuery fetching field definitions"
      pattern: "custom-fields-metadata"
    - from: "src/components/CustomFieldColumn.jsx"
      to: "person.acf"
      via: "Reading field value from ACF object"
      pattern: "field.name"
---

<objective>
Integrate custom fields as columns in People and Organizations list views.

Purpose: Allow users to see custom field values at a glance in list views without navigating to detail pages.
Output: FieldFormPanel with list view settings, CustomFieldColumn component, and integrated list views showing custom field columns.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/92-list-view-integration/92-RESEARCH.md
@src/components/FieldFormPanel.jsx
@src/components/CustomFieldsSection.jsx
@src/pages/People/PeopleList.jsx
@src/pages/Companies/CompaniesList.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add list view settings to FieldFormPanel</name>
  <files>src/components/FieldFormPanel.jsx</files>
  <action>
1. Add to `getDefaultFormData()` function (around line 38-80):
```javascript
show_in_list_view: false,
list_view_order: 999,
```

2. In the `useEffect` that populates form data when editing (around line 123-192), add after existing field mappings:
```javascript
show_in_list_view: field.show_in_list_view ?? false,
list_view_order: field.list_view_order ?? 999,
```

3. In `handleSubmit()` function (around line 258-349), add before `await onSubmit(submitData)`:
```javascript
// List view settings
submitData.show_in_list_view = formData.show_in_list_view;
if (formData.show_in_list_view) {
  submitData.list_view_order = Number(formData.list_view_order) || 999;
}
```

4. Add a new "Display Options" section at the end of the form, BEFORE the Description field (around line 1245, before the instructions textarea). Use this structure:
```jsx
{/* Display Options */}
<div className="pt-4 border-t border-gray-200 dark:border-gray-700">
  <h4 className="text-sm font-medium text-gray-600 dark:text-gray-400 mb-3">Display Options</h4>
  <div className="space-y-3">
    <div className="flex items-center gap-2">
      <input
        id="show_in_list_view"
        name="show_in_list_view"
        type="checkbox"
        checked={formData.show_in_list_view}
        onChange={handleChange}
        className="w-4 h-4 rounded border-gray-300 dark:border-gray-600 text-accent-600 focus:ring-accent-500"
      />
      <label htmlFor="show_in_list_view" className="text-sm text-gray-700 dark:text-gray-300">
        Show as column in list view
      </label>
    </div>
    {formData.show_in_list_view && (
      <div>
        <label htmlFor="list_view_order" className={labelClass}>
          Column Order
        </label>
        <input
          id="list_view_order"
          name="list_view_order"
          type="number"
          min="1"
          max="999"
          value={formData.list_view_order}
          onChange={handleChange}
          placeholder="999"
          className={`${inputClass} w-24`}
        />
        <p className={hintClass}>Lower numbers appear first (1 = leftmost)</p>
      </div>
    )}
  </div>
</div>
```
  </action>
  <verify>
Build succeeds: `npm run build`
UI shows toggle and order field when editing custom field in Settings > Custom Fields.
  </verify>
  <done>Admin can toggle "Show in list view" and set column order when creating/editing custom fields.</done>
</task>

<task type="auto">
  <name>Task 2: Create CustomFieldColumn component</name>
  <files>src/components/CustomFieldColumn.jsx</files>
  <action>
Create a new component that renders custom field values in a compact format suitable for list view columns.

Key design decisions (from research):
- Text/textarea: Use `truncate block max-w-32` for narrow column width
- Number: Show with prepend/append decorators
- Email/URL: Clickable links with truncation
- Date: Format as "MMM d, yyyy" (short format)
- Select: Show selected value with truncation
- Checkbox: Show count if >2, else comma-separated
- True/False: Show Yes/No with color (green/gray)
- Image: 8x8 rounded thumbnail
- Color: 6x6 rounded swatch with border
- Relationship: Show name if single, count if multiple
- File/Link: Show "View" text (too complex for column)
- Empty values: Show "-" in gray italic

Reference `src/components/CustomFieldsSection.jsx` for type rendering patterns, but make them more compact.

```jsx
import { format } from 'date-fns';

export default function CustomFieldColumn({ field, value }) {
  if (value === null || value === undefined || value === '') {
    return <span className="text-gray-400 dark:text-gray-500">-</span>;
  }

  switch (field.type) {
    case 'text':
    case 'textarea':
      return <span className="truncate block max-w-32" title={String(value)}>{String(value)}</span>;

    case 'number':
      return (
        <span>
          {field.prepend && <span className="text-gray-400 dark:text-gray-500">{field.prepend}</span>}
          {value}
          {field.append && <span className="text-gray-400 dark:text-gray-500">{field.append}</span>}
        </span>
      );

    case 'email':
      return (
        <a
          href={`mailto:${value}`}
          className="text-accent-600 dark:text-accent-400 hover:underline truncate block max-w-32"
          title={value}
        >
          {value}
        </a>
      );

    case 'url':
      const displayUrl = value.replace(/^https?:\/\//, '').replace(/\/$/, '');
      return (
        <a
          href={value.startsWith('http') ? value : `https://${value}`}
          target="_blank"
          rel="noopener noreferrer"
          className="text-accent-600 dark:text-accent-400 hover:underline truncate block max-w-32"
          title={value}
        >
          {displayUrl}
        </a>
      );

    case 'date':
      try {
        return <span>{format(new Date(value), 'MMM d, yyyy')}</span>;
      } catch {
        return <span>{value}</span>;
      }

    case 'select':
      return <span className="truncate block max-w-32" title={value}>{value}</span>;

    case 'checkbox':
      if (!Array.isArray(value) || value.length === 0) return <span className="text-gray-400 dark:text-gray-500">-</span>;
      if (value.length <= 2) return <span className="truncate block max-w-32" title={value.join(', ')}>{value.join(', ')}</span>;
      return <span title={value.join(', ')}>{value.length} selected</span>;

    case 'true_false':
      return (
        <span className={value ? 'text-green-600 dark:text-green-400' : 'text-gray-400 dark:text-gray-500'}>
          {value ? (field.ui_on_text || 'Yes') : (field.ui_off_text || 'No')}
        </span>
      );

    case 'image':
      const imageUrl = typeof value === 'object' ? (value.sizes?.thumbnail || value.url) : value;
      return imageUrl ? (
        <img src={imageUrl} alt="" className="w-8 h-8 rounded object-cover" />
      ) : <span className="text-gray-400 dark:text-gray-500">-</span>;

    case 'color_picker':
      return (
        <div
          className="w-6 h-6 rounded border border-gray-200 dark:border-gray-600"
          style={{ backgroundColor: value }}
          title={value}
        />
      );

    case 'relationship':
      const items = Array.isArray(value) ? value : (value ? [value] : []);
      if (items.length === 0 || !items[0]) return <span className="text-gray-400 dark:text-gray-500">-</span>;
      if (items.length === 1) {
        const item = items[0];
        const name = typeof item === 'object' ? (item.post_title || item.title?.rendered) : `#${item}`;
        return <span className="truncate block max-w-32" title={name}>{name}</span>;
      }
      return <span title={items.map(i => typeof i === 'object' ? (i.post_title || i.title?.rendered) : `#${i}`).join(', ')}>{items.length} linked</span>;

    case 'file':
      const fileName = typeof value === 'object' ? value.filename : 'File';
      return <span className="text-gray-500 dark:text-gray-400 truncate block max-w-24" title={fileName}>{fileName}</span>;

    case 'link':
      if (typeof value === 'object' && value.url) {
        return (
          <a
            href={value.url}
            target="_blank"
            rel="noopener noreferrer"
            className="text-accent-600 dark:text-accent-400 hover:underline truncate block max-w-32"
            title={value.title || value.url}
          >
            {value.title || 'Link'}
          </a>
        );
      }
      return <span className="text-gray-400 dark:text-gray-500">-</span>;

    default:
      return <span className="truncate block max-w-32" title={String(value)}>{String(value)}</span>;
  }
}
```
  </action>
  <verify>
Build succeeds: `npm run build`
Component exports correctly.
  </verify>
  <done>CustomFieldColumn component handles all 14 field types with compact list view rendering.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate custom field columns into PeopleList and CompaniesList</name>
  <files>src/pages/People/PeopleList.jsx, src/pages/Companies/CompaniesList.jsx</files>
  <action>
Update BOTH list view files with the same pattern.

**For PeopleList.jsx:**

1. Add imports at top:
```javascript
import { prmApi } from '@/api/client';
import CustomFieldColumn from '@/components/CustomFieldColumn';
```

2. In the `PersonListView` component, add a query for custom field metadata (inside the component, before the return):
```javascript
// Fetch custom field definitions for list view columns
const { data: customFields = [] } = useQuery({
  queryKey: ['custom-fields-metadata', 'person'],
  queryFn: async () => {
    const response = await prmApi.getCustomFieldsMetadata('person');
    return response.data;
  },
});

// Filter to list-view-enabled fields, sorted by order
const listViewFields = useMemo(() => {
  return customFields
    .filter(f => f.show_in_list_view)
    .sort((a, b) => (a.list_view_order || 999) - (b.list_view_order || 999));
}, [customFields]);
```

3. In the `<thead>`, after the Labels SortableHeader (around line 167), add:
```jsx
{listViewFields.map(field => (
  <th
    key={field.key}
    scope="col"
    className="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider bg-gray-50 dark:bg-gray-800"
  >
    {field.label}
  </th>
))}
```

4. Pass listViewFields to PersonListRow by adding it to the props:
```jsx
<PersonListRow
  key={person.id}
  person={person}
  companyName={companyMap[person.id]}
  workspaces={workspaces}
  listViewFields={listViewFields}
  ...
/>
```

5. In `PersonListRow` component, add `listViewFields` to the destructured props and add cells after labels (around line 113):
```jsx
{listViewFields.map(field => (
  <td key={field.key} className="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">
    <CustomFieldColumn field={field} value={person.acf?.[field.name]} />
  </td>
))}
```

**For CompaniesList.jsx:**

Apply the same pattern but with 'company' post type:
1. Same imports
2. Query with `['custom-fields-metadata', 'company']` and `prmApi.getCustomFieldsMetadata('company')`
3. Add headers after Workspace column in OrganizationListView
4. Pass listViewFields to OrganizationListRow
5. Add cells in OrganizationListRow after workspace (around line 393)

The pattern is identical, just swap 'person' for 'company' and adjust the component/prop names accordingly.
  </action>
  <verify>
Build succeeds: `npm run build`

Test on production:
1. Create a custom field for People with "Show in list view" enabled
2. Add a value to a person
3. Navigate to People list - column should appear
4. Repeat for Organizations
  </verify>
  <done>Custom field columns appear in both People and Organizations list views when enabled by admin.</done>
</task>

</tasks>

<verification>
1. npm run build succeeds without errors
2. FieldFormPanel shows "Display Options" section with checkbox and order input
3. Toggling "Show in list view" saves to field definition
4. People list shows custom field columns for enabled fields
5. Organizations list shows custom field columns for enabled fields
6. All 14 field types render appropriately in columns
7. Column order respects list_view_order setting
8. New fields default to hidden (show_in_list_view: false)
</verification>

<success_criteria>
- DISP-05: Custom field columns appear in People list when enabled
- DISP-06: Custom field columns appear in Organizations list when enabled
- DISP-07: Column values render type-appropriately (truncated, icons, badges)
- SETT-06: Admin can toggle "Show in list view" per field
- SETT-07: Admin can configure column order for list view fields
</success_criteria>

<output>
After completion, create `.planning/phases/92-list-view-integration/92-02-SUMMARY.md`
</output>
