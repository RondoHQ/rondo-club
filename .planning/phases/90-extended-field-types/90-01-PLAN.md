---
phase: 90-extended-field-types
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/customfields/class-manager.php
  - includes/class-rest-custom-fields.php
autonomous: true

must_haves:
  truths:
    - "Image field type can be created and persisted via API"
    - "File field type can be created and persisted via API"
    - "Link field type can be created and persisted via API"
    - "Color picker field type can be created and persisted via API"
    - "Relationship field type can be created and persisted via API with cardinality option"
  artifacts:
    - path: "includes/customfields/class-manager.php"
      provides: "UPDATABLE_PROPERTIES extended with image, file, link, color_picker, relationship options"
      contains: "return_format"
    - path: "includes/class-rest-custom-fields.php"
      provides: "REST params for extended field types"
      contains: "post_type"
  key_links:
    - from: "includes/class-rest-custom-fields.php"
      to: "includes/customfields/class-manager.php"
      via: "Manager->create_field and Manager->update_field calls"
      pattern: "manager->create_field|manager->update_field"
---

<objective>
Extend the CustomFields Manager class and REST API to support the 5 extended field types: Image, File, Link, Color, and Relationship.

Purpose: Enable backend persistence of extended field type configurations before building the frontend UI.
Output: Updated Manager class and REST API supporting all ACF options for image, file, link, color_picker, and relationship field types.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/90-extended-field-types/90-CONTEXT.md
@includes/customfields/class-manager.php
@includes/class-rest-custom-fields.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Manager UPDATABLE_PROPERTIES for extended types</name>
  <files>includes/customfields/class-manager.php</files>
  <action>
Add the following properties to the UPDATABLE_PROPERTIES constant array for extended field types:

**Image field options:**
- `return_format` - string: 'array', 'url', or 'id' (ACF image return format)
- `preview_size` - string: image size for admin preview (e.g., 'thumbnail', 'medium')
- `library` - string: 'all' or 'uploadedTo' (restrict to current post's uploads)
- `min_width`, `max_width`, `min_height`, `max_height` - int: dimension constraints
- `min_size`, `max_size` - string: file size constraints (e.g., '1MB')
- `mime_types` - string: allowed types (but per CONTEXT.md, we allow all)

**File field options:**
- `return_format` - string: 'array', 'url', or 'id'
- `library` - string: 'all' or 'uploadedTo'
- `min_size`, `max_size` - string: file size constraints
- `mime_types` - string: allowed mime types

**Link field options (ACF stores as array with url, title, target):**
- No special ACF options needed - link is stored as {url, title, target} object

**Color picker field options:**
- `default_value` - string: default hex color
- `enable_opacity` - bool: false (we only support hex, no alpha)
- `return_format` - string: 'string' or 'array' (we use 'string' for hex)

**Relationship field options:**
- `post_type` - array: allowed post types to relate to (['person', 'company'])
- `min`, `max` - int: min/max selections (use max=1 for single, higher for multiple)
- `filters` - array: search filters to show (['search', 'post_type'])
- `return_format` - string: 'object' or 'id'

Note: Some properties like `return_format` are already in the array but are used differently by each field type. ACF handles this gracefully.
  </action>
  <verify>Inspect UPDATABLE_PROPERTIES array contains new properties for extended types</verify>
  <done>Manager class accepts image, file, color_picker, and relationship field options</done>
</task>

<task type="auto">
  <name>Task 2: Extend REST API parameters for extended types</name>
  <files>includes/class-rest-custom-fields.php</files>
  <action>
Update both `get_create_params()` and the `$optional_params` / `$updatable_params` arrays in `create_item()` and `update_item()` methods to include extended field type parameters:

**Add to get_create_params():**

```php
// Image field options
'return_format' => array(
    'type'        => 'string',
    'description' => 'Return format: array, url, or id (Image/File/Relationship field)',
),
'preview_size' => array(
    'type'        => 'string',
    'description' => 'Preview size in admin: thumbnail, medium, large (Image field)',
),
'library' => array(
    'type'        => 'string',
    'description' => 'Media library filter: all or uploadedTo (Image/File field)',
),
'min_width' => array(
    'type'        => 'integer',
    'description' => 'Minimum image width in pixels (Image field)',
),
'max_width' => array(
    'type'        => 'integer',
    'description' => 'Maximum image width in pixels (Image field)',
),
'min_height' => array(
    'type'        => 'integer',
    'description' => 'Minimum image height in pixels (Image field)',
),
'max_height' => array(
    'type'        => 'integer',
    'description' => 'Maximum image height in pixels (Image field)',
),
'min_size' => array(
    'type'        => 'string',
    'description' => 'Minimum file size e.g. 1MB (Image/File field)',
),
'max_size' => array(
    'type'        => 'string',
    'description' => 'Maximum file size e.g. 5MB (Image/File field)',
),
'mime_types' => array(
    'type'        => 'string',
    'description' => 'Allowed mime types comma-separated (Image/File field)',
),
// Relationship field options
'post_type' => array(
    'type'        => 'array',
    'description' => 'Allowed post types for relationship (Relationship field)',
    'items'       => array( 'type' => 'string' ),
),
'filters' => array(
    'type'        => 'array',
    'description' => 'Search filters to display (Relationship field)',
    'items'       => array( 'type' => 'string' ),
),
// Color picker options
'enable_opacity' => array(
    'type'        => 'boolean',
    'description' => 'Enable opacity/alpha slider (Color field)',
),
```

**Add to $optional_params array in create_item():**
```php
'return_format', 'preview_size', 'library', 'min_width', 'max_width',
'min_height', 'max_height', 'min_size', 'max_size', 'mime_types',
'post_type', 'filters', 'enable_opacity',
```

**Add same params to $updatable_params array in update_item().**
  </action>
  <verify>Run WP-CLI test: Create image field via REST API with return_format option and verify it persists</verify>
  <done>REST API accepts and persists all extended field type options</done>
</task>

<task type="auto">
  <name>Task 3: Test extended field types via API</name>
  <files></files>
  <action>
Test each extended field type creation via WP-CLI curl commands:

**Test Image field:**
```bash
wp eval "
\$result = wp_remote_post(rest_url('prm/v1/custom-fields/person'), array(
    'headers' => array('X-WP-Nonce' => wp_create_nonce('wp_rest')),
    'body' => array(
        'label' => 'Profile Photo Test',
        'type' => 'image',
        'return_format' => 'array',
        'preview_size' => 'thumbnail'
    )
));
print_r(json_decode(wp_remote_retrieve_body(\$result), true));
"
```

**Test Relationship field with cardinality:**
```bash
wp eval "
\$result = wp_remote_post(rest_url('prm/v1/custom-fields/person'), array(
    'headers' => array('X-WP-Nonce' => wp_create_nonce('wp_rest')),
    'body' => array(
        'label' => 'Related Contacts Test',
        'type' => 'relationship',
        'post_type' => array('person', 'company'),
        'min' => 0,
        'max' => 5,
        'return_format' => 'object'
    )
));
print_r(json_decode(wp_remote_retrieve_body(\$result), true));
"
```

Verify:
1. Fields are created successfully (no errors)
2. GET request returns the field with options intact
3. Options like return_format, post_type array are correctly persisted

After testing, delete test fields to keep database clean.
  </action>
  <verify>All 5 extended field types create successfully with options persisted</verify>
  <done>Backend fully supports extended field types via REST API</done>
</task>

</tasks>

<verification>
- [ ] Image field can be created with return_format, preview_size, library options
- [ ] File field can be created with return_format, library, size constraints
- [ ] Link field can be created (no special options, ACF handles natively)
- [ ] Color picker field can be created with default_value
- [ ] Relationship field can be created with post_type array and min/max for cardinality
- [ ] All options round-trip correctly (create -> get returns same values)
</verification>

<success_criteria>
REST API accepts POST requests for all 5 extended field types with type-specific options and persists them correctly in ACF database storage.
</success_criteria>

<output>
After completion, create `.planning/phases/90-extended-field-types/90-01-SUMMARY.md`
</output>
