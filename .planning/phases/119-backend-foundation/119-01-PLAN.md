---
phase: 119-backend-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-vog-email.php
  - includes/class-rest-api.php
  - functions.php
autonomous: true

must_haves:
  truths:
    - "VOG settings can be stored and retrieved via REST API"
    - "VOG emails can be sent via wp_mail() with custom from address"
    - "Email templates support variable substitution ({first_name}, {previous_vog_date})"
    - "VOG email sent date is recorded per person in post meta"
  artifacts:
    - path: "includes/class-vog-email.php"
      provides: "VOG email service class with send and template methods"
      min_lines: 100
      exports: ["STADION_VOG_Email"]
    - path: "includes/class-rest-api.php"
      provides: "VOG settings REST endpoints"
      contains: "vog/settings"
  key_links:
    - from: "includes/class-rest-api.php"
      to: "includes/class-vog-email.php"
      via: "instantiation for settings retrieval"
      pattern: "STADION_VOG_Email|VOGEmail"
    - from: "includes/class-vog-email.php"
      to: "wp_mail"
      via: "email sending"
      pattern: "wp_mail\\s*\\("
---

<objective>
Create the PHP backend infrastructure for VOG email management.

Purpose: Establish the foundation that enables sending VOG compliance emails to volunteers with configurable templates and tracking.

Output:
- `STADION_VOG_Email` class for email sending and template management
- REST API endpoints for VOG settings (GET/POST /stadion/v1/vog/settings)
- Post meta tracking for when VOG emails are sent to each person
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/119-backend-foundation/119-RESEARCH.md

# Reference files
@includes/class-email-channel.php (pattern for wp_mail with custom from address)
@includes/class-rest-api.php (pattern for REST route registration)
@functions.php (class loading pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VOG Email Service Class</name>
  <files>includes/class-vog-email.php</files>
  <action>
Create a new PHP class `STADION_VOG_Email` in the `Stadion\VOG` namespace with these methods:

1. **Settings retrieval methods:**
   - `get_from_email()`: Returns `stadion_vog_from_email` option or defaults to site admin email
   - `get_template_new()`: Returns `stadion_vog_template_new` option or default template
   - `get_template_renewal()`: Returns `stadion_vog_template_renewal` option or default template
   - `get_all_settings()`: Returns array with all three settings

2. **Settings update methods:**
   - `update_from_email(string $email)`: Validates with `sanitize_email()`, stores option
   - `update_template_new(string $template)`: Sanitizes with `sanitize_textarea_field()`, stores option
   - `update_template_renewal(string $template)`: Sanitizes with `sanitize_textarea_field()`, stores option

3. **Email sending method:**
   - `send(int $person_id, string $template_type)`:
     - Gets person's email from contact_info ACF field (first email type contact)
     - Returns WP_Error if no email found
     - Selects template based on `$template_type` ('new' or 'renewal')
     - Gets person's first_name for substitution
     - If renewal, gets `datum-vog` ACF field for `{previous_vog_date}` substitution
     - Calls `wp_mail()` with:
       - Custom from address via wp_mail_from/wp_mail_from_name filters (add before, remove after)
       - Content-Type: text/html; charset=UTF-8
     - On success: records `vog_email_sent_date` post meta with `current_time('Y-m-d H:i:s')`
     - Returns true on success, WP_Error on failure

4. **Variable substitution method (private):**
   - `substitute_variables(string $template, array $vars)`: str_replace for {first_name}, {previous_vog_date}

5. **Default templates:**
   - New volunteer template (Dutch):
     ```
     Beste {first_name},

     Als vrijwilliger bij onze vereniging vragen wij je om een Verklaring Omtrent Gedrag (VOG) aan te vragen.

     Dit is een wettelijke vereiste voor iedereen die werkt met minderjarigen.

     Je kunt de VOG gratis aanvragen via de KNVB. Meer informatie ontvang je van onze VOG-coordinator.

     Met sportieve groet,
     De vereniging
     ```
   - Renewal template (Dutch):
     ```
     Beste {first_name},

     Je huidige VOG-verklaring (van {previous_vog_date}) is ouder dan 3 jaar en moet vernieuwd worden.

     Wij verzoeken je vriendelijk om een nieuwe VOG aan te vragen.

     Met sportieve groet,
     De vereniging
     ```

Follow the pattern from `class-email-channel.php` for the wp_mail filter approach.
Use WordPress Options API for settings storage (get_option, update_option).
  </action>
  <verify>
`grep -l "class.*VOG" includes/class-vog-email.php` returns the file
`grep "wp_mail" includes/class-vog-email.php` shows wp_mail usage
`grep "vog_email_sent_date" includes/class-vog-email.php` shows tracking
  </verify>
  <done>
Class exists with send(), get_all_settings(), and template methods. Uses wp_mail() with custom from address, stores email sent date in post meta.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add VOG Settings REST Endpoints</name>
  <files>includes/class-rest-api.php</files>
  <action>
Add two REST routes for VOG settings in the `register_routes()` method:

1. **GET /stadion/v1/vog/settings**
   - Permission: `check_admin_permission` (admin only)
   - Returns: `{ from_email, template_new, template_renewal }` via `STADION_VOG_Email::get_all_settings()`

2. **POST /stadion/v1/vog/settings**
   - Permission: `check_admin_permission` (admin only)
   - Args: `from_email` (optional, email), `template_new` (optional, string), `template_renewal` (optional, string)
   - Updates provided settings via corresponding update methods
   - Returns: Updated settings

Add the route registrations right after the existing user management routes (around line 460).

Pattern to follow (from existing code):
```php
register_rest_route(
    'stadion/v1',
    '/vog/settings',
    [
        [
            'methods'             => \WP_REST_Server::READABLE,
            'callback'            => [ $this, 'get_vog_settings' ],
            'permission_callback' => [ $this, 'check_admin_permission' ],
        ],
        [
            'methods'             => \WP_REST_Server::CREATABLE,
            'callback'            => [ $this, 'update_vog_settings' ],
            'permission_callback' => [ $this, 'check_admin_permission' ],
            'args'                => [
                'from_email' => [
                    'required'          => false,
                    'validate_callback' => function ( $param ) {
                        return empty( $param ) || is_email( $param );
                    },
                ],
                'template_new' => [
                    'required'          => false,
                ],
                'template_renewal' => [
                    'required'          => false,
                ],
            ],
        ],
    ]
);
```

Add callback methods `get_vog_settings()` and `update_vog_settings()` that instantiate `STADION_VOG_Email` and call appropriate methods.
  </action>
  <verify>
`grep -n "vog/settings" includes/class-rest-api.php` shows route registration
`grep -n "get_vog_settings\|update_vog_settings" includes/class-rest-api.php` shows callbacks
  </verify>
  <done>
GET and POST /stadion/v1/vog/settings endpoints exist. Admin-only access. Returns/updates from_email, template_new, template_renewal.
  </done>
</task>

<task type="auto">
  <name>Task 3: Register VOG Email Class and Verify</name>
  <files>functions.php</files>
  <action>
1. Add the VOG email class to the `stadion_init()` function where other classes are instantiated.

Find the section that loads classes (around line 95-120 in functions.php) and add:
```php
// VOG Email Service
require_once STADION_THEME_DIR . '/includes/class-vog-email.php';
```

No need to instantiate - it's used on-demand by REST API.

2. Add class alias for backward compatibility (following existing pattern):
```php
class_alias( 'Stadion\VOG\VOGEmail', 'STADION_VOG_Email' );
```

3. Test the setup by running:
- `npm run build` to ensure no PHP syntax errors break the theme
- Verify the class can be loaded
  </action>
  <verify>
`npm run build` completes without errors
`grep "class-vog-email" functions.php` shows the require
`grep "STADION_VOG_Email" functions.php` shows the class alias
  </verify>
  <done>
VOG email class is loaded by functions.php. Class alias exists for backward compatibility. Build passes.
  </done>
</task>

</tasks>

<verification>
1. PHP syntax check: `php -l includes/class-vog-email.php` returns no errors
2. REST endpoints exist: Deploy and test via curl:
   - `curl -X GET /wp-json/stadion/v1/vog/settings` (requires admin auth)
   - Returns JSON with from_email, template_new, template_renewal
3. Class structure: File contains namespace, class, send(), get_all_settings() methods
</verification>

<success_criteria>
- STADION_VOG_Email class exists with email sending and settings methods
- GET/POST /stadion/v1/vog/settings endpoints work (admin only)
- Default Dutch templates provided for new and renewal emails
- Email tracking uses vog_email_sent_date post meta
- Variable substitution supports {first_name} and {previous_vog_date}
- Build passes, no PHP errors
</success_criteria>

<output>
After completion, create `.planning/phases/119-backend-foundation/119-01-SUMMARY.md`
</output>
