---
phase: 156-fee-category-backend-logic
plan: 02
type: execute
wave: 2
depends_on: ["156-01"]
files_modified:
  - includes/class-rest-api.php
  - includes/class-rest-google-sheets.php
  - ../developer/src/content/docs/features/membership-fees.md
autonomous: true

must_haves:
  truths:
    - "REST API fee list endpoint sorts by category config sort_order instead of hardcoded array"
    - "Google Sheets export sorts by category config sort_order instead of hardcoded array"
    - "No hardcoded category_order arrays remain in PHP codebase"
    - "Developer documentation reflects the new config-driven fee engine"
  artifacts:
    - path: "includes/class-rest-api.php"
      provides: "Fee list endpoint using dynamic category sort order"
      contains: "get_category_sort_order"
    - path: "includes/class-rest-google-sheets.php"
      provides: "Google Sheets export using dynamic category sort order"
      contains: "get_category_sort_order"
  key_links:
    - from: "class-rest-api.php get_fee_list()"
      to: "MembershipFees::get_category_sort_order()"
      via: "method call replacing hardcoded category_order"
      pattern: "get_category_sort_order"
    - from: "class-rest-google-sheets.php fetch_fee_data()"
      to: "MembershipFees::get_category_sort_order()"
      via: "method call replacing hardcoded category_order"
      pattern: "get_category_sort_order"
---

<objective>
Replace hardcoded category_order arrays in the REST API and Google Sheets export with calls to the centralized get_category_sort_order() helper, and update developer documentation to reflect the new config-driven fee engine.

Purpose: The REST API and Google Sheets export are the two remaining locations with hardcoded category definitions. After this plan, zero hardcoded fee category references exist anywhere in the PHP backend. Documentation ensures future developers understand the new system.

Output: Updated REST API and Google Sheets export using dynamic sort order, plus comprehensive developer docs for the config-driven fee engine.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/156-fee-category-backend-logic/156-CONTEXT.md
@.planning/phases/156-fee-category-backend-logic/156-RESEARCH.md
@.planning/phases/156-fee-category-backend-logic/156-01-PLAN.md

Key source files (read these to find exact lines to change):
@includes/class-rest-api.php (line 2829: hardcoded category_order)
@includes/class-rest-google-sheets.php (line 927: hardcoded category_order)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace hardcoded category_order in REST API and Google Sheets</name>
  <files>includes/class-rest-api.php, includes/class-rest-google-sheets.php</files>
  <action>
Replace the two remaining hardcoded `$category_order` arrays with calls to the centralized `get_category_sort_order()` helper.

**1. In `includes/class-rest-api.php` around line 2828-2829:**

The `$fees` variable is already instantiated earlier in `get_fee_list()` (line 2736). The `$season` variable is also already available.

Replace line 2829:
```php
$category_order = [ 'mini' => 1, 'pupil' => 2, 'junior' => 3, 'senior' => 4, 'recreant' => 5, 'donateur' => 6 ];
```

With:
```php
$category_order = $fees->get_category_sort_order( $season );
```

The usort function below (lines 2830-2839) already uses `$category_order` correctly with the `?? 99` fallback, so no further changes needed there.

**2. In `includes/class-rest-google-sheets.php` around line 927:**

The `$fees` variable is already instantiated earlier in `fetch_fee_data()` (line 852). The `$season` variable is also already available.

Replace line 927:
```php
$category_order = [ 'mini' => 1, 'pupil' => 2, 'junior' => 3, 'senior' => 4, 'recreant' => 5, 'donateur' => 6 ];
```

With:
```php
$category_order = $fees->get_category_sort_order( $season );
```

The usort function below already uses `$category_order` correctly with the `?? 99` fallback.

**Important:** Verify both files still have valid PHP syntax after changes.
  </action>
  <verify>
Run `grep -rn "mini.*pupil.*junior.*senior.*recreant.*donateur" includes/class-rest-api.php includes/class-rest-google-sheets.php` -- should return zero matches (hardcoded arrays removed).

Run `grep -n 'get_category_sort_order' includes/class-rest-api.php includes/class-rest-google-sheets.php` -- should show exactly 1 match per file.

Run `php -l includes/class-rest-api.php` and `php -l includes/class-rest-google-sheets.php` -- both should pass syntax check.
  </verify>
  <done>
Both hardcoded category_order arrays replaced with dynamic get_category_sort_order() calls. Zero hardcoded fee category definitions remain in the PHP backend.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update developer documentation for config-driven fee engine</name>
  <files>../developer/src/content/docs/features/membership-fees.md</files>
  <action>
Update the developer documentation site at `../developer/src/content/docs/features/membership-fees.md` to reflect the Phase 156 changes.

Read the current file first, then update:

**1. Update the "Fee Category Configuration" section (added in Phase 155):**
- Change the data model description from `age_min`/`age_max` fields to `age_classes` array
- Document that `age_classes` stores Sportlink AgeClassDescription strings (e.g., `["Onder 9", "Onder 10", "Onder 11"]`)
- Document that null/empty `age_classes` makes a category a catch-all
- Add example of the updated data structure

**2. Add/update "Helper Methods" section:**
- Document `get_category_by_age_class( $leeftijdsgroep, $season )` -- replaces `parse_age_group()`
- Document `get_valid_category_slugs( $season )` -- replaces `VALID_TYPES` constant
- Document `get_youth_category_slugs( $season )` -- replaces hardcoded arrays
- Document `get_category_sort_order( $season )` -- replaces duplicated category_order arrays
- Note that all methods accept an optional `$season` parameter for forecast support

**3. Add "Removed / Deprecated" section:**
- `VALID_TYPES` constant: Removed in v21.0, use `get_valid_category_slugs()`
- `DEFAULTS` constant: Removed in v21.0, categories define amounts
- `parse_age_group()`: Removed in v21.0, use `get_category_by_age_class()`
- Hardcoded `category_order` arrays: Removed, use `get_category_sort_order()`
- Hardcoded `youth_categories` arrays: Removed, use `get_youth_category_slugs()`

**4. Update any existing code examples** that reference removed methods or constants.

This documentation is in the separate `developer` repo at `/Users/joostdevalk/Code/rondo/developer/`. Commit changes to that repo separately.
  </action>
  <verify>
Read the updated docs file and verify it documents:
- age_classes data model (not age_min/age_max)
- All 4 new helper methods
- Removed/deprecated items
- No references to VALID_TYPES, DEFAULTS, or parse_age_group as current API
  </verify>
  <done>
Developer documentation accurately reflects the config-driven fee engine with age_classes arrays, new helper methods, and deprecated items clearly documented.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. `grep -rn "'mini' => 1.*'pupil' => 2" includes/` returns nothing (all hardcoded category_order arrays removed)
2. `grep -rn 'get_category_sort_order' includes/` shows matches in class-rest-api.php and class-rest-google-sheets.php
3. `php -l includes/class-rest-api.php` passes
4. `php -l includes/class-rest-google-sheets.php` passes
5. Developer docs reference age_classes, get_category_by_age_class, and list deprecated items

Combined with Plan 01 verification, the full Phase 156 is verified:
- Zero hardcoded fee category definitions in the entire PHP codebase
- All category logic reads from per-season config
- Forecast mode works via season parameter flowing through entire chain
</verification>

<success_criteria>
No hardcoded category_order arrays remain in the PHP codebase. REST API and Google Sheets export use dynamic sort order from category config. Developer documentation is up to date with the new config-driven fee engine including age_classes data model, new helper methods, and deprecated items.
</success_criteria>

<output>
After completion, create `.planning/phases/156-fee-category-backend-logic/156-02-SUMMARY.md`
</output>
