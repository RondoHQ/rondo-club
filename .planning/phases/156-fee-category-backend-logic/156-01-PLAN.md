---
phase: 156-fee-category-backend-logic
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-membership-fees.php
autonomous: true

must_haves:
  truths:
    - "parse_age_group() is removed and replaced by get_category_by_age_class() which matches Sportlink age class strings against category config"
    - "VALID_TYPES and DEFAULTS constants are removed; category slugs derived dynamically from season config"
    - "youth_categories are derived from is_youth flag in season config, not hardcoded arrays"
    - "Category sort order is available via centralized get_category_sort_order() helper"
    - "calculate_fee() uses config-driven category matching for both current and forecast seasons"
    - "get_fee() reads amounts from category config objects instead of flat key-value pairs"
    - "Data model uses age_classes arrays instead of age_min/age_max fields"
  artifacts:
    - path: "includes/class-membership-fees.php"
      provides: "Config-driven fee calculation engine with age class matching"
      contains: "get_category_by_age_class"
  key_links:
    - from: "calculate_fee()"
      to: "get_category_by_age_class()"
      via: "method call replacing parse_age_group()"
      pattern: "get_category_by_age_class.*leeftijdsgroep"
    - from: "get_fee()"
      to: "get_categories_for_season()"
      via: "reads amount from category object"
      pattern: "get_categories_for_season"
    - from: "build_family_groups()"
      to: "get_youth_category_slugs()"
      via: "replaces hardcoded youth_categories array"
      pattern: "get_youth_category_slugs"
---

<objective>
Rewrite the MembershipFees class to replace all hardcoded fee category logic with config-driven lookups from per-season category data.

Purpose: This is the core engine change for v21.0 -- making fee categories fully configurable per season instead of hardcoded in PHP. Without this, the admin UI (Phase 158) and frontend display (Phase 159) have nothing to build on.

Output: A fully config-driven MembershipFees class where age group matching, valid types, youth categories, sort order, and fee amounts all come from the per-season category config stored in WordPress options.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/155-fee-category-data-model/155-01-SUMMARY.md
@.planning/phases/156-fee-category-backend-logic/156-CONTEXT.md
@.planning/phases/156-fee-category-backend-logic/156-RESEARCH.md

Key source file:
@includes/class-membership-fees.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update data model and add config-driven helper methods</name>
  <files>includes/class-membership-fees.php</files>
  <action>
Update the Phase 155 data model and add new config-driven helper methods to MembershipFees class. This task modifies the top half of the class (constants, helpers, age group matching).

**1. Remove hardcoded constants (lines 21-45):**
- Remove the `DEFAULTS` constant entirely (line 31-38). When no categories exist, empty array is the new default.
- Remove the `VALID_TYPES` constant entirely (line 45). Category slugs will be derived dynamically.

**2. Migrate data model from age_min/age_max to age_classes in `get_categories_for_season()` (around line 510-547):**

Phase 155 stored categories with `age_min`/`age_max` integer fields. Phase 156 CONTEXT.md requires `age_classes` arrays instead. The `get_categories_for_season()` method must detect and convert the old format on read.

**2a. Add on-read migration to `get_categories_for_season()`:**

After the line `return $stored;` (line 528) where it returns stored data as-is, add migration logic. Replace the early return with:

```php
// If season option exists and is an array, migrate if needed and return
if ( $stored !== false && is_array( $stored ) ) {
    $migrated = $this->maybe_migrate_age_classes( $stored );

    // If migration changed anything, persist the updated format
    if ( $migrated !== $stored ) {
        update_option( $season_key, $migrated );
    }

    return $migrated;
}
```

Apply the same migration after copy-forward from previous season (around line 540-541):

```php
if ( $previous_stored !== false && is_array( $previous_stored ) ) {
    $migrated = $this->maybe_migrate_age_classes( $previous_stored );
    update_option( $season_key, $migrated );
    return $migrated;
}
```

**2b. Add the `maybe_migrate_age_classes()` private helper** right before `get_categories_for_season()`:

```php
/**
 * Migrate category data from age_min/age_max format to age_classes format
 *
 * Phase 155 stored categories with age_min and age_max integer fields.
 * Phase 156 replaces these with an age_classes array of Sportlink
 * AgeClassDescription strings. This method detects the old format and
 * converts it, removing the age_min and age_max fields.
 *
 * Categories that already have age_classes (or have neither format)
 * are left unchanged.
 *
 * @param array $categories Slug-keyed array of category objects.
 * @return array Migrated categories with age_classes arrays.
 */
private function maybe_migrate_age_classes( array $categories ): array {
    $needs_migration = false;

    foreach ( $categories as $slug => $category ) {
        // Detect old format: has age_min or age_max but no age_classes
        if ( ( isset( $category['age_min'] ) || isset( $category['age_max'] ) )
             && ! isset( $category['age_classes'] ) ) {
            $needs_migration = true;

            // Set age_classes to empty array (catch-all) since we cannot
            // reverse-map age ranges to Sportlink age class strings.
            // Admin must populate the correct age_classes values manually.
            $categories[ $slug ]['age_classes'] = [];

            // Remove old fields
            unset( $categories[ $slug ]['age_min'] );
            unset( $categories[ $slug ]['age_max'] );
        }
    }

    return $categories;
}
```

**Note:** The migration sets `age_classes` to an empty array (making every migrated category a catch-all) because age ranges cannot be automatically converted to Sportlink age class strings. The admin must populate `age_classes` values for each category via the settings UI (Phase 158). This is a safe default: the lowest-sort-order catch-all will match, so fee calculation still works (just not with fine-grained category matching until age_classes are populated).

**2c. Update PHPDoc on `get_categories_for_season()`:**
- Update the docblock to reference `age_classes` instead of `age_min, age_max` in the category object description.
- Update `save_categories_for_season()` docblock similarly.
- Update `get_category()` docblock if it mentions age_min/age_max.

**3. Replace `parse_age_group()` (lines 177-229) with `get_category_by_age_class()`:**

Remove the entire `parse_age_group()` method and replace it with:

```php
/**
 * Find fee category by matching Sportlink age class against season config
 *
 * Replaces the former parse_age_group() method. Instead of hardcoded age ranges,
 * matches the member's Sportlink AgeClassDescription against the age_classes arrays
 * stored in the season's category configuration.
 *
 * Normalizes input by stripping " Meiden" and " Vrouwen" suffixes (Sportlink
 * appends these for girls' teams).
 *
 * If a class appears in multiple categories, the category with the lowest sort_order wins.
 * A category with null/empty age_classes acts as a catch-all for unmatched classes.
 *
 * @param string      $leeftijdsgroep Sportlink AgeClassDescription (e.g., "Onder 10", "Senioren").
 * @param string|null $season         Optional season key, defaults to current season.
 * @return string|null Category slug or null if no match and no catch-all exists.
 */
public function get_category_by_age_class( string $leeftijdsgroep, ?string $season = null ): ?string {
    $season     = $season ?? $this->get_season_key();
    $categories = $this->get_categories_for_season( $season );

    // Empty config = no categories defined (silent per CONTEXT.md)
    if ( empty( $categories ) ) {
        return null;
    }

    // Normalize: strip " Meiden" and " Vrouwen" suffixes
    $normalized = preg_replace( '/\s+(Meiden|Vrouwen)$/i', '', trim( $leeftijdsgroep ) );

    if ( empty( $normalized ) ) {
        return null;
    }

    // Sort by sort_order so lowest sort_order wins on overlap
    uasort( $categories, function ( $a, $b ) {
        return ( $a['sort_order'] ?? 999 ) <=> ( $b['sort_order'] ?? 999 );
    } );

    $catch_all_slug = null;

    foreach ( $categories as $slug => $category ) {
        // Validate required field (fail loudly per CONTEXT.md)
        if ( ! isset( $category['amount'] ) ) {
            // phpcs:ignore WordPress.PHP.DevelopmentFunctions.error_log_error_log
            error_log( "Rondo fee category '{$slug}' missing 'amount' for season {$season}" );
            return null;
        }

        $age_classes = $category['age_classes'] ?? null;

        // Null/empty age_classes = catch-all
        if ( $age_classes === null || ( is_array( $age_classes ) && empty( $age_classes ) ) ) {
            if ( $catch_all_slug === null ) {
                $catch_all_slug = $slug;
            }
            continue;
        }

        // Exact string match (case-insensitive)
        foreach ( (array) $age_classes as $age_class ) {
            if ( strcasecmp( $normalized, trim( $age_class ) ) === 0 ) {
                return $slug;
            }
        }
    }

    return $catch_all_slug;
}
```

**4. Add three new helper methods right after `get_category_by_age_class()`:**

```php
/**
 * Get valid category slugs for a season
 *
 * Replaces the former VALID_TYPES constant. Returns the category slugs
 * defined in the season's configuration.
 *
 * @param string|null $season Optional season key, defaults to current season.
 * @return array<string> Array of category slugs.
 */
public function get_valid_category_slugs( ?string $season = null ): array {
    $season     = $season ?? $this->get_season_key();
    $categories = $this->get_categories_for_season( $season );

    return array_keys( $categories );
}

/**
 * Get youth category slugs for a season
 *
 * Replaces all hardcoded youth_categories arrays. Returns category slugs
 * where is_youth flag is true in the season's configuration.
 *
 * @param string|null $season Optional season key, defaults to current season.
 * @return array<string> Array of youth category slugs.
 */
public function get_youth_category_slugs( ?string $season = null ): array {
    $season     = $season ?? $this->get_season_key();
    $categories = $this->get_categories_for_season( $season );

    return array_keys(
        array_filter(
            $categories,
            function ( $cat ) {
                return ! empty( $cat['is_youth'] );
            }
        )
    );
}

/**
 * Get category sort order map for a season
 *
 * Replaces all hardcoded category_order arrays. Returns a map of
 * category slug to sort_order value from the season's configuration.
 *
 * @param string|null $season Optional season key, defaults to current season.
 * @return array<string, int> Map of category slug => sort_order.
 */
public function get_category_sort_order( ?string $season = null ): array {
    $season     = $season ?? $this->get_season_key();
    $categories = $this->get_categories_for_season( $season );

    $order = [];
    foreach ( $categories as $slug => $category ) {
        $order[ $slug ] = $category['sort_order'] ?? 999;
    }

    return $order;
}
```

**5. Rewrite `get_fee()` (lines 144-155) to read from category config:**

Replace the current implementation that reads from flat settings with one that reads the `amount` from the category object:

```php
/**
 * Get a single fee amount by category slug
 *
 * Reads the amount from the category configuration for the specified season.
 *
 * @param string      $type   The fee category slug (e.g., "senior", "pupil").
 * @param string|null $season Optional season key, defaults to current season.
 * @return int The fee amount in euros, or 0 if category not found.
 */
public function get_fee( string $type, ?string $season = null ): int {
    $season   = $season ?? $this->get_season_key();
    $category = $this->get_category( $type, $season );

    if ( $category === null || ! isset( $category['amount'] ) ) {
        return 0;
    }

    return (int) $category['amount'];
}
```

**6. Rewrite `get_settings_for_season()` (lines 65-94) to use categories:**

This method is used by the REST API settings endpoint. Replace the DEFAULTS-based implementation:

```php
/**
 * Get fee settings for a specific season
 *
 * Returns a flat array of fee type => amount pairs for backward compatibility
 * with the REST API settings endpoint. Reads from the category configuration.
 *
 * @param string $season Season key in "YYYY-YYYY" format (e.g., "2025-2026").
 * @return array<string, int> Array of fee type => amount pairs.
 */
public function get_settings_for_season( string $season ): array {
    $categories = $this->get_categories_for_season( $season );

    $settings = [];
    foreach ( $categories as $slug => $category ) {
        $settings[ $slug ] = (int) ( $category['amount'] ?? 0 );
    }

    return $settings;
}
```

**7. Rewrite `update_settings_for_season()` (lines 103-125) to use categories:**

Update to modify amounts within category objects instead of flat key-value pairs:

```php
/**
 * Update fee amounts for a specific season
 *
 * Updates the amount field within category objects. Only modifies amounts
 * for categories that exist in the season's configuration.
 *
 * @param array<string, mixed> $fees   Array of category slug => amount pairs to update.
 * @param string               $season Season key in "YYYY-YYYY" format (e.g., "2025-2026").
 * @return bool True on success, false on failure.
 */
public function update_settings_for_season( array $fees, string $season ): bool {
    $categories  = $this->get_categories_for_season( $season );
    $valid_slugs = array_keys( $categories );

    foreach ( $fees as $type => $amount ) {
        // Skip categories not in this season's config
        if ( ! in_array( $type, $valid_slugs, true ) ) {
            continue;
        }

        // Validate: must be numeric and non-negative
        if ( ! is_numeric( $amount ) || $amount < 0 ) {
            continue;
        }

        $categories[ $type ]['amount'] = (int) $amount;
    }

    return $this->save_categories_for_season( $categories, $season );
}
```

**8. Update `get_all_settings()` (lines 132-135):** No change needed -- it already delegates to `get_settings_for_season()`.

**9. Update `update_settings()` (lines 163-166):** No change needed -- it already delegates to `update_settings_for_season()`.

**Important notes:**
- Keep OPTION_KEY constant (line 24) -- still used for migration detection in get_settings_for_season()
- Actually, remove the migration code from get_settings_for_season() since it now reads from categories. The old migration logic referenced DEFAULTS which no longer exists. The old global option `rondo_membership_fees` is legacy from before v12.0 season support.
  </action>
  <verify>
Run `grep -n 'VALID_TYPES\|DEFAULTS\|parse_age_group' includes/class-membership-fees.php` -- should return zero matches (constants and old method removed).

Run `grep -n 'get_category_by_age_class\|get_valid_category_slugs\|get_youth_category_slugs\|get_category_sort_order' includes/class-membership-fees.php` -- should show all 4 new methods exist.

Run `grep -n 'age_min\|age_max' includes/class-membership-fees.php` -- should only match inside `maybe_migrate_age_classes()` (migration detection), not in docblocks or data model references.

Run `grep -n 'maybe_migrate_age_classes' includes/class-membership-fees.php` -- should show the method definition and call sites in `get_categories_for_season()`.
  </verify>
  <done>
VALID_TYPES constant, DEFAULTS constant, and parse_age_group() method are completely removed. Four new config-driven helper methods exist: get_category_by_age_class(), get_valid_category_slugs(), get_youth_category_slugs(), get_category_sort_order(). Data model migration from age_min/age_max to age_classes is handled transparently in get_categories_for_season() via maybe_migrate_age_classes(). get_fee() reads from category config. get_settings_for_season() and update_settings_for_season() work with category objects. get_categories_for_season(), save_categories_for_season(), and get_category() docblocks reference age_classes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update fee calculation methods to use config-driven helpers</name>
  <files>includes/class-membership-fees.php</files>
  <action>
Update all fee calculation methods in MembershipFees to use the new config-driven helpers from Task 1. This task modifies the calculation methods in the second half of the class.

**1. Update `calculate_fee()` (around line 356):**

Replace the `parse_age_group()` call with `get_category_by_age_class()` and replace hardcoded youth category checks:

On the line `$category = $this->parse_age_group( $leeftijdsgroep );` change to:
```php
$category = $this->get_category_by_age_class( $leeftijdsgroep, $season );
```

On the line `if ( in_array( $category, [ 'mini', 'pupil', 'junior' ], true ) ) {` change to:
```php
$youth_categories = $this->get_youth_category_slugs( $season );
if ( in_array( $category, $youth_categories, true ) ) {
```

**2. Update `build_family_groups()` (around line 959):**

Replace the hardcoded `$youth_categories = [ 'mini', 'pupil', 'junior' ];` on line 978 with:
```php
$youth_categories = $this->get_youth_category_slugs( $season );
```

**3. Update `calculate_fee_with_family_discount()` (around line 1173):**

Replace the hardcoded `$youth_categories = [ 'mini', 'pupil', 'junior' ];` on line 1185 with:
```php
$youth_categories = $this->get_youth_category_slugs( $season );
```

**4. Update `get_calculation_status()` (around line 1327):**

Replace the `$this->parse_age_group( $leeftijdsgroep )` call on line 1329 with:
```php
$parsed = ! empty( $leeftijdsgroep ) ? $this->get_category_by_age_class( $leeftijdsgroep ) : null;
```

**5. Fix `get_fee_for_person()` (around line 682):**

The `calculate_fee()` call on line 682 currently does NOT pass `$season`. Fix it:
```php
$result = $this->calculate_fee( $person_id, $season );
```
This ensures the season parameter flows through the entire calculation chain, which is critical for forecast mode.

**Important:** After all changes, verify there are ZERO remaining references to:
- `parse_age_group` (replaced by `get_category_by_age_class`)
- `self::VALID_TYPES` (replaced by `$this->get_valid_category_slugs()`)
- `self::DEFAULTS` (removed entirely)
- Hardcoded `[ 'mini', 'pupil', 'junior' ]` arrays (replaced by `$this->get_youth_category_slugs()`)
  </action>
  <verify>
Run `grep -n "parse_age_group\|self::VALID_TYPES\|self::DEFAULTS\|'mini', 'pupil', 'junior'" includes/class-membership-fees.php` -- should return zero matches.

Run `grep -c 'get_category_by_age_class' includes/class-membership-fees.php` -- should show at least 3 occurrences (method definition + 2 call sites in calculate_fee and get_calculation_status).

Run `grep -c 'get_youth_category_slugs' includes/class-membership-fees.php` -- should show at least 4 occurrences (method definition + 3 call sites).
  </verify>
  <done>
All fee calculation methods use config-driven helpers. Zero hardcoded category references remain in class-membership-fees.php. The season parameter flows through the entire calculation chain including get_fee_for_person(). calculate_fee(), build_family_groups(), calculate_fee_with_family_discount(), and get_calculation_status() all use dynamic category lookups.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. `grep -rn 'VALID_TYPES\|DEFAULTS' includes/class-membership-fees.php` returns nothing
2. `grep -rn 'parse_age_group' includes/class-membership-fees.php` returns nothing
3. `grep -rn "'mini', 'pupil', 'junior'" includes/class-membership-fees.php` returns nothing
4. `grep -rn 'age_min\|age_max' includes/class-membership-fees.php` only matches inside `maybe_migrate_age_classes()` method (migration detection code), not in docblocks or other methods
5. New methods exist: get_category_by_age_class, get_valid_category_slugs, get_youth_category_slugs, get_category_sort_order, maybe_migrate_age_classes
6. `get_categories_for_season()` calls `maybe_migrate_age_classes()` on read to transparently convert old format
7. PHP syntax check passes: `php -l includes/class-membership-fees.php`
</verification>

<success_criteria>
The MembershipFees class has zero hardcoded category definitions. All fee category logic (age matching, valid types, youth detection, sort order, fee amounts) reads from the per-season category configuration stored in WordPress options. The season parameter flows through the entire calculation chain for correct forecast mode support.
</success_criteria>

<output>
After completion, create `.planning/phases/156-fee-category-backend-logic/156-01-SUMMARY.md`
</output>
