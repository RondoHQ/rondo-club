---
phase: 64-audit-planning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [.planning/phases/64-audit-planning/AUDIT.md, phpcs.xml.dist]
autonomous: true
---

<objective>
Audit PHP codebase to identify multi-class files, design folder structure, and plan namespace hierarchy for PSR-4 autoloading.

Purpose: Produce a detailed audit document that guides Phase 65 (splitting) and Phase 66 (PSR-4 autoloading).
Output: AUDIT.md with complete reteam plan.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Relevant source files:
@includes/class-notification-channels.php (known multi-class file)
@functions.php (contains current autoloader class map)
@phpcs.xml.dist (has Generic.Files.OneObjectStructurePerFile exclusion)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Complete codebase audit for multi-class files</name>
  <files>.planning/phases/64-audit-planning/AUDIT.md</files>
  <action>
Scan all PHP files in includes/ to identify:
1. Files containing multiple class/interface/trait definitions
2. Current file sizes and class counts per file
3. Any other teamal issues (deeply nested code, utility functions outside classes)

Document findings in AUDIT.md with:
- List of multi-class files with class names and line numbers
- Current folder structure overview
- Total class count and file count

Based on the initial exploration:
- `class-notification-channels.php` contains: STADION_Notification_Channel (abstract, line 15), STADION_Email_Channel (line 79), STADION_Slack_Channel (line 426)
- `carddav/` subfolder already exists with 3 backend classes

Verify no other multi-class files exist by grepping for `^class ` patterns and counting occurrences per file.
  </action>
  <verify>AUDIT.md exists with "Multi-Class Files" section listing all files needing splitting</verify>
  <done>Complete inventory of multi-class files documented</done>
</task>

<task type="auto">
  <name>Task 2: Design folder structure and namespace hierarchy</name>
  <files>.planning/phases/64-audit-planning/AUDIT.md</files>
  <action>
Add to AUDIT.md:

1. **Proposed Folder Structure:**
   Design logical groupings based on class responsibilities:
   - `includes/rest/` - All STADION_REST_* classes
   - `includes/notifications/` - Notification channel classes
   - `includes/calendar/` - Calendar-related classes (sync, providers, matcher)
   - `includes/import/` - Import classes (Monica, VCard, Google)
   - `includes/export/` - Export classes (VCard)
   - `includes/carddav/` - Already exists, keep as-is
   - `includes/core/` - Core classes (post types, taxonomies, access control)

2. **Namespace Hierarchy:**
   Plan PSR-4 compatible namespaces:
   - `Stadion\` as root namespace
   - `Stadion\REST\` for REST controllers
   - `Stadion\Notifications\` for notification channels
   - `Stadion\Calendar\` for calendar functionality
   - etc.

3. **Migration Strategy:**
   - Phase 65: Split multi-class files, move to new folders (keep old class names initially)
   - Phase 66: Add namespaces and convert autoloader to Composer PSR-4

Document each class with its:
- Current location
- Target location
- Current class name
- Target namespaced class name (for Phase 66)
  </action>
  <verify>AUDIT.md contains "Proposed Structure", "Namespace Hierarchy", and "Migration Plan" sections</verify>
  <done>Complete reteam plan documented with clear mapping of current → target state</done>
</task>

<task type="auto">
  <name>Task 3: Document PHPCS rule and verify plan completeness</name>
  <files>.planning/phases/64-audit-planning/AUDIT.md</files>
  <action>
Add to AUDIT.md:

1. **PHPCS Configuration:**
   - Document that `Generic.Files.OneObjectStructurePerFile` is currently excluded in phpcs.xml.dist line 37
   - Note that this exclusion can be removed after Phase 65 completes
   - List any other WPCS rules that may need attention during reteam

2. **Backward Compatibility Plan:**
   - Document that existing class names must continue working (no breaking changes)
   - Plan class aliases for any renamed classes
   - Ensure REST API endpoints remain unchanged

3. **Success Criteria for Phase 65-66:**
   - All files have exactly one class/interface/trait
   - Folder structure matches proposed design
   - PSR-4 autoloader replaces manual class map
   - PHPCS passes with Generic.Files.OneObjectStructurePerFile enabled
   - All existing tests pass
   - No breaking changes to class interfaces

4. **Final Review:**
   - Verify all 38+ classes in includes/ are accounted for in the migration plan
   - Ensure carddav/ backend classes are included
   - Count total files before/after to verify nothing lost
  </action>
  <verify>AUDIT.md is comprehensive with PHPCS notes, backward compatibility plan, and success criteria</verify>
  <done>Complete audit document ready to guide Phase 65-66 implementation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] AUDIT.md exists in .planning/phases/64-audit-planning/
- [ ] All multi-class files identified with specific class names and line numbers
- [ ] Proposed folder structure documented
- [ ] Namespace hierarchy planned
- [ ] Migration mapping complete (current → target for each class)
- [ ] Backward compatibility requirements documented
- [ ] Success criteria clear for subsequent phases
</verification>

<success_criteria>
- All tasks completed
- AUDIT.md is comprehensive and actionable
- Clear guidance for Phase 65 (splitting) and Phase 66 (PSR-4)
- No ambiguity about what needs to change
</success_criteria>

<output>
After completion, create `.planning/phases/64-audit-planning/64-01-SUMMARY.md`
</output>
