---
phase: 179-invoice-data-model-rest-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-post-types.php
  - acf-json/group_invoice_fields.json
  - includes/class-invoice-numbering.php
autonomous: true

must_haves:
  truths:
    - "rondo_invoice CPT is registered and queryable via WP_Query"
    - "Invoice statuses rondo_draft, rondo_sent, rondo_paid, rondo_overdue are registered"
    - "ACF field group exists with invoice_number, person, line_items repeater, total_amount, status, payment_link, pdf_path, sent_date, due_date"
    - "New invoices auto-generate invoice numbers in format 2026T001 (calendar year + T + sequential)"
  artifacts:
    - path: "includes/class-post-types.php"
      provides: "rondo_invoice CPT registration and invoice statuses"
      contains: "register_invoice_post_type"
    - path: "acf-json/group_invoice_fields.json"
      provides: "ACF field definitions for invoice data"
      contains: "group_invoice_fields"
    - path: "includes/class-invoice-numbering.php"
      provides: "Invoice number generation service"
      contains: "class InvoiceNumbering"
  key_links:
    - from: "includes/class-post-types.php"
      to: "rondo_invoice CPT"
      via: "register_post_type call"
      pattern: "register_post_type.*rondo_invoice"
    - from: "includes/class-invoice-numbering.php"
      to: "rondo_invoice CPT"
      via: "WP_Query for existing invoice numbers"
      pattern: "WP_Query.*rondo_invoice"
---

<objective>
Register the Invoice custom post type with lifecycle statuses, define ACF fields for invoice data, and create the invoice numbering service.

Purpose: Establish the data model foundation that the REST API (Plan 02) and all subsequent invoice phases depend on.
Output: Invoice CPT with statuses, ACF field group JSON, invoice numbering class.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@includes/class-post-types.php
@acf-json/group_discipline_case_fields.json
@includes/class-user-roles.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register Invoice CPT, statuses, and ACF fields</name>
  <files>includes/class-post-types.php, acf-json/group_invoice_fields.json</files>
  <action>
**In `includes/class-post-types.php`:**

1. Add `$this->register_invoice_statuses();` and `$this->register_invoice_post_type();` calls to `register_post_types()` method.

2. Create `register_invoice_statuses()` method (follow the todo statuses pattern):
   - `rondo_draft` — label "Concept" (Dutch)
   - `rondo_sent` — label "Verstuurd"
   - `rondo_paid` — label "Betaald"
   - `rondo_overdue` — label "Verlopen"
   All with `public => true`, `show_in_admin_all_list => true`, `show_in_admin_status_list => true`.

3. Create `register_invoice_post_type()` method (follow discipline_case pattern):
   - Post type slug: `rondo_invoice`
   - Dutch labels: "Facturen" (plural), "Factuur" (singular)
   - `public => false`, `publicly_queryable => false`, `show_ui => true`, `show_in_menu => true`
   - `show_in_rest => true`, `rest_base => 'invoices'`
   - `capability_type => 'post'`, `hierarchical => false`
   - `menu_position => 10`, `menu_icon => 'dashicons-media-text'`
   - `supports => ['title', 'author']`

**Create `acf-json/group_invoice_fields.json`:**

Create an ACF field group JSON file following the discipline_case pattern with these fields:

- `field_invoice_number` — text, label "Factuurnummer", required, read-only (auto-generated), width 33
- `field_invoice_person` — post_object, label "Persoon", post_type ["person"], multiple 0, return_format "id", required 1, width 33
- `field_invoice_status` — select, label "Status", choices: draft=Concept, sent=Verstuurd, paid=Betaald, overdue=Verlopen, default "draft", required 1, width 33
- `field_invoice_line_items` — repeater, label "Regelitems", layout "table", sub_fields:
  - `field_invoice_line_discipline_case` — post_object, label "Tuchtzaak", post_type ["discipline_case"], return_format "id", required 1
  - `field_invoice_line_description` — text, label "Omschrijving", required 0
  - `field_invoice_line_amount` — number, label "Bedrag", prepend euro, min 0, step 0.01, required 1
- `field_invoice_total_amount` — number, label "Totaalbedrag", prepend euro, min 0, step 0.01, required 1, width 33
- `field_invoice_payment_link` — url, label "Betaallink", required 0, width 33
- `field_invoice_pdf_path` — text, label "PDF pad", required 0, width 33 (internal use, stores relative path)
- `field_invoice_sent_date` — date_picker, label "Verzenddatum", display_format "d-m-Y", return_format "Ymd", required 0, width 33
- `field_invoice_due_date` — date_picker, label "Vervaldatum", display_format "d-m-Y", return_format "Ymd", required 0, width 33

Location rule: post_type == rondo_invoice. Set `show_in_rest: 1`, `active: true`.
  </action>
  <verify>
Run `grep -c "rondo_invoice" includes/class-post-types.php` to confirm CPT registration. Verify `acf-json/group_invoice_fields.json` exists and is valid JSON with `python3 -m json.tool acf-json/group_invoice_fields.json > /dev/null`.
  </verify>
  <done>
rondo_invoice CPT registered with 4 custom statuses. ACF field group JSON defines all invoice fields including line_items repeater with discipline_case relationship.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create invoice numbering service</name>
  <files>includes/class-invoice-numbering.php</files>
  <action>
Create `includes/class-invoice-numbering.php` with namespace `Rondo\Finance`:

```php
class InvoiceNumbering {
    /**
     * Generate the next invoice number for the current calendar year.
     * Format: 2026T001 (YYYY + T + zero-padded 3-digit sequential)
     *
     * Queries existing rondo_invoice posts for the current year to find the
     * highest existing number, then increments by 1.
     *
     * @return string The generated invoice number (e.g., "2026T001")
     */
    public static function generate_next(): string
```

Implementation:
1. Get current year via `gmdate('Y')`.
2. Build prefix: `$year . 'T'`.
3. Query all rondo_invoice posts (any status) where `invoice_number` meta starts with the year prefix. Use `WP_Query` with `meta_query` — meta_key `invoice_number`, meta_value `$prefix`, compare `LIKE` with `$prefix . '%'`. Get all matching numbers.
4. Extract the numeric suffix from each existing number (e.g., "2026T003" -> 3), find max.
5. If no existing invoices for the year, start at 1.
6. Return `$prefix . str_pad($next_number, 3, '0', STR_PAD_LEFT)`.

Also add a static method `is_valid(string $number): bool` that validates the format matches `/^\d{4}T\d{3,}$/`.

Follow the existing PSR-4 namespace pattern. The class needs no constructor — it's a static utility.
  </action>
  <verify>
Verify file exists: `test -f includes/class-invoice-numbering.php && echo "EXISTS"`. Check PHP syntax: `php -l includes/class-invoice-numbering.php`.
  </verify>
  <done>
InvoiceNumbering class generates sequential invoice numbers in 2026T001 format, querying existing invoices to determine next number. Validation method confirms format correctness.
  </done>
</task>

</tasks>

<verification>
1. `grep "rondo_invoice" includes/class-post-types.php` shows CPT registration
2. `grep "rondo_draft\|rondo_sent\|rondo_paid\|rondo_overdue" includes/class-post-types.php` shows all 4 statuses
3. `python3 -m json.tool acf-json/group_invoice_fields.json > /dev/null` — valid JSON
4. `grep "field_invoice_line_items" acf-json/group_invoice_fields.json` — repeater field exists
5. `php -l includes/class-invoice-numbering.php` — no syntax errors
6. `grep "generate_next" includes/class-invoice-numbering.php` — numbering method exists
</verification>

<success_criteria>
- rondo_invoice CPT registered in class-post-types.php
- 4 invoice statuses registered (draft, sent, paid, overdue)
- ACF field group JSON with all required fields including line_items repeater
- InvoiceNumbering class generates 2026T001 format numbers
- All PHP files pass syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/179-invoice-data-model-rest-api/179-01-SUMMARY.md`
</output>
