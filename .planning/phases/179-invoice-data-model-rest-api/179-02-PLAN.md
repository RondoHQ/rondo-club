---
phase: 179-invoice-data-model-rest-api
plan: 02
type: execute
wave: 2
depends_on: ["179-01"]
files_modified:
  - includes/class-rest-invoices.php
  - functions.php
  - src/api/client.js
autonomous: true

must_haves:
  truths:
    - "GET /rondo/v1/invoices returns list of invoices with all ACF fields and person summary"
    - "GET /rondo/v1/invoices/{id} returns single invoice with full detail"
    - "POST /rondo/v1/invoices creates a new invoice in rondo_draft status with auto-generated invoice number"
    - "POST /rondo/v1/invoices/{id}/status updates invoice status"
    - "Overdue detection marks sent invoices as overdue when due_date has passed"
    - "Invoices REST API requires financieel capability"
  artifacts:
    - path: "includes/class-rest-invoices.php"
      provides: "Invoice CRUD REST endpoints"
      contains: "class Invoices extends Base"
    - path: "functions.php"
      provides: "Invoice classes loaded for REST requests"
      contains: "RESTInvoices"
    - path: "src/api/client.js"
      provides: "Frontend API methods for invoice operations"
      contains: "getInvoices"
  key_links:
    - from: "includes/class-rest-invoices.php"
      to: "includes/class-invoice-numbering.php"
      via: "InvoiceNumbering::generate_next() call on create"
      pattern: "InvoiceNumbering::generate_next"
    - from: "includes/class-rest-invoices.php"
      to: "rondo_invoice CPT"
      via: "WP_Query and wp_insert_post"
      pattern: "post_type.*rondo_invoice"
    - from: "functions.php"
      to: "includes/class-rest-invoices.php"
      via: "use statement and instantiation in rondo_init"
      pattern: "new RESTInvoices"
    - from: "src/api/client.js"
      to: "/rondo/v1/invoices"
      via: "axios API calls"
      pattern: "rondo/v1/invoices"
---

<objective>
Create the Invoice REST API controller with CRUD endpoints, wire overdue detection logic, load classes in functions.php, and add frontend API client methods.

Purpose: Enable programmatic invoice management that the frontend UI phases will consume.
Output: REST controller class, updated functions.php, frontend API client methods.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/179-invoice-data-model-rest-api/179-01-SUMMARY.md
@includes/class-rest-feedback.php
@includes/class-rest-base.php
@includes/class-finance-config.php
@functions.php
@src/api/client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Invoice REST controller</name>
  <files>includes/class-rest-invoices.php</files>
  <action>
Create `includes/class-rest-invoices.php` following the Feedback REST controller pattern (`Rondo\REST` namespace, extends `Base`):

**Routes (all under `rondo/v1`):**

1. `GET /invoices` — List invoices
   - Permission: `check_financieel_permission` (new method: `return current_user_can('financieel');`)
   - Args: `status` (optional, filter by post status), `person_id` (optional, filter by person)
   - Callback: `get_invoice_list`
   - Query `rondo_invoice` posts with WP_Query. If status provided, use that as `post_status`; otherwise query all invoice statuses `['rondo_draft', 'rondo_sent', 'rondo_paid', 'rondo_overdue']`. If person_id provided, add meta_query for `person` field matching the ID.
   - **Before returning results, call `$this->check_overdue_invoices()` to update any overdue invoices.**
   - Map each post through `format_invoice()` method.
   - Return array.

2. `GET /invoices/(?P<id>\d+)` — Get single invoice
   - Permission: `check_financieel_permission`
   - Callback: `get_invoice`
   - Validate post exists and is `rondo_invoice` type.
   - Return `format_invoice_detail()` (includes line items with discipline case details).

3. `POST /invoices` — Create invoice
   - Permission: `check_financieel_permission`
   - Args: `person_id` (required, integer), `line_items` (required, array of `{discipline_case_id, description, amount}`)
   - Callback: `create_invoice`
   - Steps:
     a. Validate person_id is a valid person post.
     b. Generate invoice number via `\Rondo\Finance\InvoiceNumbering::generate_next()`.
     c. Calculate total_amount as sum of all line item amounts.
     d. Create post: `wp_insert_post()` with `post_type => 'rondo_invoice'`, `post_status => 'rondo_draft'`, `post_title => $invoice_number`.
     e. Set ACF fields: `update_field('invoice_number', ...)`, `update_field('person', $person_id)`, `update_field('status', 'draft')`, `update_field('total_amount', $total)`.
     f. Set line_items repeater: Use `update_field('line_items', $rows)` where each row is `['discipline_case' => $case_id, 'description' => $desc, 'amount' => $amount]`.
     g. Return the created invoice via `format_invoice_detail()`.

4. `POST /invoices/(?P<id>\d+)/status` — Update invoice status
   - Permission: `check_financieel_permission`
   - Args: `status` (required, one of: draft, sent, paid, overdue)
   - Callback: `update_invoice_status`
   - Validate post exists and is `rondo_invoice`.
   - Map status to post_status: draft -> rondo_draft, sent -> rondo_sent, paid -> rondo_paid, overdue -> rondo_overdue.
   - Call `wp_update_post(['ID' => $id, 'post_status' => $mapped_status])`.
   - Also update the ACF `status` field to keep it in sync.
   - If transitioning to "sent", set `sent_date` and calculate `due_date` (sent_date + payment_term_days from FinanceConfig).
   - Return updated invoice via `format_invoice_detail()`.

**Helper methods:**

`format_invoice($post)` — Summary format for list view:
```php
return [
    'id' => $post->ID,
    'invoice_number' => get_field('invoice_number', $post->ID),
    'person' => $this->get_invoice_person_summary($post->ID),
    'total_amount' => (float) get_field('total_amount', $post->ID),
    'status' => get_field('status', $post->ID),
    'post_status' => $post->post_status,
    'sent_date' => get_field('sent_date', $post->ID) ?: null,
    'due_date' => get_field('due_date', $post->ID) ?: null,
    'payment_link' => get_field('payment_link', $post->ID) ?: null,
    'created' => $post->post_date,
];
```

`format_invoice_detail($post)` — Full detail including line items:
- Same as format_invoice plus `line_items` array and `pdf_path`.
- For each line item, include the discipline case summary (dossier_id, match_description, charge_description, sanction_description from the linked case).

`get_invoice_person_summary($invoice_id)` — Get person data:
- Get person ID from ACF field. If valid person post, return `format_person_summary()` from Base class.
- Return null if no valid person linked.

`check_overdue_invoices()` — Overdue detection:
- Query rondo_invoice posts with `post_status => 'rondo_sent'` that have a `due_date` meta value.
- For each, if `due_date` is before today (compare Ymd format), update post_status to `rondo_overdue` and ACF status to `overdue`.
- This runs on every list request to keep statuses current.
  </action>
  <verify>
`php -l includes/class-rest-invoices.php` passes. `grep -c "register_rest_route" includes/class-rest-invoices.php` shows 4 route registrations. `grep "check_overdue_invoices" includes/class-rest-invoices.php` confirms overdue detection.
  </verify>
  <done>
Invoice REST controller provides: list (with filtering and overdue check), get single, create (with auto-numbering), and status update endpoints. All gated by financieel capability.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire invoice classes in functions.php and add API client methods</name>
  <files>functions.php, src/api/client.js</files>
  <action>
**In `functions.php`:**

1. Add import at the top with other `use` statements:
   ```php
   use Rondo\REST\Invoices as RESTInvoices;
   use Rondo\Finance\InvoiceNumbering;
   ```

2. In `rondo_init()`, within the `if ( $is_rest )` block, add:
   ```php
   new RESTInvoices();
   ```
   Place it after `new RESTFeedback();` since it follows the same pattern.

**In `src/api/client.js`:**

Add these methods to the API client object (follow the existing pattern like `getFinanceSettings`):

```javascript
// Invoice endpoints
getInvoices: (params = {}) => api.get('/rondo/v1/invoices', { params }),
getInvoice: (id) => api.get(`/rondo/v1/invoices/${id}`),
createInvoice: (data) => api.post('/rondo/v1/invoices', data),
updateInvoiceStatus: (id, status) => api.post(`/rondo/v1/invoices/${id}/status`, { status }),
```

Place these after the finance settings methods, with a comment `// Invoice endpoints`.
  </action>
  <verify>
`grep "RESTInvoices" functions.php` confirms import and instantiation. `grep "getInvoices\|getInvoice\|createInvoice\|updateInvoiceStatus" src/api/client.js` shows all 4 methods. `npm run build` succeeds (no frontend compilation errors).
  </verify>
  <done>
Invoice REST controller loaded on REST requests. Frontend API client has methods for all invoice CRUD operations. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `php -l includes/class-rest-invoices.php` — no syntax errors
2. `grep "new RESTInvoices" functions.php` — class instantiated
3. `grep "InvoiceNumbering" includes/class-rest-invoices.php` — numbering integration
4. `grep "check_overdue_invoices" includes/class-rest-invoices.php` — overdue detection
5. `grep "financieel" includes/class-rest-invoices.php` — capability check
6. `grep "getInvoices" src/api/client.js` — API client methods
7. `npm run build` — frontend compiles
</verification>

<success_criteria>
- Invoice REST controller with 4 endpoints (list, get, create, update status)
- All endpoints gated by financieel capability
- Create endpoint uses InvoiceNumbering::generate_next()
- Overdue detection runs on list endpoint
- Status update to "sent" auto-sets sent_date and calculates due_date
- functions.php loads Invoice REST class
- API client has all 4 invoice methods
- npm run build passes
</success_criteria>

<output>
After completion, create `.planning/phases/179-invoice-data-model-rest-api/179-02-SUMMARY.md`
</output>
