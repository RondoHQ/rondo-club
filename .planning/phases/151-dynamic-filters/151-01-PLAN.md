---
phase: 151-dynamic-filters
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-people.php
autonomous: true

must_haves:
  truths:
    - "GET /rondo/v1/people/filter-options returns JSON with age_groups, member_types, and total count"
    - "Each filter option includes a value and a count of matching people"
    - "Age groups are sorted youngest to oldest with smart numeric extraction (Onder 7 before Onder 10)"
    - "Non-numeric age groups (Senioren, Senioren Vrouwen) sort to the end"
    - "Gender variants (Meiden/Vrouwen) sort after their base group"
    - "Zero-count values are excluded from results"
    - "Only approved users can access the endpoint"
  artifacts:
    - path: "includes/class-rest-people.php"
      provides: "filter-options REST endpoint with generic infrastructure"
      contains: "get_filter_options"
  key_links:
    - from: "includes/class-rest-people.php"
      to: "register_rest_route"
      via: "route registration in register_routes()"
      pattern: "people/filter-options"
    - from: "includes/class-rest-people.php"
      to: "$wpdb"
      via: "SQL DISTINCT + GROUP BY queries"
      pattern: "GROUP BY pm.meta_value"
---

<objective>
Create a REST API endpoint that returns dynamic filter options with counts for the People list.

Purpose: Replace hardcoded filter arrays with data-driven options so new values from Sportlink sync automatically appear without code changes.
Output: A working `/rondo/v1/people/filter-options` endpoint that returns age groups and member types with counts, sorted intelligently.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/151-dynamic-filters/151-CONTEXT.md
@.planning/phases/151-dynamic-filters/151-RESEARCH.md
@includes/class-rest-people.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add filter-options REST endpoint with generic filter infrastructure</name>
  <files>includes/class-rest-people.php</files>
  <action>
  In `includes/class-rest-people.php`, add the following to the `Rondo\REST\People` class:

  1. **Register the route** in `register_routes()`, after the existing `/people/filtered` route registration:
     ```php
     register_rest_route(
         'rondo/v1',
         '/people/filter-options',
         [
             'methods'             => \WP_REST_Server::READABLE,
             'callback'            => [ $this, 'get_filter_options' ],
             'permission_callback' => [ $this, 'check_user_approved' ],
         ]
     );
     ```

  2. **Define a generic filter config** as a private method or class constant that maps filter keys to their meta_key and sort function. This makes adding future dynamic filters trivial:
     ```php
     private function get_dynamic_filter_config() {
         return [
             'age_groups' => [
                 'meta_key'    => 'leeftijdsgroep',
                 'sort_method' => 'sort_age_groups',
             ],
             'member_types' => [
                 'meta_key'    => 'type-lid',
                 'sort_method' => 'sort_member_types',
             ],
         ];
     }
     ```

  3. **Implement `get_filter_options()` callback:**
     - Access control check with `\Rondo\Core\AccessControl` (same pattern as `get_filtered_people`)
     - Use `$wpdb` direct queries for performance (1400+ people)
     - Get total count of published person posts
     - For each filter in the config, query DISTINCT meta_values with COUNT using GROUP BY and HAVING count > 0
     - Apply the configured sort method to each result set
     - Return JSON: `{ total: int, age_groups: [{value, count}], member_types: [{value, count}] }`
     - Cast count to int in results

     SQL pattern for each filter (use `$wpdb->prepare()` for meta_key):
     ```sql
     SELECT pm.meta_value AS value, COUNT(DISTINCT p.ID) AS count
     FROM {$wpdb->posts} p
     INNER JOIN {$wpdb->postmeta} pm ON p.ID = pm.post_id
     WHERE p.post_type = 'person'
         AND p.post_status = 'publish'
         AND pm.meta_key = %s
         AND pm.meta_value != ''
     GROUP BY pm.meta_value
     HAVING count > 0
     ```

  4. **Implement `sort_age_groups()` private method:**
     - Extract numeric part from "Onder X" pattern using `preg_match('/(\d+)/', ...)`
     - Sort numerically (youngest to oldest)
     - Within same number, sort base value before gender variant (e.g., "Onder 9" before "Onder 9 Meiden")
     - Gender variants detection: check for "Meiden" or "Vrouwen" substring
     - Non-numeric values (e.g., "Senioren", "Senioren Vrouwen") sort to end
     - Among non-numeric, base before gender variant

     Sort key logic:
     - Has number: primary = number, secondary = has_gender_variant (0 or 1)
     - No number: primary = 9999, secondary = has_gender_variant (0 or 1)

  5. **Implement `sort_member_types()` private method:**
     - Define a priority order array: `['Junior' => 1, 'Senior' => 2, 'Donateur' => 3, 'Lid van Verdienste' => 4]`
     - Values not in priority array sort to end (priority 99)
     - This allows new member types from sync to appear at the end automatically
     - Sort ascending by priority

  **Important:** Follow exact coding patterns from existing code in this file:
  - Use `\Rondo\Core\AccessControl` class for access checks
  - Use `global $wpdb` for database queries
  - Use `rest_ensure_response()` for return values
  - Follow PHPCS conventions (WordPress-Extra standard, short array syntax, no Yoda conditions)
  </action>
  <verify>
  1. Run `composer lint` from project root to verify PHPCS compliance
  2. Deploy to production using `bin/deploy.sh`
  3. Test the endpoint via SSH + curl:
     ```bash
     source .env && ssh -p "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" \
       "cd $DEPLOY_REMOTE_THEME_PATH && wp eval 'echo json_encode(json_decode(wp_remote_retrieve_body(wp_remote_get(rest_url(\"rondo/v1/people/filter-options\"), [\"headers\" => [\"X-WP-Nonce\" => wp_create_nonce(\"wp_rest\"), \"Cookie\" => \"\"]]))))' --user=1" | python3 -m json.tool
     ```
     Or test via WP-CLI:
     ```bash
     source .env && ssh -p "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" \
       "cd $DEPLOY_REMOTE_THEME_PATH && wp eval '
         wp_set_current_user(1);
         \$request = new WP_REST_Request(\"GET\", \"/rondo/v1/people/filter-options\");
         \$server = rest_get_server();
         \$response = \$server->dispatch(\$request);
         echo json_encode(\$response->get_data(), JSON_PRETTY_PRINT);
       '"
     ```
  4. Verify response contains `total`, `age_groups`, and `member_types` keys
  5. Verify age groups are in numeric order (Onder 6, Onder 7, ..., Senioren)
  6. Verify no zero-count values appear
  7. Verify each entry has `value` (string) and `count` (integer) properties
  </verify>
  <done>
  - GET /rondo/v1/people/filter-options returns { total, age_groups, member_types }
  - Age groups sorted youngest-to-oldest with gender variants after base groups
  - Member types sorted in meaningful priority order
  - Zero-count values excluded
  - Generic filter config makes future dynamic filters a one-line addition
  - PHPCS lint passes
  </done>
</task>

</tasks>

<verification>
1. `composer lint` passes with zero warnings
2. Endpoint returns valid JSON with correct structure
3. Age groups in correct order: Onder 6, Onder 7, ..., Onder 9, Onder 9 Meiden, ..., Senioren, Senioren Vrouwen
4. Member types in priority order: Junior, Senior, Donateur, Lid van Verdienste (plus any others at end)
5. Total count matches sum of all age group counts (approximately -- some people may have no age group)
6. All counts are positive integers (no zeros)
</verification>

<success_criteria>
- The REST endpoint `/rondo/v1/people/filter-options` is deployed and returns accurate filter data
- The generic filter config infrastructure is in place for future phases to add more dynamic filters
</success_criteria>

<output>
After completion, create `.planning/phases/151-dynamic-filters/151-01-SUMMARY.md`
</output>
