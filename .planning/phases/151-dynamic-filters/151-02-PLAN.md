---
phase: 151-dynamic-filters
plan: 02
type: execute
wave: 2
depends_on: ["151-01"]
files_modified:
  - src/api/client.js
  - src/hooks/usePeople.js
  - src/pages/People/PeopleList.jsx
  - docs/rest-api.md
autonomous: false

must_haves:
  truths:
    - "Age group filter dropdown shows only values that exist in the database with counts"
    - "Member type filter dropdown shows only values that exist in the database with counts"
    - "The 'Alle' default option shows the total count of people"
    - "Dropdowns are disabled with 'Laden...' text while filter options are loading"
    - "If API call fails, dropdowns show error state with 'Opnieuw proberen' retry button"
    - "If a URL query param contains a filter value not in current options, the filter is silently ignored"
    - "When new values arrive via sync, they appear automatically without code changes"
  artifacts:
    - path: "src/api/client.js"
      provides: "getFilterOptions API method"
      contains: "getFilterOptions"
    - path: "src/hooks/usePeople.js"
      provides: "useFilterOptions TanStack Query hook"
      contains: "useFilterOptions"
    - path: "src/pages/People/PeopleList.jsx"
      provides: "Dynamic filter dropdowns with loading/error states"
      contains: "useFilterOptions"
    - path: "docs/rest-api.md"
      provides: "Documentation for filter-options endpoint"
      contains: "filter-options"
  key_links:
    - from: "src/hooks/usePeople.js"
      to: "src/api/client.js"
      via: "prmApi.getFilterOptions()"
      pattern: "prmApi\\.getFilterOptions"
    - from: "src/pages/People/PeopleList.jsx"
      to: "src/hooks/usePeople.js"
      via: "useFilterOptions() hook"
      pattern: "useFilterOptions"
    - from: "src/pages/People/PeopleList.jsx"
      to: "/rondo/v1/people/filter-options"
      via: "API call through hook"
      pattern: "filterOptions"
---

<objective>
Connect the frontend to the dynamic filter-options endpoint, replacing hardcoded dropdowns with data-driven options including counts, loading states, and error handling.

Purpose: Complete the dynamic filters feature by wiring the React UI to the backend endpoint, so the People list filters are fully data-driven.
Output: Working filter dropdowns that show database-derived options with counts, proper loading/error states, and updated documentation.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/151-dynamic-filters/151-CONTEXT.md
@.planning/phases/151-dynamic-filters/151-RESEARCH.md
@.planning/phases/151-dynamic-filters/151-01-SUMMARY.md
@src/api/client.js
@src/hooks/usePeople.js
@src/pages/People/PeopleList.jsx
@docs/rest-api.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add API client method, TanStack Query hook, and convert dropdowns to dynamic</name>
  <files>src/api/client.js, src/hooks/usePeople.js, src/pages/People/PeopleList.jsx</files>
  <action>
  **1. Add API method in `src/api/client.js`:**

  In the `prmApi` object, add after the existing `getFilteredPeople` method:
  ```javascript
  // Filter options for dynamic dropdowns
  getFilterOptions: () => api.get('/rondo/v1/people/filter-options'),
  ```

  **2. Add hook in `src/hooks/usePeople.js`:**

  Add a `filterOptions` entry to the `peopleKeys` object:
  ```javascript
  filterOptions: () => [...peopleKeys.all, 'filter-options'],
  ```

  Add a new exported function after `useFilteredPeople`:
  ```javascript
  /**
   * Hook for fetching dynamic filter options with counts.
   * Returns available age groups and member types from the database.
   *
   * @param {Object} options - TanStack Query options
   * @returns {Object} TanStack Query result with { total, age_groups, member_types }
   */
  export function useFilterOptions(options = {}) {
    return useQuery({
      queryKey: peopleKeys.filterOptions(),
      queryFn: async () => {
        const response = await prmApi.getFilterOptions();
        return response.data;
      },
      staleTime: 5 * 60 * 1000, // 5 minutes - options change only on sync
      ...options,
    });
  }
  ```

  **3. Convert hardcoded dropdowns in `src/pages/People/PeopleList.jsx`:**

  a. Import `useFilterOptions` at the top (add to the existing import from `@/hooks/usePeople`):
  ```javascript
  import { useFilteredPeople, useFilterOptions, ... } from '@/hooks/usePeople';
  ```

  b. Call the hook near the top of the `PeopleList` component (near other hooks):
  ```javascript
  const {
    data: filterOptions,
    isLoading: filterOptionsLoading,
    error: filterOptionsError,
    refetch: refetchFilterOptions,
  } = useFilterOptions();
  ```

  c. **Replace the hardcoded "Type Lid" `<select>` block** (lines ~1230-1246) with a dynamic version:
  - When `filterOptionsLoading`: render a disabled select with `<option value="">Laden...</option>`
  - When `filterOptionsError`: render a disabled select with `<option value="">Fout bij laden</option>` and a retry button:
    ```jsx
    <button
      onClick={() => refetchFilterOptions()}
      className="text-xs text-accent-600 dark:text-accent-400 hover:underline mt-1"
    >
      Opnieuw proberen
    </button>
    ```
  - When loaded: render dynamic options with counts:
    ```jsx
    <select value={typeLid} onChange={(e) => setTypeLid(e.target.value)} className="...">
      <option value="">Alle ({filterOptions.total})</option>
      {filterOptions.member_types.map(opt => (
        <option key={opt.value} value={opt.value}>
          {opt.value} ({opt.count})
        </option>
      ))}
    </select>
    ```

  d. **Replace the hardcoded "Leeftijdsgroep" `<select>` block** (lines ~1248-1281) with the same pattern:
  - Same loading/error/success states
  - Use `filterOptions.age_groups` for the options

  e. **Handle stale URL params:** In the existing filter state initialization where `searchParams.get('typeLid')` and `searchParams.get('leeftijdsgroep')` are read:
  - After `filterOptions` loads, check if the current URL filter value exists in the loaded options
  - If not found and filterOptions is loaded (not loading, no error), silently clear the filter by calling the setter with empty string
  - Implement this as a `useEffect` that runs when `filterOptions` changes:
    ```javascript
    useEffect(() => {
      if (!filterOptions || filterOptionsLoading) return;

      const validTypeValues = filterOptions.member_types.map(o => o.value);
      const validAgeValues = filterOptions.age_groups.map(o => o.value);

      if (typeLid && !validTypeValues.includes(typeLid)) {
        setTypeLid('');
      }
      if (leeftijdsgroep && !validAgeValues.includes(leeftijdsgroep)) {
        setLeeftijdsgroep('');
      }
    }, [filterOptions, filterOptionsLoading]);
    ```
    NOTE: Do NOT add `typeLid` or `leeftijdsgroep` to the dependency array -- that would cause an infinite loop. The effect should only run when filterOptions arrives/changes. ESLint may warn about missing deps; add an eslint-disable comment for that specific line if needed.

  f. **Preserve existing styling:** Keep the exact same Tailwind classes on all select elements. The only changes are:
  - Adding `disabled` prop during loading/error states
  - Replacing hardcoded `<option>` elements with dynamic ones
  - Adding count text in parentheses
  - Adding retry button for error state

  **Important styling notes:**
  - Disabled selects should have the same classes but appear grayed out (native browser behavior handles this)
  - The retry button should appear below the select, using `text-xs text-accent-600 dark:text-accent-400 hover:underline mt-1`
  - Keep the `<h3>` label elements unchanged
  </action>
  <verify>
  1. Run `npm run lint` to verify ESLint passes with zero warnings
  2. Run `npm run build` to verify production build succeeds
  3. Deploy using `bin/deploy.sh`
  4. Test on production:
     - Navigate to the People list page (Leden)
     - Open the filter panel
     - Verify "Type lid" dropdown shows dynamic options with counts (e.g., "Junior (42)")
     - Verify "Leeftijdsgroep" dropdown shows dynamic options with counts
     - Verify "Alle" option shows total count
     - Verify age groups are in logical order (youngest first)
     - Briefly disconnect network or throttle: verify loading state shows "Laden..."
     - Test error state: if possible, trigger an error to see retry button
     - Test stale URL param: manually add `?typeLid=NonExistent` to URL, verify filter clears silently
  </verify>
  <done>
  - Both filter dropdowns show database-derived options with counts
  - "Alle" option includes total count
  - Loading state: dropdowns disabled with "Laden..." text
  - Error state: dropdowns disabled with "Fout bij laden" and retry button
  - Stale URL params silently cleared
  - ESLint and build pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Update documentation and changelog</name>
  <files>docs/rest-api.md, CHANGELOG.md</files>
  <action>
  **1. Add filter-options endpoint documentation to `docs/rest-api.md`:**

  Add a new section (in a logical place near the existing people endpoints documentation) documenting the new endpoint:

  ```markdown
  ### GET /rondo/v1/people/filter-options

  Returns available filter options for the People list with counts. Options are derived dynamically from database values.

  **Authentication:** Required (approved user)

  **Response:**
  ```json
  {
    "total": 523,
    "age_groups": [
      { "value": "Onder 6", "count": 12 },
      { "value": "Onder 7", "count": 18 },
      ...
      { "value": "Senioren", "count": 87 },
      { "value": "Senioren Vrouwen", "count": 34 }
    ],
    "member_types": [
      { "value": "Junior", "count": 142 },
      { "value": "Senior", "count": 287 },
      { "value": "Donateur", "count": 51 },
      { "value": "Lid van Verdienste", "count": 8 }
    ]
  }
  ```

  **Notes:**
  - Only values with at least 1 matching person are included
  - Age groups sorted youngest to oldest (numeric extraction from "Onder X"), gender variants after base groups
  - Member types sorted in priority order (new types from sync appear at end)
  - Frontend caches with 5-minute staleTime
  ```

  **2. Add changelog entry to `CHANGELOG.md`:**

  Under `## [Unreleased]`, add to the `### Added` section (create section if needed):
  ```
  - Dynamic filter options on People list derived from database values instead of hardcoded arrays
  - REST API endpoint `/rondo/v1/people/filter-options` returning available filters with counts
  - Filter dropdowns show count of matching people per option (e.g., "Junior (42)")
  - Loading and error states for filter dropdowns with retry functionality
  - Generic filter infrastructure for easily adding future dynamic filters
  ```

  Under `### Changed`:
  ```
  - People list "Type lid" filter now shows only values that exist in the database
  - People list "Leeftijdsgroep" filter now shows only values that exist in the database
  ```

  Under `### Removed`:
  ```
  - Hardcoded filter option arrays for Type lid and Leeftijdsgroep in PeopleList
  ```
  </action>
  <verify>
  1. Read docs/rest-api.md and verify the new section is present and formatted correctly
  2. Read CHANGELOG.md and verify the entries are under [Unreleased] with correct categories
  3. Verify no duplicate entries in changelog
  </verify>
  <done>
  - docs/rest-api.md documents the new /rondo/v1/people/filter-options endpoint
  - CHANGELOG.md has entries under [Unreleased] for Added, Changed, and Removed
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Dynamic filter options on the People list. Both "Type lid" and "Leeftijdsgroep" dropdowns now show database-derived values with counts instead of hardcoded option lists.
  </what-built>
  <how-to-verify>
  1. Navigate to the People list (Leden)
  2. Open the filter panel (click the filter icon)
  3. Check "Type lid" dropdown:
     - Shows options like "Junior (42)", "Senior (287)" with counts
     - "Alle" shows total count
     - Only member types that exist in the database appear
  4. Check "Leeftijdsgroep" dropdown:
     - Shows options like "Onder 6 (12)", "Onder 7 (18)" with counts
     - "Alle" shows total count
     - Age groups in logical order (youngest first, gender variants after base)
     - Only age groups that exist in the database appear
  5. Select a filter value and verify the list filters correctly
  6. Verify no visual regressions in the filter panel
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run lint` passes with zero warnings
2. `npm run build` produces successful production build
3. `composer lint` passes
4. Filter-options endpoint returns correct data on production
5. Both dropdowns render dynamic options with counts
6. Loading and error states work correctly
7. Stale URL params are silently cleared
8. Documentation updated
</verification>

<success_criteria>
- Age group filter shows only values from the database with counts
- Member type filter shows only values from the database with counts
- New sync values appear automatically without code changes
- Filter panel has proper loading and error states
- Documentation and changelog updated
</success_criteria>

<output>
After completion, create `.planning/phases/151-dynamic-filters/151-02-SUMMARY.md`
</output>
