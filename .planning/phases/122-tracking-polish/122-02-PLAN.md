---
phase: 122-tracking-polish
plan: 02
type: execute
wave: 2
depends_on: ["122-01"]
files_modified:
  - src/pages/VOG/VOGList.jsx
  - src/components/Timeline/TimelineView.jsx
  - src/hooks/usePeople.js
autonomous: true

must_haves:
  truths:
    - "User can filter VOG list by email status using dropdown"
    - "Dropdown shows counts for each filter option"
    - "Verzonden column shows email send date in VOG list"
    - "Email entries appear in person timeline with expandable content"
  artifacts:
    - path: "src/pages/VOG/VOGList.jsx"
      provides: "Email status filter dropdown and Verzonden column"
      contains: "vog_email_status"
    - path: "src/components/Timeline/TimelineView.jsx"
      provides: "Email type rendering in timeline"
      contains: "type === 'email'"
    - path: "src/hooks/usePeople.js"
      provides: "vogEmailStatus parameter support"
      contains: "vogEmailStatus"
  key_links:
    - from: "src/pages/VOG/VOGList.jsx"
      to: "src/hooks/usePeople.js"
      via: "useFilteredPeople hook with vogEmailStatus param"
      pattern: "vogEmailStatus"
    - from: "src/components/Timeline/TimelineView.jsx"
      to: "Mail icon import"
      via: "Lucide icon for email type"
      pattern: "Mail"
---

<objective>
Add email status filtering UI to VOG list and display email entries in person timeline with expandable content.

Purpose: Users can track VOG email status by filtering the list and viewing email history on person profiles.
Output: Complete tracking and polish features for VOG management milestone.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/122-tracking-polish/122-CONTEXT.md
@.planning/phases/122-tracking-polish/122-RESEARCH.md
@.planning/phases/122-tracking-polish/122-01-SUMMARY.md
@src/pages/VOG/VOGList.jsx
@src/components/Timeline/TimelineView.jsx
@src/hooks/usePeople.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add vogEmailStatus parameter to useFilteredPeople hook</name>
  <files>src/hooks/usePeople.js</files>
  <action>
Extend the useFilteredPeople hook to accept and pass vogEmailStatus parameter:

1. Add `vogEmailStatus` to the destructured options parameter (alongside existing params like huidigeVrijwilliger, vogMissing, etc.)

2. Add to the params object that's passed to the API call:
```javascript
if (vogEmailStatus) params.vog_email_status = vogEmailStatus;
```

3. Include in the queryKey array to ensure proper cache invalidation when filter changes.

Follow the same pattern used for other optional filter parameters in this file.
  </action>
  <verify>
- `grep -n "vogEmailStatus" src/hooks/usePeople.js` returns parameter handling
- `grep -n "vog_email_status" src/hooks/usePeople.js` returns API param assignment
- `npm run lint` passes
  </verify>
  <done>
useFilteredPeople hook accepts vogEmailStatus parameter and passes it to the API as vog_email_status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add email status filter dropdown and Verzonden column to VOG list</name>
  <files>src/pages/VOG/VOGList.jsx</files>
  <action>
Add email status filtering UI and Verzonden column to the VOG list:

1. Add state for email status filter:
```javascript
const [emailStatusFilter, setEmailStatusFilter] = useState('');
```

2. Add vogEmailStatus to useFilteredPeople call:
```javascript
const { data, isLoading, error } = useFilteredPeople({
  // ... existing params
  vogEmailStatus: emailStatusFilter,
});
```

3. Add a second query to get counts for the filter dropdown (fetch all without email filter):
```javascript
const { data: allData } = useFilteredPeople({
  page: 1,
  perPage: 100,
  huidigeVrijwilliger: '1',
  vogMissing: '1',
  vogOlderThanYears: 3,
  orderby,
  order,
  // Note: no vogEmailStatus - this fetches all to calculate counts
});

// Calculate counts from allData
const emailCounts = useMemo(() => {
  const allPeople = allData?.people || [];
  const sent = allPeople.filter(p => p.acf?.['vog_email_sent_date']).length;
  const notSent = allPeople.length - sent;
  return { total: allPeople.length, sent, notSent };
}, [allData?.people]);
```

4. Add filter dropdown BEFORE the table, inside the space-y-4 div, positioned between selection toolbar and table:
```jsx
{/* Email status filter */}
<div className="flex items-center gap-4">
  <label className="text-sm text-gray-600 dark:text-gray-400">Filter:</label>
  <select
    value={emailStatusFilter}
    onChange={(e) => setEmailStatusFilter(e.target.value)}
    className="text-sm border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:border-accent-500 focus:ring-accent-500 dark:bg-gray-700 dark:text-gray-200"
  >
    <option value="">Alle ({emailCounts.total})</option>
    <option value="not_sent">Niet verzonden ({emailCounts.notSent})</option>
    <option value="sent">Wel verzonden ({emailCounts.sent})</option>
  </select>
</div>
```

5. Add Verzonden column to VOGRow component (after Datum VOG column):
```jsx
{/* Verzonden date */}
<td className="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">
  {person.acf?.['vog_email_sent_date']
    ? format(new Date(person.acf['vog_email_sent_date']), 'd MMM yyyy')
    : '-'}
</td>
```

6. Add Verzonden column header (sortable by date):
```jsx
<SortableHeader
  label="Verzonden"
  columnId="custom_vog_email_sent_date"
  sortField={orderby}
  sortOrder={order}
  onSort={handleSort}
/>
```

7. Import format from '@/utils/dateFormat' if not already imported.

8. Clear emailStatusFilter when bulk operations succeed (add to handleCloseModal):
```javascript
// After clearSelection() in handleCloseModal
if (bulkActionResult && (bulkActionResult.sent > 0 || bulkActionResult?.marked > 0)) {
  clearSelection();
  // Don't clear filter - user may want to see updated list with same filter
}
```

Important: The counts query uses vog_email_sent_date post_meta (existing field), while the filter query uses the new API parameter that checks for stadion_email comments. Both should yield consistent results since email logging updates both.
  </action>
  <verify>
- `grep -n "emailStatusFilter" src/pages/VOG/VOGList.jsx` returns state and usage
- `grep -n "vogEmailStatus" src/pages/VOG/VOGList.jsx` returns hook parameter
- `grep -n "Verzonden" src/pages/VOG/VOGList.jsx` returns column header
- `grep -n "vog_email_sent_date" src/pages/VOG/VOGList.jsx` returns column value
- `npm run lint` passes
- `npm run build` succeeds
  </verify>
  <done>
VOG list has email status filter dropdown with counts and Verzonden column showing send dates.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add email type rendering to Timeline</name>
  <files>src/components/Timeline/TimelineView.jsx</files>
  <action>
Extend TimelineView to render email entries in the timeline:

1. Add Mail icon to imports from lucide-react (add Send as alternative if preferred):
```javascript
import { ..., Mail, ChevronDown, ChevronUp } from 'lucide-react';
```

2. Add useState for tracking expanded email entries:
```javascript
const [expandedEmails, setExpandedEmails] = useState(new Set());

const toggleEmailExpanded = (itemId) => {
  setExpandedEmails(prev => {
    const next = new Set(prev);
    if (next.has(itemId)) {
      next.delete(itemId);
    } else {
      next.add(itemId);
    }
    return next;
  });
};
```

3. Update getIconForItem to handle email type (add before the final return):
```javascript
if (item.type === 'email') return Mail;
```

4. Add email rendering in renderTimelineItem function. Add this block after the existing type checks (after `const isNote = item.type === 'note';`):
```javascript
const isEmail = item.type === 'email';
const isEmailExpanded = expandedEmails.has(item.id);
```

5. Update the display logic for email type. In the content rendering section, add email-specific handling:

After the existing item type handling, add a dedicated email rendering block:
```jsx
{/* Email entry */}
{isEmail && (
  <div className="relative pl-8 pb-6 group">
    {/* Timeline dot */}
    <div className="absolute left-0 top-1">
      <div className="w-4 h-4 rounded-full border-2 bg-green-500 border-green-500" />
    </div>

    {/* Email summary - clickable to expand */}
    <button
      onClick={() => toggleEmailExpanded(item.id)}
      className="w-full text-left"
    >
      <div className="flex items-center gap-2 mb-1">
        <Mail className="w-4 h-4 text-green-600 dark:text-green-400" />
        <span className="text-xs font-medium text-gray-600 dark:text-gray-300">
          VOG Email ({item.email_template_type === 'new' ? 'nieuw' : 'vernieuwing'})
        </span>
        <span className="text-xs text-gray-400">-</span>
        <span className="text-xs text-gray-500">{formattedDate}</span>
        {isEmailExpanded ? (
          <ChevronUp className="w-4 h-4 text-gray-400 ml-auto" />
        ) : (
          <ChevronDown className="w-4 h-4 text-gray-400 ml-auto" />
        )}
      </div>
      <p className="text-sm text-gray-600 dark:text-gray-300">
        Verzonden naar {item.email_recipient}
      </p>
    </button>

    {/* Expanded content */}
    {isEmailExpanded && item.email_content_snapshot && (
      <div className="mt-2 p-3 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
        <div
          className="text-sm prose prose-sm dark:prose-invert max-w-none"
          dangerouslySetInnerHTML={{ __html: item.email_content_snapshot }}
        />
      </div>
    )}
  </div>
)}
```

6. Update the main renderTimelineItem return to skip email type in the standard rendering (since we handle it separately). Add early return for email type:
```javascript
// Handle email type separately with custom rendering
if (isEmail) {
  return (
    // ... email-specific JSX from step 5
  );
}
```

7. Alternatively, integrate the email rendering into the existing renderTimelineItem structure by:
   - Using the existing timeline dot pattern
   - Adding email-specific icon and styling
   - Making the content expandable

The key difference from notes/activities:
- Green dot/icon color (success indicator)
- Expandable content section
- Shows recipient email address
- Shows template type (nieuw/vernieuwing)
- No edit/delete actions (email history is immutable)
  </action>
  <verify>
- `grep -n "type === 'email'" src/components/Timeline/TimelineView.jsx` returns email type check
- `grep -n "email_template_type" src/components/Timeline/TimelineView.jsx` returns template type display
- `grep -n "email_content_snapshot" src/components/Timeline/TimelineView.jsx` returns expandable content
- `grep -n "expandedEmails" src/components/Timeline/TimelineView.jsx` returns state management
- `npm run lint` passes
- `npm run build` succeeds
  </verify>
  <done>
Email entries appear in person timeline with green styling, template type badge, recipient address, and expandable content showing the actual email that was sent.
  </done>
</task>

</tasks>

<verification>
After deployment, test the complete flow:

1. VOG List Filter:
   - Navigate to /leden/vog
   - Verify filter dropdown appears with Alle/Niet verzonden/Wel verzonden options
   - Verify counts are shown in parentheses
   - Select "Niet verzonden" - only people without emails shown
   - Select "Wel verzonden" - only people with emails shown
   - Verzonden column shows dates or dashes

2. Email Timeline:
   - Send a VOG email to a test person (via bulk actions)
   - Navigate to that person's profile
   - Verify email entry appears in timeline
   - Entry shows green dot, Mail icon, "VOG Email (nieuw/vernieuwing)"
   - Click to expand - shows full email content
   - Click again to collapse

3. Cache Invalidation:
   - After sending email, VOG list updates correctly
   - Filter counts update to reflect new email

Run: `npm run build && bin/deploy.sh`
</verification>

<success_criteria>
- Email status filter dropdown works with accurate counts
- Verzonden column displays in VOG list table
- Email entries render in timeline with correct styling
- Email content expands/collapses on click
- All lint checks pass
- Production build succeeds
- No console errors in browser
</success_criteria>

<output>
After completion, create `.planning/phases/122-tracking-polish/122-02-SUMMARY.md`
</output>
