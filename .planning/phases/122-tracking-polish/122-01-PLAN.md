---
phase: 122-tracking-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-comment-types.php
  - includes/class-vog-email.php
  - includes/class-rest-people.php
autonomous: true

must_haves:
  truths:
    - "Sent VOG emails are logged as stadion_email comments with content snapshot"
    - "VOG list API can filter by email status (sent/not_sent)"
    - "Timeline API returns email entries with metadata"
  artifacts:
    - path: "includes/class-comment-types.php"
      provides: "TYPE_EMAIL constant and email comment type handling"
      contains: "TYPE_EMAIL"
    - path: "includes/class-vog-email.php"
      provides: "Email logging on successful send"
      contains: "create_email_log"
    - path: "includes/class-rest-people.php"
      provides: "vog_email_status filter parameter"
      contains: "vog_email_status"
  key_links:
    - from: "includes/class-vog-email.php"
      to: "includes/class-comment-types.php"
      via: "create_email_log call after wp_mail success"
      pattern: "create_email_log"
    - from: "includes/class-rest-people.php"
      to: "wp_comments table"
      via: "subquery filter for email status"
      pattern: "stadion_email"
---

<objective>
Add email tracking infrastructure to the backend: TYPE_EMAIL comment type for logging sent emails, integration with VOG email sending, and API filter parameter for email status filtering.

Purpose: Enable tracking of sent VOG emails with full content history and provide server-side filtering for the VOG list by email status.
Output: Backend infrastructure ready for frontend email history display and filtering.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/122-tracking-polish/122-CONTEXT.md
@.planning/phases/122-tracking-polish/122-RESEARCH.md
@includes/class-comment-types.php
@includes/class-vog-email.php
@includes/class-rest-people.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TYPE_EMAIL comment type with meta registration</name>
  <files>includes/class-comment-types.php</files>
  <action>
Extend the existing CommentTypes class:

1. Add constant: `const TYPE_EMAIL = 'stadion_email';`

2. Register email-specific comment meta fields in `register_comment_meta()`:
   - `email_template_type` (string): 'new' or 'renewal'
   - `email_recipient` (string): Email address sent to
   - `email_subject` (string): Email subject line
   - `email_content_snapshot` (string): Full rendered HTML content

3. Add TYPE_EMAIL to `exclude_from_regular_queries()` filter so email comments don't appear in WordPress admin comment listings.

4. Update `get_timeline()` method to include TYPE_EMAIL in `type__in` array.

5. Add email type handling in `format_comment()` method:
   - When type is 'email', include email-specific meta fields in response
   - Format: author, created, email_template_type, email_recipient, email_subject, email_content_snapshot

6. Add public `create_email_log()` method:
```php
public function create_email_log( $person_id, $data ) {
    $comment_id = wp_insert_comment([
        'comment_post_ID'  => $person_id,
        'comment_content'  => $data['subject'], // Summary for display
        'comment_type'     => self::TYPE_EMAIL,
        'user_id'          => get_current_user_id(),
        'comment_approved' => 1,
    ]);

    if ( ! $comment_id ) {
        return new \WP_Error( 'create_failed', 'Failed to log email.' );
    }

    update_comment_meta( $comment_id, 'email_template_type', $data['template_type'] );
    update_comment_meta( $comment_id, 'email_recipient', $data['recipient'] );
    update_comment_meta( $comment_id, 'email_subject', $data['subject'] );
    update_comment_meta( $comment_id, 'email_content_snapshot', $data['content'] );

    return $comment_id;
}
```
  </action>
  <verify>
Verify changes:
- `grep -n "TYPE_EMAIL" includes/class-comment-types.php` returns constant definition
- `grep -n "stadion_email" includes/class-comment-types.php` returns type__in array entry
- `grep -n "create_email_log" includes/class-comment-types.php` returns method definition
- `npm run lint` passes (PHP-only changes, but verify no syntax errors)
  </verify>
  <done>
TYPE_EMAIL comment type is registered with meta fields, excluded from regular queries, included in timeline, and create_email_log method exists for logging sent emails.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate email logging into VOG email sending</name>
  <files>includes/class-vog-email.php</files>
  <action>
Modify the `send()` method in VOGEmail class to log successful email sends:

1. After the successful `wp_mail()` call (after line 229 where post_meta is updated), add:

```php
// Log email to timeline
$comment_types = new \Stadion\Collaboration\CommentTypes();
$comment_types->create_email_log( $person_id, [
    'template_type' => $template_type,
    'recipient'     => $recipient_email,
    'subject'       => $subject,
    'content'       => $html_message,
]);
```

2. Add the use statement at the top if not already present, or use the full namespace path.

Important: Only log on successful send (after `wp_mail()` returns true, before the final `return true;`). Do NOT log failures.

Keep the existing `update_post_meta( $person_id, 'vog_email_sent_date', ... )` for backward compatibility - the VOG list filter currently uses this field.
  </action>
  <verify>
Verify changes:
- `grep -n "create_email_log" includes/class-vog-email.php` returns the logging call
- The call appears AFTER the `wp_mail()` success check
- `npm run lint` passes
  </verify>
  <done>
Successful VOG email sends are logged to the person's timeline as stadion_email comments with full content snapshot.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add vog_email_status filter to filtered people API</name>
  <files>includes/class-rest-people.php</files>
  <action>
Extend the `/rondo/v1/people/filtered` endpoint:

1. Add `vog_email_status` to the endpoint's args registration (after vog_older_than_years around line 336):
```php
'vog_email_status' => [
    'description'       => 'Filter by VOG email status (sent, not_sent, empty=all)',
    'type'              => 'string',
    'sanitize_callback' => 'sanitize_text_field',
    'validate_callback' => function ( $value ) {
        return in_array( $value, [ '', 'sent', 'not_sent' ], true );
    },
],
```

2. In `get_filtered_people()` method, extract the parameter (around line 1027):
```php
$vog_email_status = $request->get_param( 'vog_email_status' );
```

3. Add the filter logic AFTER the VOG date filters (around line 1150). Use a subquery approach:
```php
// VOG email status filter (sent/not_sent based on stadion_email comments)
if ( ! empty( $vog_email_status ) ) {
    // Subquery to find people with email comments
    $email_subquery = "SELECT DISTINCT comment_post_ID FROM {$wpdb->comments} WHERE comment_type = 'stadion_email'";

    if ( $vog_email_status === 'sent' ) {
        $where_clauses[] = "p.ID IN ($email_subquery)";
    } elseif ( $vog_email_status === 'not_sent' ) {
        $where_clauses[] = "p.ID NOT IN ($email_subquery)";
    }
}
```

Note: This filter is specifically for VOG email tracking, but the comment-based approach could be extended for other email types in the future.
  </action>
  <verify>
Verify changes:
- `grep -n "vog_email_status" includes/class-rest-people.php` returns args registration and filter logic
- `grep -n "stadion_email" includes/class-rest-people.php` returns the subquery
- `npm run lint` passes
  </verify>
  <done>
API endpoint accepts vog_email_status parameter and correctly filters people by whether they have stadion_email comments.
  </done>
</task>

</tasks>

<verification>
1. TYPE_EMAIL comment type exists with proper meta registration
2. Email logging integrates with VOG email sending
3. API filter parameter works for email status filtering
4. Timeline API returns email entries (verify by inspecting get_timeline method)
5. All PHP files have valid syntax and lint passes
</verification>

<success_criteria>
- `TYPE_EMAIL = 'stadion_email'` constant exists in class-comment-types.php
- `create_email_log()` method exists and is called from class-vog-email.php
- `vog_email_status` parameter registered in REST API args
- Subquery filter implemented for sent/not_sent filtering
- Email type included in timeline type__in array
- No PHP errors or lint failures
</success_criteria>

<output>
After completion, create `.planning/phases/122-tracking-polish/122-01-SUMMARY.md`
</output>
