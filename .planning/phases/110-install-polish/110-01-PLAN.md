---
phase: 110-install-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useInstallPrompt.js
  - src/hooks/useEngagementTracking.js
  - src/utils/installTracking.js
autonomous: true

must_haves:
  truths:
    - "useInstallPrompt hook captures beforeinstallprompt event and stores it"
    - "useInstallPrompt exposes canInstall, promptInstall, and hidePrompt functions"
    - "useEngagementTracking tracks page views in sessionStorage"
    - "installTracking utility manages localStorage for dismissal tracking"
    - "Hooks detect when app is already installed (standalone mode)"
  artifacts:
    - path: "src/hooks/useInstallPrompt.js"
      provides: "Android install prompt event management"
      exports: ["useInstallPrompt"]
    - path: "src/hooks/useEngagementTracking.js"
      provides: "Engagement-based prompt timing"
      exports: ["useEngagementTracking", "trackNoteAdded"]
    - path: "src/utils/installTracking.js"
      provides: "localStorage helpers for dismissal tracking"
      exports: ["installTracking"]
  key_links:
    - from: "src/hooks/useInstallPrompt.js"
      to: "src/utils/installTracking.js"
      via: "import installTracking"
      pattern: "import.*installTracking"
---

<objective>
Create the React hooks and utility functions for PWA install prompt management.

Purpose: Establish the foundation for smart install prompts on Android and engagement-based timing on iOS. These hooks will be used by UI components in Plan 110-02.

Output: Three files - useInstallPrompt.js (Android beforeinstallprompt handling), useEngagementTracking.js (engagement heuristics), installTracking.js (localStorage management).
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/110-install-polish/110-RESEARCH.md

Reference existing patterns:
@src/hooks/useOnlineStatus.js
@src/hooks/useVersionCheck.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create installTracking utility</name>
  <files>src/utils/installTracking.js</files>
  <action>
Create a localStorage utility for tracking install prompt dismissals and installation status.

Use the pattern from 110-RESEARCH.md "localStorage Tracking Utilities" section:
- KEYS object with: DISMISSED, DISMISS_COUNT, INSTALLED, IOS_DISMISSED
- shouldShowPrompt(): Check dismissal count (<3), time since dismissal (>7 days), and installed status
- trackDismissal(): Increment count and store timestamp
- trackInstall(): Mark as installed, clear dismissal tracking
- getDismissCount(): Return current count
- shouldShowIOSPrompt(): iOS-specific with 7-day cooldown
- trackIOSDismissal(): iOS-specific timestamp

Export as `installTracking` object.
  </action>
  <verify>
File exists at src/utils/installTracking.js and exports installTracking object with all required methods.
Run: grep -l "shouldShowPrompt" src/utils/installTracking.js
  </verify>
  <done>
installTracking utility exports all required functions for localStorage management.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useInstallPrompt hook</name>
  <files>src/hooks/useInstallPrompt.js</files>
  <action>
Create a React hook that captures the beforeinstallprompt event for Android PWA installation.

Implementation based on 110-RESEARCH.md "Pattern 1: Android Install Prompt with Engagement Heuristics":

1. State: installPrompt (the event), canInstall (boolean showing if prompt available)
2. useEffect to add event listeners:
   - beforeinstallprompt: preventDefault(), setInstallPrompt(e), check installTracking.shouldShowPrompt()
   - appinstalled: clear prompt state, call installTracking.trackInstall()
3. Add cleanup for event listeners
4. Add detection for already-installed state using:
   - window.matchMedia('(display-mode: standalone)').matches
   - window.navigator.standalone === true (iOS)
5. promptInstall async function:
   - Return early if no installPrompt
   - Call installPrompt.prompt()
   - Await userChoice
   - If dismissed, call installTracking.trackDismissal()
   - Clear state
   - Return outcome
6. hidePrompt function:
   - Call installTracking.trackDismissal()
   - Set canInstall to false

Return: { canInstall, promptInstall, hidePrompt, isInstalled }

Use the same hook patterns as useOnlineStatus.js (useState, useEffect with cleanup).
  </action>
  <verify>
File exists and exports useInstallPrompt hook.
Run: grep -E "beforeinstallprompt|canInstall|promptInstall" src/hooks/useInstallPrompt.js
  </verify>
  <done>
useInstallPrompt hook captures beforeinstallprompt event and provides install prompt management.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create useEngagementTracking hook</name>
  <files>src/hooks/useEngagementTracking.js</files>
  <action>
Create a React hook that tracks user engagement for timing install prompts.

Implementation based on 110-RESEARCH.md "Pattern 2: Engagement-Based Install Prompt Trigger":

1. useEngagementTracking hook with options parameter:
   - minPageViews: number (default 2) - show after this many page views
   - minNotes: number (default 1) - or after this many notes added
2. State: isEngaged (boolean)
3. useEffect on mount:
   - Read current page views from sessionStorage 'pwa-page-views'
   - Increment and store back
   - Read notes added from sessionStorage 'pwa-notes-added'
   - If pageViews >= minPageViews OR notesAdded >= minNotes, setIsEngaged(true)
4. Return isEngaged boolean

Also export a standalone function trackNoteAdded():
- Increments 'pwa-notes-added' in sessionStorage
- Called from note/activity creation success handlers (will be integrated later)

Export: { useEngagementTracking, trackNoteAdded }
  </action>
  <verify>
File exists and exports useEngagementTracking hook and trackNoteAdded function.
Run: grep -E "useEngagementTracking|trackNoteAdded|sessionStorage" src/hooks/useEngagementTracking.js
  </verify>
  <done>
useEngagementTracking hook tracks page views and note additions for engagement-based prompt timing.
  </done>
</task>

</tasks>

<verification>
1. All three files exist in their respective locations
2. installTracking.js exports object with all tracking methods
3. useInstallPrompt.js exports hook with canInstall, promptInstall, hidePrompt, isInstalled
4. useEngagementTracking.js exports useEngagementTracking hook and trackNoteAdded function
5. Hooks use standard React patterns (useState, useEffect with cleanup)
6. No TypeScript errors in files (run npm run lint if available, or check IDE)
</verification>

<success_criteria>
- Three new files created: src/utils/installTracking.js, src/hooks/useInstallPrompt.js, src/hooks/useEngagementTracking.js
- Each file exports documented functions/hooks
- Code follows existing codebase patterns
- Ready for Plan 110-02 to import and use these hooks in UI components
</success_criteria>

<output>
After completion, create `.planning/phases/110-install-polish/110-01-SUMMARY.md`
</output>
