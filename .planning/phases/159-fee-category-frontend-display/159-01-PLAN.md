---
phase: 159-fee-category-frontend-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-api.php
  - includes/class-rest-google-sheets.php
  - src/utils/formatters.js
  - src/pages/Contributie/ContributieList.jsx
  - src/components/FinancesCard.jsx
  - ../developer/src/content/docs/features/membership-fees.md
autonomous: true

must_haves:
  truths:
    - "ContributieList renders category badges (label + color) using data from the API response categories metadata, not from any hardcoded FEE_CATEGORIES object"
    - "Category colors are assigned from a fixed palette indexed by sort_order position (modulo for overflow)"
    - "Category sorting in ContributieList uses sort_order from the API categories metadata, not a hardcoded categoryOrder object"
    - "FinancesCard displays the category label from the API response (category_label field), not from a hardcoded lookup"
    - "Google Sheets export derives category labels from fee_data categories metadata, not from a hardcoded category_labels array"
    - "No FEE_CATEGORIES constant or getCategoryLabel function exists in formatters.js"
  artifacts:
    - path: "src/utils/formatters.js"
      provides: "CATEGORY_COLOR_PALETTE array with 6 Tailwind color class strings"
      contains: "CATEGORY_COLOR_PALETTE"
    - path: "src/pages/Contributie/ContributieList.jsx"
      provides: "Dynamic category rendering from API data"
    - path: "src/components/FinancesCard.jsx"
      provides: "Category label from API response field"
    - path: "includes/class-rest-api.php"
      provides: "category_label field in person fee endpoint"
    - path: "includes/class-rest-google-sheets.php"
      provides: "Dynamic category labels from fee_data categories"
  key_links:
    - from: "src/pages/Contributie/ContributieList.jsx"
      to: "GET /rondo/v1/fees"
      via: "data.categories metadata object"
      pattern: "data\\.categories"
    - from: "src/components/FinancesCard.jsx"
      to: "GET /rondo/v1/fees/person/{id}"
      via: "feeData.category_label field"
      pattern: "feeData\\.category_label"
    - from: "includes/class-rest-google-sheets.php"
      to: "fee_data['categories']"
      via: "Dynamic label extraction from categories metadata"
      pattern: "fee_data\\['categories'\\]"
---

<objective>
Remove all hardcoded fee category definitions from the frontend and Google Sheets export, replacing them with dynamic data from the API response's categories metadata.

Purpose: Completes the v21.0 milestone by ensuring that when an admin adds, edits, or reorders fee categories via the Settings UI, all display surfaces (contributie list, person finance card, Google Sheets export) automatically reflect those changes without any code modifications.

Output: Contributie list page, FinancesCard component, and Google Sheets export all derive category labels, colors, and sort order from the API.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/159-fee-category-frontend-display/159-RESEARCH.md
@.planning/phases/157-fee-category-rest-api/157-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend — Add category_label to person fee endpoint and make Google Sheets export dynamic</name>
  <files>
    includes/class-rest-api.php
    includes/class-rest-google-sheets.php
  </files>
  <action>
**1. Add `category_label` to the person fee endpoint response (`class-rest-api.php`)**

In the `get_person_fee()` method (around line 3101), the response array returns `'category' => $fee_data['category']` but no human-readable label. Add a `category_label` field by looking up the category in the season config:

After the existing `$fee_data` retrieval (line 3079), add:
```php
// Look up category label from season config
$season_categories = $fees->get_categories_for_season( $season );
$category_label = $season_categories[ $fee_data['category'] ]['label'] ?? $fee_data['category'];
```

Then add to the response array (after the `'category'` key):
```php
'category_label' => $category_label,
```

**2. Replace hardcoded `$category_labels` in Google Sheets export (`class-rest-google-sheets.php`)**

In the `build_fee_spreadsheet_data()` method, find the hardcoded `$category_labels` array (lines 994-1001):
```php
$category_labels = [
    'mini'     => 'Mini',
    'pupil'    => 'Pupil',
    'junior'   => 'Junior',
    'senior'   => 'Senior',
    'recreant' => 'Recreant',
    'donateur' => 'Donateur',
];
```

Replace with dynamic extraction from the `$fee_data['categories']` metadata (which is included in the fee list API response from Phase 157-02):
```php
// Derive category labels from API response metadata
$categories = $fee_data['categories'] ?? [];
$category_labels = [];
foreach ( $categories as $slug => $meta ) {
    $category_labels[ $slug ] = $meta['label'] ?? $slug;
}
```

The usage on line 1012 (`$category_labels[ $member['category'] ] ?? $member['category']`) remains unchanged — it already handles missing keys gracefully.
  </action>
  <verify>
1. Run `npm run build` to confirm no PHP syntax issues affect the build
2. Grep for the old hardcoded `$category_labels` array in `class-rest-google-sheets.php` — should no longer contain 'mini' => 'Mini' etc.
3. Grep for `category_label` in `class-rest-api.php` to confirm the new field exists in the person fee response
  </verify>
  <done>
1. Person fee endpoint (`GET /rondo/v1/fees/person/{id}`) returns a `category_label` field with the human-readable label from season config
2. Google Sheets export builds category labels dynamically from `$fee_data['categories']` metadata, not from a hardcoded array
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend — Replace hardcoded FEE_CATEGORIES with API-driven category display</name>
  <files>
    src/utils/formatters.js
    src/pages/Contributie/ContributieList.jsx
    src/components/FinancesCard.jsx
  </files>
  <action>
**1. Update `src/utils/formatters.js`**

Remove the `FEE_CATEGORIES` object (lines 36-43) and the `getCategoryLabel()` function (lines 51-53) entirely.

Replace with a `CATEGORY_COLOR_PALETTE` array — a fixed list of Tailwind color class strings indexed by sort_order position. Use the same 6 colors from the existing FEE_CATEGORIES, in sort_order sequence:

```javascript
/**
 * Fixed palette of Tailwind color classes for fee category badges.
 * Indexed by sort_order from the API categories metadata.
 * Uses modulo for categories beyond the palette size.
 */
export const CATEGORY_COLOR_PALETTE = [
  'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300',
  'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
  'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300',
  'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300',
  'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300',
  'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300',
];
```

Add a helper function:
```javascript
/**
 * Get Tailwind color classes for a category based on its sort order.
 *
 * @param {number|undefined} sortOrder - The category's sort_order from API metadata
 * @returns {string} Tailwind color class string
 */
export function getCategoryColor(sortOrder) {
  if (sortOrder === undefined || sortOrder === null) {
    return CATEGORY_COLOR_PALETTE[0];
  }
  return CATEGORY_COLOR_PALETTE[sortOrder % CATEGORY_COLOR_PALETTE.length];
}
```

**2. Update `src/pages/Contributie/ContributieList.jsx`**

a) Change the import from formatters.js:
```javascript
// OLD:
import { formatCurrency, formatPercentage, FEE_CATEGORIES } from '@/utils/formatters';
// NEW:
import { formatCurrency, formatPercentage, getCategoryColor } from '@/utils/formatters';
```

b) Update the `FeeRow` component to accept `categories` prop from the parent (the API response's `data.categories` object):

Change the FeeRow signature from:
```javascript
function FeeRow({ member, isOdd, isForecast }) {
```
to:
```javascript
function FeeRow({ member, isOdd, isForecast, categories }) {
```

Replace the category badge rendering (lines 67-71):
```javascript
{/* Category */}
<td className="px-4 py-3 whitespace-nowrap">
  <span className={`inline-flex px-2 py-0.5 text-xs rounded-full ${FEE_CATEGORIES[member.category]?.color ?? 'bg-gray-100 text-gray-700'}`}>
    {FEE_CATEGORIES[member.category]?.label ?? member.category}
  </span>
</td>
```
with:
```javascript
{/* Category */}
<td className="px-4 py-3 whitespace-nowrap">
  <span className={`inline-flex px-2 py-0.5 text-xs rounded-full ${getCategoryColor(categories?.[member.category]?.sort_order)}`}>
    {categories?.[member.category]?.label ?? member.category}
  </span>
</td>
```

c) Replace the hardcoded `categoryOrder` (line 248):
```javascript
// OLD:
const categoryOrder = { mini: 1, pupil: 2, junior: 3, senior: 4, recreant: 5, donateur: 6 };
// NEW (derive from API response):
const categoryOrder = {};
Object.entries(data?.categories || {}).forEach(([slug, meta]) => {
  categoryOrder[slug] = meta.sort_order ?? 999;
});
```

d) Pass `categories` to FeeRow in the render (around line 532):
```javascript
// OLD:
<FeeRow
  key={member.id}
  member={member}
  isOdd={index % 2 === 1}
  isForecast={isForecast}
/>
// NEW:
<FeeRow
  key={member.id}
  member={member}
  isOdd={index % 2 === 1}
  isForecast={isForecast}
  categories={data?.categories}
/>
```

**3. Update `src/components/FinancesCard.jsx`**

a) Remove the `getCategoryLabel` import:
```javascript
// OLD:
import { formatCurrency, formatPercentage, getCategoryLabel } from '@/utils/formatters';
// NEW:
import { formatCurrency, formatPercentage } from '@/utils/formatters';
```

b) Replace the `getCategoryLabel(feeData.category)` call (line 97) with `feeData.category_label ?? feeData.category`:
```javascript
// OLD:
{getCategoryLabel(feeData.category)}
// NEW:
{feeData.category_label ?? feeData.category}
```

This uses the `category_label` field added to the person fee endpoint in Task 1.

**4. Run `npm run build` and `npm run lint`**

Ensure no lint errors (max-warnings: 0) and production build succeeds.
  </action>
  <verify>
1. `npm run lint` passes with 0 warnings
2. `npm run build` succeeds
3. Grep `src/` for `FEE_CATEGORIES` — zero results
4. Grep `src/` for `getCategoryLabel` — zero results
5. Grep `src/utils/formatters.js` for `CATEGORY_COLOR_PALETTE` — exists
6. Grep `src/pages/Contributie/ContributieList.jsx` for `data?.categories` — exists
7. Grep `src/components/FinancesCard.jsx` for `category_label` — exists
  </verify>
  <done>
1. `FEE_CATEGORIES` object and `getCategoryLabel()` function are removed from formatters.js
2. `CATEGORY_COLOR_PALETTE` array and `getCategoryColor()` helper exist in formatters.js
3. ContributieList renders category badges using API categories metadata (label from `data.categories`, color from palette indexed by sort_order)
4. ContributieList sorts categories using `sort_order` from API categories metadata
5. FinancesCard displays the category label from the API's `category_label` field
6. `npm run lint` and `npm run build` pass cleanly
  </done>
</task>

</tasks>

<verification>
1. No hardcoded `FEE_CATEGORIES` or `getCategoryLabel` in the frontend codebase
2. No hardcoded `$category_labels` array in `class-rest-google-sheets.php`
3. `CATEGORY_COLOR_PALETTE` exists in formatters.js with 6 color entries
4. Person fee endpoint returns `category_label` field
5. `npm run build` succeeds
6. `npm run lint` passes with 0 warnings
</verification>

<success_criteria>
1. The contributie list page renders category badges (labels + colors) from API response categories metadata — zero hardcoded FEE_CATEGORIES references in the frontend
2. Category colors use a fixed palette indexed by sort_order with modulo overflow
3. Category sorting in the list uses API-provided sort_order values
4. FinancesCard on person detail shows category label from the API, not from hardcoded lookup
5. Google Sheets export derives category labels from API response categories metadata
</success_criteria>

<output>
After completion, create `.planning/phases/159-fee-category-frontend-display/159-01-SUMMARY.md`
</output>
