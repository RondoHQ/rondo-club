---
phase: 127
plan: 03
type: execute
wave: 2
depends_on: ["127-01"]
files_modified:
  - includes/class-rest-api.php
  - includes/class-fee-cache-invalidator.php
autonomous: true

must_haves:
  truths:
    - "Contributie list uses cached fee data for fast loading"
    - "Settings change triggers bulk cache invalidation"
    - "Background cron recalculates all fees after settings change"
    - "REST endpoint returns lid_sinds field instead of registration_date"
  artifacts:
    - path: "includes/class-rest-api.php"
      provides: "Optimized fee list using cache, bulk recalculate endpoint"
      contains: "get_fee_for_person_cached"
    - path: "includes/class-fee-cache-invalidator.php"
      provides: "Settings change hook for bulk invalidation"
      contains: "update_option_stadion_membership_fees"
  key_links:
    - from: "includes/class-rest-api.php"
      to: "includes/class-membership-fees.php"
      via: "Cached fee retrieval"
      pattern: "get_fee_for_person_cached"
---

<objective>
Optimize the fee list endpoint to use cached data and add bulk recalculation capability.

Purpose: Achieve < 1 second load time for Contributie list with 1400+ members and enable admin recalculation when settings change.
Output: Optimized REST endpoint using cache, settings change hook, and background recalculation cron.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/127-fee-caching/127-RESEARCH.md
@.planning/phases/127-fee-caching/127-01-SUMMARY.md
@includes/class-rest-api.php
@includes/class-membership-fees.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update fee list endpoint to use cached data</name>
  <files>includes/class-rest-api.php</files>
  <action>
Update the `get_fee_list()` method in class-rest-api.php to use the new cached fee retrieval method.

1. Find the `get_fee_list()` method (around line 2548).

2. Replace the fee calculation in the foreach loop. Change:
```php
// Get registration date from ACF (Sportlink field)
$registration_date = get_field( 'registratiedatum', $person->ID );

// Calculate full fee with pro-rata
$fee_data = $fees->calculate_full_fee( $person->ID, $registration_date, $season );
```

To:
```php
// Get fee with caching (uses lid-sinds for pro-rata internally)
$fee_data = $fees->get_fee_for_person_cached( $person->ID, $season );
```

3. Update the result array construction. Change the key `'registration_date'` to `'lid_sinds'`:
```php
'lid_sinds' => $fee_data['registration_date'] ?? null,
```

Note: The `calculate_full_fee` stores `registration_date` in the result, but we rename it to `lid_sinds` for the API response to match the actual field name.

4. Add `from_cache` and `calculated_at` to the results array for transparency:
```php
$results[] = [
    'id'                     => $person->ID,
    'name'                   => $name ?: $person->post_title,
    'category'               => $fee_data['category'],
    'leeftijdsgroep'         => $fee_data['leeftijdsgroep'],
    'base_fee'               => $fee_data['base_fee'],
    'family_discount_rate'   => $fee_data['family_discount_rate'],
    'family_discount_amount' => $fee_data['family_discount_amount'],
    'fee_after_discount'     => $fee_data['fee_after_discount'],
    'prorata_percentage'     => $fee_data['prorata_percentage'],
    'final_fee'              => $fee_data['final_fee'],
    'family_key'             => $fee_data['family_key'],
    'family_size'            => $fee_data['family_size'],
    'family_position'        => $fee_data['family_position'],
    'lid_sinds'              => $fee_data['registration_date'] ?? null,
    'from_cache'             => $fee_data['from_cache'] ?? false,
    'calculated_at'          => $fee_data['calculated_at'] ?? null,
];
```
  </action>
  <verify>
```bash
grep -n "get_fee_for_person_cached" includes/class-rest-api.php
grep -n "from_cache" includes/class-rest-api.php
grep -n "'lid_sinds'" includes/class-rest-api.php
```
  </verify>
  <done>
Fee list endpoint uses get_fee_for_person_cached() for performance and returns lid_sinds, from_cache, calculated_at fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add settings change hook and bulk recalculation</name>
  <files>includes/class-fee-cache-invalidator.php</files>
  <action>
Add settings change hook and cron-based bulk recalculation to FeeCacheInvalidator class.

1. Add to the constructor after the REST API hook:
```php
// Settings changes affect all people - trigger bulk recalculation
add_action( 'update_option_stadion_membership_fees', [ $this, 'schedule_bulk_recalculation' ], 10, 2 );

// Cron hook for background recalculation
add_action( 'stadion_recalculate_all_fees', [ $this, 'recalculate_all_fees_background' ] );
```

2. Add the scheduling method after `invalidate_all_caches()`:
```php
/**
 * Schedule bulk recalculation when fee settings change
 *
 * Uses wp_schedule_single_event to avoid timeouts with large member counts.
 *
 * @param mixed $old_value The old option value.
 * @param mixed $new_value The new option value.
 */
public function schedule_bulk_recalculation( $old_value, $new_value ) {
    $season = $this->fees->get_season_key();

    // Clear all caches immediately
    $cleared = $this->fees->clear_all_fee_caches( $season );

    // Schedule background recalculation (10 seconds from now)
    if ( ! wp_next_scheduled( 'stadion_recalculate_all_fees', [ $season ] ) ) {
        wp_schedule_single_event( time() + 10, 'stadion_recalculate_all_fees', [ $season ] );
    }

    // Log for debugging
    error_log( sprintf(
        '[Stadion Fee Cache] Settings changed: cleared %d caches for season %s, recalculation scheduled',
        $cleared,
        $season
    ) );
}

/**
 * Background job to recalculate all fees
 *
 * Called by WordPress cron after settings change.
 * Calculates and caches fees for all people to pre-warm cache.
 *
 * @param string $season The season key.
 */
public function recalculate_all_fees_background( $season ) {
    $query = new \WP_Query(
        [
            'post_type'      => 'person',
            'posts_per_page' => -1,
            'fields'         => 'ids',
            'no_found_rows'  => true,
        ]
    );

    $calculated = 0;
    $skipped    = 0;

    foreach ( $query->posts as $person_id ) {
        // Use get_fee_for_person_cached which calculates and saves
        $result = $this->fees->get_fee_for_person_cached( (int) $person_id, $season );

        if ( $result !== null ) {
            $calculated++;
        } else {
            $skipped++;
        }
    }

    error_log( sprintf(
        '[Stadion Fee Cache] Bulk recalculation complete: %d calculated, %d skipped for season %s',
        $calculated,
        $skipped,
        $season
    ) );
}
```

3. Add the WP_Query import at the top if not present (should already be available via WordPress global).
  </action>
  <verify>
```bash
grep -n "update_option_stadion_membership_fees" includes/class-fee-cache-invalidator.php
grep -n "stadion_recalculate_all_fees" includes/class-fee-cache-invalidator.php
grep -n "schedule_bulk_recalculation" includes/class-fee-cache-invalidator.php
grep -n "recalculate_all_fees_background" includes/class-fee-cache-invalidator.php
grep -n "wp_schedule_single_event" includes/class-fee-cache-invalidator.php
```
  </verify>
  <done>
Settings change triggers cache clear and schedules background recalculation via WordPress cron.
  </done>
</task>

<task type="auto">
  <name>Task 3: Register bulk recalculate REST endpoint</name>
  <files>includes/class-rest-api.php</files>
  <action>
Add a REST endpoint for manually triggering bulk recalculation (admin only).

1. Find the route registration section in class-rest-api.php (look for other `register_rest_route` calls for fees).

2. Add a new route after the fees list route (around where other fee routes are registered):
```php
// Bulk recalculate fees endpoint
register_rest_route(
    'rondo/v1',
    '/fees/recalculate',
    [
        'methods'             => \WP_REST_Server::CREATABLE,
        'callback'            => [ $this, 'recalculate_all_fees' ],
        'permission_callback' => function () {
            return current_user_can( 'manage_options' );
        },
        'args'                => [
            'season' => [
                'default'           => null,
                'sanitize_callback' => 'sanitize_text_field',
                'validate_callback' => function ( $param ) {
                    return $param === null || preg_match( '/^\d{4}-\d{4}$/', $param );
                },
            ],
        ],
    ]
);
```

3. Add the callback method near the `get_fee_list()` method:
```php
/**
 * Trigger bulk fee recalculation
 *
 * Admin-only endpoint to clear all fee caches and schedule recalculation.
 *
 * @param \WP_REST_Request $request The request object.
 * @return \WP_REST_Response Response with recalculation status.
 */
public function recalculate_all_fees( $request ) {
    $fees   = new \Stadion\Fees\MembershipFees();
    $season = $request->get_param( 'season' );

    if ( $season === null ) {
        $season = $fees->get_season_key();
    }

    // Clear all caches
    $cleared = $fees->clear_all_fee_caches( $season );

    // Schedule background recalculation
    if ( ! wp_next_scheduled( 'stadion_recalculate_all_fees', [ $season ] ) ) {
        wp_schedule_single_event( time() + 10, 'stadion_recalculate_all_fees', [ $season ] );
    }

    return rest_ensure_response(
        [
            'success'       => true,
            'season'        => $season,
            'cleared_count' => $cleared,
            'message'       => sprintf(
                'Cleared %d fee caches for season %s. Background recalculation scheduled.',
                $cleared,
                $season
            ),
        ]
    );
}
```
  </action>
  <verify>
```bash
grep -n "fees/recalculate" includes/class-rest-api.php
grep -n "function recalculate_all_fees" includes/class-rest-api.php
grep -n "stadion_recalculate_all_fees" includes/class-rest-api.php
```
  </verify>
  <done>
Admin-only REST endpoint POST /rondo/v1/fees/recalculate clears caches and schedules bulk recalculation.
  </done>
</task>

</tasks>

<verification>
1. Fee list uses cached retrieval:
   ```bash
   grep -A 5 "get_fee_for_person_cached" includes/class-rest-api.php
   ```

2. Settings change triggers recalculation:
   ```bash
   grep "update_option_stadion_membership_fees" includes/class-fee-cache-invalidator.php
   ```

3. Bulk recalculate endpoint exists:
   ```bash
   grep "fees/recalculate" includes/class-rest-api.php
   ```

4. Build and syntax check:
   ```bash
   cd /Users/joostdevalk/Code/stadion && npm run build
   php -l includes/class-rest-api.php
   php -l includes/class-fee-cache-invalidator.php
   ```
</verification>

<success_criteria>
- Fee list endpoint uses get_fee_for_person_cached() instead of calculate_full_fee()
- API response includes lid_sinds, from_cache, calculated_at fields
- Settings change hook triggers cache clear + scheduled recalculation
- Admin can POST to /rondo/v1/fees/recalculate to force recalculation
- Background cron pre-warms cache after settings change
</success_criteria>

<output>
After completion, create `.planning/phases/127-fee-caching/127-03-SUMMARY.md`
</output>
