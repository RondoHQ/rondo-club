---
phase: 127
plan: 02
type: execute
wave: 2
depends_on: ["127-01"]
files_modified:
  - includes/class-fee-cache-invalidator.php
  - functions.php
autonomous: true

must_haves:
  truths:
    - "Fee cache is invalidated when leeftijdsgroep changes"
    - "Fee cache is invalidated when address changes"
    - "Fee cache is invalidated when team membership changes"
    - "Fee cache is invalidated when lid-sinds changes"
    - "Family members' caches are invalidated when one member's address changes"
    - "Fee cache is invalidated via REST API updates"
  artifacts:
    - path: "includes/class-fee-cache-invalidator.php"
      provides: "Cache invalidation hook manager"
      min_lines: 100
    - path: "functions.php"
      provides: "FeeCacheInvalidator class initialization"
      contains: "FeeCacheInvalidator"
  key_links:
    - from: "includes/class-fee-cache-invalidator.php"
      to: "includes/class-membership-fees.php"
      via: "MembershipFees::clear_fee_cache() calls"
      pattern: "clear_fee_cache"
---

<objective>
Create the FeeCacheInvalidator class with ACF hooks for automatic cache invalidation.

Purpose: Ensure cached fees are automatically recalculated when relevant fields change.
Output: New FeeCacheInvalidator class loaded in functions.php with hooks for leeftijdsgroep, addresses, work_history, and lid-sinds.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/127-fee-caching/127-RESEARCH.md
@.planning/phases/127-fee-caching/127-01-SUMMARY.md
@includes/class-volunteer-status.php
@includes/class-inverse-relationships.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FeeCacheInvalidator class</name>
  <files>includes/class-fee-cache-invalidator.php</files>
  <action>
Create a new file `includes/class-fee-cache-invalidator.php` with the FeeCacheInvalidator class. Follow the patterns from VolunteerStatus and InverseRelationships classes.

```php
<?php
/**
 * Fee Cache Invalidation
 *
 * Automatically invalidates cached membership fees when relevant fields change.
 * Hooks into ACF update_value filters and REST API updates.
 *
 * @package Stadion\Fees
 */

namespace Stadion\Fees;

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * Class FeeCacheInvalidator
 *
 * Manages automatic invalidation of fee caches when dependencies change:
 * - leeftijdsgroep: Affects fee category (mini/pupil/junior/senior)
 * - addresses: Affects family grouping and discount
 * - work_history: Affects team membership and recreant detection
 * - lid-sinds: Affects pro-rata calculation
 */
class FeeCacheInvalidator {

    /**
     * MembershipFees instance
     *
     * @var MembershipFees
     */
    private $fees;

    /**
     * Constructor - registers all invalidation hooks
     */
    public function __construct() {
        $this->fees = new MembershipFees();

        // Age group changes affect fee category
        add_filter( 'acf/update_value/name=leeftijdsgroep', [ $this, 'invalidate_person_cache' ], 10, 3 );

        // Address changes affect family grouping (invalidate entire family)
        add_filter( 'acf/update_value/name=addresses', [ $this, 'invalidate_family_cache' ], 10, 3 );

        // Team changes affect senior vs recreant categorization
        add_filter( 'acf/update_value/name=work_history', [ $this, 'invalidate_person_cache' ], 10, 3 );

        // lid-sinds changes affect pro-rata calculation (PRO-04)
        add_filter( 'acf/update_value/name=lid-sinds', [ $this, 'invalidate_person_cache' ], 10, 3 );

        // REST API updates
        add_action( 'rest_after_insert_person', [ $this, 'invalidate_person_cache_rest' ], 10, 2 );
    }

    /**
     * Invalidate fee cache for a person when relevant field changes
     *
     * @param mixed $value   The new field value.
     * @param int   $post_id The post ID.
     * @param array $field   The ACF field array.
     * @return mixed The unmodified value (filter passthrough).
     */
    public function invalidate_person_cache( $value, $post_id, $field ) {
        // Handle object post IDs (can be passed by ACF)
        if ( is_object( $post_id ) && isset( $post_id->ID ) ) {
            $post_id = $post_id->ID;
        }

        // Validate post type
        if ( get_post_type( $post_id ) !== 'person' ) {
            return $value;
        }

        // Clear fee cache for current season
        $this->fees->clear_fee_cache( (int) $post_id );

        return $value;
    }

    /**
     * Invalidate fee cache for entire family when address changes
     *
     * Address changes affect family grouping, which impacts discounts for all
     * family members at the same address. Must invalidate all siblings.
     *
     * @param mixed $value   The new field value.
     * @param int   $post_id The post ID.
     * @param array $field   The ACF field array.
     * @return mixed The unmodified value (filter passthrough).
     */
    public function invalidate_family_cache( $value, $post_id, $field ) {
        // Handle object post IDs
        if ( is_object( $post_id ) && isset( $post_id->ID ) ) {
            $post_id = $post_id->ID;
        }

        // Validate post type
        if ( get_post_type( $post_id ) !== 'person' ) {
            return $value;
        }

        $post_id = (int) $post_id;

        // Clear this person's cache first
        $this->fees->clear_fee_cache( $post_id );

        // Get family key BEFORE the address update (using current saved value)
        $old_family_key = $this->fees->get_family_key( $post_id );

        // If person was in a family, invalidate all family members
        if ( $old_family_key !== null ) {
            $this->invalidate_family_by_key( $old_family_key, $post_id );
        }

        return $value;
    }

    /**
     * Invalidate all family members' caches by family key
     *
     * @param string $family_key The family key (postal code + house number).
     * @param int    $exclude_id Person ID to exclude (already invalidated).
     */
    private function invalidate_family_by_key( string $family_key, int $exclude_id ): void {
        $groups   = $this->fees->build_family_groups();
        $families = $groups['families'];

        if ( ! isset( $families[ $family_key ] ) ) {
            return;
        }

        foreach ( $families[ $family_key ] as $member_id ) {
            if ( (int) $member_id !== $exclude_id ) {
                $this->fees->clear_fee_cache( (int) $member_id );
            }
        }
    }

    /**
     * Invalidate fee cache when person is updated via REST API
     *
     * @param \WP_Post         $post    The post object.
     * @param \WP_REST_Request $request The request object.
     */
    public function invalidate_person_cache_rest( $post, $request ) {
        $this->fees->clear_fee_cache( $post->ID );
    }

    /**
     * Invalidate all fee caches (called when settings change)
     *
     * @param string|null $season Optional season key, defaults to current season.
     * @return int Number of caches cleared.
     */
    public function invalidate_all_caches( ?string $season = null ): int {
        $season = $season ?: $this->fees->get_season_key();
        return $this->fees->clear_all_fee_caches( $season );
    }
}
```
  </action>
  <verify>
```bash
# Check file exists and has correct structure
test -f /Users/joostdevalk/Code/stadion/includes/class-fee-cache-invalidator.php && echo "File exists"
grep -n "namespace Stadion" includes/class-fee-cache-invalidator.php
grep -n "class FeeCacheInvalidator" includes/class-fee-cache-invalidator.php
grep -n "acf/update_value/name=leeftijdsgroep" includes/class-fee-cache-invalidator.php
grep -n "acf/update_value/name=addresses" includes/class-fee-cache-invalidator.php
grep -n "acf/update_value/name=work_history" includes/class-fee-cache-invalidator.php
grep -n "acf/update_value/name=lid-sinds" includes/class-fee-cache-invalidator.php
grep -n "rest_after_insert_person" includes/class-fee-cache-invalidator.php
```
  </verify>
  <done>
FeeCacheInvalidator class exists with hooks for all 4 ACF fields and REST API.
  </done>
</task>

<task type="auto">
  <name>Task 2: Load FeeCacheInvalidator in functions.php</name>
  <files>functions.php</files>
  <action>
Add the FeeCacheInvalidator class to functions.php:

1. Add the use statement near the top with other Stadion\Fees imports (around line 73):
   Find: `use Stadion\Fees\MembershipFees;`
   Add after: `use Stadion\Fees\FeeCacheInvalidator;`

2. Find the class initialization section in functions.php where other classes are instantiated on 'after_setup_theme' or 'init' hooks. Look for patterns like:
   - `new VolunteerStatus();`
   - `new InverseRelationships();`

3. Add the FeeCacheInvalidator initialization on the `init` action with priority 10, near where other hook-based classes are initialized:

   Look for the `rondo_init()` function or similar initialization code and add:
   ```php
   // Initialize fee cache invalidation hooks
   new FeeCacheInvalidator();
   ```

   If there's an `add_action( 'init', ...` or `add_action( 'after_setup_theme', ...` section, add it there.

The FeeCacheInvalidator hooks into ACF filters, which are available after ACF loads (plugins_loaded or init).
  </action>
  <verify>
```bash
grep -n "use Stadion\\\\Fees\\\\FeeCacheInvalidator" functions.php
grep -n "FeeCacheInvalidator" functions.php
```
  </verify>
  <done>
FeeCacheInvalidator is imported and instantiated in functions.php.
  </done>
</task>

</tasks>

<verification>
1. FeeCacheInvalidator class structure:
   ```bash
   # Verify all hooks are registered in constructor
   grep -A 20 "public function __construct" includes/class-fee-cache-invalidator.php
   ```

2. Class is loaded:
   ```bash
   grep "FeeCacheInvalidator" functions.php
   ```

3. PHP syntax check:
   ```bash
   php -l includes/class-fee-cache-invalidator.php
   ```
</verification>

<success_criteria>
- FeeCacheInvalidator class exists in includes/class-fee-cache-invalidator.php
- Class has ACF hooks for: leeftijdsgroep, addresses, work_history, lid-sinds
- Class has REST API hook: rest_after_insert_person
- Address changes trigger family-wide cache invalidation
- Class is loaded in functions.php
</success_criteria>

<output>
After completion, create `.planning/phases/127-fee-caching/127-02-SUMMARY.md`
</output>
