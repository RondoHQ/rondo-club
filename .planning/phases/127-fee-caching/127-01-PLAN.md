---
phase: 127
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-api.php
  - includes/class-membership-fees.php
autonomous: true

must_haves:
  truths:
    - "Pro-rata calculation uses lid-sinds field instead of registratiedatum"
    - "Cached fee data can be read from person meta"
    - "Cached fee data can be written to person meta"
    - "Cache includes all required fields (base_fee, family_discount_amount, prorata_percentage, final_fee)"
  artifacts:
    - path: "includes/class-rest-api.php"
      provides: "Fixed pro-rata field reference"
      contains: "get_field( 'lid-sinds'"
    - path: "includes/class-membership-fees.php"
      provides: "Fee cache read/write methods"
      exports: ["get_fee_for_person_cached", "save_fee_cache"]
  key_links:
    - from: "includes/class-rest-api.php"
      to: "includes/class-membership-fees.php"
      via: "get_fee_for_person_cached method call"
      pattern: "get_fee_for_person_cached"
---

<objective>
Fix the PRO-04 bug (registratiedatum -> lid-sinds) and add cache storage methods to MembershipFees class.

Purpose: Correct the pro-rata calculation for 84 affected members and establish cache infrastructure for performance optimization.
Output: Fixed REST endpoint and new cache read/write methods in MembershipFees class.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/127-fee-caching/127-RESEARCH.md
@includes/class-membership-fees.php
@includes/class-rest-api.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix PRO-04 bug - change registratiedatum to lid-sinds</name>
  <files>includes/class-rest-api.php, includes/class-membership-fees.php</files>
  <action>
Fix the critical pro-rata bug:

1. In `includes/class-rest-api.php` around line 2572, change:
   - FROM: `$registration_date = get_field( 'registratiedatum', $person->ID );`
   - TO: `$registration_date = get_field( 'lid-sinds', $person->ID );`

2. Update the comment above line 2572 to reflect the change:
   - FROM: "Get registration date from ACF (Sportlink field)"
   - TO: "Get membership join date from ACF (lid-sinds field for pro-rata)"

3. In the results array around line 2601, also update the key:
   - FROM: `'registration_date' => $registration_date,`
   - TO: `'lid_sinds' => $registration_date,` (snake_case for JSON consistency)

4. In `includes/class-membership-fees.php`, update the docblock for `calculate_full_fee()` (around line 807):
   - FROM: "The registration_date should come from Sportlink data (ACF field 'registratiedatum')."
   - TO: "The registration_date should come from ACF field 'lid-sinds' (membership join date)."

The `lid-sinds` field already exists in ACF (confirmed in Phase 113 research) - it's the correct field for actual membership start date, not the Sportlink import date.
  </action>
  <verify>
Run grep to confirm changes:
```bash
grep -n "lid-sinds" includes/class-rest-api.php
grep -n "registratiedatum" includes/class-rest-api.php  # Should return no matches
grep -n "lid-sinds" includes/class-membership-fees.php  # Should appear in docblock
```
  </verify>
  <done>
REST endpoint uses 'lid-sinds' field for pro-rata calculation instead of 'registratiedatum'.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add cache storage methods to MembershipFees class</name>
  <files>includes/class-membership-fees.php</files>
  <action>
Add two new methods for fee caching to `class-membership-fees.php`. These build on the existing snapshot infrastructure but use a dedicated cache meta key for performance.

1. Add a new method `get_fee_cache_meta_key()` after `get_snapshot_meta_key()`:
```php
/**
 * Get the post meta key for storing fee cache
 *
 * @param string|null $season Optional season key, defaults to current season.
 * @return string Meta key for fee cache storage.
 */
public function get_fee_cache_meta_key( ?string $season = null ): string {
    return 'stadion_fee_cache_' . ( $season ?: $this->get_season_key() );
}
```

2. Add a new method `save_fee_cache()` for storing calculated fees:
```php
/**
 * Save calculated fee to cache for fast retrieval
 *
 * Stores the complete fee calculation result in post meta.
 * This is separate from the snapshot system which is used for season locking.
 *
 * @param int         $person_id The person post ID.
 * @param array       $fee_data  Complete fee calculation result.
 * @param string|null $season    Optional season key, defaults to current season.
 * @return bool True on success, false on failure.
 */
public function save_fee_cache( int $person_id, array $fee_data, ?string $season = null ): bool {
    $meta_key = $this->get_fee_cache_meta_key( $season );

    // Add metadata
    $fee_data['calculated_at'] = current_time( 'Y-m-d H:i:s' );
    $fee_data['season']        = $season ?: $this->get_season_key();

    return (bool) update_post_meta( $person_id, $meta_key, $fee_data );
}
```

3. Add a new method `get_fee_for_person_cached()` for cached retrieval:
```php
/**
 * Get fee for a person with caching for performance
 *
 * Checks cache first, calculates if cache miss, saves to cache.
 * Uses the lid-sinds field for pro-rata calculation (PRO-04).
 *
 * @param int         $person_id The person post ID.
 * @param string|null $season    Optional season key, defaults to current season.
 * @return array|null Fee data with cache info, or null if not calculable.
 */
public function get_fee_for_person_cached( int $person_id, ?string $season = null ): ?array {
    $season   = $season ?: $this->get_season_key();
    $meta_key = $this->get_fee_cache_meta_key( $season );

    // Try cache first
    $cached = get_post_meta( $person_id, $meta_key, true );

    if ( ! empty( $cached ) && is_array( $cached ) ) {
        $cached['from_cache'] = true;
        return $cached;
    }

    // Cache miss - calculate fresh using lid-sinds (PRO-04 fix)
    $lid_sinds = get_field( 'lid-sinds', $person_id );
    $result    = $this->calculate_full_fee( $person_id, $lid_sinds, $season );

    if ( $result === null ) {
        return null;
    }

    // Save to cache
    $this->save_fee_cache( $person_id, $result, $season );

    // Add cache flag
    $result['from_cache']    = false;
    $result['calculated_at'] = current_time( 'Y-m-d H:i:s' );
    $result['season']        = $season;

    return $result;
}
```

4. Add a new method `clear_fee_cache()` to clear a person's cache:
```php
/**
 * Clear the fee cache for a person
 *
 * @param int         $person_id The person post ID.
 * @param string|null $season    Optional season key, defaults to current season.
 * @return bool True on success, false on failure.
 */
public function clear_fee_cache( int $person_id, ?string $season = null ): bool {
    $meta_key = $this->get_fee_cache_meta_key( $season );
    return delete_post_meta( $person_id, $meta_key );
}
```

5. Add a new method `clear_all_fee_caches()` for bulk clearing:
```php
/**
 * Clear all fee caches for a season
 *
 * @param string $season The season key (e.g., "2025-2026").
 * @return int Number of caches cleared.
 */
public function clear_all_fee_caches( string $season ): int {
    $meta_key = $this->get_fee_cache_meta_key( $season );
    $cleared  = 0;

    $query = new \WP_Query(
        [
            'post_type'      => 'person',
            'posts_per_page' => -1,
            'fields'         => 'ids',
            'no_found_rows'  => true,
        ]
    );

    if ( ! empty( $query->posts ) ) {
        foreach ( $query->posts as $person_id ) {
            if ( delete_post_meta( $person_id, $meta_key ) ) {
                $cleared++;
            }
        }
    }

    return $cleared;
}
```

Place these methods after the existing `clear_all_snapshots_for_season()` method (around line 550).
  </action>
  <verify>
Check that the methods exist and have correct signatures:
```bash
grep -n "function get_fee_cache_meta_key" includes/class-membership-fees.php
grep -n "function save_fee_cache" includes/class-membership-fees.php
grep -n "function get_fee_for_person_cached" includes/class-membership-fees.php
grep -n "function clear_fee_cache" includes/class-membership-fees.php
grep -n "function clear_all_fee_caches" includes/class-membership-fees.php
grep -n "lid-sinds" includes/class-membership-fees.php  # Should appear in get_fee_for_person_cached
```
  </verify>
  <done>
MembershipFees class has cache storage methods: get_fee_cache_meta_key(), save_fee_cache(), get_fee_for_person_cached(), clear_fee_cache(), clear_all_fee_caches().
  </done>
</task>

</tasks>

<verification>
1. PRO-04 fix verified:
   - `grep "registratiedatum" includes/class-rest-api.php` returns empty
   - `grep "lid-sinds" includes/class-rest-api.php` returns the fee endpoint line

2. Cache methods exist:
   - All 5 new methods are present in class-membership-fees.php
   - get_fee_for_person_cached uses 'lid-sinds' not 'registratiedatum'

3. Run npm build to verify no syntax errors:
   ```bash
   cd /Users/joostdevalk/Code/stadion && npm run build
   ```
</verification>

<success_criteria>
- PRO-04 bug is fixed: REST endpoint uses 'lid-sinds' instead of 'registratiedatum'
- Cache storage methods are implemented in MembershipFees class
- No syntax errors in PHP files
</success_criteria>

<output>
After completion, create `.planning/phases/127-fee-caching/127-01-SUMMARY.md`
</output>
