---
phase: 50-caldav-provider
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-caldav-provider.php
  - includes/class-rest-calendar.php
  - functions.php
  - .env.example
autonomous: true
user_setup: []
---

<objective>
Implement CalDAV provider for syncing calendars from iCloud, Fastmail, Nextcloud, and other CalDAV servers.

Purpose: Enable users to connect non-Google calendars using the standard CalDAV protocol with basic authentication.
Output: RONDO_CalDAV_Provider class with calendar discovery, event sync, and iCalendar parsing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-infrastructure/47-01-SUMMARY.md
@.planning/phases/49-google-calendar-provider/49-01-SUMMARY.md

# Key existing files
@includes/class-google-calendar-provider.php (pattern to follow)
@includes/class-rest-calendar.php (has test_caldav stub to implement)
@includes/class-calendar-connections.php (connection helpers)
@includes/class-credential-encryption.php (encrypt CalDAV passwords)

# Reference: CalDAV implementation plan
@Calendar-Integration-Implementation-Plan.md (Section 4.2: Generic CalDAV Provider)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RONDO_CalDAV_Provider class</name>
  <files>includes/class-caldav-provider.php, functions.php</files>
  <action>
Create RONDO_CalDAV_Provider class that mirrors the pattern from RONDO_Google_Calendar_Provider.

The class should use sabre/dav Client and sabre/vobject for iCalendar parsing:

```php
class RONDO_CalDAV_Provider {
    /**
     * Test CalDAV connection credentials
     * @param string $url CalDAV server URL
     * @param string $username
     * @param string $password (app-specific password for iCloud)
     * @return array ['success' => bool, 'calendars' => [...], 'error' => string]
     */
    public static function test_connection(string $url, string $username, string $password): array

    /**
     * Discover available calendars from CalDAV server
     * Uses PROPFIND with Depth: 1 on calendar-home-set
     * @return array of ['id' => href, 'name' => displayname, 'color' => calendar-color]
     */
    public static function discover_calendars(string $url, string $username, string $password): array

    /**
     * Sync events from CalDAV calendar
     * Uses calendar-query REPORT to fetch events in date range
     * @param int $user_id WordPress user ID
     * @param array $connection Connection from user meta (includes credentials)
     * @return array ['created' => int, 'updated' => int, 'total' => int]
     */
    public static function sync(int $user_id, array $connection): array
}
```

**Implementation details:**

1. **test_connection**:
   - Create Sabre\DAV\Client with Basic auth
   - Do OPTIONS request to check CalDAV support (look for 'calendar-access' in DAV header)
   - Return success with discovered calendars, or error message

2. **discover_calendars**:
   - Use PROPFIND on the provided URL with Depth: 1
   - Look for resources with resourcetype containing calendar
   - Extract {DAV:}displayname and {http://apple.com/ns/ical/}calendar-color
   - Return array of calendar objects

3. **sync**:
   - Decrypt credentials from connection
   - Build calendar-query REPORT XML for date range (sync_from_days to +30 days):
     ```xml
     <c:calendar-query xmlns:d="DAV:" xmlns:c="urn:ietf:params:xml:ns:caldav">
       <d:prop>
         <d:getetag/>
         <c:calendar-data/>
       </d:prop>
       <c:filter>
         <c:comp-filter name="VCALENDAR">
           <c:comp-filter name="VEVENT">
             <c:time-range start="YYYYMMDDTHHMMSSZ" end="YYYYMMDDTHHMMSSZ"/>
           </c:comp-filter>
         </c:comp-filter>
       </c:filter>
     </c:calendar-query>
     ```
   - Parse response multiStatus to get calendar-data for each event
   - Use Sabre\VObject\Reader::read() to parse iCalendar
   - Call upsert_event() for each VEVENT (same pattern as Google provider)

4. **upsert_event** (private):
   - Check existing event by _event_uid (VEVENT UID) + _connection_id
   - Extract from VEVENT: SUMMARY (title), DESCRIPTION, DTSTART, DTEND, LOCATION
   - Extract ATTENDEE properties (MAILTO: value, CN parameter)
   - Look for meeting URLs in DESCRIPTION and X-GOOGLE-CONFERENCE
   - Create/update calendar_event post with same meta fields as Google provider

5. **parse_attendees** (private):
   - Parse VEVENT ATTENDEE properties
   - Extract email from MAILTO: value
   - Extract name from CN parameter
   - Extract status from PARTSTAT parameter

**Provider-specific URL patterns to document in code comments:**
- iCloud: https://caldav.icloud.com (requires app-specific password)
- Fastmail: https://caldav.fastmail.com/dav/calendars/user/{email}/
- Nextcloud: https://yourserver.com/remote.php/dav/calendars/{user}/
- Generic: User provides full calendar URL

Add class to autoloader in functions.php rondo_init().
  </action>
  <verify>
    - Class file exists with all methods
    - No PHP syntax errors: `php -l includes/class-caldav-provider.php`
    - Class loads via autoloader
  </verify>
  <done>RONDO_CalDAV_Provider class created with test_connection, discover_calendars, and sync methods</done>
</task>

<task type="auto">
  <name>Task 2: Implement CalDAV REST endpoints</name>
  <files>includes/class-rest-calendar.php</files>
  <action>
Update the existing stub methods in RONDO_REST_Calendar to call RONDO_CalDAV_Provider:

1. **test_caldav()** - Replace 501 stub with working implementation:
   - Get url, username, password from request params
   - Call RONDO_CalDAV_Provider::test_connection()
   - On success: Return calendars list for user to select
   - On failure: Return error message

2. **trigger_sync()** - Add CalDAV support to existing method:
   - Check if provider === 'caldav'
   - If so, call RONDO_CalDAV_Provider::sync() instead of Google provider
   - Update last_sync and last_error on connection
   - Return sync results

**Response format for test_caldav:**
```json
{
  "success": true,
  "calendars": [
    {"id": "/calendars/user/calendar1/", "name": "Personal", "color": "#0000FF"},
    {"id": "/calendars/user/calendar2/", "name": "Work", "color": "#FF0000"}
  ]
}
```

**Error response:**
```json
{
  "success": false,
  "error": "Authentication failed. Check username and app-specific password."
}
```
  </action>
  <verify>
    - test_caldav no longer returns 501
    - trigger_sync handles provider === 'caldav'
    - No PHP syntax errors
  </verify>
  <done>CalDAV test endpoint returns calendar discovery results, sync endpoint works for CalDAV connections</done>
</task>

<task type="auto">
  <name>Task 3: Update .env.example with CalDAV documentation</name>
  <files>.env.example</files>
  <action>
Add documentation comments explaining CalDAV configuration (no env vars needed for CalDAV - it's per-user credentials):

```
# CalDAV Calendar Integration
# No server-side configuration needed - users provide their own credentials.
#
# Supported providers:
# - iCloud: Use https://caldav.icloud.com with app-specific password
#   (Generate at https://appleid.apple.com → Security → App-Specific Passwords)
# - Fastmail: Use https://caldav.fastmail.com/dav/calendars/user/{email}/
# - Nextcloud: Use https://yourserver.com/remote.php/dav/calendars/{user}/
# - Generic CalDAV: Any server supporting CalDAV standard
#
# Users add connections via Settings → Calendars → Add CalDAV Calendar
```
  </action>
  <verify>
    - .env.example contains CalDAV section with provider examples
  </verify>
  <done>CalDAV setup documentation added to .env.example</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] RONDO_CalDAV_Provider class exists and loads without errors
- [ ] test_caldav REST endpoint returns proper response (not 501)
- [ ] trigger_sync handles caldav provider type
- [ ] No PHP warnings or errors in error_log
- [ ] .env.example updated with CalDAV documentation
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- CalDAV provider mirrors Google provider pattern
- test_caldav endpoint functional for credential validation
- sync endpoint works for CalDAV connections
</success_criteria>

<output>
After completion, create `.planning/phases/50-caldav-provider/50-01-SUMMARY.md`
</output>
