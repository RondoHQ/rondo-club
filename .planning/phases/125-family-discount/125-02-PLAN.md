---
phase: 125-family-discount
plan: 02
type: execute
wave: 1
depends_on: ["125-01"]
files_modified:
  - includes/class-membership-fees.php
autonomous: true

must_haves:
  truths:
    - "First youth member at address pays full fee (no discount)"
    - "Second youth member at address gets 25% discount"
    - "Third and subsequent youth members get 50% discount"
    - "Discount applies to cheapest member first (most expensive pays full)"
    - "Recreants and donateurs do not receive family discount"
  artifacts:
    - path: "includes/class-membership-fees.php"
      provides: "Family discount calculation methods"
      exports: ["get_family_discount_rate", "calculate_fee_with_family_discount"]
  key_links:
    - from: "calculate_fee_with_family_discount"
      to: "build_family_groups"
      via: "Uses family groups to determine position and discount"
      pattern: "build_family_groups"
    - from: "calculate_fee_with_family_discount"
      to: "get_fee_for_person"
      via: "Extends the public API with family discount information"
      pattern: "family_discount"
---

<objective>
Add tiered family discount calculation logic to the MembershipFees class.

Purpose: Apply 25%/50% discounts to 2nd/3rd+ youth members at the same address, with discount applied to cheapest members first.
Output: Family discount rate method and fee calculation method that includes family discount in the result.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/125-family-discount/125-CONTEXT.md
@.planning/phases/125-family-discount/125-RESEARCH.md
@.planning/phases/125-family-discount/125-01-SUMMARY.md
@includes/class-membership-fees.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add family discount rate method</name>
  <files>includes/class-membership-fees.php</files>
  <action>
Add the `get_family_discount_rate(int $position): float` method:

Per FAM-02, FAM-03, FAM-04 requirements:
- Position 1 (most expensive youth): 0.0 (no discount, pays full fee)
- Position 2: 0.25 (25% discount)
- Position 3 and beyond: 0.50 (50% discount)

```php
/**
 * Get discount rate based on family position
 *
 * Position is 1-indexed where position 1 is the most expensive youth member
 * who pays full fee. Position 2 gets 25% off, position 3+ gets 50% off.
 *
 * @param int $position 1-indexed position in family (1=most expensive, pays full).
 * @return float Discount rate (0.0, 0.25, or 0.50).
 */
public function get_family_discount_rate( int $position ): float {
    if ( $position <= 1 ) {
        return 0.0;  // First member pays full fee
    }
    if ( $position === 2 ) {
        return 0.25; // Second member gets 25% off
    }
    return 0.50;     // Third+ get 50% off
}
```

Simple method, but important to have it separated for testing and clarity.
  </action>
  <verify>
Test via WP-CLI:
```bash
wp eval '
$fees = new \Stadion\Fees\MembershipFees();
echo "Position 1: " . $fees->get_family_discount_rate(1) . "\n";
echo "Position 2: " . $fees->get_family_discount_rate(2) . "\n";
echo "Position 3: " . $fees->get_family_discount_rate(3) . "\n";
echo "Position 4: " . $fees->get_family_discount_rate(4) . "\n";
'
```
Expected output:
```
Position 1: 0
Position 2: 0.25
Position 3: 0.5
Position 4: 0.5
```
  </verify>
  <done>
- get_family_discount_rate(1) returns 0.0
- get_family_discount_rate(2) returns 0.25
- get_family_discount_rate(3) returns 0.50
- get_family_discount_rate(4+) returns 0.50
  </done>
</task>

<task type="auto">
  <name>Task 2: Add fee calculation with family discount method</name>
  <files>includes/class-membership-fees.php</files>
  <action>
Add the `calculate_fee_with_family_discount(int $person_id, ?string $season = null): ?array` method:

1. Get base fee using calculate_fee($person_id)
2. If null, return null (person not calculable)

3. Check if eligible for family discount:
   - Only youth categories are eligible: ['mini', 'pupil', 'junior']
   - If not youth (senior, recreant, donateur), return base fee with:
     ```php
     return array_merge($fee_data, [
         'family_discount_rate'   => 0.0,
         'family_discount_amount' => 0,
         'final_fee'              => $fee_data['base_fee'],
         'family_position'        => null,
         'family_key'             => null,
         'family_size'            => null,
     ]);
     ```

4. Get family key for this person using get_family_key($person_id)
5. If null (no valid address), person gets no discount:
   ```php
   return array_merge($fee_data, [
       'family_discount_rate'   => 0.0,
       'family_discount_amount' => 0,
       'final_fee'              => $fee_data['base_fee'],
       'family_position'        => null,
       'family_key'             => null,
       'family_size'            => 1,
   ]);
   ```

6. Build family groups using build_family_groups($season)
7. Get this person's family from groups:
   ```php
   $families = $groups['families'];
   $person_data = $groups['person_data'];
   $family_key = $person_data[$person_id]['family_key'];
   $family_members = $families[$family_key] ?? [];
   ```

8. If family has only 1 member, no discount (they're alone)

9. Build sorted list of family members by base_fee DESCENDING (most expensive first):
   ```php
   $sorted = [];
   foreach ($family_members as $member_id) {
       $sorted[] = [
           'person_id' => $member_id,
           'base_fee'  => $person_data[$member_id]['base_fee'],
       ];
   }
   usort($sorted, function($a, $b) {
       // Sort descending by base_fee
       $cmp = $b['base_fee'] <=> $a['base_fee'];
       if ($cmp !== 0) return $cmp;
       // Tie-breaker: lower person_id first (older record = full fee)
       return $a['person_id'] <=> $b['person_id'];
   });
   ```

10. Find position of current person in sorted list (1-indexed):
    ```php
    $position = 1;
    foreach ($sorted as $index => $member) {
        if ($member['person_id'] === $person_id) {
            $position = $index + 1;
            break;
        }
    }
    ```

11. Calculate discount:
    ```php
    $discount_rate = $this->get_family_discount_rate($position);
    $discount_amount = (int) round($fee_data['base_fee'] * $discount_rate);
    $final_fee = $fee_data['base_fee'] - $discount_amount;
    ```

12. Return complete result:
    ```php
    return array_merge($fee_data, [
        'family_discount_rate'   => $discount_rate,
        'family_discount_amount' => $discount_amount,
        'final_fee'              => $final_fee,
        'family_position'        => $position,
        'family_key'             => $family_key,
        'family_size'            => count($family_members),
    ]);
    ```

Note: This method recalculates family groups each time. This is intentional per RESEARCH.md decision to calculate on-demand rather than cache (family composition can change).
  </action>
  <verify>
Test via WP-CLI:
```bash
wp eval '
$fees = new \Stadion\Fees\MembershipFees();

// Find a family with multiple youth members
$groups = $fees->build_family_groups();
$multi_families = array_filter($groups["families"], fn($m) => count($m) > 1);

if (empty($multi_families)) {
    echo "No families with 2+ youth members found\n";
    exit;
}

// Get first multi-member family
$family_key = array_key_first($multi_families);
$members = $multi_families[$family_key];

echo "Testing family $family_key with " . count($members) . " members:\n";
foreach ($members as $person_id) {
    $result = $fees->calculate_fee_with_family_discount($person_id);
    echo "  Person $person_id: base=" . $result["base_fee"] .
         " pos=" . $result["family_position"] .
         " rate=" . ($result["family_discount_rate"] * 100) . "%" .
         " final=" . $result["final_fee"] . "\n";
}
'
```
  </verify>
  <done>
- calculate_fee_with_family_discount returns complete fee data with discount fields
- Non-youth (senior, recreant, donateur) get 0% discount
- Youth without address get 0% discount
- First youth in family (most expensive) gets 0% discount
- Second youth gets 25% discount
- Third+ youth get 50% discount
- Sorting: most expensive first, ties broken by person_id
  </done>
</task>

<task type="auto">
  <name>Task 3: Build, test, and deploy</name>
  <files>includes/class-membership-fees.php</files>
  <action>
1. Run npm build to ensure frontend builds successfully
2. Run PHPCS to check for linting issues:
   ```bash
   composer lint
   ```
3. Fix any PHPCS issues in the new methods
4. Deploy to production using bin/deploy.sh
5. Verify the new methods work on production
  </action>
  <verify>
Run the complete verification on production:
```bash
# Load .env for production URL
source .env

# SSH test on production
ssh -p "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" \
  "cd ~/www/stadion.svawc.nl/public_html/wp-content/themes/stadion && \
   wp eval '
\$fees = new \\Stadion\\Fees\\MembershipFees();

// Test discount rates
echo \"Discount rates: \";
echo \"pos1=\" . \$fees->get_family_discount_rate(1) . \" \";
echo \"pos2=\" . \$fees->get_family_discount_rate(2) . \" \";
echo \"pos3=\" . \$fees->get_family_discount_rate(3) . \"\\n\";

// Test family groups
\$groups = \$fees->build_family_groups();
\$multi = array_filter(\$groups[\"families\"], fn(\$m) => count(\$m) > 1);
echo \"Families with 2+ youth: \" . count(\$multi) . \"\\n\";
'"
```
  </verify>
  <done>
- npm run build completes without errors
- PHPCS passes with no violations in new code
- Production deployment successful
- Family discount methods work on production
  </done>
</task>

</tasks>

<verification>
Complete family discount verification:
```bash
wp eval '
$fees = new \Stadion\Fees\MembershipFees();

echo "=== Family Discount System Test ===\n\n";

// 1. Test discount rates
echo "1. Discount rates by position:\n";
for ($pos = 1; $pos <= 4; $pos++) {
    echo "   Position $pos: " . ($fees->get_family_discount_rate($pos) * 100) . "%\n";
}

// 2. Build family groups
echo "\n2. Family groups:\n";
$groups = $fees->build_family_groups();
$youth_count = count($groups["person_data"]);
$family_count = count($groups["families"]);
$multi = array_filter($groups["families"], fn($m) => count($m) > 1);
echo "   Total youth with addresses: $youth_count\n";
echo "   Total families: $family_count\n";
echo "   Families with 2+ youth: " . count($multi) . "\n";

// 3. Test a multi-member family if one exists
if (!empty($multi)) {
    $family_key = array_key_first($multi);
    $members = $multi[$family_key];

    echo "\n3. Sample family ($family_key):\n";
    foreach ($members as $person_id) {
        $result = $fees->calculate_fee_with_family_discount($person_id);
        $name = get_the_title($person_id);
        echo "   $name: base={$result[\"base_fee\"]} final={$result[\"final_fee\"]} " .
             "(pos={$result[\"family_position\"]}, -{$result[\"family_discount_amount\"]})\n";
    }
}

// 4. Test a non-youth member (should get no discount)
echo "\n4. Non-youth test:\n";
$query = new WP_Query([
    "post_type" => "person",
    "posts_per_page" => 5,
    "fields" => "ids",
]);
foreach ($query->posts as $pid) {
    $fee = $fees->calculate_fee($pid);
    if ($fee && !in_array($fee["category"], ["mini", "pupil", "junior"])) {
        $result = $fees->calculate_fee_with_family_discount($pid);
        echo "   {$result[\"category\"]}: discount_rate=" . $result["family_discount_rate"] . " (should be 0)\n";
        break;
    }
}

echo "\n=== Test Complete ===\n";
'
```

Expected behavior:
- Position 1: 0% discount (full fee)
- Position 2: 25% discount
- Position 3+: 50% discount
- Non-youth: 0% discount regardless of family
- Youth without address: 0% discount
</verification>

<success_criteria>
- [ ] get_family_discount_rate returns correct rates (0%, 25%, 50%)
- [ ] calculate_fee_with_family_discount applies discounts correctly
- [ ] Most expensive youth member pays full fee (position 1)
- [ ] Second member gets 25% off (FAM-02)
- [ ] Third+ members get 50% off (FAM-03)
- [ ] Non-youth categories get 0% discount (FAM-05)
- [ ] Youth without address get 0% discount
- [ ] final_fee = base_fee - family_discount_amount
- [ ] Deployed to production and verified
</success_criteria>

<output>
After completion, create `.planning/phases/125-family-discount/125-02-SUMMARY.md`
</output>
