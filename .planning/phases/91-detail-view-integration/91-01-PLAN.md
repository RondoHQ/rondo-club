---
phase: 91-detail-view-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-custom-fields.php
  - includes/class-rest-api.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Non-admin users can see custom field definitions for people/teams they can view"
    - "Field definitions include label, type, name, and type-specific config (choices, etc.)"
    - "Admin users continue to have full access to custom field management"
  artifacts:
    - path: "includes/class-rest-custom-fields.php"
      provides: "Read-only endpoint for field metadata"
      contains: "get_field_metadata_permissions_check"
  key_links:
    - from: "includes/class-rest-custom-fields.php"
      to: "Stadion\\CustomFields\\Manager"
      via: "get_fields() method"
      pattern: "manager->get_fields"
---

<objective>
Expose custom field definitions to non-admin users via REST API

Purpose: Non-admin users need field metadata (label, type, choices) to properly display custom fields on detail pages. Currently the `/rondo/v1/custom-fields/{post_type}` endpoint requires `manage_options`, blocking non-admins.

Output: A read-only endpoint or filter that provides field metadata to any logged-in user who can view posts of that type.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/91-detail-view-integration/91-RESEARCH.md

@includes/class-rest-custom-fields.php
@includes/customfields/class-manager.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add read-only field metadata endpoint for non-admins</name>
  <files>includes/class-rest-custom-fields.php</files>
  <action>
Add a new REST route in the CustomFields controller for read-only field metadata access:

1. Register new route: `GET /rondo/v1/custom-fields/{post_type}/metadata`
   - This is a separate endpoint from the admin CRUD routes
   - Permission: any logged-in user (`is_user_logged_in()`)

2. Create `get_field_metadata_permissions_check` method:
   - Return `is_user_logged_in()` - any authenticated user can see field definitions
   - This is safe because field definitions are structural, not user data

3. Create `get_field_metadata` callback method:
   - Call `$this->manager->get_fields($post_type)` to get active fields
   - For each field, return only the display-relevant properties:
     - `key`, `name`, `label`, `type`, `instructions`
     - `choices` (for select/checkbox)
     - `ui_on_text`, `ui_off_text` (for true_false)
     - `display_format` (for date)
     - `return_format` (for image, file, relationship)
     - `post_type` (for relationship - what types it links to)
     - `prepend`, `append` (for number)
   - Do NOT expose sensitive admin-only options like validation rules

Why separate endpoint instead of modifying existing:
- Existing endpoints handle CRUD with admin permissions
- Metadata endpoint is read-only with relaxed permissions
- Clean separation of concerns
  </action>
  <verify>
Test with non-admin user:
```bash
# As non-admin user (via browser console or curl with nonce)
fetch('/wp-json/rondo/v1/custom-fields/person/metadata')
  .then(r => r.json())
  .then(console.log)
```
Should return array of field definitions with display properties.

Test admin CRUD endpoints still require `manage_options`:
- GET `/rondo/v1/custom-fields/person` should still require admin
- POST, PUT, DELETE should still require admin
  </verify>
  <done>
- `/rondo/v1/custom-fields/{post_type}/metadata` endpoint returns field definitions to any logged-in user
- Endpoint returns only display-relevant properties (no sensitive config)
- Existing admin endpoints unchanged in permissions
  </done>
</task>

<task type="auto">
  <name>Task 2: Add prmApi client method for field metadata</name>
  <files>src/api/client.js</files>
  <action>
Add new API method to the prmApi object for fetching field metadata:

```javascript
// Custom Fields metadata (read-only, for display)
getCustomFieldsMetadata: (postType) => api.get(`/rondo/v1/custom-fields/${postType}/metadata`),
```

This is separate from the existing `getCustomFields` method which requires admin access.

Place it after the existing `deleteCustomField` method in the file.
  </action>
  <verify>
Build passes: `npm run build`
Method is accessible from the API client.
  </verify>
  <done>
- `prmApi.getCustomFieldsMetadata(postType)` method available
- Returns field definitions for display purposes
  </done>
</task>

</tasks>

<verification>
1. Non-admin user can fetch field metadata via API
2. Field metadata includes all necessary display properties
3. Admin-only CRUD endpoints remain protected
4. Build passes with no errors
</verification>

<success_criteria>
- Custom field definitions accessible to non-admin users via new `/metadata` endpoint
- API client has `getCustomFieldsMetadata` method
- No permission changes to existing admin endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/91-detail-view-integration/91-01-SUMMARY.md`
</output>
