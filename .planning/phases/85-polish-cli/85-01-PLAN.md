---
phase: 85-polish-cli
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-wp-cli.php
autonomous: true

must_haves:
  truths:
    - "Admin can trigger sync for a user via wp stadion google-contacts sync --user-id=ID"
    - "Admin can force full resync via --full flag"
    - "Admin can check sync status via wp stadion google-contacts status --user-id=ID"
    - "Admin can list unresolved conflicts via wp stadion google-contacts conflicts --user-id=ID"
    - "Admin can unlink all contacts to reset sync state via wp stadion google-contacts unlink-all --user-id=ID"
  artifacts:
    - path: "includes/class-wp-cli.php"
      provides: "STADION_Google_Contacts_CLI_Command class with 5 commands"
      contains: "class STADION_Google_Contacts_CLI_Command"
  key_links:
    - from: "includes/class-wp-cli.php"
      to: "GoogleContactsSync::sync_user_manual()"
      via: "sync command"
      pattern: "sync_user_manual"
    - from: "includes/class-wp-cli.php"
      to: "GoogleContactsAPI::import_all()"
      via: "sync --full command"
      pattern: "import_all"
    - from: "includes/class-wp-cli.php"
      to: "GoogleContactsConnection::get_connection()"
      via: "status command"
      pattern: "get_connection"
---

<objective>
Add WP-CLI commands for Google Contacts administrative operations.

Purpose: Allow admins to manage Google Contacts sync via command line - trigger syncs, check status, view conflicts, and reset sync state.

Output: `STADION_Google_Contacts_CLI_Command` class with 5 subcommands registered under `wp stadion google-contacts`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Existing classes to wrap:
- `includes/class-google-contacts-sync.php` - sync_user_manual(), get_sync_status()
- `includes/class-google-contacts-connection.php` - get_connection(), is_connected()
- `includes/class-google-contacts-api-import.php` - import_all() for full resync

Conflicts are logged as comments with:
- comment_type = 'stadion_activity'
- activity_type = 'sync_conflict' (comment meta)

Pattern to follow:
@includes/class-wp-cli.php - existing WP-CLI commands follow this structure
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create STADION_Google_Contacts_CLI_Command class with all 5 commands</name>
  <files>includes/class-wp-cli.php</files>
  <action>
Add a new `STADION_Google_Contacts_CLI_Command` class inside the `if ( defined( 'WP_CLI' ) && WP_CLI )` block in class-wp-cli.php. Follow the existing pattern used by `STADION_Calendar_CLI_Command`.

Add these imports at the top (inside the WP_CLI check block):
```php
use Stadion\Contacts\GoogleContactsSync;
use Stadion\Contacts\GoogleContactsConnection;
use Stadion\Import\GoogleContactsAPI;
use Stadion\Collaboration\CommentTypes;
```

Create the class with these methods:

**1. sync($args, $assoc_args)** - CLI-01 and CLI-02
- Options: `--user-id=<user_id>` (required), `--full` (optional)
- Validate user exists and is connected to Google Contacts
- If `--full` flag: instantiate `new GoogleContactsAPI($user_id)` and call `import_all()`
- Otherwise: instantiate `new GoogleContactsSync()` and call `sync_user_manual($user_id)`
- Output stats: pulled, pushed, errors
- Use WP_CLI::log for progress, WP_CLI::success for completion

**2. status($args, $assoc_args)** - CLI-03
- Options: `--user-id=<user_id>` (required)
- Get connection via `GoogleContactsConnection::get_connection($user_id)`
- Display: connected email, access_mode, last_sync, last_error, contact_count, sync_frequency
- Also show sync_history (last 10) if available
- Format as nice table with headers

**3. conflicts($args, $assoc_args)** - CLI-04
- Options: `--user-id=<user_id>` (required)
- Query comments with type 'stadion_activity' and activity_type meta = 'sync_conflict'
- Filter to posts owned by the user
- Display: person name, conflict date, conflict details (from comment_content)
- Use WP_CLI::warning if no conflicts found, WP_CLI::log otherwise

**4. unlink_all($args, $assoc_args)** - CLI-05
- Options: `--user-id=<user_id>` (required), `--yes` (skip confirmation)
- Query all person posts with _google_contact_id meta owned by user
- Without --yes: show count and ask for confirmation using WP_CLI::confirm()
- Delete these meta keys for each: _google_contact_id, _google_etag, _google_last_import, _google_last_export, _google_synced_fields
- Clear sync_token from connection: `GoogleContactsConnection::update_connection($user_id, ['sync_token' => null])`
- Output count of unlinked contacts

Register the command at the bottom with other commands:
```php
WP_CLI::add_command( 'stadion google-contacts', 'STADION_Google_Contacts_CLI_Command' );
```

Note: Use `stadion` namespace (not `prm`) to match the requirement spec which says `wp stadion google-contacts`.
  </action>
  <verify>
Run these commands to verify the CLI is registered and works:

```bash
# Verify commands are registered
wp stadion google-contacts --help

# Each subcommand should show help
wp stadion google-contacts sync --help
wp stadion google-contacts status --help
wp stadion google-contacts conflicts --help
wp stadion google-contacts unlink-all --help
```
  </verify>
  <done>
All 5 WP-CLI commands are implemented:
- wp stadion google-contacts sync --user-id=ID triggers delta sync
- wp stadion google-contacts sync --user-id=ID --full triggers full resync
- wp stadion google-contacts status --user-id=ID shows connection status
- wp stadion google-contacts conflicts --user-id=ID lists unresolved conflicts
- wp stadion google-contacts unlink-all --user-id=ID removes all Google links
  </done>
</task>

<task type="auto">
  <name>Task 2: Update version, changelog, and deploy</name>
  <files>style.css, package.json, CHANGELOG.md</files>
  <action>
This completes v5.0 Google Contacts Sync milestone.

1. Update version to 5.0.0 in:
   - style.css (Version: line)
   - package.json (version field)

2. Add changelog entry for v5.0.0 in CHANGELOG.md:
   ```markdown
   ## [5.0.0] - 2026-01-18

   ### Added
   - Google Contacts bidirectional sync with Stadion as source of truth
   - OAuth connection for Google Contacts in Settings > Connections
   - Automatic import from Google Contacts with duplicate detection
   - Export Stadion contacts to Google Contacts
   - Delta sync using Google syncToken for efficient updates
   - Configurable sync frequency (15min, hourly, 6hr, daily)
   - Conflict detection with Stadion-wins resolution strategy
   - Sync history log in Settings showing recent sync operations
   - "View in Google Contacts" link on synced person profiles
   - WP-CLI commands for Google Contacts management:
     - `wp stadion google-contacts sync --user-id=ID` - trigger sync
     - `wp stadion google-contacts sync --user-id=ID --full` - full resync
     - `wp stadion google-contacts status --user-id=ID` - check status
     - `wp stadion google-contacts conflicts --user-id=ID` - list conflicts
     - `wp stadion google-contacts unlink-all --user-id=ID` - reset sync
   ```

3. Deploy to production using the standard rsync commands from AGENTS.md.

4. Commit changes with message: `feat(85): add Google Contacts WP-CLI commands, complete v5.0`
  </action>
  <verify>
1. Version check: `grep -E "^Version:|\"version\"" style.css package.json`
2. Changelog has v5.0.0 entry
3. Production updated: SSH and verify theme version
  </verify>
  <done>
- Version bumped to 5.0.0
- Changelog updated with all v5.0 features
- Deployed to production
- Git committed and pushed
  </done>
</task>

</tasks>

<verification>
1. WP-CLI commands respond to --help
2. Commands validate user exists before processing
3. Commands validate user is connected to Google Contacts
4. Error messages are clear when prerequisites not met
5. Version is 5.0.0 in both style.css and package.json
6. Changelog reflects all v5.0 features
</verification>

<success_criteria>
- [ ] All 5 CLI commands implemented and registered
- [ ] Commands follow existing WP-CLI patterns in codebase
- [ ] Commands handle errors gracefully with clear messages
- [ ] Version bumped to 5.0.0
- [ ] Changelog updated
- [ ] Deployed to production
- [ ] Committed to git
</success_criteria>

<output>
After completion, create `.planning/phases/85-polish-cli/85-01-SUMMARY.md`
</output>
