# Plan 32-01: Todo Data Model Enhancement

**Phase:** 32 - Todo Data Model Enhancement
**Goal:** Add notes field, change to multi-person model, update REST API

## Current State

- `stadion_todo` CPT with custom post statuses (`stadion_open`, `stadion_awaiting`, `stadion_completed`)
- ACF fields in `acf-json/group_todo_fields.json`:
  - `related_person` - Single post_object pointing to one person
  - `awaiting_since` - DateTime for tracking wait time
  - `due_date` - Date picker
  - `_visibility` / `_assigned_workspaces` - Access control
- REST API in `includes/class-rest-todos.php`:
  - Person-scoped: `GET/POST /stadion/v1/people/{id}/todos`
  - Global: `GET /stadion/v1/todos`, `GET/PUT/DELETE /stadion/v1/todos/{id}`
- Frontend modals: `TodoModal.jsx`, `GlobalTodoModal.jsx`

## Target State

- New `notes` field for detailed descriptions (HTML/rich text)
- `related_persons` field (array) replacing `related_person` (single)
- REST API returns/accepts array of person IDs
- Migration script for existing todos

## Tasks

### Task 1: Add Notes ACF Field

**File:** `acf-json/group_todo_fields.json`

Add new field after `related_person`:
```json
{
  "key": "field_todo_notes",
  "label": "Notes",
  "name": "notes",
  "type": "wysiwyg",
  "instructions": "Additional notes or details for this todo",
  "required": 0,
  "tabs": "visual",
  "toolbar": "basic",
  "media_upload": 0
}
```

This uses ACF's WYSIWYG field which integrates with WordPress's TinyMCE editor. On the frontend we'll use TipTap (already in codebase) for editing.

### Task 2: Change related_person to Multi-Value

**File:** `acf-json/group_todo_fields.json`

Change `related_person` field:
```json
{
  "key": "field_todo_related_person",
  "label": "Related People",
  "name": "related_persons",
  "type": "post_object",
  "instructions": "Select the people this todo is related to",
  "required": 1,
  "post_type": ["person"],
  "multiple": 1,
  "return_format": "id",
  "allow_null": 0
}
```

Key changes:
- `name`: `related_person` → `related_persons`
- `label`: `Related Person` → `Related People`
- `multiple`: `0` → `1`

### Task 3: Update REST API

**File:** `includes/class-rest-todos.php`

Changes needed:

1. **`format_todo()` method** - Return array of persons:
   ```php
   // Current: single person
   $person_id = (int) get_field('related_person', $post->ID);

   // New: array of persons
   $person_ids = get_field('related_persons', $post->ID) ?: [];
   if (!is_array($person_ids)) {
       $person_ids = $person_ids ? [$person_ids] : [];
   }

   // Build persons array with details
   $persons = [];
   foreach ($person_ids as $pid) {
       $persons[] = [
           'id' => (int) $pid,
           'name' => get_the_title($pid),
           'thumbnail' => get_the_post_thumbnail_url($pid, 'thumbnail') ?: null,
       ];
   }

   // Return both for backward compatibility during transition
   return [
       // ... existing fields
       'person_id'        => $persons[0]['id'] ?? null,  // Deprecated
       'person_name'      => $persons[0]['name'] ?? '',  // Deprecated
       'person_thumbnail' => $persons[0]['thumbnail'] ?? '', // Deprecated
       'persons'          => $persons,  // New array format
       'notes'            => get_field('notes', $post->ID) ?: null,
   ];
   ```

2. **`get_person_todos()` method** - Query by array field:
   ```php
   // Use LIKE query since ACF stores serialized arrays
   $todos = get_posts([
       'post_type'      => 'stadion_todo',
       'posts_per_page' => -1,
       'post_status'    => ['stadion_open', 'stadion_awaiting', 'stadion_completed'],
       'meta_query'     => [
           [
               'key'     => 'related_persons',
               'value'   => sprintf('"%d"', $person_id), // Serialized format
               'compare' => 'LIKE',
           ],
       ],
   ]);
   ```

3. **`create_person_todo()` method** - Accept person_ids array:
   ```php
   $person_ids = $request->get_param('person_ids');
   if (!is_array($person_ids)) {
       // Single person_id for backward compatibility
       $person_id = (int) $request->get_param('person_id');
       $person_ids = $person_id ? [$person_id] : [];
   }

   // Save as array
   update_field('related_persons', $person_ids, $post_id);

   // Save notes if provided
   $notes = $request->get_param('notes');
   if ($notes !== null) {
       update_field('notes', wp_kses_post($notes), $post_id);
   }
   ```

4. **`update_todo()` method** - Handle person_ids and notes:
   ```php
   // Update persons if provided
   $person_ids = $request->get_param('person_ids');
   if ($person_ids !== null) {
       update_field('related_persons', array_map('intval', $person_ids), $todo_id);
   }

   // Update notes if provided
   $notes = $request->get_param('notes');
   if ($notes !== null) {
       update_field('notes', wp_kses_post($notes), $todo_id);
   }
   ```

### Task 4: Create Migration CLI Command

**File:** `includes/class-cli-commands.php` (or new file)

WP-CLI command to migrate existing todos:
```php
/**
 * Migrate todos from related_person to related_persons
 *
 * ## EXAMPLES
 *     wp prm migrate-todo-persons --dry-run
 *     wp prm migrate-todo-persons
 */
public function migrate_todo_persons($args, $assoc_args) {
    $dry_run = isset($assoc_args['dry-run']);

    $todos = get_posts([
        'post_type'      => 'stadion_todo',
        'posts_per_page' => -1,
        'post_status'    => 'any',
    ]);

    $migrated = 0;
    foreach ($todos as $todo) {
        // Check if already migrated
        $new_field = get_field('related_persons', $todo->ID);
        if ($new_field && is_array($new_field) && count($new_field) > 0) {
            continue; // Already has new format
        }

        // Get old single value
        $old_value = get_post_meta($todo->ID, 'related_person', true);
        if (!$old_value) {
            continue;
        }

        if (!$dry_run) {
            update_field('related_persons', [(int) $old_value], $todo->ID);
            delete_post_meta($todo->ID, 'related_person');
        }

        WP_CLI::log("Todo {$todo->ID}: person {$old_value} → [{$old_value}]");
        $migrated++;
    }

    $action = $dry_run ? 'Would migrate' : 'Migrated';
    WP_CLI::success("{$action} {$migrated} todos.");
}
```

### Task 5: Update Timeline Endpoint

**File:** `includes/class-comment-types.php` (get_timeline method)

Update the timeline endpoint to use new field and return persons array:
```php
// Around line 454-487
$person_ids = get_field('related_persons', $todo->ID) ?: [];
if (!is_array($person_ids)) {
    $person_ids = $person_ids ? [$person_ids] : [];
}

$persons = [];
foreach ($person_ids as $pid) {
    $persons[] = [
        'id' => (int) $pid,
        'name' => get_the_title($pid),
    ];
}

$timeline[] = [
    'id'             => $todo->ID,
    'type'           => 'todo',
    'content'        => $todo->post_title,
    'author_id'      => (int) $todo->post_author,
    'created'        => $todo->post_date,
    'person_id'      => (int) $person_id,  // Keep for current person context
    'person_name'    => get_the_title($person_id),
    'persons'        => $persons,  // All linked persons
    'status'         => $status_map[$todo->post_status] ?? 'open',
    'is_completed'   => $todo->post_status === 'stadion_completed',
    'due_date'       => get_field('due_date', $todo->ID) ?: null,
    'awaiting_since' => get_post_meta($todo->ID, 'awaiting_since', true) ?: null,
    'notes'          => get_field('notes', $todo->ID) ?: null,
];
```

## Verification

1. [ ] ACF field group loads correctly (check WordPress admin)
2. [ ] Existing todos still display (backward compatible)
3. [ ] New todos can be created with multiple persons via API
4. [ ] Migration command works correctly (`--dry-run` then actual)
5. [ ] Timeline endpoint returns `persons` array and `notes`
6. [ ] PHPUnit tests pass (update/add tests as needed)

## Files Modified

1. `acf-json/group_todo_fields.json` - Add notes field, change related_person to related_persons
2. `includes/class-rest-todos.php` - Update all methods for multi-person and notes
3. `includes/class-comment-types.php` - Update timeline endpoint
4. `includes/class-cli-commands.php` - Add migration command

## Notes

- Keep backward compatibility fields (`person_id`, `person_name`, `person_thumbnail`) during v3.3
- Frontend changes (Phase 33) will switch to using `persons` array
- Phase 34 will add cross-person display of shared todos
- Rich text notes will be sanitized with `wp_kses_post()` for XSS protection
