---
phase: 23-rest-api-data-model-tests
plan: 02
type: execute
depends_on: []
files_modified: [tests/Wpunit/SearchDashboardTest.php]
---

<objective>
Test custom REST endpoints: search, dashboard, reminders, and todos.

Purpose: Verify /stadion/v1/ custom endpoints return correct data and enforce access control.
Output: SearchDashboardTest.php with comprehensive endpoint tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-phpunit-setup/21-01-SUMMARY.md
@.planning/phases/22-access-control-tests/22-01-SUMMARY.md

@includes/class-rest-api.php
@includes/class-rest-base.php
@tests/Support/StadionTestCase.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test search endpoint</name>
  <files>tests/Wpunit/SearchDashboardTest.php</files>
  <action>
Create SearchDashboardTest extending StadionTestCase. Test /stadion/v1/search endpoint:

1. Test basic search:
   - Create approved user with several persons ("John Doe", "Jane Smith")
   - GET /stadion/v1/search?q=John
   - Assert returns John Doe person
   - Assert does NOT return Jane Smith

2. Test search isolation:
   - User A creates "John's Contact"
   - User B creates "John's Other Contact"
   - User A searches for "John"
   - Assert only User A's contact returned (access control)

3. Test search across CPTs:
   - Create person "Acme Employee"
   - Create team "Acme Corp"
   - Search "Acme"
   - Assert both returned (if search spans types)

4. Test search validation:
   - Search with empty query
   - Assert 400 error
   - Search with single character
   - Assert 400 error (min 2 chars)

5. Test unapproved user blocked:
   - Create unapproved user
   - Attempt search
   - Assert denied (permission callback returns false)

Use rest_do_request() with WP_REST_Request for internal REST calls.
  </action>
  <verify>vendor/bin/codecept run Wpunit SearchDashboardTest::test_search passes</verify>
  <done>Search endpoint returns correct results with proper access control</done>
</task>

<task type="auto">
  <name>Task 2: Test dashboard and reminders endpoints</name>
  <files>tests/Wpunit/SearchDashboardTest.php</files>
  <action>
Add tests for dashboard and reminder endpoints:

1. Test dashboard summary (/stadion/v1/dashboard):
   - Create user with 3 persons, 2 teams, 5 important dates
   - GET /stadion/v1/dashboard
   - Assert response includes counts (people_count, teams_count, dates_count)
   - Assert only user's own data counted
   - Test with new user (empty) - counts should be 0

2. Test dashboard isolation:
   - User A has 5 contacts
   - User B has 3 contacts
   - User A's dashboard shows 5
   - User B's dashboard shows 3

3. Test reminders endpoint (/stadion/v1/reminders):
   - Create important_date with date in next 7 days
   - GET /stadion/v1/reminders?days_ahead=30
   - Assert upcoming date included
   - Create date 60 days out
   - Assert NOT included with days_ahead=30

4. Test reminders validation:
   - GET /stadion/v1/reminders?days_ahead=0 (invalid)
   - Assert 400 error
   - GET /stadion/v1/reminders?days_ahead=500 (too large)
   - Assert 400 error

5. Test todos endpoint (/stadion/v1/todos):
   - Create person with notes containing uncompleted todos
   - GET /stadion/v1/todos
   - Assert todos returned
   - Test completed filter
  </action>
  <verify>vendor/bin/codecept run Wpunit SearchDashboardTest passes all tests</verify>
  <done>Dashboard, reminders, and todos endpoints work correctly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `vendor/bin/codecept run Wpunit SearchDashboardTest` passes all tests
- [ ] Search endpoint tested with isolation
- [ ] Dashboard counts correct per user
- [ ] Reminders filtered by days_ahead
- [ ] Unapproved users blocked from endpoints
</verification>

<success_criteria>

- All tests pass
- Search returns correct results with access control
- Dashboard provides accurate counts per user
- Reminders respect date filtering
- All endpoints enforce user approval
</success_criteria>

<output>
After completion, create `.planning/phases/23-rest-api-data-model-tests/23-02-SUMMARY.md`
</output>
