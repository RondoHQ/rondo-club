---
phase: 23-rest-api-data-model-tests
plan: 01
type: execute
depends_on: []
files_modified: [tests/Wpunit/CptCrudTest.php]
---

<objective>
Test WordPress REST API CRUD operations and ACF field handling for CPTs.

Purpose: Verify standard REST API endpoints work correctly for person, company, and important_date post types with proper access control and field handling.
Output: CptCrudTest.php with comprehensive CRUD and ACF tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-phpunit-setup/21-01-SUMMARY.md
@.planning/phases/22-access-control-tests/22-01-SUMMARY.md

@includes/class-post-types.php
@includes/class-rest-base.php
@tests/Support/CaelisTestCase.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test REST API CRUD for person CPT</name>
  <files>tests/Wpunit/CptCrudTest.php</files>
  <action>
Create CptCrudTest extending CaelisTestCase. Test WordPress standard REST API at /wp/v2/people:

1. Test CREATE person via POST:
   - Create approved user, authenticate via wp_set_current_user()
   - POST to /wp/v2/people with title
   - Assert 201 status
   - Assert post_author is current user
   - Assert response includes ID and title

2. Test READ person via GET:
   - Create person as user A
   - GET /wp/v2/people/{id} as user A
   - Assert 200 status, correct data returned
   - GET as user B (different user)
   - Assert access denied (403 or filtered out)

3. Test UPDATE person via PUT/PATCH:
   - Create person
   - PUT/PATCH with updated title
   - Assert 200 status, title updated
   - Attempt update as non-owner
   - Assert denied

4. Test DELETE person:
   - Create person
   - DELETE /wp/v2/people/{id}
   - Assert 200 or 410 status
   - Assert post trashed or deleted
   - Attempt delete as non-owner
   - Assert denied

Use rest_do_request() with WP_REST_Request to make internal REST calls. Apply unique test IDs pattern from Phase 22-03.
  </action>
  <verify>vendor/bin/codecept run Wpunit CptCrudTest::test_person passes</verify>
  <done>Person CRUD operations work correctly with access control</done>
</task>

<task type="auto">
  <name>Task 2: Test CRUD for company and important_date CPTs</name>
  <files>tests/Wpunit/CptCrudTest.php</files>
  <action>
Extend CptCrudTest with company and important_date CRUD tests:

1. Test company CRUD at /wp/v2/companies:
   - CREATE: POST with title, verify 201
   - READ: GET as owner (200) vs non-owner (denied)
   - UPDATE: PATCH title, verify change
   - DELETE: DELETE, verify trashed

2. Test important_date CRUD at /wp/v2/important-dates:
   - CREATE: POST with title and person link
   - READ: GET as owner vs non-owner
   - UPDATE: PATCH date fields
   - DELETE: DELETE, verify trashed

3. Test ACF fields in REST responses:
   - Create person with ACF fields (first_name, last_name, email)
   - GET person via REST
   - Assert ACF fields included in response under 'acf' key
   - Create company with ACF fields (website, industry)
   - GET company, verify ACF fields
   - Create important_date with date field
   - GET date, verify ACF fields

4. Test ACF field updates via REST:
   - PATCH person with acf.email update
   - GET and verify field updated
   - Test for all CPTs
  </action>
  <verify>vendor/bin/codecept run Wpunit CptCrudTest passes all tests</verify>
  <done>All CPT CRUD operations and ACF field handling verified</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `vendor/bin/codecept run Wpunit CptCrudTest` passes all tests
- [ ] Person CRUD tested (create/read/update/delete)
- [ ] Company CRUD tested
- [ ] Important Date CRUD tested
- [ ] ACF fields appear in REST responses
- [ ] Access control enforced for all operations
</verification>

<success_criteria>

- All tests pass
- Three CPT CRUD operations fully tested
- ACF field handling verified
- Access control integration confirmed
</success_criteria>

<output>
After completion, create `.planning/phases/23-rest-api-data-model-tests/23-01-SUMMARY.md`
</output>
