---
phase: 23-rest-api-data-model-tests
plan: 03
type: execute
depends_on: []
files_modified: [tests/Wpunit/RelationshipsSharesTest.php]
---

<objective>
Test CPT relationships, sharing endpoints, and bulk update operations.

Purpose: Verify person-team relationships, sharing functionality, and bulk operations work correctly via REST API.
Output: RelationshipsSharesTest.php with comprehensive relationship and sharing tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-phpunit-setup/21-01-SUMMARY.md
@.planning/phases/22-access-control-tests/22-02-SUMMARY.md

@includes/class-rest-people.php
@includes/class-rest-teams.php
@includes/class-rest-base.php
@tests/Support/StadionTestCase.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test CPT relationships via REST</name>
  <files>tests/Wpunit/RelationshipsSharesTest.php</files>
  <action>
Create RelationshipsSharesTest extending StadionTestCase. Test relationship endpoints:

1. Test person-team relationship:
   - Create team "Acme Corp"
   - Create person with team_id = team ID (via ACF)
   - GET /stadion/v1/teams/{id}/people
   - Assert person appears in team's people list

2. Test person-dates relationship:
   - Create person
   - Create important_date linked to person (via ACF person field)
   - GET /stadion/v1/people/{id}/dates
   - Assert date appears in person's dates list

3. Test relationship data expansion:
   - Create person with work_history (array of team references)
   - GET /wp/v2/people/{id}
   - Assert work_history expanded with team details (not just IDs)
   - This tests the rest_prepare_person filter

4. Test computed fields:
   - Create person with is_deceased ACF field = true
   - GET person via REST
   - Assert is_deceased computed field in response

Use rest_do_request() pattern. Apply unique test ID pattern for user isolation.
  </action>
  <verify>vendor/bin/codecept run Wpunit RelationshipsSharesTest::test_relationships passes</verify>
  <done>CPT relationships correctly exposed via REST endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Test sharing and bulk update endpoints</name>
  <files>tests/Wpunit/RelationshipsSharesTest.php</files>
  <action>
Add tests for sharing and bulk operations:

1. Test sharing endpoints for people (/stadion/v1/people/{id}/shares):
   - Create person as User A
   - POST share with User B (view permission)
   - GET shares, assert User B in list
   - DELETE share
   - GET shares, assert User B removed

2. Test share permission levels:
   - Share with 'view' permission
   - Assert permission returned correctly
   - Share with 'edit' permission
   - Assert permission updated

3. Test sharing for teams:
   - Same tests as people at /stadion/v1/teams/{id}/shares

4. Test bulk update for people (/stadion/v1/people/bulk-update):
   - Create 3 persons
   - POST bulk-update with ids and visibility change
   - Assert all 3 updated
   - Test with workspace assignment
   - Test with label add/remove

5. Test bulk update authorization:
   - User A creates persons
   - User B attempts bulk-update on User A's persons
   - Assert denied (ownership check)

6. Test bulk update for teams:
   - Similar tests at /stadion/v1/teams/bulk-update
  </action>
  <verify>vendor/bin/codecept run Wpunit RelationshipsSharesTest passes all tests</verify>
  <done>Sharing and bulk update endpoints verified with access control</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `vendor/bin/codecept run Wpunit RelationshipsSharesTest` passes all tests
- [ ] Person-team relationship endpoint works
- [ ] Person-dates relationship endpoint works
- [ ] Sharing add/remove works for people and teams
- [ ] Bulk update respects ownership
- [ ] Phase 23 complete (all REST API tests written)
</verification>

<success_criteria>

- All tests pass
- CPT relationships verified via REST
- Sharing endpoints work correctly
- Bulk operations enforce ownership
- Phase 23 complete (milestone v3.0 testing infrastructure done)
</success_criteria>

<output>
After completion, create `.planning/phases/23-rest-api-data-model-tests/23-03-SUMMARY.md`
</output>
