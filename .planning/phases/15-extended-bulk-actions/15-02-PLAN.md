---
phase: 15-extended-bulk-actions
plan: 02
type: execute
depends_on: ["15-01"]
files_modified: [src/pages/People/PeopleList.jsx, src/api/client.js]
---

<objective>
Add bulk organization and bulk label modals to the People list view.

Purpose: Enable users to assign organizations and manage labels for multiple people at once from the list view.
Output: Two new modals (BulkOrganizationModal, BulkLabelsModal) integrated into the Actions dropdown.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-extended-bulk-actions/15-01-SUMMARY.md

**Key files:**
@src/pages/People/PeopleList.jsx — Contains BulkVisibilityModal and BulkWorkspaceModal patterns (lines 241-440)
@src/hooks/usePeople.js — useBulkUpdatePeople hook (lines 253-265)
@src/api/client.js — bulkUpdatePeople API call (line 96)

**Established patterns from Phase 13-02:**
- Modals defined inline in PeopleList.jsx
- Modal state managed via useState (showBulk*Modal)
- Click-outside handler for dropdown
- Use refetchQueries for immediate UI refresh after bulk operations
- Modal clears selection and closes on success
- bulkUpdateMutation.mutateAsync handles the API call

**Lucide icons available:**
Building2 for organizations, Tag or Tags for labels
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BulkOrganizationModal component</name>
  <files>src/pages/People/PeopleList.jsx</files>
  <action>
Add a new inline modal component following the BulkWorkspaceModal pattern:

```jsx
// Bulk Organization Modal Component
function BulkOrganizationModal({ isOpen, onClose, selectedCount, companies, onSubmit, isLoading }) {
  const [selectedCompanyId, setSelectedCompanyId] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');

  // Reset when modal opens
  useEffect(() => {
    if (isOpen) {
      setSelectedCompanyId(null);
      setSearchQuery('');
    }
  }, [isOpen]);

  if (!isOpen) return null;

  // Filter companies by search query
  const filteredCompanies = companies.filter(company =>
    company.name.toLowerCase().includes(searchQuery.toLowerCase())
  );

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
      <div className="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div className="flex items-center justify-between p-4 border-b">
          <h2 className="text-lg font-semibold">Set Organization</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-600" disabled={isLoading}>
            <X className="w-5 h-5" />
          </button>
        </div>

        <div className="p-4 space-y-4">
          <p className="text-sm text-gray-600">
            Set current organization for {selectedCount} {selectedCount === 1 ? 'person' : 'people'}:
          </p>

          {/* Search input */}
          <input
            type="text"
            placeholder="Search organizations..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500"
          />

          {/* Option to clear organization */}
          <button
            type="button"
            onClick={() => setSelectedCompanyId('clear')}
            disabled={isLoading}
            className={`w-full flex items-center gap-3 p-3 rounded-lg border-2 text-left transition-colors ${
              selectedCompanyId === 'clear'
                ? 'border-primary-500 bg-primary-50'
                : 'border-gray-200 hover:border-gray-300'
            }`}
          >
            <X className={`w-5 h-5 ${selectedCompanyId === 'clear' ? 'text-primary-600' : 'text-gray-400'}`} />
            <div className="flex-1">
              <div className="text-sm font-medium text-gray-900">Clear organization</div>
              <div className="text-xs text-gray-500">Remove current organization from selected people</div>
            </div>
            {selectedCompanyId === 'clear' && <Check className="w-5 h-5 text-primary-600" />}
          </button>

          {/* Company list */}
          <div className="space-y-2 max-h-64 overflow-y-auto">
            {filteredCompanies.length === 0 ? (
              <p className="text-sm text-gray-500 text-center py-4">
                {searchQuery ? 'No organizations match your search' : 'No organizations found'}
              </p>
            ) : (
              filteredCompanies.map((company) => {
                const isSelected = selectedCompanyId === company.id;
                return (
                  <button
                    key={company.id}
                    type="button"
                    onClick={() => setSelectedCompanyId(company.id)}
                    disabled={isLoading}
                    className={`w-full flex items-center gap-3 p-3 rounded-lg border-2 text-left transition-colors ${
                      isSelected
                        ? 'border-primary-500 bg-primary-50'
                        : 'border-gray-200 hover:border-gray-300'
                    }`}
                  >
                    <Building2 className={`w-5 h-5 ${isSelected ? 'text-primary-600' : 'text-gray-400'}`} />
                    <div className="flex-1">
                      <div className="text-sm font-medium text-gray-900">{company.name}</div>
                    </div>
                    {isSelected && <Check className="w-5 h-5 text-primary-600" />}
                  </button>
                );
              })
            )}
          </div>
        </div>

        <div className="flex justify-end gap-2 p-4 border-t bg-gray-50">
          <button type="button" onClick={onClose} className="btn-secondary" disabled={isLoading}>
            Cancel
          </button>
          <button
            type="button"
            onClick={() => onSubmit(selectedCompanyId === 'clear' ? null : selectedCompanyId)}
            className="btn-primary"
            disabled={isLoading || selectedCompanyId === null}
          >
            {isLoading ? 'Applying...' : `Apply to ${selectedCount} ${selectedCount === 1 ? 'person' : 'people'}`}
          </button>
        </div>
      </div>
    </div>
  );
}
```

Also:
1. Add `Building2` to the Lucide imports at the top
2. Add state: `const [showBulkOrganizationModal, setShowBulkOrganizationModal] = useState(false);`
3. Fetch companies for the modal (can reuse companiesData or add separate query)
4. Add the modal to the JSX near BulkWorkspaceModal
5. Add menu item in Actions dropdown (after "Assign to workspace...")
6. Wire up the submit handler to call bulkUpdateMutation with `{ organization_id: selectedCompanyId }`

Avoid: Creating a separate component file - keep inline per established pattern.
  </action>
  <verify>Modal appears when clicking "Set organization..." in Actions dropdown, lists available organizations with search</verify>
  <done>BulkOrganizationModal functional with search, clear option, and organization selection</done>
</task>

<task type="auto">
  <name>Task 2: Create BulkLabelsModal component</name>
  <files>src/pages/People/PeopleList.jsx</files>
  <action>
Add a new inline modal component for bulk label management:

```jsx
// Bulk Labels Modal Component
function BulkLabelsModal({ isOpen, onClose, selectedCount, labels, onSubmit, isLoading }) {
  const [mode, setMode] = useState('add'); // 'add' or 'remove'
  const [selectedLabelIds, setSelectedLabelIds] = useState([]);

  // Reset when modal opens
  useEffect(() => {
    if (isOpen) {
      setMode('add');
      setSelectedLabelIds([]);
    }
  }, [isOpen]);

  if (!isOpen) return null;

  const handleLabelToggle = (labelId) => {
    setSelectedLabelIds(prev =>
      prev.includes(labelId)
        ? prev.filter(id => id !== labelId)
        : [...prev, labelId]
    );
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
      <div className="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div className="flex items-center justify-between p-4 border-b">
          <h2 className="text-lg font-semibold">Manage Labels</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-600" disabled={isLoading}>
            <X className="w-5 h-5" />
          </button>
        </div>

        <div className="p-4 space-y-4">
          <p className="text-sm text-gray-600">
            {mode === 'add' ? 'Add' : 'Remove'} labels for {selectedCount} {selectedCount === 1 ? 'person' : 'people'}:
          </p>

          {/* Mode toggle */}
          <div className="flex rounded-lg border border-gray-200 p-1">
            <button
              type="button"
              onClick={() => { setMode('add'); setSelectedLabelIds([]); }}
              className={`flex-1 px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${
                mode === 'add' ? 'bg-primary-100 text-primary-700' : 'text-gray-600 hover:bg-gray-50'
              }`}
            >
              Add Labels
            </button>
            <button
              type="button"
              onClick={() => { setMode('remove'); setSelectedLabelIds([]); }}
              className={`flex-1 px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${
                mode === 'remove' ? 'bg-red-100 text-red-700' : 'text-gray-600 hover:bg-gray-50'
              }`}
            >
              Remove Labels
            </button>
          </div>

          {/* Label list */}
          {labels.length === 0 ? (
            <div className="text-center py-6 text-gray-500">
              <Tag className="w-8 h-8 mx-auto mb-2 text-gray-400" />
              <p className="text-sm">No labels available.</p>
              <p className="text-xs">Create labels first to use this feature.</p>
            </div>
          ) : (
            <div className="space-y-2 max-h-64 overflow-y-auto">
              {labels.map((label) => {
                const isChecked = selectedLabelIds.includes(label.id);
                return (
                  <button
                    key={label.id}
                    type="button"
                    onClick={() => handleLabelToggle(label.id)}
                    disabled={isLoading}
                    className={`w-full flex items-center gap-3 p-3 rounded-lg border-2 text-left transition-colors ${
                      isChecked
                        ? mode === 'add' ? 'border-primary-500 bg-primary-50' : 'border-red-500 bg-red-50'
                        : 'border-gray-200 hover:border-gray-300'
                    }`}
                  >
                    <div className={`flex items-center justify-center w-5 h-5 border-2 rounded ${
                      isChecked
                        ? mode === 'add' ? 'bg-primary-600 border-primary-600' : 'bg-red-600 border-red-600'
                        : 'border-gray-300'
                    }`}>
                      {isChecked && <Check className="w-3 h-3 text-white" />}
                    </div>
                    <span className="text-sm font-medium text-gray-900">{label.name}</span>
                  </button>
                );
              })}
            </div>
          )}
        </div>

        <div className="flex justify-end gap-2 p-4 border-t bg-gray-50">
          <button type="button" onClick={onClose} className="btn-secondary" disabled={isLoading}>
            Cancel
          </button>
          <button
            type="button"
            onClick={() => onSubmit(mode, selectedLabelIds)}
            className={mode === 'add' ? 'btn-primary' : 'bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 disabled:opacity-50'}
            disabled={isLoading || selectedLabelIds.length === 0}
          >
            {isLoading
              ? (mode === 'add' ? 'Adding...' : 'Removing...')
              : `${mode === 'add' ? 'Add' : 'Remove'} ${selectedLabelIds.length} ${selectedLabelIds.length === 1 ? 'label' : 'labels'}`
            }
          </button>
        </div>
      </div>
    </div>
  );
}
```

Also:
1. Add `Tag` to Lucide imports
2. Add state: `const [showBulkLabelsModal, setShowBulkLabelsModal] = useState(false);`
3. Need labels with IDs - modify the existing labelsData query or transform data to include term IDs
4. Add menu item in Actions dropdown (after "Set organization...")
5. Wire up submit handler:
   ```jsx
   onSubmit={async (mode, labelIds) => {
     setBulkActionLoading(true);
     try {
       const updates = mode === 'add'
         ? { labels_add: labelIds }
         : { labels_remove: labelIds };
       await bulkUpdateMutation.mutateAsync({
         ids: Array.from(selectedIds),
         updates
       });
       clearSelection();
       setShowBulkLabelsModal(false);
     } finally {
       setBulkActionLoading(false);
     }
   }}
   ```

For labels data, modify the useQuery to return full term objects:
```jsx
const { data: labelsData } = useQuery({
  queryKey: ['person-labels'],
  queryFn: async () => {
    const response = await wpApi.getPersonLabels();
    return response.data;
  },
});

// Labels with IDs for the modal
const availableLabelsWithIds = labelsData || [];
// Keep availableLabels for filters (name-only)
const availableLabels = labelsData?.map(label => label.name) || [];
```

Avoid: Breaking the existing label filter which uses label names (not IDs).
  </action>
  <verify>Modal appears with add/remove toggle, shows available labels, submits correct action type</verify>
  <done>BulkLabelsModal functional with add/remove mode toggle and multi-select labels</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Bulk organization and label management modals in list view</what-built>
  <how-to-verify>
    1. Run: npm run dev (or access production at https://cael.is/)
    2. Navigate to People page, switch to list view
    3. Select 2-3 people using checkboxes
    4. Click "Actions" dropdown in selection toolbar
    5. Verify new menu items: "Set organization..." and "Manage labels..."
    6. Test Set Organization:
       - Click "Set organization..."
       - Search for an organization
       - Select one and click Apply
       - Verify Organization column updates for selected people
    7. Test Clear Organization:
       - Select people with organizations
       - Click "Set organization...", choose "Clear organization"
       - Verify Organization column shows "-" after apply
    8. Test Add Labels:
       - Select people, click "Manage labels..."
       - Ensure "Add Labels" is selected
       - Select 1-2 labels, click Add
       - Verify Labels column updates
    9. Test Remove Labels:
       - Select people with labels
       - Click "Manage labels...", switch to "Remove Labels"
       - Select labels to remove, click Remove
       - Verify Labels column updates
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Both modals open and close correctly
- [ ] Organization assignment updates list view
- [ ] Label add/remove updates list view
- [ ] Selection clears after successful bulk operation
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript/JavaScript errors
- Both modals integrate with existing bulk actions dropdown
- UI refreshes immediately after bulk operations
- Phase 15 complete - ISS-003 resolved
</success_criteria>

<output>
After completion, create `.planning/phases/15-extended-bulk-actions/15-02-SUMMARY.md`
</output>
