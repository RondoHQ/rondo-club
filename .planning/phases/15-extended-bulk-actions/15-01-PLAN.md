---
phase: 15-extended-bulk-actions
plan: 01
type: execute
depends_on: []
files_modified: [includes/class-rest-people.php]
---

<objective>
Extend the bulk-update REST endpoint to support organization and label operations.

Purpose: Enable backend support for assigning people to organizations and managing labels in bulk.
Output: Extended `/prm/v1/people/bulk-update` endpoint accepting organization_id, labels_add, and labels_remove parameters.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key files:**
@includes/class-rest-people.php — Current bulk-update endpoint (lines 101-156 for registration, 632-689 for implementation)
@includes/class-taxonomies.php — person_label taxonomy (lines 126-153)

**Prior context:**
- Phase 13-01 created the bulk-update endpoint with visibility and assigned_workspaces support
- Labels use the `person_label` taxonomy (non-hierarchical, shown in REST via show_in_rest: true)
- Organization assignment stores company ID in work_history ACF repeater field with is_current=true

**Issue being addressed:** ISS-003 (bulk edit for Organizations and Labels)

**Established patterns:**
- Bulk endpoint validates all IDs first via check_bulk_update_permission
- Updates are atomic per person with try/catch blocks
- Returns { success, updated, failed } response
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend bulk-update endpoint validation to accept organization_id, labels_add, labels_remove</name>
  <files>includes/class-rest-people.php</files>
  <action>
Modify the `register_routes()` method's bulk-update endpoint args:

1. Update the `updates` validation callback to also accept:
   - `organization_id` (integer or null, null means "clear organization")
   - `labels_add` (array of term IDs to add)
   - `labels_remove` (array of term IDs to remove)

2. The validation should:
   - Check `organization_id` is numeric if provided (or null)
   - Validate organization exists as a published 'company' post if not null
   - Check `labels_add` is array of numeric IDs if provided
   - Check `labels_remove` is array of numeric IDs if provided
   - Require at least ONE of: visibility, assigned_workspaces, organization_id, labels_add, labels_remove

Avoid: Adding validation for label term existence in registration - defer to implementation for efficiency (batch check).
  </action>
  <verify>The endpoint registration accepts the new parameters without PHP errors</verify>
  <done>Validation accepts organization_id (int|null), labels_add (array), labels_remove (array) in updates parameter</done>
</task>

<task type="auto">
  <name>Task 2: Implement organization and label updates in bulk_update_people method</name>
  <files>includes/class-rest-people.php</files>
  <action>
Extend `bulk_update_people()` method to handle the new update types:

**Organization assignment (if organization_id provided):**
```php
if (array_key_exists('organization_id', $updates)) {
    $org_id = $updates['organization_id'];

    // Get current work_history
    $work_history = get_field('work_history', $post_id) ?: [];

    if ($org_id === null) {
        // Clear current organization: set is_current=false on all entries
        foreach ($work_history as &$job) {
            $job['is_current'] = false;
        }
    } else {
        // Check if company already exists in work history
        $found = false;
        foreach ($work_history as &$job) {
            $job['is_current'] = ($job['company'] == $org_id);
            if ($job['company'] == $org_id) {
                $found = true;
            }
        }

        // If company not in history, add new entry
        if (!$found) {
            $work_history[] = [
                'company' => $org_id,
                'title' => '',
                'start_date' => '',
                'end_date' => '',
                'is_current' => true,
            ];
        }
    }

    update_field('work_history', $work_history, $post_id);
}
```

**Labels add (if labels_add provided):**
```php
if (!empty($updates['labels_add'])) {
    $term_ids = array_map('intval', $updates['labels_add']);
    // Append terms (don't replace existing)
    wp_set_object_terms($post_id, $term_ids, 'person_label', true);
}
```

**Labels remove (if labels_remove provided):**
```php
if (!empty($updates['labels_remove'])) {
    $term_ids = array_map('intval', $updates['labels_remove']);
    wp_remove_object_terms($post_id, $term_ids, 'person_label');
}
```

Avoid: Using wp_set_object_terms with append=false for labels_add (would clear existing labels).
  </action>
  <verify>
Test via curl:
```bash
# Test label add (substitute real IDs)
curl -X POST "http://localhost/wp-json/prm/v1/people/bulk-update" \
  -H "Content-Type: application/json" \
  -H "X-WP-Nonce: [nonce]" \
  -d '{"ids":[123],"updates":{"labels_add":[1,2]}}'
```
  </verify>
  <done>
- organization_id updates work_history ACF field, setting is_current flag
- labels_add appends terms to person_label taxonomy
- labels_remove removes terms from person_label taxonomy
- Existing visibility and workspace functionality unchanged
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] No PHP errors on plugin activation
- [ ] Existing bulk visibility change still works
- [ ] Existing bulk workspace assignment still works
- [ ] PHP code passes basic syntax check
</verification>

<success_criteria>

- Bulk-update endpoint accepts organization_id, labels_add, labels_remove
- Organization assignment creates/updates work_history entries with is_current flag
- Labels can be added to people in bulk (appending, not replacing)
- Labels can be removed from people in bulk
- No regressions in existing bulk update functionality
</success_criteria>

<output>
After completion, create `.planning/phases/15-extended-bulk-actions/15-01-SUMMARY.md`
</output>
