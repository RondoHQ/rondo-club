---
phase: 108-offline-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useOnlineStatus.js
  - src/main.jsx
  - vite.config.js
  - public/offline.html
autonomous: true

must_haves:
  truths:
    - "Navigator.onLine state is accessible via React hook"
    - "TanStack Query pauses queries when browser goes offline"
    - "Service worker serves offline.html for uncached navigation routes"
  artifacts:
    - path: "src/hooks/useOnlineStatus.js"
      provides: "Online/offline detection hook"
      exports: ["useOnlineStatus"]
    - path: "public/offline.html"
      provides: "Static fallback page for offline navigation"
      contains: "Je bent offline"
  key_links:
    - from: "src/main.jsx"
      to: "@tanstack/react-query onlineManager"
      via: "setEventListener"
      pattern: "onlineManager\\.setEventListener"
    - from: "vite.config.js"
      to: "public/offline.html"
      via: "navigateFallback"
      pattern: "navigateFallback.*offline\\.html"
---

<objective>
Create the core offline infrastructure: useOnlineStatus hook for React components, TanStack Query integration for automatic query pausing, and Workbox configuration for offline fallback page.

Purpose: Establish the foundation for offline support that all other Phase 108 features build upon
Output: Hook for detecting network status, Query library integration, and static fallback page
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/108-offline-support/108-CONTEXT.md
@.planning/phases/108-offline-support/108-RESEARCH.md

# Key files to reference
@src/main.jsx
@vite.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useOnlineStatus hook</name>
  <files>src/hooks/useOnlineStatus.js</files>
  <action>
Create a new hook that tracks browser online/offline state using navigator.onLine and window events.

Implementation:
1. Initialize state from navigator.onLine (with SSR fallback returning true)
2. Use useEffect to add 'online' and 'offline' event listeners on window
3. Return boolean isOnline state
4. Clean up listeners on unmount

Pattern from RESEARCH.md:
```javascript
import { useState, useEffect } from 'react';

export function useOnlineStatus() {
  const [isOnline, setIsOnline] = useState(() => {
    if (typeof navigator === 'undefined' || typeof window === 'undefined') {
      return true;
    }
    return navigator.onLine;
  });

  useEffect(() => {
    if (typeof window === 'undefined') return;

    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  return isOnline;
}
```

Do NOT add console.log statements (production code per AGENTS.md Rule 5).
  </action>
  <verify>
File exists with correct export:
- `grep -q "export function useOnlineStatus" src/hooks/useOnlineStatus.js`
- `npm run lint` passes for this file
  </verify>
  <done>useOnlineStatus hook exists and exports a function that returns boolean online state</done>
</task>

<task type="auto">
  <name>Task 2: Configure TanStack Query onlineManager</name>
  <files>src/main.jsx</files>
  <action>
Add onlineManager configuration to main.jsx so TanStack Query respects browser online/offline state.

Implementation:
1. Import onlineManager from '@tanstack/react-query'
2. Call onlineManager.setEventListener BEFORE QueryClient initialization
3. Register online/offline event listeners that call setOnline(true/false)
4. Return cleanup function from the event listener

Add this code BEFORE the queryClient declaration:

```javascript
import { QueryClient, QueryClientProvider, onlineManager } from '@tanstack/react-query';

// Configure TanStack Query to use browser online/offline events
onlineManager.setEventListener((setOnline) => {
  const handleOnline = () => setOnline(true);
  const handleOffline = () => setOnline(false);

  window.addEventListener('online', handleOnline);
  window.addEventListener('offline', handleOffline);

  return () => {
    window.removeEventListener('online', handleOnline);
    window.removeEventListener('offline', handleOffline);
  };
});
```

Note: The existing QueryClient config with networkMode defaults to 'online' which is correct - queries will automatically pause when offline.
  </action>
  <verify>
- `grep -q "onlineManager" src/main.jsx`
- `grep -q "setEventListener" src/main.jsx`
- `npm run lint` passes
  </verify>
  <done>TanStack Query onlineManager configured to use browser online/offline events</done>
</task>

<task type="auto">
  <name>Task 3: Configure Workbox offline fallback and create offline.html</name>
  <files>vite.config.js, public/offline.html</files>
  <action>
Part A - Update vite.config.js workbox configuration:

Add to the existing workbox config object:
```javascript
// Offline fallback page
navigateFallback: '/offline.html',
navigateFallbackDenylist: [
  /^\/wp-json\//,   // Don't use offline page for API requests
  /^\/wp-admin\//,  // Don't use offline page for admin
  /^\/wp-login/,    // Don't use offline page for login
],
```

Also add offline.html to includeAssets if not present:
```javascript
includeAssets: ['offline.html', 'icons/**/*'],
```

Part B - Create public/offline.html:

Static HTML page with:
- Dutch language (lang="nl")
- Title: "Offline - Stadion"
- Centered layout with flexbox
- Large wifi-off SVG icon (inline, from lucide-react)
- Heading: "Je bent offline"
- Message: "We kunnen deze pagina nu niet laden. Controleer je internetverbinding en probeer het opnieuw."
- Two buttons: "Opnieuw proberen" (onclick reload) and "Ga terug" (onclick history.back)
- Primary button uses Stadion accent color (#f97316 orange)
- No external dependencies (works fully offline)
- Dark mode support with prefers-color-scheme media query

Use the exact HTML from RESEARCH.md Pattern 5, but add dark mode support:
- Dark mode: background #111827, text #f9fafb, secondary text #9ca3af
- Light mode: background #f9fafb, text #111827, secondary text #6b7280
  </action>
  <verify>
- `grep -q "navigateFallback" vite.config.js`
- `ls public/offline.html` shows file exists
- File contains "Je bent offline"
- `npm run build` completes without errors
- `ls dist/offline.html` shows file is included in build output
  </verify>
  <done>Workbox configured to serve offline.html for uncached navigation, offline.html exists with Dutch copy and dark mode support</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run lint` passes
2. `npm run build` succeeds
3. `ls dist/offline.html` shows fallback page in build
4. `grep "navigateFallback" vite.config.js` confirms config
5. `grep "onlineManager" src/main.jsx` confirms Query integration
6. Hook exports correctly: `grep "export function useOnlineStatus" src/hooks/useOnlineStatus.js`
</verification>

<success_criteria>
- useOnlineStatus hook created and exported
- TanStack Query onlineManager configured in main.jsx
- Workbox navigateFallback set to /offline.html with appropriate denylist
- public/offline.html exists with Dutch copy, wifi-off icon, Retry/Go back buttons
- offline.html appears in dist/ after build
- All lint checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/108-offline-support/108-01-SUMMARY.md`
</output>
