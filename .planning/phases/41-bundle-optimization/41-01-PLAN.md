---
phase: 41-bundle-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/components/layout/Layout.jsx, vite.config.js]
autonomous: true
---

<objective>
Reduce initial bundle size by lazy loading modals in Layout.jsx

Purpose: The main bundle has grown from 87 KB (v2.5) to 460 KB due to modals imported statically in Layout.jsx. GlobalTodoModal imports RichTextEditor (TipTap ~370 KB), which gets pulled into the main bundle.

Output: Main bundle reduced back to ~100 KB, initial load under 500 KB target
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior bundle optimization work
@.planning/phases/20-bundle-optimization/20-03-SUMMARY.md

# Current files to modify
@src/components/layout/Layout.jsx
@vite.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Lazy load modals in Layout.jsx</name>
  <files>src/components/layout/Layout.jsx</files>
  <action>
Convert the four modal imports to lazy imports with Suspense:

1. Replace static imports:
```javascript
import GlobalTodoModal from '@/components/Timeline/GlobalTodoModal';
import PersonEditModal from '@/components/PersonEditModal';
import CompanyEditModal from '@/components/CompanyEditModal';
import ImportantDateModal from '@/components/ImportantDateModal';
```

With lazy imports:
```javascript
const GlobalTodoModal = lazy(() => import('@/components/Timeline/GlobalTodoModal'));
const PersonEditModal = lazy(() => import('@/components/PersonEditModal'));
const CompanyEditModal = lazy(() => import('@/components/CompanyEditModal'));
const ImportantDateModal = lazy(() => import('@/components/ImportantDateModal'));
```

2. Add `lazy` to the React import at the top (already has `useState, useRef, useEffect`)

3. Wrap each modal usage in Suspense with a simple null fallback (modals don't need loading spinners since they overlay content):

```jsx
<Suspense fallback={null}>
  <GlobalTodoModal isOpen={showTodoModal} onClose={() => setShowTodoModal(false)} />
</Suspense>

<Suspense fallback={null}>
  <PersonEditModal ... />
</Suspense>
```

Note: Do NOT change the modal component files themselves - they work correctly. Only change how Layout imports and renders them.
  </action>
  <verify>npm run build - verify main bundle is significantly smaller (~100 KB)</verify>
  <done>Main bundle reduced from 460 KB to under 150 KB</done>
</task>

<task type="auto">
  <name>Task 2: Verify bundle sizes and update version</name>
  <files>package.json, style.css, CHANGELOG.md</files>
  <action>
1. Run `npm run build` and capture the output
2. Document the before/after comparison:
   - Before: main-*.js 460.83 KB (138.95 KB gzipped)
   - After: main-*.js should be ~100-150 KB

3. Update version in package.json and style.css to 3.6.0

4. Add CHANGELOG.md entry under 3.6.0:
   - Under "Changed": Document the bundle size reduction
   - Format: "Reduced initial bundle from 460 KB to X KB via modal lazy loading"
  </action>
  <verify>npm run build shows no chunks over 500 KB (TreeVisualization warning is acceptable)</verify>
  <done>Version bumped, changelog updated, bundle sizes documented</done>
</task>

<task type="auto">
  <name>Task 3: Test modals still work correctly</name>
  <files>-</files>
  <action>
Verify that lazy loading doesn't break modal functionality:

1. Run npm run dev
2. Test each modal can open and close:
   - Click + button in header, select "New Person" - PersonEditModal should open
   - Click + button, select "New Organization" - CompanyEditModal should open
   - Click + button, select "New Todo" - GlobalTodoModal should open
   - Click + button, select "New Date" - ImportantDateModal should open
3. Verify the search modal (Cmd+K) still works (not affected by changes)
4. Check browser console for any errors

If any modal fails to open, the Suspense/lazy setup is incorrect.
  </action>
  <verify>npm run dev - all four modals open correctly with no console errors</verify>
  <done>All modals (Person, Company, Todo, Date) open and close correctly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` produces main bundle under 150 KB
- [ ] No new build warnings (existing TreeVisualization warning is acceptable)
- [ ] `npm run lint` passes with no errors
- [ ] All four quick-add modals work correctly
- [ ] Search modal (Cmd+K) works correctly
</verification>

<success_criteria>

- Main bundle reduced from 460 KB to under 150 KB
- Initial load size back to ~435 KB target (vs current ~767 KB total)
- All modals function correctly with lazy loading
- Version bumped to 3.6.0
- CHANGELOG.md updated with bundle optimization entry
</success_criteria>

<output>
After completion, create `.planning/phases/41-bundle-optimization/41-01-SUMMARY.md`
</output>
