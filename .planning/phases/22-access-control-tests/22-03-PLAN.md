---
phase: 22-access-control-tests
plan: 03
type: execute
depends_on: []
files_modified: [tests/Wpunit/WorkspacePermissionsTest.php]
---

<objective>
Test workspace membership management and user approval blocking.

Purpose: Verify workspace role-based permissions resolve correctly and unapproved users are blocked from all access.
Output: WorkspacePermissionsTest.php with comprehensive tests for permissions and approval.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-phpunit-setup/21-01-SUMMARY.md

@includes/class-access-control.php
@includes/class-workspace-members.php
@includes/class-user-roles.php
@tests/Support/StadionTestCase.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test workspace membership and permissions</name>
  <files>tests/Wpunit/WorkspacePermissionsTest.php</files>
  <action>
Create WorkspacePermissionsTest extending StadionTestCase. Test RONDO_Workspace_Members:

1. Test membership add/remove:
   - Create workspace and users
   - Add user as member: RONDO_Workspace_Members::add($workspace_id, $user_id, 'member')
   - Verify is_member() returns true
   - Remove user: RONDO_Workspace_Members::remove()
   - Verify is_member() returns false

2. Test role assignment:
   - Add user with 'admin' role, verify get_user_role() returns 'admin'
   - Add user with 'member' role, verify get_user_role() returns 'member'
   - Add user with 'viewer' role, verify get_user_role() returns 'viewer'
   - Test update_role() changes role correctly

3. Test role-based permissions:
   - is_admin() returns true only for admin role
   - can_edit() returns true for admin and member, false for viewer

4. Test get_user_permission() on RONDO_Access_Control:
   - Author gets 'owner'
   - Workspace admin gets 'admin'
   - Workspace member gets 'member'
   - Workspace viewer gets 'viewer'
   - Direct share 'edit' returns 'edit'
   - Direct share 'view' returns 'view'
   - No access returns false

5. Test owner protection:
   - Workspace owner cannot be removed (remove() returns false)
   - Owner is auto-added as admin on workspace creation
  </action>
  <verify>vendor/bin/codecept run Wpunit WorkspacePermissionsTest::test_workspace_membership passes</verify>
  <done>Workspace membership CRUD and role-based permissions verified</done>
</task>

<task type="auto">
  <name>Task 2: Test user approval blocking</name>
  <files>tests/Wpunit/WorkspacePermissionsTest.php</files>
  <action>
Add tests for user approval blocking via RONDO_User_Roles:

1. Test approval status:
   - Create Stadion user (default unapproved)
   - Verify RONDO_User_Roles::is_user_approved() returns false
   - Approve via update_user_meta($user_id, 'stadion_user_approved', '1')
   - Verify is_user_approved() returns true

2. Test unapproved user access blocking:
   - Create unapproved user
   - Create person post authored by that user
   - Verify user_can_access_post() returns false for their OWN posts
   - Verify get_accessible_post_ids() returns empty array
   - Approve user, now access works

3. Test admin always approved:
   - Create admin user (role: administrator)
   - Verify is_user_approved() returns true even without meta

4. Test REST API blocking for unapproved users:
   - Unapproved user should get empty results from filter_rest_query()
   - filter_rest_single_access() should return WP_Error for unapproved user

5. Test approval transitions:
   - Deny previously approved user
   - Verify they lose access
  </action>
  <verify>vendor/bin/codecept run Wpunit WorkspacePermissionsTest passes all tests</verify>
  <done>User approval correctly gates all access, admins always approved</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `vendor/bin/codecept run Wpunit WorkspacePermissionsTest` passes all tests
- [ ] Workspace membership add/remove/update tested
- [ ] Role-based permissions (admin/member/viewer) tested
- [ ] User approval blocking tested for all access methods
- [ ] Admin bypass verified
</verification>

<success_criteria>

- All tests pass
- Workspace membership lifecycle fully tested
- Role-based permission resolution verified
- User approval blocking works at all access levels
- Phase 22 complete (all access control tests written)
</success_criteria>

<output>
After completion, create `.planning/phases/22-access-control-tests/22-03-SUMMARY.md`
</output>
