---
phase: 22-access-control-tests
plan: 02
type: execute
depends_on: []
files_modified: [tests/Wpunit/VisibilityRulesTest.php]
---

<objective>
Test visibility rules - private, workspace, and shared access patterns.

Purpose: Verify the three visibility modes (private/workspace/shared) correctly grant or deny access based on user relationships.
Output: VisibilityRulesTest.php with comprehensive tests for all visibility scenarios.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-phpunit-setup/21-01-SUMMARY.md

@includes/class-access-control.php
@includes/class-visibility.php
@includes/class-workspace-members.php
@tests/Support/StadionTestCase.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test private visibility</name>
  <files>tests/Wpunit/VisibilityRulesTest.php</files>
  <action>
Create VisibilityRulesTest extending StadionTestCase. Test private visibility:

1. Create two approved Stadion users (Alice, Bob)
2. Create a person post authored by Alice
3. Set visibility to private: STADION_Visibility::set_visibility($post_id, 'private')
4. Test assertions:
   - Alice can access (author always has access)
   - Bob cannot access (private = author only)
   - Verify get_visibility() returns 'private'
   - Verify default visibility is 'private' when not set

Test helper: Create helper method in test class to approve users and set up common fixtures.

Use STADION_Access_Control::user_can_access_post() for access checks.
  </action>
  <verify>vendor/bin/codecept run Wpunit VisibilityRulesTest::test_private_visibility passes</verify>
  <done>Private visibility correctly restricts access to author only</done>
</task>

<task type="auto">
  <name>Task 2: Test workspace visibility</name>
  <files>tests/Wpunit/VisibilityRulesTest.php</files>
  <action>
Add tests for workspace visibility:

1. Create three approved users (Alice, Bob, Charlie)
2. Create a workspace post authored by Alice
3. Add Alice as admin, Bob as member to workspace via STADION_Workspace_Members::add()
4. Create workspace_access term for the workspace (slug: 'workspace-{workspace_id}')
5. Create a person post authored by Alice with:
   - visibility = 'workspace'
   - workspace_access term assigned via wp_set_object_terms()
6. Test assertions:
   - Alice can access (author)
   - Bob can access (workspace member)
   - Charlie cannot access (not a workspace member)

Also test:
- User with viewer role can access (read access)
- Post with multiple workspace assignments (user in any = access)
  </action>
  <verify>vendor/bin/codecept run Wpunit VisibilityRulesTest::test_workspace_visibility passes</verify>
  <done>Workspace visibility grants access to all workspace members</done>
</task>

<task type="auto">
  <name>Task 3: Test direct shares</name>
  <files>tests/Wpunit/VisibilityRulesTest.php</files>
  <action>
Add tests for direct shares via _shared_with meta:

1. Create two approved users (Alice, Bob)
2. Create a private person post authored by Alice
3. Share with Bob via STADION_Visibility::add_share($post_id, $bob_id, 'view')
4. Test assertions:
   - Alice can access (author)
   - Bob can access (direct share, despite private visibility)
   - Verify share permission via STADION_Visibility::get_share_permission()
   - Test 'edit' permission level

Also test:
- Remove share via STADION_Visibility::remove_share(), Bob loses access
- user_has_share() returns correct boolean
- Share with 'edit' permission vs 'view' permission

Test interaction with visibility:
- Private post + shared = shared user has access
- Workspace post + shared to non-member = shared user has access
  </action>
  <verify>vendor/bin/codecept run Wpunit VisibilityRulesTest passes all tests</verify>
  <done>Direct shares override visibility restrictions for shared users</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `vendor/bin/codecept run Wpunit VisibilityRulesTest` passes all tests
- [ ] Private visibility tested (author only)
- [ ] Workspace visibility tested (members only)
- [ ] Direct shares tested (override visibility)
- [ ] Share add/remove lifecycle tested
</verification>

<success_criteria>

- All tests pass
- Three visibility modes fully tested
- Direct shares work independently of visibility
- Edge cases covered (multiple workspaces, share removal)
</success_criteria>

<output>
After completion, create `.planning/phases/22-access-control-tests/22-02-SUMMARY.md`
</output>
