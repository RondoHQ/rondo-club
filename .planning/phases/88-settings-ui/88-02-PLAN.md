---
phase: 88-settings-ui
plan: 02
type: execute
wave: 2
depends_on: [88-01]
files_modified:
  - src/pages/Settings/CustomFields.jsx
  - src/components/FieldFormPanel.jsx
  - src/components/DeleteFieldDialog.jsx
autonomous: true

must_haves:
  truths:
    - "Admin can add a new field via slide-out panel with type selector"
    - "Admin can edit existing field via same slide-out panel"
    - "Admin can archive (soft delete) a field preserving data"
    - "Admin can permanently delete a field with type-to-confirm"
  artifacts:
    - path: "src/components/FieldFormPanel.jsx"
      provides: "Slide-out panel for add/edit field form"
      min_lines: 150
    - path: "src/components/DeleteFieldDialog.jsx"
      provides: "Delete confirmation dialog with archive vs permanent options"
      min_lines: 80
  key_links:
    - from: "src/pages/Settings/CustomFields.jsx"
      to: "src/components/FieldFormPanel.jsx"
      via: "component import and state"
      pattern: "FieldFormPanel.*isOpen"
    - from: "src/components/FieldFormPanel.jsx"
      to: "/rondo/v1/custom-fields"
      via: "prmApi.createCustomField or updateCustomField"
      pattern: "createCustomField|updateCustomField"
---

<objective>
Create the slide-out panel for add/edit field forms and the delete confirmation dialog with archive vs permanent delete options.

Purpose: Enable admins to create, edit, and delete custom field definitions through the Settings UI.
Output: Fully functional custom field management with add, edit, archive, and delete capabilities
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/88-settings-ui/88-CONTEXT.md
@.planning/phases/88-settings-ui/88-01-SUMMARY.md
@src/pages/Settings/CustomFields.jsx
@src/api/client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FieldFormPanel slide-out component</name>
  <files>src/components/FieldFormPanel.jsx</files>
  <action>
Create slide-out panel component for add/edit field form:

**Props:**
- isOpen: boolean
- onClose: () => void
- onSubmit: (data) => Promise<void>
- field: object | null (null for add, object for edit)
- postType: 'person' | 'team'
- isSubmitting: boolean

**Panel structure:**
1. Overlay backdrop (fixed inset-0, bg-black/50, z-40)
2. Panel slides in from right (fixed inset-y-0 right-0, w-full max-w-md, z-50)
3. Use transform/transition for slide animation:
   ```jsx
   className={`fixed inset-y-0 right-0 w-full max-w-md bg-white dark:bg-gray-800 shadow-xl transform transition-transform duration-300 ease-in-out z-50 ${isOpen ? 'translate-x-0' : 'translate-x-full'}`}
   ```

**Form fields:**
1. **Label** (required) - text input
2. **Type** (required) - select dropdown
   - Show all types from FIELD_TYPE_LABELS constant
   - Disabled when editing (type cannot change after creation)
   - Show warning text when editing: "Field type cannot be changed after creation"
3. **Description** (optional) - textarea for instructions/help text

**Header:**
- Title: "Add Field" or "Edit Field" based on mode
- X close button

**Footer:**
- Cancel button (btn-secondary)
- Save button (btn-primary)
- Show loading spinner when isSubmitting

**Behavior:**
- Close on backdrop click
- Close on Escape key
- Focus first input on open
- Prevent body scroll when open (add overflow-hidden to body)

**Field type options for select:**
```javascript
const FIELD_TYPES = [
  { value: 'text', label: 'Text' },
  { value: 'textarea', label: 'Textarea' },
  { value: 'number', label: 'Number' },
  { value: 'email', label: 'Email' },
  { value: 'url', label: 'URL' },
  { value: 'date', label: 'Date' },
  { value: 'select', label: 'Select' },
  { value: 'checkbox', label: 'Checkbox' },
  { value: 'true_false', label: 'True/False' },
  { value: 'image', label: 'Image' },
  { value: 'file', label: 'File' },
  { value: 'link', label: 'Link' },
  { value: 'color', label: 'Color' },
  { value: 'relationship', label: 'Relationship' },
];
```

Note: Phase 89-90 will implement these field types. For now, the type is just stored in the definition.
  </action>
  <verify>Component file exists with form fields, slide animation, and submit handling</verify>
  <done>FieldFormPanel renders slide-out panel with Label, Type, Description fields and save/cancel</done>
</task>

<task type="auto">
  <name>Task 2: Create DeleteFieldDialog component</name>
  <files>src/components/DeleteFieldDialog.jsx</files>
  <action>
Create delete confirmation dialog with archive vs permanent options:

**Props:**
- isOpen: boolean
- onClose: () => void
- onArchive: () => Promise<void>
- onDelete: () => Promise<void>
- field: object
- isDeleting: boolean
- usageCount: number (how many records have values for this field)

**Dialog structure:**
Use centered modal pattern (fixed inset-0, flex items-center justify-center):

1. **Header:** "Delete Field" with field.label displayed

2. **Warning section:**
   - Show usage count: "This field has values on {usageCount} {people/teams}."
   - If usageCount === 0: "This field has no stored values."

3. **Options section:**
   Two clearly separated options:

   **Option A - Archive (Recommended)**
   - Description: "Hide this field from the UI. Data is preserved and can be restored later."
   - Button: "Archive Field" (btn-secondary)

   **Option B - Permanently Delete**
   - Description: "Remove field definition AND all stored values. This cannot be undone."
   - Type-to-confirm input: must type field label exactly
   - Button: "Delete Permanently" (btn with red styling, disabled until confirmed)

4. **Cancel button:** Close without action

**Type-to-confirm pattern:**
```jsx
const [confirmText, setConfirmText] = useState('');
const canDelete = confirmText === field?.label;
```

**Styling:**
- Archive section: neutral styling
- Delete section: red/warning styling (border-red-200, bg-red-50)
- Delete button: bg-red-600 hover:bg-red-700, disabled:opacity-50
  </action>
  <verify>Component file exists with archive/delete options and type-to-confirm</verify>
  <done>DeleteFieldDialog shows two delete options with type-to-confirm for permanent delete</done>
</task>

<task type="auto">
  <name>Task 3: Wire panel and dialog into CustomFields page</name>
  <files>src/pages/Settings/CustomFields.jsx</files>
  <action>
Update CustomFields.jsx to integrate the panel and dialog:

**State additions:**
```javascript
const [showPanel, setShowPanel] = useState(false);
const [editingField, setEditingField] = useState(null);
const [showDeleteDialog, setShowDeleteDialog] = useState(false);
const [deletingField, setDeletingField] = useState(null);
```

**Mutations (using TanStack Query):**
```javascript
const createMutation = useMutation({
  mutationFn: async (data) => prmApi.createCustomField(activeTab, data),
  onSuccess: () => {
    queryClient.invalidateQueries({ queryKey: ['custom-fields', activeTab] });
    setShowPanel(false);
    setEditingField(null);
  },
});

const updateMutation = useMutation({
  mutationFn: async ({ fieldKey, data }) => prmApi.updateCustomField(activeTab, fieldKey, data),
  onSuccess: () => {
    queryClient.invalidateQueries({ queryKey: ['custom-fields', activeTab] });
    setShowPanel(false);
    setEditingField(null);
  },
});

const deleteMutation = useMutation({
  mutationFn: async (fieldKey) => prmApi.deleteCustomField(activeTab, fieldKey),
  onSuccess: () => {
    queryClient.invalidateQueries({ queryKey: ['custom-fields', activeTab] });
    setShowDeleteDialog(false);
    setDeletingField(null);
  },
});
```

**Event handlers:**
```javascript
const handleAddField = () => {
  setEditingField(null);
  setShowPanel(true);
};

const handleEditField = (field) => {
  setEditingField(field);
  setShowPanel(true);
};

const handleDeleteField = (field) => {
  setDeletingField(field);
  setShowDeleteDialog(true);
};

const handleSubmitField = async (data) => {
  if (editingField) {
    await updateMutation.mutateAsync({ fieldKey: editingField.key, data });
  } else {
    await createMutation.mutateAsync(data);
  }
};

const handleArchiveField = async () => {
  // Archive uses the same DELETE endpoint (soft delete)
  await deleteMutation.mutateAsync(deletingField.key);
};

const handlePermanentDelete = async () => {
  // For now, same as archive. Phase 94 may add hard delete option.
  // The API currently only supports soft delete (deactivate).
  await deleteMutation.mutateAsync(deletingField.key);
};
```

**Wire up UI elements:**
1. Add Field button onClick -> handleAddField
2. Edit icon onClick -> handleEditField(field)
3. Delete icon onClick -> handleDeleteField(field)

**Add components at end of return:**
```jsx
<FieldFormPanel
  isOpen={showPanel}
  onClose={() => { setShowPanel(false); setEditingField(null); }}
  onSubmit={handleSubmitField}
  field={editingField}
  postType={activeTab}
  isSubmitting={createMutation.isPending || updateMutation.isPending}
/>

<DeleteFieldDialog
  isOpen={showDeleteDialog}
  onClose={() => { setShowDeleteDialog(false); setDeletingField(null); }}
  onArchive={handleArchiveField}
  onDelete={handlePermanentDelete}
  field={deletingField}
  isDeleting={deleteMutation.isPending}
  usageCount={0} // TODO: Phase 91+ will add usage count lookup
/>
```

**Import the new components:**
```javascript
import FieldFormPanel from '@/components/FieldFormPanel';
import DeleteFieldDialog from '@/components/DeleteFieldDialog';
```
  </action>
  <verify>Test add, edit, delete flows via the UI. Fields should appear in list after creation.</verify>
  <done>CustomFields page has working add, edit, and delete flows via panel and dialog</done>
</task>

</tasks>

<verification>
1. Click "Add Field" - slide-out panel opens from right
2. Fill in Label and Type, click Save - field appears in list
3. Click Edit on a field - panel opens with existing values
4. Change label, save - list updates with new label
5. Click Delete on a field - dialog shows with archive/permanent options
6. Click Archive - field disappears from list
7. Panel closes on backdrop click and Escape key
8. Delete permanent requires typing field name to confirm
</verification>

<success_criteria>
- Add Field opens slide-out panel with form
- Edit Field opens panel pre-filled with existing values
- Delete Field shows dialog with archive vs permanent options
- Type-to-confirm required for permanent delete
- All CRUD operations persist to database via REST API
- Query cache invalidates after mutations
</success_criteria>

<output>
After completion, create `.planning/phases/88-settings-ui/88-02-SUMMARY.md`
</output>
