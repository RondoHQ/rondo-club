---
phase: 131-forecast-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-google-sheets.php
  - src/pages/Contributie/ContributieList.jsx
autonomous: false

must_haves:
  truths:
    - "User can export forecast view to Google Sheets"
    - "Exported sheet title shows season and (Prognose) indicator"
    - "Exported forecast sheet has 8 columns (no Nikki columns)"
  artifacts:
    - path: "includes/class-rest-google-sheets.php"
      provides: "export_fees with forecast support"
      contains: "forecast"
    - path: "src/pages/Contributie/ContributieList.jsx"
      provides: "Export call passes forecast parameter"
      pattern: "forecast.*isForecast"
  key_links:
    - from: "src/pages/Contributie/ContributieList.jsx"
      to: "/rondo/v1/google-sheets/export-fees"
      via: "prmApi.exportFeesToSheets with forecast param"
      pattern: "forecast.*isForecast"
    - from: "includes/class-rest-google-sheets.php"
      to: "fetch_fee_data"
      via: "forecast parameter passed to data fetch"
      pattern: "fetch_fee_data.*forecast"
---

<objective>
Add forecast parameter support to Google Sheets export for contributie data.

Purpose: Enable users to export next season projections for budget planning. When viewing forecast in the UI, the export should produce a spreadsheet with the forecast data, excluding Nikki columns and clearly labeled as a projection.

Output: Modified export endpoint and frontend export handler supporting forecast mode.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/131-forecast-export/131-RESEARCH.md
@includes/class-rest-google-sheets.php
@src/pages/Contributie/ContributieList.jsx
@src/api/client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add forecast parameter to export_fees endpoint</name>
  <files>includes/class-rest-google-sheets.php</files>
  <action>
Modify the export_fees endpoint and related methods to support forecast mode:

1. **Route registration (line ~116-128):** Add forecast parameter to args:
   ```php
   'forecast' => [
       'required' => false,
       'type'     => 'boolean',
       'default'  => false,
   ],
   ```

2. **export_fees method (line ~497):** Extract forecast parameter and pass to fetch_fee_data:
   ```php
   $forecast = $request->get_param( 'forecast' );
   // ...
   $fee_data = $this->fetch_fee_data( $sort_field, $sort_order, $forecast );
   ```

3. **Spreadsheet title (line ~541-543):** Include "(Prognose)" when forecast:
   ```php
   $title = 'Contributie ' . $season;
   if ( $forecast ) {
       $title .= ' (Prognose)';
   }
   $title .= ' - ' . gmdate( 'Y-m-d' );
   ```

4. **Column count (line ~581):** Dynamic based on forecast:
   ```php
   $num_columns = $forecast ? 8 : 10;
   ```

5. **Nikki formatting (lines ~712-753):** Only apply Nikki column formatting when not forecast:
   Wrap requests 7 and 8 (Nikki Total and Saldo currency formatting) in:
   ```php
   if ( ! $forecast ) {
       // Nikki Total formatting
       // Saldo formatting
   }
   ```

6. **fetch_fee_data method (line ~838):** Add bool $forecast parameter:
   ```php
   private function fetch_fee_data( string $sort_field, string $sort_order, bool $forecast = false ): array {
       $fees = new \Stadion\Fees\MembershipFees();

       // Use next season for forecast
       $season = $forecast
           ? $fees->get_next_season_key()
           : $fees->get_season_key();

       $nikki_year = substr( $season, 0, 4 );
       // ... existing query code ...

       foreach ( $query->posts as $person ) {
           if ( $forecast ) {
               // Calculate with 100% pro-rata for forecast
               $fee_data = $fees->calculate_fee_with_family_discount( $person->ID, $season );
               if ( $fee_data === null ) {
                   continue;
               }
               $fee_data['prorata_percentage'] = 1.0;
               $fee_data['final_fee'] = $fee_data['fee_after_discount'] ?? $fee_data['final_fee'];
           } else {
               // Use cached calculation for current season
               $fee_data = $fees->get_fee_for_person_cached( $person->ID, $season );
               if ( $fee_data === null ) {
                   continue;
               }
           }

           $result = [
               'id'                   => $person->ID,
               'name'                 => $name ?: $person->post_title,
               'relatiecode'          => $relatiecode,
               'category'             => $fee_data['category'],
               'leeftijdsgroep'       => $fee_data['leeftijdsgroep'],
               'base_fee'             => $fee_data['base_fee'],
               'family_discount_rate' => $fee_data['family_discount_rate'],
               'prorata_percentage'   => $fee_data['prorata_percentage'],
               'final_fee'            => $fee_data['final_fee'],
           ];

           // Only include Nikki data for current season
           if ( ! $forecast ) {
               $result['nikki_total'] = $nikki_total !== '' ? (float) $nikki_total : null;
               $result['nikki_saldo'] = $nikki_saldo !== '' ? (float) $nikki_saldo : null;
           }

           $results[] = $result;
       }

       return [
           'season'   => $season,
           'forecast' => $forecast,
           'members'  => $results,
       ];
   }
   ```

7. **build_fee_spreadsheet_data method (line ~939):** Add bool $forecast parameter:
   ```php
   private function build_fee_spreadsheet_data( array $fee_data, bool $forecast = false ): array {
       // Conditional header row
       $headers = [
           'Naam', 'Relatiecode', 'Categorie', 'Leeftijdsgroep',
           'Basis', 'Gezinskorting', 'Pro-rata %', 'Bedrag',
       ];
       if ( ! $forecast ) {
           $headers[] = 'Nikki Total';
           $headers[] = 'Saldo';
       }
       $data[] = $headers;

       // Data rows - conditional Nikki columns
       foreach ( $fee_data['members'] as $member ) {
           $row = [
               $member['name'],
               $member['relatiecode'] ?: '',
               $category_labels[ $member['category'] ] ?? $member['category'],
               $member['leeftijdsgroep'] ?: '',
               $member['base_fee'],
               $member['family_discount_rate'],
               $member['prorata_percentage'],
               $member['final_fee'],
           ];
           if ( ! $forecast ) {
               $row[] = $member['nikki_total'];
               $row[] = $member['nikki_saldo'];
           }
           $data[] = $row;
       }

       // Totals row - conditional Nikki columns
       $totals_row = [ 'Totaal', '', '', '', $total_base_fee, '', '', $total_final_fee ];
       if ( ! $forecast ) {
           $totals_row[] = '';
           $totals_row[] = '';
       }
       $data[] = $totals_row;

       return $data;
   }
   ```

8. **Update the call to build_fee_spreadsheet_data** in export_fees (around line ~539):
   ```php
   $spreadsheet_data = $this->build_fee_spreadsheet_data( $fee_data, $forecast );
   ```
  </action>
  <verify>
Run `npm run lint` to check for any PHP syntax errors indirectly (via any shared tooling).
Review the modified file structure - the export_fees endpoint should now accept forecast=true and produce different output.
  </verify>
  <done>
- export_fees endpoint accepts forecast boolean parameter
- Forecast mode uses next season, 100% pro-rata, no Nikki columns
- Spreadsheet title includes "(Prognose)" when forecast=true
- Spreadsheet has 8 columns in forecast mode, 10 in current mode
- Nikki column formatting only applied in current mode
  </done>
</task>

<task type="auto">
  <name>Task 2: Pass forecast parameter in frontend export call</name>
  <files>src/pages/Contributie/ContributieList.jsx</files>
  <action>
In ContributieList.jsx, modify the handleExportToSheets function (around line 247-250) to include the forecast parameter:

```javascript
const response = await prmApi.exportFeesToSheets({
    sort_field: sortField,
    sort_order: sortOrder,
    forecast: isForecast,  // Add this line
});
```

The isForecast state already exists (line 203) and is toggled by the season selector (line 401).
  </action>
  <verify>
Run `npm run lint` - should pass with 0 warnings.
Run `npm run build` - should complete successfully.
  </verify>
  <done>
- Frontend export call includes forecast: isForecast parameter
- When viewing forecast and clicking export, the API receives forecast=true
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Forecast export to Google Sheets with conditional columns and title</what-built>
  <how-to-verify>
1. Deploy to production: `bin/deploy.sh`
2. Navigate to Contributie page
3. Select current season (2025-2026 huidig)
4. Click export button - verify spreadsheet has 10 columns including Nikki Total and Saldo
5. Note the spreadsheet title format: "Contributie 2025-2026 - YYYY-MM-DD"
6. Switch to forecast view (2026-2027 prognose)
7. Click export button - verify:
   - Spreadsheet title includes "(Prognose)": "Contributie 2026-2027 (Prognose) - YYYY-MM-DD"
   - Spreadsheet has 8 columns (no Nikki Total, no Saldo)
   - All members have 100% pro-rata
   - Currency and percentage formatting applied correctly
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Requirements coverage:
- EXP-01: Export button works when viewing forecast - TASK 1+2
- EXP-02: Exported sheet title includes season and "(Prognose)" - TASK 1 (title logic)
- EXP-03: Exported forecast excludes Nikki columns - TASK 1 (conditional columns)
</verification>

<success_criteria>
- Export from forecast view produces spreadsheet with:
  - Title: "Contributie YYYY-YYYY (Prognose) - DATE"
  - 8 columns (no Nikki Total, no Saldo)
  - All members with 100% pro-rata
  - Proper currency/percentage formatting
- Export from current view unchanged (10 columns, no Prognose in title)
- npm run lint passes
- npm run build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/131-forecast-export/131-01-SUMMARY.md`
</output>
