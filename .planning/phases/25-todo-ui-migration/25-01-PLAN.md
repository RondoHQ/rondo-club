---
phase: 25-todo-ui-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-comment-types.php
  - src/hooks/usePeople.js
  - src/hooks/useDashboard.js
autonomous: true
---

<objective>
Integrate CPT-based todos into the person timeline and ensure all frontend todo functionality works with the new backend.

Purpose: Phase 24 migrated todos from comments to a CPT but the timeline endpoint still only returns notes + activities. The PersonDetail page expects todos in the timeline for the Todos section. This plan restores that functionality.

Output: Timeline endpoint returns todos from CPT, frontend todo hooks updated with proper cache invalidation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-todo-post-type/24-02-SUMMARY.md
@.planning/phases/24-todo-post-type/24-03-SUMMARY.md

@includes/class-comment-types.php
@includes/class-rest-todos.php
@src/hooks/usePeople.js
@src/hooks/useDashboard.js
@src/pages/People/PersonDetail.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update timeline endpoint to include CPT todos</name>
  <files>includes/class-comment-types.php</files>
  <action>
Modify `get_timeline()` method to include todos from the `stadion_todo` CPT alongside notes and activities from comments.

**Implementation:**
1. After fetching comments (notes + activities), also query `stadion_todo` posts for this person:
   ```php
   $todos = get_posts([
       'post_type'      => 'stadion_todo',
       'post_status'    => 'publish',
       'posts_per_page' => -1,
       'meta_query'     => [
           [
               'key'   => 'related_person',
               'value' => $person_id,
           ],
       ],
   ]);
   ```

2. For each todo, format it to match the existing timeline format:
   ```php
   $timeline[] = [
       'id'           => $todo->ID,
       'type'         => 'todo',
       'content'      => $todo->post_content,
       'author_id'    => (int) $todo->post_author,
       'created'      => $todo->post_date,
       'person_id'    => $person_id,
       'person_name'  => get_the_title($person_id),
       'is_completed' => (bool) get_field('is_completed', $todo->ID),
       'due_date'     => get_field('due_date', $todo->ID),
   ];
   ```

3. Merge todos into timeline array before returning (they're already ordered by date via the existing sort or add explicit sorting).

**Note:** The access control for todos is automatic via `RONDO_Access_Control` hooks on `WP_Query`.
  </action>
  <verify>
Test on production:
1. `curl -X GET "https://cael.is/wp-json/rondo/v1/people/{person_id}/timeline" -H "Cookie: ..." | jq '.[] | select(.type == "todo")'`
2. Should return todos for that person with correct format
  </verify>
  <done>Timeline endpoint returns todos from CPT merged with notes and activities</done>
</task>

<task type="auto">
  <name>Task 2: Add usePersonTodos hook for direct todo fetching</name>
  <files>src/hooks/usePeople.js</files>
  <action>
Add a new hook `usePersonTodos` that fetches todos for a specific person. This provides a direct way to get person todos without going through the timeline.

**Implementation:**
```javascript
export function usePersonTodos(personId) {
  return useQuery({
    queryKey: peopleKeys.todos(personId),
    queryFn: async () => {
      const response = await prmApi.getPersonTodos(personId);
      return response.data;
    },
    enabled: !!personId,
  });
}
```

**Also update peopleKeys to include todos:**
```javascript
export const peopleKeys = {
  all: ['people'],
  lists: () => [...peopleKeys.all, 'list'],
  list: (filters) => [...peopleKeys.lists(), filters],
  details: () => [...peopleKeys.all, 'detail'],
  detail: (id) => [...peopleKeys.details(), id],
  timeline: (id) => [...peopleKeys.all, 'timeline', id],
  dates: (id) => [...peopleKeys.all, 'dates', id],
  todos: (id) => [...peopleKeys.all, 'todos', id], // NEW
};
```

**Update todo mutations to invalidate person todos:**
In `useCreateTodo`, `useUpdateTodo`, and `useDeleteTodo` mutations, add:
```javascript
queryClient.invalidateQueries({ queryKey: peopleKeys.timeline(personId) });
queryClient.invalidateQueries({ queryKey: peopleKeys.todos(personId) });
```

This ensures the PersonDetail page's timeline and dedicated todos queries both refresh when todos change.
  </action>
  <verify>Run `npm run build` - should compile without errors</verify>
  <done>usePersonTodos hook exists and mutations invalidate relevant queries</done>
</task>

<task type="auto">
  <name>Task 3: Update useDashboard hooks to invalidate timeline</name>
  <files>src/hooks/useDashboard.js</files>
  <action>
The `useUpdateTodo` and `useDeleteTodo` hooks in useDashboard.js also need to invalidate timeline queries when todos change, since the timeline now includes todos.

**Update useUpdateTodo:**
```javascript
export function useUpdateTodo() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ todoId, data }) => prmApi.updateTodo(todoId, data),
    onSuccess: (response, { todoId }) => {
      queryClient.invalidateQueries({ queryKey: ['todos'] });
      queryClient.invalidateQueries({ queryKey: ['dashboard'] });
      // Also invalidate timeline since todos now appear there
      queryClient.invalidateQueries({ queryKey: ['people', 'timeline'] });
    },
  });
}
```

**Update useDeleteTodo:**
```javascript
export function useDeleteTodo() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (todoId) => prmApi.deleteTodo(todoId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['todos'] });
      queryClient.invalidateQueries({ queryKey: ['dashboard'] });
      // Also invalidate timeline since todos now appear there
      queryClient.invalidateQueries({ queryKey: ['people', 'timeline'] });
    },
  });
}
```

**Note:** We invalidate all timelines (`['people', 'timeline']`) since we don't have the personId in these hooks. This is a broad invalidation but safe.
  </action>
  <verify>Run `npm run build` - should compile without errors</verify>
  <done>Dashboard hooks invalidate timeline queries when todos change</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Timeline endpoint returns todos for a person
- [ ] PersonDetail page shows todos in the Todos section
- [ ] Creating/editing/deleting todos updates both TodosList and PersonDetail views
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Todos appear in person timeline
- Cache invalidation works across all todo-related views
</success_criteria>

<output>
After completion, create `.planning/phases/25-todo-ui-migration/25-01-SUMMARY.md`
</output>
