---
phase: 58-react-dom-error-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - functions.php
  - index.php
  - src/App.jsx
  - src/components/DomErrorBoundary.jsx
  - src/main.jsx
autonomous: true
---

<objective>
Fix recurring React DOM removeChild/insertBefore errors through prevention and graceful recovery.

Purpose: Eliminate production errors caused by external DOM modification (browser extensions, Google Translate) interfering with React's virtual DOM reconciliation.

Output: Preventive measures blocking common DOM modifiers + error boundary for graceful recovery when errors still occur.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/58-react-dom-error-fix/58-RESEARCH.md

@index.php
@functions.php
@src/main.jsx
@src/App.jsx
</context>

<tasks>

<task type="auto">
<name>Task 1: Add DOM modification prevention measures</name>
<files>index.php, functions.php, src/App.jsx</files>
<action>
**1. Add translate="no" to HTML tag (index.php):**
Change line 2 from:
```php
<html <?php language_attributes(); ?>>
```
to:
```php
<html <?php language_attributes(); ?> translate="no">
```

**2. Add Google Translate meta tag (index.php):**
Add after the viewport meta tag:
```php
<meta name="google" content="notranslate">
```

**3. Replace top-level Fragment in App.jsx:**
The current App component returns:
```jsx
return (
  <>
    <UpdateBanner />
    <Routes>...
```

Change to use a wrapper div instead of Fragment:
```jsx
return (
  <div className="app-root">
    <UpdateBanner />
    <Routes>...
```

This provides a stable DOM container that browser extensions are less likely to disrupt.

**Why these changes:**
- `translate="no"` prevents Google Translate from modifying text nodes
- The meta tag is a belt-and-suspenders approach for Google
- Replacing Fragment with div gives React a stable parent reference - Fragments don't create DOM nodes, making their children vulnerable to external manipulation
</action>
<verify>npm run build succeeds without errors</verify>
<done>index.php has translate="no" and notranslate meta, App.jsx uses div wrapper instead of Fragment</done>
</task>

<task type="auto">
<name>Task 2: Create and integrate DomErrorBoundary</name>
<files>src/components/DomErrorBoundary.jsx, src/main.jsx</files>
<action>
**1. Create src/components/DomErrorBoundary.jsx:**

```jsx
import { Component } from 'react';

/**
 * Error boundary that catches React DOM synchronization errors.
 *
 * These errors occur when external forces (browser extensions, Google Translate,
 * third-party scripts) modify the DOM independently of React, causing React's
 * virtual DOM to become out of sync with the actual DOM.
 *
 * This boundary catches these specific errors and auto-recovers by forcing
 * a clean re-render of its children.
 */
class DomErrorBoundary extends Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, errorKey: 0 };
  }

  static getDerivedStateFromError(error) {
    // Only catch DOM-related errors
    if (
      error.name === 'NotFoundError' ||
      error.message?.includes('removeChild') ||
      error.message?.includes('insertBefore')
    ) {
      console.warn('[DomErrorBoundary] Caught DOM sync error, recovering:', error.message);
      return { hasError: true };
    }
    // Re-throw other errors - don't swallow legitimate bugs
    throw error;
  }

  componentDidCatch(error, errorInfo) {
    // Log for debugging in production
    console.error('[DomErrorBoundary] Error details:', error, errorInfo);

    // Auto-recover after brief delay to let React stabilize
    setTimeout(() => {
      this.setState(prev => ({
        hasError: false,
        errorKey: prev.errorKey + 1
      }));
    }, 100);
  }

  render() {
    if (this.state.hasError) {
      // Return null briefly during recovery
      // The setTimeout in componentDidCatch will trigger re-render
      return null;
    }

    // Key change forces clean re-mount after recovery
    return (
      <div key={this.state.errorKey}>
        {this.props.children}
      </div>
    );
  }
}

export default DomErrorBoundary;
```

**2. Integrate into src/main.jsx:**

Import the error boundary:
```jsx
import DomErrorBoundary from './components/DomErrorBoundary';
```

Wrap the app with DomErrorBoundary inside StrictMode but outside QueryClientProvider:
```jsx
ReactDOM.createRoot(rootElement).render(
  <React.StrictMode>
    <DomErrorBoundary>
      <QueryClientProvider client={queryClient}>
        <BrowserRouter>
          <App />
        </BrowserRouter>
      </QueryClientProvider>
    </DomErrorBoundary>
  </React.StrictMode>
);
```

**Why this structure:**
- Error boundary catches DOM errors before they crash the app
- Auto-recovery re-mounts children with fresh state
- Key prop ensures clean re-render after recovery
- Only catches specific DOM errors - other bugs propagate normally
- Placed outside QueryClient so query cache survives recovery
</action>
<verify>npm run build succeeds, npm run lint passes</verify>
<done>DomErrorBoundary.jsx exists and is integrated in main.jsx wrapping the app</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes (max-warnings: 0)
- [ ] index.php has `translate="no"` attribute on html tag
- [ ] index.php has `<meta name="google" content="notranslate">` tag
- [ ] App.jsx uses `<div className="app-root">` instead of Fragment
- [ ] DomErrorBoundary.jsx exists in src/components/
- [ ] main.jsx imports and uses DomErrorBoundary
- [ ] Error boundary only catches DOM-specific errors (NotFoundError, removeChild, insertBefore)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Prevention measures in place (translate="no", meta tag, div wrapper)
- Error boundary provides graceful recovery for any remaining DOM sync errors
</success_criteria>

<output>
After completion, create `.planning/phases/58-react-dom-error-fix/58-01-SUMMARY.md`
</output>
