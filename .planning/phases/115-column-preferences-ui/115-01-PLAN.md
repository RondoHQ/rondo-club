---
phase: 115-column-preferences-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-api.php
  - src/hooks/useListPreferences.js
autonomous: true

must_haves:
  truths:
    - "Backend stores column_order (all columns) separately from visible_columns"
    - "Backend stores column_widths object with column widths"
    - "Frontend hook fetches and updates preferences with optimistic updates"
    - "Hook provides instant feedback via optimistic updates"
  artifacts:
    - path: "includes/class-rest-api.php"
      provides: "Extended list-preferences endpoint with column_order and column_widths"
      contains: "column_order"
    - path: "src/hooks/useListPreferences.js"
      provides: "TanStack Query hook for preferences GET/PATCH"
      exports: ["useListPreferences"]
  key_links:
    - from: "src/hooks/useListPreferences.js"
      to: "/stadion/v1/user/list-preferences"
      via: "prmApi GET and PATCH"
      pattern: "stadion/v1/user/list-preferences"
---

<objective>
Extend the Phase 114 backend to support column order and widths storage, and create the frontend hook for preferences management.

Purpose: The backend needs to store column_order (all columns in user's preferred order) separately from visible_columns (which columns are shown), plus column_widths for resize persistence. The frontend hook provides optimistic updates for instant UI feedback.

Output: Extended REST API endpoints and useListPreferences.js hook
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/114-user-preferences-backend/114-01-SUMMARY.md
@.planning/phases/115-column-preferences-ui/115-CONTEXT.md
@.planning/phases/115-column-preferences-ui/115-RESEARCH.md
@includes/class-rest-api.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend backend to store column_order and column_widths</name>
  <files>includes/class-rest-api.php</files>
  <action>
Extend the existing list-preferences endpoint to support column_order and column_widths:

1. Update get_list_preferences() to return:
   - visible_columns (existing)
   - column_order (all columns in user's preferred order, defaults to available_columns order)
   - column_widths (object mapping column_id to width in pixels, empty by default)
   - available_columns (existing)

2. Update update_list_preferences() to accept:
   - visible_columns (existing)
   - column_order (array of all column IDs, validates against available columns)
   - column_widths (object, validates column IDs exist)

3. Store column_order in separate user_meta key 'stadion_people_list_column_order'
4. Store column_widths in separate user_meta key 'stadion_people_list_column_widths'

5. On reset:
   - Delete visible_columns, column_order, and column_widths
   - Return defaults for all

Validation rules:
- column_order: filter to valid column IDs (silently remove invalid)
- column_widths: filter to valid column IDs, values must be positive integers
- Empty column_order or column_widths = use defaults (don't store empty arrays/objects)

Follow existing patterns from get_dashboard_settings/update_dashboard_settings.
  </action>
  <verify>
Browser console tests:
```javascript
// Test column_order and column_widths storage
await fetch('/wp-json/stadion/v1/user/list-preferences', {
  method: 'PATCH',
  headers: { 'Content-Type': 'application/json', 'X-WP-Nonce': window.wpApiSettings.nonce },
  body: JSON.stringify({
    column_order: ['team', 'labels', 'modified'],
    column_widths: { team: 200, labels: 150 }
  })
}).then(r => r.json());
// Should return column_order and column_widths in response

// Test GET returns stored values
await fetch('/wp-json/stadion/v1/user/list-preferences', {
  headers: { 'X-WP-Nonce': window.wpApiSettings.nonce }
}).then(r => r.json());
// Should return column_order: ['team', 'labels', 'modified'], column_widths: { team: 200, labels: 150 }

// Test reset clears all
await fetch('/wp-json/stadion/v1/user/list-preferences', {
  method: 'PATCH',
  headers: { 'Content-Type': 'application/json', 'X-WP-Nonce': window.wpApiSettings.nonce },
  body: JSON.stringify({ reset: true })
}).then(r => r.json());
// Should return defaults for all fields
```
  </verify>
  <done>
- GET /stadion/v1/user/list-preferences returns column_order and column_widths
- PATCH /stadion/v1/user/list-preferences accepts column_order and column_widths
- Invalid column IDs filtered silently
- Reset clears all preferences
- All three properties stored in separate user_meta keys
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useListPreferences hook with optimistic updates</name>
  <files>src/hooks/useListPreferences.js</files>
  <action>
Create a new hook at src/hooks/useListPreferences.js that wraps TanStack Query for preferences management:

1. Export useListPreferences() hook that returns:
   - preferences: { visible_columns, column_order, column_widths, available_columns }
   - isLoading: boolean
   - updatePreferences: (updates) => void - optimistic mutation
   - isUpdating: boolean

2. Use TanStack Query patterns already established in codebase:
   - queryKey: ['user', 'list-preferences']
   - queryFn: GET /stadion/v1/user/list-preferences via prmApi
   - Optimistic updates on mutation (update cache immediately, rollback on error)
   - Invalidate query on settled (ensure server sync)

3. Debounce width updates:
   - Create updateColumnWidths(widths) helper that debounces by 300ms
   - Batch multiple rapid width changes into single API call

4. Handle localStorage sync for instant column widths on page load:
   - On query success, sync column_widths to localStorage key 'stadion_column_widths'
   - On mount, initialize from localStorage if available (prevents flicker)

Pattern to follow from RESEARCH.md and existing codebase hooks.

Import from '@/api/client' using prmApi (not wpApi) for /stadion/v1 namespace.
  </action>
  <verify>
After npm run build, verify in browser console:
```javascript
// Import hook (will be available via React DevTools or manual testing)
// The hook should be usable in React components

// Manual API test to verify debouncing works:
// 1. Open PeopleList page
// 2. Check Network tab for list-preferences calls
// 3. Should see GET on mount, PATCH calls on preference changes
```

Also verify:
- Hook file exists at src/hooks/useListPreferences.js
- No ESLint errors: npm run lint -- src/hooks/useListPreferences.js
  </verify>
  <done>
- useListPreferences hook created at src/hooks/useListPreferences.js
- Hook fetches preferences from /stadion/v1/user/list-preferences
- Optimistic updates provide instant feedback
- Width updates debounced by 300ms
- localStorage sync prevents column width flicker on reload
- No ESLint errors
  </done>
</task>

</tasks>

<verification>
1. Backend endpoint returns column_order and column_widths in response
2. Backend stores/retrieves column_order and column_widths correctly
3. Reset action clears all three preference types
4. useListPreferences hook exists and exports correctly
5. Hook provides optimistic update functionality
6. npm run lint passes for new hook file
7. npm run build completes successfully
</verification>

<success_criteria>
- GET /stadion/v1/user/list-preferences returns { visible_columns, column_order, column_widths, available_columns }
- PATCH endpoint accepts and stores column_order and column_widths
- useListPreferences hook provides preferences data and update functions
- Optimistic updates work (UI updates before server confirms)
- Width updates are debounced to prevent excessive API calls
</success_criteria>

<output>
After completion, create `.planning/phases/115-column-preferences-ui/115-01-SUMMARY.md`
</output>
