---
phase: 160-configurable-family-discount
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-membership-fees.php
  - includes/class-rest-api.php
autonomous: true

must_haves:
  truths:
    - "get_family_discount_rate() reads percentages from per-season WordPress option with fallback to defaults (25/50)"
    - "get_family_discount_rate() accepts optional season parameter for forecast mode"
    - "GET /membership-fees/settings returns family_discount config for both seasons"
    - "POST /membership-fees/settings accepts and validates family_discount alongside categories"
    - "Existing fee calculations continue to work correctly with default values when no config exists"
  artifacts:
    - path: "includes/class-membership-fees.php"
      provides: "get_family_discount_config(), save_family_discount_config(), updated get_family_discount_rate()"
      contains: "get_family_discount_config"
    - path: "includes/class-rest-api.php"
      provides: "family_discount in GET/POST settings endpoints, validate_family_discount_config()"
      contains: "validate_family_discount_config"
  key_links:
    - from: "includes/class-membership-fees.php::get_family_discount_rate()"
      to: "get_family_discount_config()"
      via: "reads percentages from season config"
      pattern: "get_family_discount_config"
    - from: "includes/class-membership-fees.php::calculate_fee_with_family_discount()"
      to: "get_family_discount_rate()"
      via: "passes season parameter"
      pattern: "get_family_discount_rate.*\\$season"
    - from: "includes/class-rest-api.php::update_membership_fee_settings()"
      to: "save_family_discount_config()"
      via: "saves validated discount config"
      pattern: "save_family_discount_config"
---

<objective>
Make family discount percentages configurable per season in the backend. Update `get_family_discount_rate()` to read from a per-season WordPress option instead of returning hardcoded values, add helper methods for discount config CRUD, and extend the REST API settings endpoints to include family discount configuration with server-side validation.

Purpose: Admins need to adjust family discount percentages per season without code changes. The backend must support this before the UI can be built.
Output: PHP backend with configurable family discount that falls back to current behavior (25%/50%) when no config exists.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/160-configurable-family-discount/160-RESEARCH.md
@.planning/phases/155-fee-category-data-model/155-01-SUMMARY.md
@.planning/phases/157-fee-category-rest-api/157-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add family discount config helpers and update get_family_discount_rate()</name>
  <files>includes/class-membership-fees.php</files>
  <action>
Add three new methods and update one existing method in the MembershipFees class:

**1. Add `get_family_discount_config()` method** (place after `get_category()` around line 649):
```php
/**
 * Get family discount configuration for a season
 *
 * Returns discount percentages stored in a separate WordPress option.
 * Falls back to default values (25% for 2nd child, 50% for 3rd+) if not configured.
 *
 * @param string|null $season Optional season key, defaults to current season.
 * @return array Array with 'second_child_percent' and 'third_child_percent' keys.
 */
public function get_family_discount_config( ?string $season = null ): array {
    $season = $season ?: $this->get_season_key();
    $config = get_option( 'rondo_family_discount_' . $season, null );

    return [
        'second_child_percent' => $config['second_child_percent'] ?? 25,
        'third_child_percent'  => $config['third_child_percent'] ?? 50,
    ];
}
```

**2. Add `save_family_discount_config()` method** (place after `get_family_discount_config()`):
```php
/**
 * Save family discount configuration for a season
 *
 * @param array  $config Array with 'second_child_percent' and 'third_child_percent' keys.
 * @param string $season Season key in "YYYY-YYYY" format.
 * @return bool True on success, false on failure.
 */
public function save_family_discount_config( array $config, string $season ): bool {
    return update_option( 'rondo_family_discount_' . $season, $config );
}
```

**3. Update `get_family_discount_rate()` method** (currently lines 1126-1134):

Change the method signature to accept an optional `$season` parameter and read from config instead of hardcoded values:

```php
/**
 * Get discount rate based on family position
 *
 * Position is 1-indexed where position 1 is the most expensive youth member
 * who pays full fee. Discount percentages are read from season config, with
 * fallback to default values (25% for 2nd child, 50% for 3rd+).
 *
 * @param int         $position 1-indexed position in family (1=most expensive, pays full).
 * @param string|null $season   Optional season key, defaults to current season.
 * @return float Discount rate (0.0 to 1.0).
 */
public function get_family_discount_rate( int $position, ?string $season = null ): float {
    if ( $position <= 1 ) {
        return 0.0;  // First member always pays full fee
    }

    $config = $this->get_family_discount_config( $season );

    if ( $position === 2 ) {
        return $config['second_child_percent'] / 100.0;
    }

    return $config['third_child_percent'] / 100.0;
}
```

**4. Update the call site in `calculate_fee_with_family_discount()`** (around line 1347):

Change:
```php
$discount_rate = $this->get_family_discount_rate( $position );
```
To:
```php
$discount_rate = $this->get_family_discount_rate( $position, $season );
```

The `$season` variable is already resolved at the top of `calculate_fee_with_family_discount()` (line 1248), so it's available here.

**Important: Use a separate WordPress option** (`rondo_family_discount_{season}`) instead of storing in the same option as categories. This is because `save_categories_for_season()` replaces the entire option with just categories, and `get_categories_for_season()` returns all keys as categories. Mixing them would cause family_discount to appear as a category or get lost on save.
  </action>
  <verify>
Run on production via SSH:
```bash
source .env && ssh -p "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" "cd $DEPLOY_REMOTE_THEME_PATH && wp eval '
\$fees = new \Rondo\Fees\MembershipFees();
// Test default config (no option set yet)
\$config = \$fees->get_family_discount_config();
echo \"Default config: \" . json_encode(\$config) . \"\n\";
// Test discount rates with defaults
echo \"Pos 1: \" . \$fees->get_family_discount_rate(1) . \"\n\";
echo \"Pos 2: \" . \$fees->get_family_discount_rate(2) . \"\n\";
echo \"Pos 3: \" . \$fees->get_family_discount_rate(3) . \"\n\";
'"
```
Expected: config returns {second_child_percent: 25, third_child_percent: 50}, rates return 0.0, 0.25, 0.50.

Also verify `npm run build` succeeds locally (no PHP changes break JS build).
  </verify>
  <done>
- get_family_discount_config() returns {second_child_percent: 25, third_child_percent: 50} by default
- get_family_discount_rate(1) returns 0.0, (2) returns 0.25, (3) returns 0.50 with defaults
- save_family_discount_config() persists config to rondo_family_discount_{season} option
- calculate_fee_with_family_discount() passes season to get_family_discount_rate()
- All existing fee calculations unchanged (backward compatible via defaults)
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend REST API settings endpoints with family discount</name>
  <files>includes/class-rest-api.php</files>
  <action>
Extend the membership fee settings endpoints to include family discount configuration:

**1. Update `get_membership_fee_settings()` method** (around line 2573):

Add `family_discount` to the response for both seasons:

```php
public function get_membership_fee_settings( $request ) {
    $membership_fees = new \Rondo\Fees\MembershipFees();
    $current_season  = $membership_fees->get_season_key();
    $next_season     = $membership_fees->get_next_season_key();

    return rest_ensure_response(
        [
            'current_season' => [
                'key'             => $current_season,
                'categories'      => $membership_fees->get_categories_for_season( $current_season ),
                'family_discount' => $membership_fees->get_family_discount_config( $current_season ),
            ],
            'next_season'    => [
                'key'             => $next_season,
                'categories'      => $membership_fees->get_categories_for_season( $next_season ),
                'family_discount' => $membership_fees->get_family_discount_config( $next_season ),
            ],
        ]
    );
}
```

**2. Update `update_membership_fee_settings()` method** (around line 2600):

Add family_discount parameter handling. Read it from the request, validate it, save it alongside categories:

```php
public function update_membership_fee_settings( $request ) {
    $membership_fees = new \Rondo\Fees\MembershipFees();
    $current_season  = $membership_fees->get_season_key();
    $next_season     = $membership_fees->get_next_season_key();
    $season          = $request->get_param( 'season' );
    $categories      = $request->get_param( 'categories' );
    $family_discount = $request->get_param( 'family_discount' );

    // Validate category structure
    $validation = $this->validate_category_config( $categories );

    // Validate family discount config (if provided)
    $discount_validation = $this->validate_family_discount_config( $family_discount );

    // Merge all errors and warnings
    $all_errors   = array_merge( $validation['errors'], $discount_validation['errors'] );
    $all_warnings = array_merge( $validation['warnings'], $discount_validation['warnings'] );

    if ( ! empty( $all_errors ) ) {
        return new \WP_Error(
            'invalid_settings',
            'Settings validation failed',
            [
                'status'   => 400,
                'errors'   => $all_errors,
                'warnings' => $all_warnings,
            ]
        );
    }

    // Save categories for the specified season
    $membership_fees->save_categories_for_season( $categories, $season );

    // Save family discount config (if provided)
    if ( $family_discount !== null ) {
        $membership_fees->save_family_discount_config(
            [
                'second_child_percent' => (float) ( $family_discount['second_child_percent'] ?? 25 ),
                'third_child_percent'  => (float) ( $family_discount['third_child_percent'] ?? 50 ),
            ],
            $season
        );
    }

    // Return updated settings for both seasons
    $response = [
        'current_season' => [
            'key'             => $current_season,
            'categories'      => $membership_fees->get_categories_for_season( $current_season ),
            'family_discount' => $membership_fees->get_family_discount_config( $current_season ),
        ],
        'next_season'    => [
            'key'             => $next_season,
            'categories'      => $membership_fees->get_categories_for_season( $next_season ),
            'family_discount' => $membership_fees->get_family_discount_config( $next_season ),
        ],
    ];

    // Include warnings if any
    if ( ! empty( $all_warnings ) ) {
        $response['warnings'] = $all_warnings;
    }

    return rest_ensure_response( $response );
}
```

**3. Add `validate_family_discount_config()` private method** (place after `validate_category_config()`):

```php
/**
 * Validate family discount configuration
 *
 * Ensures percentages are valid numbers between 0 and 100.
 * Null/missing config is valid (defaults will be used).
 *
 * @param mixed $config The family_discount config to validate.
 * @return array Array with 'errors' and 'warnings' keys.
 */
private function validate_family_discount_config( $config ) {
    $errors   = [];
    $warnings = [];

    // Null/missing is valid (use defaults)
    if ( $config === null ) {
        return [ 'errors' => [], 'warnings' => [] ];
    }

    // Must be an array
    if ( ! is_array( $config ) ) {
        $errors[] = [
            'field'   => 'family_discount',
            'message' => 'Familiekorting configuratie moet een object zijn',
        ];
        return [ 'errors' => $errors, 'warnings' => $warnings ];
    }

    // Validate second_child_percent
    if ( isset( $config['second_child_percent'] ) ) {
        $value = $config['second_child_percent'];
        if ( ! is_numeric( $value ) || $value < 0 || $value > 100 ) {
            $errors[] = [
                'field'   => 'family_discount.second_child_percent',
                'message' => 'Korting tweede kind moet tussen 0 en 100 procent zijn',
            ];
        }
    }

    // Validate third_child_percent
    if ( isset( $config['third_child_percent'] ) ) {
        $value = $config['third_child_percent'];
        if ( ! is_numeric( $value ) || $value < 0 || $value > 100 ) {
            $errors[] = [
                'field'   => 'family_discount.third_child_percent',
                'message' => 'Korting derde kind en verder moet tussen 0 en 100 procent zijn',
            ];
        }
    }

    // Warning if second child discount >= third child discount
    $second = is_numeric( $config['second_child_percent'] ?? null ) ? (float) $config['second_child_percent'] : 25;
    $third  = is_numeric( $config['third_child_percent'] ?? null ) ? (float) $config['third_child_percent'] : 50;
    if ( $second > 0 && $third > 0 && $second >= $third ) {
        $warnings[] = [
            'field'   => 'family_discount',
            'message' => 'Korting tweede kind is doorgaans lager dan korting derde kind',
        ];
    }

    return [ 'errors' => $errors, 'warnings' => $warnings ];
}
```

**Important:** The WP_Error code changes from `'invalid_categories'` to `'invalid_settings'` since validation now covers both categories and family discount. Update this in the existing error return.
  </action>
  <verify>
Deploy and test via curl:
```bash
# Test GET returns family_discount
source .env && curl -s "https://${DEPLOY_PRODUCTION_URL}/wp-json/rondo/v1/membership-fees/settings" -H "Cookie: ..." | python3 -m json.tool | grep -A3 family_discount

# Test POST with family_discount
# (will be tested more thoroughly via the UI in Plan 02)
```

Also verify: `npm run build` succeeds.
  </verify>
  <done>
- GET /membership-fees/settings returns family_discount config (second_child_percent, third_child_percent) for both seasons
- POST /membership-fees/settings accepts optional family_discount parameter and validates it
- Validation rejects percentages outside 0-100 range (error) and warns if 2nd >= 3rd (warning)
- Null/missing family_discount is accepted (defaults used)
- Categories save still works independently when family_discount is not provided
- Validation errors use Dutch messages consistent with the existing UI
  </done>
</task>

</tasks>

<verification>
1. Default behavior preserved: existing fee calculations return same values (0%/25%/50%) without any config
2. GET endpoint returns family_discount for both current and next season
3. POST endpoint accepts family_discount alongside categories, validates independently
4. Validation: rejects non-numeric, <0, >100; warns when 2nd >= 3rd
5. `npm run build` succeeds
6. No existing code breaks (backward compatible via defaults)
</verification>

<success_criteria>
- Family discount percentages are stored in `rondo_family_discount_{season}` WordPress option
- `get_family_discount_rate()` reads from config with fallback to 25/50 defaults
- REST API settings endpoints include family_discount in GET responses and accept it in POST requests
- All existing fee calculations continue to work identically when no discount config is set
</success_criteria>

<output>
After completion, create `.planning/phases/160-configurable-family-discount/160-01-SUMMARY.md`
</output>
