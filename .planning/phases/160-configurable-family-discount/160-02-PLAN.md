---
phase: 160-configurable-family-discount
plan: 02
type: execute
wave: 2
depends_on: ["160-01"]
files_modified:
  - src/pages/Settings/FeeCategorySettings.jsx
  - src/api/client.js
autonomous: true

must_haves:
  truths:
    - "Admin can see current family discount percentages in the fee settings UI"
    - "Admin can edit second child and third child discount percentages"
    - "Admin can save discount percentages and they persist across page reload"
    - "Changing discount percentages works independently per season (current vs next)"
    - "Validation errors and warnings from API are displayed correctly"
    - "Default values (25%/50%) shown when no config exists"
  artifacts:
    - path: "src/pages/Settings/FeeCategorySettings.jsx"
      provides: "FamilyDiscountSection component integrated into FeeCategorySettings"
      contains: "FamilyDiscountSection"
    - path: "src/api/client.js"
      provides: "API client sends family_discount in settings update"
      contains: "family_discount"
  key_links:
    - from: "src/pages/Settings/FeeCategorySettings.jsx::saveMutation"
      to: "POST /rondo/v1/membership-fees/settings"
      via: "sends family_discount alongside categories"
      pattern: "family_discount"
    - from: "src/pages/Settings/FeeCategorySettings.jsx::FamilyDiscountSection"
      to: "FeeCategorySettings state"
      via: "reads discount config from query data, saves via mutation"
      pattern: "family_discount"
---

<objective>
Add family discount configuration UI to the existing FeeCategorySettings component. Admin can view and edit the discount percentages (second child, third child and further) per season, with validation feedback.

Purpose: Completes the configurable family discount feature by providing the admin interface for the backend built in Plan 01.
Output: Working UI section in fee category settings for managing family discount percentages per season.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/160-configurable-family-discount/160-RESEARCH.md
@.planning/phases/160-configurable-family-discount/160-01-SUMMARY.md
@.planning/phases/158-fee-category-settings-ui/158-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FamilyDiscountSection to FeeCategorySettings and wire up save</name>
  <files>src/pages/Settings/FeeCategorySettings.jsx, src/api/client.js</files>
  <action>
**1. Add `FamilyDiscountSection` component** inside `FeeCategorySettings.jsx` (before the main `FeeCategorySettings` component, after `AgeCoverageSummary`):

Create a new sub-component that displays two number inputs for the discount percentages:

```jsx
function FamilyDiscountSection({ discountConfig, onSave, isSaving }) {
  const [secondChild, setSecondChild] = useState(discountConfig?.second_child_percent ?? 25);
  const [thirdChild, setThirdChild] = useState(discountConfig?.third_child_percent ?? 50);
  const [isDirty, setIsDirty] = useState(false);

  // Sync with external data when season changes
  useEffect(() => {
    setSecondChild(discountConfig?.second_child_percent ?? 25);
    setThirdChild(discountConfig?.third_child_percent ?? 50);
    setIsDirty(false);
  }, [discountConfig?.second_child_percent, discountConfig?.third_child_percent]);

  const handleSave = () => {
    onSave({
      second_child_percent: parseFloat(secondChild) || 0,
      third_child_percent: parseFloat(thirdChild) || 0,
    });
    setIsDirty(false);
  };

  const handleReset = () => {
    setSecondChild(25);
    setThirdChild(50);
    setIsDirty(true);
  };

  return (
    <div className="card p-6 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800">
      <h4 className="text-base font-semibold text-gray-900 dark:text-gray-100 mb-1">
        Familiekorting
      </h4>
      <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">
        Configureer de kortingspercentages voor het tweede en derde kind binnen een gezin.
        Het eerste kind betaalt altijd het volledige tarief.
      </p>

      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label htmlFor="second_child_percent" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Tweede kind
          </label>
          <div className="relative">
            <input
              type="number"
              id="second_child_percent"
              min="0"
              max="100"
              step="1"
              value={secondChild}
              onChange={(e) => { setSecondChild(e.target.value); setIsDirty(true); }}
              className="w-full pr-8 px-3 py-2 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-accent-500 focus:ring-accent-500"
            />
            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400">%</span>
          </div>
          <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Standaard: 25%</p>
        </div>
        <div>
          <label htmlFor="third_child_percent" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Derde kind en verder
          </label>
          <div className="relative">
            <input
              type="number"
              id="third_child_percent"
              min="0"
              max="100"
              step="1"
              value={thirdChild}
              onChange={(e) => { setThirdChild(e.target.value); setIsDirty(true); }}
              className="w-full pr-8 px-3 py-2 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-accent-500 focus:ring-accent-500"
            />
            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400">%</span>
          </div>
          <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Standaard: 50%</p>
        </div>
      </div>

      <div className="mt-4 flex items-center gap-3">
        <button
          onClick={handleSave}
          disabled={isSaving || !isDirty}
          className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-accent-600 hover:bg-accent-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent-500 disabled:opacity-50"
        >
          {isSaving ? (
            <>
              <Loader2 className="w-4 h-4 mr-2 animate-spin" />
              Opslaan...
            </>
          ) : (
            'Opslaan'
          )}
        </button>
        <button
          onClick={handleReset}
          disabled={isSaving}
          className="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md shadow-sm text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent-500 disabled:opacity-50"
        >
          Reset naar standaard
        </button>
      </div>
    </div>
  );
}
```

**Important:** Add `useEffect` to the import at the top of the file (it currently only imports `useState`).

**2. Wire FamilyDiscountSection into the main component:**

In the main `FeeCategorySettings` component:

a. Extract `family_discount` from the active season data:
```jsx
const activeDiscount = activeSeason?.family_discount || { second_child_percent: 25, third_child_percent: 50 };
```

b. Create a separate mutation for saving family discount (to avoid sending categories when only discount changes). Add this after the existing `saveMutation`:
```jsx
const discountMutation = useMutation({
    mutationFn: async ({ family_discount, season }) => {
      const response = await prmApi.updateMembershipFeeSettings({ categories, family_discount }, season);
      return response.data;
    },
    onSuccess: (responseData) => {
      queryClient.setQueryData(['membership-fee-settings'], responseData);
      if (responseData.warnings && responseData.warnings.length > 0) {
        setSaveWarnings(responseData.warnings);
      } else {
        setSaveWarnings([]);
      }
      setSaveErrors([]);
      setSuccessMessage('Familiekorting opgeslagen');
      setTimeout(() => setSuccessMessage(''), 3000);
    },
    onError: (error) => {
      const errorData = error.response?.data?.data;
      if (errorData?.errors) {
        setSaveErrors(errorData.errors);
      } else {
        setSaveErrors([{ field: 'general', message: error.message || 'Er is een fout opgetreden' }]);
      }
      setSaveWarnings([]);
    },
    onSettled: () => {
      queryClient.invalidateQueries({ queryKey: ['membership-fee-settings'] });
    },
  });
```

c. Add a handler for discount save:
```jsx
const handleDiscountSave = (discountConfig) => {
    clearMessages();
    discountMutation.mutate({ family_discount: discountConfig, season: activeSeasonKey });
  };
```

d. Place the `FamilyDiscountSection` in the JSX **between the season selector and the error display** (after the season selector `<div className="flex gap-2">` block, before the error display block). This puts it prominently above the category list:

```jsx
{/* Family discount section */}
<FamilyDiscountSection
  discountConfig={activeDiscount}
  onSave={handleDiscountSave}
  isSaving={discountMutation.isPending}
/>
```

**3. Update the API client** in `src/api/client.js`:

The existing `updateMembershipFeeSettings` already spreads settings: `api.post('/rondo/v1/membership-fees/settings', { ...settings, season })`. Since the caller sends `{ categories, family_discount }` as settings, the spread will include `family_discount` automatically. **No change needed** to `client.js` -- verify this is the case by reading the current implementation.

However, update the existing `saveMutation` to also include `family_discount` when saving categories, so discount config is not lost when saving categories:

In the `saveMutation.mutationFn`, change:
```jsx
const response = await prmApi.updateMembershipFeeSettings({ categories }, season);
```
To:
```jsx
const response = await prmApi.updateMembershipFeeSettings({ categories, family_discount: activeSeason?.family_discount }, season);
```

Wait -- actually the backend saves categories and family_discount independently (separate options). So family_discount being null on a categories-only save is fine (the backend skips saving when null). No change needed to the existing saveMutation.

**4. Add `useEffect` import:**
Update the import line at the top of the file from:
```jsx
import { useState } from 'react';
```
To:
```jsx
import { useState, useEffect } from 'react';
```

**Style notes:**
- All text in Dutch, consistent with existing UI
- Use same button styles as EditCategoryForm (accent for primary, gray for secondary)
- Blue info-card background matches AgeCoverageSummary pattern
- Percentage suffix (%) inside input field, right-aligned
  </action>
  <verify>
1. Run `npm run lint` from rondo-club/ -- expect 0 warnings
2. Run `npm run build` from rondo-club/ -- expect successful build
3. Deploy to production and verify:
   - Navigate to Settings > Beheer tab
   - Family discount section visible above category list
   - Shows 25% and 50% defaults
   - Change values and save -- success message appears
   - Switch season -- values may differ per season
   - Reload page -- saved values persist
   - Enter invalid value (e.g., 200) and save -- error message from API
  </verify>
  <done>
- FamilyDiscountSection component renders with two number inputs (second child %, third child+ %)
- Default values (25/50) displayed when no config exists
- Save persists to backend and shows success message
- Validation errors from API displayed in red error block
- Section works independently per season (current vs next)
- Existing category management unaffected
- Build and lint pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Update developer documentation and version</name>
  <files>style.css, package.json, CHANGELOG.md</files>
  <action>
**1. Update version numbers:**

In `style.css`, find the `Version:` line in the theme header comment and bump the minor version. If current is e.g., `20.6.0`, bump to `20.7.0` (or whatever the next minor version is -- read the file to determine current version).

In `package.json`, update the `"version"` field to match.

**2. Update CHANGELOG.md:**

Add an entry at the top of the changelog (below the header, above the most recent entry) in Keep a Changelog format:

```markdown
## [X.Y.0] - 2026-02-09

### Added
- Configurable family discount: admin can set second child and third child discount percentages per season
- Family discount configuration stored per season in WordPress options with fallback to defaults (25%/50%)
- FamilyDiscountSection component in fee category settings UI
- REST API validation for family discount percentages (0-100 range, warning if 2nd >= 3rd)

### Changed
- `get_family_discount_rate()` reads from per-season config instead of returning hardcoded values
- GET/POST `/rondo/v1/membership-fees/settings` now includes `family_discount` field
```

**3. Update developer documentation:**

Update the membership fees documentation at `../developer/src/content/docs/features/membership-fees.md` to document:
- The `rondo_family_discount_{season}` WordPress option and its structure
- The `get_family_discount_config()` and `save_family_discount_config()` helper methods
- The updated `get_family_discount_rate()` signature (now accepts optional season parameter)
- The REST API response now includes `family_discount` for both seasons
- The POST endpoint accepts optional `family_discount` parameter with validation

Keep the documentation concise and consistent with the existing style in that file.
  </action>
  <verify>
1. Version in style.css matches version in package.json
2. CHANGELOG.md has new entry with correct date and version
3. Developer docs file updated with family discount configuration details
4. `npm run build` still succeeds
  </verify>
  <done>
- Version bumped in style.css and package.json
- CHANGELOG.md has new entry documenting configurable family discount
- Developer documentation updated with new methods, option key, and API changes
  </done>
</task>

</tasks>

<verification>
1. Navigate to Settings > Beheer tab on production
2. Family discount section visible with 25%/50% defaults
3. Change second child to 30%, save -- success message appears
4. Reload page -- 30% persists
5. Switch to next season -- shows 25% (default, not configured yet)
6. Navigate to Contributie page -- fee calculations reflect updated discount
7. `npm run lint` passes with 0 warnings
8. `npm run build` succeeds
9. Version numbers consistent across style.css and package.json
</verification>

<success_criteria>
- Admin can configure family discount percentages (2nd child, 3rd+ child) per season in the UI
- Saved percentages are reflected in fee calculations
- Default behavior (25%/50%) preserved when no config exists
- Version bumped and changelog updated
- Developer documentation updated
</success_criteria>

<output>
After completion, create `.planning/phases/160-configurable-family-discount/160-02-SUMMARY.md`
</output>
