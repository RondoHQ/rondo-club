---
phase: 84-settings-person-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-google-contacts.php
  - includes/class-google-contacts-connection.php
  - includes/class-google-contacts-sync.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Person REST response includes google_contact_id field when linked"
    - "Sync operations store history entry after completion"
    - "Status endpoint returns sync_history array (last 10 entries)"
  artifacts:
    - path: "includes/class-rest-google-contacts.php"
      provides: "REST field registration and sync_history in status response"
      contains: "register_rest_field"
    - path: "includes/class-google-contacts-connection.php"
      provides: "add_sync_history_entry method"
      contains: "add_sync_history_entry"
    - path: "includes/class-google-contacts-sync.php"
      provides: "Sync history recording after sync operations"
      contains: "add_sync_history_entry"
  key_links:
    - from: "includes/class-google-contacts-sync.php"
      to: "GoogleContactsConnection::add_sync_history_entry"
      via: "Method call after sync_user completes"
      pattern: "add_sync_history_entry"
---

<objective>
Add backend infrastructure for sync history storage and expose google_contact_id to frontend.

Purpose: Enable frontend to display sync history and "View in Google" link on person pages.
Output: REST field for google_contact_id, sync_history storage in connection meta, sync_history in status endpoint.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/84-settings-person-ui/84-RESEARCH.md
@.planning/phases/84-settings-person-ui/84-CONTEXT.md

# Relevant source files
@includes/class-rest-google-contacts.php
@includes/class-google-contacts-connection.php
@includes/class-google-contacts-sync.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add google_contact_id REST field to person post type</name>
  <files>includes/class-rest-google-contacts.php</files>
  <action>
Add a new method `register_person_rest_fields()` and call it from constructor via `add_action('rest_api_init', ...)`.

Use `register_rest_field()` to expose `_google_contact_id` post meta on the `person` post type:

```php
register_rest_field('person', 'google_contact_id', [
    'get_callback' => function($post) {
        return get_post_meta($post['id'], '_google_contact_id', true) ?: null;
    },
    'schema' => [
        'description' => 'Google Contacts resource name for this person',
        'type' => ['string', 'null'],
        'context' => ['view', 'edit'],
    ],
]);
```

This exposes the existing `_google_contact_id` meta (set during import/export in Phases 80-81) to the REST API so PersonDetail can display "View in Google" link.
  </action>
  <verify>
Test with curl:
```bash
curl -s "https://cael.is/wp-json/wp/v2/person?per_page=1" -H "Cookie: [auth]" | jq '.[0].google_contact_id'
```
Should return the resourceName (e.g., "people/c12345") for a linked contact, or null for unlinked.
  </verify>
  <done>Person REST responses include google_contact_id field (string or null)</done>
</task>

<task type="auto">
  <name>Task 2: Add sync history storage and retrieval</name>
  <files>includes/class-google-contacts-connection.php, includes/class-google-contacts-sync.php</files>
  <action>
In `class-google-contacts-connection.php`, add static method to append sync history:

```php
/**
 * Add sync history entry (keeps last 10)
 *
 * @param int   $user_id User ID
 * @param array $entry   History entry with keys: timestamp, pulled, pushed, errors, duration_ms
 */
public static function add_sync_history_entry($user_id, $entry) {
    $connection = self::get_connection($user_id);
    $history = $connection['sync_history'] ?? [];

    // Prepend new entry
    array_unshift($history, $entry);

    // Keep only last 10
    $history = array_slice($history, 0, 10);

    self::update_connection($user_id, ['sync_history' => $history]);
}
```

In `class-google-contacts-sync.php`, modify `sync_user()` to record sync history after completion. At the end of sync_user(), before the return statement:

1. Calculate duration (add `$start_time = microtime(true)` at function start)
2. Build history entry from results
3. Call `GoogleContactsConnection::add_sync_history_entry()`

History entry structure:
```php
$history_entry = [
    'timestamp'   => current_time('c'),  // ISO 8601
    'pulled'      => $results['pull_stats']['contacts_imported'] ?? 0,
    'pushed'      => $results['push_stats']['pushed'] ?? 0,
    'errors'      => count($results['errors'] ?? []),
    'duration_ms' => (int)(($end_time - $start_time) * 1000),
];
```

Note: For errors count, check both `$results['errors']` and any errors in pull_stats/push_stats.
  </action>
  <verify>
Trigger a manual sync via Settings UI, then check user meta:
```bash
ssh u25-eninwxjgiulh@c1130624.sgvps.net -p 18765 "cd ~/www/cael.is/public_html && wp user meta get 1 _google_contacts_connection --format=json" | jq '.sync_history'
```
Should show array with at least one entry containing timestamp, pulled, pushed, errors, duration_ms.
  </verify>
  <done>Sync operations record history entry; connection meta contains sync_history array</done>
</task>

<task type="auto">
  <name>Task 3: Extend status endpoint to return sync_history</name>
  <files>includes/class-rest-google-contacts.php</files>
  <action>
In `get_status()` method, add `sync_history` to the response array:

```php
$response = [
    // ... existing fields ...
    'sync_history' => $connection['sync_history'] ?? [],
];
```

This enables the frontend to display the sync history log.

After all changes, run `npm run build` and deploy to production.
  </action>
  <verify>
Test status endpoint:
```bash
curl -s "https://cael.is/wp-json/rondo/v1/google-contacts/status" -H "Cookie: [auth]" | jq '.sync_history'
```
Should return array (empty if no syncs yet, or with entries after sync).
  </verify>
  <done>Status endpoint returns sync_history array in response</done>
</task>

</tasks>

<verification>
1. Person REST response includes google_contact_id field
2. Sync creates history entry in connection meta
3. Status endpoint returns sync_history array
4. Production deployed and working
</verification>

<success_criteria>
- Person with _google_contact_id meta returns that value in REST response
- Person without _google_contact_id meta returns null in REST response
- After sync, connection meta contains sync_history with entry
- Status endpoint response includes sync_history array
</success_criteria>

<output>
After completion, create `.planning/phases/84-settings-person-ui/84-01-SUMMARY.md`
</output>
