---
phase: 153-wire-up-role-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-api.php
  - src/hooks/useVolunteerRoleSettings.js
  - src/pages/Teams/TeamDetail.jsx
  - style.css
  - package.json
  - CHANGELOG.md
autonomous: true

must_haves:
  truths:
    - "Team detail page splits members into players and staff using configured player roles from settings API"
    - "Non-admin authenticated users can fetch role settings from /rondo/v1/volunteer-roles/settings"
    - "Hardcoded playerRoles array is completely removed from TeamDetail.jsx"
  artifacts:
    - path: "src/hooks/useVolunteerRoleSettings.js"
      provides: "TanStack Query hook for fetching role settings"
      exports: ["useVolunteerRoleSettings", "volunteerRoleKeys"]
    - path: "includes/class-rest-api.php"
      provides: "Updated permission callback for GET volunteer-roles/settings"
      contains: "check_user_approved"
  key_links:
    - from: "src/hooks/useVolunteerRoleSettings.js"
      to: "/rondo/v1/volunteer-roles/settings"
      via: "prmApi.getVolunteerRoleSettings()"
      pattern: "prmApi\\.getVolunteerRoleSettings"
    - from: "src/pages/Teams/TeamDetail.jsx"
      to: "src/hooks/useVolunteerRoleSettings.js"
      via: "useVolunteerRoleSettings hook import"
      pattern: "useVolunteerRoleSettings"
---

<objective>
Replace the last hardcoded player roles array in the frontend with a settings-driven lookup from the existing REST API endpoint.

Purpose: Team detail page currently has a hardcoded array of 9 Dutch role names to split members into players vs staff. This must read from the configured settings so any club can customize which roles count as "player" without code changes.

Output: TeamDetail.jsx uses role settings from API, permission fix allows all authenticated users to read settings.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/153-wire-up-role-settings/153-CONTEXT.md
@.planning/phases/153-wire-up-role-settings/153-RESEARCH.md
@src/hooks/useFees.js
@src/hooks/usePeople.js
@src/pages/Teams/TeamDetail.jsx
@includes/class-rest-api.php
@includes/class-rest-base.php
@src/api/client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix API permission and create useVolunteerRoleSettings hook</name>
  <files>includes/class-rest-api.php, src/hooks/useVolunteerRoleSettings.js</files>
  <action>
**Backend permission fix (class-rest-api.php):**

On line 763, the GET endpoint for `/rondo/v1/volunteer-roles/settings` uses `check_admin_permission`. Change ONLY the GET endpoint's permission_callback to `check_user_approved` so all authenticated users can read role settings. Keep the POST endpoint (line 768) as `check_admin_permission` since only admins should update settings.

Change line 763 from:
```php
'permission_callback' => [ $this, 'check_admin_permission' ],
```
to:
```php
'permission_callback' => [ $this, 'check_user_approved' ],
```

Also update the comment above the route registration (line 755) from "Volunteer role classification settings (admin only)" to "Volunteer role classification settings (read: all users, write: admin)".

**Frontend hook (src/hooks/useVolunteerRoleSettings.js):**

Create a new hook file following the exact pattern from `src/hooks/useFees.js`:

1. Import `useQuery` from `@tanstack/react-query` and `prmApi` from `@/api/client`
2. Export `volunteerRoleKeys` object with:
   - `all: ['volunteer-roles']`
   - `settings: () => [...volunteerRoleKeys.all, 'settings']`
3. Export `useVolunteerRoleSettings()` function that:
   - Uses `useQuery` with `queryKey: volunteerRoleKeys.settings()`
   - Calls `prmApi.getVolunteerRoleSettings()` as queryFn
   - Sets `staleTime: 5 * 60 * 1000` (5 minutes, matching the pattern in usePeople.js line 176 for rarely-changing settings)
   - Returns the query result

The API client method `prmApi.getVolunteerRoleSettings()` already exists in `src/api/client.js` (lines 289-292) -- do NOT modify client.js.
  </action>
  <verify>
Run `npm run lint` from `rondo-club/` to verify no lint errors in the new hook file.
Verify the hook file exists and exports the correct function: `grep -c "export function useVolunteerRoleSettings" src/hooks/useVolunteerRoleSettings.js` should return 1.
Verify the permission change: `grep "check_user_approved" includes/class-rest-api.php` should include the volunteer-roles settings line.
  </verify>
  <done>
New hook file `src/hooks/useVolunteerRoleSettings.js` exists with exported `useVolunteerRoleSettings` function and `volunteerRoleKeys` query key factory. GET endpoint for `/rondo/v1/volunteer-roles/settings` uses `check_user_approved` permission. POST endpoint remains `check_admin_permission`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire TeamDetail to use settings, version bump, changelog, docs, build, deploy</name>
  <files>src/pages/Teams/TeamDetail.jsx, style.css, package.json, CHANGELOG.md</files>
  <action>
**TeamDetail.jsx update:**

1. Add import at top of file: `import { useVolunteerRoleSettings } from '@/hooks/useVolunteerRoleSettings';`

2. Inside the TeamDetail component, add the hook call alongside the existing queries (near the other `useQuery` calls):
   ```js
   const { data: roleSettings } = useVolunteerRoleSettings();
   ```

3. Replace the hardcoded block on line 330:
   ```js
   const playerRoles = ['Aanvaller', 'Verdediger', 'Keeper', 'Middenvelder', 'Teamspeler', 'Speler', 'Champions league', 'Zondag recranten', 'Zaterdag recreanten'];
   ```
   with:
   ```js
   const playerRoles = roleSettings?.player_roles || [];
   ```

4. Leave everything else in the members section unchanged -- the `isPlayerRole` function, the `players`/`staff` split, and the rendering logic all remain the same.

**Version bump:**

Bump version from `19.1.0` to `19.2.0` (minor: new feature -- settings-driven role lookup in frontend) in both `style.css` (Theme Version header) and `package.json`.

**Changelog update:**

Under the `## [Unreleased]` section, add entries (these will be released as part of the Unreleased batch). Under `### Changed`:
- "Team detail page player/staff split now reads from configured role settings instead of hardcoded array"

Under `### Fixed`:
- "Volunteer role settings API endpoint now accessible to all authenticated users (was admin-only for GET)"

**Documentation:**

Check if `docs/rest-api.md` documents the volunteer-roles endpoint. If it does, update the permission description for the GET endpoint. If it does not document it, no doc change needed for this endpoint.

**Build and deploy:**

1. Run `npm run build` to produce production assets
2. Run `bin/deploy.sh` to deploy to production
  </action>
  <verify>
Run `npm run lint` -- should pass with zero warnings.
Run `npm run build` -- should complete without errors.
Verify hardcoded array is gone: `grep -c "Aanvaller" src/pages/Teams/TeamDetail.jsx` should return 0.
Verify hook is imported: `grep "useVolunteerRoleSettings" src/pages/Teams/TeamDetail.jsx` should show the import line.
After deploy, verify production is accessible.
  </verify>
  <done>
TeamDetail.jsx uses `useVolunteerRoleSettings` hook to fetch player roles from settings API. Hardcoded 9-element `playerRoles` array is completely removed. Version bumped to 19.2.0. Changelog updated. Production deployed.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run lint` passes with zero warnings
2. `npm run build` completes successfully
3. No hardcoded player role names remain in `TeamDetail.jsx` (grep for 'Aanvaller', 'Verdediger', 'Keeper' returns 0)
4. `useVolunteerRoleSettings` hook exists and is imported in TeamDetail
5. GET `/rondo/v1/volunteer-roles/settings` uses `check_user_approved` permission
6. POST `/rondo/v1/volunteer-roles/settings` still uses `check_admin_permission`
7. Production deployed and accessible
</verification>

<success_criteria>
- Team detail page splits members into players and staff using configured player roles from the settings API (not hardcoded)
- Non-admin users can view team detail page with correct player/staff split (no 403 errors on settings endpoint)
- Empty array fallback ensures graceful degradation if settings unavailable (all members shown as staff)
- Version 19.2.0 in style.css and package.json
- Changelog documents the change
</success_criteria>

<output>
After completion, create `.planning/phases/153-wire-up-role-settings/153-01-SUMMARY.md`
</output>
