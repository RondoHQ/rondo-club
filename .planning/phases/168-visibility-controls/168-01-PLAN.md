---
phase: 168-visibility-controls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-people.php
  - includes/class-rest-api.php
  - includes/class-rest-base.php
  - src/hooks/usePeople.js
  - src/pages/People/PeopleList.jsx
  - src/components/layout/Layout.jsx
  - ../developer/src/content/docs/features/former-members.md
autonomous: true

must_haves:
  truths:
    - "Leden list has a 'Toon oud-leden' toggle in the filter dropdown"
    - "When toggle is enabled, former members appear in the list with visual distinction"
    - "When toggle is disabled (default), former members are hidden"
    - "Global search includes former members with 'oud-lid' indicator"
    - "Former members are easily discoverable when needed"
  artifacts:
    - path: "includes/class-rest-people.php"
      provides: "include_former parameter on filtered endpoint"
      contains: "include_former"
    - path: "includes/class-rest-api.php"
      provides: "former_member flag in global search results"
      contains: "former_member"
    - path: "includes/class-rest-base.php"
      provides: "former_member field in person summary format"
      contains: "former_member"
    - path: "src/pages/People/PeopleList.jsx"
      provides: "Toon oud-leden toggle UI and visual distinction styling"
      contains: "oud-leden"
    - path: "src/components/layout/Layout.jsx"
      provides: "Oud-lid badge in search results"
      contains: "oud-lid"
  key_links:
    - from: "src/pages/People/PeopleList.jsx"
      to: "/rondo/v1/people/filtered?include_former=1"
      via: "useFilteredPeople hook with includeFormer param"
      pattern: "include_former"
    - from: "src/components/layout/Layout.jsx"
      to: "searchResults.people[].former_member"
      via: "SearchModal reads former_member flag from API"
      pattern: "former_member"
    - from: "includes/class-rest-api.php"
      to: "includes/class-rest-base.php"
      via: "format_person_summary includes former_member"
      pattern: "former_member"
---

<objective>
Add visibility controls for former members: a "Toon oud-leden" toggle on the Leden list filter dropdown and "oud-lid" indicator in global search results.

Purpose: Users need to be able to find former members when needed (e.g., when a former member contacts the club), even though they are hidden from default views by Phase 167's filtering.

Output: Backend parameters for including former members, frontend toggle and visual indicators.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/167-core-filtering/167-01-SUMMARY.md

Key codebase context:
- includes/class-rest-people.php: Filtered people endpoint with SQL query builder (line ~968-1024 for former_member exclusion)
- includes/class-rest-api.php: Global search at global_search() method (line ~1631-1868), uses 5 queries without former_member filtering
- includes/class-rest-base.php: format_person_summary() (line ~199-208) returns id, name, first_name, last_name, thumbnail, labels
- src/hooks/usePeople.js: useFilteredPeople hook (line ~120-160) sends params to /rondo/v1/people/filtered
- src/pages/People/PeopleList.jsx: Filter dropdown (line ~1146-1385), URL-based filter state (line ~632-731), hasActiveFilters (line ~918)
- src/components/layout/Layout.jsx: SearchModal (line ~236-435), renders people results with name and thumbnail
- src/hooks/useDashboard.js: useSearch hook (line ~77-93) calls /rondo/v1/search
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add include_former parameter and former_member flag to backend</name>
  <files>
    includes/class-rest-people.php
    includes/class-rest-api.php
    includes/class-rest-base.php
  </files>
  <action>
    **1. Add `include_former` parameter to filtered people endpoint (class-rest-people.php):**

    In the `register_rest_routes()` method, add a new parameter to the `/people/filtered` route args (after `vog_justis_status`):
    ```php
    'include_former' => [
        'description'       => 'Include former members in results (1=include, empty=exclude)',
        'type'              => 'string',
        'default'           => '',
        'sanitize_callback' => 'sanitize_text_field',
        'validate_callback' => function ( $value ) {
            return in_array( $value, [ '', '1' ], true );
        },
    ],
    ```

    In `get_filtered_people()`, after extracting `$vog_justis_status` (around line 992), add:
    ```php
    $include_former = $request->get_param( 'include_former' );
    ```

    Then modify the former member exclusion block (around lines 1022-1024). Change from always excluding to conditional:
    ```php
    // Former member handling
    $join_clauses[] = "LEFT JOIN {$wpdb->postmeta} fm ON p.ID = fm.post_id AND fm.meta_key = 'former_member'";
    if ( $include_former !== '1' ) {
        // Default: exclude former members
        $where_clauses[] = "(fm.meta_value IS NULL OR fm.meta_value = '' OR fm.meta_value = '0')";
    }
    ```

    The LEFT JOIN for `fm` is kept in both cases because the `fm.meta_value` is needed in the SELECT for the response (see below).

    In the SELECT fields section (around line 1014), add `fm.meta_value AS is_former_member` to `$select_fields`:
    ```php
    $select_fields = 'p.ID, p.post_modified, p.post_author';
    ```
    Becomes:
    ```php
    $select_fields = 'p.ID, p.post_modified, p.post_author, fm.meta_value AS is_former_member';
    ```
    Note: The `fm` JOIN is already present (added in Phase 167). But we need to ensure `fm` is joined BEFORE `fn`, `ix`, `ln` since it references `fm`. Move the former member JOIN block above the name JOIN block if it is not already.

    In the person data formatting loop where each person row is built for the response (around lines 1280-1310), add `former_member` to each person entry. Find where person data is assembled and add:
    ```php
    'former_member' => ( $row->is_former_member === '1' ),
    ```
    Look for the pattern where person array is constructed with keys like `id`, `name`, `first_name`, etc. and add `former_member` as a boolean.

    **2. Include former members in global search (class-rest-api.php):**

    The global search function `global_search()` (around line 1631) runs 5 `get_posts()` queries for people. Currently none of these queries exclude or include former members - they all return ALL people (the Phase 167 filtering only applied to the filtered endpoint, dashboard, and team rosters).

    This is actually correct - the search already includes former members by default. However, we need the search results to include the `former_member` flag so the frontend can show the "oud-lid" indicator.

    The search results use `format_person_summary()` from class-rest-base.php. Update that method to include the former_member field.

    **3. Add `former_member` to format_person_summary() (class-rest-base.php):**

    In `format_person_summary()` (line 199), add a `former_member` field:
    ```php
    protected function format_person_summary( $post ) {
        return [
            'id'             => $post->ID,
            'name'           => $this->sanitize_text( $post->post_title ),
            'first_name'     => $this->sanitize_text( get_field( 'first_name', $post->ID ) ),
            'last_name'      => $this->sanitize_text( get_field( 'last_name', $post->ID ) ),
            'thumbnail'      => $this->sanitize_url( get_the_post_thumbnail_url( $post->ID, 'thumbnail' ) ),
            'labels'         => wp_get_post_terms( $post->ID, 'person_label', [ 'fields' => 'names' ] ),
            'former_member'  => ( get_field( 'former_member', $post->ID ) == true ),
        ];
    }
    ```
    Use `== true` (loose comparison) because ACF true_false fields return '1' as a string when true.

    This ensures both global search results AND dashboard recent people/recently contacted results include the former_member flag.
  </action>
  <verify>
    Deploy to production and test:
    1. `curl` the filtered people endpoint with `include_former=1` and verify former members appear in results with `former_member: true`
    2. `curl` the filtered people endpoint without the parameter and verify former members are excluded
    3. `curl` the search endpoint and verify former members appear with `former_member: true` in the response
    4. Run `npm run build` to verify no build errors
  </verify>
  <done>
    Filtered people endpoint accepts include_former=1 to include former members. format_person_summary includes former_member boolean. Global search results include former_member flag.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Toon oud-leden toggle and search indicator in frontend</name>
  <files>
    src/hooks/usePeople.js
    src/pages/People/PeopleList.jsx
    src/components/layout/Layout.jsx
    ../developer/src/content/docs/features/former-members.md
  </files>
  <action>
    **1. Add includeFormer param to useFilteredPeople (src/hooks/usePeople.js):**

    In the `useFilteredPeople` function (line ~122), add to the params object:
    ```js
    include_former: filters.includeFormer || null,
    ```

    **2. Add "Toon oud-leden" toggle to PeopleList (src/pages/People/PeopleList.jsx):**

    a) Parse the new filter from URL (around line 655, after `vogOlderThanYears`):
    ```js
    const includeFormer = searchParams.get('oudLeden') || '';
    ```

    b) Add setter (around line 730, after `setVogOlderThanYears`):
    ```js
    const setIncludeFormer = useCallback((value) => {
      updateSearchParams({ oudLeden: value });
    }, [updateSearchParams]);
    ```

    c) Pass `includeFormer` to `useFilteredPeople` call (around line 763). Add to the filters object:
    ```js
    includeFormer: includeFormer || null,
    ```

    d) Add `includeFormer` to `hasActiveFilters` calculation (around line 918). Append:
    ```js
    || includeFormer
    ```

    e) Update the active filter count badge (around line 1139). Add `+ (includeFormer ? 1 : 0)` to the count.

    f) Add the toggle UI in the filter dropdown. Place it at the TOP of the filter dropdown content (before Labels), as a prominent toggle. After the opening `<div className="p-4 space-y-4">` (around line 1152), add:
    ```jsx
    {/* Former Members Toggle */}
    <div>
      <label className="flex items-center cursor-pointer">
        <div className="relative">
          <input
            type="checkbox"
            checked={includeFormer === '1'}
            onChange={() => setIncludeFormer(includeFormer === '1' ? '' : '1')}
            className="sr-only peer"
          />
          <div className="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:bg-electric-cyan transition-colors"></div>
          <div className="absolute left-[2px] top-[2px] bg-white w-4 h-4 rounded-full transition-transform peer-checked:translate-x-4"></div>
        </div>
        <span className="ml-3 text-sm font-medium text-gray-700 dark:text-gray-200">Toon oud-leden</span>
      </label>
    </div>
    ```

    g) Add `includeFormer` to the `clearFilters` function (around line 961). Add:
    ```js
    setIncludeFormer('');
    ```

    h) Add `includeFormer` to the selection reset useEffect dependency array (around line 1002).

    i) Visual distinction for former members in the list rows. In the `PersonListRow` component (around line 62), add an "Oud-lid" badge next to the person's name. Find the name cell (around line 100-101) where the person's name is rendered. After the name span, add a conditional badge:
    ```jsx
    {person.former_member && (
      <span className="ml-2 inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-gray-200 text-gray-600 dark:bg-gray-600 dark:text-gray-300">
        Oud-lid
      </span>
    )}
    ```

    Also add a subtle opacity/style change to the entire row when it's a former member. Update the row's `<tr>` className to include opacity reduction:
    ```jsx
    <tr className={`hover:bg-gray-100 dark:hover:bg-gray-700 ${isOdd ? 'bg-gray-50 dark:bg-gray-800/50' : 'bg-white dark:bg-gray-800'} ${person.former_member ? 'opacity-60' : ''}`}>
    ```

    j) Add `includeFormer` to the export filter params (around line 1076) if it is set:
    ```js
    include_former: includeFormer || undefined,
    ```

    **3. Add "oud-lid" indicator in SearchModal (src/components/layout/Layout.jsx):**

    In the SearchModal people results rendering (around line 378-380), after the person name span, add:
    ```jsx
    {person.former_member && (
      <span className="ml-2 inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-gray-200 text-gray-600 dark:bg-gray-600 dark:text-gray-300 flex-shrink-0">
        Oud-lid
      </span>
    )}
    ```

    **4. Create former-members developer documentation:**

    Create `../developer/src/content/docs/features/former-members.md` with Starlight frontmatter documenting:
    - The former_member ACF field (readonly, managed by rondo-sync)
    - How former members are excluded by default (Phase 167 SQL/meta_query patterns)
    - The include_former parameter on /rondo/v1/people/filtered
    - The former_member flag in format_person_summary (affects search, dashboard)
    - UI: "Toon oud-leden" filter toggle and "Oud-lid" badge styling

    **5. Update version and changelog:**

    Update version to 23.1.0 in both `style.css` and `package.json`.
    Add changelog entry for the new former member visibility controls.

    **6. Build:**

    Run `npm run build` to create production assets.
  </action>
  <verify>
    1. `npm run build` succeeds without errors
    2. `npm run lint` runs (note: pre-existing lint issues expected, but no NEW errors should be introduced)
    3. Deploy to production and verify:
       a. Leden list filter dropdown shows "Toon oud-leden" toggle at the top
       b. Toggling shows former members with "Oud-lid" badge and reduced opacity
       c. Toggling off hides former members again
       d. Global search shows "Oud-lid" badge next to former member names
       e. Filter count badge increments when toggle is active
       f. "Clear filters" resets the toggle
  </verify>
  <done>
    Leden list has "Toon oud-leden" toggle that shows former members with visual distinction. Global search shows "Oud-lid" indicator for former members. Version bumped and changelog updated.
  </done>
</task>

</tasks>

<verification>
1. Filtered people endpoint: Default request excludes former members; `include_former=1` includes them with `former_member: true`
2. Global search: Former members appear in results with `former_member: true` flag
3. Leden list: Filter dropdown has "Toon oud-leden" toggle at the top
4. Leden list: Former members shown with "Oud-lid" badge and reduced opacity when toggle is on
5. Leden list: Toggle state persisted in URL params (`?oudLeden=1`)
6. Leden list: "Clear filters" resets the toggle
7. Search modal: Former members shown with "Oud-lid" badge
8. `npm run build` succeeds
</verification>

<success_criteria>
Users can find former members through the "Toon oud-leden" filter toggle on the Leden list and through global search with "oud-lid" visual indicator. Former members are hidden by default but easily discoverable when needed.
</success_criteria>

<output>
After completion, create `.planning/phases/168-visibility-controls/168-01-SUMMARY.md`
</output>
