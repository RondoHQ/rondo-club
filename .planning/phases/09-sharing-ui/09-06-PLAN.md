---
phase: 09-sharing-ui
plan: 06
type: execute
depends_on: ["09-01"]
files_modified: [src/pages/People/PeopleList.jsx, src/pages/Companies/CompaniesList.jsx]
---

<objective>
Add visibility and workspace filtering to People and Companies list views.

Purpose: Enable users to filter contacts by ownership (All, My Contacts, Shared with Me) and by workspace.
Output: Enhanced list views with filter options for visibility and workspace membership.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-sharing-ui/09-01-SUMMARY.md
@.planning/phases/07-data-model-visibility/07-04-SUMMARY.md
@src/pages/People/PeopleList.jsx
@src/pages/Companies/CompaniesList.jsx
@src/hooks/useWorkspaces.js

**Current Filter Implementation (PeopleList.jsx):**
- Filter dropdown with favorites, labels, birth year, last modified
- Uses local state for filter values
- Client-side filtering via useMemo on fetched data

**Available Data (from access control extension 07-04):**
- Posts now include visibility info accessible to frontend
- Need to add _visibility, _shared_with to REST response

**Note:** The current REST API may not expose _visibility and _shared_with fields. We may need to:
1. Add these fields to the REST response on the backend, OR
2. Filter based on ownership (author_id === current_user_id) for "My Contacts"

For this plan, we'll implement client-side filtering based on what data is available. If _visibility isn't exposed, we'll use author comparison.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add visibility/ownership filter to PeopleList</name>
  <files>src/pages/People/PeopleList.jsx</files>
  <action>
Add ownership/visibility filter to the existing filter dropdown:

1. Add new state for ownership filter:
```javascript
const [ownershipFilter, setOwnershipFilter] = useState('all'); // 'all', 'mine', 'shared'
const [selectedWorkspaceFilter, setSelectedWorkspaceFilter] = useState('');
```

2. Import useWorkspaces and get current user:
```javascript
import { useWorkspaces } from '@/hooks/useWorkspaces';
```

In the component:
```javascript
const { data: workspaces = [] } = useWorkspaces();

// Get current user ID from stadionConfig
const currentUserId = window.stadionConfig?.userId;
```

3. Add the ownership filter section to the filter dropdown (before or after Labels section):
```jsx
{/* Ownership Filter */}
<div>
  <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">
    Ownership
  </h3>
  <div className="space-y-1">
    {[
      { value: 'all', label: 'All Contacts' },
      { value: 'mine', label: 'My Contacts' },
      { value: 'shared', label: 'Shared with Me' },
    ].map(option => (
      <label
        key={option.value}
        className="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"
      >
        <input
          type="radio"
          name="ownership"
          value={option.value}
          checked={ownershipFilter === option.value}
          onChange={(e) => setOwnershipFilter(e.target.value)}
          className="sr-only"
        />
        <div className={`flex items-center justify-center w-4 h-4 border-2 rounded-full mr-3 ${
          ownershipFilter === option.value
            ? 'border-primary-600'
            : 'border-gray-300'
        }`}>
          {ownershipFilter === option.value && (
            <div className="w-2 h-2 bg-primary-600 rounded-full" />
          )}
        </div>
        <span className="text-sm text-gray-700">{option.label}</span>
      </label>
    ))}
  </div>
</div>
```

4. Add workspace filter dropdown (only shows if user has workspaces):
```jsx
{/* Workspace Filter */}
{workspaces.length > 0 && (
  <div>
    <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">
      Workspace
    </h3>
    <select
      value={selectedWorkspaceFilter}
      onChange={(e) => setSelectedWorkspaceFilter(e.target.value)}
      className="w-full text-sm border border-gray-300 rounded-lg px-3 py-2 focus:ring-primary-500 focus:border-primary-500"
    >
      <option value="">All Workspaces</option>
      {workspaces.map(ws => (
        <option key={ws.id} value={ws.id}>{ws.title}</option>
      ))}
    </select>
  </div>
)}
```

5. Update the filtering logic in the useMemo that creates filteredAndSortedPeople:
```javascript
// Apply ownership filter
if (ownershipFilter === 'mine') {
  filtered = filtered.filter(person => person.author === currentUserId);
} else if (ownershipFilter === 'shared') {
  filtered = filtered.filter(person => person.author !== currentUserId);
}

// Apply workspace filter
if (selectedWorkspaceFilter) {
  // Filter by workspace assignment
  // This requires the _assigned_workspaces or workspace_access terms to be in the REST response
  // If not available, we'll need to check visibility = 'workspace' and assigned workspaces
  filtered = filtered.filter(person => {
    const assignedWorkspaces = person.acf?._assigned_workspaces || [];
    return assignedWorkspaces.includes(parseInt(selectedWorkspaceFilter));
  });
}
```

6. Update hasActiveFilters to include new filters:
```javascript
const hasActiveFilters = showFavoritesOnly || selectedLabels.length > 0 || selectedBirthYear || lastModifiedFilter || ownershipFilter !== 'all' || selectedWorkspaceFilter;
```

7. Update clearFilters to reset new filters:
```javascript
const clearFilters = () => {
  setShowFavoritesOnly(false);
  setSelectedLabels([]);
  setSelectedBirthYear('');
  setLastModifiedFilter('');
  setOwnershipFilter('all');
  setSelectedWorkspaceFilter('');
};
```

8. Add filter chips for active ownership/workspace filters:
```jsx
{ownershipFilter !== 'all' && (
  <span className="inline-flex items-center gap-1 px-2 py-1 bg-primary-100 text-primary-800 rounded-full text-xs">
    {ownershipFilter === 'mine' ? 'My Contacts' : 'Shared with Me'}
    <button onClick={() => setOwnershipFilter('all')} className="hover:text-primary-600">
      <X className="w-3 h-3" />
    </button>
  </span>
)}
{selectedWorkspaceFilter && (
  <span className="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">
    {workspaces.find(ws => ws.id === parseInt(selectedWorkspaceFilter))?.title || 'Workspace'}
    <button onClick={() => setSelectedWorkspaceFilter('')} className="hover:text-blue-600">
      <X className="w-3 h-3" />
    </button>
  </span>
)}
```

Note: The `author` field should be available in the REST response. If not, we may need to add it to the _fields parameter in the API call or ensure it's included in the REST response on the backend.
  </action>
  <verify>Open PeopleList, verify ownership and workspace filters appear in filter dropdown</verify>
  <done>PeopleList includes ownership and workspace filtering</done>
</task>

<task type="auto">
  <name>Task 2: Add visibility/ownership filter to CompaniesList</name>
  <files>src/pages/Companies/CompaniesList.jsx</files>
  <action>
Apply the same filtering pattern to CompaniesList.jsx:

1. Add state for ownership and workspace filters:
```javascript
const [ownershipFilter, setOwnershipFilter] = useState('all');
const [selectedWorkspaceFilter, setSelectedWorkspaceFilter] = useState('');
```

2. Import and use hooks:
```javascript
import { useWorkspaces } from '@/hooks/useWorkspaces';

// In component:
const { data: workspaces = [] } = useWorkspaces();
const currentUserId = window.stadionConfig?.userId;
```

3. Add the ownership filter section to the filter dropdown (same JSX as PeopleList).

4. Add workspace filter dropdown (same JSX as PeopleList).

5. Update the filtering logic in useMemo for filteredAndSortedCompanies:
```javascript
// Apply ownership filter
if (ownershipFilter === 'mine') {
  filtered = filtered.filter(company => company.author === currentUserId);
} else if (ownershipFilter === 'shared') {
  filtered = filtered.filter(company => company.author !== currentUserId);
}

// Apply workspace filter
if (selectedWorkspaceFilter) {
  filtered = filtered.filter(company => {
    const assignedWorkspaces = company.acf?._assigned_workspaces || [];
    return assignedWorkspaces.includes(parseInt(selectedWorkspaceFilter));
  });
}
```

6. Update hasActiveFilters and clearFilters to include new filters.

7. Add filter chips for active ownership/workspace filters.

Note: CompaniesList may have a different existing filter structure than PeopleList. Adapt the implementation to match the existing patterns in that file while adding the new ownership/workspace filters.
  </action>
  <verify>Open CompaniesList, verify ownership and workspace filters work</verify>
  <done>CompaniesList includes ownership and workspace filtering</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Ownership and workspace filtering added to both PeopleList and CompaniesList pages</what-built>
  <how-to-verify>
    1. Run: `npm run dev`
    2. Go to People page
    3. Click Filter button
    4. Verify: "Ownership" section appears with All/My Contacts/Shared options
    5. Select "My Contacts" - should only show contacts you created
    6. Select "Shared with Me" - should show contacts shared by others (if any)
    7. If you have workspaces: verify "Workspace" dropdown appears
    8. Select a workspace - should filter to contacts in that workspace
    9. Verify filter chips appear and can be cleared
    10. Click "Clear all filters" - all filters reset
    11. Repeat steps 2-10 for Companies page
    12. Check browser console for errors
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run lint` passes
- [ ] `npm run build` succeeds
- [ ] PeopleList has ownership filter (All/My/Shared)
- [ ] PeopleList has workspace filter dropdown
- [ ] CompaniesList has ownership filter
- [ ] CompaniesList has workspace filter
- [ ] Filter chips display and can be cleared
- [ ] Clear all filters resets everything
</verification>

<success_criteria>

- Ownership filter working on PeopleList
- Ownership filter working on CompaniesList
- Workspace filter working on both lists
- Filter chips visible when filters active
- Human verification passed
- Phase 9 complete
</success_criteria>

<output>
After completion, create `.planning/phases/09-sharing-ui/09-06-SUMMARY.md`

This completes Phase 9: Sharing UI & Permissions Interface.
</output>
