---
phase: 09-sharing-ui
plan: 05
type: execute
depends_on: ["09-04"]
files_modified: [src/pages/Workspaces/WorkspaceSettings.jsx, src/pages/Workspaces/WorkspaceInviteAccept.jsx, src/App.jsx]
---

<objective>
Create workspace settings page and invite acceptance flow.

Purpose: Allow workspace owners to manage settings and enable users to accept workspace invitations via email links.
Output: WorkspaceSettings page for owners, WorkspaceInviteAccept public page for invitation flow.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-sharing-ui/09-04-SUMMARY.md
@.planning/phases/08-workspace-infrastructure/08-02-SUMMARY.md
@src/App.jsx
@src/hooks/useWorkspaces.js

**Available Hooks:**
- useWorkspace(id) - Get workspace details
- useUpdateWorkspace() - Update workspace
- useDeleteWorkspace() - Delete workspace
- useValidateInvite(token) - Validate invite token (public)
- useAcceptInvite() - Accept invite mutation

**Invite Accept URL Pattern (from 08-02):**
React Router: `/workspace-invite/{token}`
Email contains link to this URL
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WorkspaceSettings page</name>
  <files>src/pages/Workspaces/WorkspaceSettings.jsx</files>
  <action>
Create the settings page for workspace owners:

```javascript
import { useState, useEffect } from 'react';
import { useParams, useNavigate, Link } from 'react-router-dom';
import { useForm } from 'react-hook-form';
import { ArrowLeft, Trash2, AlertTriangle, LogOut } from 'lucide-react';
import { useWorkspace, useUpdateWorkspace, useDeleteWorkspace, useRemoveWorkspaceMember } from '@/hooks/useWorkspaces';
import { useQuery } from '@tanstack/react-query';
import { prmApi } from '@/api/client';

export default function WorkspaceSettings() {
  const { id } = useParams();
  const navigate = useNavigate();
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
  const [deleteConfirmText, setDeleteConfirmText] = useState('');

  const { data: workspace, isLoading, error } = useWorkspace(id);
  const { data: currentUser } = useQuery({
    queryKey: ['current-user'],
    queryFn: async () => {
      const response = await prmApi.getCurrentUser();
      return response.data;
    },
  });

  const updateMutation = useUpdateWorkspace();
  const deleteMutation = useDeleteWorkspace();
  const leaveMutation = useRemoveWorkspaceMember();

  const { register, handleSubmit, reset, formState: { errors, isDirty } } = useForm();

  // Populate form when workspace loads
  useEffect(() => {
    if (workspace) {
      reset({
        title: workspace.title,
        description: workspace.description || '',
      });
    }
  }, [workspace, reset]);

  const onSubmit = async (data) => {
    await updateMutation.mutateAsync({
      id: parseInt(id),
      data: {
        title: data.title,
        content: data.description,
      },
    });
  };

  const handleDelete = async () => {
    if (deleteConfirmText !== workspace.title) return;

    await deleteMutation.mutateAsync(parseInt(id));
    navigate('/workspaces');
  };

  const handleLeave = async () => {
    if (!confirm('Are you sure you want to leave this workspace?')) return;

    await leaveMutation.mutateAsync({
      workspaceId: parseInt(id),
      userId: currentUser.id,
    });
    navigate('/workspaces');
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
      </div>
    );
  }

  if (error || !workspace) {
    return (
      <div className="card p-6 text-center">
        <p className="text-red-600">Failed to load workspace.</p>
        <Link to="/workspaces" className="text-primary-600 hover:underline mt-2 inline-block">
          Back to Workspaces
        </Link>
      </div>
    );
  }

  const isOwner = workspace.current_user?.is_owner;

  // Non-owners can't access settings (should be caught by route, but just in case)
  if (!isOwner) {
    return (
      <div className="card p-6 text-center">
        <p className="text-gray-600">Only workspace owners can access settings.</p>
        <Link to={`/workspaces/${id}`} className="text-primary-600 hover:underline mt-2 inline-block">
          Back to Workspace
        </Link>
      </div>
    );
  }

  return (
    <div className="max-w-2xl mx-auto space-y-6">
      {/* Header */}
      <div>
        <button
          onClick={() => navigate(`/workspaces/${id}`)}
          className="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-700 mb-2"
        >
          <ArrowLeft className="w-4 h-4" />
          Back to Workspace
        </button>
        <h1 className="text-2xl font-semibold text-gray-900">Workspace Settings</h1>
        <p className="text-gray-500 mt-1">{workspace.title}</p>
      </div>

      {/* General Settings */}
      <div className="card">
        <div className="px-6 py-4 border-b border-gray-200">
          <h2 className="text-lg font-medium text-gray-900">General</h2>
        </div>
        <form onSubmit={handleSubmit(onSubmit)} className="p-6 space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Workspace Name *
            </label>
            <input
              type="text"
              {...register('title', { required: 'Name is required' })}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            />
            {errors.title && (
              <p className="mt-1 text-sm text-red-600">{errors.title.message}</p>
            )}
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Description
            </label>
            <textarea
              {...register('description')}
              rows={3}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            />
          </div>

          <div className="flex justify-end">
            <button
              type="submit"
              disabled={!isDirty || updateMutation.isPending}
              className="btn-primary disabled:opacity-50"
            >
              {updateMutation.isPending ? 'Saving...' : 'Save Changes'}
            </button>
          </div>
        </form>
      </div>

      {/* Leave Workspace (for non-owners who somehow got here) */}
      {!isOwner && (
        <div className="card border-yellow-200 bg-yellow-50">
          <div className="p-6">
            <div className="flex items-start gap-4">
              <LogOut className="w-6 h-6 text-yellow-600 flex-shrink-0" />
              <div className="flex-1">
                <h3 className="text-lg font-medium text-gray-900">Leave Workspace</h3>
                <p className="text-sm text-gray-600 mt-1">
                  You will lose access to all contacts shared in this workspace.
                </p>
                <button
                  onClick={handleLeave}
                  disabled={leaveMutation.isPending}
                  className="mt-4 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 disabled:opacity-50"
                >
                  {leaveMutation.isPending ? 'Leaving...' : 'Leave Workspace'}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Danger Zone */}
      {isOwner && (
        <div className="card border-red-200">
          <div className="px-6 py-4 border-b border-red-200 bg-red-50">
            <h2 className="text-lg font-medium text-red-900 flex items-center gap-2">
              <AlertTriangle className="w-5 h-5" />
              Danger Zone
            </h2>
          </div>
          <div className="p-6">
            <div className="flex items-start gap-4">
              <Trash2 className="w-6 h-6 text-red-600 flex-shrink-0" />
              <div className="flex-1">
                <h3 className="text-base font-medium text-gray-900">Delete Workspace</h3>
                <p className="text-sm text-gray-600 mt-1">
                  This will permanently delete the workspace and remove all member access.
                  Contacts will remain but will no longer be shared via this workspace.
                </p>

                {!showDeleteConfirm ? (
                  <button
                    onClick={() => setShowDeleteConfirm(true)}
                    className="mt-4 px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50"
                  >
                    Delete Workspace
                  </button>
                ) : (
                  <div className="mt-4 p-4 bg-red-50 rounded-lg">
                    <p className="text-sm text-red-800 mb-3">
                      Type <strong>{workspace.title}</strong> to confirm deletion:
                    </p>
                    <input
                      type="text"
                      value={deleteConfirmText}
                      onChange={(e) => setDeleteConfirmText(e.target.value)}
                      className="w-full px-3 py-2 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 mb-3"
                      placeholder="Type workspace name..."
                    />
                    <div className="flex gap-2">
                      <button
                        onClick={() => { setShowDeleteConfirm(false); setDeleteConfirmText(''); }}
                        className="btn-secondary"
                      >
                        Cancel
                      </button>
                      <button
                        onClick={handleDelete}
                        disabled={deleteConfirmText !== workspace.title || deleteMutation.isPending}
                        className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        {deleteMutation.isPending ? 'Deleting...' : 'Delete Forever'}
                      </button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
```
  </action>
  <verify>`npm run lint` passes</verify>
  <done>WorkspaceSettings.jsx created with edit and delete functionality</done>
</task>

<task type="auto">
  <name>Task 2: Create WorkspaceInviteAccept page</name>
  <files>src/pages/Workspaces/WorkspaceInviteAccept.jsx</files>
  <action>
Create the public invite acceptance page:

```javascript
import { useEffect } from 'react';
import { useParams, useNavigate, Link } from 'react-router-dom';
import { Users, CheckCircle, XCircle, Clock, Loader2 } from 'lucide-react';
import { useValidateInvite, useAcceptInvite } from '@/hooks/useWorkspaces';
import { useAuth } from '@/hooks/useAuth';

export default function WorkspaceInviteAccept() {
  const { token } = useParams();
  const navigate = useNavigate();
  const { isLoggedIn, isLoading: authLoading } = useAuth();

  const { data: invite, isLoading, error } = useValidateInvite(token);
  const acceptMutation = useAcceptInvite();

  const handleAccept = async () => {
    try {
      const result = await acceptMutation.mutateAsync(token);
      // Redirect to the workspace after accepting
      navigate(`/workspaces/${result.workspace_id}`);
    } catch (err) {
      // Error will be displayed via acceptMutation.error
    }
  };

  // If not logged in, redirect to login with return URL
  useEffect(() => {
    if (!authLoading && !isLoggedIn) {
      const returnUrl = encodeURIComponent(`/workspace-invite/${token}`);
      window.location.href = `/wp-login.php?redirect_to=${returnUrl}`;
    }
  }, [authLoading, isLoggedIn, token]);

  // Loading state
  if (isLoading || authLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="card p-8 max-w-md w-full mx-4 text-center">
          <Loader2 className="w-8 h-8 text-primary-600 animate-spin mx-auto mb-4" />
          <p className="text-gray-600">Validating invitation...</p>
        </div>
      </div>
    );
  }

  // Error state (invalid or expired token)
  if (error || !invite) {
    const errorMessage = error?.response?.data?.message || 'This invitation is invalid or has expired.';

    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="card p-8 max-w-md w-full mx-4 text-center">
          <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <XCircle className="w-8 h-8 text-red-600" />
          </div>
          <h1 className="text-xl font-semibold text-gray-900 mb-2">
            Invalid Invitation
          </h1>
          <p className="text-gray-600 mb-6">{errorMessage}</p>
          <Link to="/workspaces" className="btn-primary inline-block">
            Go to Workspaces
          </Link>
        </div>
      </div>
    );
  }

  // Already accepted (shouldn't normally happen, but handle gracefully)
  if (invite.status === 'accepted') {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="card p-8 max-w-md w-full mx-4 text-center">
          <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <CheckCircle className="w-8 h-8 text-green-600" />
          </div>
          <h1 className="text-xl font-semibold text-gray-900 mb-2">
            Already Accepted
          </h1>
          <p className="text-gray-600 mb-6">
            This invitation has already been accepted.
          </p>
          <Link to={`/workspaces/${invite.workspace_id}`} className="btn-primary inline-block">
            Go to Workspace
          </Link>
        </div>
      </div>
    );
  }

  // Valid invitation - show accept UI
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="card p-8 max-w-md w-full mx-4">
        {/* Header */}
        <div className="text-center mb-6">
          <div className="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <Users className="w-8 h-8 text-primary-600" />
          </div>
          <h1 className="text-xl font-semibold text-gray-900">
            Workspace Invitation
          </h1>
        </div>

        {/* Invitation details */}
        <div className="bg-gray-50 rounded-lg p-4 mb-6">
          <div className="text-center">
            <p className="text-sm text-gray-500 mb-1">You've been invited to join</p>
            <p className="text-lg font-semibold text-gray-900">{invite.workspace_name}</p>
          </div>

          <hr className="my-4 border-gray-200" />

          <div className="grid grid-cols-2 gap-4 text-sm">
            <div>
              <p className="text-gray-500">Invited by</p>
              <p className="font-medium text-gray-900">{invite.invited_by}</p>
            </div>
            <div>
              <p className="text-gray-500">Your role</p>
              <p className="font-medium text-gray-900 capitalize">{invite.role}</p>
            </div>
          </div>

          <div className="mt-4 flex items-center justify-center gap-2 text-sm text-gray-500">
            <Clock className="w-4 h-4" />
            Expires {new Date(invite.expires_at).toLocaleDateString()}
          </div>
        </div>

        {/* Error message */}
        {acceptMutation.error && (
          <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
            <p className="text-sm text-red-600">
              {acceptMutation.error?.response?.data?.message || 'Failed to accept invitation'}
            </p>
          </div>
        )}

        {/* Actions */}
        <div className="flex flex-col gap-3">
          <button
            onClick={handleAccept}
            disabled={acceptMutation.isPending}
            className="btn-primary w-full justify-center"
          >
            {acceptMutation.isPending ? (
              <>
                <Loader2 className="w-4 h-4 animate-spin mr-2" />
                Joining...
              </>
            ) : (
              'Accept Invitation'
            )}
          </button>

          <Link
            to="/workspaces"
            className="btn-secondary w-full justify-center text-center"
          >
            Decline
          </Link>
        </div>

        {/* Note about email */}
        <p className="text-xs text-gray-500 text-center mt-4">
          This invitation was sent to {invite.email}
        </p>
      </div>
    </div>
  );
}
```
  </action>
  <verify>`npm run lint` passes</verify>
  <done>WorkspaceInviteAccept.jsx created with validation and acceptance flow</done>
</task>

<task type="auto">
  <name>Task 3: Add routes to App.jsx</name>
  <files>src/App.jsx</files>
  <action>
Update App.jsx to add the new routes:

1. Add imports:
```javascript
import WorkspaceSettings from '@/pages/Workspaces/WorkspaceSettings';
import WorkspaceInviteAccept from '@/pages/Workspaces/WorkspaceInviteAccept';
```

2. Add settings route inside protected Routes (after /workspaces/:id):
```jsx
<Route path="/workspaces/:id/settings" element={<WorkspaceSettings />} />
```

3. Add invite accept route as a PUBLIC route (outside ProtectedRoute, alongside /login):
```jsx
{/* Public routes */}
<Route path="/login" element={<Login />} />
<Route path="/workspace-invite/:token" element={<WorkspaceInviteAccept />} />
```

Note: The invite accept page needs to be public initially so we can validate the token and show the invitation details. The page itself handles the auth check and redirects to login if needed.

Actually, looking at the logic in WorkspaceInviteAccept, it checks isLoggedIn and redirects. So it can be a protected route, but we need to handle the redirect properly. Let me reconsider...

The cleanest approach: Make it a semi-protected route. Put it inside ProtectedRoute but the component handles showing invite details before requiring login for acceptance.

Alternative: Keep it public but the accept API endpoint requires authentication. The page shows invite details to anyone, but Accept button only works when logged in.

For simplicity, let's keep it as a protected route - users will need to log in first, then they'll see the invite accept page. The email invite can mention they need to log in or create an account.

So add it inside the protected Routes section:
```jsx
{/* Workspaces routes */}
<Route path="/workspaces" element={<WorkspacesList />} />
<Route path="/workspaces/:id" element={<WorkspaceDetail />} />
<Route path="/workspaces/:id/settings" element={<WorkspaceSettings />} />
<Route path="/workspace-invite/:token" element={<WorkspaceInviteAccept />} />
```

Update the WorkspaceInviteAccept component to remove the manual auth check since ProtectedRoute handles it - the component can assume the user is logged in.
  </action>
  <verify>Navigate to /workspaces/:id/settings (as owner) - should show settings page</verify>
  <done>Settings and invite accept routes added to App.jsx</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run lint` passes
- [ ] `npm run build` succeeds
- [ ] /workspaces/:id/settings accessible to workspace owner
- [ ] Can edit workspace name and description
- [ ] Can delete workspace with confirmation
- [ ] /workspace-invite/:token shows invite details
- [ ] Can accept invitation
</verification>

<success_criteria>

- WorkspaceSettings page created with edit/delete
- WorkspaceInviteAccept page created with accept flow
- Routes added to App.jsx
- Delete requires typing workspace name to confirm
- Invite acceptance redirects to workspace
</success_criteria>

<output>
After completion, create `.planning/phases/09-sharing-ui/09-05-SUMMARY.md`
</output>
