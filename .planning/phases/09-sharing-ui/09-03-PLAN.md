---
phase: 09-sharing-ui
plan: 03
type: execute
depends_on: ["09-01"]
files_modified: [src/components/ShareModal.jsx, src/hooks/useSharing.js, src/api/client.js, src/pages/People/PersonDetail.jsx, src/pages/Companies/CompanyDetail.jsx, includes/class-rest-people.php, includes/class-rest-companies.php]
---

<objective>
Create ShareModal component for sharing contacts/companies with specific users.

Purpose: Enable users to share individual contacts or companies directly with other users (separate from workspace sharing).
Output: Working ShareModal with user search, share/unshare functionality, integrated into PersonDetail and CompanyDetail pages.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-sharing-ui/09-01-SUMMARY.md
@.planning/phases/07-data-model-visibility/07-02-SUMMARY.md
@src/components/PersonEditModal.jsx
@src/pages/People/PersonDetail.jsx
@src/api/client.js
@includes/class-rest-people.php

**ACF Fields Available (from Phase 7):**
- `_shared_with`: Serialized array of user shares - `[{user_id: int, permission: 'view'|'edit'}]`

**Patterns:**
- Modals use controlled component pattern with isOpen, onClose props
- Modal dialog uses fixed positioning with backdrop
- User avatars use get_avatar_url() on backend
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add share REST endpoints to backend</name>
  <files>includes/class-rest-people.php, includes/class-rest-companies.php</files>
  <action>
Add sharing endpoints to the existing REST classes. These endpoints manage the `_shared_with` ACF field.

In `class-rest-people.php`, add these routes in `register_routes()`:
```php
// Sharing endpoints
register_rest_route('prm/v1', '/people/(?P<id>\d+)/shares', [
    [
        'methods' => 'GET',
        'callback' => [$this, 'get_shares'],
        'permission_callback' => [$this, 'check_post_access'],
    ],
    [
        'methods' => 'POST',
        'callback' => [$this, 'add_share'],
        'permission_callback' => [$this, 'check_post_access'],
    ],
]);

register_rest_route('prm/v1', '/people/(?P<id>\d+)/shares/(?P<user_id>\d+)', [
    'methods' => 'DELETE',
    'callback' => [$this, 'remove_share'],
    'permission_callback' => [$this, 'check_post_access'],
]);
```

Add the handler methods:
```php
/**
 * Get list of users this post is shared with
 */
public function get_shares($request) {
    $post_id = $request->get_param('id');
    $shares = get_field('_shared_with', $post_id) ?: [];

    $result = [];
    foreach ($shares as $share) {
        $user = get_user_by('ID', $share['user_id']);
        if ($user) {
            $result[] = [
                'user_id' => $share['user_id'],
                'display_name' => $user->display_name,
                'email' => $user->user_email,
                'avatar_url' => get_avatar_url($user->ID, ['size' => 48]),
                'permission' => $share['permission'],
            ];
        }
    }

    return rest_ensure_response($result);
}

/**
 * Share post with a user
 */
public function add_share($request) {
    $post_id = $request->get_param('id');
    $user_id = (int) $request->get_param('user_id');
    $permission = $request->get_param('permission') ?: 'view';

    // Validate user exists
    $user = get_user_by('ID', $user_id);
    if (!$user) {
        return new WP_Error('invalid_user', 'User not found', ['status' => 404]);
    }

    // Can't share with yourself
    if ($user_id === get_current_user_id()) {
        return new WP_Error('invalid_share', 'Cannot share with yourself', ['status' => 400]);
    }

    // Get current shares
    $shares = get_field('_shared_with', $post_id) ?: [];

    // Check if already shared
    foreach ($shares as $key => $share) {
        if ($share['user_id'] === $user_id) {
            // Update permission
            $shares[$key]['permission'] = $permission;
            update_field('_shared_with', $shares, $post_id);
            return rest_ensure_response(['success' => true, 'message' => 'Share updated']);
        }
    }

    // Add new share
    $shares[] = [
        'user_id' => $user_id,
        'permission' => $permission,
    ];
    update_field('_shared_with', $shares, $post_id);

    return rest_ensure_response(['success' => true, 'message' => 'Shared successfully']);
}

/**
 * Remove share from a user
 */
public function remove_share($request) {
    $post_id = $request->get_param('id');
    $user_id = (int) $request->get_param('user_id');

    $shares = get_field('_shared_with', $post_id) ?: [];
    $shares = array_filter($shares, function($share) use ($user_id) {
        return $share['user_id'] !== $user_id;
    });
    $shares = array_values($shares); // Re-index

    update_field('_shared_with', $shares, $post_id);

    return rest_ensure_response(['success' => true, 'message' => 'Share removed']);
}

/**
 * Check if current user can access/modify this post
 */
protected function check_post_access($request) {
    if (!is_user_logged_in()) {
        return false;
    }
    $post_id = $request->get_param('id');
    $post = get_post($post_id);

    // Must be post author or admin
    return $post && ($post->post_author == get_current_user_id() || current_user_can('administrator'));
}
```

Add the same endpoints to `class-rest-companies.php` with the route prefix changed to `/companies/`.

Also add a user search endpoint (can go in class-rest-api.php or a new utility class):
```php
// In class-rest-api.php, add to register_routes():
register_rest_route('prm/v1', '/users/search', [
    'methods' => 'GET',
    'callback' => [$this, 'search_users'],
    'permission_callback' => 'is_user_logged_in',
]);

// Add handler:
public function search_users($request) {
    $query = sanitize_text_field($request->get_param('q'));
    if (strlen($query) < 2) {
        return rest_ensure_response([]);
    }

    $users = get_users([
        'search' => '*' . $query . '*',
        'search_columns' => ['user_login', 'user_email', 'display_name'],
        'number' => 10,
        'exclude' => [get_current_user_id()],
    ]);

    $result = [];
    foreach ($users as $user) {
        $result[] = [
            'id' => $user->ID,
            'display_name' => $user->display_name,
            'email' => $user->user_email,
            'avatar_url' => get_avatar_url($user->ID, ['size' => 48]),
        ];
    }

    return rest_ensure_response($result);
}
```
  </action>
  <verify>Test endpoints via curl or browser - GET /prm/v1/people/{id}/shares should return empty array for unshared post</verify>
  <done>Share REST endpoints added to People and Companies classes, user search endpoint added</done>
</task>

<task type="auto">
  <name>Task 2: Create useSharing.js hook and update API client</name>
  <files>src/hooks/useSharing.js, src/api/client.js</files>
  <action>
First, ensure the sharing API methods are in client.js (may already be there from 09-01):
```javascript
// In prmApi object:
getPostShares: (postType, postId) => api.get(`/prm/v1/${postType}/${postId}/shares`),
addShare: (postType, postId, userId, permission) => api.post(`/prm/v1/${postType}/${postId}/shares`, { user_id: userId, permission }),
removeShare: (postType, postId, userId) => api.delete(`/prm/v1/${postType}/${postId}/shares/${userId}`),
searchUsers: (query) => api.get('/prm/v1/users/search', { params: { q: query } }),
```

Create `src/hooks/useSharing.js`:
```javascript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { prmApi } from '@/api/client';

// Get shares for a post
export function useShares(postType, postId) {
  return useQuery({
    queryKey: ['shares', postType, postId],
    queryFn: async () => {
      const response = await prmApi.getPostShares(postType, postId);
      return response.data;
    },
    enabled: !!postId,
  });
}

// Add share mutation
export function useAddShare() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async ({ postType, postId, userId, permission }) => {
      const response = await prmApi.addShare(postType, postId, userId, permission);
      return response.data;
    },
    onSuccess: (_, { postType, postId }) => {
      queryClient.invalidateQueries({ queryKey: ['shares', postType, postId] });
    },
  });
}

// Remove share mutation
export function useRemoveShare() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async ({ postType, postId, userId }) => {
      await prmApi.removeShare(postType, postId, userId);
    },
    onSuccess: (_, { postType, postId }) => {
      queryClient.invalidateQueries({ queryKey: ['shares', postType, postId] });
    },
  });
}

// Search users for sharing
export function useUserSearch(query) {
  return useQuery({
    queryKey: ['users', 'search', query],
    queryFn: async () => {
      const response = await prmApi.searchUsers(query);
      return response.data;
    },
    enabled: query?.length >= 2,
  });
}
```
  </action>
  <verify>`npm run lint` passes</verify>
  <done>useSharing.js hook created with share CRUD and user search</done>
</task>

<task type="auto">
  <name>Task 3: Create ShareModal component</name>
  <files>src/components/ShareModal.jsx</files>
  <action>
Create the ShareModal component:

```javascript
import { useState, useEffect, useRef } from 'react';
import { X, Search, UserPlus, Trash2, Check } from 'lucide-react';
import { useShares, useAddShare, useRemoveShare, useUserSearch } from '@/hooks/useSharing';

export default function ShareModal({
  isOpen,
  onClose,
  postType,  // 'people' or 'companies'
  postId,
  postTitle, // For display purposes
}) {
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedPermission, setSelectedPermission] = useState('view');
  const searchInputRef = useRef(null);

  const { data: shares = [], isLoading: sharesLoading } = useShares(postType, postId);
  const { data: searchResults = [], isLoading: searchLoading } = useUserSearch(searchQuery);
  const addShareMutation = useAddShare();
  const removeShareMutation = useRemoveShare();

  // Focus search input when modal opens
  useEffect(() => {
    if (isOpen) {
      setSearchQuery('');
      setTimeout(() => searchInputRef.current?.focus(), 100);
    }
  }, [isOpen]);

  // Filter out users already shared with
  const availableUsers = searchResults.filter(
    user => !shares.some(share => share.user_id === user.id)
  );

  const handleAddShare = async (user) => {
    await addShareMutation.mutateAsync({
      postType,
      postId,
      userId: user.id,
      permission: selectedPermission,
    });
    setSearchQuery('');
  };

  const handleRemoveShare = async (userId) => {
    await removeShareMutation.mutateAsync({
      postType,
      postId,
      userId,
    });
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 overflow-y-auto">
      {/* Backdrop */}
      <div
        className="fixed inset-0 bg-black bg-opacity-50 transition-opacity"
        onClick={onClose}
      />

      {/* Modal */}
      <div className="flex min-h-full items-center justify-center p-4">
        <div className="relative w-full max-w-md bg-white rounded-lg shadow-xl">
          {/* Header */}
          <div className="flex items-center justify-between px-6 py-4 border-b border-gray-200">
            <div>
              <h2 className="text-lg font-semibold text-gray-900">Share</h2>
              <p className="text-sm text-gray-500 truncate max-w-xs">{postTitle}</p>
            </div>
            <button
              onClick={onClose}
              className="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100"
            >
              <X className="w-5 h-5" />
            </button>
          </div>

          {/* Content */}
          <div className="px-6 py-4">
            {/* Search input */}
            <div className="relative mb-4">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
              <input
                ref={searchInputRef}
                type="text"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                placeholder="Search users by name or email..."
                className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              />
            </div>

            {/* Permission selector */}
            <div className="flex items-center gap-2 mb-4">
              <span className="text-sm text-gray-600">Permission:</span>
              <select
                value={selectedPermission}
                onChange={(e) => setSelectedPermission(e.target.value)}
                className="text-sm border border-gray-300 rounded-md px-2 py-1 focus:ring-primary-500 focus:border-primary-500"
              >
                <option value="view">Can view</option>
                <option value="edit">Can edit</option>
              </select>
            </div>

            {/* Search results */}
            {searchQuery.length >= 2 && (
              <div className="mb-4">
                {searchLoading ? (
                  <div className="py-3 text-center text-sm text-gray-500">Searching...</div>
                ) : availableUsers.length === 0 ? (
                  <div className="py-3 text-center text-sm text-gray-500">
                    {searchResults.length === 0 ? 'No users found' : 'All matching users already have access'}
                  </div>
                ) : (
                  <div className="border border-gray-200 rounded-lg divide-y divide-gray-100">
                    {availableUsers.map((user) => (
                      <div key={user.id} className="flex items-center gap-3 p-3 hover:bg-gray-50">
                        <img
                          src={user.avatar_url}
                          alt={user.display_name}
                          className="w-8 h-8 rounded-full"
                        />
                        <div className="flex-1 min-w-0">
                          <div className="text-sm font-medium text-gray-900 truncate">
                            {user.display_name}
                          </div>
                          <div className="text-xs text-gray-500 truncate">{user.email}</div>
                        </div>
                        <button
                          onClick={() => handleAddShare(user)}
                          disabled={addShareMutation.isPending}
                          className="p-2 text-primary-600 hover:bg-primary-50 rounded-full"
                        >
                          <UserPlus className="w-4 h-4" />
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {/* Current shares */}
            <div>
              <h3 className="text-sm font-medium text-gray-700 mb-2">
                Shared with ({shares.length})
              </h3>
              {sharesLoading ? (
                <div className="py-3 text-center text-sm text-gray-500">Loading...</div>
              ) : shares.length === 0 ? (
                <div className="py-6 text-center text-sm text-gray-500">
                  Not shared with anyone yet
                </div>
              ) : (
                <div className="border border-gray-200 rounded-lg divide-y divide-gray-100">
                  {shares.map((share) => (
                    <div key={share.user_id} className="flex items-center gap-3 p-3">
                      <img
                        src={share.avatar_url}
                        alt={share.display_name}
                        className="w-8 h-8 rounded-full"
                      />
                      <div className="flex-1 min-w-0">
                        <div className="text-sm font-medium text-gray-900 truncate">
                          {share.display_name}
                        </div>
                        <div className="text-xs text-gray-500">
                          Can {share.permission}
                        </div>
                      </div>
                      <button
                        onClick={() => handleRemoveShare(share.user_id)}
                        disabled={removeShareMutation.isPending}
                        className="p-2 text-red-600 hover:bg-red-50 rounded-full"
                      >
                        <Trash2 className="w-4 h-4" />
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* Footer */}
          <div className="px-6 py-4 border-t border-gray-200 flex justify-end">
            <button
              onClick={onClose}
              className="btn-secondary"
            >
              Done
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}
```
  </action>
  <verify>`npm run lint` passes</verify>
  <done>ShareModal.jsx component created with user search and share management</done>
</task>

<task type="auto">
  <name>Task 4: Add Share button to PersonDetail and CompanyDetail pages</name>
  <files>src/pages/People/PersonDetail.jsx, src/pages/Companies/CompanyDetail.jsx</files>
  <action>
Add ShareModal to PersonDetail.jsx:

1. Import the component:
```javascript
import ShareModal from '@/components/ShareModal';
import { Share2 } from 'lucide-react';
```

2. Add state for modal:
```javascript
const [showShareModal, setShowShareModal] = useState(false);
```

3. Add Share button in the header area (near edit/delete buttons):
```jsx
<button
  onClick={() => setShowShareModal(true)}
  className="btn-secondary"
  title="Share"
>
  <Share2 className="w-4 h-4 md:mr-2" />
  <span className="hidden md:inline">Share</span>
</button>
```

4. Add the modal at the end of the component (before the closing fragment/div):
```jsx
<ShareModal
  isOpen={showShareModal}
  onClose={() => setShowShareModal(false)}
  postType="people"
  postId={person.id}
  postTitle={person.name || person.title?.rendered}
/>
```

Apply the same pattern to CompanyDetail.jsx:
- Import ShareModal and Share2 icon
- Add showShareModal state
- Add Share button in header
- Add ShareModal with postType="companies"
  </action>
  <verify>Navigate to PersonDetail and CompanyDetail pages, verify Share button appears</verify>
  <done>Share button and ShareModal added to PersonDetail and CompanyDetail pages</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>ShareModal component with user search, share/unshare functionality, integrated into PersonDetail and CompanyDetail pages</what-built>
  <how-to-verify>
    1. Run: `npm run dev`
    2. Go to People page, click on a person
    3. Verify: "Share" button appears in the header
    4. Click Share button
    5. Verify: ShareModal opens showing "Not shared with anyone yet"
    6. Type a username or email in search (must have other users in system)
    7. Verify: Search results appear
    8. Click the add button next to a user
    9. Verify: User appears in "Shared with" list
    10. Click trash icon to remove share
    11. Verify: User removed from list
    12. Repeat for Companies page
    13. Check browser console for any errors
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run lint` passes
- [ ] `npm run build` succeeds
- [ ] Share endpoints work in backend
- [ ] ShareModal opens and functions correctly
- [ ] User search returns results
- [ ] Can add and remove shares
- [ ] Works for both People and Companies
</verification>

<success_criteria>

- ShareModal component created and working
- Backend share endpoints implemented
- useSharing.js hook created
- Share button visible on PersonDetail and CompanyDetail
- Can search users and add/remove shares
- Human verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/09-sharing-ui/09-03-SUMMARY.md`
</output>
