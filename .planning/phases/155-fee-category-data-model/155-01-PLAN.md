---
phase: 155-fee-category-data-model
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-membership-fees.php
  - ../developer/src/content/docs/features/membership-fees.md
autonomous: true

must_haves:
  truths:
    - "get_categories_for_season() returns a slug-keyed array of category objects (label, amount, age_min, age_max, is_youth, sort_order) for a given season"
    - "save_categories_for_season() persists a slug-keyed category array to the WordPress option for a season"
    - "get_category() returns a single category object by slug for a given season, or null if not found"
    - "get_previous_season_key() returns the previous season key (e.g. '2024-2025' for '2025-2026'), or null for invalid input"
    - "When a season option does not exist, get_categories_for_season() copies the full category configuration from the previous season and saves it"
    - "When neither the requested season nor the previous season have data, get_categories_for_season() returns an empty array"
  artifacts:
    - path: "includes/class-membership-fees.php"
      provides: "Category read/write helpers and updated season copy-forward"
      contains: "get_categories_for_season"
    - path: "../developer/src/content/docs/features/membership-fees.md"
      provides: "Updated developer documentation reflecting new category data model"
      contains: "get_categories_for_season"
  key_links:
    - from: "includes/class-membership-fees.php::get_categories_for_season"
      to: "WordPress Options API"
      via: "get_option() and update_option()"
      pattern: "get_option.*get_option_key_for_season"
    - from: "includes/class-membership-fees.php::get_categories_for_season"
      to: "includes/class-membership-fees.php::get_previous_season_key"
      via: "copy-forward fallback chain"
      pattern: "get_previous_season_key.*get_option"
---

<objective>
Add fee category read/write helpers and update the season copy-forward mechanism in MembershipFees to work with full category objects instead of flat amount arrays.

Purpose: This is the data model foundation for v21.0 Per-Season Fee Categories. It defines how category definitions (slug, label, amount, age ranges, youth flag, sort order) are stored and retrieved per season, and ensures new seasons automatically inherit the previous season's category configuration.

Output: Updated `class-membership-fees.php` with new category helper methods and updated developer documentation.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/155-fee-category-data-model/155-CONTEXT.md
@.planning/phases/155-fee-category-data-model/155-RESEARCH.md
@includes/class-membership-fees.php
@../developer/src/content/docs/features/membership-fees.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add category helper methods and update copy-forward in MembershipFees</name>
  <files>includes/class-membership-fees.php</files>
  <action>
Add 4 new methods to the `Rondo\Fees\MembershipFees` class:

1. **`get_previous_season_key(string $season): ?string`**
   - Extract start year from "YYYY-YYYY" format using regex `/^(\d{4})-(\d{4})$/`
   - Return `(start_year - 1) . '-' . start_year` (e.g., "2025-2026" returns "2024-2025")
   - Return `null` if format is invalid
   - Place after existing `get_next_season_key()` method (around line 485) for logical grouping

2. **`get_categories_for_season(string $season): array`**
   - Read option using existing `get_option_key_for_season($season)` method
   - If option exists and is an array, return it as-is (no merging with DEFAULTS, no validation — trust the data per CONTEXT.md)
   - If option does not exist: call `get_previous_season_key($season)` to get previous season
   - If previous season is not null: read that season's option. If it exists and is an array, save it as the new season's option (copy-forward) and return it
   - If previous season has no data or is null: return empty array `[]`
   - No backward compatibility with old flat amount format — this is a clean break per CONTEXT.md

3. **`save_categories_for_season(array $categories, string $season): bool`**
   - Save using `update_option()` with the season-specific option key from `get_option_key_for_season($season)`
   - No validation — trust the input per CONTEXT.md decision
   - Return the bool result of `update_option()`

4. **`get_category(string $slug, ?string $season = null): ?array`**
   - Default season to `$this->get_season_key()` if null
   - Call `get_categories_for_season($season)` to get all categories
   - Return `$categories[$slug] ?? null`

**Important constraints:**
- Do NOT modify existing methods (`get_settings_for_season`, `update_settings_for_season`, `get_fee`, etc.) — those will be updated in Phase 156
- Do NOT add backward compatibility code, migration code, or validation logic
- Do NOT remove `DEFAULTS` or `VALID_TYPES` constants — they are still used by existing code until Phase 156
- Keep PHPDoc blocks consistent with existing style in the file (parameter types, return types, descriptions)
- Follow existing namespace (`Rondo\Fees`) and coding style
  </action>
  <verify>
Run `php -l includes/class-membership-fees.php` to verify no syntax errors. Then grep for the 4 new method names to confirm they exist:
- `get_previous_season_key`
- `get_categories_for_season`
- `save_categories_for_season`
- `get_category`
  </verify>
  <done>
The MembershipFees class has 4 new methods: `get_previous_season_key()`, `get_categories_for_season()` (with copy-forward from previous season), `save_categories_for_season()`, and `get_category()`. Existing methods are untouched. No backward compatibility layer, no validation, no migration code. The new data structure is a slug-keyed array of category objects with fields: label, amount, age_min, age_max, is_youth, sort_order.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update developer documentation for the new category data model</name>
  <files>../developer/src/content/docs/features/membership-fees.md</files>
  <action>
Update the membership fees developer documentation at `../developer/src/content/docs/features/membership-fees.md` to reflect the v21.0 category data model changes:

1. **Add a "Fee Category Configuration" section** explaining:
   - Categories are stored per season in `rondo_membership_fees_{season}` WordPress option
   - The option value is a slug-keyed PHP array where each value is a category object with: `label` (string), `amount` (int), `age_min` (int), `age_max` (int), `is_youth` (bool), `sort_order` (int)
   - Example of the data structure showing 2-3 categories

2. **Document the new helper methods:**
   - `get_categories_for_season(string $season): array` — reads categories with copy-forward from previous season
   - `save_categories_for_season(array $categories, string $season): bool` — writes categories
   - `get_category(string $slug, ?string $season = null): ?array` — reads single category
   - `get_previous_season_key(string $season): ?string` — calculates previous season key

3. **Document the season copy-forward behavior:**
   - New season reads trigger automatic copy from previous season
   - If no previous season data exists, returns empty array
   - Copy is saved to the new season option for future reads

4. **Add a note** that v21.0 Phase 156 will update `parse_age_group()` and other existing methods to read from the new category config.

Keep the existing documentation intact — add new sections, do not remove old content. The existing docs describe the current fee amounts system which is still used until Phase 156 completes.
  </action>
  <verify>
Read the updated docs file to verify it contains sections on the new category data model, helper methods, and copy-forward behavior.
  </verify>
  <done>
Developer documentation at `developer.rondo.club` reflects the new per-season fee category data model, documents the 4 new helper methods, and explains the copy-forward behavior. Existing documentation about fee amounts is preserved.
  </done>
</task>

</tasks>

<verification>
After both tasks are complete:

1. `php -l includes/class-membership-fees.php` returns no errors
2. The 4 new methods exist in the class and follow existing code style
3. Existing methods (`get_settings_for_season`, `update_settings_for_season`, `calculate_fee`, etc.) are completely unchanged
4. `DEFAULTS` and `VALID_TYPES` constants are still present
5. Developer documentation contains the new category data model section
6. No backward compatibility code, feature flags, or migration logic was added
</verification>

<success_criteria>
- MembershipFees class has `get_categories_for_season()`, `save_categories_for_season()`, `get_category()`, and `get_previous_season_key()` methods
- `get_categories_for_season()` implements copy-forward: reads season option -> falls back to previous season -> falls back to empty array
- No existing methods were modified (they break in Phase 155 and get fixed in Phase 156)
- Developer documentation is updated
- PHP syntax is valid
</success_criteria>

<output>
After completion, create `.planning/phases/155-fee-category-data-model/155-01-SUMMARY.md`
</output>
