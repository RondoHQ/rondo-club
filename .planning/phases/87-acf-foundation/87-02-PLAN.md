---
phase: 87-acf-foundation
plan: 02
type: execute
wave: 2
depends_on: [87-01]
files_modified:
  - includes/class-rest-custom-fields.php
  - functions.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "API can list custom field definitions for People"
    - "API can list custom field definitions for Teams"
    - "API can create a new custom field definition"
    - "API can update an existing custom field definition"
    - "API can deactivate a custom field definition"
  artifacts:
    - path: "includes/class-rest-custom-fields.php"
      provides: "REST API endpoints for custom field CRUD"
      exports: ["Stadion\\REST\\CustomFields"]
      min_lines: 200
  key_links:
    - from: "includes/class-rest-custom-fields.php"
      to: "Stadion\\CustomFields\\Manager"
      via: "instantiation and method calls"
      pattern: "new Manager\\(\\)|\\$this->manager->"
    - from: "functions.php"
      to: "Stadion\\REST\\CustomFields"
      via: "initialization in rondo_init for REST requests"
      pattern: "new.*CustomFields"
---

<objective>
Create REST API endpoints that expose the CustomFields Manager to the React frontend.

Purpose: The React Settings UI needs API endpoints to manage custom field definitions. This plan creates the REST controller that bridges the Manager class to HTTP.

Output: REST API endpoints at `/rondo/v1/custom-fields/{post_type}` with full CRUD operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/87-acf-foundation/87-RESEARCH.md
@.planning/phases/87-acf-foundation/87-01-SUMMARY.md

Reference files:
@includes/class-rest-base.php (for REST controller pattern)
@includes/class-rest-people.php (for endpoint registration pattern)
@functions.php (for initialization)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create REST CustomFields controller</name>
  <files>includes/class-rest-custom-fields.php</files>
  <action>
Create a new REST controller class `Stadion\REST\CustomFields` that exposes the Manager class via HTTP.

**Class structure:**
```php
namespace Stadion\REST;

use Stadion\CustomFields\Manager;
use WP_Error;
use WP_REST_Controller;
use WP_REST_Request;
use WP_REST_Response;
use WP_REST_Server;

class CustomFields extends WP_REST_Controller {
    protected string $namespace = 'rondo/v1';
    protected string $rest_base = 'custom-fields';
    protected Manager $manager;

    public function __construct() {
        $this->manager = new Manager();
        add_action('rest_api_init', [$this, 'register_routes']);
    }
}
```

**Routes to register:**

1. `GET /rondo/v1/custom-fields/{post_type}` - List all custom fields for post type
   - Permission: `manage_options` (admin only)
   - Args: `post_type` (string, required, enum: person|team)
   - Optional query param: `include_inactive` (boolean, default false)
   - Response: Array of field objects

2. `POST /rondo/v1/custom-fields/{post_type}` - Create new custom field
   - Permission: `manage_options`
   - Args: `post_type` (string, required, enum: person|team)
   - Body: `{ label: string, type: string, name?: string, instructions?: string, required?: boolean, choices?: array, default_value?: mixed, placeholder?: string }`
   - Response: Created field object or WP_Error

3. `GET /rondo/v1/custom-fields/{post_type}/{field_key}` - Get single field
   - Permission: `manage_options`
   - Response: Field object or 404

4. `PUT /rondo/v1/custom-fields/{post_type}/{field_key}` - Update field
   - Permission: `manage_options`
   - Body: `{ label?: string, name?: string, instructions?: string, required?: boolean, choices?: array, default_value?: mixed, placeholder?: string }`
   - Response: Updated field object or WP_Error

5. `DELETE /rondo/v1/custom-fields/{post_type}/{field_key}` - Deactivate field (soft delete)
   - Permission: `manage_options`
   - Response: `{ success: true, field: {...} }` or WP_Error

**Methods to implement:**

```php
public function register_routes() {
    // Collection route: list and create
    register_rest_route($this->namespace, '/' . $this->rest_base . '/(?P<post_type>person|team)', [
        [
            'methods'             => WP_REST_Server::READABLE,
            'callback'            => [$this, 'get_items'],
            'permission_callback' => [$this, 'get_items_permissions_check'],
            'args'                => $this->get_collection_params(),
        ],
        [
            'methods'             => WP_REST_Server::CREATABLE,
            'callback'            => [$this, 'create_item'],
            'permission_callback' => [$this, 'create_item_permissions_check'],
            'args'                => $this->get_create_params(),
        ],
    ]);

    // Single item route: get, update, delete
    register_rest_route($this->namespace, '/' . $this->rest_base . '/(?P<post_type>person|team)/(?P<field_key>[a-z0-9_]+)', [
        [
            'methods'             => WP_REST_Server::READABLE,
            'callback'            => [$this, 'get_item'],
            'permission_callback' => [$this, 'get_item_permissions_check'],
        ],
        [
            'methods'             => WP_REST_Server::EDITABLE,
            'callback'            => [$this, 'update_item'],
            'permission_callback' => [$this, 'update_item_permissions_check'],
            'args'                => $this->get_update_params(),
        ],
        [
            'methods'             => WP_REST_Server::DELETABLE,
            'callback'            => [$this, 'delete_item'],
            'permission_callback' => [$this, 'delete_item_permissions_check'],
        ],
    ]);
}

public function get_items_permissions_check($request): bool {
    return current_user_can('manage_options');
}

// Similar permission checks for other methods - all require manage_options

public function get_items($request): WP_REST_Response {
    $post_type = $request->get_param('post_type');
    $include_inactive = $request->get_param('include_inactive') === true;

    $fields = $this->manager->get_fields($post_type, $include_inactive);

    return rest_ensure_response($fields);
}

public function create_item($request): WP_REST_Response|WP_Error {
    $post_type = $request->get_param('post_type');
    $field_config = [
        'label' => $request->get_param('label'),
        'type'  => $request->get_param('type'),
    ];

    // Add optional params if present
    foreach (['name', 'instructions', 'required', 'choices', 'default_value', 'placeholder'] as $param) {
        if ($request->has_param($param)) {
            $field_config[$param] = $request->get_param($param);
        }
    }

    $result = $this->manager->create_field($post_type, $field_config);

    if (is_wp_error($result)) {
        return $result;
    }

    return rest_ensure_response($result);
}

public function get_item($request): WP_REST_Response|WP_Error {
    $field_key = $request->get_param('field_key');
    $field = $this->manager->get_field($field_key);

    if (!$field) {
        return new WP_Error('not_found', 'Field not found', ['status' => 404]);
    }

    return rest_ensure_response($field);
}

public function update_item($request): WP_REST_Response|WP_Error {
    $field_key = $request->get_param('field_key');
    $updates = [];

    foreach (['label', 'name', 'instructions', 'required', 'choices', 'default_value', 'placeholder'] as $param) {
        if ($request->has_param($param)) {
            $updates[$param] = $request->get_param($param);
        }
    }

    $result = $this->manager->update_field($field_key, $updates);

    if (is_wp_error($result)) {
        return $result;
    }

    return rest_ensure_response($result);
}

public function delete_item($request): WP_REST_Response|WP_Error {
    $field_key = $request->get_param('field_key');
    $result = $this->manager->deactivate_field($field_key);

    if (is_wp_error($result)) {
        return $result;
    }

    return rest_ensure_response([
        'success' => true,
        'field'   => $result,
    ]);
}
```

**Argument schema methods:**

```php
protected function get_collection_params(): array {
    return [
        'include_inactive' => [
            'type'        => 'boolean',
            'default'     => false,
            'description' => 'Include deactivated fields in response',
        ],
    ];
}

protected function get_create_params(): array {
    return [
        'label' => [
            'type'        => 'string',
            'required'    => true,
            'description' => 'Field label displayed to users',
        ],
        'type' => [
            'type'        => 'string',
            'required'    => true,
            'description' => 'ACF field type (text, textarea, number, etc.)',
        ],
        'name' => [
            'type'        => 'string',
            'description' => 'Field name (defaults to sanitized label)',
        ],
        'instructions' => [
            'type'        => 'string',
            'description' => 'Help text displayed below field',
        ],
        'required' => [
            'type'        => 'boolean',
            'default'     => false,
            'description' => 'Whether field is required',
        ],
        'choices' => [
            'type'        => 'object',
            'description' => 'Choices for select/checkbox fields',
        ],
        'default_value' => [
            'description' => 'Default value for new posts',
        ],
        'placeholder' => [
            'type'        => 'string',
            'description' => 'Placeholder text for empty field',
        ],
    ];
}

protected function get_update_params(): array {
    // Same as create but nothing required
    $params = $this->get_create_params();
    unset($params['label']['required']);
    unset($params['type']['required']);
    unset($params['type']); // Cannot change type after creation
    return $params;
}
```
  </action>
  <verify>
Run `wp rest-api discover` or check endpoints exist:
```bash
curl -s "https://[site]/wp-json/rondo/v1/" | grep custom-fields
```
  </verify>
  <done>
REST controller exists at includes/class-rest-custom-fields.php with all 5 endpoints registered. Class follows WP_REST_Controller pattern with proper permission checks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Initialize REST controller in functions.php</name>
  <files>functions.php</files>
  <action>
Update functions.php to initialize the CustomFields REST controller:

1. Add use statement with other REST imports:
   ```php
   use Stadion\REST\CustomFields as RESTCustomFields;
   ```

2. Add backward compatibility alias:
   ```php
   if ( ! class_exists( 'RONDO_REST_Custom_Fields' ) ) {
       class_alias( RESTCustomFields::class, 'RONDO_REST_Custom_Fields' );
   }
   ```

3. In `rondo_init()`, add instantiation in the REST API section (where other REST classes are instantiated):
   ```php
   // REST API classes - only for REST requests
   if ( $is_rest ) {
       new Api();
       new People();
       new Teams();
       // ... existing classes ...
       new RESTCustomFields();  // Add this line
   }
   ```
  </action>
  <verify>
Run `npm run lint` for PHP linting.
Verify endpoint responds:
```bash
wp eval "
\$request = new WP_REST_Request('GET', '/rondo/v1/custom-fields/person');
\$response = rest_do_request(\$request);
var_dump(\$response->get_status());
"
```
  </verify>
  <done>
functions.php has use statement, backward compatibility alias, and instantiates RESTCustomFields in the REST section of rondo_init().
  </done>
</task>

<task type="auto">
  <name>Task 3: Test API endpoints via curl</name>
  <files>None (verification only)</files>
  <action>
Test all REST endpoints to verify they work correctly.

Note: These tests require admin authentication. Use WP-CLI to simulate authenticated requests.

**Test sequence:**

1. List fields (should be empty initially):
```bash
wp eval "
wp_set_current_user(1); // Admin user
\$request = new WP_REST_Request('GET', '/rondo/v1/custom-fields/person');
\$response = rest_do_request(\$request);
echo 'Status: ' . \$response->get_status() . PHP_EOL;
echo 'Data: ' . json_encode(\$response->get_data()) . PHP_EOL;
"
```

2. Create a text field:
```bash
wp eval "
wp_set_current_user(1);
\$request = new WP_REST_Request('POST', '/rondo/v1/custom-fields/person');
\$request->set_param('label', 'LinkedIn URL');
\$request->set_param('type', 'url');
\$request->set_param('instructions', 'Enter LinkedIn profile URL');
\$response = rest_do_request(\$request);
echo 'Status: ' . \$response->get_status() . PHP_EOL;
echo 'Data: ' . json_encode(\$response->get_data()) . PHP_EOL;
"
```

3. List fields (should show created field):
```bash
wp eval "
wp_set_current_user(1);
\$request = new WP_REST_Request('GET', '/rondo/v1/custom-fields/person');
\$response = rest_do_request(\$request);
echo 'Status: ' . \$response->get_status() . PHP_EOL;
echo 'Count: ' . count(\$response->get_data()) . PHP_EOL;
"
```

4. Update the field:
```bash
wp eval "
wp_set_current_user(1);
// First get the field key from previous step
\$fields = (new Stadion\CustomFields\Manager())->get_fields('person');
\$field_key = \$fields[0]['key'] ?? '';
if (\$field_key) {
    \$request = new WP_REST_Request('PUT', '/rondo/v1/custom-fields/person/' . \$field_key);
    \$request->set_param('label', 'LinkedIn Profile');
    \$response = rest_do_request(\$request);
    echo 'Status: ' . \$response->get_status() . PHP_EOL;
    echo 'New label: ' . \$response->get_data()['label'] . PHP_EOL;
}
"
```

5. Delete (deactivate) the field:
```bash
wp eval "
wp_set_current_user(1);
\$fields = (new Stadion\CustomFields\Manager())->get_fields('person');
\$field_key = \$fields[0]['key'] ?? '';
if (\$field_key) {
    \$request = new WP_REST_Request('DELETE', '/rondo/v1/custom-fields/person/' . \$field_key);
    \$response = rest_do_request(\$request);
    echo 'Status: ' . \$response->get_status() . PHP_EOL;
    echo 'Success: ' . (\$response->get_data()['success'] ? 'true' : 'false') . PHP_EOL;
}
"
```

6. Verify field is inactive but still exists:
```bash
wp eval "
wp_set_current_user(1);
\$request = new WP_REST_Request('GET', '/rondo/v1/custom-fields/person');
\$request->set_param('include_inactive', true);
\$response = rest_do_request(\$request);
echo 'Total (with inactive): ' . count(\$response->get_data()) . PHP_EOL;

\$request2 = new WP_REST_Request('GET', '/rondo/v1/custom-fields/person');
\$response2 = rest_do_request(\$request2);
echo 'Active only: ' . count(\$response2->get_data()) . PHP_EOL;
"
```

7. Permission check (non-admin should get 403):
```bash
wp eval "
wp_set_current_user(0); // No user
\$request = new WP_REST_Request('GET', '/rondo/v1/custom-fields/person');
\$response = rest_do_request(\$request);
echo 'Unauthenticated status: ' . \$response->get_status() . PHP_EOL;
"
```

If all tests pass, the API is working correctly.
  </action>
  <verify>
All 7 test commands above should output expected results:
- Status codes: 200 for success, 403 for permission denied
- Create should return field object with key
- Update should reflect label change
- Delete should return success: true
- include_inactive should control field visibility
  </verify>
  <done>
All API endpoints tested and working: list, create, get single, update, delete (deactivate). Permission checks working (non-admins get 403).
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **REST controller class exists and loads:**
   ```bash
   wp eval "echo class_exists('Stadion\\REST\\CustomFields') ? 'OK' : 'FAIL';"
   ```

2. **Endpoints are registered:**
   ```bash
   wp eval "
   \$routes = rest_get_server()->get_routes();
   echo isset(\$routes['/rondo/v1/custom-fields/(?P<post_type>person|team)']) ? 'Collection route OK' : 'MISSING';
   echo PHP_EOL;
   echo isset(\$routes['/rondo/v1/custom-fields/(?P<post_type>person|team)/(?P<field_key>[a-z0-9_]+)']) ? 'Item route OK' : 'MISSING';
   "
   ```

3. **Full CRUD cycle works:**
   - Create field via POST
   - Read via GET
   - Update via PUT
   - Delete via DELETE
   - Verify soft delete preserves data

4. **Permission checks enforced:**
   - Admins can access all endpoints
   - Non-admins get 403 Forbidden
</verification>

<success_criteria>
1. REST controller exists at includes/class-rest-custom-fields.php
2. 5 endpoints registered: GET list, POST create, GET single, PUT update, DELETE deactivate
3. All endpoints require manage_options capability
4. functions.php initializes REST controller for REST requests
5. Full CRUD operations work via REST API
6. Soft delete via DELETE endpoint preserves stored field values
</success_criteria>

<output>
After completion, create `.planning/phases/87-acf-foundation/87-02-SUMMARY.md`
</output>
