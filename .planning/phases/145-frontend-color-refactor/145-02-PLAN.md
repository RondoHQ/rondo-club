---
phase: 145-frontend-color-refactor
plan: 02
type: execute
wave: 2
depends_on: ["145-01"]
files_modified:
  - src/pages/Settings/Settings.jsx
  - functions.php
  - package.json
  - package-lock.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Admin sees Club Configuration section at top of Settings page with name, color picker, and FreeScout URL fields"
    - "Non-admin users do NOT see the Club Configuration section"
    - "Admin can pick a color with visual color picker and see live preview throughout the app"
    - "Saving club color updates window.stadionConfig and applies theme immediately"
    - "Login screen uses club color for buttons, links, and gradient background"
    - "Login screen shows club name as heading below the logo"
    - "Club color falls back to green (#006935) when not configured"
  artifacts:
    - path: "src/pages/Settings/Settings.jsx"
      provides: "ClubConfigSection with color picker, name, FreeScout URL fields"
      contains: "react-colorful"
    - path: "functions.php"
      provides: "Dynamic login page styling reading from ClubConfig"
      contains: "ClubConfig"
    - path: "package.json"
      provides: "react-colorful dependency"
      contains: "react-colorful"
  key_links:
    - from: "src/pages/Settings/Settings.jsx"
      to: "/stadion/v1/config"
      via: "POST request to save club configuration"
      pattern: "stadion/v1/config"
    - from: "src/pages/Settings/Settings.jsx"
      to: "window.stadionConfig"
      via: "Update stadionConfig after successful save"
      pattern: "stadionConfig"
    - from: "src/pages/Settings/Settings.jsx"
      to: "document.documentElement.style"
      via: "Live preview injects CSS custom properties directly on :root"
      pattern: "style\\.setProperty.*--color-accent"
    - from: "functions.php"
      to: "includes/class-club-config.php"
      via: "ClubConfig service reads options for login page styling"
      pattern: "ClubConfig"
---

<objective>
Add admin-only Club Configuration section to Settings UI with visual color picker and live preview, then update the WordPress login page to use dynamic club colors from the backend configuration.

Purpose: Admins can now configure their club's identity (name, color, FreeScout URL) through the Settings UI with immediate visual feedback, and the login page reflects the club's branding automatically.

Output: Club Configuration section in Settings with react-colorful color picker, live preview, and a dynamically-styled WordPress login page.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/144-backend-configuration-system/144-01-SUMMARY.md
@.planning/phases/145-frontend-color-refactor/145-CONTEXT.md
@.planning/phases/145-frontend-color-refactor/145-RESEARCH.md
@.planning/phases/145-frontend-color-refactor/145-01-SUMMARY.md

Key source files:
@src/pages/Settings/Settings.jsx
@functions.php
@src/hooks/useTheme.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-colorful and add Club Configuration section to Settings (UI + save)</name>
  <files>package.json, src/pages/Settings/Settings.jsx</files>
  <action>
    **Install dependency:**
    ```bash
    npm install react-colorful
    ```

    **src/pages/Settings/Settings.jsx:**

    1. Add import at the top:
       ```javascript
       import { HexColorPicker, HexColorInput } from 'react-colorful';
       ```

    2. Add Club Configuration section to the Appearance tab ("Weergave"). This section should appear FIRST, before the color scheme card, and only for admins (`isAdmin` is already available from `config.isAdmin`).

    Add local state for the three fields, initialized from `window.stadionConfig`:

    ```jsx
    const [clubName, setClubName] = useState(config.clubName || '');
    const [clubColor, setClubColor] = useState(config.accentColor || '#006935');
    const [freescoutUrl, setFreescoutUrl] = useState(config.freescoutUrl || '');
    const [savingClubConfig, setSavingClubConfig] = useState(false);
    const [clubConfigSaved, setClubConfigSaved] = useState(false);
    const [showColorPicker, setShowColorPicker] = useState(false);
    ```

    3. Implement the save handler using the existing `prmApi` pattern (Settings.jsx already uses this for stadion/v1 calls):

    ```jsx
    const handleSaveClubConfig = async () => {
      setSavingClubConfig(true);
      setClubConfigSaved(false);
      try {
        const response = await prmApi.post('/config', {
          club_name: clubName,
          accent_color: clubColor,
          freescout_url: freescoutUrl,
        });
        // Update window.stadionConfig with saved values
        window.stadionConfig.clubName = response.data.club_name;
        window.stadionConfig.accentColor = response.data.accent_color;
        window.stadionConfig.freescoutUrl = response.data.freescout_url;

        // Force theme re-application if user is on 'club' accent
        if (accentColor === 'club') {
          // useTheme's applyTheme will pick up new stadionConfig value
          setAccentColor('club');
        }

        setClubConfigSaved(true);
        setTimeout(() => setClubConfigSaved(false), 3000);
      } catch (error) {
        // Handle error - follow existing Settings.jsx error handling patterns
      } finally {
        setSavingClubConfig(false);
      }
    };
    ```

    4. Render the Club Configuration section in the appearance tab (before "Kleurenschema" card):

    ```jsx
    {isAdmin && (
      <div className="card p-6">
        <h2 className="text-lg font-semibold mb-2 dark:text-gray-100">Clubconfiguratie</h2>
        <p className="text-sm text-gray-600 mb-6 dark:text-gray-400">
          Configureer clubinstellingen. Wijzigingen gelden voor alle gebruikers.
        </p>

        <div className="space-y-5">
          {/* Club Name */}
          <div>
            <label className="label">Clubnaam</label>
            <input
              type="text"
              value={clubName}
              onChange={(e) => setClubName(e.target.value)}
              className="input max-w-md"
              placeholder="bijv. Hockey Club Utrecht"
            />
            <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
              Wordt getoond op het inlogscherm en in de paginatitel.
            </p>
          </div>

          {/* Club Color */}
          <div>
            <label className="label">Clubkleur</label>
            <div className="flex gap-4 items-start">
              <div>
                <button
                  type="button"
                  onClick={() => setShowColorPicker(!showColorPicker)}
                  className="w-12 h-12 rounded-lg border-2 border-gray-300 dark:border-gray-600 cursor-pointer hover:scale-105 transition-transform"
                  style={{ backgroundColor: clubColor }}
                  title="Klik om kleurkiezer te openen"
                />
                {showColorPicker && (
                  <div className="mt-2">
                    <HexColorPicker color={clubColor} onChange={setClubColor} />
                  </div>
                )}
              </div>
              <div className="flex-1 max-w-[200px]">
                <HexColorInput
                  color={clubColor}
                  onChange={setClubColor}
                  className="input"
                  prefixed
                  placeholder="#006935"
                />
              </div>
            </div>
          </div>

          {/* FreeScout URL */}
          <div>
            <label className="label">FreeScout URL</label>
            <input
              type="url"
              value={freescoutUrl}
              onChange={(e) => setFreescoutUrl(e.target.value)}
              className="input max-w-md"
              placeholder="https://support.example.com"
            />
            <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
              Basis-URL voor FreeScout klantkoppelingen. Laat leeg om te verbergen.
            </p>
          </div>

          {/* Save Button */}
          <div className="flex items-center gap-3">
            <button
              onClick={handleSaveClubConfig}
              disabled={savingClubConfig}
              className="btn-primary"
            >
              {savingClubConfig ? 'Opslaan...' : 'Opslaan'}
            </button>
            {clubConfigSaved && (
              <span className="text-sm text-green-600 dark:text-green-400 flex items-center gap-1">
                <Check className="w-4 h-4" />
                Opgeslagen
              </span>
            )}
          </div>
        </div>
      </div>
    )}
    ```

    All UI text must be in Dutch, consistent with the rest of the Settings page.

    NOTE: In this task, `setClubColor` does NOT include live preview CSS injection yet -- that is added in Task 2. This task focuses on getting the UI structure and save flow working correctly.
  </action>
  <verify>
    1. `npm run build` completes without errors
    2. `npm run lint` passes
    3. `grep "react-colorful" package.json` shows the dependency
    4. `grep "Clubconfiguratie" src/pages/Settings/Settings.jsx` shows the section
    5. `grep "isAdmin" src/pages/Settings/Settings.jsx` shows the conditional rendering
  </verify>
  <done>
    - react-colorful installed as dependency
    - Club Configuration section visible in Settings for admins only
    - Color picker with visual swatch toggle + hex input
    - Save persists via POST /stadion/v1/config
    - window.stadionConfig updated after save
    - Theme re-applied after save (if user is on 'club' accent)
    - All UI text in Dutch
  </done>
</task>

<task type="auto">
  <name>Task 2: Add live preview for club color and cleanup on unmount</name>
  <files>src/pages/Settings/Settings.jsx</files>
  <action>
    Add live preview so admin sees the club color change throughout the app in real-time as they pick colors, BEFORE saving.

    **Approach:** Settings.jsx directly manipulates CSS custom properties on `document.documentElement` when the color picker value changes. This is the simplest and most performant approach -- CSS variable updates are cheap (1-2ms) and the browser handles repaints efficiently. No need to go through useTheme.

    1. Add state to track the original color for revert-on-unmount:
       ```javascript
       const [originalClubColor] = useState(config.accentColor || '#006935');
       ```

    2. Replace the simple `setClubColor` onChange handler with a `handleClubColorChange` function that also injects CSS vars for live preview:

       ```javascript
       const handleClubColorChange = (color) => {
         setClubColor(color);
         // Live preview: if user's current accent is 'club', update CSS vars immediately
         if (accentColor === 'club') {
           const root = document.documentElement;
           // Import lightenHex and darkenHex from useTheme, OR duplicate the simple helpers inline.
           // Since useTheme exports these via the module, check if they are exported.
           // If not exported, duplicate the 3 small functions (lightenHex, darkenHex, injectClubColorVars)
           // or just set the key shades that are visible in the UI:
           root.style.setProperty('--color-accent-500', color);
           root.style.setProperty('--color-accent-600', color);
           root.style.setProperty('--color-accent-700', color);
         }
       };
       ```

       Update the HexColorPicker and HexColorInput onChange props to use `handleClubColorChange` instead of `setClubColor`.

       IMPORTANT: For live preview, setting just the 3 most-visible shades (500, 600, 700) is sufficient. These control buttons, links, and interactive elements. A full 50-900 scale generation is unnecessary for a preview -- the full scale gets applied properly on save when useTheme re-applies the theme from stadionConfig.

    3. Add a cleanup effect that reverts the preview if the admin navigates away without saving:

       ```javascript
       useEffect(() => {
         return () => {
           // Revert preview if color was changed but not saved
           if (accentColor === 'club') {
             // Clear inline CSS overrides - useTheme will re-apply from stadionConfig
             const root = document.documentElement;
             for (const shade of ['500', '600', '700']) {
               root.style.removeProperty(`--color-accent-${shade}`);
             }
           }
         };
       }, [accentColor]);
       ```

    4. Update the save handler: After a successful save, clear the preview overrides so useTheme can re-apply the full color scale properly:
       ```javascript
       // After window.stadionConfig update in handleSaveClubConfig:
       // Clear preview overrides
       const root = document.documentElement;
       for (const shade of ['500', '600', '700']) {
         root.style.removeProperty(`--color-accent-${shade}`);
       }
       // useTheme's applyTheme will now generate the full scale from the new stadionConfig value
       ```

    5. Add a hint text below the color picker that explains live preview:
       ```jsx
       <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
         Live voorbeeld zichtbaar als je accentkleur op "Club" staat.
       </p>
       ```
       Place this after the HexColorInput.
  </action>
  <verify>
    1. `npm run build` completes without errors
    2. `npm run lint` passes
    3. `grep "handleClubColorChange" src/pages/Settings/Settings.jsx` shows the handler
    4. `grep "removeProperty" src/pages/Settings/Settings.jsx` shows cleanup logic
    5. `grep "Live voorbeeld" src/pages/Settings/Settings.jsx` shows the hint text
  </verify>
  <done>
    - Live preview updates CSS variables in real-time as admin picks colors
    - Only key shades (500, 600, 700) updated for preview -- lightweight and fast
    - Preview reverts on unmount if not saved
    - Preview overrides cleared on save so useTheme applies full scale
    - Hint text explains live preview behavior
  </done>
</task>

<task type="auto">
  <name>Task 3: Update WordPress login page to use dynamic club colors</name>
  <files>functions.php</files>
  <action>
    Update the `stadion_login_styles()` function (starts around line 945) to read the club color from ClubConfig instead of hardcoding AWC green values.

    1. At the start of the function, instantiate ClubConfig and get the color:
       ```php
       function stadion_login_styles() {
           $favicon_url = STADION_THEME_URL . '/favicon.svg';
           $site_name   = get_bloginfo( 'name' );

           // Get club configuration for dynamic theming
           $club_config = new \Stadion\Config\ClubConfig();
           $settings    = $club_config->get_all_settings();
           $club_color  = $settings['accent_color']; // Defaults to #006935
           $club_name   = $settings['club_name'];

           // Pre-calculate color variants for CSS
           $color_rgb = sscanf( $club_color, '#%02x%02x%02x' );
           $r = $color_rgb[0]; $g = $color_rgb[1]; $b = $color_rgb[2];

           // Darker variant (multiply by 0.75)
           $dark_r = max( 0, round( $r * 0.75 ) );
           $dark_g = max( 0, round( $g * 0.75 ) );
           $dark_b = max( 0, round( $b * 0.75 ) );
           $color_dark = sprintf( '#%02x%02x%02x', $dark_r, $dark_g, $dark_b );

           // Darkest variant (multiply by 0.55)
           $darkest_r = max( 0, round( $r * 0.55 ) );
           $darkest_g = max( 0, round( $g * 0.55 ) );
           $darkest_b = max( 0, round( $b * 0.55 ) );
           $color_darkest = sprintf( '#%02x%02x%02x', $darkest_r, $darkest_g, $darkest_b );

           // Very light tint for backgrounds (mix with white at 94%)
           $light_r = min( 255, round( $r + ( 255 - $r ) * 0.94 ) );
           $light_g = min( 255, round( $g + ( 255 - $g ) * 0.94 ) );
           $light_b = min( 255, round( $b + ( 255 - $b ) * 0.94 ) );
           $color_lightest = sprintf( '#%02x%02x%02x', $light_r, $light_g, $light_b );

           // Light tint for gradients (mix with white at 85%)
           $mid_r = min( 255, round( $r + ( 255 - $r ) * 0.85 ) );
           $mid_g = min( 255, round( $g + ( 255 - $g ) * 0.85 ) );
           $mid_b = min( 255, round( $b + ( 255 - $b ) * 0.85 ) );
           $color_light = sprintf( '#%02x%02x%02x', $mid_r, $mid_g, $mid_b );

           // Medium light tint for borders (mix with white at 72%)
           $border_r = min( 255, round( $r + ( 255 - $r ) * 0.72 ) );
           $border_g = min( 255, round( $g + ( 255 - $g ) * 0.72 ) );
           $border_b = min( 255, round( $b + ( 255 - $b ) * 0.72 ) );
           $color_border = sprintf( '#%02x%02x%02x', $border_r, $border_g, $border_b );
       ```

    2. Replace ALL hardcoded hex values in the CSS output with PHP variables. The mapping:
       - `#006935` (primary) -> `$club_color`
       - `#004924` (dark) -> `$color_dark`
       - `#003d1e` (darkest) -> `$color_darkest`
       - `#005a2d` (medium dark) -> `$color_dark`
       - `#f0fdf5` (lightest bg) -> `$color_lightest`
       - `#dcfce8` (light bg) -> `$color_light`
       - `#bbf7d1` (border light) -> `$color_border`
       - `rgba(0, 105, 53, 0.1)` (shadow) -> `rgba(<?php echo "$r, $g, $b"; ?>, 0.1)`
       - `rgba(0, 73, 36, 0.4)` (hover shadow) -> `rgba(<?php echo "$dark_r, $dark_g, $dark_b"; ?>, 0.4)`
       - `rgba(0, 105, 53, 0.15)` (focus ring) -> `rgba(<?php echo "$r, $g, $b"; ?>, 0.15)`

    3. Use the `$club_name` for the login heading. The existing code uses `$site_name = get_bloginfo('name')`. If `$club_name` is configured, use that instead:
       ```php
       $display_name = ! empty( $club_name ) ? $club_name : $site_name;
       ```
       Then use `$display_name` in the CSS `content` property for `#login h1::after`.

    4. Update the `stadion_login_favicon()` function to also use the club color in an inline SVG favicon:
       ```php
       function stadion_login_favicon() {
           $club_config = new \Stadion\Config\ClubConfig();
           $settings    = $club_config->get_all_settings();
           $club_color  = esc_attr( $settings['accent_color'] );

           $svg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="' . $club_color . '">'
               . '<path fill-rule="evenodd" d="M12 2C6.5 2 2 5.5 2 9v6c0 3.5 4.5 7 10 7s10-3.5 10-7V9c0-3.5-4.5-7-10-7zm0 2c4.4 0 8 2.7 8 5s-3.6 5-8 5-8-2.7-8-5 3.6-5 8-5zm0 4c-2.2 0-4 .9-4 2s1.8 2 4 2 4-.9 4-2-1.8-2-4-2z" clip-rule="evenodd"/>'
               . '</svg>';
           $data_url = 'data:image/svg+xml,' . rawurlencode( $svg );

           echo '<link rel="icon" type="image/svg+xml" href="' . esc_url( $data_url ) . '">';
       }
       ```

    5. Update `stadion_pwa_meta_tags()` (around line 624) to make theme-color meta tags dynamic on initial page load:
       ```php
       function stadion_pwa_meta_tags() {
           $theme_url   = STADION_THEME_URL;
           $club_config = new \Stadion\Config\ClubConfig();
           $settings    = $club_config->get_all_settings();
           $club_color  = esc_attr( $settings['accent_color'] );
           // ... existing tags ...
           // Update the two theme-color meta tags to use $club_color instead of hardcoded #006935
       }
       ```
       Note: React's useTheme will override these on mount, but this ensures the initial flash shows the right color before React hydrates.
  </action>
  <verify>
    1. `grep -c "006935" functions.php` should return 0 or only appear inside fallback/default comments (ClubConfig defaults are in class-club-config.php, not functions.php)
    2. `grep "club_config\|ClubConfig" functions.php` shows the dynamic config usage in login and PWA functions
    3. `npm run build` completes without errors (PHP changes don't affect build, but ensure nothing broken)
    4. Test login page renders correctly (deploy and visit /wp-login.php)
  </verify>
  <done>
    - Login page uses club color from ClubConfig for all styling (gradient, buttons, links, borders, shadows)
    - Login page shows club name (from config) or site name as heading
    - Login page favicon uses club color via inline SVG
    - PWA theme-color meta tags use club color from config on initial load
    - All hardcoded AWC green hex values replaced with dynamic values in login styling
    - No #006935 hardcoded in functions.php (all derived from ClubConfig)
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. `npm run lint` passes
3. Settings page: admin sees "Clubconfiguratie" section, non-admin does not
4. Color picker works: visual picker toggle + hex input
5. Live preview: changing color updates app accent in real-time (when accent is "Club")
6. Live preview reverts when navigating away without saving
7. Save updates window.stadionConfig and persists via REST API
8. Login page (/wp-login.php) uses club colors from backend config
9. Login page shows club name heading
10. PWA theme-color meta tags show club color on initial load
11. Fallback to #006935 when no color is configured
</verification>

<success_criteria>
- Admin-only club configuration section in Settings with name, color picker, FreeScout URL
- Live preview of club color changes via direct CSS variable injection (simple: 3 key shades)
- Login page dynamically styled with club color
- Club name shown on login page
- PWA meta tags use club color
- All text in Dutch
- No hardcoded AWC colors remaining in functions.php
</success_criteria>

<output>
After completion, create `.planning/phases/145-frontend-color-refactor/145-02-SUMMARY.md`
</output>
