# Phase 144: Backend Configuration System - Research

**Researched:** 2026-02-05
**Domain:** WordPress Options API, REST API configuration endpoints
**Confidence:** HIGH

## Summary

This phase implements club-wide configuration storage using WordPress Options API and exposes it via REST API. The research examined existing patterns in the Stadion codebase for VOG settings and membership fees, which provide proven templates for implementing club configuration.

The standard approach uses: (1) A service class to encapsulate option storage with const OPTION_KEY naming, (2) REST endpoints following the existing `rondo/v1` namespace with separate GET/POST routes, (3) Admin-only write permissions with read access for all authenticated users, (4) Integration with existing `stadionConfig` JavaScript object and PWA manifest generation.

The codebase already has excellent patterns: `class-vog-email.php` and `class-membership-fees.php` demonstrate proper option management with defaults, sanitization, and validation. The REST API uses `class-rest-base.php` for shared permission callbacks. The PWA manifest is statically generated by Vite but references hardcoded values that need to become dynamic.

**Primary recommendation:** Create `class-club-config.php` service class with Options API storage, register REST endpoints in `class-rest-api.php` following existing patterns, extend `stadion_get_js_config()` to include club config, and optionally generate dynamic PWA manifest via PHP endpoint.

## Standard Stack

The established libraries/tools for this domain:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| WordPress Options API | Core (6.0+) | Site-wide settings storage | Native WordPress solution, no external dependencies |
| WordPress REST API | Core (6.0+) | HTTP API endpoints | Native WordPress solution with built-in authentication |
| sanitize_hex_color() | Core | Hex color validation | WordPress native function for color sanitization |
| sanitize_text_field() | Core | Text input sanitization | WordPress standard for single-line text |
| sanitize_url() | Core | URL validation/sanitization | WordPress standard for URL fields |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| VitePWA | 0.x (in package.json) | PWA manifest generation | Already used for static manifest in vite.config.js |
| wp_localize_script() | Core | Pass PHP data to JS | Already used for stadionConfig object |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Options API | Custom DB table | AGENTS.md Rule 0 forbids custom tables; Options API is simpler |
| Static REST endpoint | Settings API admin UI | Settings API requires admin UI; REST endpoint works with React SPA |
| Vite static manifest | Dynamic PHP manifest | Static is simpler, dynamic allows runtime config (club name, color) |

**Installation:**
No external packages needed - uses WordPress core APIs only.

## Architecture Patterns

### Recommended Project Structure
```
includes/
├── class-club-config.php       # New: Service class for club settings
├── class-rest-api.php          # Modify: Add config endpoints
└── class-rest-base.php         # Existing: Permission callbacks

functions.php                   # Modify: Load new class, extend stadion_get_js_config()
vite.config.js                  # Optional: Make manifest dynamic
```

### Pattern 1: Service Class with Option Constants
**What:** Encapsulate option storage in a dedicated class with const OPTION_KEY naming
**When to use:** For any group of related settings that need validation and defaults
**Example:**
```php
// Source: Existing pattern from class-membership-fees.php and class-vog-email.php
namespace Stadion\Config;

class ClubConfig {
    const OPTION_CLUB_NAME = 'stadion_club_name';
    const OPTION_ACCENT_COLOR = 'stadion_accent_color';
    const OPTION_FREESCOUT_URL = 'stadion_freescout_url';

    const DEFAULTS = [
        'club_name' => '',
        'accent_color' => '#006935',
        'freescout_url' => '',
    ];

    public function get_all_settings(): array {
        return [
            'club_name' => $this->get_club_name(),
            'accent_color' => $this->get_accent_color(),
            'freescout_url' => $this->get_freescout_url(),
        ];
    }

    public function get_club_name(): string {
        return get_option( self::OPTION_CLUB_NAME, self::DEFAULTS['club_name'] );
    }

    public function update_club_name( string $name ): bool {
        $sanitized = sanitize_text_field( $name );
        return update_option( self::OPTION_CLUB_NAME, $sanitized );
    }

    public function get_accent_color(): string {
        $color = get_option( self::OPTION_ACCENT_COLOR, self::DEFAULTS['accent_color'] );
        // Validate hex color format
        $sanitized = sanitize_hex_color( $color );
        return $sanitized ?: self::DEFAULTS['accent_color'];
    }

    public function update_accent_color( string $color ): bool {
        $sanitized = sanitize_hex_color( $color );
        if ( empty( $sanitized ) ) {
            return false; // Invalid color
        }
        return update_option( self::OPTION_ACCENT_COLOR, $sanitized );
    }

    public function get_freescout_url(): string {
        return get_option( self::OPTION_FREESCOUT_URL, self::DEFAULTS['freescout_url'] );
    }

    public function update_freescout_url( string $url ): bool {
        $sanitized = esc_url_raw( $url );
        return update_option( self::OPTION_FREESCOUT_URL, $sanitized );
    }
}
```

### Pattern 2: Dual-Method REST Endpoint (GET + POST)
**What:** Register single route with array of method configurations for read and write
**When to use:** Settings endpoints where GET returns current values, POST updates them
**Example:**
```php
// Source: Existing pattern from class-rest-api.php lines 465-503 (VOG settings)
register_rest_route(
    'rondo/v1',
    '/config',
    [
        [
            'methods'             => \WP_REST_Server::READABLE,
            'callback'            => [ $this, 'get_club_config' ],
            'permission_callback' => [ $this, 'check_user_approved' ], // All users can read
        ],
        [
            'methods'             => \WP_REST_Server::CREATABLE,
            'callback'            => [ $this, 'update_club_config' ],
            'permission_callback' => [ $this, 'check_admin_permission' ], // Admin only write
            'args'                => [
                'club_name' => [
                    'required'          => false,
                    'sanitize_callback' => 'sanitize_text_field',
                ],
                'accent_color' => [
                    'required'          => false,
                    'validate_callback' => function ( $param ) {
                        return empty( $param ) || sanitize_hex_color( $param );
                    },
                ],
                'freescout_url' => [
                    'required'          => false,
                    'sanitize_callback' => 'esc_url_raw',
                ],
            ],
        ],
    ]
);

public function get_club_config( $request ) {
    $club_config = new \Stadion\Config\ClubConfig();
    return rest_ensure_response( $club_config->get_all_settings() );
}

public function update_club_config( $request ) {
    $club_config = new \Stadion\Config\ClubConfig();

    $club_name = $request->get_param( 'club_name' );
    $accent_color = $request->get_param( 'accent_color' );
    $freescout_url = $request->get_param( 'freescout_url' );

    // Update provided settings
    if ( $club_name !== null ) {
        $club_config->update_club_name( $club_name );
    }

    if ( $accent_color !== null ) {
        $club_config->update_accent_color( $accent_color );
    }

    if ( $freescout_url !== null ) {
        $club_config->update_freescout_url( $freescout_url );
    }

    return rest_ensure_response( $club_config->get_all_settings() );
}
```

### Pattern 3: Extend stadionConfig JavaScript Object
**What:** Add club config to window.stadionConfig for React access without API call
**When to use:** Data needed on initial page load (page titles, theme color)
**Example:**
```php
// Source: Existing pattern from functions.php lines 545-579
function stadion_get_js_config() {
    $user    = wp_get_current_user();
    $user_id = get_current_user_id();

    // Get club config
    $club_config = new \Stadion\Config\ClubConfig();
    $config = $club_config->get_all_settings();

    return [
        'apiUrl'              => rest_url(),
        'nonce'               => wp_create_nonce( 'wp_rest' ),
        'siteUrl'             => home_url(),
        'siteName'            => get_bloginfo( 'name' ),
        'userId'              => $user_id,
        'userLogin'           => $user ? $user->user_login : '',
        'isLoggedIn'          => is_user_logged_in(),
        'isAdmin'             => current_user_can( 'manage_options' ),
        // ... existing fields ...

        // Add club config
        'clubName'            => $config['club_name'],
        'accentColor'         => $config['accent_color'],
        'freescoutUrl'        => $config['freescout_url'],
    ];
}
```

### Pattern 4: Dynamic Page Title
**What:** Use club name in page title when configured
**When to use:** Immediately - affects browser tab and PWA
**Example:**
```php
// Source: Existing pattern from functions.php lines 455-467
function stadion_theme_document_title_parts( $title ) {
    if ( is_admin() ) {
        return $title;
    }

    $club_config = new \Stadion\Config\ClubConfig();
    $club_name = $club_config->get_club_name();

    // Use club name if configured, otherwise "Stadion"
    $title['title'] = ! empty( $club_name ) ? $club_name : 'Stadion';
    $title['site']  = '';

    return $title;
}
```

### Pattern 5: Dynamic PWA Manifest (Optional)
**What:** Generate manifest.webmanifest via PHP with dynamic club name and theme color
**When to use:** If PWA manifest needs to reflect club branding
**Example:**
```php
// Source: Research from https://github.com/SuperPWA/Super-Progressive-Web-Apps/blob/master/public/manifest.php
// Register manifest endpoint
register_rest_route(
    'rondo/v1',
    '/manifest',
    [
        'methods'             => \WP_REST_Server::READABLE,
        'callback'            => [ $this, 'get_pwa_manifest' ],
        'permission_callback' => '__return_true', // Public endpoint
    ]
);

public function get_pwa_manifest( $request ) {
    $club_config = new \Stadion\Config\ClubConfig();
    $club_name = $club_config->get_club_name();
    $accent_color = $club_config->get_accent_color();

    $manifest = [
        'name' => ! empty( $club_name ) ? $club_name : 'Stadion',
        'short_name' => ! empty( $club_name ) ? $club_name : 'Stadion',
        'description' => 'Club data management',
        'theme_color' => $accent_color,
        'background_color' => '#ffffff',
        'display' => 'standalone',
        'start_url' => '/dashboard',
        'scope' => '/',
        'icons' => [
            [
                'src' => '/wp-content/themes/rondo-club/public/icons/icon-192x192.png',
                'sizes' => '192x192',
                'type' => 'image/png',
            ],
            // ... more icons
        ],
    ];

    $response = new \WP_REST_Response( $manifest );
    $response->header( 'Content-Type', 'application/manifest+json' );
    return $response;
}
```

### Anti-Patterns to Avoid
- **Storing each setting as separate REST endpoint**: Use single `/config` endpoint with multiple fields (follows existing VOG/fees patterns)
- **Direct `$_POST` access in callbacks**: Use `$request->get_param()` for REST API consistency
- **Missing sanitization**: Always sanitize before `update_option()` - Options API does NOT auto-sanitize
- **Autoload for large data**: Keep config small (<10KB) so default autoload=yes is fine. For larger data, set autoload=no in `update_option()`
- **Hardcoding defaults in multiple places**: Use class constants for single source of truth

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Hex color validation | Regex patterns | sanitize_hex_color() | WordPress core handles 3-digit and 6-digit formats, returns empty string on invalid |
| URL validation | Custom regex | esc_url_raw() or sanitize_url() | WordPress core handles protocols, encoding, malicious input |
| Permission checks | Custom user role logic | check_admin_permission() from class-rest-base.php | Already tested, consistent with other endpoints |
| REST nonce validation | Manual nonce checks | Built-in REST authentication | WordPress REST API handles nonces automatically with wp_rest cookie authentication |
| Settings storage | Custom database table | WordPress Options API | AGENTS.md Rule 0 mandates native WordPress storage; Options API is simpler and works with multisite |

**Key insight:** WordPress core provides sanitization functions for every common input type. Using them ensures consistency with WordPress standards and leverages battle-tested validation logic.

## Common Pitfalls

### Pitfall 1: Missing Option Autoload Optimization
**What goes wrong:** All options default to autoload=yes, loading data on every page request even if unused
**Why it happens:** `add_option()` and `update_option()` autoload by default for backward compatibility
**How to avoid:** For club config (3 small values, used on every page), autoload=yes is correct. For large data (>100KB) or rarely-used options, pass third parameter: `update_option( $key, $value, 'no' )`
**Warning signs:** wp_options table grows large, TTFB increases, WordPress loads megabytes of autoloaded data

### Pitfall 2: Unsanitized Option Values
**What goes wrong:** XSS vulnerabilities or malformed data when admin input is not sanitized
**Why it happens:** Options API stores exactly what you give it - no automatic sanitization
**How to avoid:** Always sanitize in update methods: `sanitize_text_field()` for text, `sanitize_hex_color()` for colors, `esc_url_raw()` for URLs
**Warning signs:** HTML/JavaScript appearing in output, invalid color values breaking CSS, malformed URLs

### Pitfall 3: Forgetting Permission Callback
**What goes wrong:** WordPress 5.5+ shows `_doing_it_wrong` notice; endpoint may be inaccessible
**Why it happens:** Permission callbacks were optional in old versions but are now required
**How to avoid:** Always include `'permission_callback'` in register_rest_route(), use `check_admin_permission()` for admin-only, `check_user_approved()` for authenticated users, or `'__return_true'` for public endpoints
**Warning signs:** Console errors, "permission_callback was called incorrectly" warnings

### Pitfall 4: Validation Runs Before Permission Check
**What goes wrong:** Unauthenticated users can probe for valid data by triggering validation errors
**Why it happens:** WordPress runs validate_callback before permission_callback (by design for error reporting)
**How to avoid:** Keep validation logic simple and non-revealing. Don't leak sensitive info in validation error messages. For sensitive validation, do it inside the callback after permission check.
**Warning signs:** Validation error messages expose internal data structure to unauthenticated users

### Pitfall 5: Not Handling null Parameters in REST Updates
**What goes wrong:** Empty form fields (`''`) differ from missing fields (`null`), causing unintended overwrites
**Why it happens:** REST API distinguishes between "parameter not provided" (null) and "empty value provided" ('')
**How to avoid:** Check `$request->get_param( 'field' ) !== null` before updating, allowing partial updates without overwriting unmodified fields
**Warning signs:** Saving one field clears other fields, need to send all fields on every update

## Code Examples

Verified patterns from official sources:

### Permission Callbacks
```php
// Source: class-rest-base.php lines 35-60
public function check_user_approved() {
    if ( ! is_user_logged_in() ) {
        return false;
    }

    $user_id = get_current_user_id();

    // Admins are always approved
    if ( user_can( $user_id, 'manage_options' ) ) {
        return true;
    }

    // Check if user is approved
    return \RONDO_User_Roles::is_user_approved( $user_id );
}

public function check_admin_permission() {
    return current_user_can( 'manage_options' );
}
```

### Options API with Defaults
```php
// Source: class-vog-email.php lines 58-77
public function get_from_email(): string {
    $email = get_option( self::OPTION_FROM_EMAIL, '' );
    if ( empty( $email ) ) {
        return get_option( 'admin_email' ); // WordPress fallback
    }
    return $email;
}

public function update_from_email( string $email ): bool {
    $sanitized = sanitize_email( $email );
    if ( empty( $sanitized ) && ! empty( $email ) ) {
        return false; // Invalid email provided
    }
    return update_option( self::OPTION_FROM_EMAIL, $sanitized );
}
```

### REST Endpoint Registration
```php
// Source: class-rest-api.php lines 23-40 (reminders endpoint)
register_rest_route(
    'rondo/v1',
    '/reminders',
    [
        'methods'             => \WP_REST_Server::READABLE,
        'callback'            => [ $this, 'get_upcoming_reminders' ],
        'permission_callback' => [ $this, 'check_user_approved' ],
        'args'                => [
            'days_ahead' => [
                'default'           => 30,
                'validate_callback' => function ( $param ) {
                    return is_numeric( $param ) && $param > 0 && $param <= 365;
                },
            ],
        ],
    ]
);
```

### Existing Option Keys (Avoid Conflicts)
```php
// Source: Grep results from includes/*.php
// Existing stadion_ options:
// - stadion_carddav_changes
// - stadion_carddav_sync_tokens
// - stadion_membership_fees
// - stadion_vog_exempt_commissies
// - stadion_vog_from_email
// - stadion_vog_from_name
// - stadion_vog_template_new
// - stadion_vog_template_renewal

// New options for this phase:
// - stadion_club_name
// - stadion_accent_color
// - stadion_freescout_url
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Settings API admin pages | REST API + React SPA | Phase 123 (Settings Backend Foundation) | Settings managed in React UI, not WordPress admin |
| Hardcoded "awc" color | Configurable club color | Phase 144 (this phase) | Need to rename 'awc' → 'club' throughout codebase |
| Static Vite manifest | Dynamic manifest (optional) | Phase 144 (this phase) | PWA can show club branding |
| Hardcoded "Stadion" title | Dynamic club name | Phase 144 (this phase) | Page title reflects club name |

**Deprecated/outdated:**
- **Settings API for SPA settings**: Settings API requires admin pages, incompatible with React SPA. Use REST endpoints instead.
- **permission_callback omission**: WordPress 5.5+ requires explicit permission callbacks. Always include one.

## Open Questions

Things that couldn't be fully resolved:

1. **Should PWA manifest be dynamic or static?**
   - What we know: Vite generates static manifest in vite.config.js lines 12-41. Making it dynamic requires PHP endpoint and updating manifest link in functions.php line 607.
   - What's unclear: Whether PWA manifest updates are worth the complexity. Static manifest means users see "Stadion" in app launcher even after club name is configured.
   - Recommendation: START with static manifest (simpler). Add dynamic manifest in later phase if users request club branding in app launcher. Page titles and UI will show club name immediately.

2. **Should FreeScout URL be validated for reachability?**
   - What we know: esc_url_raw() validates URL format but doesn't check if URL is reachable.
   - What's unclear: Whether to ping FreeScout URL on save to verify it's accessible.
   - Recommendation: Validate format only. Checking reachability adds latency and fails if FreeScout is on internal network. Let users test via frontend integration.

3. **Should accent color replace or coexist with hardcoded colors?**
   - What we know: src/hooks/useTheme.js has ACCENT_COLORS array with 'awc' (hardcoded #006935) and 8 other colors. STATE.md says rename 'awc' → 'club'.
   - What's unclear: Whether users should still be able to choose from predefined palette OR only use club default color.
   - Recommendation: Keep palette for user preference. Rename 'awc' → 'club' and use club config as default for 'club' color. Users can still override with other palette colors.

## Sources

### Primary (HIGH confidence)
- WordPress Options API documentation: https://developer.wordpress.org/apis/options/
- WordPress REST API custom endpoints: https://developer.wordpress.org/rest-api/extending-the-rest-api/adding-custom-endpoints/
- sanitize_hex_color() function: https://developer.wordpress.org/reference/functions/sanitize_hex_color/
- Existing codebase patterns: class-vog-email.php, class-membership-fees.php, class-rest-base.php, class-rest-api.php

### Secondary (MEDIUM confidence)
- WordPress autoload best practices: https://docs.wpvip.com/wordpress-on-vip/autoloaded-options/ and https://felix-arntz.me/blog/autoloading-wordpress-options-efficiently-and-responsibly/
- Dynamic PWA manifest examples: https://github.com/SuperPWA/Super-Progressive-Web-Apps/blob/master/public/manifest.php and https://dev.to/progressier/create-a-pwa-app-manifest-dynamically-1b4b
- REST API permission patterns: https://dev.to/david_woolf/handling-permissions-in-your-wordpress-rest-routes-c6j

### Tertiary (LOW confidence)
- None - all findings verified with official docs or existing codebase

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - WordPress core APIs, verified in official docs and existing codebase
- Architecture: HIGH - Patterns extracted from existing VOG and fees implementations
- Pitfalls: HIGH - Verified with WordPress documentation and known issues from community

**Research date:** 2026-02-05
**Valid until:** 2026-03-05 (30 days - stable WordPress core APIs, unlikely to change)
