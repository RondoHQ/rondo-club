---
phase: 144-backend-configuration-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-club-config.php
  - includes/class-rest-api.php
  - functions.php
autonomous: true

must_haves:
  truths:
    - "GET /stadion/v1/config returns club_name, accent_color, and freescout_url with sensible defaults"
    - "POST /stadion/v1/config allows admin to update any subset of settings"
    - "POST /stadion/v1/config returns 403 for non-admin authenticated users"
    - "Default accent_color is #006935 when no config saved"
    - "Default club_name is empty string when no config saved"
    - "Default freescout_url is empty string when no config saved"
    - "Browser page title shows club name when configured, 'Stadion' when not"
    - "window.stadionConfig includes clubName, accentColor, and freescoutUrl on page load"
  artifacts:
    - path: "includes/class-club-config.php"
      provides: "Club configuration service class with Options API storage"
      contains: "class ClubConfig"
    - path: "includes/class-rest-api.php"
      provides: "REST endpoint for /config"
      contains: "get_club_config"
    - path: "functions.php"
      provides: "ClubConfig loaded, stadionConfig extended, page title dynamic"
      contains: "clubName"
  key_links:
    - from: "includes/class-rest-api.php"
      to: "includes/class-club-config.php"
      via: "new \\Stadion\\Config\\ClubConfig()"
      pattern: "Stadion\\\\Config\\\\ClubConfig"
    - from: "functions.php"
      to: "includes/class-club-config.php"
      via: "stadion_get_js_config() instantiates ClubConfig"
      pattern: "ClubConfig.*get_all_settings"
    - from: "functions.php"
      to: "includes/class-club-config.php"
      via: "stadion_theme_document_title_parts() reads club name"
      pattern: "get_club_name"
---

<objective>
Implement the backend configuration system for club-wide settings (name, accent color, FreeScout URL) using WordPress Options API, exposed via REST API at `/stadion/v1/config`.

Purpose: Phase 145 (frontend Settings UI and color refactor) depends on this API existing. This provides the data layer for all club configuration.
Output: Service class, REST endpoint, stadionConfig extension, dynamic page title.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/144-backend-configuration-system/144-RESEARCH.md
@includes/class-membership-fees.php (pattern reference for service class with OPTION_KEY constants, DEFAULTS, get/update methods)
@includes/class-vog-email.php (pattern reference for Options API with sanitization)
@includes/class-rest-api.php (add config endpoint following VOG settings pattern at lines 464-503)
@includes/class-rest-base.php (check_user_approved and check_admin_permission callbacks)
@functions.php (stadion_get_js_config at line 542, stadion_theme_document_title_parts at line 455, stadion_init at line 310, use statements at line 28)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ClubConfig service class</name>
  <files>includes/class-club-config.php</files>
  <action>
Create `includes/class-club-config.php` in namespace `Stadion\Config` following the established service class pattern from `class-membership-fees.php` and `class-vog-email.php`.

The class must have:

1. **Three option key constants:**
   - `OPTION_CLUB_NAME = 'stadion_club_name'`
   - `OPTION_ACCENT_COLOR = 'stadion_accent_color'`
   - `OPTION_FREESCOUT_URL = 'stadion_freescout_url'`

2. **A DEFAULTS constant array:**
   - `club_name` => `''` (empty string, CFG-05: no club name means use "Stadion")
   - `accent_color` => `'#006935'` (CFG-05: green default)
   - `freescout_url` => `''` (CFG-05: empty means FreeScout hidden)

3. **Getter methods with defaults and validation:**
   - `get_club_name(): string` - returns `get_option(OPTION_CLUB_NAME, DEFAULTS['club_name'])`
   - `get_accent_color(): string` - returns option value validated with `sanitize_hex_color()`, falls back to DEFAULTS if invalid
   - `get_freescout_url(): string` - returns `get_option(OPTION_FREESCOUT_URL, DEFAULTS['freescout_url'])`
   - `get_all_settings(): array` - returns associative array with all three settings

4. **Setter methods with sanitization:**
   - `update_club_name(string $name): bool` - sanitizes with `sanitize_text_field()`
   - `update_accent_color(string $color): bool` - sanitizes with `sanitize_hex_color()`, returns false if invalid
   - `update_freescout_url(string $url): bool` - sanitizes with `esc_url_raw()`

Include proper PHPDoc, `namespace Stadion\Config;`, `if ( ! defined( 'ABSPATH' ) ) { exit; }` guard, and PHPCS-compliant formatting (tabs, WordPress-Extra standard).

The class does NOT extend anything (it is a service class, not a REST class). Follow the exact coding style of class-membership-fees.php: tab indentation, brace positioning, PHPDoc with `@package Stadion\Config`.
  </action>
  <verify>
Check file exists and has correct structure:
- File contains `namespace Stadion\Config;`
- File contains `class ClubConfig`
- File contains all three OPTION_ constants
- File contains DEFAULTS constant with correct values
- File contains get_club_name, get_accent_color, get_freescout_url, get_all_settings methods
- File contains update_club_name, update_accent_color, update_freescout_url methods
- Run `php -l includes/class-club-config.php` for syntax check
  </verify>
  <done>
ClubConfig service class exists at `includes/class-club-config.php` with Options API storage, proper sanitization on all setters, and sensible defaults for all three settings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire REST endpoint, stadionConfig, page title, and class loading</name>
  <files>includes/class-rest-api.php, functions.php</files>
  <action>
Three modifications across two files:

**A. Register REST endpoint in `includes/class-rest-api.php`:**

In the `register_routes()` method, add a new route registration for `/config` following the dual-method pattern used by VOG settings (lines 464-503). Place it after the membership fee settings routes.

```php
// Club configuration (admin write, all-users read)
register_rest_route(
    'stadion/v1',
    '/config',
    [
        [
            'methods'             => \WP_REST_Server::READABLE,
            'callback'            => [ $this, 'get_club_config' ],
            'permission_callback' => [ $this, 'check_user_approved' ],
        ],
        [
            'methods'             => \WP_REST_Server::CREATABLE,
            'callback'            => [ $this, 'update_club_config' ],
            'permission_callback' => [ $this, 'check_admin_permission' ],
            'args'                => [
                'club_name'    => [
                    'required'          => false,
                    'sanitize_callback' => 'sanitize_text_field',
                ],
                'accent_color' => [
                    'required'          => false,
                    'validate_callback' => function ( $param ) {
                        return empty( $param ) || sanitize_hex_color( $param );
                    },
                ],
                'freescout_url' => [
                    'required'          => false,
                    'sanitize_callback' => 'esc_url_raw',
                ],
            ],
        ],
    ]
);
```

Add two callback methods to the class (after the `update_membership_fee_settings` method):

- `get_club_config( $request )`: Creates new `\Stadion\Config\ClubConfig()`, returns `rest_ensure_response( $club_config->get_all_settings() )`.
- `update_club_config( $request )`: Creates new `\Stadion\Config\ClubConfig()`, checks each param with `$request->get_param()` for null (supports partial updates per Pitfall 5 in research), calls appropriate update method, returns `rest_ensure_response( $club_config->get_all_settings() )`.

IMPORTANT: Check `$request->get_param('field') !== null` before updating each field. This allows partial updates (e.g., updating only club_name without touching accent_color).

**B. Extend stadionConfig in `functions.php`:**

In `stadion_get_js_config()` (line 542), add three new keys to the returned array:

```php
// Club configuration
$club_config = new \Stadion\Config\ClubConfig();
$club_settings = $club_config->get_all_settings();
```

Add to the return array:
- `'clubName' => $club_settings['club_name']`
- `'accentColor' => $club_settings['accent_color']`
- `'freescoutUrl' => $club_settings['freescout_url']`

**C. Update page title in `functions.php`:**

In `stadion_theme_document_title_parts()` (line 455), replace the hardcoded `'Stadion'` with dynamic club name:

```php
$club_config = new \Stadion\Config\ClubConfig();
$club_name = $club_config->get_club_name();
$title['title'] = ! empty( $club_name ) ? $club_name : 'Stadion';
```

**D. Load new class in `functions.php`:**

1. Add use statement with the other imports (around line 72, after `use Stadion\Fees\FeeCacheInvalidator;`):
   ```php
   use Stadion\Config\ClubConfig;
   ```

2. Add backward-compatible class alias (after the VOG class alias around line 274):
   ```php
   if ( ! class_exists( 'STADION_Club_Config' ) ) {
       class_alias( ClubConfig::class, 'STADION_Club_Config' );
   }
   ```

Note: The ClubConfig class does NOT need to be instantiated in `stadion_init()` because it has no constructor hooks. It is used on-demand by the REST API callbacks and stadion_get_js_config(). This follows the same pattern as MembershipFees (not instantiated in init, created where needed).
  </action>
  <verify>
1. Run `php -l includes/class-rest-api.php` and `php -l functions.php` for syntax check
2. Deploy to production: `npm run build && bin/deploy.sh`
3. Test REST API read (any authenticated user):
   ```bash
   source .env && ssh -p "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" "cd ~/www/stadion.svawc.nl/public_html/wp-content/themes/stadion && wp eval 'echo json_encode((new \Stadion\Config\ClubConfig())->get_all_settings());'"
   ```
   Expected: `{"club_name":"","accent_color":"#006935","freescout_url":""}`

4. Test updating via WP-CLI:
   ```bash
   source .env && ssh -p "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" "cd ~/www/stadion.svawc.nl/public_html/wp-content/themes/stadion && wp eval 'update_option(\"stadion_club_name\", \"Test Club\"); echo json_encode((new \Stadion\Config\ClubConfig())->get_all_settings());'"
   ```
   Expected: `{"club_name":"Test Club","accent_color":"#006935","freescout_url":""}`

5. Reset test data:
   ```bash
   source .env && ssh -p "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" "cd ~/www/stadion.svawc.nl/public_html/wp-content/themes/stadion && wp eval 'delete_option(\"stadion_club_name\");'"
   ```
  </verify>
  <done>
REST endpoint at `/stadion/v1/config` responds to GET (returns defaults) and POST (admin-only, partial updates). Page title reads from club config with "Stadion" fallback. stadionConfig includes clubName, accentColor, freescoutUrl.
  </done>
</task>

</tasks>

<verification>
1. **CFG-01**: `GET /stadion/v1/config` returns `club_name` field; `POST` allows setting it
2. **CFG-02**: `GET /stadion/v1/config` returns `accent_color` field; `POST` allows setting hex value
3. **CFG-03**: `GET /stadion/v1/config` returns `freescout_url` field; `POST` allows setting it
4. **CFG-04**: GET permission is `check_user_approved` (all authenticated users), POST permission is `check_admin_permission` (admin only)
5. **CFG-05**: Default response is `{"club_name":"","accent_color":"#006935","freescout_url":""}` when no options saved
6. **Page title**: `stadion_theme_document_title_parts()` uses club name when configured, "Stadion" when empty
7. **stadionConfig**: `window.stadionConfig` includes `clubName`, `accentColor`, `freescoutUrl` keys
</verification>

<success_criteria>
- ClubConfig class exists at includes/class-club-config.php with proper namespace, sanitization, and defaults
- REST endpoint /stadion/v1/config handles GET (all users) and POST (admin only)
- Partial updates work (sending only club_name does not reset accent_color)
- stadion_get_js_config() includes all three club config values
- Page title reads from club config with "Stadion" fallback
- All PHP files pass syntax check (php -l)
- Production deployment successful and tested via WP-CLI
</success_criteria>

<output>
After completion, create `.planning/phases/144-backend-configuration-system/144-01-SUMMARY.md`
</output>
