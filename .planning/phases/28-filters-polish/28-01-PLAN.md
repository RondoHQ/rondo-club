---
phase: 28-filters-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-todos.php
  - src/pages/Todos/TodosList.jsx
  - tests/Wpunit/TodoCptTest.php
autonomous: true
---

<objective>
Add todo filtering capabilities with REST API support and frontend filter UI.

Purpose: Enable users to filter todos by status (all/open/completed) and awaiting response, improving task management workflow.
Output: REST API with awaiting_response filter, TodosList with filter controls, PHPUnit test coverage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-pending-response-ui/27-01-SUMMARY.md
@.planning/phases/27-pending-response-ui/27-02-SUMMARY.md

@includes/class-rest-todos.php
@src/pages/Todos/TodosList.jsx
@tests/Wpunit/TodoCptTest.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add awaiting_response filter to REST API</name>
  <files>includes/class-rest-todos.php</files>
  <action>
Add `awaiting_response` query parameter to the `/prm/v1/todos` endpoint in `get_all_todos()`:

1. In `register_routes()`, add `awaiting_response` arg to the `/prm/v1/todos` endpoint args array:
   - Default: null (no filter)
   - validate_callback: accepts bool, 'true', 'false', '1', '0', or null

2. In `get_all_todos()`, after the `$include_completed` handling:
   - Parse `awaiting_response` parameter (normalize like completed param)
   - If `awaiting_response` is true, add meta_query condition:
     ```php
     [
         'key'     => 'awaiting_response',
         'value'   => '1',
         'compare' => '=',
     ]
     ```
   - Handle meta_query merging - if already has meta_query for completion, use 'relation' => 'AND'

Note: Keep existing sorting logic intact. Filter applies before sorting.
  </action>
  <verify>
Test with curl:
- `curl -s "localhost/wp-json/prm/v1/todos" | jq length` returns all open todos
- `curl -s "localhost/wp-json/prm/v1/todos?awaiting_response=true" | jq length` returns only awaiting todos
- `curl -s "localhost/wp-json/prm/v1/todos?awaiting_response=true&completed=true" | jq length` returns awaiting todos including completed
  </verify>
  <done>REST API accepts awaiting_response parameter and filters correctly</done>
</task>

<task type="auto">
  <name>Task 2: Add filter UI to TodosList</name>
  <files>src/pages/Todos/TodosList.jsx</files>
  <action>
Add filter controls to the TodosList page header:

1. Add state for filters:
   ```jsx
   const [statusFilter, setStatusFilter] = useState('open'); // 'all' | 'open' | 'completed'
   const [awaitingFilter, setAwaitingFilter] = useState(false);
   ```

2. Update the useTodos hook call to always fetch all todos (completed=true) since we filter client-side:
   - Change `useTodos(true)` - already fetches all

3. Add filter UI in the header section (between the h1 and the buttons):
   ```jsx
   <div className="flex items-center gap-2">
     {/* Status filter tabs */}
     <div className="flex rounded-lg border border-gray-200 p-0.5">
       <button
         onClick={() => setStatusFilter('all')}
         className={`px-3 py-1 text-sm rounded-md transition-colors ${
           statusFilter === 'all' ? 'bg-primary-100 text-primary-700' : 'text-gray-600 hover:text-gray-900'
         }`}
       >
         All
       </button>
       <button
         onClick={() => setStatusFilter('open')}
         className={`px-3 py-1 text-sm rounded-md transition-colors ${
           statusFilter === 'open' ? 'bg-primary-100 text-primary-700' : 'text-gray-600 hover:text-gray-900'
         }`}
       >
         Open
       </button>
       <button
         onClick={() => setStatusFilter('completed')}
         className={`px-3 py-1 text-sm rounded-md transition-colors ${
           statusFilter === 'completed' ? 'bg-primary-100 text-primary-700' : 'text-gray-600 hover:text-gray-900'
         }`}
       >
         Completed
       </button>
     </div>

     {/* Awaiting response toggle */}
     <button
       onClick={() => setAwaitingFilter(!awaitingFilter)}
       className={`flex items-center gap-1.5 px-3 py-1.5 text-sm rounded-lg border transition-colors ${
         awaitingFilter
           ? 'bg-orange-50 border-orange-200 text-orange-700'
           : 'border-gray-200 text-gray-600 hover:border-gray-300'
       }`}
     >
       <Clock className="w-4 h-4" />
       Awaiting
     </button>
   </div>
   ```

4. Update the useMemo that groups todos to respect filters:
   - First filter by statusFilter: 'all' = no filter, 'open' = !is_completed, 'completed' = is_completed
   - Then filter by awaitingFilter: if true, only show awaiting_response === true
   - Remove the existing grouping logic (incompleteTodos, recentlyCompletedTodos, olderCompletedTodos) and replace with simpler filtered list

5. Simplify the render to show a single filtered list instead of multiple sections:
   - When statusFilter is 'open' or 'all', show the filtered todos
   - When statusFilter is 'completed', show completed todos
   - Remove the "Show all completed" toggle since we now have explicit filter

6. Update empty state messages based on active filters.
  </action>
  <verify>
Run `npm run build` - should complete without errors.
Manual test: Navigate to /todos, verify:
- Status tabs switch between All/Open/Completed views
- Awaiting toggle filters to only awaiting response todos
- Filters can be combined (e.g., Open + Awaiting)
  </verify>
  <done>TodosList has working filter tabs and awaiting toggle with proper empty states</done>
</task>

<task type="auto">
  <name>Task 3: Add PHPUnit tests for awaiting response filter</name>
  <files>tests/Wpunit/TodoCptTest.php</files>
  <action>
Add test methods for the awaiting_response filter in the "Completion Filter Tests" section (or create new "Awaiting Response Filter Tests" section):

1. `test_todos_with_awaiting_response_filter_returns_only_awaiting()`:
   - Create person and 3 todos: 2 with awaiting_response=true, 1 without
   - Call GET /prm/v1/todos?awaiting_response=true
   - Assert only the 2 awaiting todos are returned

2. `test_todos_awaiting_response_filter_with_completed()`:
   - Create person and 4 todos:
     - Open + awaiting
     - Open + not awaiting
     - Completed + awaiting
     - Completed + not awaiting
   - Call GET /prm/v1/todos?awaiting_response=true (no completed param)
   - Assert only open + awaiting is returned
   - Call GET /prm/v1/todos?awaiting_response=true&completed=true
   - Assert both awaiting todos (open and completed) are returned

3. `test_todos_awaiting_response_filter_false_returns_non_awaiting()`:
   - Create person and 2 todos: 1 awaiting, 1 not awaiting
   - Call GET /prm/v1/todos?awaiting_response=false
   - Assert only non-awaiting todo is returned

Update the createTodo helper to support awaiting_response:
```php
private function createTodo( int $person_id, int $user_id, array $data = [] ): int {
    $defaults = [
        'content'           => 'Test todo',
        'is_completed'      => false,
        'due_date'          => '',
        'visibility'        => 'private',
        'awaiting_response' => false,  // Add this
    ];
    // ... existing code ...

    // After existing field updates, add:
    if ( $data['awaiting_response'] ) {
        update_field( 'awaiting_response', true, $post_id );
        update_field( 'awaiting_response_since', gmdate( 'Y-m-d H:i:s' ), $post_id );
    }

    return $post_id;
}
```
  </action>
  <verify>Run `vendor/bin/codecept run Wpunit TodoCptTest` - all tests should pass including new filter tests</verify>
  <done>3 new PHPUnit tests for awaiting_response filter parameter, all passing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] `vendor/bin/codecept run Wpunit TodoCptTest` passes all tests
- [ ] REST API correctly filters by awaiting_response parameter
- [ ] TodosList filter UI works correctly
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- REST API supports awaiting_response filter with proper meta_query
- TodosList has status tabs (All/Open/Completed) and awaiting toggle
- 3 new PHPUnit tests covering filter combinations
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/28-filters-polish/28-01-SUMMARY.md`
</output>
