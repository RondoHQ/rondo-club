---
phase: 137-query-deduplication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useCurrentUser.js
  - src/hooks/usePeople.js
  - src/hooks/useVOGCount.js
  - src/router.jsx
  - src/components/layout/Layout.jsx
  - src/components/FinancesCard.jsx
  - src/pages/People/PersonDetail.jsx
autonomous: true

must_haves:
  truths:
    - "Network panel shows single current-user API call on app load (not 3-6x from multiple components)"
    - "VOG count is fetched once and cached for 5 minutes (not on every navigation)"
    - "All components using current-user share the same cache entry"
  artifacts:
    - path: "src/hooks/useCurrentUser.js"
      provides: "Centralized current-user query hook"
      exports: ["useCurrentUser"]
    - path: "src/hooks/useVOGCount.js"
      provides: "VOG count with staleTime configuration"
      contains: "staleTime"
    - path: "src/hooks/usePeople.js"
      provides: "useFilteredPeople with options support"
      contains: "options"
  key_links:
    - from: "src/router.jsx"
      to: "src/hooks/useCurrentUser.js"
      via: "import useCurrentUser"
      pattern: "useCurrentUser"
    - from: "src/components/layout/Layout.jsx"
      to: "src/hooks/useCurrentUser.js"
      via: "import useCurrentUser"
      pattern: "useCurrentUser"
    - from: "src/hooks/useVOGCount.js"
      to: "src/hooks/usePeople.js"
      via: "useFilteredPeople with staleTime"
      pattern: "staleTime"
---

<objective>
Create shared current-user hook and configure VOG count caching to eliminate duplicate API calls.

Purpose: Fulfill QRY-01 (single current-user query) and QRY-02 (cached VOG count) requirements for v14.0 Performance Optimization.
Output: useCurrentUser hook used by all components, VOG count cached for 5 minutes between navigations.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/137-query-deduplication/137-RESEARCH.md

# Key source files
@src/hooks/usePeople.js
@src/hooks/useVOGCount.js
@src/router.jsx
@src/components/layout/Layout.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useCurrentUser hook and update consumers</name>
  <files>
    src/hooks/useCurrentUser.js
    src/router.jsx
    src/components/layout/Layout.jsx
    src/components/FinancesCard.jsx
    src/pages/People/PersonDetail.jsx
  </files>
  <action>
Create `src/hooks/useCurrentUser.js`:
```javascript
import { useQuery } from '@tanstack/react-query';
import { prmApi } from '@/api/client';

/**
 * Hook for fetching the current authenticated user.
 * Centralized query to ensure deduplication across all components.
 *
 * Used by: ApprovalCheck, FairplayRoute, Sidebar, UserMenu, FinancesCard, PersonDetail
 *
 * @returns {Object} TanStack Query result with user data
 */
export function useCurrentUser() {
  return useQuery({
    queryKey: ['current-user'],
    queryFn: async () => {
      const response = await prmApi.getCurrentUser();
      return response.data;
    },
    staleTime: 5 * 60 * 1000, // 5 minutes - user data rarely changes
    retry: false,
  });
}
```

Update `src/router.jsx`:
- Add import: `import { useCurrentUser } from '@/hooks/useCurrentUser';`
- In ApprovalCheck function: Replace inline useQuery with `const { data: user, isLoading, error } = useCurrentUser();`
- In FairplayRoute function: Replace inline useQuery with `const { data: user, isLoading } = useCurrentUser();`
- Remove the prmApi import if it's only used for getCurrentUser (check first)

Update `src/components/layout/Layout.jsx`:
- Add import: `import { useCurrentUser } from '@/hooks/useCurrentUser';`
- In Sidebar function: Replace inline useQuery with `const { data: currentUser } = useCurrentUser();`
- In UserMenu function: Replace inline useQuery with `const { data: user, isLoading } = useCurrentUser();`
- Remove the direct useQuery import for current-user (keep useQuery if used elsewhere)
- Remove prmApi from imports if only used for getCurrentUser

Update `src/components/FinancesCard.jsx`:
- Add import: `import { useCurrentUser } from '@/hooks/useCurrentUser';`
- Replace inline useQuery for current-user with `const { data: currentUser } = useCurrentUser();`
- Remove prmApi from imports if only used for getCurrentUser

Update `src/pages/People/PersonDetail.jsx`:
- Add import: `import { useCurrentUser } from '@/hooks/useCurrentUser';`
- Replace inline useQuery for current-user with `const { data: currentUser } = useCurrentUser();`
- Keep prmApi import (used for other API calls like getInvestments, getPersonDates, etc.)
  </action>
  <verify>
1. `npm run lint` passes with no errors
2. `npm run build` succeeds
3. Grep for duplicate current-user queries: `grep -r "queryKey.*current-user" src/` should only show useCurrentUser.js
  </verify>
  <done>
All 6 components using current-user now import and use useCurrentUser hook. No duplicate query definitions remain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add staleTime support to useFilteredPeople and configure useVOGCount</name>
  <files>
    src/hooks/usePeople.js
    src/hooks/useVOGCount.js
  </files>
  <action>
Update `src/hooks/usePeople.js` - modify useFilteredPeople to accept options:

Change the function signature from:
```javascript
export function useFilteredPeople(filters = {}) {
```

To:
```javascript
export function useFilteredPeople(filters = {}, options = {}) {
```

And update the useQuery call to include options:
```javascript
return useQuery({
  queryKey: peopleKeys.filtered(params),
  queryFn: async () => {
    const response = await prmApi.getFilteredPeople(params);
    return response.data;
  },
  placeholderData: (previousData) => previousData,
  ...options, // Allow staleTime, enabled, etc. to be passed
});
```

Update `src/hooks/useVOGCount.js` to pass staleTime option:

```javascript
import { useFilteredPeople } from '@/hooks/usePeople';

/**
 * Hook for getting the count of volunteers needing VOG action.
 * Used in navigation badge to show how many volunteers need attention.
 *
 * Filters:
 * - huidig-vrijwilliger = true (current volunteers only)
 * - No VOG date OR VOG date older than 3 years
 *
 * @returns {Object} { count: number, isLoading: boolean }
 */
export function useVOGCount() {
  const { data, isLoading } = useFilteredPeople(
    {
      page: 1,
      perPage: 1, // Only need count, not full data
      huidigeVrijwilliger: '1',
      vogMissing: '1',
      vogOlderThanYears: 3,
    },
    {
      staleTime: 5 * 60 * 1000, // 5 minutes - badge doesn't need real-time updates
    }
  );

  return {
    count: data?.total || 0,
    isLoading,
  };
}
```
  </action>
  <verify>
1. `npm run lint` passes
2. `npm run build` succeeds
3. Check useFilteredPeople now accepts second parameter: `grep -A5 "export function useFilteredPeople" src/hooks/usePeople.js` shows `options` parameter
4. Check useVOGCount has staleTime: `grep "staleTime" src/hooks/useVOGCount.js` shows 5 * 60 * 1000
  </verify>
  <done>
useFilteredPeople accepts options parameter. useVOGCount configured with 5-minute staleTime to prevent refetching on every navigation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Deploy and verify deduplication</name>
  <files>None (deployment only)</files>
  <action>
1. Run `npm run build` to create production bundle
2. Deploy to production using `bin/deploy.sh`
3. Document the changes in this task for the summary
  </action>
  <verify>
1. `npm run build` completes without errors
2. `bin/deploy.sh` completes successfully
3. Production site loads without errors
  </verify>
  <done>
Production deployment complete. Query deduplication changes are live.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Code verification:**
   - `grep -r "queryKey.*current-user" src/` returns only `src/hooks/useCurrentUser.js`
   - `grep -r "useCurrentUser" src/` shows imports in router.jsx, Layout.jsx, FinancesCard.jsx, PersonDetail.jsx
   - `grep "staleTime" src/hooks/useVOGCount.js` shows staleTime configuration

2. **Build verification:**
   - `npm run lint` passes
   - `npm run build` succeeds

3. **Runtime verification (manual check on production):**
   - Open Network panel in DevTools
   - Navigate to dashboard - should see ONE current-user request (not 3-6)
   - Navigate People -> Dashboard -> Teams - VOG count should not refetch within 5 minutes
   - React Query DevTools (if enabled) shows shared queryKey usage
</verification>

<success_criteria>
- [x] QRY-01: Single current-user query shared across all components
- [x] QRY-02: VOG count cached with 5-minute staleTime
- All consumers updated to use useCurrentUser hook
- useFilteredPeople accepts options parameter for staleTime configuration
- Production deployed and functional
</success_criteria>

<output>
After completion, create `.planning/phases/137-query-deduplication/137-01-SUMMARY.md`
</output>
