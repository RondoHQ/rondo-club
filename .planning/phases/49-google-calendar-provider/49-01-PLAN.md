---
phase: 49-google-calendar-provider
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-google-calendar-provider.php
  - includes/class-rest-calendar.php
  - functions.php
autonomous: true
---

<objective>
Implement Google Calendar sync provider with event fetching and upsert logic.

Purpose: Enable fetching calendar events from Google Calendar and storing them locally in the calendar_event CPT for later matching and display.
Output: Working sync that pulls events from Google Calendar and stores them with all metadata (attendees, location, meeting URLs).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-infrastructure/47-01-SUMMARY.md
@.planning/phases/47-infrastructure/47-02-SUMMARY.md
@.planning/phases/48-google-oauth/48-01-SUMMARY.md

# Source files
@includes/class-google-oauth.php
@includes/class-rest-calendar.php
@includes/class-calendar-connections.php
@includes/class-post-types.php
@Calendar-Integration-Implementation-Plan.md

# Codebase context
@.planning/codebase/ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RONDO_Google_Calendar_Provider class with sync logic</name>
  <files>includes/class-google-calendar-provider.php, functions.php</files>
  <action>
Create includes/class-google-calendar-provider.php with the following structure:

```php
class RONDO_Google_Calendar_Provider {

    /**
     * Sync events from Google Calendar for a connection
     *
     * @param int   $user_id    WordPress user ID
     * @param array $connection Connection data from user meta
     * @return array Summary of sync results (created, updated, total)
     * @throws Exception On API errors
     */
    public static function sync(int $user_id, array $connection): array

    /**
     * Get authenticated Google Calendar service
     *
     * @param array $connection Connection with credentials
     * @return Google\Service\Calendar|null Service or null on failure
     */
    private static function get_service(array $connection): ?Google\Service\Calendar

    /**
     * Upsert a single event into calendar_event CPT
     *
     * @param int    $user_id    WordPress user ID
     * @param array  $connection Connection data
     * @param object $event      Google Calendar event object
     * @return int Post ID of created/updated event
     */
    private static function upsert_event(int $user_id, array $connection, $event): int

    /**
     * Extract attendees from Google event
     *
     * @param object $event Google Calendar event
     * @return array Array of attendee data [{email, name, status}]
     */
    private static function extract_attendees($event): array

    /**
     * Extract meeting URL from Google event (Meet, Zoom, Teams links)
     *
     * @param object $event Google Calendar event
     * @return string Meeting URL or empty string
     */
    private static function extract_meeting_url($event): string

    /**
     * Parse event time (handles all-day vs timed events)
     *
     * @param object $event_time Google EventDateTime object
     * @return string ISO 8601 datetime string
     */
    private static function parse_event_time($event_time): string

    /**
     * Check if event is all-day
     *
     * @param object $event Google Calendar event
     * @return bool True if all-day event
     */
    private static function is_all_day($event): bool
}
```

Implementation details:

**sync() method:**
1. Get valid access token via RONDO_Google_OAuth::get_access_token($connection)
2. If no token, throw Exception('Authentication required')
3. Create Google\Client with token, then Google\Service\Calendar
4. Calculate date range:
   - Start: now minus sync_from_days (default 90)
   - End: now plus 30 days
5. Fetch events with listEvents():
   - timeMin: start date (RFC 3339)
   - timeMax: end date (RFC 3339)
   - singleEvents: true (expand recurring)
   - orderBy: startTime
   - maxResults: 250 (paginate if needed)
6. For each event: call upsert_event()
7. Return summary: ['created' => N, 'updated' => M, 'total' => X]

**upsert_event() method:**
1. Check for existing event by _event_uid and _connection_id
2. Build post_data:
   - post_type: 'calendar_event'
   - post_title: event summary (sanitized)
   - post_content: event description (sanitized)
   - post_author: $user_id
   - post_status: 'publish'
   - post_date: event start time
3. Insert or update post
4. Update post meta:
   - _connection_id
   - _event_uid (Google event ID)
   - _calendar_id (from connection)
   - _start_time (ISO 8601)
   - _end_time (ISO 8601)
   - _all_day (bool)
   - _location (sanitized)
   - _meeting_url (Google Meet, Zoom, or Teams link)
   - _organizer_email
   - _attendees (JSON array)
   - _raw_data (full event JSON for debugging)
5. Return post_id

**extract_attendees() method:**
- Get $event->getAttendees() array
- Map to: email, displayName, responseStatus
- Filter out null emails
- Return array

**extract_meeting_url() method:**
1. Check hangoutLink property (Google Meet)
2. Check conferenceData->entryPoints for video links
3. Parse description/location for Zoom/Teams URLs (regex)
4. Return first found URL or empty string

**parse_event_time() method:**
- If $event_time->dateTime exists: return it (timed event)
- If $event_time->date exists: return date + 'T00:00:00' (all-day)
- Handle timezone if present

**is_all_day() method:**
- Return true if getStart()->date is set (not dateTime)

Add class to autoloader in functions.php (after class-google-oauth.php).

Error handling:
- Catch Google API exceptions, wrap in user-friendly messages
- Log errors to WordPress error_log for debugging
- Don't fail entire sync on single event error - log and continue
  </action>
  <verify>
- PHP syntax check: php -l includes/class-google-calendar-provider.php
- Class loads without errors in functions.php
  </verify>
  <done>
- RONDO_Google_Calendar_Provider class created with all methods
- Event upsert creates/updates calendar_event posts with full metadata
- Attendee extraction captures email, name, and response status
- Meeting URL extraction handles Google Meet, Zoom, Teams links
- Class autoloaded in functions.php
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement trigger_sync and get_events REST endpoints</name>
  <files>includes/class-rest-calendar.php</files>
  <action>
Replace the stub implementations in RONDO_REST_Calendar:

**trigger_sync() method:**
1. Get connection_id from request params
2. Get user_id from get_current_user_id()
3. Get connection via RONDO_Calendar_Connections::get_connection()
4. Verify connection exists, return 404 if not
5. Verify provider is 'google' (CalDAV comes in Phase 50)
6. If provider is 'caldav', return 501 with "CalDAV sync not yet implemented"
7. Try sync:
   ```php
   try {
       $result = RONDO_Google_Calendar_Provider::sync($user_id, $connection);

       // Update last_sync timestamp
       RONDO_Calendar_Connections::update_connection($user_id, $connection_id, [
           'last_sync' => current_time('c'),
           'last_error' => null,
       ]);

       return rest_ensure_response([
           'message' => 'Sync completed',
           'created' => $result['created'],
           'updated' => $result['updated'],
           'total'   => $result['total'],
       ]);
   } catch (Exception $e) {
       // Update last_error
       RONDO_Calendar_Connections::update_connection($user_id, $connection_id, [
           'last_error' => $e->getMessage(),
       ]);

       return new WP_Error('sync_failed', $e->getMessage(), ['status' => 500]);
   }
   ```

**get_events() method:**
1. Get current user_id
2. Build WP_Query for calendar_event posts:
   ```php
   $args = [
       'post_type'      => 'calendar_event',
       'author'         => $user_id,
       'posts_per_page' => 100,
       'orderby'        => 'meta_value',
       'meta_key'       => '_start_time',
       'order'          => 'ASC',
   ];
   ```
3. Apply date filters if provided:
   - If 'from' param: add meta_query for _start_time >= from
   - If 'to' param: add meta_query for _start_time <= to
4. Apply person_id filter if provided (for future Phase 51):
   - Skip for now, just ignore the parameter
5. Execute query
6. Map results to response format:
   ```php
   $events = array_map(function($post) {
       return [
           'id'             => $post->ID,
           'title'          => $post->post_title,
           'description'    => $post->post_content,
           'start_time'     => get_post_meta($post->ID, '_start_time', true),
           'end_time'       => get_post_meta($post->ID, '_end_time', true),
           'all_day'        => (bool) get_post_meta($post->ID, '_all_day', true),
           'location'       => get_post_meta($post->ID, '_location', true),
           'meeting_url'    => get_post_meta($post->ID, '_meeting_url', true),
           'organizer'      => get_post_meta($post->ID, '_organizer_email', true),
           'attendees'      => json_decode(get_post_meta($post->ID, '_attendees', true), true) ?: [],
           'connection_id'  => get_post_meta($post->ID, '_connection_id', true),
           'calendar_id'    => get_post_meta($post->ID, '_calendar_id', true),
       ];
   }, $query->posts);
   ```
7. Return response with events array and count
  </action>
  <verify>
- PHP syntax check: php -l includes/class-rest-calendar.php
- With valid Google connection: POST /rondo/v1/calendar/connections/{id}/sync returns 200 with sync results
- GET /rondo/v1/calendar/events returns array of events (empty if no sync yet)
  </verify>
  <done>
- trigger_sync endpoint calls RONDO_Google_Calendar_Provider::sync()
- Connection last_sync and last_error updated after sync
- get_events endpoint returns cached calendar events
- Date range filtering supported via from/to parameters
- CalDAV sync returns 501 (not yet implemented)
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] PHP linting passes on all modified files
- [ ] RONDO_Google_Calendar_Provider class loads without errors
- [ ] trigger_sync endpoint returns proper response for Google connections
- [ ] get_events endpoint returns array of events (empty until sync runs)
- [ ] Event metadata includes attendees, location, meeting URL
</verification>

<success_criteria>

- RONDO_Google_Calendar_Provider class syncs events from Google Calendar
- Events stored in calendar_event CPT with full metadata
- Attendees extracted with email, name, response status
- Meeting URLs extracted (Google Meet, Zoom, Teams)
- trigger_sync endpoint triggers sync for Google connections
- get_events endpoint returns cached events with date filtering
- Error handling preserves last_error on connection
</success_criteria>

<output>
After completion, create .planning/phases/49-google-calendar-provider/49-01-SUMMARY.md
</output>
