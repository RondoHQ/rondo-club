---
phase: 24-todo-post-type
plan: 02
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - includes/class-rest-todos.php
  - functions.php
autonomous: true
---

<objective>
Create `RONDO_REST_Todos` class with full CRUD endpoints for the todo CPT.

Purpose: Provide REST API interface for frontend to manage todos via the new CPT, replacing comment-based endpoints.

Output: New REST class with endpoints for creating, reading, updating, deleting todos both globally and per-person.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-todo-post-type/24-01-SUMMARY.md

@includes/class-rest-base.php
@includes/class-comment-types.php
@includes/class-rest-api.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RONDO_REST_Todos class</name>
  <files>includes/class-rest-todos.php</files>
  <action>
Create new file `includes/class-rest-todos.php` extending `RONDO_REST_Base`. Implement these endpoints:

**Person-scoped endpoints:**
1. `GET /rondo/v1/people/{person_id}/todos` - Get todos for a specific person
2. `POST /rondo/v1/people/{person_id}/todos` - Create todo linked to person

**Global endpoints:**
3. `GET /rondo/v1/todos` - Get all todos for current user (with optional `completed` param)
4. `GET /rondo/v1/todos/{id}` - Get single todo
5. `PUT /rondo/v1/todos/{id}` - Update todo
6. `DELETE /rondo/v1/todos/{id}` - Delete todo

**Key implementation details:**
- Use `check_person_access()` from base class for person-scoped endpoints
- Use `check_user_approved()` for global endpoints
- Add `check_todo_access()` method for single-item operations
- Query `stadion_todo` post type with ACF field `related_person` for person filtering
- Return format matching current comment-based response (id, type, content, person_id, person_name, person_thumbnail, author_id, created, is_completed, due_date)

**Response format (match existing):**
```php
[
    'id' => $post->ID,
    'type' => 'todo',
    'content' => $this->sanitize_text($post->post_title),
    'person_id' => (int) get_field('related_person', $post->ID),
    'person_name' => get_the_title(get_field('related_person', $post->ID)),
    'person_thumbnail' => get_the_post_thumbnail_url(get_field('related_person', $post->ID), 'thumbnail'),
    'author_id' => (int) $post->post_author,
    'created' => $post->post_date,
    'is_completed' => (bool) get_field('is_completed', $post->ID),
    'due_date' => get_field('due_date', $post->ID) ?: null,
]
```

Use `sanitize_text()`, `sanitize_url()` from base class for output sanitization.
For input: `sanitize_textarea_field()` for content, `sanitize_text_field()` for due_date.
  </action>
  <verify>
File exists at `includes/class-rest-todos.php`. Class extends `RONDO_REST_Base`. Has all 6 endpoint methods registered.
  </verify>
  <done>
`RONDO_REST_Todos` class created with all CRUD endpoints and proper permission callbacks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register RONDO_REST_Todos in functions.php</name>
  <files>functions.php</files>
  <action>
In `functions.php`, add the new class to the initialization flow:

1. Add require statement in the includes section (after other class-rest-*.php files):
   `require_once get_template_directory() . '/includes/class-rest-todos.php';`

2. In `rondo_init()` function, instantiate the class (after other REST classes):
   `new RONDO_REST_Todos();`

Follow the existing pattern for other REST classes like `RONDO_REST_People`, `RONDO_REST_Teams`.
  </action>
  <verify>
`grep -n "class-rest-todos" functions.php` shows require_once line.
`grep -n "RONDO_REST_Todos" functions.php` shows instantiation in rondo_init().
  </verify>
  <done>
RONDO_REST_Todos class loaded and instantiated on theme initialization.
  </done>
</task>

<task type="auto">
  <name>Task 3: Test REST API endpoints manually</name>
  <files>-</files>
  <action>
Verify the new endpoints work by:

1. Create a test todo via admin:
   - Go to /wp-admin/post-new.php?post_type=stadion_todo
   - Add title (todo content), select a related person, save

2. Test GET all todos:
   `curl -X GET "https://cael.is/wp-json/rondo/v1/todos" -H "Cookie: <auth_cookie>"`

3. Test GET person todos:
   `curl -X GET "https://cael.is/wp-json/rondo/v1/people/{person_id}/todos" -H "Cookie: <auth_cookie>"`

4. Verify response format matches expected structure (id, type, content, person_id, etc.)

Note: For local testing, use `wp eval` or manual browser testing with logged-in session.
  </action>
  <verify>
Endpoints return valid JSON. Response includes expected fields. No PHP errors in log.
  </verify>
  <done>
REST API endpoints functional: GET/POST/PUT/DELETE working for todos.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `includes/class-rest-todos.php` exists with all methods
- [ ] `functions.php` loads and instantiates the class
- [ ] `GET /rondo/v1/todos` returns array (empty is OK)
- [ ] `GET /rondo/v1/people/{id}/todos` returns array filtered by person
- [ ] Creating todo via admin shows in API response
- [ ] No PHP errors or warnings
</verification>

<success_criteria>

- RONDO_REST_Todos class complete with all 6 endpoints
- Class properly integrated into theme initialization
- Response format matches existing comment-based todo format
- Access control enforced on all endpoints
- Build passes (`npm run build`)
</success_criteria>

<output>
After completion, create `.planning/phases/24-todo-post-type/24-02-SUMMARY.md`
</output>
