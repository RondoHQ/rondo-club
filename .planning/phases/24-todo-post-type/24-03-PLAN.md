---
phase: 24-todo-post-type
plan: 03
type: execute
wave: 3
depends_on: ["24-02"]
files_modified:
  - includes/class-cli-commands.php
  - includes/class-comment-types.php
  - includes/class-rest-api.php
autonomous: true
---

<objective>
Create WP-CLI migration command and remove legacy comment-based todo code.

Purpose: Migrate existing todos from comment system to CPT, then clean up legacy code to avoid confusion and maintain single source of truth.

Output: WP-CLI migration command, cleaned comment-types.php, cleaned rest-api.php.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-todo-post-type/24-01-SUMMARY.md
@.planning/phases/24-todo-post-type/24-02-SUMMARY.md

@includes/class-comment-types.php
@includes/class-rest-api.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WP-CLI migration command for todos</name>
  <files>includes/class-cli-commands.php</files>
  <action>
Add a new WP-CLI command to migrate todos from comment-based to CPT-based storage.

Check if `class-cli-commands.php` exists. If not, create it with `PRM_CLI_Commands` class.

**Command:** `wp prm migrate-todos [--dry-run]`

**Implementation:**
1. Query all comments with `comment_type = 'prm_todo'`
2. For each comment:
   - Create `prm_todo` post with:
     - `post_title` = comment_content (the todo text)
     - `post_author` = comment user_id
     - `post_date` = comment_date
     - `post_status` = 'publish'
   - Set ACF fields:
     - `related_person` = comment_post_ID (the person this todo was on)
     - `is_completed` = get_comment_meta($id, 'is_completed', true)
     - `due_date` = get_comment_meta($id, 'due_date', true)
     - `_visibility` = 'private' (default, todos were always private)
   - On success, delete the original comment
3. Track counts: migrated, skipped, failed
4. `--dry-run` flag shows what would happen without making changes

**Registration:**
```php
if (class_exists('WP_CLI')) {
    WP_CLI::add_command('prm migrate-todos', ['PRM_CLI_Commands', 'migrate_todos']);
}
```

Include the class in functions.php if creating new file.
  </action>
  <verify>
`wp prm migrate-todos --dry-run` runs without error and shows count of todos to migrate. On production, verify with dry-run first.
  </verify>
  <done>
WP-CLI command `wp prm migrate-todos` functional with --dry-run support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove todo endpoints from class-comment-types.php</name>
  <files>includes/class-comment-types.php</files>
  <action>
Remove all todo-related code from `PRM_Comment_Types`:

1. Remove `TYPE_TODO` constant (but keep `TYPE_NOTE` and `TYPE_ACTIVITY`)

2. Remove todo REST routes from `register_rest_routes()`:
   - Remove `/people/{person_id}/todos` route registration
   - Remove `/todos/{id}` route registration

3. Remove todo methods:
   - `get_todos()`
   - `create_todo()`
   - `update_todo()`
   - `delete_todo()`

4. Update `get_timeline()` method:
   - Remove `self::TYPE_TODO` from `type__in` array
   - Remove todo handling from foreach loop

5. Update `exclude_from_regular_queries()`:
   - Remove `self::TYPE_TODO` from exclusion array (no longer exists as comment type)

6. Remove todo meta registration from `register_comment_meta()`:
   - Remove `is_completed` meta registration
   - Remove `due_date` meta registration

Keep: TYPE_NOTE, TYPE_ACTIVITY, all note/activity methods, timeline without todos.
  </action>
  <verify>
`grep -c "todo" includes/class-comment-types.php` should return 0 or very low count (only if word appears in comments/unrelated context).
  </verify>
  <done>
class-comment-types.php cleaned of all todo-related code. Notes and activities still functional.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update class-rest-api.php to remove old todo endpoints</name>
  <files>includes/class-rest-api.php</files>
  <action>
Remove legacy todo code from `PRM_REST_API`:

1. Remove `/prm/v1/todos` route registration from `register_routes()`
   (Now handled by PRM_REST_Todos)

2. Remove `get_all_todos()` method entirely
   (Now handled by PRM_REST_Todos::get_todos())

3. Remove `count_open_todos()` method
   (Will be re-implemented in Task 4 of Plan 04 for dashboard)

4. Update `get_dashboard()` method:
   - Remove call to `$this->count_open_todos()`
   - Set `'open_todos_count' => 0` temporarily (Plan 04 will fix properly)
   - Or leave the field as-is with a TODO comment for Plan 04

Note: The dashboard stat needs to query the new CPT. This is handled in Plan 04.
  </action>
  <verify>
`grep -c "get_all_todos\|count_open_todos" includes/class-rest-api.php` returns 0.
Dashboard endpoint still returns (may show 0 for todos temporarily).
  </verify>
  <done>
class-rest-api.php cleaned of todo code. Dashboard temporarily shows 0 todos.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `wp prm migrate-todos --dry-run` works
- [ ] Run migration on production: `wp prm migrate-todos` (after dry-run)
- [ ] No todo references in class-comment-types.php (grep confirms)
- [ ] No get_all_todos/count_open_todos in class-rest-api.php
- [ ] Notes and activities still work via timeline
- [ ] GET /prm/v1/todos returns todos from CPT (via new class)
- [ ] Build passes (`npm run build`)
</verification>

<success_criteria>

- WP-CLI migration command works with dry-run and actual migration
- All existing todos migrated to CPT posts
- Legacy comment-based todo code removed
- Notes and activities unaffected
- No PHP errors or warnings
</success_criteria>

<output>
After completion, create `.planning/phases/24-todo-post-type/24-03-SUMMARY.md`
</output>
