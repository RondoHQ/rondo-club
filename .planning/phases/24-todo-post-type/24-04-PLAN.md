---
phase: 24-todo-post-type
plan: 04
type: execute
wave: 4
depends_on: ["24-03"]
files_modified:
  - includes/class-rest-api.php
  - tests/Wpunit/TodoCptTest.php
autonomous: true
---

<objective>
Update dashboard endpoint to query todo CPT and add PHPUnit tests for new todo functionality.

Purpose: Complete the backend migration by fixing dashboard stats and ensuring test coverage for the new todo system.

Output: Working dashboard open_todos_count, PHPUnit tests for todo CPT and REST API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-todo-post-type/24-01-SUMMARY.md
@.planning/phases/24-todo-post-type/24-02-SUMMARY.md
@.planning/phases/24-todo-post-type/24-03-SUMMARY.md

@includes/class-rest-api.php
@tests/Wpunit/SearchDashboardTest.php
@tests/Wpunit/CptCrudTest.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update dashboard to count todos from CPT</name>
  <files>includes/class-rest-api.php</files>
  <action>
In `PRM_REST_API`, add new method to count open todos from CPT and update dashboard:

**Add new method `count_open_todos_cpt()`:**
```php
private function count_open_todos_cpt() {
    $user_id = get_current_user_id();
    $access_control = new PRM_Access_Control();

    // Get accessible people for this user
    $accessible_people = $access_control->get_accessible_post_ids('person', $user_id);

    if (empty($accessible_people)) {
        return 0;
    }

    // Query prm_todo posts where:
    // - related_person is in accessible_people
    // - is_completed is false/empty
    // - post_status is publish
    $args = [
        'post_type' => 'prm_todo',
        'post_status' => 'publish',
        'posts_per_page' => -1,
        'fields' => 'ids',
        'meta_query' => [
            'relation' => 'AND',
            [
                'key' => 'related_person',
                'value' => $accessible_people,
                'compare' => 'IN',
            ],
            [
                'relation' => 'OR',
                [
                    'key' => 'is_completed',
                    'value' => '',
                    'compare' => '=',
                ],
                [
                    'key' => 'is_completed',
                    'value' => '0',
                    'compare' => '=',
                ],
                [
                    'key' => 'is_completed',
                    'compare' => 'NOT EXISTS',
                ],
            ],
        ],
    ];

    $query = new WP_Query($args);
    return $query->found_posts;
}
```

**Update `get_dashboard()` method:**
Replace the temporary `0` or old `count_open_todos()` call with:
```php
'open_todos_count' => $this->count_open_todos_cpt(),
```
  </action>
  <verify>
Dashboard API returns accurate `open_todos_count`. Create a test todo, verify count increments. Complete it, verify count decrements.
  </verify>
  <done>
Dashboard `open_todos_count` reflects CPT-based todos correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PHPUnit tests for todo CPT</name>
  <files>tests/Wpunit/TodoCptTest.php</files>
  <action>
Create `tests/Wpunit/TodoCptTest.php` following existing test patterns from SearchDashboardTest and CptCrudTest.

**Test class structure:**
```php
<?php
namespace Tests\Wpunit;

class TodoCptTest extends \Codeception\TestCase\WPTestCase {
    // ... tests
}
```

**Tests to implement:**

1. **CPT Registration:**
   - `test_prm_todo_post_type_registered()` - verify post type exists

2. **Access Control:**
   - `test_user_can_only_see_own_todos()` - user A cannot see user B's todos
   - `test_admin_can_see_all_todos()` - admin bypass works

3. **REST API - CRUD:**
   - `test_get_todos_returns_user_todos()` - GET /prm/v1/todos returns user's todos
   - `test_get_person_todos_filters_by_person()` - GET /prm/v1/people/{id}/todos filters
   - `test_create_todo_creates_prm_todo_post()` - POST creates CPT post
   - `test_update_todo_changes_is_completed()` - PUT updates completion status
   - `test_delete_todo_removes_post()` - DELETE removes post

4. **Dashboard Integration:**
   - `test_dashboard_counts_open_todos()` - verify open_todos_count is accurate
   - `test_completed_todos_not_counted()` - completed todos excluded from count

**Helpers needed:**
- `createApprovedCaelisUser()` - from existing tests
- `createTodo($person_id, $user_id, $data)` - create test todo
- `doRestRequest($method, $route, $data, $user_id)` - REST request helper

Follow patterns from SearchDashboardTest.php for REST API testing (manual server initialization).
  </action>
  <verify>
`vendor/bin/codecept run Wpunit TodoCptTest` passes all tests. No skipped or failed tests.
  </verify>
  <done>
TodoCptTest.php created with 10+ tests covering CPT registration, access control, REST API, and dashboard integration.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and verify no regressions</name>
  <files>-</files>
  <action>
Run the complete PHPUnit test suite to ensure no regressions:

```bash
vendor/bin/codecept run Wpunit
```

All existing tests should still pass:
- SmokeTest
- UserIsolationTest
- VisibilityRulesTest
- WorkspacePermissionsTest
- CptCrudTest
- SearchDashboardTest (verify dashboard test still works)
- RelationshipsSharesTest
- TodoCptTest (new)

If any tests fail:
1. Check if failure is due to removed comment-based todo code
2. Update SearchDashboardTest if it tested old todo endpoints
3. Fix any regressions introduced by changes
  </action>
  <verify>
`vendor/bin/codecept run Wpunit` shows all tests passing. Total should be 120+ (existing) + 10+ (new) = 130+ tests.
  </verify>
  <done>
Full test suite passes. No regressions. Todo CPT fully tested.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `GET /prm/v1/dashboard` returns accurate `open_todos_count`
- [ ] Creating/completing todos changes dashboard count
- [ ] TodoCptTest.php exists with 10+ tests
- [ ] All tests pass: `vendor/bin/codecept run Wpunit`
- [ ] Build passes (`npm run build`)
- [ ] No PHP errors in logs
</verification>

<success_criteria>

- Dashboard open_todos_count queries CPT correctly
- Test coverage for todo CPT: registration, access control, REST API, dashboard
- Full test suite passes (130+ tests)
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/24-todo-post-type/24-04-SUMMARY.md`
</output>
