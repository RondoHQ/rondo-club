---
phase: 24-todo-post-type
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-post-types.php
  - includes/class-access-control.php
  - acf-json/group_todo_fields.json
autonomous: true
---

<objective>
Register `stadion_todo` custom post type with ACF fields and add access control filtering.

Purpose: Foundation for migrating todos from comment-based to CPT-based system. CPT enables proper WordPress query capabilities, visibility/workspace support, and consistent REST API patterns.

Output: `stadion_todo` post type registered, ACF fields defined, access control integrated.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@includes/class-post-types.php
@includes/class-access-control.php
@includes/class-comment-types.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register stadion_todo custom post type</name>
  <files>includes/class-post-types.php</files>
  <action>
Add `register_todo_post_type()` method following existing CPT patterns. Configuration:
- Post type slug: `stadion_todo`
- Labels: "Todos" / "Todo"
- `public: false`, `publicly_queryable: false` (internal only)
- `show_ui: true`, `show_in_menu: true` (admin visibility)
- `show_in_rest: true`, `rest_base: 'todos'` (REST API access)
- `capability_type: 'post'`
- `menu_position: 8` (after Important Dates)
- `menu_icon: 'dashicons-yes-alt'`
- `supports: ['title', 'editor', 'author']` (title=todo text, editor=optional notes)

Call `$this->register_todo_post_type()` from `register_post_types()`.
  </action>
  <verify>
WordPress admin shows "Todos" in left menu after visiting /wp-admin/. Use `wp post-type list | grep stadion_todo` to verify registration.
  </verify>
  <done>
`stadion_todo` post type registered, visible in admin menu, accessible via wp/v2/todos REST endpoint.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ACF field group for todo metadata</name>
  <files>acf-json/group_todo_fields.json</files>
  <action>
Create ACF field group for `stadion_todo` post type with these fields:

1. `related_person` (post_object)
   - Label: "Related Person"
   - Post type: person
   - Return format: ID
   - Required: true

2. `is_completed` (true_false)
   - Label: "Completed"
   - Default: 0
   - UI: toggle

3. `due_date` (date_picker)
   - Label: "Due Date"
   - Return format: Y-m-d
   - Required: false

4. `_visibility` (select)
   - Label: "Visibility"
   - Choices: private|Private, workspace|Workspace, shared|Shared
   - Default: private

5. `_assigned_workspaces` (taxonomy)
   - Label: "Workspaces"
   - Taxonomy: workspace_access
   - Field type: multi_select
   - Conditional: show when _visibility = workspace

Location rule: post_type == stadion_todo
Group key: group_todo_fields
  </action>
  <verify>
With WP_DEBUG=true, edit a Todo in admin - ACF fields should render. Or check `acf-json/` for the new JSON file.
  </verify>
  <done>
ACF field group registered with all fields: related_person, is_completed, due_date, _visibility, _assigned_workspaces.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add access control for stadion_todo</name>
  <files>includes/class-access-control.php</files>
  <action>
Update `STADION_Access_Control` to handle the new `stadion_todo` post type:

1. Add `'stadion_todo'` to `$controlled_post_types` array (line ~17)

2. Add REST API filter hook in constructor:
   `add_filter('rest_stadion_todo_query', [$this, 'filter_rest_query'], 10, 2);`

3. Add REST API single access filter:
   `add_filter('rest_prepare_stadion_todo', [$this, 'filter_rest_single_access'], 10, 3);`

4. Add workspace ID conversion hook:
   `add_action('rest_after_insert_stadion_todo', [$this, 'convert_workspace_ids_after_rest_insert'], 10, 2);`

This ensures todos follow same visibility/workspace rules as person, company, important_date.
  </action>
  <verify>
Create a todo via admin as user A, verify user B cannot see it via REST. Check `$controlled_post_types` includes `stadion_todo`.
  </verify>
  <done>
stadion_todo has full access control: query filtering, REST API filtering, workspace support.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `wp post-type list | grep stadion_todo` shows post type registered
- [ ] `/wp-admin/edit.php?post_type=stadion_todo` loads without error
- [ ] ACF fields visible when creating/editing a todo in admin
- [ ] REST endpoint `/wp/v2/todos` accessible (may be empty)
- [ ] `STADION_Access_Control::$controlled_post_types` includes `stadion_todo`
</verification>

<success_criteria>

- stadion_todo CPT registered with correct configuration
- ACF field group created with all required fields
- Access control fully integrated for new post type
- No errors in PHP error log
- Build passes (`npm run build`)
</success_criteria>

<output>
After completion, create `.planning/phases/24-todo-post-type/24-01-SUMMARY.md`
</output>
