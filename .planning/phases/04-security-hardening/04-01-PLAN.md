---
phase: 04-security-hardening
plan: 01
type: execute
depends_on: []
files_modified: [includes/class-rest-slack.php]
---

<objective>
Implement sodium encryption for Slack bot tokens to replace weak base64 encoding.

Purpose: Protect sensitive OAuth tokens at rest with proper cryptographic encryption. Base64 is encoding, not encryption - if the database is compromised, tokens are immediately usable.
Output: Slack bot tokens encrypted with sodium_crypto_secretbox, transparent to existing functionality.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-rest-api-integrations/03-01-SUMMARY.md

**Key files:**
@includes/class-rest-slack.php

**Security concern from CONCERNS.md:**
- Token stored with base64 encoding at line 236
- Decryption at lines 275, 470

**Sodium approach:**
- Use `sodium_crypto_secretbox()` for symmetric encryption
- Key: Generate once and store in wp-config.php (CAELIS_ENCRYPTION_KEY)
- Nonce: Generate random per encryption, prepend to ciphertext
- Format: nonce (24 bytes) + ciphertext

**Migration strategy:**
- Check if stored value starts with valid nonce length
- If not, assume legacy base64 and migrate on first read
- New writes always use sodium
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sodium encryption/decryption helper methods</name>
  <files>includes/class-rest-slack.php</files>
  <action>
Add two protected methods to PRM_REST_Slack class:

1. `encrypt_token($token)`:
   - Check CAELIS_ENCRYPTION_KEY is defined (return base64 fallback if not)
   - Generate 24-byte random nonce: `random_bytes(SODIUM_CRYPTO_SECRETBOX_NONCEBYTES)`
   - Encrypt: `sodium_crypto_secretbox($token, $nonce, CAELIS_ENCRYPTION_KEY)`
   - Return: base64_encode($nonce . $ciphertext)

2. `decrypt_token($encrypted)`:
   - Check CAELIS_ENCRYPTION_KEY is defined (return base64_decode fallback if not)
   - Decode: base64_decode($encrypted)
   - If decoded length < SODIUM_CRYPTO_SECRETBOX_NONCEBYTES + SODIUM_CRYPTO_SECRETBOX_MACBYTES, assume legacy base64
   - Extract nonce (first 24 bytes) and ciphertext (rest)
   - Decrypt: `sodium_crypto_secretbox_open($ciphertext, $nonce, CAELIS_ENCRYPTION_KEY)`
   - On failure, try legacy base64_decode (migration path)

Place methods after constructor, before register_routes.
  </action>
  <verify>Methods exist in class - check with grep for "function encrypt_token" and "function decrypt_token"</verify>
  <done>Two helper methods added with proper sodium encryption and legacy fallback</done>
</task>

<task type="auto">
  <name>Task 2: Update token storage and retrieval to use encryption</name>
  <files>includes/class-rest-slack.php</files>
  <action>
Replace all base64_encode/decode calls for bot token with new helper methods:

1. Line ~236 (slack_oauth_callback): Replace `base64_encode($bot_token)` with `$this->encrypt_token($bot_token)`

2. Line ~275 (slack_disconnect): Replace `base64_decode($encrypted_token)` with `$this->decrypt_token($encrypted_token)`

3. Line ~470 (get_slack_channels): Replace `base64_decode($bot_token)` with `$this->decrypt_token($bot_token)`

Search for any other occurrences of base64_encode/decode with 'token' to ensure complete coverage.

DO NOT change the user_meta key name - existing tokens will auto-migrate on first decrypt attempt.
  </action>
  <verify>
grep -n "base64_encode\|base64_decode" includes/class-rest-slack.php should return no results related to tokens
Run: php -l includes/class-rest-slack.php (syntax check)
  </verify>
  <done>All token operations use encrypt_token/decrypt_token methods, PHP syntax valid</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `php -l includes/class-rest-slack.php` passes (no syntax errors)
- [ ] `grep -n "encrypt_token\|decrypt_token" includes/class-rest-slack.php` shows both methods defined and called
- [ ] No raw base64_encode/decode of bot_token remains
- [ ] Methods handle missing CAELIS_ENCRYPTION_KEY gracefully (fallback to base64)
</verification>

<success_criteria>

- encrypt_token and decrypt_token methods implemented
- All bot token storage uses encryption
- Legacy base64 tokens auto-migrate on read
- Graceful degradation if CAELIS_ENCRYPTION_KEY not set
- PHP syntax valid
</success_criteria>

<output>
After completion, create `.planning/phases/04-security-hardening/04-01-SUMMARY.md`
</output>
