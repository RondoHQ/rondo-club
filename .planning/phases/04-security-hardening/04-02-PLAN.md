---
phase: 04-security-hardening
plan: 02
type: execute
depends_on: []
files_modified: [includes/class-rest-slack.php, docs/public-endpoints.md]
---

<objective>
Add webhook URL domain validation and document public REST endpoints.

Purpose: Prevent SSRF attacks via webhook URL and ensure public endpoints are intentionally public with documented security rationale.
Output: Webhook URLs restricted to hooks.slack.com, documentation of public endpoints with their security mechanisms.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-rest-api-integrations/03-01-SUMMARY.md

**Key files:**
@includes/class-rest-slack.php

**Security concerns from CONCERNS.md:**
- Webhook URL validation accepts any URL (line 97-98 validate_callback)
- Public endpoints with `__return_true` permission callback need review

**Public endpoints identified (permission_callback = __return_true):**
1. `/slack/oauth/callback` - OAuth redirect, validates state parameter
2. `/slack/commands` - Slack slash command, validates Slack signature
3. `/slack/events` - Slack event subscription, validates Slack signature

All three have legitimate reasons to be public - they receive requests from external services (browser redirect, Slack servers) that cannot authenticate as WordPress users.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add webhook URL domain whitelist validation</name>
  <files>includes/class-rest-slack.php</files>
  <action>
Update the webhook validation in two places:

1. In register_routes() around line 97-98, update the validate_callback:
   ```php
   'validate_callback' => function($param) {
       if (empty($param)) {
           return true;
       }
       if (!filter_var($param, FILTER_VALIDATE_URL)) {
           return false;
       }
       $host = parse_url($param, PHP_URL_HOST);
       return $host === 'hooks.slack.com';
   },
   ```

2. In update_slack_webhook() around line 609, add domain check after FILTER_VALIDATE_URL:
   ```php
   $host = parse_url($webhook, PHP_URL_HOST);
   if ($host !== 'hooks.slack.com') {
       return new WP_Error(
           'invalid_webhook_domain',
           __('Webhook URL must be from hooks.slack.com domain.', 'personal-crm'),
           ['status' => 400]
       );
   }
   ```

This prevents SSRF attacks where an attacker could make the server send requests to internal services.
  </action>
  <verify>
grep -n "hooks.slack.com" includes/class-rest-slack.php should show domain check in both locations
Run: php -l includes/class-rest-slack.php (syntax check)
  </verify>
  <done>Webhook URL validation restricts to hooks.slack.com domain in both validate_callback and method body</done>
</task>

<task type="auto">
  <name>Task 2: Document public REST endpoints and their security</name>
  <files>docs/public-endpoints.md</files>
  <action>
Create documentation file explaining public endpoints:

```markdown
# Public REST API Endpoints

This document lists REST API endpoints that do not require WordPress authentication (`permission_callback => __return_true`). Each has a documented security rationale.

## Slack Integration Endpoints

### POST /prm/v1/slack/oauth/callback

**Purpose:** Receives OAuth redirect from Slack after user authorizes the app.

**Why public:** Browser redirect from Slack cannot carry WordPress authentication.

**Security mechanism:**
- Validates `state` parameter against stored transient (CSRF protection)
- State includes user ID, verified against stored value
- Transient expires in 10 minutes
- Code can only be exchanged once with Slack

### POST /prm/v1/slack/commands

**Purpose:** Receives slash command requests from Slack.

**Why public:** Slack servers cannot authenticate as WordPress users.

**Security mechanism:**
- Validates `X-Slack-Signature` header using HMAC-SHA256
- Validates `X-Slack-Request-Timestamp` (rejects requests older than 5 minutes)
- Requires `CAELIS_SLACK_SIGNING_SECRET` to be configured

### POST /prm/v1/slack/events

**Purpose:** Receives event subscription requests from Slack.

**Why public:** Slack servers cannot authenticate as WordPress users.

**Security mechanism:**
- Only handles URL verification challenge (returns challenge value)
- No sensitive data exposed
- Future event handling would validate Slack signature

## Security Review Checklist

When adding new public endpoints:
1. Document why authentication cannot be used
2. Implement alternative verification (signatures, tokens, state validation)
3. Rate limit if possible
4. Log suspicious activity
5. Add to this document
```
  </action>
  <verify>File exists at docs/public-endpoints.md and contains all three endpoints</verify>
  <done>Documentation file created with all public endpoints documented and security rationale explained</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `php -l includes/class-rest-slack.php` passes (no syntax errors)
- [ ] Webhook validation restricts to hooks.slack.com domain
- [ ] docs/public-endpoints.md exists with all three public endpoints documented
- [ ] Each endpoint has "Why public" and "Security mechanism" sections
</verification>

<success_criteria>

- Webhook URL validation only accepts hooks.slack.com domain
- Public endpoints documented with security rationale
- PHP syntax valid
- Phase 4: Security Hardening complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-security-hardening/04-02-SUMMARY.md`
</output>
