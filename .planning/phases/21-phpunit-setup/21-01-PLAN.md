---
phase: 21-phpunit-setup
plan: 01
type: execute
depends_on: []
files_modified:
  - composer.json
  - codeception.yml
  - tests/.env.testing
  - tests/Support/StadionTestCase.php
  - tests/Wpunit/SmokeTest.php
---

<objective>
Set up PHPUnit testing infrastructure using wp-browser (Codeception) for the Stadion WordPress theme.

Purpose: Establish the foundation for automated testing of access control, REST API, and data model - enabling confident refactoring and feature development.
Output: Working test framework with wp-browser configured, test database created, base test case ready, and a passing smoke test proving the setup works.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-phpunit-setup/21-RESEARCH.md

**Key files:**
@composer.json
@functions.php

**From research - Standard Stack:**
- lucatume/wp-browser ^4.5 (Codeception modules for WordPress)
- WPLoader module with loadOnly: false for integration tests
- Dedicated test database (stadion_test)

**From research - Don't Hand-Roll:**
- WordPress bootstrap (use WPLoader)
- Database reset (use transaction rollback)
- Test fixtures (use self::factory())

**From research - Critical Pitfalls to Avoid:**
- NEVER use dev/prod database - will be wiped
- Must activate ACF Pro in WPLoader plugins config
- Must activate theme in WPLoader for CPT registration
- Call do_action('rest_api_init') in setUp for REST tests

**Decisions from STATE.md:**
- PHPUnit via wp-browser (Codeception) - WordPress-specific test types
- Separate test database (stadion_test) - isolation from dev/prod
- Backend-first testing - Playwright deferred to future milestone
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install wp-browser and create test database</name>
  <files>composer.json</files>
  <action>
1. Add wp-browser as dev dependency:
   ```bash
   composer require --dev lucatume/wp-browser "^4.5"
   ```
   This pulls in Codeception 5.x and PHPUnit automatically.

2. Create the test database via MySQL CLI:
   ```bash
   mysql -u root -e "CREATE DATABASE IF NOT EXISTS stadion_test CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
   ```

   Note: If root requires password, user will need to provide it or create DB manually.

3. Add test script to composer.json scripts section:
   ```json
   "scripts": {
     "test": "vendor/bin/codecept run wpunit",
     "test:coverage": "vendor/bin/codecept run wpunit --coverage --coverage-html"
   }
   ```

**What to avoid:**
- Don't use SQLite for tests - we need MySQL compatibility for production parity
- Don't point to existing stadion database - it WILL be wiped
  </action>
  <verify>
- `composer show lucatume/wp-browser` shows version 4.5.x installed
- `mysql -u root -e "SHOW DATABASES;" | grep stadion_test` returns stadion_test
- `composer test` command exists (will fail until config done)
  </verify>
  <done>wp-browser installed, test database exists, composer test script added</done>
</task>

<task type="auto">
  <name>Task 2: Configure Codeception with WPLoader for Stadion</name>
  <files>codeception.yml, tests/.env.testing, tests/Support/Helper/Wpunit.php</files>
  <action>
1. Create codeception.yml in theme root with WPLoader configuration:
   ```yaml
   namespace: Tests
   support_namespace: Support
   actor_suffix: Tester
   paths:
     tests: tests
     output: tests/_output
     support: tests/Support

   settings:
     shuffle: false
     lint: true

   extensions:
     enabled:
       - Codeception\Extension\RunFailed

   suites:
     Wpunit:
       actor: WpunitTester
       path: Wpunit
       modules:
         enabled:
           - WPLoader
         config:
           WPLoader:
             wpRootFolder: "%WP_ROOT_FOLDER%"
             dbUrl: "%TEST_DB_URL%"
             tablePrefix: "wp_"
             domain: "%WP_DOMAIN%"
             adminEmail: "admin@stadion.test"
             plugins:
               - advanced-custom-fields-pro/acf.php
             theme: stadion
             loadOnly: false
   ```

2. Create tests/.env.testing template (to be copied to .env):
   ```bash
   # WordPress root folder (contains wp-load.php)
   # This is the WordPress installation, NOT the theme folder
   WP_ROOT_FOLDER=/Users/joostdevalk/Code/wordpress

   # Test database connection (WILL BE DROPPED AND RECREATED)
   # Format: mysql://user:password@host:port/database
   TEST_DB_URL=mysql://root@localhost/stadion_test

   # Domain for test requests
   WP_DOMAIN=stadion.test
   ```

3. Copy .env.testing to tests/.env (gitignored):
   ```bash
   cp tests/.env.testing tests/.env
   ```

4. Create directory structure:
   ```
   tests/
   ├── .env.testing
   ├── .env (gitignored)
   ├── _output/ (gitignored)
   ├── Support/
   │   ├── Helper/
   │   │   └── Wpunit.php
   │   └── WpunitTester.php (generated)
   └── Wpunit/
   ```

5. Create tests/Support/Helper/Wpunit.php:
   ```php
   <?php
   namespace Tests\Support\Helper;

   class Wpunit extends \Codeception\Module {
       // Custom helper methods for Stadion tests
   }
   ```

6. Add to .gitignore:
   ```
   tests/.env
   tests/_output/
   ```

7. Run Codeception build to generate actor classes:
   ```bash
   vendor/bin/codecept build
   ```

**What to avoid:**
- Don't set loadOnly: true - we need transaction rollback for test isolation
- Don't forget to activate ACF Pro in plugins array - tests will fail without it
- Don't use theme path as wpRootFolder - must be WordPress root
  </action>
  <verify>
- `cat codeception.yml` shows WPLoader configuration
- `ls tests/Support/` shows Helper/ directory
- `vendor/bin/codecept build` succeeds without errors
  </verify>
  <done>Codeception configured with WPLoader, .env template created, directory structure in place</done>
</task>

<task type="auto">
  <name>Task 3: Create base test case and smoke test</name>
  <files>tests/Support/StadionTestCase.php, tests/Wpunit/SmokeTest.php</files>
  <action>
1. Create tests/Support/StadionTestCase.php - base class for all Stadion tests:
   ```php
   <?php
   namespace Tests\Support;

   use lucatume\WPBrowser\TestCase\WPTestCase;

   /**
    * Base test case for Stadion theme tests.
    *
    * Provides helper methods for creating test fixtures and
    * ensures ACF is properly loaded.
    */
   abstract class StadionTestCase extends WPTestCase {

       protected function set_up(): void {
           parent::set_up();

           // Ensure ACF is fully loaded with local JSON
           if (function_exists('acf_get_local_json_files')) {
               acf_get_local_json_files();
           }
       }

       /**
        * Create a person post with optional ACF fields.
        *
        * @param array $args Post arguments (post_title, post_author, etc.)
        * @param array $acf ACF field values keyed by field name
        * @return int Post ID
        */
       protected function createPerson(array $args = [], array $acf = []): int {
           $defaults = [
               'post_type'   => 'person',
               'post_status' => 'publish',
               'post_author' => get_current_user_id() ?: 1,
           ];

           $post_id = self::factory()->post->create(array_merge($defaults, $args));

           foreach ($acf as $field => $value) {
               update_field($field, $value, $post_id);
           }

           return $post_id;
       }

       /**
        * Create an organization (company) post.
        */
       protected function createOrganization(array $args = [], array $acf = []): int {
           $defaults = [
               'post_type'   => 'company',
               'post_status' => 'publish',
               'post_author' => get_current_user_id() ?: 1,
           ];

           $post_id = self::factory()->post->create(array_merge($defaults, $args));

           foreach ($acf as $field => $value) {
               update_field($field, $value, $post_id);
           }

           return $post_id;
       }

       /**
        * Create a Stadion User with the custom role.
        */
       protected function createStadionUser(array $args = []): int {
           $defaults = ['role' => 'stadion_user'];
           return self::factory()->user->create(array_merge($defaults, $args));
       }

       /**
        * Create an important date linked to a person.
        */
       protected function createImportantDate(int $person_id, array $args = [], array $acf = []): int {
           $defaults = [
               'post_type'   => 'important_date',
               'post_status' => 'publish',
               'post_author' => get_current_user_id() ?: 1,
           ];

           $post_id = self::factory()->post->create(array_merge($defaults, $args));

           // Link to person via ACF relationship field
           update_field('person', $person_id, $post_id);

           foreach ($acf as $field => $value) {
               update_field($field, $value, $post_id);
           }

           return $post_id;
       }
   }
   ```

2. Create tests/Wpunit/SmokeTest.php - verifies the setup works:
   ```php
   <?php
   namespace Tests\Wpunit;

   use Tests\Support\StadionTestCase;

   /**
    * Smoke test to verify PHPUnit/wp-browser setup is working.
    *
    * These tests verify:
    * - WordPress is loaded correctly
    * - Stadion theme is active
    * - Custom post types are registered
    * - ACF Pro is available
    * - Factory methods work
    */
   class SmokeTest extends StadionTestCase {

       public function test_wordpress_is_loaded(): void {
           $this->assertTrue(function_exists('wp_insert_post'));
           $this->assertTrue(defined('ABSPATH'));
       }

       public function test_stadion_theme_is_active(): void {
           $theme = wp_get_theme();
           $this->assertEquals('stadion', $theme->get_stylesheet());
       }

       public function test_person_post_type_is_registered(): void {
           $post_type = get_post_type_object('person');
           $this->assertNotNull($post_type, 'Person post type should be registered');
       }

       public function test_company_post_type_is_registered(): void {
           $post_type = get_post_type_object('company');
           $this->assertNotNull($post_type, 'Company post type should be registered');
       }

       public function test_important_date_post_type_is_registered(): void {
           $post_type = get_post_type_object('important_date');
           $this->assertNotNull($post_type, 'Important Date post type should be registered');
       }

       public function test_acf_pro_is_available(): void {
           $this->assertTrue(
               function_exists('get_field'),
               'ACF Pro should be loaded (get_field function)'
           );
           $this->assertTrue(
               function_exists('update_field'),
               'ACF Pro should be loaded (update_field function)'
           );
       }

       public function test_stadion_user_role_exists(): void {
           $role = get_role('stadion_user');
           $this->assertNotNull($role, 'Stadion User role should exist');
       }

       public function test_can_create_person_with_factory(): void {
           $person_id = $this->createPerson(['post_title' => 'Test Person']);

           $this->assertGreaterThan(0, $person_id);
           $this->assertEquals('person', get_post_type($person_id));
           $this->assertEquals('Test Person', get_the_title($person_id));
       }

       public function test_can_create_stadion_user(): void {
           $user_id = $this->createStadionUser(['user_login' => 'testuser']);

           $this->assertGreaterThan(0, $user_id);
           $user = get_user_by('id', $user_id);
           $this->assertTrue(in_array('stadion_user', $user->roles));
       }

       public function test_database_transactions_rollback(): void {
           // Create a person in this test
           $person_id = $this->createPerson(['post_title' => 'Transaction Test']);

           // Person should exist within this test
           $this->assertNotNull(get_post($person_id));

           // After this test, the person will be rolled back
           // (verified by not persisting between test runs)
       }
   }
   ```

3. Run the smoke test to verify everything works:
   ```bash
   vendor/bin/codecept run wpunit
   ```

**What to avoid:**
- Don't use setUp() - WordPress requires set_up() (snake_case)
- Don't forget parent::set_up() call
- Don't use $this->factory - use self::factory() (static access)
  </action>
  <verify>
- `vendor/bin/codecept run wpunit` shows all tests passing
- Test output shows "OK" with 10 tests (or similar count)
- No errors about missing functions or undefined classes
  </verify>
  <done>Base test case created with helpers, smoke test passes, PHPUnit setup complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `composer show lucatume/wp-browser` shows 4.5.x
- [ ] `vendor/bin/codecept run wpunit` passes all smoke tests
- [ ] tests/.env.testing exists (template, committed)
- [ ] tests/.env exists (local config, gitignored)
- [ ] StadionTestCase.php provides createPerson, createOrganization, createStadionUser helpers
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- wp-browser 4.x installed via Composer
- Test database stadion_test exists
- Codeception configured with WPLoader
- ACF Pro and Stadion theme activated in test environment
- Base test case ready with factory helpers
- All smoke tests passing (WordPress loaded, CPTs registered, ACF available)
- No errors or warnings in test output
</success_criteria>

<output>
After completion, create `.planning/phases/21-phpunit-setup/21-01-SUMMARY.md` following the summary template.

Key items to document:
- wp-browser version installed
- Test database configuration
- Number of smoke tests passing
- Any issues with ACF activation or theme loading
- Decisions made (e.g., WP_ROOT_FOLDER path)
</output>
