---
phase: 02-rest-api-people-companies
plan: 01
type: execute
depends_on: []
files_modified: [includes/class-rest-people.php, includes/class-rest-api.php, functions.php]
---

<objective>
Extract people-related REST API endpoints and methods into a dedicated PRM_REST_People class.

Purpose: Continue the REST API split by moving people domain logic out of the monolithic class.
Output: New `class-rest-people.php` with people endpoints, `class-rest-api.php` reduced by ~300 lines.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-rest-api-infrastructure/01-01-SUMMARY.md
@includes/class-rest-base.php
@includes/class-rest-api.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PRM_REST_People class with routes and methods</name>
  <files>includes/class-rest-people.php</files>
  <action>
Create new file `includes/class-rest-people.php` with class PRM_REST_People extending PRM_REST_Base.

In constructor:
- Add `rest_api_init` action to register_routes method
- Add filter `rest_prepare_person` for expand_person_relationships (priority 10)
- Add filter `rest_prepare_person` for add_person_computed_fields (priority 20)

Register these routes in register_routes():
- `/people/{person_id}/dates` - GET - callback: get_dates_by_person, permission: check_person_access
- `/people/{person_id}/gravatar` - POST - callback: sideload_gravatar, permission: check_person_access
- `/people/{person_id}/photo` - POST - callback: upload_person_photo, permission: check_person_edit_permission

Copy these methods from class-rest-api.php:
- get_dates_by_person (lines ~573-591)
- sideload_gravatar (lines ~1436-1498)
- upload_person_photo (lines ~1580-1648)
- expand_person_relationships (lines ~1313-1380)
- add_person_computed_fields (lines ~1386-1431)

Use protected methods from base class: format_date, format_person_summary.
Permission methods are public in base class and can be used as permission_callback via $this.
  </action>
  <verify>php -l includes/class-rest-people.php shows no syntax errors</verify>
  <done>class-rest-people.php exists with PRM_REST_People class containing all people-specific endpoints and filters</done>
</task>

<task type="auto">
  <name>Task 2: Remove people methods from PRM_REST_API</name>
  <files>includes/class-rest-api.php</files>
  <action>
Remove from class-rest-api.php:

From constructor:
- Remove the two `add_filter('rest_prepare_person', ...)` lines

From register_routes():
- Remove route registration for `/people/{person_id}/dates`
- Remove route registration for `/people/{person_id}/gravatar`
- Remove route registration for `/people/{person_id}/photo`

Remove these methods entirely:
- get_dates_by_person
- sideload_gravatar
- upload_person_photo
- expand_person_relationships
- add_person_computed_fields

Do NOT remove methods that are used by other domains (get_people_by_company stays - it's company-related despite the name).
  </action>
  <verify>php -l includes/class-rest-api.php shows no syntax errors</verify>
  <done>class-rest-api.php no longer contains people-specific routes or methods</done>
</task>

<task type="auto">
  <name>Task 3: Update autoloader and instantiate new class</name>
  <files>functions.php</files>
  <action>
In functions.php:

1. Add autoloader mapping for PRM_REST_People:
   'PRM_REST_People' => 'includes/class-rest-people.php'
   (Add near the PRM_REST_Base and PRM_REST_API mappings)

2. Instantiate the new class in prm_init() function:
   new PRM_REST_People();
   (Add after the PRM_REST_API instantiation)

The order matters - classes should be instantiated so routes don't conflict.
  </action>
  <verify>php -l functions.php shows no syntax errors</verify>
  <done>Autoloader maps PRM_REST_People, class is instantiated in prm_init()</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `php -l includes/class-rest-people.php` passes
- [ ] `php -l includes/class-rest-api.php` passes
- [ ] `php -l functions.php` passes
- [ ] class-rest-people.php contains all 5 people-related methods
- [ ] class-rest-api.php no longer has people-specific routes or methods
</verification>

<success_criteria>

- All tasks completed
- All PHP files pass syntax check
- PRM_REST_People class properly extends PRM_REST_Base
- People endpoints extracted to dedicated class
- No duplicate code between files
</success_criteria>

<output>
After completion, create `.planning/phases/02-rest-api-people-companies/02-01-SUMMARY.md`
</output>
