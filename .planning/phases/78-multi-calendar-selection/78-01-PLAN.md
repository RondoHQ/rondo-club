---
phase: 78-multi-calendar-selection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-calendar.php
  - includes/class-google-calendar-provider.php
  - src/pages/Settings/Settings.jsx
autonomous: true

must_haves:
  truths:
    - "User can select multiple calendars via checkbox UI in EditConnectionModal"
    - "Selected calendars are stored as calendar_ids array in connection data"
    - "Sync pulls events from all selected calendars"
    - "Connection card shows count of selected calendars (e.g., '3 calendars selected')"
    - "Existing single-calendar connections continue to work without user action"
  artifacts:
    - path: "includes/class-google-calendar-provider.php"
      provides: "get_calendar_ids() helper and multi-calendar sync loop"
      contains: "function get_calendar_ids"
    - path: "includes/class-rest-calendar.php"
      provides: "calendar_ids array parameter handling"
      contains: "calendar_ids"
    - path: "src/pages/Settings/Settings.jsx"
      provides: "Checkbox-based multi-calendar selection UI"
      contains: "selectedCalendarIds"
  key_links:
    - from: "src/pages/Settings/Settings.jsx"
      to: "/stadion/v1/calendar/connections/{id}"
      via: "PUT request with calendar_ids array"
      pattern: "calendar_ids"
    - from: "includes/class-google-calendar-provider.php"
      to: "connection.calendar_ids"
      via: "get_calendar_ids helper normalizes old/new format"
      pattern: "get_calendar_ids"
---

<objective>
Enable multi-calendar selection for Google Calendar connections

Purpose: Allow users to sync events from multiple calendars in a single Google Calendar connection, rather than requiring separate connections per calendar.

Output: Working multi-calendar selection with backward-compatible migration, checkbox UI, and sync loop.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/78-multi-calendar-selection/78-RESEARCH.md

Key existing code to reference:
@includes/class-google-calendar-provider.php (sync logic, list_calendars method)
@includes/class-rest-calendar.php (update_connection handler, calendar_ids parameter registration)
@src/pages/Settings/Settings.jsx (EditConnectionModal component)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend multi-calendar support</name>
  <files>
    includes/class-google-calendar-provider.php
    includes/class-rest-calendar.php
  </files>
  <action>
**In class-google-calendar-provider.php:**

1. Add static helper method `get_calendar_ids( array $connection ): array` that:
   - Returns `$connection['calendar_ids']` if present and is non-empty array
   - Falls back to `[$connection['calendar_id']]` if old format present
   - Defaults to `['primary']` if neither present

2. Refactor `do_sync()` to loop over calendars:
   - Extract existing sync-per-calendar logic into private method `sync_single_calendar( int $user_id, array $connection, string $calendar_id ): array`
   - In `do_sync()`, call `get_calendar_ids($connection)` to get array
   - Loop through calendar IDs, calling `sync_single_calendar()` for each
   - Aggregate created/updated/total counts across all calendars
   - Pass correct `$calendar_id` to `upsert_event()` (currently uses `$connection['calendar_id']` hardcoded on line 234)

3. Fix `upsert_event()` to accept calendar_id as parameter (or get it from connection properly)

**In class-rest-calendar.php:**

1. Add `calendar_ids` parameter to create_connection route args (around line 51):
   ```php
   'calendar_ids' => [
       'required'          => false,
       'type'              => 'array',
       'items'             => [ 'type' => 'string' ],
       'sanitize_callback' => function( $value ) {
           if ( ! is_array( $value ) ) return [];
           return array_map( 'sanitize_text_field', $value );
       },
   ],
   ```

2. Add same `calendar_ids` parameter to update_connection route args (around line 134)

3. Update `create_connection()` method to handle `calendar_ids`:
   - If `calendar_ids` array provided, store it
   - If only single `calendar_id` provided, convert to array for storage

4. Update `update_connection()` method (around line 549):
   - Add handling for `calendar_ids` array:
     ```php
     if ( isset( $data['calendar_ids'] ) && is_array( $data['calendar_ids'] ) ) {
         $updates['calendar_ids'] = array_map( 'sanitize_text_field', $data['calendar_ids'] );
         // Clear old single-value fields to avoid confusion
         $updates['calendar_id'] = '';
         $updates['calendar_name'] = '';
     }
     ```

5. Update `get_connection_calendars()` to return `current_ids` (array) alongside `current` (single):
   - Return connection's `calendar_ids` if present
   - Fall back to `[calendar_id]` if old format
  </action>
  <verify>
- `php -l includes/class-google-calendar-provider.php` passes
- `php -l includes/class-rest-calendar.php` passes
- Test API: `curl` PUT to update connection with `calendar_ids: ["cal1", "cal2"]` should save array
  </verify>
  <done>
- REST API accepts and stores `calendar_ids` as array
- `get_calendar_ids()` helper normalizes old format to array
- Sync loops through all selected calendars
- Events store correct `_calendar_id` meta for each source calendar
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend multi-calendar checkbox UI</name>
  <files>
    src/pages/Settings/Settings.jsx
  </files>
  <action>
**In EditConnectionModal component:**

1. Change state from single selection to multi-selection:
   - Replace `selectedCalendarId` state with `selectedCalendarIds` (array)
   - Initialize from `connection.calendar_ids || (connection.calendar_id ? [connection.calendar_id] : [])`

2. Update calendar fetch effect:
   - Set initial selection from `response.data.current_ids` (array) if available
   - Fall back to `[response.data.current]` for backward compat

3. Replace dropdown (`<select>`) with checkbox list:
   ```jsx
   {calendars.length > 0 && (
     <div>
       <label className="label mb-1">Calendars to sync</label>
       <div className="space-y-2 max-h-48 overflow-y-auto border rounded-lg p-3 bg-gray-50 dark:bg-gray-900 dark:border-gray-700">
         {calendars.map((cal) => (
           <label key={cal.id} className="flex items-center gap-2 cursor-pointer">
             <input
               type="checkbox"
               checked={selectedCalendarIds.includes(cal.id)}
               onChange={() => {
                 setSelectedCalendarIds(prev =>
                   prev.includes(cal.id)
                     ? prev.filter(id => id !== cal.id)
                     : [...prev, cal.id]
                 );
               }}
               className="rounded border-gray-300 text-accent-600 focus:ring-accent-500 dark:border-gray-600 dark:bg-gray-800"
             />
             <span className="text-sm text-gray-700 dark:text-gray-300">
               {cal.name}{cal.primary ? ' (Primary)' : ''}
             </span>
           </label>
         ))}
       </div>
       {selectedCalendarIds.length === 0 && (
         <p className="text-xs text-amber-600 dark:text-amber-400 mt-1">
           Select at least one calendar to sync
         </p>
       )}
     </div>
   )}
   ```

4. Update `handleSave()` to send array:
   - Replace `calendar_id` logic with:
     ```javascript
     if (selectedCalendarIds.length > 0) {
       data.calendar_ids = selectedCalendarIds;
     }
     ```
   - Remove `calendar_name` logic (not needed for multi-select)

5. Add validation: disable Save if `selectedCalendarIds.length === 0` for Google connections

**In ConnectionsCalendarsSubtab component (connection card display):**

1. Update the calendar display section (around line 850-851):
   ```jsx
   {/* Multi-calendar display */}
   {connection.calendar_ids?.length > 0 ? (
     <p className="text-xs text-gray-400 dark:text-gray-500">
       {connection.calendar_ids.length} calendar{connection.calendar_ids.length !== 1 ? 's' : ''} selected
     </p>
   ) : connection.calendar_id && connection.calendar_id !== 'primary' ? (
     <p className="text-xs text-gray-400 dark:text-gray-500 truncate max-w-xs">
       {connection.calendar_name || connection.calendar_id}
     </p>
   ) : null}
   ```

2. Ensure backward compatibility: old connections with single `calendar_id` still display correctly
  </action>
  <verify>
- `npm run lint` passes with no errors
- `npm run build` succeeds
- EditConnectionModal shows checkbox list instead of dropdown
- Selecting/deselecting calendars works correctly
- Save button disabled when no calendars selected
- Connection card shows "N calendars selected" for multi-calendar connections
  </verify>
  <done>
- Checkbox UI replaces dropdown in EditConnectionModal
- Users can select multiple calendars
- Save sends `calendar_ids` array to API
- Connection card displays calendar count
- Existing single-calendar connections display correctly (backward compat)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Build check:**
   - `npm run build` succeeds
   - `php -l` passes for all modified PHP files

2. **Backward compatibility:**
   - Existing Google connection with single `calendar_id` continues to work
   - Opening EditConnectionModal shows that calendar as checked
   - Sync still works without any user action

3. **Multi-calendar flow:**
   - Open EditConnectionModal for Google connection
   - See checkbox list of available calendars
   - Check 2-3 calendars
   - Save connection
   - Connection card shows "3 calendars selected"
   - Trigger sync - events from all selected calendars appear

4. **Edge cases:**
   - Unchecking all calendars shows warning and disables Save
   - Connection with no calendar_id/calendar_ids defaults to primary
</verification>

<success_criteria>
- CAL-01: Checkbox UI allows selecting multiple calendars
- CAL-02: `calendar_ids` array stored in connection
- CAL-03: Sync iterates through all selected calendars
- CAL-04: Connection card shows "N calendars selected"
- CAL-05: Old `calendar_id` format normalized to array on read
</success_criteria>

<output>
After completion, create `.planning/phases/78-multi-calendar-selection/78-01-SUMMARY.md`
</output>
