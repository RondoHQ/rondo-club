<plan>
phase: 56
plan: 01
name: Dark Mode & Console Fixes
</plan>

<objective>
Fix dark mode contrast issues in CardDAV connection details and search modal, then investigate and resolve console errors (DOM synchronization and MIME type issues).
</objective>

<execution_context>
@AGENTS.md
@.planning/codebase/CONVENTIONS.md
</execution_context>

<context>
## Phase Goal
Fix dark mode contrast issues and console errors that have accumulated during recent development.

## Issues to Address

1. **CardDAV Connection Details Dark Mode** (Settings.jsx:1481-1525)
   - Problem: `bg-gray-50` and `bg-white` without dark mode variants
   - Solution: Add `dark:bg-gray-800`, `dark:bg-gray-700` classes
   - Todo: `.planning/todos/pending/2026-01-15-carddav-connection-details-dark-mode-contrast.md`

2. **Search Modal Active Result Dark Mode** (Layout.jsx:324-365)
   - Problem: Selected result styling has poor dark mode contrast
   - Current: `bg-accent-50 text-accent-900 dark:bg-accent-900/50 dark:text-accent-100`
   - Solution: Improve dark mode contrast with better accent color usage
   - Todo: `.planning/todos/pending/2026-01-15-fix-search-modal-dark-mode-contrast.md`

3. **DOM Synchronization Errors** (intermittent)
   - Problem: `Failed to execute 'removeChild' on 'Node'` and `insertBefore` errors
   - Likely cause: React 18 StrictMode, lazy loading, or component lifecycle issues
   - Requires investigation
   - Todo: `.planning/todos/pending/2026-01-15-fix-removechild-node-error.md`

4. **MIME Type Errors** (intermittent)
   - Problem: Module scripts served with `text/html` MIME type
   - Likely cause: Stale build artifacts, WordPress rewrites, or cache issues
   - Requires investigation
   - Todo: `.planning/todos/pending/2026-01-15-fix-module-mime-type-errors.md`

## Key Files
- `src/pages/Settings/Settings.jsx` - SyncTab with CardDAV connection details
- `src/components/layout/Layout.jsx` - SearchModal component
- `functions.php` - Asset loading, potential MIME type issues
- `vite.config.js` - Build configuration
</context>

<tasks>
<task id="1">
<name>Fix Dark Mode Contrast Issues</name>
<files>
- src/pages/Settings/Settings.jsx
- src/components/layout/Layout.jsx
</files>
<instructions>
Fix dark mode contrast in two locations:

**1. CardDAV Connection Details (Settings.jsx)**

Find the CardDAV connection details block in SyncTab (around line 1481-1525):
```jsx
{carddavUrls && (
  <div className="p-4 bg-gray-50 rounded-lg space-y-3">
```

Update the styling to include dark mode variants:
- Container: `bg-gray-50` → `bg-gray-50 dark:bg-gray-800`
- Section headers: ensure `dark:text-gray-200` for labels
- Input fields: `bg-white` → `bg-white dark:bg-gray-700`
- Labels: `text-gray-500` → `text-gray-500 dark:text-gray-400`

**2. Search Modal Active Result (Layout.jsx)**

Find the search result button in SearchModal (around line 324-365):
```jsx
<button
  className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors text-left ${
    isSelected ? 'bg-accent-50 text-accent-900 dark:bg-accent-900/50 dark:text-accent-100' : ...
  }`}
>
```

Improve the dark mode selected state contrast:
- Change dark mode selected: `dark:bg-accent-900/50 dark:text-accent-100` → `dark:bg-accent-700 dark:text-white`
- This provides stronger contrast against the dark modal background

Build and verify changes visually in dark mode.
</instructions>
<verification>
- [ ] CardDAV connection details block is readable in dark mode
- [ ] Input fields have proper contrast in dark mode
- [ ] Search modal selected result has clear visual distinction in dark mode
- [ ] No regressions in light mode styling
- [ ] `npm run build` succeeds
</verification>
<wave>1</wave>
<autonomous>true</autonomous>
</task>

<task id="2">
<name>Investigate DOM Synchronization Errors</name>
<files>
- src/components/layout/Layout.jsx
- src/App.jsx
- src/pages/Settings/Settings.jsx
</files>
<instructions>
Investigate the intermittent DOM errors:
- `Failed to execute 'removeChild' on 'Node'`
- `Failed to execute 'insertBefore' on 'Node'`

**Investigation Steps:**

1. **Check for direct DOM manipulation**
   - Search for `document.` calls that might conflict with React
   - Look for third-party libraries doing DOM manipulation

2. **Review lazy loading patterns**
   - Check React.lazy + Suspense usage in App.jsx
   - Verify modal lazy loading patterns
   - Look for race conditions in component mounting

3. **Check for common causes:**
   - React 18 StrictMode double-rendering issues
   - Components updating state after unmount
   - Portal containers being removed before portal content

4. **Look at error sources:**
   - Use browser DevTools to get stack traces
   - Identify which component triggers the error

**Common Fixes:**
- Add null checks before DOM operations
- Use useEffect cleanup functions properly
- Ensure refs are valid before use
- Consider wrapping problematic components in error boundaries

If the issue cannot be reproduced or identified, document findings and mark as "monitoring" - some React 18 StrictMode warnings are benign.
</instructions>
<verification>
- [ ] Investigation documented in task notes
- [ ] Root cause identified (or documented as intermittent/benign)
- [ ] Fix applied if cause found
- [ ] No new console errors introduced
</verification>
<wave>2</wave>
<autonomous>false</autonomous>
<checkpoint>
<type>human-verify</type>
<what-built>Investigation of DOM synchronization errors</what-built>
<how-to-verify>
1. Check if findings are documented
2. Review any proposed fix before applying
3. If no fix found, confirm monitoring approach is acceptable
</how-to-verify>
</checkpoint>
</task>

<task id="3">
<name>Investigate MIME Type Errors</name>
<files>
- functions.php
- vite.config.js
- .htaccess (if exists)
</files>
<instructions>
Investigate the MIME type errors for module scripts:
```
Failed to load module script: Expected a JavaScript-or-Wasm module script
but the server responded with a MIME type of "text/html"
```

**Investigation Steps:**

1. **Check asset loading in functions.php**
   - Review how manifest.json is read
   - Verify paths are correctly resolved
   - Check for 404 fallbacks returning HTML

2. **Review Vite build output**
   - Check dist/ structure after build
   - Verify manifest.json contains correct paths
   - Look for hash mismatches

3. **Check WordPress rewrite rules**
   - Review .htaccess for JS file handling
   - Check if WordPress catches JS requests

4. **Test in different scenarios:**
   - Fresh build + deploy
   - Browser with cleared cache
   - Different browsers

**Common Fixes:**
- Ensure manifest.json is read correctly
- Add proper Content-Type headers for JS files
- Clear all caches after deploy (browser, WordPress, CDN)
- Add version busting to script URLs

If issue is deployment-related, document the proper deploy procedure.
</instructions>
<verification>
- [ ] Investigation documented in task notes
- [ ] Root cause identified
- [ ] Fix applied if cause found
- [ ] Deploy procedure updated if needed
</verification>
<wave>2</wave>
<autonomous>false</autonomous>
<checkpoint>
<type>human-verify</type>
<what-built>Investigation of MIME type errors</what-built>
<how-to-verify>
1. Check if findings are documented
2. Review any proposed fix before applying
3. Test in production after fix
</how-to-verify>
</checkpoint>
</task>
</tasks>

<verification>
- [ ] All dark mode contrast issues fixed
- [ ] DOM synchronization errors investigated/resolved
- [ ] MIME type errors investigated/resolved
- [ ] Build succeeds with no warnings
- [ ] Visual verification in both light and dark modes
</verification>

<success_criteria>
- [ ] CardDAV connection details readable in dark mode
- [ ] Search modal selected result clearly visible in dark mode
- [ ] Console errors investigated with documented findings
- [ ] Fixes applied where root cause identified
</success_criteria>

<output>
After completing all tasks:
1. Move completed todo files to `.planning/todos/done/`
2. Update STATE.md with phase completion
3. Create 56-01-SUMMARY.md with:
   - Dark mode fixes applied
   - Console error investigation findings
   - Any fixes applied or monitoring recommendations
</output>
