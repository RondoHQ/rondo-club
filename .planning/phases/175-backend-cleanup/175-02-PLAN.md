---
phase: 175-backend-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-reminders.php
  - includes/class-ical-feed.php
  - includes/class-wp-cli.php
  - includes/class-email-channel.php
  - includes/class-rest-import-export.php
  - includes/class-rest-people.php
  - functions.php
autonomous: true

must_haves:
  truths:
    - "Reminders system no longer uses date_type field in its data structures"
    - "iCal feed no longer includes date_type in CATEGORIES or data arrays"
    - "Deprecated WP-CLI commands for important_dates are fully removed"
    - "No stale important_date references remain in backend code"
    - "Email channel wording no longer mentions 'important dates'"
  artifacts:
    - path: "includes/class-reminders.php"
      provides: "Reminders without date_type field"
    - path: "includes/class-ical-feed.php"
      provides: "iCal feed without date_type references"
    - path: "includes/class-wp-cli.php"
      provides: "CLI without deprecated RONDO_Dates_CLI_Command class"
    - path: "functions.php"
      provides: "Route map without important_date entry"
  key_links:
    - from: "includes/class-reminders.php"
      to: "includes/class-email-channel.php"
      via: "digest data format (date_type removed from arrays)"
      pattern: "date_type"
    - from: "includes/class-ical-feed.php"
      to: "iCal output"
      via: "CATEGORIES line removed for birthday-only system"
      pattern: "CATEGORIES"
---

<objective>
Remove residual important_date, date_type, and deprecated CLI references from the backend, completing the cleanup of features removed in v19.0.

Purpose: These are stale references to the important_date CPT removed in v19.0. The system now only handles birthdays directly on person records, making date_type fields and important_date references dead code that confuses the codebase.
Output: Clean backend with no references to the removed important_date system or date_type taxonomy.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@includes/class-reminders.php
@includes/class-ical-feed.php
@includes/class-wp-cli.php
@includes/class-email-channel.php
@includes/class-rest-import-export.php
@functions.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove date_type from reminders and iCal systems</name>
  <files>
    includes/class-reminders.php
    includes/class-ical-feed.php
    includes/class-email-channel.php
  </files>
  <action>
1. **class-reminders.php**:
   - In `get_upcoming_dates()` (around line 336): Remove `'date_type' => ['Birthday']` from the data array in `$upcoming[]`. This field is only used by the frontend for display, and since the system ONLY generates birthday entries now, the type is implicit. Remove the key entirely from the array.
   - In `get_weekly_digest_dates()` (around line 484): Same change -- remove `'date_type' => ['Birthday']` from the `$date_item` array.
   - **Important**: Check if any downstream consumer of these methods reads `date_type`. The email channel and API both consume this data. If the email channel or API templates reference `$date['date_type']`, those references must also be cleaned up.

2. **class-ical-feed.php**:
   - In `get_user_dates()` (around line 261): Remove `'date_type' => 'Birthday'` from the dates array.
   - In `format_event()` or wherever the iCal VEVENT is built (around lines 372-373): Remove the block that checks `if (!empty($date['date_type']))` and adds `CATEGORIES:` line. Since we're removing date_type from the data, this code would be dead. Remove it entirely.
   - In the workspace feed method (around line 457): Remove `'date_type' => 'Birthday'` from the dates array.
   - Update the comment on line 209 from "Get all important dates accessible to this user" to "Get all birthday events accessible to this user" (the method already returns birthday data only, the comment is stale).

3. **class-email-channel.php**:
   - On line 112: Change the email template text from `'Here are your important dates and to-dos for this week:'` to `'Here are your birthdays and to-dos for this week:'`. The system only handles birthdays now, so "important dates" is misleading.
  </action>
  <verify>
Run: `grep -rn 'date_type' includes/class-reminders.php includes/class-ical-feed.php` -- should return zero results.
Run: `grep -rn 'important.date' includes/class-email-channel.php` -- should return zero results.
Run: `php -l includes/class-reminders.php && php -l includes/class-ical-feed.php && php -l includes/class-email-channel.php` -- no syntax errors.
  </verify>
  <done>
Reminders system generates birthday data without date_type field. iCal feed generates events without CATEGORIES line or date_type. Email channel text accurately says "birthdays" instead of "important dates".
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove deprecated WP-CLI commands and stale important_date references</name>
  <files>
    includes/class-wp-cli.php
    includes/class-rest-import-export.php
    includes/class-rest-people.php
    functions.php
  </files>
  <action>
1. **class-wp-cli.php**:
   - Remove the entire `RONDO_Dates_CLI_Command` class (lines 626-644). It contains only the deprecated `regenerate_titles()` method that errors out.
   - Remove the WP-CLI command registration for it at line 2712: `WP_CLI::add_command('prm dates', 'RONDO_Dates_CLI_Command');`
   - In `RONDO_Migration_CLI_Command`, remove the deprecated `migrate_birthdates()` method (lines 364-373) that just errors out.
   - Remove the command registration at line 2709: `WP_CLI::add_command('rondo migrate-birthdates', [...]);`
   - Remove the deprecated `update_date_references()` method in the merge/duplicate CLI class (lines 2020-2031). It's a no-op. Also find and remove any call to `$this->update_date_references()` in the same class (it may be called from a merge method).
   - Update the reminder CLI messages (lines 89-91): Replace the misleading messages about "No important dates exist" with accurate messages. Change to something like:
     - "1. No people with birthdates exist in the system"
     - "2. People exist but have no birthdates set"
     - Remove line about "People exist but are not linked to any dates" as it refers to the old linked-date model.

2. **includes/class-rest-import-export.php**:
   - On line 363: Update the docblock `@param array $person_dates Array of person's important dates.` -- since this parameter deals with vCard generation which no longer handles important_dates, update the docblock to accurately reflect what the parameter contains (check whether `$person_dates` is still passed or used; if it's an empty/unused parameter, note that).

3. **includes/class-rest-people.php**:
   - On line 659: Remove or update the comment `// Deceased status is no longer computed from important_date` and the comment `// (that system was removed in v19.0)` -- these are stale explanatory comments. Replace with a simple comment: `// Deceased status field (reserved for future use)` or remove the comment entirely since the code `$data['is_deceased'] = false;` is self-explanatory.

4. **functions.php**:
   - On line 738: Remove the `'important_date' => 'dates'` entry from the `$route_map` array. The important_date CPT no longer exists, so this mapping is dead code.
  </action>
  <verify>
Run: `grep -rn 'important_date\|important.date' includes/class-wp-cli.php` -- should return zero results.
Run: `grep -rn 'important_date' functions.php` -- should return zero results.
Run: `grep -rn 'RONDO_Dates_CLI' includes/class-wp-cli.php` -- should return zero results.
Run: `grep -rn 'migrate.birthdates\|migrate_birthdates' includes/class-wp-cli.php` -- should return zero results.
Run: `php -l includes/class-wp-cli.php && php -l functions.php && php -l includes/class-rest-people.php && php -l includes/class-rest-import-export.php` -- no syntax errors.
  </verify>
  <done>
All deprecated WP-CLI commands related to important_dates are removed. The `prm dates` CLI namespace no longer exists. The `rondo migrate-birthdates` command is removed. Stale important_date references in functions.php route map, REST people computed fields, and import-export docblocks are cleaned up. CLI reminder messages accurately describe the birthday-only system.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn 'date_type' includes/ --include='*.php'` returns zero results
2. `grep -rn 'important_date' includes/ functions.php --include='*.php'` returns zero results (excluding any legitimate "was removed" changelog-type comments if they exist in other files)
3. `grep -rn 'RONDO_Dates_CLI' includes/ --include='*.php'` returns zero results
4. All modified PHP files pass `php -l` syntax check
5. Requirements CLEAN-01, CLEAN-02, CLEAN-03, CLEAN-04 are satisfied
</verification>

<success_criteria>
- date_type field is removed from reminders and iCal data structures
- iCal CATEGORIES line is no longer generated
- Email channel accurately says "birthdays" instead of "important dates"
- RONDO_Dates_CLI_Command class and its registration are removed
- migrate_birthdates deprecated command is removed
- update_date_references no-op method is removed
- functions.php route map no longer includes important_date
- Stale comments referencing removed systems are updated
- All PHP files pass syntax checks
</success_criteria>

<output>
After completion, create `.planning/phases/175-backend-cleanup/175-02-SUMMARY.md`
</output>
