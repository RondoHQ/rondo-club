---
phase: 175-backend-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-taxonomies.php
  - includes/class-rest-base.php
  - includes/class-rest-people.php
  - includes/class-rest-teams.php
  - includes/class-rest-google-sheets.php
  - tests/Wpunit/RelationshipsSharesTest.php
autonomous: true

must_haves:
  truths:
    - "person_label and team_label taxonomies are no longer registered in WordPress"
    - "REST API responses for people and teams no longer include a 'labels' field"
    - "Bulk update endpoints for people and teams no longer accept labels_add/labels_remove"
    - "Filtered people endpoint no longer accepts a labels filter parameter"
    - "Google Sheets export no longer includes a labels column"
  artifacts:
    - path: "includes/class-taxonomies.php"
      provides: "Taxonomy registration without person_label or team_label"
      contains: "register_commissie_label_taxonomy"
    - path: "includes/class-rest-base.php"
      provides: "Summary formatters without labels field"
    - path: "includes/class-rest-people.php"
      provides: "People endpoints without label references"
    - path: "includes/class-rest-teams.php"
      provides: "Teams bulk-update endpoint without label references"
  key_links:
    - from: "includes/class-rest-people.php"
      to: "includes/class-taxonomies.php"
      via: "person_label taxonomy removed"
      pattern: "person_label"
    - from: "includes/class-rest-teams.php"
      to: "includes/class-taxonomies.php"
      via: "team_label taxonomy removed"
      pattern: "team_label"
---

<objective>
Remove person_label and team_label taxonomy registrations and all label-related code from REST API endpoints, response formatters, and backend query logic.

Purpose: These taxonomies are unused dead features that add unnecessary complexity. Removing them simplifies the data model and reduces API payload size.
Output: Clean PHP backend with no person_label or team_label references in taxonomy registration, REST endpoints, or API responses.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@includes/class-taxonomies.php
@includes/class-rest-base.php
@includes/class-rest-people.php
@includes/class-rest-teams.php
@includes/class-rest-google-sheets.php
@tests/Wpunit/RelationshipsSharesTest.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove label taxonomy registrations and REST label references</name>
  <files>
    includes/class-taxonomies.php
    includes/class-rest-base.php
    includes/class-rest-people.php
    includes/class-rest-teams.php
    includes/class-rest-google-sheets.php
  </files>
  <action>
1. **class-taxonomies.php**: Remove the `register_person_label_taxonomy()` method (lines 35-58) and the `register_team_label_taxonomy()` method (lines 64-88). Remove the two calls to these methods in `register_taxonomies()` (lines 25-26). Keep `register_commissie_label_taxonomy`, `register_relationship_type_taxonomy`, and `register_seizoen_taxonomy` untouched.

2. **class-rest-base.php**: In `format_person_summary()` (around line 206), remove the `'labels'` key/value line that calls `wp_get_post_terms($post->ID, 'person_label', ...)`. In `format_company_summary()` (around line 226), remove the `'labels'` key/value line that calls `wp_get_post_terms($post->ID, 'team_label', ...)`.

3. **class-rest-people.php**:
   - In the `bulk-update` route registration (around lines 151-200): Remove the `labels_add` and `labels_remove` validation blocks from the `updates` parameter validator. Update the `$has_update` check to only check for `organization_id` (remove `labels_add`/`labels_remove` from the OR conditions). After removing labels, the bulk-update endpoint still serves a purpose for `organization_id` updates.
   - In `bulk_update_people()` method (around lines 917-926): Remove the two blocks that handle `labels_add` (wp_set_object_terms) and `labels_remove` (wp_remove_object_terms). Update the docblock to remove references to labels_add/labels_remove.
   - In the `filtered` route registration (around lines 230-244): Remove the `'labels'` parameter definition entirely.
   - In `get_filtered_people()` method (around line 1000): Remove `$labels = $request->get_param('labels') ?: [];`
   - In the SQL query builder (around lines 1087-1094): Remove the entire label filter block that adds JOIN clauses for `term_relationships`/`term_taxonomy` and the WHERE clause for `tt.term_id IN`.
   - In the results formatter (around line 1347): Remove the `'labels'` key/value from the person array.

4. **class-rest-teams.php**:
   - In the `bulk-update` route registration (around lines 143-179): Since labels are the ONLY update type for teams bulk-update, the entire `bulk-update` route and `bulk_update_teams()` method become purposeless. Remove the entire route registration block and the `bulk_update_teams()` method. Also remove the corresponding `check_bulk_update_authorization` method if it exists solely for this endpoint (check if it's shared with other endpoints first -- if shared, keep it).
   - Alternatively, if `check_bulk_update_authorization` is shared with people, keep the method but remove only the teams bulk-update route registration.

5. **class-rest-google-sheets.php**:
   - Remove the `get_labels()` private method (around lines 1255-1264) that calls `wp_get_post_terms($person['id'], 'person_label')`.
   - In the column value resolver (around line 1190), remove the `case 'labels':` case that calls `$this->get_labels()`. If the surrounding switch statement can encounter a 'labels' column from saved user config, let it fall through to the default which returns empty string for unknown ACF fields -- this is safe.
  </action>
  <verify>
Run: `grep -rn 'person_label\|team_label' includes/ --include='*.php'` -- should return zero results.
Run: `grep -rn "labels.*person_label\|labels.*team_label\|person_label.*labels\|team_label.*labels" includes/ --include='*.php'` -- should return zero results.
  </verify>
  <done>
No PHP file in includes/ references person_label or team_label taxonomy. REST API responses for people and teams no longer include labels. Bulk-update endpoints no longer handle label operations. Filtered people endpoint no longer accepts labels parameter. Google Sheets export handles missing labels column gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove label-related tests and add taxonomy DB cleanup</name>
  <files>
    tests/Wpunit/RelationshipsSharesTest.php
    includes/class-taxonomies.php
  </files>
  <action>
1. **tests/Wpunit/RelationshipsSharesTest.php**: Remove the following test methods entirely:
   - `test_people_bulk_update_add_labels()` (around lines 595-628) -- tests adding person_label via bulk-update
   - `test_people_bulk_update_remove_labels()` (around lines 633-669) -- tests removing person_label via bulk-update
   - `test_teams_bulk_update_add_labels()` (around lines 745-778) -- tests adding team_label via bulk-update

2. **includes/class-taxonomies.php**: Add a static method `cleanup_removed_taxonomies()` that can be called during theme activation or via WP-CLI to delete all person_label and team_label terms from the database. Implementation:
   ```php
   public static function cleanup_removed_taxonomies() {
       $taxonomies = ['person_label', 'team_label'];
       foreach ($taxonomies as $taxonomy) {
           $terms = get_terms([
               'taxonomy'   => $taxonomy,
               'hide_empty' => false,
               'fields'     => 'ids',
           ]);
           if (!is_wp_error($terms)) {
               foreach ($terms as $term_id) {
                   wp_delete_term($term_id, $taxonomy);
               }
           }
       }
   }
   ```
   Note: Since the taxonomies are no longer registered, this method must be called BEFORE removing the registration, OR it should use direct DB queries instead. Actually, since we've already removed the registration in Task 1, use raw `$wpdb` queries to clean up:
   ```php
   global $wpdb;
   $wpdb->query("DELETE tr FROM {$wpdb->term_relationships} tr
       INNER JOIN {$wpdb->term_taxonomy} tt ON tr.term_taxonomy_id = tt.term_taxonomy_id
       WHERE tt.taxonomy IN ('person_label', 'team_label')");
   $wpdb->query("DELETE FROM {$wpdb->term_taxonomy} WHERE taxonomy IN ('person_label', 'team_label')");
   // Clean up orphaned terms (terms not in any term_taxonomy)
   $wpdb->query("DELETE t FROM {$wpdb->terms} t
       LEFT JOIN {$wpdb->term_taxonomy} tt ON t.term_id = tt.term_id
       WHERE tt.term_id IS NULL");
   ```
   Call this method during `register_taxonomies()` with a one-time option check: only run if `get_option('rondo_labels_cleaned') !== '1'`, then set `update_option('rondo_labels_cleaned', '1')` after cleanup. This ensures it runs exactly once after deployment.
  </action>
  <verify>
Run: `grep -rn 'person_label\|team_label' tests/ --include='*.php'` -- should return zero results.
Verify class-taxonomies.php has the cleanup method and one-time trigger.
  </verify>
  <done>
All label-related test methods are removed. A one-time database cleanup runs on first load after deployment to remove stale person_label and team_label data from wp_terms, wp_term_taxonomy, and wp_term_relationships tables.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn 'person_label' includes/ tests/ --include='*.php'` returns zero results
2. `grep -rn 'team_label' includes/ tests/ --include='*.php'` returns zero results
3. PHP files have no syntax errors: `php -l includes/class-taxonomies.php && php -l includes/class-rest-base.php && php -l includes/class-rest-people.php && php -l includes/class-rest-teams.php && php -l includes/class-rest-google-sheets.php`
4. The commissie_label, relationship_type, and seizoen taxonomies remain registered and unaffected
</verification>

<success_criteria>
- person_label and team_label taxonomies are completely removed from PHP backend
- REST API summary formatters no longer include labels
- People bulk-update only handles organization_id (labels removed)
- Teams bulk-update endpoint is removed (was labels-only)
- People filtered endpoint no longer filters by labels
- Google Sheets export handles missing labels gracefully
- All label-related tests are removed
- Database cleanup runs once after deployment
- Requirements LABEL-01, LABEL-02, LABEL-03, LABEL-09 are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/175-backend-cleanup/175-01-SUMMARY.md`
</output>
