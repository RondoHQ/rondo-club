---
phase: 149-vcard-birthday-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/vcard.js
autonomous: true

must_haves:
  truths:
    - "Exported vCard contains BDAY field when person has birthdate"
    - "Exported vCard has no BDAY field when person has no birthdate"
    - "vCard export works without passing personDates option"
  artifacts:
    - path: "src/utils/vcard.js"
      provides: "vCard generation with direct birthdate field access"
      contains: "acf.birthdate"
  key_links:
    - from: "src/utils/vcard.js:generateVCard"
      to: "person.acf.birthdate"
      via: "direct field access"
      pattern: "acf\\.birthdate"
---

<objective>
Fix vCard birthday export to read from person.birthdate field

Purpose: After Phase 148 removed the Important Dates infrastructure, the JavaScript vCard export still reads from the now-deleted `personDates` array. This gap closure updates the export to read birthdate directly from the person's `acf.birthdate` field, matching the PHP backend implementation.

Output: Working vCard export that includes BDAY field from person.birthdate
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/149-vcard-birthday-export/149-RESEARCH.md
@src/utils/vcard.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update generateVCard to read from acf.birthdate</name>
  <files>src/utils/vcard.js</files>
  <action>
Update the `generateVCard` function in `src/utils/vcard.js`:

1. **Remove personDates from options destructuring** (line 101):
   - Change: `const { teamMap = {}, personDates = [] } = options;`
   - To: `const { teamMap = {} } = options;`

2. **Replace the birthday lookup block** (lines 197-209):
   - Remove the entire `personDates` conditional block
   - Replace with direct acf.birthdate access:
   ```javascript
   // Birthday from person birthdate field
   if (acf.birthdate) {
     const bday = formatVCardDate(acf.birthdate);
     if (bday) {
       lines.push(`BDAY:${bday}`);
     }
   }
   ```

3. **Update JSDoc comment** (lines 89-95):
   - Remove `@param {Array} options.personDates` from the function documentation

4. **Update downloadVCard JSDoc** (lines 239-243):
   - Remove `@param {Array} options.personDates` from the function documentation

The `acf` variable is already destructured from `person.acf` on line 102, so use it directly.
The existing `formatVCardDate` helper (lines 38-46) already handles the Y-m-d string format from ACF.
  </action>
  <verify>
Run `npm run lint` - should pass without errors related to unused personDates variable.
Run `npm run build` - should complete successfully.
  </verify>
  <done>
The generateVCard function reads birthdate from person.acf.birthdate instead of personDates array.
Function signature no longer includes personDates parameter.
JSDoc comments updated to remove personDates references.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build and deploy</name>
  <files>dist/</files>
  <action>
1. Run production build: `npm run build`
2. Deploy to production: `bin/deploy.sh`

This ensures the fix is live and testable.
  </action>
  <verify>
Build completes without errors.
Deploy script completes successfully.
  </verify>
  <done>
Production build created in dist/ folder.
Changes deployed to production server.
  </done>
</task>

</tasks>

<verification>
1. **Lint check:** `npm run lint` passes
2. **Build check:** `npm run build` completes without errors
3. **Code review:** `src/utils/vcard.js` contains `if (acf.birthdate)` pattern
4. **Code review:** `src/utils/vcard.js` does NOT contain `personDates` anywhere
5. **Deployment:** Production server has updated code
</verification>

<success_criteria>
- vCard export function reads from `acf.birthdate` field
- No references to `personDates` remain in vcard.js
- Production build succeeds
- Changes deployed to production
</success_criteria>

<output>
After completion, create `.planning/phases/149-vcard-birthday-export/149-01-SUMMARY.md`
</output>
