---
phase: 157-fee-category-rest-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-api.php
autonomous: true

must_haves:
  truths:
    - "GET /rondo/v1/membership-fees/settings returns full category objects (slug, label, amount, age_classes, is_youth, sort_order) per season"
    - "POST /rondo/v1/membership-fees/settings accepts a 'categories' parameter with full category config and replaces stored data"
    - "POST rejects duplicate slugs and missing required fields (slug, label, amount) with structured error response"
    - "POST returns warnings (not errors) for duplicate age class assignments across categories"
    - "POST validates season is current or next, rejects invalid seasons"
    - "Empty category array is accepted (saves empty config)"
  artifacts:
    - path: "includes/class-rest-api.php"
      provides: "Updated settings endpoints and validation logic"
      contains: "validate_category_config"
  key_links:
    - from: "includes/class-rest-api.php::get_membership_fee_settings"
      to: "MembershipFees::get_categories_for_season"
      via: "Returns full category objects instead of flat fee amounts"
      pattern: "get_categories_for_season"
    - from: "includes/class-rest-api.php::update_membership_fee_settings"
      to: "MembershipFees::save_categories_for_season"
      via: "Saves validated category config via full replacement"
      pattern: "save_categories_for_season"
    - from: "includes/class-rest-api.php::update_membership_fee_settings"
      to: "includes/class-rest-api.php::validate_category_config"
      via: "Validates before saving, returns errors or warnings"
      pattern: "validate_category_config"
---

<objective>
Update the membership fee settings REST endpoints to expose full category definitions and support CRUD operations via full replacement pattern.

Purpose: The Settings UI (Phase 158) needs to read and write complete category configurations per season. Currently the GET endpoint returns flat amounts and the POST accepts individual fee type values. Both need to evolve to work with the Phase 155/156 category data structure.

Output: Updated GET and POST `/membership-fees/settings` endpoints with full category support and validation.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/157-fee-category-rest-api/157-CONTEXT.md
@.planning/phases/157-fee-category-rest-api/157-RESEARCH.md
@.planning/phases/155-fee-category-data-model/155-01-SUMMARY.md
@.planning/phases/156-fee-category-backend-logic/156-01-SUMMARY.md

Key source files:
@includes/class-rest-api.php (lines 555-678 for route registration and endpoint methods)
@includes/class-membership-fees.php (methods: get_categories_for_season, save_categories_for_season, get_season_key, get_next_season_key)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update GET settings endpoint to return full category objects</name>
  <files>includes/class-rest-api.php</files>
  <action>
Update `get_membership_fee_settings()` (around line 2605) to return full category objects instead of flat fee amounts.

**Current response structure:**
```php
'current_season' => [
    'key'  => $current_season,
    'fees' => $membership_fees->get_settings_for_season( $current_season ),
],
```

**New response structure:**
```php
'current_season' => [
    'key'        => $current_season,
    'categories' => $membership_fees->get_categories_for_season( $current_season ),
],
'next_season' => [
    'key'        => $next_season,
    'categories' => $membership_fees->get_categories_for_season( $next_season ),
],
```

This replaces `fees` (flat amounts from `get_settings_for_season()`) with `categories` (full objects from `get_categories_for_season()`). The `get_categories_for_season()` method already returns slug-keyed objects with label, amount, age_classes, is_youth, sort_order.

No backward compatibility needed for `fees` key — the current frontend does not read from this endpoint (it reads from `/fees` endpoint). Phase 158 Settings UI will be the first consumer.
  </action>
  <verify>
Run `php -l includes/class-rest-api.php` to verify syntax.
Grep for `get_categories_for_season` in get_membership_fee_settings to confirm it's used.
Grep for `get_settings_for_season` in get_membership_fee_settings to confirm it's removed.
  </verify>
  <done>GET /rondo/v1/membership-fees/settings returns `categories` key with full category objects (not `fees` with flat amounts) for both current and next season.</done>
</task>

<task type="auto">
  <name>Task 2: Update POST settings endpoint for full replacement and add validation</name>
  <files>includes/class-rest-api.php</files>
  <action>
**Part A: Update route registration (around line 562-625)**

Replace the hardcoded fee type args (mini, pupil, junior, senior, recreant, donateur) with a single `categories` parameter:

```php
'args' => [
    'season'     => [
        'required'          => true,
        'type'              => 'string',
        'validate_callback' => function ( $param, $request, $key ) {
            $membership_fees = new \Rondo\Fees\MembershipFees();
            $valid           = [ $membership_fees->get_season_key(), $membership_fees->get_next_season_key() ];
            return in_array( $param, $valid, true );
        },
    ],
    'categories' => [
        'required' => true,
        'type'     => 'object',
    ],
],
```

Keep the existing season validation callback — it already validates current or next season only.

**Part B: Rewrite `update_membership_fee_settings()` (around line 2632)**

Replace the method body to:
1. Get season from request (already validated by route args)
2. Get categories from request
3. Call `$this->validate_category_config( $categories )` for business validation
4. If errors exist, return WP_Error with status 400, including both errors and warnings in the data array
5. If no errors, call `$membership_fees->save_categories_for_season( $categories, $season )`
6. Return updated settings for both seasons (using same format as GET) plus any warnings

```php
public function update_membership_fee_settings( $request ) {
    $membership_fees = new \Rondo\Fees\MembershipFees();
    $current_season  = $membership_fees->get_season_key();
    $next_season     = $membership_fees->get_next_season_key();
    $season          = $request->get_param( 'season' );
    $categories      = $request->get_param( 'categories' );

    // Validate category structure
    $validation = $this->validate_category_config( $categories );
    if ( ! empty( $validation['errors'] ) ) {
        return new \WP_Error(
            'invalid_categories',
            'Category validation failed',
            [
                'status'   => 400,
                'errors'   => $validation['errors'],
                'warnings' => $validation['warnings'],
            ]
        );
    }

    // Save categories for the specified season
    $membership_fees->save_categories_for_season( $categories, $season );

    // Return updated settings for both seasons
    $response = [
        'current_season' => [
            'key'        => $current_season,
            'categories' => $membership_fees->get_categories_for_season( $current_season ),
        ],
        'next_season'    => [
            'key'        => $next_season,
            'categories' => $membership_fees->get_categories_for_season( $next_season ),
        ],
    ];

    // Include warnings if any
    if ( ! empty( $validation['warnings'] ) ) {
        $response['warnings'] = $validation['warnings'];
    }

    return rest_ensure_response( $response );
}
```

**Part C: Add `validate_category_config()` private method**

Add this new private method to the Api class (near the other membership fee methods). Follow the research-recommended validation pattern:

```php
/**
 * Validate category configuration structure
 *
 * Checks for required fields, duplicate slugs, and duplicate age class assignments.
 * Returns both errors (block save) and warnings (informational).
 *
 * @param mixed $categories The categories data to validate.
 * @return array Array with 'errors' and 'warnings' keys.
 */
private function validate_category_config( $categories ) {
    $errors   = [];
    $warnings = [];

    // Must be an array/object
    if ( ! is_array( $categories ) ) {
        $errors[] = [ 'field' => 'categories', 'message' => 'Categories must be an object' ];
        return [ 'errors' => $errors, 'warnings' => $warnings ];
    }

    // Empty array is valid (per Phase 156 pattern: silent for missing config)
    if ( empty( $categories ) ) {
        return [ 'errors' => [], 'warnings' => [] ];
    }

    $seen_slugs    = [];
    $age_class_map = [];

    foreach ( $categories as $slug => $category ) {
        // Validate slug is not empty
        if ( empty( $slug ) || ! is_string( $slug ) ) {
            $errors[] = [ 'field' => 'slug', 'message' => 'Category slug is required and must be a string' ];
            continue;
        }

        // Validate slug format (lowercase, no spaces — use sanitize_title for normalization check)
        $normalized_slug = sanitize_title( $slug );
        if ( $normalized_slug !== $slug ) {
            $errors[] = [
                'field'   => "categories.{$slug}",
                'message' => "Invalid slug format. Use lowercase letters, numbers, and hyphens only. Suggested: '{$normalized_slug}'",
            ];
        }

        // Check for duplicate slugs (case-insensitive)
        $lower_slug = strtolower( $slug );
        if ( isset( $seen_slugs[ $lower_slug ] ) ) {
            $errors[] = [
                'field'   => "categories.{$slug}",
                'message' => "Duplicate slug '{$slug}'",
            ];
        }
        $seen_slugs[ $lower_slug ] = true;

        // Validate required field: label
        if ( ! isset( $category['label'] ) || ! is_string( $category['label'] ) || trim( $category['label'] ) === '' ) {
            $errors[] = [
                'field'   => "categories.{$slug}.label",
                'message' => 'Label is required',
            ];
        }

        // Validate required field: amount (must be numeric, non-negative)
        if ( ! isset( $category['amount'] ) || ! is_numeric( $category['amount'] ) || (float) $category['amount'] < 0 ) {
            $errors[] = [
                'field'   => "categories.{$slug}.amount",
                'message' => 'Amount is required and must be a non-negative number',
            ];
        }

        // Track age class assignments for overlap detection (warning, not error per API-04)
        if ( isset( $category['age_classes'] ) && is_array( $category['age_classes'] ) ) {
            foreach ( $category['age_classes'] as $age_class ) {
                if ( ! is_string( $age_class ) ) {
                    continue;
                }
                $normalized_class = strtolower( trim( $age_class ) );
                if ( isset( $age_class_map[ $normalized_class ] ) ) {
                    $warnings[] = [
                        'field'      => "categories.{$slug}.age_classes",
                        'message'    => "Age class '{$age_class}' is also assigned to category '{$age_class_map[ $normalized_class ]}'",
                        'categories' => [ $age_class_map[ $normalized_class ], $slug ],
                    ];
                } else {
                    $age_class_map[ $normalized_class ] = $slug;
                }
            }
        }
    }

    return [ 'errors' => $errors, 'warnings' => $warnings ];
}
```

Key validation rules:
- **Errors (block save):** empty/invalid slug, duplicate slug (case-insensitive), missing label, missing/negative amount, invalid slug format
- **Warnings (informational):** age class assigned to multiple categories (per API-04)
- **Allowed:** empty categories array, missing age_classes, missing is_youth, missing sort_order (these have defaults)
  </action>
  <verify>
Run `php -l includes/class-rest-api.php` to verify syntax.
Grep for `validate_category_config` to confirm the method exists and is called from `update_membership_fee_settings`.
Grep for `save_categories_for_season` in `update_membership_fee_settings` to confirm it saves via the new method.
Grep for the old hardcoded fee types ('mini', 'pupil', 'junior', 'senior', 'recreant', 'donateur') in the route registration section (around lines 562-625) to confirm they are removed.
  </verify>
  <done>
POST /rondo/v1/membership-fees/settings accepts a `categories` parameter with full category config, validates structure (errors for duplicate slugs, missing required fields; warnings for duplicate age class assignments), and saves via MembershipFees::save_categories_for_season(). Returns updated settings in same format as GET plus any warnings.
  </done>
</task>

</tasks>

<verification>
1. `php -l includes/class-rest-api.php` passes with no errors
2. GET endpoint uses `get_categories_for_season()` instead of `get_settings_for_season()`
3. POST endpoint accepts `categories` parameter (not individual fee types)
4. POST endpoint calls `validate_category_config()` before saving
5. POST endpoint calls `save_categories_for_season()` to persist
6. `validate_category_config()` returns both `errors` and `warnings` arrays
7. No hardcoded fee type names (mini, pupil, etc.) remain in route registration args
</verification>

<success_criteria>
- GET /membership-fees/settings returns `categories` key with full slug-keyed category objects for both seasons
- POST /membership-fees/settings accepts `categories` + `season`, validates, and saves via full replacement
- Validation returns structured errors for: duplicate slugs, missing label, missing/invalid amount, invalid slug format
- Validation returns warnings (not errors) for: duplicate age class assignments
- Empty categories array is accepted without error
- Invalid season still rejected (existing validation preserved)
</success_criteria>

<output>
After completion, create `.planning/phases/157-fee-category-rest-api/157-01-SUMMARY.md`
</output>
