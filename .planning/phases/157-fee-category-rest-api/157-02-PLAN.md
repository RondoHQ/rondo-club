---
phase: 157-fee-category-rest-api
plan: 02
type: execute
wave: 2
depends_on: ["157-01"]
files_modified:
  - includes/class-rest-api.php
  - ../developer/src/content/docs/features/membership-fees.md
autonomous: true

must_haves:
  truths:
    - "GET /rondo/v1/fees response includes a top-level 'categories' key with label, sort_order, and is_youth per category"
    - "Existing fee list response structure (members, season, forecast, total) is preserved â€” no breaking changes"
    - "Developer documentation describes the updated REST API endpoints for fee categories"
  artifacts:
    - path: "includes/class-rest-api.php"
      provides: "Fee list endpoint with categories metadata"
      contains: "categories"
    - path: "../developer/src/content/docs/features/membership-fees.md"
      provides: "Updated REST API documentation"
      contains: "categories"
  key_links:
    - from: "includes/class-rest-api.php::get_fee_list"
      to: "MembershipFees::get_categories_for_season"
      via: "Adds category metadata to fee list response"
      pattern: "get_categories_for_season"
---

<objective>
Add category metadata to the fee list endpoint and update developer documentation for the Phase 157 REST API changes.

Purpose: The fee list frontend (Phase 159) needs category labels and sort order from the API instead of hardcoded `FEE_CATEGORIES`. Developer docs must reflect the updated endpoint contracts so future development has accurate reference material.

Output: Updated fee list endpoint with `categories` key and comprehensive developer documentation.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/157-fee-category-rest-api/157-CONTEXT.md
@.planning/phases/157-fee-category-rest-api/157-RESEARCH.md
@.planning/phases/157-fee-category-rest-api/157-01-SUMMARY.md

Key source files:
@includes/class-rest-api.php (get_fee_list method around line 2734)
@includes/class-membership-fees.php (get_categories_for_season method)
@../developer/src/content/docs/features/membership-fees.md (existing developer docs)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add categories metadata to fee list endpoint</name>
  <files>includes/class-rest-api.php</files>
  <action>
Update `get_fee_list()` (around line 2734) to include category metadata in the response.

After the existing sort logic and before the `return rest_ensure_response()` call (around line 2841), add category metadata extraction:

```php
// Get category metadata for frontend
$categories_raw = $fees->get_categories_for_season( $season );
$categories_meta = [];
foreach ( $categories_raw as $slug => $category ) {
    $categories_meta[ $slug ] = [
        'label'      => $category['label'] ?? $slug,
        'sort_order' => $category['sort_order'] ?? 999,
        'is_youth'   => $category['is_youth'] ?? false,
    ];
}
```

Then add the `categories` key to the response array:

```php
return rest_ensure_response(
    [
        'season'     => $season,
        'forecast'   => (bool) $forecast,
        'total'      => count( $results ),
        'members'    => $results,
        'categories' => $categories_meta,
    ]
);
```

**Important:** This is a non-breaking additive change. The existing response keys (`season`, `forecast`, `total`, `members`) remain unchanged. The new `categories` key is simply added alongside them.

The categories metadata includes only the fields the frontend needs for display: label (for badges/headers), sort_order (for column ordering), and is_youth (for grouping). Full category data (amount, age_classes) is available via the settings endpoint.

Note: `$fees` and `$season` variables are already in scope from the existing method logic.
  </action>
  <verify>
Run `php -l includes/class-rest-api.php` to verify syntax.
Grep for `categories_meta` in get_fee_list to confirm the variable is created and used.
Grep for `'categories'` near the return statement in get_fee_list to confirm it's in the response.
Confirm existing response keys ('season', 'forecast', 'total', 'members') are still present.
  </verify>
  <done>GET /rondo/v1/fees response includes a `categories` key with label, sort_order, and is_youth per category slug, alongside the existing members/season/forecast/total keys.</done>
</task>

<task type="auto">
  <name>Task 2: Update developer documentation for REST API changes</name>
  <files>../developer/src/content/docs/features/membership-fees.md</files>
  <action>
Update the developer documentation at `../developer/src/content/docs/features/membership-fees.md` to document the Phase 157 REST API changes.

Add or update a "REST API" section in the documentation covering:

**1. GET /rondo/v1/membership-fees/settings**
- Now returns `categories` key (not `fees`) per season
- Response structure:
```json
{
  "current_season": {
    "key": "2025-2026",
    "categories": {
      "mini": {
        "label": "Mini",
        "amount": 100,
        "age_classes": ["Mini F", "Mini E"],
        "is_youth": true,
        "sort_order": 10
      }
    }
  },
  "next_season": { ... }
}
```
- Admin-only endpoint

**2. POST /rondo/v1/membership-fees/settings**
- Full replacement pattern: send complete category config for a season
- Required parameters: `season` (YYYY-YYYY, must be current or next), `categories` (object)
- Validation:
  - Errors (block save): duplicate slugs, missing label, missing/invalid amount, invalid slug format
  - Warnings (informational): duplicate age class assignments
  - Empty categories array is accepted
- Response: same format as GET, plus `warnings` array if any
- Admin-only endpoint

**3. GET /rondo/v1/fees**
- Now includes top-level `categories` key alongside `members`
- Categories metadata: label, sort_order, is_youth per slug
- Frontend uses this for dynamic labels and sorting without hardcoded mappings

**4. Version History**
Add entry for Phase 157:
- `v21.0 (Phase 157)`: Fee settings endpoints return/accept full category objects; fee list includes category metadata; category validation with errors/warnings split

Keep existing documentation intact. Add new sections after the existing content or update existing REST API sections if they exist.
  </action>
  <verify>
Grep for "POST /rondo/v1/membership-fees/settings" in the docs to confirm POST endpoint is documented.
Grep for "categories" in the docs to confirm the new response structure is described.
Grep for "Phase 157" in the docs to confirm the version history entry exists.
  </verify>
  <done>Developer documentation at developer.rondo.club describes the updated GET/POST settings endpoints and the fee list categories metadata, with examples and validation rules.</done>
</task>

</tasks>

<verification>
1. `php -l includes/class-rest-api.php` passes with no errors
2. Fee list response includes `categories` key with metadata per slug
3. Existing fee list response keys (season, forecast, total, members) unchanged
4. Developer docs describe GET settings, POST settings, and GET fees changes
5. Developer docs document validation error/warning split
</verification>

<success_criteria>
- GET /fees returns categories metadata alongside members (non-breaking addition)
- Developer docs comprehensively document all Phase 157 REST API changes
- No breaking changes to existing API consumers
</success_criteria>

<output>
After completion, create `.planning/phases/157-fee-category-rest-api/157-02-SUMMARY.md`
</output>
