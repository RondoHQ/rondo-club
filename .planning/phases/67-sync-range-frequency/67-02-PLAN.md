---
phase: 67-sync-range-frequency
plan: 02
type: execute
wave: 2
depends_on: ["67-01"]
files_modified:
  - includes/class-calendar-sync.php
autonomous: true
---

<objective>
Implement per-connection sync frequency in background sync service.

Purpose: Allow connections to sync at different intervals (15min to daily), respecting user preferences while maintaining efficient background processing.

Output: Background sync service that checks each connection's `last_sync` timestamp against its `sync_frequency` to determine if sync is needed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/67-sync-range-frequency/67-01-SUMMARY.md

Relevant source files:
@includes/class-calendar-sync.php

**Current State (after Plan 01):**
- Connections have `sync_frequency` field (minutes: 15/30/60/240/1440)
- WP-Cron runs every 15 minutes, syncs one user round-robin
- No per-connection frequency check - all enabled connections sync

**Target State:**
- Background sync checks `last_sync` + `sync_frequency` before syncing
- Connections with longer intervals skip unnecessary syncs
- Round-robin continues to spread load across users
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sync frequency check to background sync</name>
  <files>includes/class-calendar-sync.php</files>
  <action>
1. In `sync_user_connections()` method (around line 153), add frequency check before sync:
   ```php
   private function sync_user_connections( $user_id ) {
       $connections = \RONDO_Calendar_Connections::get_user_connections( $user_id );

       foreach ( $connections as $connection ) {
           // Skip disabled connections
           if ( empty( $connection['sync_enabled'] ) ) {
               continue;
           }

           $connection_id = $connection['id'] ?? '';
           $provider      = $connection['provider'] ?? '';

           if ( empty( $connection_id ) || empty( $provider ) ) {
               continue;
           }

           // Check if sync is due based on frequency setting
           if ( ! $this->is_sync_due( $connection ) ) {
               continue;
           }

           // ... rest of existing sync logic
       }
   }
   ```

2. Add new helper method `is_sync_due()` after `sync_user_connections()`:
   ```php
   /**
    * Check if a connection is due for sync based on its frequency setting
    *
    * @param array $connection Connection data.
    * @return bool True if sync is due.
    */
   private function is_sync_due( array $connection ): bool {
       $last_sync = $connection['last_sync'] ?? null;

       // No last sync - always due
       if ( empty( $last_sync ) ) {
           return true;
       }

       // Get sync frequency (default 15 minutes)
       $frequency_minutes = isset( $connection['sync_frequency'] ) ? absint( $connection['sync_frequency'] ) : 15;

       // Parse last_sync timestamp
       $last_sync_time = strtotime( $last_sync );
       if ( $last_sync_time === false ) {
           return true; // Invalid timestamp, sync now
       }

       // Calculate if enough time has passed
       $seconds_since_sync = time() - $last_sync_time;
       $required_seconds   = $frequency_minutes * 60;

       return $seconds_since_sync >= $required_seconds;
   }
   ```

3. Update the log message in the sync loop to include frequency info (around line 193):
   ```php
   error_log(
       sprintf(
           'RONDO_Calendar_Sync: Synced connection %s for user %d - %d events (%d created, %d updated) [freq: %d min]',
           $connection_id,
           $user_id,
           $result['total'] ?? 0,
           $result['created'] ?? 0,
           $result['updated'] ?? 0,
           $connection['sync_frequency'] ?? 15
       )
   );
   ```

4. Add a skip log for debugging (optional but helpful), in the frequency check block:
   ```php
   // In sync_user_connections, when skipping due to frequency:
   // Note: Only log at debug level to avoid log spam
   // error_log( sprintf( 'RONDO_Calendar_Sync: Skipping connection %s - not due yet', $connection_id ) );
   ```
  </action>
  <verify>
    - Run: `composer lint` to check PHP syntax
    - Test: Set a connection to daily sync, trigger cron multiple times, verify it only syncs once per day
  </verify>
  <done>
    - Background sync respects per-connection `sync_frequency`
    - Connections with 1-hour frequency only sync every hour
    - Connections with daily frequency only sync once per day
    - No changes to manual sync (trigger_sync endpoint always syncs immediately)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update sync status endpoint with frequency information</name>
  <files>includes/class-calendar-sync.php</files>
  <action>
1. In `get_sync_status()` static method (around line 466), add frequency-aware information:

   After getting user connections, add next_sync calculation for each connection:
   ```php
   $safe_connections = array_map(
       function ( $conn ) {
           unset( $conn['credentials'] );

           // Calculate next scheduled sync time
           $last_sync  = $conn['last_sync'] ?? null;
           $frequency  = isset( $conn['sync_frequency'] ) ? absint( $conn['sync_frequency'] ) : 15;
           $next_sync  = null;

           if ( $last_sync ) {
               $last_sync_time = strtotime( $last_sync );
               if ( $last_sync_time !== false ) {
                   $next_sync_time = $last_sync_time + ( $frequency * 60 );
                   $next_sync      = gmdate( 'c', $next_sync_time );
               }
           }

           $conn['next_sync'] = $next_sync;

           return $conn;
       },
       $user_connections
   );
   ```

This makes the connection objects include a `next_sync` field that the UI can display.
  </action>
  <verify>
    - Run: `composer lint` to check PHP syntax
    - Test: Call GET `/rondo/v1/calendar/sync/status` and verify `next_sync` field in response
  </verify>
  <done>
    - Sync status endpoint includes `next_sync` timestamp for each connection
    - UI can show when next sync will occur
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `composer lint` passes with no errors
- [ ] Background sync respects `sync_frequency` setting
- [ ] Connections with longer frequencies skip unnecessary syncs
- [ ] Manual sync (via UI refresh button) still works immediately
- [ ] Sync status endpoint shows `next_sync` for each connection
</verification>

<success_criteria>
- All tasks completed
- Connection with 15-minute frequency syncs every cron run (when due)
- Connection with 4-hour frequency skips syncs until 4 hours have passed
- Connection with daily frequency syncs once per day
- Round-robin user selection continues working (load balancing)
- No performance regressions in background sync
</success_criteria>

<output>
After completion, create `.planning/phases/67-sync-range-frequency/67-02-SUMMARY.md`
</output>
