---
phase: 67-sync-range-frequency
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-calendar-connections.php
  - includes/class-google-calendar-provider.php
  - includes/class-caldav-provider.php
  - includes/class-rest-calendar.php
  - src/pages/Settings/Settings.jsx
autonomous: true
---

<objective>
Add configurable sync range and frequency settings for calendar connections.

Purpose: Give users control over how far back/forward events sync and how often synchronization occurs, reducing API usage and tailoring sync behavior to individual needs.

Output: Extended connection settings with `sync_to_days` (future range) and `sync_frequency` (sync interval) fields, updated providers to respect these settings, and enhanced Settings UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Relevant source files (current implementation):
@includes/class-calendar-connections.php
@includes/class-google-calendar-provider.php
@includes/class-caldav-provider.php
@includes/class-rest-calendar.php
@src/pages/Settings/Settings.jsx

**Current State:**
- `sync_from_days` exists (past events, default 90 days)
- Future sync range is hardcoded to +30 days in providers
- Sync frequency is hardcoded to every 15 minutes globally via WP-Cron
- No per-connection frequency control

**Target State:**
- `sync_to_days` for future event range (default 30 days)
- `sync_frequency` for per-connection sync interval (15min/30min/1hr/4hr/daily)
- Providers respect both `sync_from_days` and `sync_to_days`
- Background sync respects per-connection frequency
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sync_to_days and sync_frequency fields to connection data model</name>
  <files>includes/class-calendar-connections.php, includes/class-rest-calendar.php</files>
  <action>
1. In `class-calendar-connections.php`:
   - Add `sync_to_days` default to 30 in `add_connection()` defaults (around line 82)
   - Add `sync_frequency` default to 15 (minutes) in `add_connection()` defaults

2. In `class-rest-calendar.php`:
   - Add `sync_to_days` parameter to POST `/calendar/connections` route args (after `sync_from_days`, around line 84):
     ```php
     'sync_to_days' => [
         'required' => false,
         'type'     => 'integer',
         'default'  => 30,
     ],
     ```
   - Add `sync_frequency` parameter (minutes: 15, 30, 60, 240, 1440):
     ```php
     'sync_frequency' => [
         'required' => false,
         'type'     => 'integer',
         'default'  => 15,
         'validate_callback' => function ( $param ) {
             return in_array( (int) $param, [ 15, 30, 60, 240, 1440 ], true );
         },
     ],
     ```
   - Add same parameters to PUT `/calendar/connections/{id}` route args (around line 150)
   - Update `create_connection()` to include both new fields (around line 414):
     ```php
     'sync_to_days'   => isset( $data['sync_to_days'] ) ? absint( $data['sync_to_days'] ) : 30,
     'sync_frequency' => isset( $data['sync_frequency'] ) ? absint( $data['sync_frequency'] ) : 15,
     ```
   - Update `update_connection()` to handle both new fields (around line 477):
     ```php
     if ( isset( $data['sync_to_days'] ) ) {
         $updates['sync_to_days'] = absint( $data['sync_to_days'] );
     }
     if ( isset( $data['sync_frequency'] ) ) {
         $updates['sync_frequency'] = absint( $data['sync_frequency'] );
     }
     ```
   - Update `google_auth_callback()` OAuth flow to include defaults (around line 674):
     ```php
     'sync_to_days'   => 30,
     'sync_frequency' => 15,
     ```
  </action>
  <verify>
    - Run: `composer lint` to check PHP syntax
    - Test: Create a new connection via API and verify new fields are stored
  </verify>
  <done>
    - `sync_to_days` and `sync_frequency` fields accepted by REST API
    - New connections get default values for both fields
    - Existing connections continue working (missing fields use defaults)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update calendar providers to use configurable sync_to_days</name>
  <files>includes/class-google-calendar-provider.php, includes/class-caldav-provider.php</files>
  <action>
1. In `class-google-calendar-provider.php` `sync()` method (around line 39-44):
   - Replace hardcoded `+30 days` with configurable `sync_to_days`:
     ```php
     $sync_from_days = isset( $connection['sync_from_days'] ) ? absint( $connection['sync_from_days'] ) : 90;
     $sync_to_days   = isset( $connection['sync_to_days'] ) ? absint( $connection['sync_to_days'] ) : 30;

     $start_date = new \DateTime();
     $start_date->modify( "-{$sync_from_days} days" );

     $end_date = new \DateTime();
     $end_date->modify( "+{$sync_to_days} days" );
     ```

2. In `class-caldav-provider.php` `sync()` method (around line 284-289):
   - Same change: replace hardcoded `+30 days` with configurable `sync_to_days`:
     ```php
     $sync_from_days = isset( $connection['sync_from_days'] ) ? absint( $connection['sync_from_days'] ) : 90;
     $sync_to_days   = isset( $connection['sync_to_days'] ) ? absint( $connection['sync_to_days'] ) : 30;

     $start_date = new \DateTime();
     $start_date->modify( "-{$sync_from_days} days" );

     $end_date = new \DateTime();
     $end_date->modify( "+{$sync_to_days} days" );
     ```
  </action>
  <verify>
    - Run: `composer lint` to check PHP syntax
    - Manual test: Edit a connection's sync_to_days via API, trigger sync, verify date range in logs
  </verify>
  <done>
    - Google Calendar provider uses `sync_to_days` for future range
    - CalDAV provider uses `sync_to_days` for future range
    - Default behavior unchanged (30 days) when field not set
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Settings UI with sync range and frequency controls</name>
  <files>src/pages/Settings/Settings.jsx</files>
  <action>
1. In `EditConnectionModal` component (around line 1156):
   - Add state for new fields:
     ```javascript
     const [syncToDays, setSyncToDays] = useState(connection.sync_to_days || 30);
     const [syncFrequency, setSyncFrequency] = useState(connection.sync_frequency || 15);
     ```

2. Add `syncToDays` options (around line 1236, after syncFromOptions):
   ```javascript
   const syncToOptions = [
     { value: 7, label: '1 week' },
     { value: 14, label: '2 weeks' },
     { value: 30, label: '30 days' },
     { value: 60, label: '60 days' },
     { value: 90, label: '90 days' },
   ];

   const syncFrequencyOptions = [
     { value: 15, label: 'Every 15 minutes' },
     { value: 30, label: 'Every 30 minutes' },
     { value: 60, label: 'Every hour' },
     { value: 240, label: 'Every 4 hours' },
     { value: 1440, label: 'Once daily' },
   ];
   ```

3. Include new fields in handleSave data object (around line 1217):
   ```javascript
   const data = {
     name: name.trim(),
     sync_enabled: syncEnabled,
     auto_log: autoLog,
     sync_from_days: syncFromDays,
     sync_to_days: syncToDays,
     sync_frequency: syncFrequency,
   };
   ```

4. Add UI elements after "Sync from" dropdown (around line 1333):
   ```jsx
   {/* Sync to dropdown */}
   <div>
     <label className="label mb-1">Sync events until</label>
     <select
       value={syncToDays}
       onChange={(e) => setSyncToDays(Number(e.target.value))}
       className="input"
     >
       {syncToOptions.map((option) => (
         <option key={option.value} value={option.value}>
           Next {option.label}
         </option>
       ))}
     </select>
     <p className="text-xs text-gray-500 mt-1 dark:text-gray-400">
       Future events beyond this will not be synced
     </p>
   </div>

   {/* Sync frequency dropdown */}
   <div>
     <label className="label mb-1">Sync frequency</label>
     <select
       value={syncFrequency}
       onChange={(e) => setSyncFrequency(Number(e.target.value))}
       className="input"
     >
       {syncFrequencyOptions.map((option) => (
         <option key={option.value} value={option.value}>
           {option.label}
         </option>
       ))}
     </select>
     <p className="text-xs text-gray-500 mt-1 dark:text-gray-400">
       How often to check for calendar updates
     </p>
   </div>
   ```
  </action>
  <verify>
    - Run: `npm run build` to ensure no build errors
    - Manual test: Open Settings > Connections > Calendars, edit a connection, verify new dropdowns appear
  </verify>
  <done>
    - "Sync events until" dropdown shows future range options (1 week to 90 days)
    - "Sync frequency" dropdown shows interval options (15min to daily)
    - Both values saved correctly when editing connection
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `composer lint` passes with no errors
- [ ] `npm run build` succeeds without errors
- [ ] New connections get default `sync_to_days: 30` and `sync_frequency: 15`
- [ ] Editing connection shows and saves new settings
- [ ] Calendar sync respects `sync_to_days` setting (verify via logs or API test)
</verification>

<success_criteria>
- All tasks completed
- REST API accepts and validates `sync_to_days` (7-90 days) and `sync_frequency` (15/30/60/240/1440 minutes)
- Both Google and CalDAV providers use `sync_to_days` for future date range
- Settings UI shows clear controls for sync range and frequency
- No regressions in existing calendar sync functionality
</success_criteria>

<output>
After completion, create `.planning/phases/67-sync-range-frequency/67-01-SUMMARY.md`
</output>
