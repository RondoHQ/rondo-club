---
phase: 128-google-sheets-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-google-sheets.php
  - src/pages/Contributie/ContributieList.jsx
  - src/api/client.js
autonomous: true

must_haves:
  truths:
    - "User can click export button on Contributie page"
    - "Export creates new Google Sheets spreadsheet with fee data"
    - "Spreadsheet opens in new browser tab automatically"
    - "Export includes all 10 columns with Dutch labels"
    - "Monetary values display as Euro currency"
    - "Totals row shows sums for Base Fee and Final Amount"
  artifacts:
    - path: "includes/class-rest-google-sheets.php"
      provides: "export_fees REST endpoint"
      contains: "export_fees"
    - path: "src/pages/Contributie/ContributieList.jsx"
      provides: "Export button in header row"
      contains: "handleExportToSheets"
    - path: "src/api/client.js"
      provides: "exportFeesToSheets API method"
      contains: "exportFeesToSheets"
  key_links:
    - from: "src/pages/Contributie/ContributieList.jsx"
      to: "/stadion/v1/google-sheets/export-fees"
      via: "prmApi.exportFeesToSheets"
      pattern: "exportFeesToSheets"
    - from: "includes/class-rest-google-sheets.php"
      to: "Google Sheets API"
      via: "Google\\Service\\Sheets"
      pattern: "sheets_service->spreadsheets->create"
---

<objective>
Add Google Sheets export functionality to the Contributie page

Purpose: Allow users to export fee data to Google Sheets for viewing, sharing, or further analysis
Output: Export button on Contributie page that creates a formatted spreadsheet with all fee data
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/128-google-sheets-export/128-CONTEXT.md
@.planning/phases/128-google-sheets-export/128-RESEARCH.md

# Existing patterns to follow
@includes/class-rest-google-sheets.php (export_people method, lines 287-464)
@src/pages/People/PeopleList.jsx (handleExportToSheets pattern, lines 1043-1102, 1469-1492)
@src/pages/Contributie/ContributieList.jsx (target component)
@src/api/client.js (API client methods)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend export endpoint</name>
  <files>includes/class-rest-google-sheets.php</files>
  <action>
Add `export_fees` REST endpoint following the `export_people` pattern:

1. **Register route** (in `register_routes` method, after export-people):
   ```php
   register_rest_route(
       'stadion/v1',
       '/google-sheets/export-fees',
       [
           'methods'             => \WP_REST_Server::CREATABLE,
           'callback'            => [ $this, 'export_fees' ],
           'permission_callback' => [ $this, 'check_user_approved' ],
           'args'                => [
               'sort_field' => [
                   'required' => false,
                   'type'     => 'string',
                   'default'  => 'category',
               ],
               'sort_order' => [
                   'required' => false,
                   'type'     => 'string',
                   'default'  => 'asc',
                   'enum'     => [ 'asc', 'desc' ],
               ],
           ],
       ]
   );
   ```

2. **Create `export_fees` method** following `export_people` pattern:
   - Check connection: `GoogleSheetsConnection::is_connected($user_id)`
   - Get credentials and refresh token via `GoogleOAuth::get_access_token()`
   - Create Sheets client
   - Fetch fee data via internal REST request to /fees endpoint (or use MembershipFees service directly)
   - Include relatiecode (KNVB ID) from ACF field for each person

3. **Build spreadsheet with these columns** (per CONTEXT.md):
   - Naam (text)
   - Relatiecode (text - KNVB ID from ACF `relatiecode` field)
   - Categorie (text)
   - Leeftijdsgroep (text)
   - Basis (currency EUR, whole numbers)
   - Gezinskorting (percentage as decimal 0.25)
   - Pro-rata % (percentage as decimal)
   - Bedrag (currency EUR, whole numbers)
   - Nikki Total (currency EUR with 2 decimals)
   - Saldo (currency EUR with 2 decimals)

4. **Spreadsheet configuration**:
   - Title: "Contributie {season} - {date}" (e.g., "Contributie 2025-2026 - 2026-02-01")
   - Sheet tab name: "Contributie"
   - Locale: `nl_NL` (for Euro formatting)

5. **Apply formatting** (batchUpdate requests):
   - Bold header row with light gray background
   - Freeze first row
   - Auto-resize all columns
   - Currency format for columns E, H, I, J (Basis, Bedrag, Nikki Total, Saldo): `"[$EUR] #,##0"` for columns E/H, `"[$EUR] #,##0.00"` for I/J
   - Percentage format for columns F, G (Gezinskorting, Pro-rata): `"0%"`

6. **Add totals row** at bottom:
   - Column A: "Totaal"
   - Column E: Sum of Basis (use SUM formula or pre-calculated value)
   - Column H: Sum of Bedrag
   - Columns I, J: Leave empty (per CONTEXT.md - Nikki columns not summed in export)

7. **Respect sort order**: Pass `sort_field` and `sort_order` to data fetch, apply same client-side sort logic as ContributieList.jsx uses.

8. **Return response**: `{ success: true, spreadsheet_url: url, spreadsheet_id: id, rows_exported: count }`
  </action>
  <verify>
    - `npm run lint` passes
    - No PHP syntax errors: `php -l includes/class-rest-google-sheets.php`
    - Endpoint registered: Check REST discovery or test with curl
  </verify>
  <done>
    - POST /stadion/v1/google-sheets/export-fees endpoint exists
    - Endpoint creates spreadsheet with 10 columns and totals row
    - Currency formatting uses Euro with nl_NL locale
    - Returns spreadsheet URL on success
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend export button</name>
  <files>src/pages/Contributie/ContributieList.jsx, src/api/client.js</files>
  <action>
**In src/api/client.js:**

Add to `prmApi` object (after `getFeeList`):
```javascript
exportFeesToSheets: (data) => api.post('/stadion/v1/google-sheets/export-fees', data),
```

**In src/pages/Contributie/ContributieList.jsx:**

1. **Add imports** at top:
   ```javascript
   import { FileSpreadsheet } from 'lucide-react';
   import { useQuery } from '@tanstack/react-query';
   import { prmApi } from '@/api/client';
   ```
   Note: `prmApi` may already be imported via `useFeeList` hook - check and add only if needed.

2. **Add state** after existing useState calls:
   ```javascript
   const [isExporting, setIsExporting] = useState(false);
   ```

3. **Add sheets status query** after existing useQuery:
   ```javascript
   const { data: sheetsStatus } = useQuery({
     queryKey: ['google-sheets-status'],
     queryFn: async () => {
       const response = await prmApi.getSheetsStatus();
       return response.data;
     },
   });
   ```

4. **Add handleExportToSheets function** (follow PeopleList.jsx pattern exactly):
   ```javascript
   const handleExportToSheets = async () => {
     if (isExporting) return;
     setIsExporting(true);

     // Open window immediately to avoid popup blocker
     const newWindow = window.open('about:blank', '_blank');

     try {
       const response = await prmApi.exportFeesToSheets({
         sort_field: sortField,
         sort_order: sortOrder,
       });

       if (response.data.spreadsheet_url && newWindow) {
         newWindow.location.href = response.data.spreadsheet_url;
       }
     } catch (error) {
       console.error('Export error:', error);
       if (newWindow) newWindow.close();
       const message = error.response?.data?.message || 'Export mislukt. Probeer het opnieuw.';
       alert(message);
     } finally {
       setIsExporting(false);
     }
   };
   ```

5. **Add handleConnectSheets function**:
   ```javascript
   const handleConnectSheets = async () => {
     try {
       const response = await prmApi.getSheetsAuthUrl();
       if (response.data.auth_url) {
         window.location.href = response.data.auth_url;
       }
     } catch (error) {
       console.error('Auth error:', error);
       alert('Kon geen verbinding maken met Google Sheets. Probeer het opnieuw.');
     }
   };
   ```

6. **Update header section** (around line 275-283):
   Change from:
   ```jsx
   <div className="flex items-center justify-between">
     <div className="text-sm...">Season info</div>
     <div className="text-sm...">Totaal: ...</div>
   </div>
   ```

   To:
   ```jsx
   <div className="flex items-center justify-between">
     <div className="text-sm text-gray-500 dark:text-gray-400">
       Seizoen: <span className="font-medium text-gray-900 dark:text-gray-100">{data?.season}</span>
       <span className="ml-4">{sortedMembers.length} leden</span>
     </div>
     <div className="flex items-center gap-3">
       <div className="text-sm text-gray-500 dark:text-gray-400">
         Totaal: <span className="font-medium text-gray-900 dark:text-gray-100">{formatCurrency(totals.finalFee)}</span>
       </div>
       {/* Export Button */}
       {sheetsStatus?.connected ? (
         <button
           onClick={handleExportToSheets}
           disabled={isExporting}
           className="btn-secondary"
           title="Exporteren naar Google Sheets"
         >
           {isExporting ? (
             <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-current"></div>
           ) : (
             <FileSpreadsheet className="w-4 h-4" />
           )}
         </button>
       ) : sheetsStatus?.google_configured ? (
         <button
           onClick={handleConnectSheets}
           className="btn-secondary"
           title="Verbinden met Google Sheets"
         >
           <FileSpreadsheet className="w-4 h-4" />
         </button>
       ) : null}
     </div>
   </div>
   ```
  </action>
  <verify>
    - `npm run lint` passes
    - `npm run build` succeeds
    - Button appears in Contributie page header (when Google configured)
  </verify>
  <done>
    - Export button visible in Contributie page header next to totals
    - Button shows spinner during export
    - Disabled state shows when not connected (with connect tooltip)
    - Clicking export opens spreadsheet in new tab
  </done>
</task>

</tasks>

<verification>
1. Navigate to Contributie page
2. Verify export button appears (if Google Sheets connected) or connect button appears (if configured but not connected)
3. Click export button
4. Verify new browser tab opens with Google Sheets
5. Verify spreadsheet has:
   - Title: "Contributie {season} - {date}"
   - 10 columns with Dutch headers
   - Currency formatting for Euro values
   - Percentage formatting for discount/pro-rata
   - Totals row at bottom
   - Same sort order as current page view
</verification>

<success_criteria>
- Export button on Contributie page (EXP-01 requirement)
- Creates Google Sheets with all fee data
- Uses existing Google OAuth connection (no new auth flow)
- Spreadsheet auto-opens in new tab
- Euro currency formatting via nl_NL locale
- Totals row includes Base Fee and Final Amount sums
</success_criteria>

<output>
After completion, create `.planning/phases/128-google-sheets-export/128-01-SUMMARY.md`
</output>
