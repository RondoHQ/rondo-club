---
phase: 170-fixture-format-design
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/demo-fixture-schema.md
  - fixtures/demo-fixture.example.json
autonomous: true

must_haves:
  truths:
    - "The fixture format documents every entity type needed for a working demo (people, teams, commissies, discipline cases, tasks, notes, activities, settings)"
    - "The fixture format captures all relationships between entities using temporary IDs"
    - "The fixture format is self-contained with no external dependencies"
    - "The fixture format includes all Sportlink-synced meta fields on person posts"
  artifacts:
    - path: "docs/demo-fixture-schema.md"
      provides: "Complete schema documentation for the demo fixture JSON format"
      min_lines: 100
    - path: "fixtures/demo-fixture.example.json"
      provides: "Minimal but valid example fixture demonstrating every entity type and relationship"
      min_lines: 50
  key_links:
    - from: "docs/demo-fixture-schema.md"
      to: "fixtures/demo-fixture.example.json"
      via: "Schema documents the structure that the example demonstrates"
      pattern: "demo-fixture"
---

<objective>
Design the JSON fixture schema that serves as the contract between the export command (Phase 171) and import command (Phase 173). The schema must cover all entity types, their fields, inter-entity relationships, and site-wide settings.

Purpose: This schema is the single source of truth for what the fixture file contains. Phase 171 (export) writes this format, Phase 173 (import) reads it. Getting the schema right prevents rework later.

Output: A schema documentation file and a minimal example fixture JSON.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/170-fixture-format-design/170-CONTEXT.md
@acf-json/group_person_fields.json
@acf-json/group_team_fields.json
@acf-json/group_commissie_fields.json
@acf-json/group_discipline_case_fields.json
@acf-json/group_todo_fields.json
@acf-json/group_relationship_type_fields.json
@includes/class-post-types.php
@includes/class-taxonomies.php
@includes/class-comment-types.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create fixture schema documentation</name>
  <files>docs/demo-fixture-schema.md</files>
  <action>
Create `docs/demo-fixture-schema.md` documenting the complete JSON fixture format.

The fixture is a single JSON object with these top-level keys:

```json
{
  "meta": { ... },
  "people": [ ... ],
  "teams": [ ... ],
  "commissies": [ ... ],
  "discipline_cases": [ ... ],
  "todos": [ ... ],
  "comments": [ ... ],
  "taxonomies": { ... },
  "settings": { ... }
}
```

**Document each section in detail:**

### `meta` (object)
Metadata about the fixture itself:
- `version` (string): Schema version, e.g. "1.0"
- `exported_at` (string): ISO 8601 timestamp of when the fixture was created
- `source` (string): Description of the source (e.g. "Production export, anonymized")
- `record_counts` (object): Count of each entity type for quick validation

### `people` (array of objects)
Each person object:
- `_ref` (string): Temporary reference ID for cross-entity linking, format: `"person:1"`, `"person:2"`, etc. These are NOT WordPress post IDs -- they're fixture-internal references used by the import to wire up relationships.
- `title` (string): Post title (auto-generated from name fields)
- `status` (string): Post status, always `"publish"`
- `acf` (object): All ACF and Sportlink-synced meta fields:
  - `first_name` (string)
  - `infix` (string, nullable): Tussenvoegsel (van, de, van der)
  - `last_name` (string)
  - `nickname` (string, nullable)
  - `gender` (string, nullable): One of "male", "female", "non_binary", "other", "prefer_not_to_say"
  - `pronouns` (string, nullable)
  - `birthdate` (string): Format "Y-m-d"
  - `former_member` (boolean): Whether person is a former member
  - `lid-tot` (string, nullable): Date membership ended, "Y-m-d"
  - `datum-overlijden` (string, nullable): Date of death, "Y-m-d"
  - `contact_info` (array of objects): Each with `contact_type`, `contact_label`, `contact_value`
  - `addresses` (array of objects): Each with `address_label`, `street`, `postal_code`, `city`, `state`, `country`
  - `work_history` (array of objects): Each with `team` (ref string like `"team:1"` or `"commissie:1"`), `entity_type`, `job_title`, `description`, `start_date`, `end_date`, `is_current`
  - `relationships` (array of objects): Each with `related_person` (ref string like `"person:5"`), `relationship_type` (ref string like `"relationship_type:parent"`), `relationship_label`
  - Sportlink-synced fields (all nullable):
    - `lid-sinds` (string): Member since date, "Y-m-d"
    - `leeftijdsgroep` (string): Age class description (e.g., "Onder 10", "Senioren")
    - `datum-vog` (string): VOG date, "Y-m-d"
    - `datum-foto` (string): Photo date, "Y-m-d"
    - `type-lid` (string): Member type
    - `huidig-vrijwilliger` (string "0" or "1"): Current volunteer status
    - `financiele-blokkade` (boolean): Financial block flag
    - `relatiecode` (string): KNVB relation code
    - `werkfuncties` (array of objects): Job functions, each with `team` (ref), `job_title`, etc.
    - `freescout-id` (string): FreeScout customer ID
    - `factuur-adres` (string): Invoice address
    - `factuur-email` (string): Invoice email
    - `factuur-referentie` (string): Invoice reference
- `post_meta` (object, optional): Non-ACF post meta fields:
  - `vog_email_sent_date` (string, nullable): Date VOG email was sent
  - `vog_justis_submitted_date` (string, nullable): Date Justis was submitted
  - `vog_reminder_sent_date` (string, nullable): Date VOG reminder was sent
  - `_nikki_{year}_total` (number, nullable): Nikki total for a given year
  - `_nikki_{year}_saldo` (number, nullable): Nikki balance for a given year
  - `_fee_snapshot_{season}` (object, nullable): Cached fee calculation
  - `_fee_forecast_{season}` (object, nullable): Cached fee forecast

Note: `photo_gallery` is EXCLUDED per EXPORT-04. No thumbnail/featured image data.

### `teams` (array of objects)
Each team object:
- `_ref` (string): Temporary reference ID, format: `"team:1"`
- `title` (string): Team name (preserved unchanged per EXPORT-06)
- `content` (string): Post content/description
- `status` (string): Post status
- `parent` (string, nullable): Ref to parent team if hierarchical, e.g. `"team:3"`
- `acf` (object):
  - `website` (string, nullable)
  - `contact_info` (array of objects): Each with `contact_type`, `contact_label`, `contact_value`

### `commissies` (array of objects)
Same structure as teams but with `_ref` format `"commissie:1"`:
- `_ref` (string): e.g. `"commissie:1"`
- `title` (string): Name (preserved unchanged per EXPORT-06)
- `content` (string): Post content/description
- `status` (string): Post status
- `parent` (string, nullable): Ref to parent commissie
- `acf` (object):
  - `website` (string, nullable)
  - `contact_info` (array of objects)

### `discipline_cases` (array of objects)
Each discipline case:
- `_ref` (string): e.g. `"discipline_case:1"`
- `title` (string): Case title
- `status` (string): Post status
- `acf` (object):
  - `dossier_id` (string): Unique identifier
  - `person` (string, nullable): Ref to linked person, e.g. `"person:42"`
  - `match_date` (string, nullable): "Ymd" format
  - `processing_date` (string, nullable): "Ymd" format
  - `match_description` (string, nullable)
  - `team_name` (string, nullable)
  - `charge_codes` (string, nullable)
  - `charge_description` (string, nullable)
  - `sanction_description` (string, nullable)
  - `administrative_fee` (number, nullable)
  - `is_charged` (boolean)
- `seizoen` (string, nullable): Season slug, e.g. `"2024-2025"`

### `todos` (array of objects)
Each todo:
- `_ref` (string): e.g. `"todo:1"`
- `title` (string): Todo title
- `content` (string): Todo body
- `status` (string): Custom post status: `"rondo_open"`, `"rondo_awaiting"`, or `"rondo_completed"`
- `date` (string): Post creation date, ISO 8601
- `acf` (object):
  - `related_persons` (array of strings): Refs to related people, e.g. `["person:1", "person:5"]`
  - `notes` (string, nullable): Additional notes (WYSIWYG)
  - `awaiting_since` (string, nullable): "Y-m-d H:i:s"
  - `due_date` (string, nullable): "Y-m-d"

### `comments` (array of objects)
Notes and activities stored as WordPress comments on person posts:
- `type` (string): One of `"rondo_note"`, `"rondo_activity"`, `"rondo_email"`
- `person` (string): Ref to the person post, e.g. `"person:1"`
- `content` (string): Comment content
- `date` (string): Comment date, ISO 8601
- `meta` (object, optional): Comment meta fields:
  - `activity_type` (string, nullable): Type of activity (for rondo_activity)
  - `activity_date` (string, nullable): Date of the activity

### `taxonomies` (object)
Taxonomy terms that need to exist for the fixture to work:
- `relationship_types` (array of objects): Each with:
  - `_ref` (string): e.g. `"relationship_type:parent"`
  - `name` (string): Term name
  - `slug` (string): Term slug
  - `acf` (object): With `inverse_relationship_type` (ref string to another relationship_type)
- `seizoenen` (array of objects): Each with:
  - `name` (string): Season name (e.g. "2024-2025")
  - `slug` (string): Season slug
  - `is_current` (boolean): Whether this is the current season

### `settings` (object)
WordPress options needed for the demo to function:
- `rondo_club_name` (string): Club name
- `rondo_membership_fees_{season}` (object): Fee category configuration per season. Keys are category slugs, values are objects with `label`, `amount`, `age_classes`, `matching_werkfuncties`.
- `rondo_family_discount_{season}` (object): Family discount config per season with `type`, `fixed_amount`, `percentage`.
- `rondo_player_roles` (array): Player role configuration
- `rondo_excluded_roles` (array): Excluded role configuration
- `rondo_vog_from_email` (string): VOG sender email
- `rondo_vog_from_name` (string): VOG sender name
- `rondo_vog_template_new` (string): VOG email template for new VOG
- `rondo_vog_template_renewal` (string): VOG email template for renewal
- `rondo_vog_reminder_template_new` (string): VOG reminder template new
- `rondo_vog_reminder_template_renewal` (string): VOG reminder template renewal
- `rondo_vog_exempt_commissies` (array): Commissie IDs exempt from VOG (stored as refs)

### Reference system
Document the reference ID system:
- All references use the format `"{entity_type}:{sequential_number}"` or `"{entity_type}:{slug}"` for taxonomies
- References are resolved during import: the importer maintains a mapping from fixture refs to newly created WordPress post IDs
- This makes the fixture portable -- no WordPress IDs leak into the fixture
- Example flow: Person has `work_history[0].team = "team:5"` → importer looks up which WP post ID was created for `"team:5"` → stores that ID in the ACF repeater field

### Excluded data
Explicitly document what is NOT in the fixture:
- Photos, avatars, thumbnails (per EXPORT-04)
- important_dates CPT (being removed from codebase)
- person_labels, team_labels, date_types taxonomies (being removed)
- OAuth tokens, calendar connections, CardDAV data (per Out of Scope)
- User accounts (users created separately via WordPress)
- Feedback posts (internal dev feedback, not demo-relevant)
- Calendar events (per-user OAuth, out of scope)
  </action>
  <verify>
Verify the file exists and covers all required entity types:
```bash
test -f docs/demo-fixture-schema.md && \
grep -c "people\|teams\|commissies\|discipline_cases\|todos\|comments\|taxonomies\|settings" docs/demo-fixture-schema.md
```
Should return a count >= 8 (one for each section).
  </verify>
  <done>
Schema documentation exists at `docs/demo-fixture-schema.md` and documents: (1) all 8 top-level fixture sections, (2) all person fields including Sportlink-synced meta, (3) the reference ID system for cross-entity linking, (4) all settings options needed for the demo, (5) explicitly listed exclusions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create minimal example fixture</name>
  <files>fixtures/demo-fixture.example.json</files>
  <action>
Create `fixtures/demo-fixture.example.json` -- a minimal but valid example that demonstrates every entity type and relationship type in the fixture format. This serves as both documentation and a smoke-test target.

The example should contain:
- **meta**: Version 1.0, timestamp, source "Example fixture", counts
- **2 people**: One active member, one former member. Include all field types (contact_info repeater, addresses repeater, work_history linking to a team, relationships linking to each other as parent/child)
- **1 team**: With website and contact_info
- **1 commissie**: With website and contact_info
- **1 discipline_case**: Linked to person:1, with seizoen
- **1 todo**: Status rondo_open, linked to person:1, with due_date
- **2 comments**: One rondo_note on person:1, one rondo_activity on person:2
- **taxonomies**: 3 relationship_types (parent, child, sibling) with inverse mappings, 1 seizoen
- **settings**: rondo_club_name, one season of fee categories, family discount config, player_roles, excluded_roles

Use fake Dutch data for the example (since real data would be anonymized anyway):
- Person 1: "Jan de Vries", male, active, born 1985-03-15, member since 2020-09-01
- Person 2: "Maria van den Berg", female, former member, born 2012-07-22, lid-tot 2024-06-30, child of person:1

Keep the JSON well-formatted (2-space indent) for readability in diffs. Demonstrate but don't exhaustively fill every nullable field -- some fields should be null to show that's valid.

IMPORTANT: Use realistic Dutch addresses, phone numbers, and email format (but fake data). Date formats must match what the schema specifies (Y-m-d for ACF date fields, Ymd for discipline case dates, ISO 8601 for timestamps).
  </action>
  <verify>
Verify the file is valid JSON and contains all top-level keys:
```bash
node -e "const f = require('./fixtures/demo-fixture.example.json'); const keys = Object.keys(f); console.log('Keys:', keys.join(', ')); console.log('Valid:', keys.length >= 8 ? 'YES' : 'NO')"
```
  </verify>
  <done>
Example fixture exists at `fixtures/demo-fixture.example.json`, is valid JSON, contains all 8 top-level sections, demonstrates cross-entity references (person→team in work_history, person→person in relationships, discipline_case→person, todo→person, comment→person), and uses the reference ID format documented in the schema.
  </done>
</task>

</tasks>

<verification>
1. `docs/demo-fixture-schema.md` exists and documents all entity types: people, teams, commissies, discipline_cases, todos, comments, taxonomies, settings
2. `docs/demo-fixture-schema.md` documents the reference ID system for cross-entity linking
3. `docs/demo-fixture-schema.md` explicitly lists excluded data types
4. `fixtures/demo-fixture.example.json` is valid JSON
5. The example fixture contains at least one instance of every entity type
6. The example fixture demonstrates cross-entity references (work_history→team, relationships→person, discipline_case→person, todo→person, comment→person)
7. The schema and example are consistent (same field names, same structure)
</verification>

<success_criteria>
- A JSON schema documentation exists that Phase 171 (export) and Phase 173 (import) can both use as their contract
- The schema covers all entity types from the CONTEXT decisions (people, teams, commissies, discipline cases, tasks, notes, activities, relationship types, settings)
- The reference system enables importing into any WordPress instance without ID conflicts
- A minimal example fixture validates the schema is implementable
</success_criteria>

<output>
After completion, create `.planning/phases/170-fixture-format-design/170-01-SUMMARY.md`
</output>
