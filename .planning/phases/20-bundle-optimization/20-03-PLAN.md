---
phase: 20-bundle-optimization
plan: 03
type: execute
depends_on: ["20-02"]
files_modified: [src/components/family-tree/TreeVisualization.jsx, src/pages/People/FamilyTree.jsx, src/components/RichTextEditor.jsx, src/components/Timeline/NoteModal.jsx, src/components/Timeline/QuickActivityModal.jsx]
---

<objective>
Lazy load heavy third-party libraries (vis-network, TipTap) that are only used in specific features.

Purpose: vis-network (~300KB) and TipTap (~150KB) are large libraries used only in FamilyTree and notes/activities. Dynamic imports prevent loading these until needed.

Output: Heavy libraries load on-demand, further reducing initial bundle.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-bundle-optimization/20-02-SUMMARY.md
@src/components/family-tree/TreeVisualization.jsx
@src/components/RichTextEditor.jsx

**Heavy libraries to lazy load:**
1. `vis-network` + `vis-data` - Only used in TreeVisualization.jsx (FamilyTree page)
2. `@tiptap/*` - Only used in RichTextEditor.jsx (notes and activities)

**Note:** @icons-pack/react-simple-icons is used only in PersonDetail.jsx which is already lazy-loaded as a page, so those icons will automatically be in the PersonDetail chunk.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Lazy load vis-network in FamilyTree</name>
  <files>src/pages/People/FamilyTree.jsx</files>
  <action>
The TreeVisualization component is only rendered in FamilyTree.jsx. Make it a lazy-loaded component:

1. In FamilyTree.jsx, change:
```javascript
import TreeVisualization from '@/components/family-tree/TreeVisualization';
```
to:
```javascript
import { lazy, Suspense } from 'react';
const TreeVisualization = lazy(() => import('@/components/family-tree/TreeVisualization'));
```

2. Wrap the TreeVisualization usage with Suspense and a loading state:
```jsx
<Suspense fallback={
  <div className="flex items-center justify-center h-96">
    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
    <span className="ml-3 text-gray-500">Loading visualization...</span>
  </div>
}>
  <TreeVisualization ... />
</Suspense>
```

This ensures vis-network and vis-data are only loaded when viewing a family tree.
  </action>
  <verify>npm run build shows vis-* libraries in a separate chunk</verify>
  <done>vis-network chunk loads only when navigating to family tree page</done>
</task>

<task type="auto">
  <name>Task 2: Lazy load TipTap in RichTextEditor</name>
  <files>src/components/RichTextEditor.jsx, src/components/Timeline/NoteModal.jsx, src/components/Timeline/QuickActivityModal.jsx</files>
  <action>
RichTextEditor is used in NoteModal and QuickActivityModal. Lazy load it at the modal level.

1. In NoteModal.jsx, change the import:
```javascript
import RichTextEditor from '@/components/RichTextEditor';
```
to:
```javascript
import { lazy, Suspense } from 'react';
const RichTextEditor = lazy(() => import('@/components/RichTextEditor'));
```

2. Wrap the RichTextEditor usage in NoteModal with Suspense:
```jsx
<Suspense fallback={
  <div className="border border-gray-300 rounded-md p-3 min-h-[120px] animate-pulse bg-gray-100" />
}>
  <RichTextEditor ... />
</Suspense>
```

3. Repeat the same pattern in QuickActivityModal.jsx

This ensures TipTap is only loaded when a user opens the notes/activity modal.
  </action>
  <verify>npm run build shows @tiptap libraries in a separate chunk</verify>
  <done>TipTap chunk loads only when opening note/activity modals</done>
</task>

<task type="auto">
  <name>Task 3: Final verification and documentation</name>
  <files>None (verification only)</files>
  <action>
1. Run `npm run build` and capture complete output
2. Document final chunk breakdown:
   - vendor chunk size
   - utils chunk size
   - main chunk size
   - page chunks (average size)
   - vis-network chunk size
   - tiptap chunk size
3. Calculate initial load size (what loads for Dashboard)
4. Compare to original 1,646 KB baseline
5. Test with `npm run preview`:
   - Load Dashboard (verify small initial load)
   - Navigate to People list
   - Open a note modal (verify TipTap loads)
   - Navigate to family tree (verify vis-network loads)
6. Check browser Network tab confirms dynamic loading
  </action>
  <verify>All heavy libraries in separate chunks, initial load under 500KB target</verify>
  <done>Complete size documentation, all tests pass, target achieved</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` produces vis-* chunk
- [ ] `npm run build` produces tiptap chunk
- [ ] Initial bundle (vendor + utils + main + Dashboard) under 500KB
- [ ] Family tree page loads vis-network on demand
- [ ] Note modal loads TipTap on demand
- [ ] No console errors
- [ ] Complete size comparison documented
</verification>

<success_criteria>

- vis-network lazy loaded via component-level Suspense
- TipTap lazy loaded via component-level Suspense
- Initial load size under 500KB target
- All features still work correctly
- Phase 20 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/20-bundle-optimization/20-03-SUMMARY.md` with:
- Final bundle breakdown (all chunks with sizes)
- Initial load size achieved
- Comparison to 1,646 KB baseline
- Phase 20 complete status
</output>
