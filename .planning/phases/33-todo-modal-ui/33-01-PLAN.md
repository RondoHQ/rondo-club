---
phase: 33-todo-modal-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/components/Timeline/TodoModal.jsx, src/components/Timeline/GlobalTodoModal.jsx, src/pages/Todos/TodosList.jsx, src/components/PersonDetail/TodosSidebar.jsx, src/hooks/usePeople.js]
autonomous: true
---

<objective>
Enhance TodoModal and GlobalTodoModal with notes editor and multi-person selector, plus visual polish for todo display.

Purpose: Complete Phase 33 of v3.3 Todo Enhancement milestone - integrating Phase 32's backend changes (notes field, multi-person support) into the frontend UI.

Output: Enhanced todo modals with rich text notes, multi-person selection, and improved todo display across all views.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-todo-data-model/32-01-SUMMARY.md

# Phase 32 delivered:
# - notes ACF field (WYSIWYG) on todos
# - related_persons multi-value field (replaces related_person)
# - REST API returns: notes, persons array (with backward compat person_id, person_name, person_thumbnail)
# - API accepts: notes, person_ids array (with backward compat via URL person_id)

# Existing components to reference:
@src/components/RichTextEditor.jsx
@src/components/Timeline/TodoModal.jsx
@src/components/Timeline/GlobalTodoModal.jsx
@src/hooks/usePeople.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance TodoModal with notes editor and multi-person selector</name>
  <files>src/components/Timeline/TodoModal.jsx</files>
  <action>
Upgrade TodoModal to support notes and multi-person:

1. Add imports:
   - Import RichTextEditor from '@/components/RichTextEditor'
   - Import usePeople from '@/hooks/usePeople'
   - Import User, X, ChevronDown, Search from lucide-react

2. Add state for notes and multi-person:
   - const [notes, setNotes] = useState('')
   - const [selectedPersonIds, setSelectedPersonIds] = useState([])
   - const [isPersonDropdownOpen, setIsPersonDropdownOpen] = useState(false)
   - const [personSearchQuery, setPersonSearchQuery] = useState('')

3. Fetch people for multi-person selector:
   - const { data: people = [], isLoading: isPeopleLoading } = usePeople()

4. In useEffect when loading existing todo:
   - setNotes(todo?.notes || '')
   - setSelectedPersonIds(todo?.persons?.map(p => p.id) || [todo?.person_id].filter(Boolean))

5. Add filteredPeople useMemo (same pattern as GlobalTodoModal):
   - Filter by personSearchQuery matching name/first_name/last_name
   - Sort alphabetically

6. Update form UI to add after description textarea:
   a. Notes field (collapsible, optional):
      - Label "Notes (optional)" with expand/collapse toggle
      - RichTextEditor component with minHeight="80px"
      - Only show when editing OR when expanded for new todos

   b. Related People section (only show when editing existing todo):
      - Label "Related people"
      - Display selected persons as chips with X to remove
      - "Add person" button opens dropdown
      - Dropdown with search input and scrollable person list
      - Each person shows thumbnail + name
      - Click to add, X to remove

7. Update handleSubmit to include notes and person_ids:
   - Add notes to submitted data (only if not empty)
   - Add person_ids array (existing persons from todo)

8. Style: Keep modal width max-w-md but notes section uses minHeight="80px" to avoid making modal too tall.

NOTE: TodoModal is used for editing todos on a person's detail page where the person context is already set. The multi-person selector is for showing/managing which people the todo is linked to, not required for new todos (that's handled by GlobalTodoModal). For new todos via TodoModal, person_id comes from the parent component prop.
  </action>
  <verify>
Open a person detail page, click to edit an existing todo, verify:
1. Notes field appears with existing content loaded
2. Related persons shown as chips
3. Can add/remove persons
4. Save works with updated data
  </verify>
  <done>TodoModal displays and saves notes field, shows related persons with add/remove capability</done>
</task>

<task type="auto">
  <name>Task 2: Enhance GlobalTodoModal with notes and multi-person</name>
  <files>src/components/Timeline/GlobalTodoModal.jsx</files>
  <action>
Upgrade GlobalTodoModal from single-person to multi-person selection:

1. Add imports:
   - Import RichTextEditor from '@/components/RichTextEditor'

2. Change state from single to multi-person:
   - Change selectedPersonId (string) to selectedPersonIds (array)
   - Add notes state: const [notes, setNotes] = useState('')

3. Update UI for multi-person selection:
   - Change "Person *" label to "People *"
   - Instead of single dropdown showing selected person, show:
     a. Selected persons as removable chips (with thumbnail + name + X button)
     b. "Add person" button that opens the dropdown
   - Dropdown behavior same as before but clicking adds to array instead of replacing
   - Remove person by clicking X on chip

4. Add Notes field after Description:
   - Label "Notes (optional)"
   - Collapsible section (start collapsed for new todos)
   - RichTextEditor with minHeight="80px"
   - Value: notes, onChange: setNotes

5. Update handleSubmit:
   - Change personId to person_ids array: person_ids: selectedPersonIds.map(id => parseInt(id))
   - Add notes to data if not empty

6. Update validation:
   - Disable submit if selectedPersonIds.length === 0 instead of !selectedPersonId

7. Update reset in useEffect:
   - setSelectedPersonIds([]) instead of setSelectedPersonId('')
   - setNotes('')

8. Update selectedPerson useMemo to selectedPersons:
   - Return array of person objects matching selectedPersonIds
  </action>
  <verify>
From Todos page, click Add todo:
1. Can select multiple people (chips appear)
2. Can remove people by clicking X
3. Notes section appears (collapsible)
4. Submit sends person_ids array and notes
5. Todo appears linked to all selected people
  </verify>
  <done>GlobalTodoModal supports multi-person selection and notes input</done>
</task>

<task type="auto">
  <name>Task 3: Display notes and multi-person in todo lists</name>
  <files>src/pages/Todos/TodosList.jsx, src/components/PersonDetail/TodosSidebar.jsx</files>
  <action>
Update todo display to show notes preview and multiple linked persons:

**TodosList.jsx:**

1. Update todo item rendering to show:
   a. Multiple person avatars (stacked/overlapping) instead of single avatar
   b. "and X others" text when >3 persons linked
   c. Notes preview (truncated, first ~100 chars, stripped of HTML) below content
   d. Link to first person remains primary, others shown on hover/tooltip

2. For multi-person avatar display:
   - Stack up to 3 avatars with -ml-2 overlap
   - If >3, show "+N" badge
   - On hover, show tooltip with all names

3. For notes preview:
   - Use stripHtmlTags utility (already exists in richTextUtils)
   - Truncate to ~100 chars with ellipsis
   - Show in smaller, muted text below main content
   - Only show if notes exists and not empty

**TodosSidebar.jsx (if it exists, check first):**

If src/components/PersonDetail/TodosSidebar.jsx exists:
1. Show notes preview on each todo item
2. If todo has multiple persons, show small indicator (e.g., "Shared with 2 others")

If it doesn't exist (todos are inline in PersonDetail), find where todos are rendered and:
1. Add notes preview display
2. Add multi-person indicator

The key pattern for multi-person display:
```jsx
{/* Person avatars */}
<div className="flex items-center -space-x-2">
  {todo.persons.slice(0, 3).map(person => (
    <img key={person.id} src={person.thumbnail} className="w-6 h-6 rounded-full border-2 border-white" />
  ))}
  {todo.persons.length > 3 && (
    <span className="w-6 h-6 rounded-full bg-gray-200 text-xs flex items-center justify-center">
      +{todo.persons.length - 3}
    </span>
  )}
</div>
```
  </action>
  <verify>
1. TodosList page shows stacked avatars for multi-person todos
2. Notes preview appears below todo content
3. Person detail sidebar shows notes and multi-person indicators
  </verify>
  <done>Notes and multi-person info displayed in all todo views</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TodoModal shows notes editor when editing todo
- [ ] TodoModal shows related persons with add/remove
- [ ] GlobalTodoModal supports multi-person selection
- [ ] GlobalTodoModal includes notes field
- [ ] TodosList shows notes preview
- [ ] TodosList shows multiple person avatars
- [ ] npm run build succeeds
- [ ] npm run lint passes (max-warnings 0)
</verification>

<success_criteria>
- All tasks completed
- Notes field functional in both modals
- Multi-person selection works in GlobalTodoModal
- Multi-person display works in TodoModal (edit mode)
- Todo lists show notes preview and multi-person avatars
- No lint errors or build failures
</success_criteria>

<output>
After completion, create `.planning/phases/33-todo-modal-ui/33-01-SUMMARY.md`
</output>
