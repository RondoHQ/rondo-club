---
phase: 95-backend-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-post-types.php
  - acf-json/group_feedback_fields.json
autonomous: true

must_haves:
  truths:
    - "User can create a feedback post in WordPress admin"
    - "Feedback stores type (bug/feature_request)"
    - "Feedback stores status (new/in_progress/resolved/declined)"
    - "Feedback stores priority (low/medium/high/critical)"
    - "Bug-specific fields appear only for bug type"
    - "Feature request fields appear only for feature_request type"
    - "Feedback posts are queryable via WP_Query"
  artifacts:
    - path: "includes/class-post-types.php"
      provides: "caelis_feedback CPT registration"
      contains: "register_feedback_post_type"
    - path: "acf-json/group_feedback_fields.json"
      provides: "ACF field group for feedback metadata"
      contains: "group_feedback_fields"
  key_links:
    - from: "includes/class-post-types.php"
      to: "register_post_type"
      via: "WordPress init hook"
      pattern: "register_post_type.*caelis_feedback"
    - from: "acf-json/group_feedback_fields.json"
      to: "caelis_feedback"
      via: "ACF location rule"
      pattern: "\"value\":\\s*\"caelis_feedback\""
---

<objective>
Register the `caelis_feedback` custom post type and create the ACF field group for storing feedback metadata.

Purpose: Establish the WordPress data layer foundation for the feedback system. This enables feedback to be created, stored, and queried using standard WordPress APIs.

Output:
- `caelis_feedback` CPT registered and visible in WordPress admin
- ACF field group with type, status, priority, and conditional fields for bug vs feature request
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v6.1-feedback-system/ROADMAP.md
@.planning/phases/95-backend-foundation/95-RESEARCH.md
@includes/class-post-types.php
@acf-json/group_todo_fields.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register caelis_feedback custom post type</name>
  <files>includes/class-post-types.php</files>
  <action>
Add a new private method `register_feedback_post_type()` to the `PostTypes` class, following the exact pattern of existing CPT registrations (e.g., `register_todo_post_type()`).

CPT configuration:
- Post type slug: `caelis_feedback`
- Labels: "Feedback" (singular and plural - feedback is uncountable)
- public: false
- publicly_queryable: false
- show_ui: true
- show_in_menu: true
- show_in_rest: true (required for Phase 2 REST API)
- rest_base: `feedback`
- query_var: false
- rewrite: false
- capability_type: post
- has_archive: false
- hierarchical: false
- menu_position: 26 (after Settings area)
- menu_icon: dashicons-megaphone
- supports: title, editor, author

Call the new method from `register_post_types()` at the end of the method.

Do NOT create custom post statuses (unlike prm_todo). The status will be managed via ACF select field for simplicity, as noted in the research document.
  </action>
  <verify>
1. WordPress admin shows "Feedback" menu item with megaphone icon
2. Can create a new feedback post with title and editor
3. `wp-json/wp/v2/feedback` endpoint exists (returns empty array or 401 if not logged in)
  </verify>
  <done>
- caelis_feedback CPT registered
- Visible in WordPress admin menu
- REST API endpoint accessible
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ACF field group for feedback metadata</name>
  <files>acf-json/group_feedback_fields.json</files>
  <action>
Create a new ACF field group JSON file with the following structure. Use consistent naming: `group_feedback_fields` for group key, `field_feedback_{name}` for field keys.

Fields to create:

1. `feedback_type` (select, required)
   - Choices: bug -> "Bug Report", feature_request -> "Feature Request"
   - No default (force user selection)
   - allow_null: 0

2. `status` (select, required)
   - Choices: new -> "New", in_progress -> "In Progress", resolved -> "Resolved", declined -> "Declined"
   - Default: "new"
   - allow_null: 0

3. `priority` (select, optional)
   - Choices: low -> "Low", medium -> "Medium", high -> "High", critical -> "Critical"
   - Default: "medium"
   - allow_null: 0

4. `browser_info` (text, optional)
   - Instructions: "Browser and OS information (auto-captured)"

5. `app_version` (text, optional)
   - Instructions: "Caelis version at time of submission"

6. `url_context` (text, optional)
   - Instructions: "Page URL where feedback was submitted"

7. `steps_to_reproduce` (textarea, optional)
   - Conditional: show only when feedback_type == bug
   - Instructions: "Describe the steps to reproduce this issue"
   - rows: 4

8. `expected_behavior` (textarea, optional)
   - Conditional: show only when feedback_type == bug
   - Instructions: "What did you expect to happen?"
   - rows: 4

9. `actual_behavior` (textarea, optional)
   - Conditional: show only when feedback_type == bug
   - Instructions: "What actually happened?"
   - rows: 4

10. `use_case` (textarea, optional)
    - Conditional: show only when feedback_type == feature_request
    - Instructions: "Describe how you would use this feature"
    - rows: 4

11. `attachments` (gallery, optional)
    - return_format: array
    - preview_size: medium
    - library: all
    - Instructions: "Screenshots or other files related to this feedback"

Location rule: post_type == caelis_feedback

Field group settings:
- position: normal
- style: default
- label_placement: top
- instruction_placement: label
- hide_on_screen: excerpt, discussion, comments, slug
- active: true
- show_in_rest: 1 (required for REST API access)
  </action>
  <verify>
1. File exists at acf-json/group_feedback_fields.json
2. JSON is valid (no syntax errors)
3. WordPress admin shows ACF fields when editing a feedback post
4. Bug-specific fields (steps_to_reproduce, expected_behavior, actual_behavior) appear only when type is "Bug Report"
5. Feature request field (use_case) appears only when type is "Feature Request"
  </verify>
  <done>
- ACF field group JSON created with 11 fields
- Conditional logic working for bug vs feature request fields
- Fields visible in WordPress admin when editing feedback
  </done>
</task>

</tasks>

<verification>
## Phase Verification

After completing both tasks, verify the full data layer:

1. **Create a bug report:**
   - Go to Feedback > Add New in WordPress admin
   - Fill in title: "Test Bug Report"
   - Select Type: "Bug Report"
   - Verify steps_to_reproduce, expected_behavior, actual_behavior fields appear
   - Verify use_case field is hidden
   - Set status and priority
   - Save and confirm all fields persist

2. **Create a feature request:**
   - Go to Feedback > Add New
   - Fill in title: "Test Feature Request"
   - Select Type: "Feature Request"
   - Verify use_case field appears
   - Verify bug-specific fields are hidden
   - Save and confirm all fields persist

3. **Query via WP_Query:**
   ```php
   $feedback = new WP_Query([
       'post_type' => 'caelis_feedback',
       'posts_per_page' => -1,
   ]);
   ```
   Verify posts are returned.

4. **REST API access:**
   - Visit `/wp-json/wp/v2/feedback` when logged in
   - Confirm feedback posts are returned with ACF fields
</verification>

<success_criteria>
- [ ] caelis_feedback CPT registered and visible in admin menu
- [ ] ACF field group with 11 fields created
- [ ] Type field enforces bug/feature_request values
- [ ] Status field enforces new/in_progress/resolved/declined values
- [ ] Priority field has low/medium/high/critical options
- [ ] Bug-specific fields show only for bug type
- [ ] Feature request field shows only for feature_request type
- [ ] Attachments field accepts gallery uploads
- [ ] REST API endpoint `/wp-json/wp/v2/feedback` accessible
- [ ] Feedback posts queryable via WP_Query
</success_criteria>

<output>
After completion, create `.planning/phases/95-backend-foundation/95-01-SUMMARY.md`
</output>
