---
phase: 174-end-to-end-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - functions.php
  - src/components/layout/Layout.jsx
  - dist/
  - fixtures/demo-fixture.json
autonomous: true

must_haves:
  truths:
    - "Demo banner shows on demo.rondo.club but not on production"
    - "Export command produces a valid fixture JSON from production data"
    - "Import command loads fixture into demo site without errors"
    - "Demo site has fresh anonymized data after import"
  artifacts:
    - path: "fixtures/demo-fixture.json"
      provides: "Anonymized production fixture pulled from server"
    - path: "src/components/layout/Layout.jsx"
      provides: "Demo banner component"
    - path: "functions.php"
      provides: "isDemo flag in rondoConfig"
  key_links:
    - from: "functions.php"
      to: "window.rondoConfig.isDemo"
      via: "rondo_get_js_config() adds isDemo based on WP option"
      pattern: "isDemo"
    - from: "Layout.jsx"
      to: "window.rondoConfig.isDemo"
      via: "conditional banner rendering"
      pattern: "rondoConfig.*isDemo"
    - from: "wp rondo demo export"
      to: "fixtures/demo-fixture.json"
      via: "WP-CLI on production, then SCP to local"
    - from: "fixtures/demo-fixture.json"
      to: "wp rondo demo import --clean"
      via: "deploy to demo, then WP-CLI import on demo site"
---

<objective>
Add a demo site banner, generate the fixture from production, deploy to demo, and import demo data.

Purpose: Execute the full pipeline (export on production -> pull fixture -> deploy to demo -> import on demo with --clean) and add a demo banner that makes the demo site visually distinct from production.

Output: Demo site (demo.rondo.club) running with anonymized data and a visible demo banner. Fresh fixture file pulled locally.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/173-import-command/173-01-SUMMARY.md
@includes/class-demo-export.php
@includes/class-demo-import.php
@includes/class-wp-cli.php
@functions.php
@src/components/layout/Layout.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add demo banner to Layout and isDemo flag to PHP config</name>
  <files>
    functions.php
    src/components/layout/Layout.jsx
  </files>
  <action>
**1. Add `isDemo` flag to `rondo_get_js_config()` in `functions.php`:**

In the `rondo_get_js_config()` function, add an `isDemo` key to the returned array. The demo site is identified by the WordPress option `rondo_is_demo_site`. Add this line after `'freescoutUrl'`:

```php
'isDemo' => (bool) get_option( 'rondo_is_demo_site', false ),
```

This option will be set to `true` on the demo site via WP-CLI during the import process (Task 2 will set it). It does NOT need an ACF field or settings UI — it's a simple boolean flag set by the demo import pipeline.

**2. Add demo banner to `Layout.jsx`:**

In `src/components/layout/Layout.jsx`, add a `DemoBanner` component above the Layout's main `div`. The banner:
- Is approximately 28px high
- Has a bright yellow/amber background: `bg-amber-400`
- Dark text: `text-amber-900 font-semibold`
- Centered text: "DEMO OMGEVING — Dit is geen echte data"
- Text size: `text-xs` or `text-sm`
- Only renders when `window.rondoConfig?.isDemo` is truthy
- Is a simple div ABOVE the flex h-screen container, adjusting the overall page height

Implementation approach: Add a `DemoBanner` functional component that reads `window.rondoConfig?.isDemo` and returns null if falsy. Place it at the top of the Layout return, wrapping the existing content in a fragment. Adjust the outer div from `h-screen` to `h-[calc(100vh-28px)]` when the banner is present (or use a CSS approach that works).

Simpler approach: Wrap the existing Layout return in a fragment `<>`. Put the DemoBanner before the existing outer div. If banner is shown, change the outer div height from `h-screen` to use `calc(100vh - 28px)`.

```jsx
const isDemo = window.rondoConfig?.isDemo;

function DemoBanner() {
  if (!isDemo) return null;
  return (
    <div className="h-7 bg-amber-400 text-amber-900 text-xs font-semibold flex items-center justify-center shrink-0">
      DEMO OMGEVING — Dit is geen echte data
    </div>
  );
}
```

In the Layout component's return, wrap in a fragment and add DemoBanner:
```jsx
return (
  <>
    <DemoBanner />
    <div className={`flex ${isDemo ? 'h-[calc(100vh-28px)]' : 'h-screen'} bg-gray-50 dark:bg-gray-900`}>
      {/* ... existing content unchanged ... */}
    </div>
  </>
);
```

**3. Build the frontend:**
```bash
cd /Users/joostdevalk/Code/rondo/rondo-club && npm run build
```
  </action>
  <verify>
- `php -l functions.php` passes (no syntax errors)
- `npm run build` succeeds without errors
- `grep -q "isDemo" functions.php` confirms the config flag exists
- `grep -q "DEMO OMGEVING" src/components/layout/Layout.jsx` confirms the banner exists
  </verify>
  <done>Demo banner component added to Layout, isDemo flag added to PHP config, frontend built successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Execute full export-import pipeline on production and demo</name>
  <files>
    fixtures/demo-fixture.json
  </files>
  <action>
Execute the full pipeline: export on production, pull fixture locally, deploy to demo, import on demo.

**1. Deploy current code to production** (so export command with any fixes is available):
```bash
cd /Users/joostdevalk/Code/rondo/rondo-club && bin/deploy.sh
```

**2. Run export on production:**
```bash
source .env && ssh -p "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" "cd $DEPLOY_REMOTE_THEME_PATH && wp rondo demo export"
```
This creates `fixtures/demo-fixture.json` on the production server.

**3. Pull the fixture file locally via SCP:**
```bash
source .env && scp -P "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST:$DEPLOY_REMOTE_THEME_PATH/fixtures/demo-fixture.json" fixtures/demo-fixture.json
```

**4. Validate the fixture locally:**
- Verify it's valid JSON: `python3 -c "import json; d=json.load(open('fixtures/demo-fixture.json')); print(f'Records: {d[\"meta\"][\"record_counts\"]}')" `
- Verify reasonable record counts (people > 10, teams > 3)
- Spot-check for PII: ensure no real email domains (only fake ones like example.nl, rondo-demo.nl)

**5. Deploy code to demo site** (this puts the updated theme with banner + import command on demo):
```bash
cd /Users/joostdevalk/Code/rondo/rondo-club && bin/deploy-demo.sh
```

**6. Set the demo flag on the demo site:**
```bash
ssh -p 18765 u26-b0fnaayuzqqg@c1130624.sgvps.net "cd ~/www/demo.rondo.club/public_html && wp option update rondo_is_demo_site 1"
```

**7. Run import on the demo site with --clean:**
```bash
ssh -p 18765 u26-b0fnaayuzqqg@c1130624.sgvps.net "cd ~/www/demo.rondo.club/public_html/wp-content/themes/rondo-club && wp rondo demo import --clean"
```

**8. Clear caches on demo:**
```bash
ssh -p 18765 u26-b0fnaayuzqqg@c1130624.sgvps.net "cd ~/www/demo.rondo.club/public_html && wp cache flush && wp sg purge"
```

**9. If export or import produces errors**, diagnose and fix in `class-demo-export.php` or `class-demo-import.php`. Common issues:
- ACF field format mismatches (post object vs ID)
- Missing reference resolution
- Date format parsing errors
- WordPress option format issues

After fixing, rebuild (`npm run build`), redeploy to the relevant server, and re-run the failed step.

**10. Clean up production** — delete the exported fixture from the production server since it's not needed there:
```bash
source .env && ssh -p "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" "rm -f $DEPLOY_REMOTE_THEME_PATH/fixtures/demo-fixture.json"
```
  </action>
  <verify>
- `fixtures/demo-fixture.json` exists locally and is valid JSON
- Record counts are reasonable (people > 10, teams > 3)
- Export completed without errors on production
- Import completed without errors on demo site
- `ssh -p 18765 u26-b0fnaayuzqqg@c1130624.sgvps.net "cd ~/www/demo.rondo.club/public_html && wp option get rondo_is_demo_site"` returns `1`
  </verify>
  <done>Fixture exported from production, pulled locally, deployed to demo site, imported with --clean. Demo site has fresh anonymized data and the demo flag is set.</done>
</task>

</tasks>

<verification>
1. `fixtures/demo-fixture.json` exists locally and is valid JSON with realistic record counts
2. Demo site import completed without errors
3. Demo site has `rondo_is_demo_site` option set to `1`
4. Frontend build succeeded with demo banner code
5. Code deployed to both production and demo
</verification>

<success_criteria>
- Export from production produces valid anonymized fixture
- Fixture pulled locally for future commit
- Demo site has imported data via --clean flag
- Demo banner code is deployed to demo site
- Production remains untouched (no --clean, no import on production)
</success_criteria>

<output>
After completion, create `.planning/phases/174-end-to-end-verification/174-01-SUMMARY.md`
</output>
