---
phase: 180-invoice-creation-flow
plan: 02
type: execute
wave: 2
depends_on: ["180-01"]
files_modified:
  - src/components/FinancesCard.jsx
  - src/hooks/useInvoices.js
  - src/pages/People/PersonDetail.jsx
autonomous: true

must_haves:
  truths:
    - "Member's profile sidebar shows invoices linked to that person"
    - "Each invoice shows invoice number, status badge, total amount, and date"
    - "Invoice display updates immediately after creating a new invoice on Tuchtzaken tab"
    - "Users without financieel capability do not see invoice section"
  artifacts:
    - path: "src/hooks/useInvoices.js"
      provides: "usePersonInvoices hook for fetching invoices by person"
    - path: "src/components/FinancesCard.jsx"
      provides: "Facturen section showing person's invoices"
  key_links:
    - from: "src/hooks/useInvoices.js"
      to: "/rondo/v1/invoices"
      via: "prmApi.getInvoices with person_id param"
      pattern: "getInvoices.*person_id"
    - from: "src/components/FinancesCard.jsx"
      to: "src/hooks/useInvoices.js"
      via: "usePersonInvoices hook"
      pattern: "usePersonInvoices"
---

<objective>
Display invoices on the member's profile so users can see the result of invoice creation.

Purpose: After creating an invoice from the Tuchtzaken tab, users need to confirm it exists and see its status on the member's profile.
Output: Invoice list visible in the FinancesCard sidebar with status badges and amounts.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/180-invoice-creation-flow/180-01-SUMMARY.md
@src/components/FinancesCard.jsx
@src/hooks/useInvoices.js
@src/api/client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add usePersonInvoices hook</name>
  <files>src/hooks/useInvoices.js</files>
  <action>
  Add a new hook to the existing `src/hooks/useInvoices.js` file (created in 180-01):

  `usePersonInvoices(personId, options)` — TanStack Query hook:
  - Query key: `['invoices', 'person', personId]`
  - Calls `prmApi.getInvoices({ person_id: personId })`
  - Returns `data` as the array of invoice objects (extract `.data`)
  - Enabled when `personId` is truthy and `options.enabled` is true
  - `staleTime: 30000` (30 seconds)

  Also update the `useCreateInvoice` mutation's `onSuccess` to additionally invalidate `['invoices', 'person']` so the FinancesCard refreshes after invoice creation.
  </action>
  <verify>
  - Grep for `usePersonInvoices` in src/hooks/useInvoices.js confirms the hook exists
  - Grep for `invoices.*person` in src/hooks/useInvoices.js confirms the query key
  </verify>
  <done>
  usePersonInvoices hook fetches invoices for a specific person. Cache invalidation ensures invoice list updates after creation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Display invoices in FinancesCard sidebar</name>
  <files>src/components/FinancesCard.jsx</files>
  <action>
  Import and use the new hook in the FinancesCard:

  ```javascript
  import { usePersonInvoices } from '@/hooks/useInvoices';
  ```

  Add inside the component (after the existing hooks):
  ```javascript
  const { data: invoices = [] } = usePersonInvoices(personId, {
    enabled: Boolean(currentUser?.can_access_financieel),
  });
  ```

  Add a "Facturen" section at the bottom of the FinancesCard (after the existing Nikki/discipline sections, before the closing `</div>`). Only render this section when `invoices.length > 0`:

  ```jsx
  {invoices.length > 0 && (
    <div className="pt-3 mt-3 border-t border-gray-100 dark:border-gray-700">
      <div className="flex items-center gap-1.5 mb-2">
        <FileText className="w-3.5 h-3.5 text-gray-500 dark:text-gray-400" />
        <span className="text-sm font-medium text-gray-700 dark:text-gray-300">Facturen</span>
      </div>
      <div className="space-y-1.5">
        {invoices.map(invoice => (
          <div key={invoice.id} className="flex justify-between items-center text-sm">
            <div className="flex items-center gap-2">
              <span className="text-gray-600 dark:text-gray-400">{invoice.invoice_number}</span>
              <StatusBadge status={invoice.status} />
            </div>
            <span className="font-medium">{formatCurrency(invoice.total_amount, 2)}</span>
          </div>
        ))}
      </div>
    </div>
  )}
  ```

  Add the `FileText` icon to the lucide-react import at the top.

  Create a small `StatusBadge` helper component (inline, not exported) within the file:
  ```jsx
  function StatusBadge({ status }) {
    const styles = {
      draft: 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300',
      sent: 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400',
      paid: 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400',
      overdue: 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400',
    };
    const labels = {
      draft: 'Concept',
      sent: 'Verstuurd',
      paid: 'Betaald',
      overdue: 'Verlopen',
    };
    return (
      <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium ${styles[status] || styles.draft}`}>
        {labels[status] || status}
      </span>
    );
  }
  ```

  This keeps the display compact in the sidebar — just the invoice number, status badge, and amount per line.
  </action>
  <verify>
  - `npm run build` succeeds
  - Grep for `usePersonInvoices` in FinancesCard.jsx confirms the hook is used
  - Grep for `StatusBadge` in FinancesCard.jsx confirms the status badge component exists
  - Grep for `Facturen` in FinancesCard.jsx confirms the section header
  - Grep for `FileText` in FinancesCard.jsx confirms the icon import
  </verify>
  <done>
  FinancesCard sidebar shows "Facturen" section with invoice number, status badge (Concept/Verstuurd/Betaald/Verlopen), and amount for each invoice linked to the person. Section hidden when no invoices exist. Updates immediately after invoice creation.
  </done>
</task>

</tasks>

<verification>
1. Frontend build: `npm run build`
2. Verify usePersonInvoices hook exists: grep `usePersonInvoices` in src/hooks/useInvoices.js
3. Verify FinancesCard displays invoices: grep `Facturen` in src/components/FinancesCard.jsx
4. Verify status badges: grep `StatusBadge` in src/components/FinancesCard.jsx
5. Verify cache invalidation covers invoice list: grep `invoices.*person` in src/hooks/useInvoices.js
</verification>

<success_criteria>
- FinancesCard shows "Facturen" section when person has invoices
- Each invoice displays number, status badge, and amount
- Section updates immediately after creating invoice from Tuchtzaken tab
- Hidden when user lacks financieel capability
- Hidden when person has no invoices
</success_criteria>

<output>
After completion, create `.planning/phases/180-invoice-creation-flow/180-02-SUMMARY.md`
</output>
