---
phase: 180-invoice-creation-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-invoices.php
  - src/components/DisciplineCaseTable.jsx
  - src/pages/People/PersonDetail.jsx
  - src/hooks/useInvoices.js
autonomous: true

must_haves:
  truths:
    - "Tuchtzaken tab shows checkboxes next to each uninvoiced discipline case"
    - "Already-invoiced discipline cases do NOT show checkboxes (they show a factuur icon/badge instead)"
    - "User can select one or more uninvoiced cases and click 'Maak factuur' button"
    - "Clicking 'Maak factuur' creates a Draft invoice via REST API with selected cases as line items"
    - "Invoice total equals sum of selected cases' Boete (administrative_fee) fields"
    - "After invoice creation, selection resets and invoiced-case state updates"
  artifacts:
    - path: "includes/class-rest-invoices.php"
      provides: "GET /rondo/v1/invoices/invoiced-cases endpoint returning discipline case IDs that already have invoices"
      contains: "invoiced.cases"
    - path: "src/hooks/useInvoices.js"
      provides: "useInvoicedCaseIds hook and useCreateInvoice mutation"
    - path: "src/components/DisciplineCaseTable.jsx"
      provides: "Checkbox column for uninvoiced cases, selection state, Maak factuur button"
    - path: "src/pages/People/PersonDetail.jsx"
      provides: "Passes invoicedCaseIds and onCreateInvoice to DisciplineCaseTable"
  key_links:
    - from: "src/hooks/useInvoices.js"
      to: "/rondo/v1/invoices/invoiced-cases"
      via: "prmApi.getInvoicedCaseIds"
      pattern: "invoiced.cases"
    - from: "src/components/DisciplineCaseTable.jsx"
      to: "src/hooks/useInvoices.js"
      via: "props invoicedCaseIds and onCreateInvoice"
      pattern: "invoicedCaseIds"
    - from: "src/pages/People/PersonDetail.jsx"
      to: "src/hooks/useInvoices.js"
      via: "useInvoicedCaseIds and useCreateInvoice hooks"
      pattern: "useInvoicedCaseIds|useCreateInvoice"
---

<objective>
Add the ability to select uninvoiced discipline cases on a member's Tuchtzaken tab and create a draft invoice from the selection.

Purpose: This is the core invoice creation workflow — users need to pick which discipline cases to invoice, see the running total, and create the invoice with one click.
Output: Working selection UI on Tuchtzaken tab that creates invoices via REST API.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/179-invoice-data-model-rest-api/179-01-SUMMARY.md
@.planning/phases/179-invoice-data-model-rest-api/179-02-SUMMARY.md
@includes/class-rest-invoices.php
@src/components/DisciplineCaseTable.jsx
@src/pages/People/PersonDetail.jsx
@src/hooks/useDisciplineCases.js
@src/api/client.js
@acf-json/group_invoice_fields.json
@acf-json/group_discipline_case_fields.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add invoiced-cases endpoint and API client method</name>
  <files>includes/class-rest-invoices.php, src/api/client.js</files>
  <action>
  **Backend — `includes/class-rest-invoices.php`:**

  Add a new REST route in `register_routes()`:

  ```php
  register_rest_route(
      'rondo/v1',
      '/invoices/invoiced-cases',
      [
          [
              'methods'             => \WP_REST_Server::READABLE,
              'callback'            => [ $this, 'get_invoiced_case_ids' ],
              'permission_callback' => [ $this, 'check_financieel_permission' ],
              'args'                => [
                  'person_id' => [
                      'required'          => true,
                      'validate_callback' => function ( $param ) {
                          return is_numeric( $param );
                      },
                      'sanitize_callback' => 'absint',
                  ],
              ],
          ],
      ]
  );
  ```

  IMPORTANT: Register this route BEFORE the `/invoices/(?P<id>\d+)` route, otherwise WordPress will try to match "invoiced-cases" as an invoice ID and fail.

  Add the callback method `get_invoiced_case_ids($request)`:
  1. Get `person_id` from request
  2. Query all `rondo_invoice` posts where ACF `person` field = `person_id` (all statuses except trash: `rondo_draft`, `rondo_sent`, `rondo_paid`, `rondo_overdue`)
  3. For each invoice, get the `line_items` repeater field
  4. Extract the `discipline_case` ID from each line item
  5. Return a flat array of unique discipline case IDs (integers)

  Response format: `{ "case_ids": [123, 456, 789] }`

  **Frontend — `src/api/client.js`:**

  Add to the `prmApi` object:
  ```javascript
  getInvoicedCaseIds: (personId) => api.get('/rondo/v1/invoices/invoiced-cases', { params: { person_id: personId } }),
  ```
  </action>
  <verify>
  - `php -l includes/class-rest-invoices.php` passes
  - `npm run build` succeeds
  - Grep for `invoiced-cases` in class-rest-invoices.php returns the route registration
  - Grep for `getInvoicedCaseIds` in src/api/client.js returns the method
  </verify>
  <done>
  REST endpoint GET /rondo/v1/invoices/invoiced-cases?person_id=X returns array of discipline case IDs that already have invoices. API client method exists for frontend consumption.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add checkbox selection, Maak factuur button, and invoice creation to Tuchtzaken tab</name>
  <files>src/hooks/useInvoices.js, src/components/DisciplineCaseTable.jsx, src/pages/People/PersonDetail.jsx</files>
  <action>
  **Create `src/hooks/useInvoices.js`:**

  Create a new hooks file with:

  1. `useInvoicedCaseIds(personId, options)` — TanStack Query hook:
     - Query key: `['invoiced-case-ids', personId]`
     - Calls `prmApi.getInvoicedCaseIds(personId)`
     - Returns `data` as the array of case IDs (extract `.data.case_ids`)
     - Enabled when `personId` is truthy and `options.enabled` is true
     - `staleTime: 30000` (30 seconds — invoiced status changes infrequently during a session)

  2. `useCreateInvoice()` — TanStack Query mutation hook:
     - Calls `prmApi.createInvoice(data)` where data = `{ person_id, line_items }`
     - On success, invalidate both `['invoiced-case-ids']` and `['invoices']` query keys using `queryClient.invalidateQueries()`
     - Returns the mutation object

  **Modify `src/components/DisciplineCaseTable.jsx`:**

  Add new optional props:
  - `invoicedCaseIds` (Set or array, default `new Set()`) — IDs of discipline cases already on an invoice
  - `selectedCaseIds` (Set) — currently selected case IDs (controlled by parent)
  - `onSelectionChange` (function) — callback when selection changes, receives new Set
  - `onCreateInvoice` (function) — callback for "Maak factuur" button click
  - `isCreatingInvoice` (boolean) — loading state for the create button
  - `canCreateInvoice` (boolean, default false) — whether to show invoice selection UI

  Implementation:
  - Convert `invoicedCaseIds` to a Set at the top if it's an array
  - Add a checkbox column as the FIRST column in the table header and body (only when `canCreateInvoice` is true)
  - Header: checkbox to select/deselect all uninvoiced cases
  - Each row: checkbox if case is NOT in `invoicedCaseIds`, otherwise show a small receipt/file-text icon (from lucide: `FileText`) with tooltip "Al gefactureerd" and the case row at 60% opacity
  - Checkbox onChange: toggle the case ID in `selectedCaseIds` Set and call `onSelectionChange(newSet)`
  - Select-all checkbox: toggles all uninvoiced case IDs, calls `onSelectionChange`

  Add a sticky selection toolbar (only when `canCreateInvoice` is true and `selectedCaseIds.size > 0`):
  - Position: above the table, with `bg-electric-cyan text-white rounded-lg px-4 py-3 mb-3` styling
  - Left side: "{N} tuchtzaken geselecteerd — Totaal: €{sum}" where sum = sum of administrative_fee for selected cases
  - Right side: "Maak factuur" button (white text, dark background) that calls `onCreateInvoice()`
  - Show spinner on button if `isCreatingInvoice` is true
  - Calculate total from cases array: filter by selectedCaseIds, sum `parseFloat(acf.administrative_fee) || 0`

  Adjust the `colSpan` in the expanded detail row to account for the checkbox column when `canCreateInvoice` is true.

  **Modify `src/pages/People/PersonDetail.jsx`:**

  Import the new hooks:
  ```javascript
  import { useInvoicedCaseIds, useCreateInvoice } from '@/hooks/useInvoices';
  ```

  Add state and hooks near the existing discipline case hooks (around line 75):
  ```javascript
  const { data: invoicedCaseIds = [], isLoading: isInvoicedLoading } = useInvoicedCaseIds(id, {
    enabled: canAccessFairplay,
  });
  const createInvoice = useCreateInvoice();
  const [selectedCaseIds, setSelectedCaseIds] = useState(new Set());
  ```

  Check if user has financieel capability: `const canAccessFinancieel = currentUser?.can_access_financieel ?? false;`

  Add handler for invoice creation:
  ```javascript
  const handleCreateInvoice = async () => {
    if (selectedCaseIds.size === 0) return;

    const lineItems = disciplineCases
      .filter(dc => selectedCaseIds.has(dc.id))
      .map(dc => ({
        discipline_case_id: dc.id,
        description: dc.acf?.match_description || dc.acf?.sanction_description || '',
        amount: parseFloat(dc.acf?.administrative_fee) || 0,
      }));

    try {
      await createInvoice.mutateAsync({
        person_id: parseInt(id),
        line_items: lineItems,
      });
      setSelectedCaseIds(new Set());
    } catch {
      alert('Factuur kon niet worden aangemaakt. Probeer het opnieuw.');
    }
  };
  ```

  Update the DisciplineCaseTable usage in the discipline tab section (around line 1534):
  ```jsx
  <DisciplineCaseTable
    cases={disciplineCases}
    showPersonColumn={false}
    personMap={new Map()}
    isLoading={isDisciplineCasesLoading}
    invoicedCaseIds={new Set(invoicedCaseIds)}
    selectedCaseIds={selectedCaseIds}
    onSelectionChange={setSelectedCaseIds}
    onCreateInvoice={handleCreateInvoice}
    isCreatingInvoice={createInvoice.isPending}
    canCreateInvoice={canAccessFairplay && canAccessFinancieel}
  />
  ```

  Reset selectedCaseIds when switching away from discipline tab: add to the existing activeTab effect or a simple `useEffect(() => setSelectedCaseIds(new Set()), [activeTab])`.
  </action>
  <verify>
  - `npm run build` succeeds without errors
  - `src/hooks/useInvoices.js` exists with useInvoicedCaseIds and useCreateInvoice exports
  - Grep for `canCreateInvoice` in DisciplineCaseTable.jsx confirms the prop is used
  - Grep for `handleCreateInvoice` in PersonDetail.jsx confirms the handler exists
  - Grep for `selectedCaseIds` in PersonDetail.jsx confirms selection state management
  - Grep for `invoicedCaseIds` in DisciplineCaseTable.jsx confirms uninvoiced filtering
  </verify>
  <done>
  Tuchtzaken tab shows checkboxes for uninvoiced discipline cases. Already-invoiced cases show a receipt icon and reduced opacity. Selection toolbar shows count and running total. "Maak factuur" button creates Draft invoice via API, resets selection, and refreshes invoiced state.
  </done>
</task>

</tasks>

<verification>
1. PHP syntax check: `php -l includes/class-rest-invoices.php`
2. Frontend build: `npm run build`
3. Verify REST route registered: grep `invoiced-cases` in class-rest-invoices.php
4. Verify API client method: grep `getInvoicedCaseIds` in client.js
5. Verify hooks file exists: `src/hooks/useInvoices.js`
6. Verify DisciplineCaseTable has checkbox support: grep `canCreateInvoice` in DisciplineCaseTable.jsx
7. Verify PersonDetail wires up invoice creation: grep `handleCreateInvoice` in PersonDetail.jsx
</verification>

<success_criteria>
- Backend endpoint returns invoiced discipline case IDs for a person
- DisciplineCaseTable displays checkboxes for uninvoiced cases and badges for invoiced cases
- Selection toolbar shows selected count and running total
- "Maak factuur" button creates invoice and resets selection
- Frontend build passes
</success_criteria>

<output>
After completion, create `.planning/phases/180-invoice-creation-flow/180-01-SUMMARY.md`
</output>
