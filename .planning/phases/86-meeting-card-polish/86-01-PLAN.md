---
phase: 86-meeting-card-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/Dashboard.jsx
  - includes/class-wp-cli.php
autonomous: true

must_haves:
  truths:
    - "Past meetings appear visually dimmed on the dashboard"
    - "Currently active meeting is highlighted distinctly"
    - "Meeting times display in 24h format (HH:mm)"
    - "Event titles with & character display correctly (not &amp;)"
  artifacts:
    - path: "src/pages/Dashboard.jsx"
      provides: "MeetingCard component with time-based styling"
      contains: "isPast|isNow|HH:mm"
    - path: "includes/class-wp-cli.php"
      provides: "WP-CLI command for event title cleanup"
      contains: "cleanup-titles|html_entity_decode"
  key_links:
    - from: "src/pages/Dashboard.jsx"
      to: "MeetingCard"
      via: "time comparison for styling"
      pattern: "new Date.*start_time|end_time"
---

<objective>
Polish dashboard meeting cards with time-based styling and data cleanup

Purpose: Improve visual clarity of meeting cards by dimming past events, highlighting current events, and using 24h time format. Also clean up synced event titles that have HTML-encoded ampersands.

Output: Updated MeetingCard component with conditional styling and WP-CLI command for one-time data cleanup
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@src/pages/Dashboard.jsx
@includes/class-wp-cli.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MeetingCard styling and time format</name>
  <files>src/pages/Dashboard.jsx</files>
  <action>
Update the MeetingCard component in Dashboard.jsx:

1. Change time format from 12h to 24h:
   - Line 239: Change `format(new Date(meeting.start_time), 'h:mm a')` to `format(new Date(meeting.start_time), 'HH:mm')`
   - The 'HH:mm' format gives 24-hour time like "14:30" instead of "2:30 PM"

2. Add time-based status detection at the start of MeetingCard function:
   ```javascript
   const now = new Date();
   const startTime = new Date(meeting.start_time);
   const endTime = new Date(meeting.end_time);
   const isPast = endTime < now;
   const isNow = startTime <= now && now <= endTime;
   ```

3. Apply conditional styling to the button wrapper (line 279-282):
   - For past meetings: Add `opacity-50` class
   - For current meeting: Add a highlight style like `bg-accent-50 dark:bg-accent-900/30 ring-1 ring-accent-200 dark:ring-accent-700`
   - Default (upcoming): Keep current styling

4. Update the time display div (line 250) to reflect status:
   - Past: Keep muted color (already uses text-accent-600)
   - Current: Make bolder, perhaps `font-semibold`
   - The styling should work in both light and dark mode

Example button className update:
```javascript
className={`w-full flex items-center p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-left ${
  isPast ? 'opacity-50' : ''
} ${
  isNow ? 'bg-accent-50 dark:bg-accent-900/30 ring-1 ring-accent-200 dark:ring-accent-700' : ''
}`}
```
  </action>
  <verify>
Run `npm run build` to ensure no syntax errors. Visually verify on https://cael.is after deployment:
- Check a day with meetings showing 24h format (e.g., "14:30" not "2:30 PM")
- If there are past meetings, they should appear dimmed
- Current ongoing meeting (if any) should have highlight styling
  </verify>
  <done>
- Time displays in 24h format (HH:mm)
- Past events (end_time < now) are dimmed with opacity-50
- Current event (start < now < end) has highlight ring/background
- All styling works in both light and dark mode
  </done>
</task>

<task type="auto">
  <name>Task 2: Add WP-CLI command for event title cleanup</name>
  <files>includes/class-wp-cli.php</files>
  <action>
Add a new WP-CLI command to clean up HTML entities in calendar event titles. Add a new command class before the register commands section (around line 2273):

```php
/**
 * Calendar Event WP-CLI Commands
 */
class PRM_Event_CLI_Command {

    /**
     * Clean up HTML entities in calendar event titles
     *
     * Decodes HTML entities like &amp; to & in all calendar event titles.
     * This fixes titles synced from Google Calendar that have encoded ampersands.
     *
     * ## OPTIONS
     *
     * [--dry-run]
     * : Preview changes without making them
     *
     * ## EXAMPLES
     *
     *     wp prm event cleanup-titles
     *     wp prm event cleanup-titles --dry-run
     *
     * @when after_wp_load
     */
    public function cleanup_titles( $args, $assoc_args ) {
        $dry_run = isset( $assoc_args['dry-run'] );

        if ( $dry_run ) {
            WP_CLI::log( 'DRY RUN MODE - No changes will be made' );
        }

        WP_CLI::log( 'Cleaning up HTML entities in calendar event titles...' );
        WP_CLI::log( '' );

        // Get all calendar events
        global $wpdb;
        $events = $wpdb->get_results(
            "SELECT ID, post_title FROM {$wpdb->posts}
             WHERE post_type = 'calendar_event'
             AND post_status = 'publish'"
        );

        if ( empty( $events ) ) {
            WP_CLI::warning( 'No calendar events found.' );
            return;
        }

        WP_CLI::log( sprintf( 'Found %d calendar event(s) to check.', count( $events ) ) );
        WP_CLI::log( '' );

        $updated = 0;
        $skipped = 0;

        foreach ( $events as $event ) {
            $original_title = $event->post_title;
            $decoded_title  = html_entity_decode( $original_title, ENT_QUOTES | ENT_HTML5, 'UTF-8' );

            // Skip if no change needed
            if ( $original_title === $decoded_title ) {
                ++$skipped;
                continue;
            }

            if ( $dry_run ) {
                WP_CLI::log( sprintf( '[WOULD UPDATE] #%d: "%s" -> "%s"', $event->ID, $original_title, $decoded_title ) );
            } else {
                wp_update_post( [
                    'ID'         => $event->ID,
                    'post_title' => $decoded_title,
                ] );
                WP_CLI::log( sprintf( '[UPDATED] #%d: "%s" -> "%s"', $event->ID, $original_title, $decoded_title ) );
            }

            ++$updated;
        }

        WP_CLI::log( '' );

        if ( $dry_run ) {
            WP_CLI::success( sprintf( 'Would update %d event(s). Skipped %d (no changes needed).', $updated, $skipped ) );
        } else {
            WP_CLI::success( sprintf( 'Updated %d event(s). Skipped %d (no changes needed).', $updated, $skipped ) );
        }
    }
}
```

Then register the command (add near line 2283 with the other registrations):
```php
WP_CLI::add_command( 'prm event', 'PRM_Event_CLI_Command' );
```
  </action>
  <verify>
After deployment, SSH to production and run:
```bash
wp prm event cleanup-titles --dry-run
```
This should list any events with HTML entities that would be cleaned up. If any found, run without --dry-run to fix them.
  </verify>
  <done>
- WP-CLI command `wp prm event cleanup-titles` exists
- Command has --dry-run option for preview
- Command decodes HTML entities in calendar_event post titles
- Running the command fixes any &amp; -> & issues in existing data
  </done>
</task>

<task type="auto">
  <name>Task 3: Build, deploy, and run cleanup</name>
  <files>dist/*</files>
  <action>
1. Run `npm run build` to create production build
2. Deploy to production using the rsync commands from CLAUDE.md
3. Clear production caches
4. SSH to production and run the cleanup command:
   ```bash
   wp prm event cleanup-titles --dry-run
   ```
   If events need cleanup, run:
   ```bash
   wp prm event cleanup-titles
   ```
  </action>
  <verify>
- `npm run build` completes without errors
- rsync deployment succeeds
- Cache flush succeeds
- WP-CLI cleanup command runs successfully on production
  </verify>
  <done>
- Production has updated code
- Any existing event titles with &amp; have been cleaned up
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Visual verification on https://cael.is:**
   - Navigate to dashboard with meetings widget visible
   - Verify times show in 24h format (e.g., "14:30" not "2:30 PM")
   - If past meetings exist: confirm they appear dimmed
   - If a meeting is currently happening: confirm it has highlight styling
   - Test in both light and dark mode

2. **Data cleanup verification:**
   - Run `wp prm event cleanup-titles --dry-run` on production
   - Should report 0 events needing cleanup (if cleanup already ran)
   - Check a meeting with "&" in title displays correctly
</verification>

<success_criteria>
- [ ] Meeting times display in 24h format (HH:mm)
- [ ] Past meetings (end_time < now) appear dimmed with opacity-50
- [ ] Current meeting (start <= now <= end) has distinct highlight styling
- [ ] Styling works correctly in both light and dark mode
- [ ] WP-CLI cleanup command exists and works
- [ ] Any existing &amp; in event titles have been decoded to &
- [ ] All changes deployed to production
</success_criteria>

<output>
After completion, create `.planning/phases/86-meeting-card-polish/86-01-SUMMARY.md`
</output>
