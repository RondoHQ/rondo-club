---
phase: 96-rest-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-feedback.php
  - functions.php
autonomous: true

must_haves:
  truths:
    - "Logged-in user can list their own feedback via GET /rondo/v1/feedback"
    - "Logged-in user can create feedback via POST /rondo/v1/feedback"
    - "Logged-in user can read their own feedback via GET /rondo/v1/feedback/{id}"
    - "Logged-in user can update their own feedback via PATCH /rondo/v1/feedback/{id}"
    - "Logged-in user can delete their own feedback via DELETE /rondo/v1/feedback/{id}"
    - "Admin can list all feedback from all users"
    - "Admin can update status and priority on any feedback"
    - "Non-admin cannot change status or priority fields"
    - "Unauthenticated requests return 401"
    - "Access to other users' feedback returns 403"
  artifacts:
    - path: "includes/class-rest-feedback.php"
      provides: "REST API controller for feedback CRUD"
      exports: ["Stadion\\REST\\Feedback"]
    - path: "functions.php"
      provides: "Feedback REST class instantiation"
      contains: "new Stadion\\REST\\Feedback"
  key_links:
    - from: "includes/class-rest-feedback.php"
      to: "includes/class-rest-base.php"
      via: "class extends"
      pattern: "class Feedback extends Base"
    - from: "includes/class-rest-feedback.php"
      to: "ACF fields"
      via: "get_field/update_field calls"
      pattern: "(get_field|update_field).*feedback"
    - from: "functions.php"
      to: "includes/class-rest-feedback.php"
      via: "require_once and instantiation"
      pattern: "class-rest-feedback"
---

<objective>
Create REST API endpoints for feedback CRUD operations under rondo/v1/feedback namespace.

Purpose: Enable external tools (and internal frontend) to create and manage feedback programmatically via authenticated REST API.

Output: Fully functional feedback REST API with permission-based access control.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v6.1-feedback-system/ROADMAP.md
@.planning/milestones/v6.1-feedback-system/REQUIREMENTS.md
@.planning/phases/96-rest-api/96-CONTEXT.md
@.planning/phases/96-rest-api/96-RESEARCH.md
@.planning/phases/95-backend-foundation/95-01-SUMMARY.md

# Existing patterns to follow
@includes/class-rest-base.php
@includes/class-rest-todos.php
@acf-json/group_feedback_fields.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Feedback REST class with route registration</name>
  <files>includes/class-rest-feedback.php, functions.php</files>
  <action>
Create `includes/class-rest-feedback.php` following the Todos pattern:

1. Namespace: `Stadion\REST`
2. Class `Feedback` extends `Base`
3. Constructor: call parent, add `rest_api_init` action for `register_routes`
4. Register all routes under `rondo/v1/feedback`:
   - GET /feedback (list) - permission: is_user_logged_in
   - POST /feedback (create) - permission: is_user_logged_in
   - GET /feedback/{id} (read) - permission: check_feedback_access
   - PATCH /feedback/{id} (update) - permission: check_feedback_access
   - DELETE /feedback/{id} (delete) - permission: check_feedback_access

5. Implement permission callbacks:
   - `check_feedback_access($request)`: Returns true if user is admin OR user owns the feedback post (post_author matches current user). Returns false for non-existent posts.

6. Add list query parameter args:
   - `type` (bug/feature_request)
   - `status` (new/in_progress/resolved/declined)
   - `priority` (low/medium/high/critical)
   - `per_page` (default 10, max 100)
   - `page` (default 1)
   - `orderby` (date/title/priority/status)
   - `order` (asc/desc)

Update functions.php to load and instantiate the class:
- Add require_once in rondo_init() alongside other REST classes
- Instantiate in plugins_loaded action alongside other REST classes

Note: Application Passwords work automatically with is_user_logged_in() - no special auth code needed.
  </action>
  <verify>
Check class exists and has expected structure:
```bash
grep -n "class Feedback extends Base" includes/class-rest-feedback.php
grep -n "register_rest_route.*rondo/v1.*feedback" includes/class-rest-feedback.php
grep -n "class-rest-feedback" functions.php
```
  </verify>
  <done>
Feedback REST class exists with 5 routes registered and is loaded via functions.php.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement list, create, and read endpoints</name>
  <files>includes/class-rest-feedback.php</files>
  <action>
Implement three endpoint callbacks:

**get_feedback_list($request):**
1. Get current user ID and check if admin
2. Build WP_Query args:
   - post_type: stadion_feedback
   - posts_per_page: from per_page param
   - paged: from page param
   - author: current_user_id (skip for admins)
   - Add meta_query filters for type, status, priority if provided
   - orderby/order handling (map 'priority' and 'status' to meta_value ordering)
3. Execute query
4. Format each post via format_feedback()
5. Build response with X-WP-Total and X-WP-TotalPages headers

**create_feedback($request):**
1. Validate required fields: title, feedback_type
2. Validate feedback_type is 'bug' or 'feature_request'
3. wp_insert_post with:
   - post_type: stadion_feedback
   - post_title: sanitized title
   - post_content: sanitized content (wp_kses_post)
   - post_status: publish
   - post_author: current_user_id
4. Save ACF fields via update_field():
   - feedback_type (required)
   - status (default: 'new')
   - priority (default: 'medium')
   - browser_info, app_version, url_context (optional)
   - Bug-specific: steps_to_reproduce, expected_behavior, actual_behavior
   - Feature-specific: use_case
   - attachments (array of media IDs)
5. Return formatted feedback

**get_feedback($request):**
1. Get post by ID
2. Validate it's stadion_feedback type
3. Return formatted feedback (or 404 error)

**format_feedback($post) helper:**
Return array with:
- id, title (sanitize_text), content (sanitize_rich_content)
- author object: { id, name (display_name), email }
- date (post_date_gmt), modified (post_modified_gmt)
- meta object with all ACF fields
- For attachments: format as array of { id, url, thumbnail, title }
  </action>
  <verify>
Test endpoints via curl (requires valid application password):
```bash
# These will fail without auth but should return 401 not 500
curl -s -o /dev/null -w "%{http_code}" "https://stadion.joost.blog/wp-json/rondo/v1/feedback"
# Should return 401 (not logged in)
```
Check implementation exists:
```bash
grep -n "function get_feedback_list" includes/class-rest-feedback.php
grep -n "function create_feedback" includes/class-rest-feedback.php
grep -n "function get_feedback" includes/class-rest-feedback.php
grep -n "function format_feedback" includes/class-rest-feedback.php
grep -n "X-WP-Total" includes/class-rest-feedback.php
```
  </verify>
  <done>
List endpoint returns paginated feedback with headers. Create endpoint accepts all feedback fields and returns created item. Read endpoint returns single feedback item.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement update and delete endpoints with field-level permissions</name>
  <files>includes/class-rest-feedback.php</files>
  <action>
Implement two endpoint callbacks:

**update_feedback($request):**
1. Get feedback post by ID
2. Validate post exists and is stadion_feedback type
3. Check field-level permissions (from CONTEXT.md):
   - If status param provided AND user is NOT admin: return 403 error "Only administrators can change feedback status"
   - If priority param provided AND user is NOT admin: return 403 error "Only administrators can change feedback priority"
4. Validate field values against allowed choices:
   - feedback_type: bug, feature_request
   - status: new, in_progress, resolved, declined
   - priority: low, medium, high, critical
5. Build wp_update_post args if title or content changed
6. Update ACF fields via update_field() for any provided params
7. Return formatted updated feedback

**delete_feedback($request):**
1. Get feedback post by ID
2. Validate post exists and is stadion_feedback type
3. wp_delete_post with force=true (bypass trash)
4. Return { deleted: true, id: post_id }

Error response format (WordPress standard):
```php
return new \WP_Error(
    'rest_forbidden',
    __( 'Only administrators can change feedback status.', 'stadion' ),
    [ 'status' => 403 ]
);
```

For invalid field values:
```php
return new \WP_Error(
    'rest_invalid_param',
    __( 'Invalid feedback type.', 'stadion' ),
    [ 'status' => 400, 'params' => [ 'feedback_type' => 'Must be "bug" or "feature_request"' ] ]
);
```
  </action>
  <verify>
Check implementation exists:
```bash
grep -n "function update_feedback" includes/class-rest-feedback.php
grep -n "function delete_feedback" includes/class-rest-feedback.php
grep -n "Only administrators can change" includes/class-rest-feedback.php
grep -n "rest_forbidden" includes/class-rest-feedback.php
grep -n "rest_invalid_param" includes/class-rest-feedback.php
```
  </verify>
  <done>
Update endpoint allows title/content/type-specific field changes by owners, restricts status/priority to admins only. Delete endpoint removes feedback and returns success confirmation.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Route registration:** All 5 routes registered under rondo/v1/feedback
2. **Authentication:** Unauthenticated requests return 401
3. **List filtering:** Non-admins only see own feedback
4. **CRUD operations:** Create, read, update, delete all functional
5. **Field-level permissions:** Status/priority changes blocked for non-admins
6. **Response format:** Matches WordPress REST conventions with author embed
7. **Pagination:** X-WP-Total and X-WP-TotalPages headers present on list
</verification>

<success_criteria>
- [ ] GET /rondo/v1/feedback returns user's own feedback (admin sees all)
- [ ] POST /rondo/v1/feedback creates feedback with all fields
- [ ] GET /rondo/v1/feedback/{id} returns single feedback (own or admin)
- [ ] PATCH /rondo/v1/feedback/{id} updates allowed fields (status/priority admin-only)
- [ ] DELETE /rondo/v1/feedback/{id} removes feedback (own or admin)
- [ ] Unauthenticated requests return 401
- [ ] Access to others' feedback returns 403
- [ ] Invalid field values return 400 with error details
</success_criteria>

<output>
After completion, create `.planning/phases/96-rest-api/96-01-SUMMARY.md`
</output>
