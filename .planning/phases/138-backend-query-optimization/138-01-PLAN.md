---
phase: 138-backend-query-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-api.php
autonomous: true

must_haves:
  truths:
    - "Dashboard stats load without fetching all todo IDs into memory"
    - "count_open_todos() uses wp_count_posts() not get_posts()"
    - "count_awaiting_todos() uses wp_count_posts() not get_posts()"
  artifacts:
    - path: "includes/class-rest-api.php"
      provides: "Optimized todo count functions"
      contains: "wp_count_posts('stadion_todo')"
  key_links:
    - from: "get_dashboard_summary()"
      to: "count_open_todos() and count_awaiting_todos()"
      via: "method calls at lines 2013, 2016"
      pattern: "wp_count_posts.*stadion_todo"
---

<objective>
Optimize backend todo count queries to use SQL COUNT instead of fetching all records.

Purpose: The current `count_open_todos()` and `count_awaiting_todos()` functions use `get_posts()` with `posts_per_page => -1`, which fetches ALL matching post IDs into memory before counting them. This is inefficient - replacing with `wp_count_posts()` executes a single SQL COUNT(*) query.

Output: Two optimized count functions using the same pattern already established in the dashboard for person/team/date counts.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/138-backend-query-optimization/138-RESEARCH.md
@includes/class-rest-api.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Optimize todo count functions</name>
  <files>includes/class-rest-api.php</files>
  <action>
Replace the inefficient `count_open_todos()` and `count_awaiting_todos()` functions with optimized versions using `wp_count_posts()`.

**Current implementation (lines 2043-2055 and 2136-2148):**
```php
private function count_open_todos() {
    $todos = get_posts([
        'post_type'      => 'stadion_todo',
        'post_status'    => 'stadion_open',
        'posts_per_page' => -1,
        'fields'         => 'ids',
    ]);
    return count($todos);
}
```

**Optimized implementation:**
```php
private function count_open_todos() {
    return wp_count_posts( 'stadion_todo' )->stadion_open ?? 0;
}

private function count_awaiting_todos() {
    return wp_count_posts( 'stadion_todo' )->stadion_awaiting ?? 0;
}
```

**Important:**
- Use null coalescing (`?? 0`) to handle the case where no posts have that status
- Keep the docblocks but update to reflect the new implementation
- Follow existing code style (tabs, spacing matching lines 1993-1995)
- This pattern is already used in the same file for `wp_count_posts('person')->publish`
  </action>
  <verify>
1. Run `npm run build` to ensure no PHP syntax errors
2. Deploy to production: `bin/deploy.sh`
3. Visit dashboard and confirm stats load correctly (open_todos_count and awaiting_todos_count should appear)
4. If possible, use Query Monitor plugin to verify no `posts_per_page=-1` queries for stadion_todo
  </verify>
  <done>
Both count functions use `wp_count_posts()` instead of `get_posts()`, dashboard stats display correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Update version and changelog</name>
  <files>style.css, package.json, CHANGELOG.md</files>
  <action>
Update version to 14.0.0 and add changelog entry.

**style.css:** Update `Version: X.X.X` to `Version: 14.0.0`

**package.json:** Update `"version": "X.X.X"` to `"version": "14.0.0"`

**CHANGELOG.md:** Add entry at top:
```markdown
## [14.0.0] - 2026-02-04

### Changed
- Optimized QueryClient defaults to prevent duplicate API calls on page load
- Migrated from BrowserRouter to createBrowserRouter for better route handling
- Modal people selectors now load data only when modal opens (lazy loading)
- Created centralized useCurrentUser hook for query deduplication
- VOG count now cached with 5-minute staleTime
- Backend todo count queries now use SQL COUNT instead of fetching all records
```
  </action>
  <verify>
1. Grep for version in style.css and package.json to confirm 14.0.0
2. Check CHANGELOG.md has the new entry
  </verify>
  <done>
Version updated to 14.0.0 in both files, changelog reflects v14.0 performance optimization milestone
  </done>
</task>

</tasks>

<verification>
1. Dashboard loads and displays stats correctly
2. `count_open_todos()` and `count_awaiting_todos()` both use `wp_count_posts()` pattern
3. No `posts_per_page => -1` queries for todo counting
4. Version is 14.0.0 across all files
</verification>

<success_criteria>
- Requirements BE-01 and BE-02 are satisfied
- Dashboard performance improved (no full record fetch for counts)
- v14.0 milestone complete
</success_criteria>

<output>
After completion, create `.planning/phases/138-backend-query-optimization/138-01-SUMMARY.md`
</output>
