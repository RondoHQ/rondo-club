---
phase: 83-conflict-deletion
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-google-contacts-export.php
autonomous: true

must_haves:
  truths:
    - "Deleting a contact in Caelis removes it from Google Contacts"
    - "Deletion propagates only for linked contacts (with _google_contact_id)"
    - "Google API errors do not block Caelis deletion"
    - "Trashing a contact does NOT delete from Google (only permanent delete)"
  artifacts:
    - path: "includes/class-google-contacts-export.php"
      provides: "Deletion hook and Google API delete call"
      contains: "before_delete_post"
  key_links:
    - from: "before_delete_post hook"
      to: "delete_google_contact()"
      via: "WordPress hook when person permanently deleted"
      pattern: "before_delete_post"
    - from: "delete_google_contact()"
      to: "PeopleService::deleteContact()"
      via: "Google People API call"
      pattern: "deleteContact"
---

<objective>
Add Caelis-to-Google deletion propagation via WordPress hook.

Purpose: When a user permanently deletes a contact in Caelis, automatically delete the corresponding contact from Google Contacts. This maintains sync integrity with Caelis as the source of truth.

Output: Modified export class with deletion hook that calls Google People API deleteContact.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/83-conflict-deletion/83-CONTEXT.md
@.planning/phases/83-conflict-deletion/83-RESEARCH.md
@.planning/phases/81-export-to-google/81-01-SUMMARY.md

@includes/class-google-contacts-export.php
@includes/class-google-contacts-connection.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deletion hook and Google API delete method</name>
  <files>includes/class-google-contacts-export.php</files>
  <action>
Add deletion propagation to GoogleContactsExport class:

1. In the `init()` static method, add a new hook registration AFTER the existing hooks:
   ```php
   add_action( 'before_delete_post', [ $instance, 'on_person_deleted' ], 10, 2 );
   ```

   IMPORTANT: Use `before_delete_post` NOT `delete_post`. The `before_delete_post` hook fires BEFORE meta is deleted, so we can still read `_google_contact_id`. It also only fires on permanent delete (empty trash), not when trashing.

2. Add new public method `on_person_deleted(int $post_id, \WP_Post $post): void`:
   ```php
   public function on_person_deleted( int $post_id, \WP_Post $post ): void {
       // Only handle person posts.
       if ( $post->post_type !== 'person' ) {
           return;
       }

       // Check if linked to Google.
       $google_id = get_post_meta( $post_id, '_google_contact_id', true );
       if ( empty( $google_id ) ) {
           return; // Not linked, nothing to delete in Google.
       }

       // Get post author (the user who owns this contact).
       $user_id = (int) $post->post_author;

       // Verify user has Google Contacts connected with readwrite access.
       $connection = GoogleContactsConnection::get_connection( $user_id );
       if ( ! $connection || ( $connection['access_mode'] ?? '' ) !== 'readwrite' ) {
           return; // Can't delete without write access.
       }

       // Attempt to delete from Google (non-blocking).
       $this->delete_google_contact( $google_id, $user_id );
   }
   ```

3. Add new private method `delete_google_contact(string $resource_name, int $user_id): bool`:
   ```php
   private function delete_google_contact( string $resource_name, int $user_id ): bool {
       try {
           // Create service for this user.
           $credentials = GoogleContactsConnection::get_decrypted_credentials( $user_id );
           if ( ! $credentials ) {
               return false;
           }

           $client = \Caelis\Calendar\GoogleOAuth::get_contacts_client( false, false );
           if ( ! $client ) {
               return false;
           }

           $client->setAccessToken( $credentials );

           // Refresh token if expired.
           if ( $client->isAccessTokenExpired() ) {
               $refresh_token = $client->getRefreshToken();
               if ( ! $refresh_token ) {
                   return false;
               }
               $client->fetchAccessTokenWithRefreshToken( $refresh_token );
               GoogleContactsConnection::update_credentials( $user_id, $client->getAccessToken() );
           }

           $service = new PeopleService( $client );

           // Delete the contact from Google.
           // https://developers.google.com/people/api/rest/v1/people/deleteContact
           $service->people->deleteContact( $resource_name );

           if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
               error_log( sprintf( 'PRM: Deleted Google contact %s for user %d', $resource_name, $user_id ) );
           }

           return true;

       } catch ( \Google\Service\Exception $e ) {
           // 404 means already deleted - that's fine.
           if ( $e->getCode() === 404 ) {
               return true;
           }

           // Log error but don't throw - never block local deletion.
           if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
               error_log( sprintf(
                   'PRM: Failed to delete Google contact %s: %s',
                   $resource_name,
                   $e->getMessage()
               ) );
           }

           return false;

       } catch ( \Exception $e ) {
           // Log any other error but don't throw.
           if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
               error_log( sprintf(
                   'PRM: Exception deleting Google contact %s: %s',
                   $resource_name,
                   $e->getMessage()
               ) );
           }

           return false;
       }
   }
   ```

Key design decisions:
- Use `before_delete_post` hook - fires before meta deletion, only on permanent delete
- Never throw exceptions in hook - always allow local deletion to proceed
- Handle 404 as success (contact already deleted in Google)
- Log errors for debugging but fail silently
- Check readwrite access before attempting delete
  </action>
  <verify>
Run syntax check: `php -l includes/class-google-contacts-export.php` returns no errors.

Verify the new methods exist:
- `grep -n "on_person_deleted" includes/class-google-contacts-export.php`
- `grep -n "delete_google_contact" includes/class-google-contacts-export.php`
- `grep -n "before_delete_post" includes/class-google-contacts-export.php`
  </verify>
  <done>
GoogleContactsExport class has:
- `before_delete_post` hook registered in `init()`
- `on_person_deleted()` method handling the hook
- `delete_google_contact()` method calling Google People API
- Proper error handling that never blocks local deletion
  </done>
</task>

<task type="auto">
  <name>Task 2: Build, deploy, and verify</name>
  <files>dist/</files>
  <action>
1. Build the frontend:
   ```bash
   cd /Users/joostdevalk/Code/caelis && npm run build
   ```

2. Deploy to production:
   ```bash
   # Sync dist folder
   rsync -avz --delete -e "ssh -p 18765" /Users/joostdevalk/Code/caelis/dist/ u25-eninwxjgiulh@c1130624.sgvps.net:~/www/cael.is/public_html/wp-content/themes/caelis/dist/

   # Sync theme files
   rsync -avz --exclude='.git' --exclude='node_modules' --exclude='dist' -e "ssh -p 18765" /Users/joostdevalk/Code/caelis/ u25-eninwxjgiulh@c1130624.sgvps.net:~/www/cael.is/public_html/wp-content/themes/caelis/

   # Clear caches
   ssh u25-eninwxjgiulh@c1130624.sgvps.net -p 18765 "cd ~/www/cael.is/public_html && wp cache flush && wp sg purge"
   ```

3. Verify PHP syntax on production:
   ```bash
   ssh u25-eninwxjgiulh@c1130624.sgvps.net -p 18765 "php -l ~/www/cael.is/public_html/wp-content/themes/caelis/includes/class-google-contacts-export.php"
   ```
  </action>
  <verify>
PHP file passes syntax check on production. Cache is cleared. Production site loads without errors.
  </verify>
  <done>
Deletion propagation code deployed to production. Permanently deleting a linked contact in Caelis will now delete it from Google Contacts.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Code review:
   - `before_delete_post` hook used (not `delete_post`)
   - Hook only fires for person post type
   - Only attempts delete if contact has `_google_contact_id`
   - Only attempts delete if user has readwrite access
   - Error handling never blocks local deletion
   - 404 errors treated as success

2. Behavior verification:
   - Trashing a contact does NOT delete from Google (before_delete_post only fires on permanent delete)
   - Permanently deleting a linked contact triggers Google API delete
   - Permanently deleting an unlinked contact has no Google API effect
   - Google API errors are logged but don't prevent Caelis deletion
</verification>

<success_criteria>
- [ ] `before_delete_post` hook registered in `init()`
- [ ] `on_person_deleted()` checks post type, google_id, and write access
- [ ] `delete_google_contact()` calls Google People API deleteContact
- [ ] Errors are caught and logged, never thrown
- [ ] 404 errors treated as success
- [ ] PHP file passes syntax check
- [ ] Code deployed to production
</success_criteria>

<output>
After completion, create `.planning/phases/83-conflict-deletion/83-02-SUMMARY.md`
</output>
