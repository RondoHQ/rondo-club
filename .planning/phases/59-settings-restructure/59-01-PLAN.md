---
phase: 59-settings-restructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/Settings/Settings.jsx
  - includes/class-rest-calendar.php
  - includes/class-rest-slack.php
autonomous: true
---

<objective>
Restructure Settings page to group external service connections under a unified "Connections" tab with subtabs.

Purpose: Better information architecture - group related connection management (Calendars, CardDAV, Slack) together, separating connection setup from notification preferences.

Output: Settings page with Connections tab containing Calendars, CardDAV, and Slack subtabs; updated OAuth redirect URLs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/pages/Settings/Settings.jsx
@includes/class-rest-calendar.php
@includes/class-rest-slack.php
</context>

<tasks>

<task type="auto">
<name>Task 1: Restructure Settings tabs with Connections subtabs</name>
<files>src/pages/Settings/Settings.jsx</files>
<action>
**Current tab structure:**
- Appearance, Calendars, Sync, Notifications, Data, Admin, About

**New tab structure:**
- Appearance, Connections, Notifications, Data, Admin, About

Where "Connections" has subtabs:
- Calendars (existing CalendarsTab content)
- CardDAV (CardDAV sync section from current SyncTab)
- Slack (Slack connection section from current NotificationsTab)

**Implementation steps:**

1. **Update TABS config** - Replace calendars/sync with single 'connections' tab:
```jsx
const TABS = [
  { id: 'appearance', label: 'Appearance', icon: Palette },
  { id: 'connections', label: 'Connections', icon: Share2 },
  { id: 'notifications', label: 'Notifications', icon: Bell },
  { id: 'data', label: 'Data', icon: Database },
  { id: 'admin', label: 'Admin', icon: Shield, adminOnly: true },
  { id: 'about', label: 'About', icon: Info },
];
```

2. **Add SUBTABS config** for Connections:
```jsx
const CONNECTION_SUBTABS = [
  { id: 'calendars', label: 'Calendars', icon: Calendar },
  { id: 'carddav', label: 'CardDAV', icon: Users },
  { id: 'slack', label: 'Slack', icon: MessageSquare },
];
```
(Import Users, MessageSquare from lucide-react)

3. **Create ConnectionsTab component** that:
   - Reads `subtab` from searchParams (default 'calendars')
   - Renders horizontal subtab navigation
   - Renders ConnectionsCalendarsSubtab, ConnectionsCardDAVSubtab, or ConnectionsSlackSubtab

4. **Create ConnectionsCalendarsSubtab component:**
   - Move entire CalendarsTab content here unchanged
   - Keep all state and handlers as-is

5. **Create ConnectionsCardDAVSubtab component:**
   - Extract CardDAV section from SyncTab:
     - App passwords creation/management
     - CardDAV URL display
   - Move appPasswords state and handlers to this subtab
   - Keep iCal subscription in SyncTab (rename to "Calendar Feed")

6. **Create ConnectionsSlackSubtab component:**
   - Extract Slack OAuth connection from NotificationsTab:
     - Connect/disconnect Slack
     - Slack target selection (channels/users)
   - Move slackConnected, slackWorkspaceName, slackChannels, slackUsers, slackTargets state
   - Leave notification channel toggles and time preferences in NotificationsTab

7. **Simplify SyncTab:**
   - Rename section header to "Calendar subscription" (already is)
   - Remove CardDAV section (moved to ConnectionsCardDAVSubtab)
   - Consider renaming tab to "Calendar Feed" or keep as "Sync" with just iCal

8. **Simplify NotificationsTab:**
   - Keep Email/Slack channel toggles (enable/disable)
   - Keep notification time preference
   - Keep mention notification preference
   - Remove Slack connection UI (moved to ConnectionsSlackSubtab)
   - Add note when Slack not connected: "Connect Slack in Connections tab to enable Slack notifications"

9. **Update URL scheme:**
   - Connections tab: `/settings?tab=connections` (defaults to calendars subtab)
   - With subtab: `/settings?tab=connections&subtab=calendars`
   - CardDAV: `/settings?tab=connections&subtab=carddav`
   - Slack: `/settings?tab=connections&subtab=slack`

10. **Handle OAuth callbacks:**
   - Google OAuth callback sets: `tab=connections&subtab=calendars&connected=google`
   - Slack OAuth callback sets: `tab=connections&subtab=slack&slack_connected=1`
   - Update useEffect handlers that read these params

**Subtab UI pattern** (inside ConnectionsTab):
```jsx
// Subtab navigation (horizontal pills)
<div className="flex gap-2 mb-6">
  {CONNECTION_SUBTABS.map((subtab) => {
    const Icon = subtab.icon;
    const isActive = activeSubtab === subtab.id;
    return (
      <button
        key={subtab.id}
        onClick={() => setActiveSubtab(subtab.id)}
        className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors
          ${isActive
            ? 'bg-accent-100 text-accent-700 dark:bg-accent-900/30 dark:text-accent-400'
            : 'text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800'
          }`}
      >
        <Icon className="w-4 h-4" />
        {subtab.label}
      </button>
    );
  })}
</div>
```

**Important:** Don't duplicate state - the ConnectionsTab should manage shared state for all subtabs that need it (like slackConnected which affects both Slack subtab and Notifications tab behavior).
</action>
<verify>npm run build succeeds, npm run lint passes</verify>
<done>Settings has Connections tab with Calendars/CardDAV/Slack subtabs; Sync tab shows only iCal; Notifications tab shows only preferences</done>
</task>

<task type="auto">
<name>Task 2: Update PHP OAuth redirect URLs</name>
<files>includes/class-rest-calendar.php, includes/class-rest-slack.php</files>
<action>
Update OAuth callback redirects to use new URL structure:

**class-rest-calendar.php** - Update Google OAuth callback URLs:

Find all occurrences of `'/settings?tab=calendars'` and change to `'/settings?tab=connections&subtab=calendars'`:
- Line 561: Error redirect
- Line 567: Invalid state error
- Line 573: Security verification error
- Line 583: No auth code error
- Line 609: Success redirect (add `connected=google`)
- Line 612: Exception error

**class-rest-slack.php** - Update Slack OAuth callback URL:

Find `'/settings?slack_connected=1'` and change to `'/settings?tab=connections&subtab=slack&slack_connected=1'`
- Line 323: Success redirect

**Also check for error redirects in Slack OAuth** that might need updating.
</action>
<verify>grep for 'tab=calendars' and 'slack_connected' shows only new URL format</verify>
<done>All OAuth redirects point to /settings?tab=connections&subtab=... URLs</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes (max-warnings: 0)
- [ ] Settings page loads with Connections tab visible
- [ ] Connections tab has Calendars/CardDAV/Slack subtabs
- [ ] Calendars subtab shows Google and CalDAV connection options
- [ ] CardDAV subtab shows app passwords and connection details
- [ ] Slack subtab shows connect/disconnect and target selection
- [ ] Notifications tab shows channel toggles and time preferences only
- [ ] Sync tab shows iCal subscription only
- [ ] PHP OAuth redirects updated to new URLs (grep confirms)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- External service connections grouped under Connections tab
- Clear separation between connection management and notification preferences
</success_criteria>

<output>
After completion, create `.planning/phases/59-settings-restructure/59-01-SUMMARY.md`
</output>
