---
phase: 13-bulk-actions
plan: 01
type: execute
depends_on: []
files_modified: [includes/class-rest-people.php, src/api/client.js, src/hooks/usePeople.js]
---

<objective>
Create bulk update REST endpoint and React hooks for batch operations.

Purpose: Enable backend support for updating multiple contacts' workspace assignments and visibility in a single API call.
Output: Working REST endpoint `/stadion/v1/people/bulk-update` and `useBulkUpdatePeople` hook.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-list-view-selection/12-01-SUMMARY.md

**Existing patterns:**
- REST routes registered in `class-rest-*.php` with `register_rest_route()`
- Permission callbacks use `check_post_owner()`, `check_person_access()` patterns
- `STADION_Visibility::set_visibility()` sets visibility on a single post
- `_assigned_workspaces` ACF field stores array of workspace IDs
- React mutations use TanStack Query `useMutation` with `queryClient.invalidateQueries()`
- API client has `wpApi` and `prmApi` objects with method wrappers

**Key files:**
@includes/class-rest-people.php
@includes/class-visibility.php
@src/api/client.js
@src/hooks/usePeople.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bulk update REST endpoint</name>
  <files>includes/class-rest-people.php</files>
  <action>
Add a POST endpoint `/stadion/v1/people/bulk-update` in the `register_routes()` method.

The endpoint accepts JSON body:
```json
{
  "ids": [1, 2, 3],
  "updates": {
    "visibility": "workspace",       // optional: "private", "workspace", or "shared"
    "assigned_workspaces": [10, 20]  // optional: array of workspace IDs
  }
}
```

Implementation:
1. Register route with `WP_REST_Server::CREATABLE`
2. Permission callback: new method `check_bulk_update_permission` that verifies current user owns all specified posts (loop through IDs, check `post_author === current_user_id`)
3. Args validation: `ids` is required array of integers, `updates` is required object with optional `visibility` and `assigned_workspaces` keys
4. Callback method `bulk_update_people`:
   - Loop through each ID
   - If `visibility` provided: call `STADION_Visibility::set_visibility($id, $visibility)`
   - If `assigned_workspaces` provided: call `update_field('_assigned_workspaces', $workspaces, $id)` - convert to term IDs first using the same pattern from PersonDetail.jsx save
   - Track success/failure per ID
   - Return `{ success: true, updated: [ids], failed: [] }` or partial success

IMPORTANT: For workspace assignment, need to convert workspace post IDs to term IDs using the workspace_access taxonomy. Look at how PersonDetail.jsx handles this - there's likely an existing pattern in the codebase for this conversion. Check if there's a REST action that does this or if it needs to be done server-side.
  </action>
  <verify>
Test with curl:
```bash
curl -X POST "https://cael.is/wp-json/stadion/v1/people/bulk-update" \
  -H "Content-Type: application/json" \
  -H "X-WP-Nonce: <nonce>" \
  -d '{"ids":[1,2],"updates":{"visibility":"private"}}'
```
Returns 200 with success response (or test locally with `npm run dev`).
  </verify>
  <done>Endpoint responds to POST requests, validates permissions per-post, updates visibility and/or workspaces for multiple people</done>
</task>

<task type="auto">
  <name>Task 2: Add bulk update API method and React hook</name>
  <files>src/api/client.js, src/hooks/usePeople.js</files>
  <action>
1. In `src/api/client.js`, add to `prmApi` object:
   ```js
   bulkUpdatePeople: (ids, updates) =>
     api.post('/stadion/v1/people/bulk-update', { ids, updates }),
   ```

2. In `src/hooks/usePeople.js`, add a new hook:
   ```js
   export function useBulkUpdatePeople() {
     const queryClient = useQueryClient();

     return useMutation({
       mutationFn: ({ ids, updates }) => prmApi.bulkUpdatePeople(ids, updates),
       onSuccess: () => {
         // Invalidate people list and details for all updated people
         queryClient.invalidateQueries({ queryKey: peopleKeys.lists() });
         queryClient.invalidateQueries({ queryKey: peopleKeys.details() });
       },
     });
   }
   ```
  </action>
  <verify>Import hook in a test file or browser console to verify no syntax errors. The hook should export correctly.</verify>
  <done>API client has `bulkUpdatePeople` method, `useBulkUpdatePeople` hook is exported from usePeople.js</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run lint` passes without errors
- [ ] `npm run build` succeeds
- [ ] Bulk update endpoint is registered (check `/wp-json/stadion/v1` route listing)
- [ ] Hook exports correctly from usePeople.js
</verification>

<success_criteria>

- Bulk update endpoint accepts array of IDs and updates object
- Endpoint validates ownership of each post before updating
- Visibility updates use STADION_Visibility helper
- Workspace updates use ACF update_field
- React hook available for use in UI
</success_criteria>

<output>
After completion, create `.planning/phases/13-bulk-actions/13-01-SUMMARY.md`
</output>
