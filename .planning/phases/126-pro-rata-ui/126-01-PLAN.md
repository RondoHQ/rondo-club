---
phase: 126-pro-rata-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-membership-fees.php
autonomous: true

must_haves:
  truths:
    - "System uses Sportlink registration date for pro-rata calculation"
    - "July-Sept joins pay 100% of calculated fee"
    - "October-December joins pay 75% of calculated fee"
    - "January-March joins pay 50% of calculated fee"
    - "April-June joins pay 25% of calculated fee"
    - "Pro-rata applies after family discount calculation"
  artifacts:
    - path: "includes/class-membership-fees.php"
      provides: "Pro-rata percentage calculation and fee integration"
      contains: "get_prorata_percentage"
  key_links:
    - from: "calculate_fee_with_family_discount"
      to: "get_prorata_percentage"
      via: "Pro-rata applied after family discount"
      pattern: "prorata.*final_fee"
---

<objective>
Add pro-rata calculation to MembershipFees class based on Sportlink registration date.

Purpose: Members joining mid-season pay a reduced fee proportional to remaining season time.
Output: Extended MembershipFees class with pro-rata percentage method and full fee calculation method.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/126-pro-rata-ui/126-CONTEXT.md
@.planning/phases/126-pro-rata-ui/126-RESEARCH.md
@.planning/phases/125-family-discount/125-02-SUMMARY.md
@includes/class-membership-fees.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pro-rata percentage method</name>
  <files>includes/class-membership-fees.php</files>
  <action>
Add a new public method `get_prorata_percentage` to the MembershipFees class that calculates the pro-rata percentage based on registration month:

```php
/**
 * Get pro-rata percentage based on registration month.
 *
 * Season starts July 1. Pro-rata tiers by quarter:
 * - Q1 (July-September): 100% - full season
 * - Q2 (October-December): 75% - 3/4 season
 * - Q3 (January-March): 50% - 1/2 season
 * - Q4 (April-June): 25% - 1/4 season
 *
 * @param string|null $registration_date Date in Y-m-d format, or null for 100%.
 * @return float Pro-rata percentage (0.25 to 1.0).
 */
public function get_prorata_percentage( ?string $registration_date ): float {
    // Null date = full fee (100%)
    if ( $registration_date === null || trim( $registration_date ) === '' ) {
        return 1.0;
    }

    $timestamp = strtotime( $registration_date );
    if ( $timestamp === false ) {
        return 1.0; // Invalid date = full fee
    }

    $month = (int) date( 'n', $timestamp );

    // Q1: July-September = 100%
    if ( $month >= 7 && $month <= 9 ) {
        return 1.0;
    }
    // Q2: October-December = 75%
    if ( $month >= 10 && $month <= 12 ) {
        return 0.75;
    }
    // Q3: January-March = 50%
    if ( $month >= 1 && $month <= 3 ) {
        return 0.50;
    }
    // Q4: April-June = 25%
    return 0.25;
}
```

Place this method after the `get_family_discount_rate` method for logical grouping.
  </action>
  <verify>
Run: `source .env && ssh -p "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" "cd ~/www/stadion.svawc.nl/public_html/wp-content/themes/stadion && wp eval 'echo (new \Stadion\Fees\MembershipFees())->get_prorata_percentage(\"2025-08-15\");'"` should return 1.0 (Q1).
  </verify>
  <done>Pro-rata percentage method returns correct values: July-Sept=100%, Oct-Dec=75%, Jan-Mar=50%, Apr-Jun=25%.</done>
</task>

<task type="auto">
  <name>Task 2: Add full fee calculation method with pro-rata</name>
  <files>includes/class-membership-fees.php</files>
  <action>
Add a new public method `calculate_full_fee` that combines base fee, family discount, and pro-rata:

```php
/**
 * Calculate complete fee with family discount and pro-rata
 *
 * Calculates: base_fee -> apply family discount -> apply pro-rata -> final_fee
 *
 * The registration_date should come from Sportlink data (ACF field 'registratiedatum').
 *
 * @param int         $person_id         The person post ID.
 * @param string|null $registration_date Sportlink registration date (Y-m-d format).
 * @param string|null $season            Optional season key, defaults to current season.
 * @return array|null Complete fee data or null if not calculable.
 */
public function calculate_full_fee( int $person_id, ?string $registration_date = null, ?string $season = null ): ?array {
    // Get fee with family discount
    $fee_data = $this->calculate_fee_with_family_discount( $person_id, $season );

    if ( $fee_data === null ) {
        return null;
    }

    // Get pro-rata percentage
    $prorata_percentage = $this->get_prorata_percentage( $registration_date );

    // Calculate pro-rata amount (applied to fee after family discount)
    $fee_after_discount = $fee_data['final_fee'];
    $prorata_amount     = (int) round( $fee_after_discount * $prorata_percentage );

    // Add pro-rata fields to result
    return array_merge(
        $fee_data,
        [
            'registration_date'   => $registration_date,
            'prorata_percentage'  => $prorata_percentage,
            'fee_after_discount'  => $fee_after_discount,
            'final_fee'           => $prorata_amount,  // Override final_fee with pro-rata amount
        ]
    );
}
```

Note: This method takes registration_date as a parameter rather than reading it from ACF because:
1. It keeps the method pure and testable
2. The REST API endpoint (Plan 02) will read the ACF field and pass it in
3. Allows flexibility for different date sources in the future

Place this method after `calculate_fee_with_family_discount` for logical grouping.
  </action>
  <verify>
Verify method exists and returns correct structure by running on production. Check that final_fee is correctly reduced for mid-season dates.
  </verify>
  <done>Full fee calculation method combines family discount and pro-rata correctly, with final_fee reflecting the pro-rata adjusted amount.</done>
</task>

<task type="auto">
  <name>Task 3: Build, deploy, and verify</name>
  <files></files>
  <action>
1. Run `npm run build` to create production assets
2. Run `bin/deploy.sh` to deploy to production
3. Verify the pro-rata methods work by testing edge cases via WP-CLI:
   - July registration (Q1) = 100%
   - November registration (Q2) = 75%
   - February registration (Q3) = 50%
   - May registration (Q4) = 25%
   - Null date = 100%
   - Empty string = 100%
  </action>
  <verify>
Run WP-CLI tests for each quarter boundary and edge cases.
  </verify>
  <done>Pro-rata calculation deployed and verified for all quarter boundaries.</done>
</task>

</tasks>

<verification>
1. `get_prorata_percentage('2025-07-01')` returns 1.0 (Q1 start)
2. `get_prorata_percentage('2025-09-30')` returns 1.0 (Q1 end)
3. `get_prorata_percentage('2025-10-01')` returns 0.75 (Q2 start)
4. `get_prorata_percentage('2026-01-15')` returns 0.50 (Q3 mid)
5. `get_prorata_percentage('2026-05-01')` returns 0.25 (Q4)
6. `get_prorata_percentage(null)` returns 1.0 (missing date)
7. `calculate_full_fee` returns array with all fee breakdown fields
</verification>

<success_criteria>
- Pro-rata percentage method exists and returns correct values for all quarters
- Full fee calculation integrates family discount and pro-rata correctly
- Order of operations: base_fee -> family_discount -> pro-rata -> final_fee
- Null/empty registration dates default to 100% (full fee)
- All code deployed to production
</success_criteria>

<output>
After completion, create `.planning/phases/126-pro-rata-ui/126-01-SUMMARY.md`
</output>
