---
phase: 126-pro-rata-ui
plan: 03
type: execute
wave: 3
depends_on: ["126-02"]
files_modified:
  - includes/class-rest-api.php
  - includes/class-membership-fees.php
  - src/pages/Contributie/ContributieList.jsx
autonomous: true

must_haves:
  truths:
    - "User can filter to show address mismatches"
    - "Address mismatches are visually flagged in the list"
    - "Mismatch detection identifies youth with same last name at different addresses"
  artifacts:
    - path: "src/pages/Contributie/ContributieList.jsx"
      provides: "Filter dropdown for address mismatches"
      contains: "addressFilter"
    - path: "includes/class-membership-fees.php"
      provides: "Address mismatch detection method"
      contains: "detect_address_mismatches"
  key_links:
    - from: "ContributieList.jsx"
      to: "addressFilter"
      via: "Filter state and dropdown"
      pattern: "addressFilter.*mismatch"
---

<objective>
Add address mismatch filter to Contributie list for data quality review.

Purpose: Identify potential siblings registered at different addresses for data cleanup.
Output: Filter dropdown in UI, backend mismatch detection, visual flagging.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/126-pro-rata-ui/126-CONTEXT.md
@.planning/phases/126-pro-rata-ui/126-RESEARCH.md
@.planning/phases/126-pro-rata-ui/126-02-SUMMARY.md
@src/pages/Contributie/ContributieList.jsx
@includes/class-membership-fees.php
@includes/class-rest-api.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add address mismatch detection method</name>
  <files>includes/class-membership-fees.php</files>
  <action>
Add a method to detect potential address mismatches - youth members with the same last name but different family keys (addresses).

```php
/**
 * Detect potential address mismatches within family groups
 *
 * Identifies youth members who share the same last name but have different
 * family keys (addresses). This suggests potential siblings registered at
 * different addresses, which is a data quality issue.
 *
 * @return array<int> Person IDs that have potential address mismatches.
 */
public function detect_address_mismatches(): array {
    // Query all person posts
    $query = new \WP_Query(
        [
            'post_type'      => 'person',
            'posts_per_page' => -1,
            'fields'         => 'ids',
            'no_found_rows'  => true,
        ]
    );

    // Youth categories eligible for family discount
    $youth_categories = [ 'mini', 'pupil', 'junior' ];

    // Build map: last_name => [ ['id' => X, 'family_key' => Y], ... ]
    $last_name_groups = [];

    foreach ( $query->posts as $person_id ) {
        // Calculate fee to determine if youth
        $fee_data = $this->calculate_fee( $person_id );

        // Skip non-calculable or non-youth
        if ( $fee_data === null || ! in_array( $fee_data['category'], $youth_categories, true ) ) {
            continue;
        }

        // Get last name
        $last_name = get_field( 'last_name', $person_id );
        if ( empty( $last_name ) ) {
            continue;
        }

        // Normalize last name for comparison (trim, lowercase)
        $normalized_name = strtolower( trim( $last_name ) );

        // Get family key
        $family_key = $this->get_family_key( $person_id );

        // Store in groups
        if ( ! isset( $last_name_groups[ $normalized_name ] ) ) {
            $last_name_groups[ $normalized_name ] = [];
        }
        $last_name_groups[ $normalized_name ][] = [
            'id'         => $person_id,
            'family_key' => $family_key,
        ];
    }

    // Find mismatches: same last name, different family keys
    $mismatch_ids = [];

    foreach ( $last_name_groups as $members ) {
        // Need at least 2 members with same last name
        if ( count( $members ) < 2 ) {
            continue;
        }

        // Get unique family keys (excluding null)
        $family_keys = array_unique(
            array_filter(
                array_column( $members, 'family_key' ),
                function ( $key ) {
                    return $key !== null;
                }
            )
        );

        // If more than 1 unique family key, we have a mismatch
        if ( count( $family_keys ) > 1 ) {
            foreach ( $members as $member ) {
                $mismatch_ids[] = $member['id'];
            }
        }

        // Also flag if any member has null family_key while others have valid keys
        $has_valid_key = count( $family_keys ) > 0;
        $has_null_key  = count( array_filter( array_column( $members, 'family_key' ), 'is_null' ) ) > 0;

        if ( $has_valid_key && $has_null_key ) {
            foreach ( $members as $member ) {
                if ( ! in_array( $member['id'], $mismatch_ids, true ) ) {
                    $mismatch_ids[] = $member['id'];
                }
            }
        }
    }

    return array_unique( $mismatch_ids );
}
```

Place this method at the end of the class, after `get_calculation_status`.
  </action>
  <verify>
Test via WP-CLI that the method runs without error and returns an array.
  </verify>
  <done>Address mismatch detection method identifies youth with same last name at different addresses.</done>
</task>

<task type="auto">
  <name>Task 2: Update REST endpoint with mismatch data</name>
  <files>includes/class-rest-api.php</files>
  <action>
Update the `get_fee_list` method to include mismatch information:

1. Add a new parameter to the endpoint args:
```php
'filter' => [
    'default'           => 'all',
    'validate_callback' => function ( $param ) {
        return in_array( $param, [ 'all', 'mismatches' ], true );
    },
],
```

2. In the callback method, after building results but before sorting, add mismatch detection:

```php
// Detect address mismatches
$mismatch_ids = $fees->detect_address_mismatches();

// Add mismatch flag to results
foreach ( $results as &$result ) {
    $result['has_mismatch'] = in_array( $result['id'], $mismatch_ids, true );
}
unset( $result );

// Apply filter
$filter = $request->get_param( 'filter' );
if ( $filter === 'mismatches' ) {
    $results = array_values( array_filter( $results, function ( $r ) {
        return $r['has_mismatch'];
    } ) );
}
```

3. Add mismatch count to the response:
```php
return rest_ensure_response(
    [
        'season'         => $season,
        'total'          => count( $results ),
        'mismatch_count' => count( array_filter( $results, function ( $r ) {
            return $r['has_mismatch'] ?? false;
        } ) ),
        'members'        => $results,
    ]
);
```
  </action>
  <verify>
Test endpoint with filter=mismatches parameter returns only mismatched members.
  </verify>
  <done>REST endpoint includes mismatch flag and supports filtering.</done>
</task>

<task type="auto">
  <name>Task 3: Add filter dropdown to ContributieList</name>
  <files>src/pages/Contributie/ContributieList.jsx</files>
  <action>
Update ContributieList.jsx to add address filter dropdown:

1. Add imports at top:
```javascript
import { useState, useCallback, useRef, useEffect } from 'react';
import { Filter, AlertTriangle, X } from 'lucide-react';
```

2. Add filter state after existing state declarations:
```javascript
const [addressFilter, setAddressFilter] = useState('all');
const [isFilterOpen, setIsFilterOpen] = useState(false);
const filterRef = useRef(null);
```

3. Update useFeeList call to include filter:
```javascript
const { data, isLoading, error } = useFeeList({ filter: addressFilter });
```

4. Add click outside handler (after existing useEffect or create new one):
```javascript
useEffect(() => {
  const handleClickOutside = (event) => {
    if (filterRef.current && !filterRef.current.contains(event.target)) {
      setIsFilterOpen(false);
    }
  };
  document.addEventListener('mousedown', handleClickOutside);
  return () => document.removeEventListener('mousedown', handleClickOutside);
}, []);
```

5. Add filter dropdown UI before the season indicator div:
```javascript
{/* Filter Section */}
<div className="flex flex-wrap items-center gap-2">
  {/* Filter Dropdown */}
  <div className="relative" ref={filterRef}>
    <button
      onClick={() => setIsFilterOpen(!isFilterOpen)}
      className={`btn-secondary ${addressFilter !== 'all' ? 'bg-accent-50 text-accent-700 border-accent-200 dark:bg-accent-900/30 dark:text-accent-300 dark:border-accent-700' : ''}`}
    >
      <Filter className="w-4 h-4 md:mr-2" />
      <span className="hidden md:inline">Filter</span>
      {addressFilter !== 'all' && (
        <span className="ml-2 px-1.5 py-0.5 bg-accent-600 text-white text-xs rounded-full">1</span>
      )}
    </button>

    {isFilterOpen && (
      <div className="absolute top-full left-0 mt-2 w-64 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50">
        <div className="p-4 space-y-2">
          <h3 className="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-2">
            Adres filter
          </h3>
          <label className="flex items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 p-2 rounded">
            <input
              type="radio"
              name="addressFilter"
              checked={addressFilter === 'all'}
              onChange={() => { setAddressFilter('all'); setIsFilterOpen(false); }}
              className="mr-3"
            />
            <span className="text-sm text-gray-700 dark:text-gray-200">
              Alle leden ({data?.total || 0})
            </span>
          </label>
          <label className="flex items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 p-2 rounded">
            <input
              type="radio"
              name="addressFilter"
              checked={addressFilter === 'mismatches'}
              onChange={() => { setAddressFilter('mismatches'); setIsFilterOpen(false); }}
              className="mr-3"
            />
            <span className="text-sm text-gray-700 dark:text-gray-200">
              Adres afwijkingen ({data?.mismatch_count || 0})
            </span>
          </label>
        </div>
      </div>
    )}
  </div>

  {/* Active Filter Chip */}
  {addressFilter !== 'all' && (
    <span className="inline-flex items-center gap-1 px-2 py-1 text-xs bg-amber-50 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 border border-amber-200 dark:border-amber-700 rounded">
      <AlertTriangle className="w-3 h-3" />
      Adres afwijkingen
      <button
        onClick={() => setAddressFilter('all')}
        className="hover:text-amber-900 dark:hover:text-amber-100"
      >
        <X className="w-3 h-3" />
      </button>
    </span>
  )}
</div>
```

6. Add warning indicator to FeeRow for mismatched members. Update the component to accept has_mismatch and show indicator:
```javascript
function FeeRow({ member, isOdd }) {
  const hasDiscount = member.family_discount_rate > 0;
  const hasProrata = member.prorata_percentage < 1.0;
  const hasMismatch = member.has_mismatch;

  return (
    <tr className={`hover:bg-gray-100 dark:hover:bg-gray-700 ${
      isOdd ? 'bg-gray-50 dark:bg-gray-800/50' : 'bg-white dark:bg-gray-800'
    } ${hasProrata ? 'bg-amber-50/50 dark:bg-amber-900/10' : ''}`}>
      {/* Name with mismatch indicator */}
      <td className="px-4 py-3 whitespace-nowrap">
        <div className="flex items-center gap-2">
          <Link
            to={`/people/${member.id}`}
            className="text-sm font-medium text-gray-900 dark:text-gray-50 hover:text-accent-600 dark:hover:text-accent-400"
          >
            {member.name}
          </Link>
          {hasMismatch && (
            <span
              className="text-amber-500 dark:text-amber-400"
              title="Mogelijk adres afwijking: zelfde achternaam, ander adres"
            >
              <AlertTriangle className="w-4 h-4" />
            </span>
          )}
        </div>
      </td>
      {/* ... rest unchanged ... */}
    </tr>
  );
}
```

7. Update useFeeList hook to accept params:
```javascript
// In src/hooks/useFees.js - update if needed
export function useFeeList(params = {}) {
  return useQuery({
    queryKey: feeKeys.list(params),
    queryFn: async () => {
      const response = await prmApi.getFeeList(params);
      return response.data;
    },
  });
}
```
  </action>
  <verify>
Visual check that filter dropdown appears and works correctly.
  </verify>
  <done>Filter dropdown allows filtering to mismatches only, with visual warning indicators.</done>
</task>

<task type="auto">
  <name>Task 4: Build, deploy, and verify</name>
  <files></files>
  <action>
1. Run `npm run lint` to check for errors
2. Run `npm run build` to create production assets
3. Run `bin/deploy.sh` to deploy to production
4. Verify:
   - Filter dropdown appears in Contributie list
   - Selecting "Adres afwijkingen" filters to only mismatched members
   - Members with mismatches show warning icon next to name
   - Filter chip shows when filter is active
   - Clear filter button works
  </action>
  <verify>
Visual verification on production.
  </verify>
  <done>Address mismatch filter deployed and working with visual indicators.</done>
</task>

</tasks>

<verification>
1. `detect_address_mismatches()` returns array of person IDs
2. REST endpoint accepts filter=mismatches parameter
3. REST response includes has_mismatch flag per member
4. REST response includes mismatch_count in totals
5. Filter dropdown shows "Alle leden" and "Adres afwijkingen" options
6. Selecting "Adres afwijkingen" filters the list
7. Warning icon appears next to names with mismatches
8. Filter chip appears when filter is active
9. X button clears the filter
</verification>

<success_criteria>
- Address mismatch detection identifies youth with same last name at different addresses
- Filter dropdown allows selecting "Adres afwijkingen" filter
- Visual warning indicators shown for mismatched members
- Filter state persists in query params
- All components deployed and working on production
</success_criteria>

<output>
After completion, create `.planning/phases/126-pro-rata-ui/126-03-SUMMARY.md`
</output>
