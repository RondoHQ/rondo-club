---
phase: 126-pro-rata-ui
plan: 02
type: execute
wave: 2
depends_on: ["126-01"]
files_modified:
  - includes/class-rest-api.php
  - src/components/layout/Layout.jsx
  - src/App.jsx
  - src/api/client.js
  - src/hooks/useFees.js
  - src/pages/Contributie/ContributieList.jsx
autonomous: true

must_haves:
  truths:
    - "Contributie section appears in sidebar below Leden, above VOG"
    - "List displays Name, Age Group, Base Fee, Family Discount, Pro-rata, Final Amount columns"
    - "Clicking a row navigates to member profile"
    - "Loading and error states display correctly"
  artifacts:
    - path: "src/pages/Contributie/ContributieList.jsx"
      provides: "Contributie list page component"
      min_lines: 100
    - path: "src/hooks/useFees.js"
      provides: "useFeeList hook for data fetching"
      exports: ["useFeeList", "feeKeys"]
    - path: "includes/class-rest-api.php"
      provides: "Fee list REST endpoint"
      contains: "/fees"
  key_links:
    - from: "ContributieList.jsx"
      to: "/rondo/v1/fees"
      via: "useFeeList hook"
      pattern: "useFeeList"
    - from: "Layout.jsx"
      to: "/contributie"
      via: "navigation array"
      pattern: "Contributie.*href.*contributie"
---

<objective>
Create Contributie list page with REST endpoint showing calculated membership fees.

Purpose: Users can view all calculated fees with breakdown (base, discount, pro-rata, final).
Output: New sidebar section, REST endpoint, React page with fee list.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/126-pro-rata-ui/126-CONTEXT.md
@.planning/phases/126-pro-rata-ui/126-RESEARCH.md
@.planning/phases/126-pro-rata-ui/126-01-SUMMARY.md
@src/pages/VOG/VOGList.jsx
@src/components/layout/Layout.jsx
@src/App.jsx
@src/api/client.js
@src/hooks/useVOGCount.js
@includes/class-rest-api.php
@includes/class-membership-fees.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add REST endpoint for fee list</name>
  <files>includes/class-rest-api.php</files>
  <action>
Add a new REST endpoint to return calculated fees for all members. Register in the `register_routes` method:

```php
// Get membership fee list
register_rest_route(
    'rondo/v1',
    '/fees',
    [
        'methods'             => \WP_REST_Server::READABLE,
        'callback'            => [ $this, 'get_fee_list' ],
        'permission_callback' => [ $this, 'check_user_approved' ],
        'args'                => [
            'season' => [
                'default'           => null,
                'validate_callback' => function ( $param ) {
                    return $param === null || preg_match( '/^\d{4}-\d{4}$/', $param );
                },
            ],
        ],
    ]
);
```

Add the callback method to the Api class:

```php
/**
 * Get membership fee list for all calculable members
 *
 * @param \WP_REST_Request $request The request object.
 * @return \WP_REST_Response
 */
public function get_fee_list( $request ) {
    $season = $request->get_param( 'season' );
    $fees   = new \Stadion\Fees\MembershipFees();

    if ( $season === null ) {
        $season = $fees->get_season_key();
    }

    // Query all person posts
    $query = new \WP_Query(
        [
            'post_type'      => 'person',
            'posts_per_page' => -1,
            'post_status'    => 'publish',
            'orderby'        => 'meta_value',
            'meta_key'       => 'first_name',
            'order'          => 'ASC',
        ]
    );

    $results = [];

    foreach ( $query->posts as $person ) {
        // Get registration date from ACF (Sportlink field)
        $registration_date = get_field( 'registratiedatum', $person->ID );

        // Calculate full fee with pro-rata
        $fee_data = $fees->calculate_full_fee( $person->ID, $registration_date, $season );

        // Skip non-calculable members
        if ( $fee_data === null ) {
            continue;
        }

        // Get person name
        $first_name = get_field( 'first_name', $person->ID ) ?: '';
        $last_name  = get_field( 'last_name', $person->ID ) ?: '';
        $name       = trim( $first_name . ' ' . $last_name );

        $results[] = [
            'id'                     => $person->ID,
            'name'                   => $name ?: $person->post_title,
            'category'               => $fee_data['category'],
            'leeftijdsgroep'         => $fee_data['leeftijdsgroep'],
            'base_fee'               => $fee_data['base_fee'],
            'family_discount_rate'   => $fee_data['family_discount_rate'],
            'family_discount_amount' => $fee_data['family_discount_amount'],
            'fee_after_discount'     => $fee_data['fee_after_discount'],
            'prorata_percentage'     => $fee_data['prorata_percentage'],
            'final_fee'              => $fee_data['final_fee'],
            'family_key'             => $fee_data['family_key'],
            'family_size'            => $fee_data['family_size'],
            'family_position'        => $fee_data['family_position'],
            'registration_date'      => $registration_date,
        ];
    }

    // Sort by category priority, then name
    $category_order = [ 'mini' => 1, 'pupil' => 2, 'junior' => 3, 'senior' => 4, 'recreant' => 5, 'donateur' => 6 ];
    usort( $results, function ( $a, $b ) use ( $category_order ) {
        $cat_cmp = ( $category_order[ $a['category'] ] ?? 99 ) <=> ( $category_order[ $b['category'] ] ?? 99 );
        if ( $cat_cmp !== 0 ) {
            return $cat_cmp;
        }
        return strcasecmp( $a['name'], $b['name'] );
    } );

    return rest_ensure_response(
        [
            'season'  => $season,
            'total'   => count( $results ),
            'members' => $results,
        ]
    );
}
```

Place the route registration near other data retrieval routes. Place the callback method with other list methods.
  </action>
  <verify>
Deploy and test: `curl -s "https://stadion.svawc.nl/wp-json/rondo/v1/fees" -H "Cookie: <auth>"` returns JSON with members array.
  </verify>
  <done>REST endpoint /rondo/v1/fees returns fee list sorted by category and name.</done>
</task>

<task type="auto">
  <name>Task 2: Add API client method and hook</name>
  <files>src/api/client.js, src/hooks/useFees.js</files>
  <action>
1. Add to `src/api/client.js` in the prmApi object (after existing methods like getDashboard):

```javascript
// Membership fees
getFeeList: (params = {}) => api.get('/rondo/v1/fees', { params }),
```

2. Create new file `src/hooks/useFees.js`:

```javascript
import { useQuery } from '@tanstack/react-query';
import { prmApi } from '@/api/client';

/**
 * Query keys for fee data
 */
export const feeKeys = {
  all: ['fees'],
  list: (params) => [...feeKeys.all, 'list', params],
};

/**
 * Hook for fetching the membership fee list
 *
 * @param {Object} params - Optional params (season filter)
 * @returns {Object} Query result with data, isLoading, error
 */
export function useFeeList(params = {}) {
  return useQuery({
    queryKey: feeKeys.list(params),
    queryFn: async () => {
      const response = await prmApi.getFeeList(params);
      return response.data;
    },
  });
}
```
  </action>
  <verify>
File exists at correct path and exports are correct.
  </verify>
  <done>API client method and useFeeList hook created.</done>
</task>

<task type="auto">
  <name>Task 3: Add navigation entry and route</name>
  <files>src/components/layout/Layout.jsx, src/App.jsx</files>
  <action>
1. In `src/components/layout/Layout.jsx`:

   a. Add Coins icon to imports at top:
   ```javascript
   import {
     Users,
     Building2,
     Calendar,
     Settings,
     Menu,
     X,
     Home,
     LogOut,
     Search,
     ChevronDown,
     CheckSquare,
     Command,
     UsersRound,
     MessageSquare,
     User,
     FileCheck,
     Coins  // ADD THIS
   } from 'lucide-react';
   ```

   b. Add Contributie to navigation array AFTER Leden and BEFORE VOG (keeping correct order per NAV-01):
   ```javascript
   const navigation = [
     { name: 'Dashboard', href: '/', icon: Home },
     { name: 'Leden', href: '/people', icon: Users },
     { name: 'Contributie', href: '/contributie', icon: Coins, indent: true },  // ADD THIS
     { name: 'VOG', href: '/vog', icon: FileCheck, indent: true },
     { name: 'Teams', href: '/teams', icon: Building2 },
     // ... rest unchanged
   ];
   ```

2. In `src/App.jsx`:

   a. Add lazy import at top with other page imports:
   ```javascript
   const ContributieList = lazy(() => import('@/pages/Contributie/ContributieList'));
   ```

   b. Add route after VOG route and before Teams routes:
   ```javascript
   {/* VOG route */}
   <Route path="/vog" element={<VOGList />} />

   {/* Contributie route */}
   <Route path="/contributie" element={<ContributieList />} />

   {/* Teams routes */}
   <Route path="/teams" element={<TeamsList />} />
   ```

3. In `src/components/layout/Layout.jsx`, add to the Header's getPageTitle function:
   ```javascript
   if (path.startsWith('/contributie')) return 'Contributie';
   ```
  </action>
  <verify>
Sidebar shows Contributie between Leden and VOG. Route /contributie loads without error.
  </verify>
  <done>Navigation entry and route added. Contributie appears in correct sidebar position.</done>
</task>

<task type="auto">
  <name>Task 4: Create ContributieList page component</name>
  <files>src/pages/Contributie/ContributieList.jsx</files>
  <action>
Create the directory and page component. Follow VOGList pattern but simpler (no bulk actions needed).

Create `src/pages/Contributie/ContributieList.jsx`:

```javascript
import { useState, useCallback } from 'react';
import { Link } from 'react-router-dom';
import { ArrowUp, ArrowDown, RefreshCw, Coins } from 'lucide-react';
import { useFeeList } from '@/hooks/useFees';
import { useQueryClient } from '@tanstack/react-query';
import PullToRefreshWrapper from '@/components/PullToRefreshWrapper';

// Format currency in euros
function formatCurrency(amount) {
  return new Intl.NumberFormat('nl-NL', {
    style: 'currency',
    currency: 'EUR',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(amount);
}

// Format percentage
function formatPercentage(rate) {
  return `${Math.round(rate * 100)}%`;
}

// Category badge colors
const categoryColors = {
  mini: 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300',
  pupil: 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
  junior: 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300',
  senior: 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300',
  recreant: 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300',
  donateur: 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300',
};

// Category labels
const categoryLabels = {
  mini: 'Mini',
  pupil: 'Pupil',
  junior: 'Junior',
  senior: 'Senior',
  recreant: 'Recreant',
  donateur: 'Donateur',
};

// Sortable header component
function SortableHeader({ label, columnId, sortField, sortOrder, onSort, className = '' }) {
  const isActive = sortField === columnId;
  const nextOrder = isActive && sortOrder === 'asc' ? 'desc' : 'asc';

  return (
    <th
      scope="col"
      className={`px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider bg-gray-50 dark:bg-gray-800 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 ${className}`}
      onClick={() => onSort(columnId, nextOrder)}
    >
      <div className="flex items-center gap-1">
        {label}
        {isActive && (
          sortOrder === 'asc' ? (
            <ArrowUp className="w-3 h-3" />
          ) : (
            <ArrowDown className="w-3 h-3" />
          )
        )}
      </div>
    </th>
  );
}

// Fee row component
function FeeRow({ member, isOdd }) {
  const hasDiscount = member.family_discount_rate > 0;
  const hasProrata = member.prorata_percentage < 1.0;

  return (
    <tr className={`hover:bg-gray-100 dark:hover:bg-gray-700 ${
      isOdd ? 'bg-gray-50 dark:bg-gray-800/50' : 'bg-white dark:bg-gray-800'
    } ${hasProrata ? 'bg-amber-50/50 dark:bg-amber-900/10' : ''}`}>
      {/* Name */}
      <td className="px-4 py-3 whitespace-nowrap">
        <Link
          to={`/people/${member.id}`}
          className="text-sm font-medium text-gray-900 dark:text-gray-50 hover:text-accent-600 dark:hover:text-accent-400"
        >
          {member.name}
        </Link>
      </td>

      {/* Category */}
      <td className="px-4 py-3 whitespace-nowrap">
        <span className={`inline-flex px-2 py-0.5 text-xs rounded-full ${categoryColors[member.category] || 'bg-gray-100 text-gray-700'}`}>
          {categoryLabels[member.category] || member.category}
        </span>
      </td>

      {/* Age Group */}
      <td className="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">
        {member.leeftijdsgroep || '-'}
      </td>

      {/* Base Fee */}
      <td className="px-4 py-3 text-sm text-gray-500 dark:text-gray-400 text-right">
        {formatCurrency(member.base_fee)}
      </td>

      {/* Family Discount */}
      <td className="px-4 py-3 text-sm text-right">
        {hasDiscount ? (
          <span className="text-green-600 dark:text-green-400">
            -{formatPercentage(member.family_discount_rate)}
          </span>
        ) : (
          <span className="text-gray-400 dark:text-gray-500">-</span>
        )}
      </td>

      {/* Pro-rata */}
      <td className="px-4 py-3 text-sm text-right">
        {hasProrata ? (
          <span className="text-amber-600 dark:text-amber-400">
            {formatPercentage(member.prorata_percentage)}
          </span>
        ) : (
          <span className="text-gray-400 dark:text-gray-500">100%</span>
        )}
      </td>

      {/* Final Fee */}
      <td className="px-4 py-3 text-sm font-medium text-gray-900 dark:text-gray-50 text-right">
        {formatCurrency(member.final_fee)}
      </td>
    </tr>
  );
}

// Empty state component
function EmptyState() {
  return (
    <div className="flex flex-col items-center justify-center py-12 text-center">
      <div className="flex justify-center mb-4">
        <div className="p-3 bg-gray-100 rounded-full dark:bg-gray-700">
          <Coins className="w-8 h-8 text-gray-400 dark:text-gray-500" />
        </div>
      </div>
      <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">
        Geen leden gevonden
      </h3>
      <p className="text-sm text-gray-600 dark:text-gray-400">
        Er zijn geen leden met een berekenbare contributie.
      </p>
    </div>
  );
}

export default function ContributieList() {
  const [sortField, setSortField] = useState('category');
  const [sortOrder, setSortOrder] = useState('asc');
  const queryClient = useQueryClient();

  // Fetch fee data
  const { data, isLoading, error } = useFeeList();

  // Handle sort
  const handleSort = useCallback((field, order) => {
    setSortField(field);
    setSortOrder(order);
  }, []);

  // Handle refresh
  const handleRefresh = async () => {
    await queryClient.invalidateQueries({ queryKey: ['fees'] });
  };

  // Sort members client-side
  const sortedMembers = data?.members ? [...data.members].sort((a, b) => {
    let cmp = 0;
    switch (sortField) {
      case 'name':
        cmp = a.name.localeCompare(b.name);
        break;
      case 'category':
        const catOrder = { mini: 1, pupil: 2, junior: 3, senior: 4, recreant: 5, donateur: 6 };
        cmp = (catOrder[a.category] || 99) - (catOrder[b.category] || 99);
        break;
      case 'base_fee':
        cmp = a.base_fee - b.base_fee;
        break;
      case 'final_fee':
        cmp = a.final_fee - b.final_fee;
        break;
      default:
        cmp = 0;
    }
    return sortOrder === 'asc' ? cmp : -cmp;
  }) : [];

  // Calculate totals
  const totals = sortedMembers.reduce(
    (acc, m) => ({
      baseFee: acc.baseFee + m.base_fee,
      finalFee: acc.finalFee + m.final_fee,
    }),
    { baseFee: 0, finalFee: 0 }
  );

  // Loading state
  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-accent-600 dark:border-accent-400"></div>
      </div>
    );
  }

  // Error state
  if (error) {
    return (
      <div className="card p-6 text-center">
        <p className="text-red-600 dark:text-red-400 mb-4">
          Contributie kon niet worden geladen.
        </p>
        <button
          onClick={handleRefresh}
          className="btn-secondary inline-flex items-center gap-2"
        >
          <RefreshCw className="w-4 h-4" />
          Opnieuw proberen
        </button>
      </div>
    );
  }

  // Empty state
  if (!sortedMembers.length) {
    return (
      <PullToRefreshWrapper onRefresh={handleRefresh}>
        <div className="card">
          <EmptyState />
        </div>
      </PullToRefreshWrapper>
    );
  }

  return (
    <PullToRefreshWrapper onRefresh={handleRefresh}>
      <div className="space-y-4">
        {/* Season indicator */}
        <div className="flex items-center justify-between">
          <div className="text-sm text-gray-500 dark:text-gray-400">
            Seizoen: <span className="font-medium text-gray-900 dark:text-gray-100">{data?.season}</span>
            <span className="ml-4">{sortedMembers.length} leden</span>
          </div>
          <div className="text-sm text-gray-500 dark:text-gray-400">
            Totaal: <span className="font-medium text-gray-900 dark:text-gray-100">{formatCurrency(totals.finalFee)}</span>
          </div>
        </div>

        {/* Fee list table */}
        <div className="card overflow-x-auto">
          <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead className="bg-gray-50 dark:bg-gray-800">
              <tr>
                <SortableHeader
                  label="Naam"
                  columnId="name"
                  sortField={sortField}
                  sortOrder={sortOrder}
                  onSort={handleSort}
                />
                <SortableHeader
                  label="Categorie"
                  columnId="category"
                  sortField={sortField}
                  sortOrder={sortOrder}
                  onSort={handleSort}
                />
                <th
                  scope="col"
                  className="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider bg-gray-50 dark:bg-gray-800"
                >
                  Leeftijdsgroep
                </th>
                <SortableHeader
                  label="Basis"
                  columnId="base_fee"
                  sortField={sortField}
                  sortOrder={sortOrder}
                  onSort={handleSort}
                  className="text-right"
                />
                <th
                  scope="col"
                  className="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider bg-gray-50 dark:bg-gray-800"
                >
                  Gezin
                </th>
                <th
                  scope="col"
                  className="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider bg-gray-50 dark:bg-gray-800"
                >
                  Pro-rata
                </th>
                <SortableHeader
                  label="Bedrag"
                  columnId="final_fee"
                  sortField={sortField}
                  sortOrder={sortOrder}
                  onSort={handleSort}
                  className="text-right"
                />
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
              {sortedMembers.map((member, index) => (
                <FeeRow
                  key={member.id}
                  member={member}
                  isOdd={index % 2 === 1}
                />
              ))}
            </tbody>
            <tfoot className="bg-gray-50 dark:bg-gray-800">
              <tr>
                <td colSpan="3" className="px-4 py-3 text-sm font-medium text-gray-900 dark:text-gray-100">
                  Totaal
                </td>
                <td className="px-4 py-3 text-sm text-gray-500 dark:text-gray-400 text-right">
                  {formatCurrency(totals.baseFee)}
                </td>
                <td colSpan="2"></td>
                <td className="px-4 py-3 text-sm font-bold text-gray-900 dark:text-gray-100 text-right">
                  {formatCurrency(totals.finalFee)}
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </PullToRefreshWrapper>
  );
}
```
  </action>
  <verify>
Run `npm run lint` to check for errors. Visual check that page renders correctly.
  </verify>
  <done>ContributieList page displays fee data with sorting, totals, and proper styling.</done>
</task>

<task type="auto">
  <name>Task 5: Build, deploy, and verify</name>
  <files></files>
  <action>
1. Run `npm run lint` to check for errors
2. Run `npm run build` to create production assets
3. Run `bin/deploy.sh` to deploy to production
4. Verify:
   - Sidebar shows Contributie between Leden and VOG
   - Clicking Contributie loads the list page
   - Table shows columns: Name, Category, Leeftijdsgroep, Basis, Gezin, Pro-rata, Bedrag
   - Totals row shows correct sums
   - Clicking a name navigates to person detail
  </action>
  <verify>
Visual verification on production at /contributie URL.
  </verify>
  <done>Contributie list page deployed and working with all columns, sorting, and navigation.</done>
</task>

</tasks>

<verification>
1. REST endpoint /rondo/v1/fees returns correct data structure
2. Sidebar shows "Contributie" between "Leden" and "VOG" with Coins icon
3. Route /contributie loads without error
4. Table displays 7 columns: Name, Category, Leeftijdsgroep, Basis, Gezin, Pro-rata, Bedrag
5. Sorting works on Name, Category, Basis, Bedrag columns
6. Members with pro-rata < 100% have amber row highlight
7. Members with family discount show green percentage
8. Footer shows totals
9. Clicking member name navigates to /people/:id
</verification>

<success_criteria>
- Contributie appears in sidebar in correct position (below Leden, above VOG)
- REST endpoint returns calculated fees for all members
- List page shows all fee breakdown columns
- Pro-rata highlighted rows are visible
- Total amounts calculated correctly
- Navigation to person detail works
</success_criteria>

<output>
After completion, create `.planning/phases/126-pro-rata-ui/126-02-SUMMARY.md`
</output>
