---
phase: 34-cross-person-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/pages/People/PersonDetail.jsx]
autonomous: true
---

<objective>
Enhance cross-person todo display on PersonDetail page to match TodosList visual parity.

Purpose: When viewing a person's todos sidebar, shared todos should display the other linked people with stacked avatars and links, matching the TodosList component's visual treatment.

Output: PersonDetail todos sidebar shows stacked avatars of linked people (like TodosList does) instead of plain "Shared with N others" text.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-todo-modal-ui/33-01-SUMMARY.md

@src/pages/People/PersonDetail.jsx
@src/pages/Todos/TodosList.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add stacked avatars to PersonDetail todos sidebar</name>
  <files>src/pages/People/PersonDetail.jsx</files>
  <action>
Replace the plain text "Shared with N others" indicator with stacked avatars matching TodosList's visual pattern.

In the desktop sidebar todo rendering (around line 2145-2149) and mobile panel todo rendering (around line 2298-2300):

1. Replace this pattern:
   ```jsx
   {todo.persons && todo.persons.length > 1 && (
     <p className="text-xs text-gray-500 mt-0.5">
       Shared with {todo.persons.length - 1} {todo.persons.length - 1 === 1 ? 'other' : 'others'}
     </p>
   )}
   ```

2. With stacked avatars showing OTHER persons (excluding current person being viewed):
   ```jsx
   {todo.persons && todo.persons.length > 1 && (() => {
     // Get other persons (exclude the current person we're viewing)
     const currentPersonId = parseInt(id, 10);
     const otherPersons = todo.persons.filter(p => p.id !== currentPersonId);
     if (otherPersons.length === 0) return null;

     return (
       <div className="flex items-center gap-1 mt-1">
         <span className="text-xs text-gray-500">Also:</span>
         <div className="flex -space-x-1.5" title={otherPersons.map(p => p.name).join(', ')}>
           {otherPersons.slice(0, 2).map((person, idx) => (
             <Link
               key={person.id}
               to={`/people/${person.id}`}
               className="relative hover:z-10"
               style={{ zIndex: 2 - idx }}
               onClick={(e) => e.stopPropagation()}
             >
               {person.thumbnail ? (
                 <img
                   src={person.thumbnail}
                   alt={person.name}
                   className="w-5 h-5 rounded-full object-cover border border-white"
                 />
               ) : (
                 <div className="w-5 h-5 bg-gray-200 rounded-full flex items-center justify-center border border-white">
                   <User className="w-2.5 h-2.5 text-gray-500" />
                 </div>
               )}
             </Link>
           ))}
           {otherPersons.length > 2 && (
             <span className="w-5 h-5 rounded-full bg-gray-200 text-[10px] flex items-center justify-center border border-white text-gray-600">
               +{otherPersons.length - 2}
             </span>
           )}
         </div>
       </div>
     );
   })()}
   ```

Key differences from TodosList:
- Smaller size (w-5 h-5 vs w-6 h-6) to fit compact sidebar
- Only shows OTHER people (filters out current person being viewed)
- Uses "Also:" prefix to clarify these are additional linked people
- Shows max 2 avatars (vs 3 in TodosList) due to space constraints
- Includes e.stopPropagation() on links since todo rows may be clickable

Note: Apply the same change to BOTH the desktop sidebar section AND the mobile panel section (both render the same todo list differently).
  </action>
  <verify>npm run build succeeds</verify>
  <done>PersonDetail todos sidebar shows stacked avatars for other linked people instead of plain text, both on desktop and mobile views</done>
</task>

<task type="auto">
  <name>Task 2: Add thumbnail to timeline todo response</name>
  <files>includes/class-comment-types.php</files>
  <action>
The timeline endpoint (get_timeline method) returns persons array but without thumbnail URLs. Update the persons array building to include thumbnails so the frontend can display avatars.

In the get_timeline method (around line 483-489), change:
```php
$persons[] = [
    'id'   => (int) $pid,
    'name' => get_the_title($pid),
];
```

To:
```php
$persons[] = [
    'id'        => (int) $pid,
    'name'      => get_the_title($pid),
    'thumbnail' => get_the_post_thumbnail_url($pid, 'thumbnail') ?: null,
];
```

This matches the format returned by PRM_REST_Todos::format_todo() which already includes thumbnail.
  </action>
  <verify>curl http://localhost/wp-json/prm/v1/people/{id}/timeline returns todos with persons[].thumbnail field</verify>
  <done>Timeline endpoint returns thumbnail URLs in persons array for proper avatar display</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] PersonDetail sidebar shows stacked avatars for shared todos (desktop)
- [ ] PersonDetail mobile panel shows stacked avatars for shared todos
- [ ] Clicking avatar links to other person's profile
- [ ] Current person is excluded from the "Also:" avatars (only shows OTHER people)
- [ ] Timeline API returns thumbnail in persons array
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Visual parity between PersonDetail and TodosList for multi-person display
</success_criteria>

<output>
After completion, create `.planning/phases/34-cross-person-display/34-01-SUMMARY.md`
</output>
