---
phase: 07-data-model-visibility
plan: 02
type: execute
depends_on: ["07-01"]
files_modified: [acf-json/group_visibility_settings.json, includes/class-visibility.php, functions.php]
---

<objective>
Add visibility and sharing post meta fields to Person/Team/Important Date.

Purpose: Enable contacts to be marked as private, workspace-visible, or shared with specific users.
Output: ACF field group for visibility, helper class for reading/writing visibility meta.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@Stadion-Multi-User-Project-Plan.md (sections 1.1, 1.5)
@includes/class-post-types.php (for controlled_post_types pattern)
@.planning/phases/07-data-model-visibility/07-01-SUMMARY.md

**Design decisions:**
- _visibility meta: 'private' (default), 'workspace', 'shared'
- _shared_with meta: JSON array of {user_id, permission, shared_by, shared_at}
- Use ACF for _visibility (admin UI), but _shared_with is managed programmatically
- Default visibility for all existing posts = 'private' (preserves current behavior)

**Why ACF for _visibility:**
- Gives admin UI for visibility changes
- Follows existing pattern (all contact fields use ACF)
- Can be exposed in REST API via ACF's built-in support
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create visibility ACF field group</name>
  <files>acf-json/group_visibility_settings.json</files>
  <action>
Create ACF field group JSON file with:
- Group key: group_visibility_settings
- Title: "Visibility Settings"
- Location: post_type == person OR post_type == team OR post_type == important_date
- Position: side
- Menu order: 100 (after main content)

Fields:
1. visibility (field_visibility)
   - Type: select
   - Label: "Visibility"
   - Name: _visibility
   - Choices: private|Private (only you), workspace|Workspace, shared|Shared with specific users
   - Default: private
   - Required: yes
   - Instructions: "Control who can see this contact"

Note: _shared_with is managed via API, not ACF field (complex nested structure).

Set show_in_rest: true on the field for REST API access.
  </action>
  <verify>ACF admin shows "Visibility Settings" field group with visibility select field</verify>
  <done>ACF field group appears in WordPress admin, visibility field visible on Person/Team edit screens</done>
</task>

<task type="auto">
  <name>Task 2: Create STADION_Visibility helper class</name>
  <files>includes/class-visibility.php, functions.php</files>
  <action>
Create new class-visibility.php with static helper methods:

```php
class STADION_Visibility {
    const PRIVATE = 'private';
    const WORKSPACE = 'workspace';
    const SHARED = 'shared';

    // Get visibility for a post (returns 'private' if not set)
    public static function get_visibility($post_id) {}

    // Set visibility for a post
    public static function set_visibility($post_id, $visibility) {}

    // Get shared_with array for a post (returns empty array if not set)
    public static function get_shares($post_id) {}

    // Add a user share (adds to _shared_with array)
    public static function add_share($post_id, $user_id, $permission = 'view', $shared_by = null) {}

    // Remove a user share
    public static function remove_share($post_id, $user_id) {}

    // Check if user has share access
    public static function user_has_share($post_id, $user_id) {}

    // Get share permission for user ('view', 'edit', or false)
    public static function get_share_permission($post_id, $user_id) {}
}
```

_shared_with structure in post meta:
```json
[
  {"user_id": 5, "permission": "edit", "shared_by": 1, "shared_at": "2026-01-15T10:30:00Z"},
  {"user_id": 8, "permission": "view", "shared_by": 1, "shared_at": "2026-01-16T14:00:00Z"}
]
```

Use get_post_meta/update_post_meta. Store as serialized array (WordPress handles JSON).

Load class in functions.php in stadion_init() function, after class-access-control.php.
  </action>
  <verify>Create test script that calls STADION_Visibility::set_visibility() and STADION_Visibility::add_share() then reads them back</verify>
  <done>Class loads without errors, visibility/share helpers work correctly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ACF field group syncs (visible in ACF admin)
- [ ] Visibility field appears on Person edit screen in admin
- [ ] Visibility field appears on Team edit screen in admin
- [ ] STADION_Visibility class loads without fatal errors
- [ ] `npm run build` succeeds
- [ ] No PHP errors in debug log
</verification>

<success_criteria>
- ACF visibility field registered for all controlled post types
- STADION_Visibility helper class provides clean API for visibility/share operations
- Default visibility is 'private' (existing behavior preserved)
- No changes to frontend yet (Phase 9)
</success_criteria>

<output>
After completion, create `.planning/phases/07-data-model-visibility/07-02-SUMMARY.md`
</output>
