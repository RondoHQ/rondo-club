---
phase: 07-data-model-visibility
plan: 03
type: execute
depends_on: ["07-01"]
files_modified: [includes/class-workspace-members.php, functions.php]
---

<objective>
Create workspace membership system using user meta.

Purpose: Enable users to belong to multiple workspaces with different roles.
Output: PRM_Workspace_Members class with methods for managing membership data in user meta.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@Caelis-Multi-User-Project-Plan.md (sections 1.3, 2.3)
@.planning/phases/07-data-model-visibility/07-01-SUMMARY.md

**Design decisions:**
- Store in user meta key: _workspace_memberships
- Roles: 'admin' (full control), 'member' (add/edit), 'viewer' (read-only)
- Structure: array of {workspace_id, role, joined_at}
- Owner (workspace post_author) is implicitly admin but also stored in memberships for query simplicity

**Why user meta:**
- Easy to query "which workspaces am I in?" (single user meta lookup)
- Survives workspace queries (no joins needed)
- Follows WordPress patterns
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PRM_Workspace_Members class</name>
  <files>includes/class-workspace-members.php, functions.php</files>
  <action>
Create new class-workspace-members.php with static methods:

```php
class PRM_Workspace_Members {
    const ROLE_ADMIN = 'admin';
    const ROLE_MEMBER = 'member';
    const ROLE_VIEWER = 'viewer';

    const META_KEY = '_workspace_memberships';

    /**
     * Add user to workspace
     * @param int $workspace_id
     * @param int $user_id
     * @param string $role (admin|member|viewer)
     * @return bool
     */
    public static function add($workspace_id, $user_id, $role = self::ROLE_MEMBER) {}

    /**
     * Remove user from workspace
     * @return bool
     */
    public static function remove($workspace_id, $user_id) {}

    /**
     * Update user's role in workspace
     * @return bool
     */
    public static function update_role($workspace_id, $user_id, $new_role) {}

    /**
     * Get all members of a workspace
     * @return array [{user_id, role, joined_at}, ...]
     */
    public static function get_members($workspace_id) {}

    /**
     * Get all workspaces a user belongs to
     * @return array [{workspace_id, role, joined_at}, ...]
     */
    public static function get_user_workspaces($user_id) {}

    /**
     * Get user's role in a workspace (or false if not member)
     * @return string|false
     */
    public static function get_user_role($workspace_id, $user_id) {}

    /**
     * Check if user is member of workspace (any role)
     * @return bool
     */
    public static function is_member($workspace_id, $user_id) {}

    /**
     * Get workspace IDs for a user (for query optimization)
     * @return array [workspace_id, ...]
     */
    public static function get_user_workspace_ids($user_id) {}
}
```

User meta structure (_workspace_memberships):
```json
[
  {"workspace_id": 123, "role": "admin", "joined_at": "2026-01-15T10:00:00Z"},
  {"workspace_id": 456, "role": "member", "joined_at": "2026-01-20T14:30:00Z"}
]
```

Important:
- Use get_user_meta/update_user_meta with true for single value
- Store as serialized array
- Validate role against constants
- Validate workspace_id is valid workspace post

Load class in functions.php in prm_init() function.
  </action>
  <verify>Create test script that adds user to workspace, retrieves memberships, updates role, removes user</verify>
  <done>Class loads, all methods work correctly, data persists in user meta</done>
</task>

<task type="auto">
  <name>Task 2: Add workspace owner auto-membership hook</name>
  <files>includes/class-workspace-members.php</files>
  <action>
Add constructor and hook to automatically add workspace creator as admin:

```php
public function __construct() {
    add_action('save_post_workspace', [$this, 'add_owner_as_admin'], 10, 3);
}

/**
 * When workspace is created, add author as admin member
 */
public function add_owner_as_admin($post_id, $post, $update) {
    // Only on create (not update)
    if ($update) {
        return;
    }

    // Add author as admin
    self::add($post_id, $post->post_author, self::ROLE_ADMIN);
}
```

Also add hook to prevent owner from being removed:

```php
// In remove() method:
// Don't allow removing the workspace owner
$workspace = get_post($workspace_id);
if ($workspace && (int) $workspace->post_author === (int) $user_id) {
    return false; // Owner cannot be removed
}
```

Update functions.php to instantiate class (not just load it) since it has hooks.
  </action>
  <verify>Create workspace via admin, check that creator is automatically added to _workspace_memberships with admin role</verify>
  <done>Workspace creators are auto-added as admins, owner removal is prevented</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] PRM_Workspace_Members class loads without errors
- [ ] Creating workspace adds owner as admin member
- [ ] get_user_workspaces() returns correct data
- [ ] get_members() returns correct data
- [ ] Owner cannot be removed from workspace
- [ ] `npm run build` succeeds
- [ ] No PHP errors in debug log
</verification>

<success_criteria>
- Workspace membership management works via user meta
- Workspace owner automatically becomes admin
- All CRUD operations for membership work correctly
- Query helper methods ready for Access Control phase
</success_criteria>

<output>
After completion, create `.planning/phases/07-data-model-visibility/07-03-SUMMARY.md`
</output>
