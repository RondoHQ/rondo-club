---
phase: 26-pending-response-model
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - acf-json/group_todo_fields.json
  - includes/class-rest-todos.php
  - tests/Wpunit/TodoCptTest.php
autonomous: true
---

<objective>
Add "awaiting response" status to todos with timestamp tracking.

Purpose: Enable users to mark todos as waiting for a response from the linked contact, with automatic timestamp tracking for aging visibility.
Output: Updated todo CPT with awaiting_response fields, REST API support, and test coverage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 25 established timeline integration - this phase adds pending response fields
@.planning/phases/25-todo-ui-migration/25-01-SUMMARY.md

# Existing todo implementation to extend
@acf-json/group_todo_fields.json
@includes/class-rest-todos.php

# Test patterns to follow
@tests/Wpunit/TodoCptTest.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ACF fields for pending response tracking</name>
  <files>acf-json/group_todo_fields.json</files>
  <action>
Add two new fields to the Todo Fields group:

1. `awaiting_response` (true_false):
   - key: field_todo_awaiting_response
   - label: "Awaiting Response"
   - name: awaiting_response
   - default_value: 0
   - ui: 1
   - ui_on_text: "Yes"
   - ui_off_text: "No"

2. `awaiting_response_since` (date_time_picker):
   - key: field_todo_awaiting_response_since
   - label: "Awaiting Since"
   - name: awaiting_response_since
   - display_format: "F j, Y g:i a"
   - return_format: "Y-m-d H:i:s"
   - conditional_logic: show only when awaiting_response is true

Insert these after the `is_completed` field and before the `due_date` field.
  </action>
  <verify>Check that acf-json/group_todo_fields.json is valid JSON with the new fields</verify>
  <done>Two new ACF fields added: awaiting_response (bool) and awaiting_response_since (datetime)</done>
</task>

<task type="auto">
  <name>Task 2: Update REST API to handle pending response fields</name>
  <files>includes/class-rest-todos.php</files>
  <action>
Update the REST API to support pending response functionality:

1. In `format_todo()`:
   - Add `awaiting_response` (bool) from get_field()
   - Add `awaiting_response_since` (string or null) from get_field()

2. In `create_person_todo()`:
   - Accept `awaiting_response` parameter
   - If true, set `awaiting_response_since` to current datetime (gmdate('Y-m-d H:i:s'))
   - If false or not provided, leave both fields empty

3. In `update_todo()`:
   - Accept `awaiting_response` parameter
   - If changing from false to true: set `awaiting_response_since` to current datetime
   - If changing from true to false: clear `awaiting_response_since` to empty string
   - If no change, leave as-is

The auto-timestamp logic ensures awaiting_response_since is always accurate - users don't manually set it.
  </action>
  <verify>curl -X GET localhost/wp-json/rondo/v1/todos shows awaiting_response and awaiting_response_since fields in response</verify>
  <done>REST API returns and accepts awaiting_response fields with auto-timestamp on state changes</done>
</task>

<task type="auto">
  <name>Task 3: Add PHPUnit tests for pending response functionality</name>
  <files>tests/Wpunit/TodoCptTest.php</files>
  <action>
Add test methods to TodoCptTest.php:

1. `test_create_todo_with_awaiting_response_sets_timestamp`:
   - Create todo with awaiting_response: true
   - Assert awaiting_response is true in response
   - Assert awaiting_response_since is not null and is a valid datetime

2. `test_update_todo_sets_awaiting_response_timestamp`:
   - Create todo without awaiting_response
   - Update todo with awaiting_response: true
   - Assert awaiting_response_since is set to current time (within 5 seconds tolerance)

3. `test_update_todo_clears_awaiting_response_timestamp`:
   - Create todo with awaiting_response: true
   - Update todo with awaiting_response: false
   - Assert awaiting_response is false
   - Assert awaiting_response_since is null or empty

4. `test_format_todo_includes_awaiting_response_fields`:
   - Create todo
   - GET /rondo/v1/todos/{id}
   - Assert response has awaiting_response key
   - Assert response has awaiting_response_since key

Run: `./vendor/bin/codecept run Wpunit TodoCptTest`
Ensure all existing tests still pass.
  </action>
  <verify>./vendor/bin/codecept run Wpunit TodoCptTest passes all tests including new ones</verify>
  <done>4 new tests added and passing, no regressions in existing tests</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./vendor/bin/codecept run Wpunit TodoCptTest` passes all tests
- [ ] `./vendor/bin/codecept run Wpunit` passes all tests (no regressions)
- [ ] ACF JSON is valid (no syntax errors)
- [ ] REST API response includes awaiting_response and awaiting_response_since fields
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Todos can be marked as awaiting response with automatic timestamp
- Timestamp auto-clears when awaiting_response is set to false
- 4 new tests added to TodoCptTest.php
</success_criteria>

<output>
After completion, create `.planning/phases/26-pending-response-model/26-01-SUMMARY.md`
</output>
