---
phase: 18-organizations-bulk-actions
plan: 01
type: execute
depends_on: []
files_modified:
  - includes/class-rest-companies.php
  - src/api/client.js
  - src/hooks/useCompanies.js
  - src/pages/Companies/CompaniesList.jsx
---

<objective>
Add bulk actions (visibility, workspace, labels) to Organizations list view.

Purpose: Enable efficient batch management of organizations, matching the bulk action capabilities available for People.
Output: Organizations list view with Actions dropdown providing bulk visibility, workspace assignment, and label management.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase establishing patterns:
@.planning/phases/13-bulk-actions/13-01-SUMMARY.md
@.planning/phases/15-extended-bulk-actions/15-02-SUMMARY.md
@.planning/phases/17-organizations-list-view/17-01-SUMMARY.md

# Key source files to reference:
@includes/class-rest-people.php (bulk-update endpoint pattern at line 102-197, callback at 682-790)
@src/hooks/usePeople.js (useBulkUpdatePeople hook pattern)
@src/pages/People/PeopleList.jsx (BulkVisibilityModal, BulkWorkspaceModal, BulkLabelsModal patterns)
@includes/class-rest-companies.php (add bulk endpoint here)
@src/pages/Companies/CompaniesList.jsx (add modals and Actions dropdown here)

**Tech stack available:**
- Bulk REST endpoint pattern with per-item permission validation
- STADION_Visibility helper for visibility updates
- Workspace post ID to term ID conversion pattern
- TanStack Query mutation with query invalidation

**Established patterns:**
- Bulk update endpoints return success/failure per item
- Permission check validates ownership of ALL posts before updates
- Inline modal components in list pages
- Mode toggle pattern for add/remove label operations

**Constraining decisions:**
- Phase 13: Bulk endpoints validate ownership atomically before any updates
- Phase 15: Labels modal uses mode toggle (add/remove) rather than separate modals
- Phase 17: Selection infrastructure ready in CompaniesList with selectedIds Set
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bulk-update REST endpoint for companies</name>
  <files>includes/class-rest-companies.php</files>
  <action>
Add bulk update endpoint to STADION_REST_Companies class, following the pattern from class-rest-people.php:

1. In register_routes(), add route registration for POST `/stadion/v1/companies/bulk-update`:
   - Permission callback: check_bulk_update_permission
   - Args: ids (required array), updates (required object with visibility, assigned_workspaces, labels_add, labels_remove)

2. Add check_bulk_update_permission() method:
   - Verify user is logged in
   - Loop through all IDs, verify each post exists and is type 'company'
   - Verify current user is post author OR administrator
   - Return WP_Error for invalid/forbidden IDs, true on success

3. Add bulk_update_companies() callback method:
   - Process each post ID in try/catch
   - If visibility provided: use STADION_Visibility::set_visibility()
   - If assigned_workspaces provided: convert post IDs to term IDs using 'workspace-' slug pattern, call wp_set_object_terms() and update_field('_assigned_workspaces')
   - If labels_add provided: wp_set_object_terms($post_id, $term_ids, 'company_label', true) (append mode)
   - If labels_remove provided: wp_remove_object_terms($post_id, $term_ids, 'company_label')
   - Return response with success boolean, updated array, failed array

Note: Companies do NOT have organization_id update (unlike People) - they ARE organizations. Only visibility, workspaces, and labels.
  </action>
  <verify>
curl -X POST "http://localhost/wp-json/stadion/v1/companies/bulk-update" \
  -H "X-WP-Nonce: {nonce}" \
  -H "Content-Type: application/json" \
  -d '{"ids":[123],"updates":{"visibility":"workspace"}}' \
  returns 200 with success:true (or 401/403 for auth issues)
  </verify>
  <done>Endpoint registered, permission check validates ownership, callback updates visibility/workspaces/labels</done>
</task>

<task type="auto">
  <name>Task 2: Add bulk update API method and React hook</name>
  <files>src/api/client.js, src/hooks/useCompanies.js</files>
  <action>
1. In src/api/client.js, add bulkUpdateCompanies method after the existing company methods (around line 55):
   ```javascript
   bulkUpdateCompanies: (ids, updates) => api.post('/stadion/v1/companies/bulk-update', { ids, updates }),
   ```

2. In src/hooks/useCompanies.js, add useBulkUpdateCompanies hook following useBulkUpdatePeople pattern:
   ```javascript
   export function useBulkUpdateCompanies() {
     const queryClient = useQueryClient();

     return useMutation({
       mutationFn: async ({ ids, updates }) => {
         const response = await wpApi.bulkUpdateCompanies(ids, updates);
         return response.data;
       },
       onSuccess: () => {
         queryClient.invalidateQueries({ queryKey: ['companies'] });
       },
     });
   }
   ```
  </action>
  <verify>Import useBulkUpdateCompanies in a component and verify no TypeScript/lint errors</verify>
  <done>API method added, hook exported, query invalidation configured</done>
</task>

<task type="auto">
  <name>Task 3: Add bulk action modals and Actions dropdown to CompaniesList</name>
  <files>src/pages/Companies/CompaniesList.jsx</files>
  <action>
Add bulk actions UI to CompaniesList, following PeopleList patterns:

1. Add imports at top:
   - Import { Lock, Users, Check, Tag, MoreHorizontal } from 'lucide-react'
   - Import { useBulkUpdateCompanies } from '@/hooks/useCompanies'
   - Import useLabels hook or inline query for company_label taxonomy

2. Copy and adapt modal components from PeopleList (place before CompaniesList function):
   - BulkVisibilityModal: Change text from "person/people" to "organization/organizations"
   - BulkWorkspaceModal: Change text from "person/people" to "organization/organizations"
   - BulkLabelsModal: Change text, use company_label instead of person_label

3. In CompaniesList component, add state variables:
   - const [showBulkVisibilityModal, setShowBulkVisibilityModal] = useState(false)
   - const [showBulkWorkspaceModal, setShowBulkWorkspaceModal] = useState(false)
   - const [showBulkLabelsModal, setShowBulkLabelsModal] = useState(false)
   - const [showActionsMenu, setShowActionsMenu] = useState(false)
   - const actionsRef = useRef(null)

4. Add mutation hook: const bulkUpdateMutation = useBulkUpdateCompanies()

5. Add click-outside handler for Actions dropdown (copy pattern from filter dropdown)

6. Update selection toolbar (currently shows count + clear):
   - Add "Actions" dropdown button with MoreHorizontal icon
   - Dropdown items: "Change visibility...", "Assign workspace...", "Manage labels..."
   - Each item opens corresponding modal

7. Add submit handlers (following PeopleList patterns):
   - handleBulkVisibilitySubmit: calls bulkUpdateMutation.mutateAsync with visibility update
   - handleBulkWorkspaceSubmit: calls bulkUpdateMutation.mutateAsync with assigned_workspaces
   - handleBulkLabelsSubmit: calls bulkUpdateMutation.mutateAsync with labels_add or labels_remove based on mode
   - All handlers clear selection after success

8. Render modals at bottom of component (before closing </div>):
   - BulkVisibilityModal with isOpen, onClose, selectedCount, onSubmit, isLoading props
   - BulkWorkspaceModal with workspaces prop
   - BulkLabelsModal with labels prop (company labels)

9. Version bump: Update package.json and style.css to 1.70.0, add CHANGELOG entry
  </action>
  <verify>
1. npm run build succeeds
2. Navigate to Organizations page
3. Select multiple organizations using checkboxes
4. Selection toolbar shows count, clear button, and Actions dropdown
5. Actions dropdown opens with three options
6. Each modal opens, shows correct organization count, and submits successfully
  </verify>
  <done>Actions dropdown appears when organizations selected, all three bulk modals work correctly, selection clears after action</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes with no warnings
- [ ] Bulk visibility change works: select orgs → Actions → Change visibility → Apply
- [ ] Bulk workspace assignment works: select orgs → Actions → Assign workspace → Apply
- [ ] Bulk label add works: select orgs → Actions → Manage labels → Add mode → Apply
- [ ] Bulk label remove works: select orgs → Actions → Manage labels → Remove mode → Apply
- [ ] Selection clears after each bulk action
- [ ] Version is 1.70.0 in package.json and style.css
- [ ] CHANGELOG.md has v1.70.0 entry
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript or linting errors
- Organizations list view has full bulk action parity with People list view
- Phase 18 complete, milestone v2.3 complete
</success_criteria>

<output>
After completion, create `.planning/phases/18-organizations-bulk-actions/18-01-SUMMARY.md`:

# Phase 18 Plan 01: Organizations Bulk Actions Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `includes/class-rest-companies.php` - Added bulk-update endpoint
- `src/api/client.js` - Added bulkUpdateCompanies method
- `src/hooks/useCompanies.js` - Added useBulkUpdateCompanies hook
- `src/pages/Companies/CompaniesList.jsx` - Added bulk modals and Actions dropdown

## Decisions Made

[Any decisions made during implementation]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 18 complete. Milestone v2.3 List View Unification complete.
- ISS-008 resolved (Organizations list interface)
- Full bulk action parity between People and Organizations
</output>
