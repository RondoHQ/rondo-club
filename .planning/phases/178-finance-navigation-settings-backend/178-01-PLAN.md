---
phase: 178-finance-navigation-settings-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/layout/Layout.jsx
  - src/router.jsx
  - includes/class-finance-config.php
  - includes/class-rest-api.php
  - functions.php
  - src/api/client.js
autonomous: true

must_haves:
  truths:
    - "Financien section appears in sidebar with Contributie, Facturen (disabled), and Instellingen sub-items"
    - "Contributie page is accessible at /financien/contributie"
    - "Old /contributie route redirects to /financien/contributie"
    - "Finance settings REST API returns and accepts settings data"
    - "Rabobank API credentials are encrypted at rest using sodium"
  artifacts:
    - path: "src/components/layout/Layout.jsx"
      provides: "Financien section in sidebar navigation with collapsible sub-items"
      contains: "Financien"
    - path: "includes/class-finance-config.php"
      provides: "FinanceConfig class storing all finance settings via WP Options API"
      exports: ["get_all_settings", "update_settings"]
    - path: "includes/class-rest-api.php"
      provides: "GET/POST /rondo/v1/finance/settings endpoints"
      contains: "finance/settings"
    - path: "src/api/client.js"
      provides: "getFinanceSettings and updateFinanceSettings API methods"
      contains: "finance/settings"
    - path: "src/router.jsx"
      provides: "Routes for /financien/contributie and /financien/instellingen"
      contains: "financien"
  key_links:
    - from: "includes/class-rest-api.php"
      to: "includes/class-finance-config.php"
      via: "new FinanceConfig() in endpoint callbacks"
      pattern: "FinanceConfig"
    - from: "includes/class-finance-config.php"
      to: "includes/class-credential-encryption.php"
      via: "CredentialEncryption::encrypt for Rabobank credentials"
      pattern: "CredentialEncryption"
    - from: "src/api/client.js"
      to: "/rondo/v1/finance/settings"
      via: "axios GET/POST calls"
      pattern: "finance/settings"
---

<objective>
Restructure sidebar navigation to include a Financien section with sub-items, move Contributie under it, and create the backend PHP class + REST API endpoints for finance settings storage.

Purpose: Establishes the navigation structure and data layer that the finance settings UI (Plan 02) will consume. All settings are stored via WordPress Options API with sodium encryption for sensitive credentials.
Output: Working navigation with Financien section, backend FinanceConfig class, REST endpoints at /rondo/v1/finance/settings
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/layout/Layout.jsx
@src/router.jsx
@includes/class-club-config.php
@includes/class-credential-encryption.php
@includes/class-rest-api.php
@functions.php
@src/api/client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure sidebar navigation with Financien section</name>
  <files>src/components/layout/Layout.jsx, src/router.jsx</files>
  <action>
**Layout.jsx changes:**

1. Add `Wallet` (or `Banknote`) and `Receipt` icons from lucide-react imports (for Financien section and Facturen).

2. Replace the current flat navigation array with a structure that supports sections. The Financien section should be a collapsible group (like the existing indent pattern but as an explicit section header). Implementation approach:

   Replace the current `navigation` array. The Financien section needs:
   - A section header "Financien" with a `Wallet` icon (not a link, just a visual group header) that is always expanded (no collapse toggle needed -- keep it simple like the current indent pattern)
   - Sub-items indented under it:
     - "Contributie" at `/financien/contributie` with `Coins` icon, `requiresFinancieel: true`
     - "Facturen" at `/financien/facturen` with `Receipt` icon, `requiresFinancieel: true`, `disabled: true` (grayed out, not clickable -- will be enabled in phase 184)
     - "Instellingen" at `/financien/instellingen` with `Settings` icon, `requiresFinancieel: true`, `adminOnly: true`

   The simplest approach: keep the flat array but add a `section` type entry. Navigation items get a new optional `type: 'section'` field for section headers. Section headers render as non-clickable styled text (not NavLink). Items with `disabled: true` render grayed out and not clickable.

   Remove the old Contributie entry (`{ name: 'Contributie', href: '/contributie', icon: Coins, indent: true, requiresFinancieel: true }`).

   Updated navigation array should be:
   ```js
   const navigation = [
     { name: 'Dashboard', href: '/', icon: Home },
     { name: 'Leden', href: '/people', icon: Users },
     { name: 'VOG', href: '/vog', icon: FileCheck, indent: true, requiresVOG: true },
     { name: 'Tuchtzaken', href: '/tuchtzaken', icon: Gavel, indent: true, requiresFairplay: true },
     { name: 'Teams', href: '/teams', icon: Building2 },
     { name: 'Commissies', href: '/commissies', icon: UsersRound },
     { name: 'Financien', type: 'section', icon: Wallet, requiresFinancieel: true },
     { name: 'Contributie', href: '/financien/contributie', icon: Coins, indent: true, requiresFinancieel: true },
     { name: 'Facturen', href: '/financien/facturen', icon: Receipt, indent: true, requiresFinancieel: true, disabled: true },
     { name: 'Instellingen', href: '/financien/instellingen', icon: Settings, indent: true, requiresFinancieel: true, adminOnly: true },
     { name: 'Taken', href: '/todos', icon: CheckSquare },
     { name: 'Feedback', href: '/feedback', icon: MessageSquare },
     { name: 'Instellingen', href: '/settings', icon: Settings },
   ];
   ```

   Note: There are now two "Instellingen" items -- the finance one and the general settings one. The finance one is nested under Financien. To avoid key conflicts, use a unique key like `item.href || item.name` in the `.map()`.

3. Update the `.filter()` logic to also handle `adminOnly` on nav items: `if (item.adminOnly && !isAdmin) return false;`

4. Update the `.map()` rendering to handle `type: 'section'` items (render as non-clickable section label) and `disabled: true` items (render grayed out, cursor-default, no NavLink). Section headers should render as:
   ```jsx
   <div className="flex items-center px-3 pt-4 pb-1 text-xs font-semibold text-gray-400 uppercase tracking-wider dark:text-gray-500">
     <item.icon className="w-4 h-4 mr-2" />
     {item.name}
   </div>
   ```
   Disabled items render like normal NavLinks but with `opacity-50 cursor-default pointer-events-none` classes and no actual navigation.

5. Update the `getPageTitle()` function in Header to handle the new `/financien/*` paths:
   - `/financien/contributie` -> 'Contributie'
   - `/financien/instellingen` -> 'Financien Instellingen'
   - `/financien/facturen` -> 'Facturen'

6. Update the key in the `.map()` from `item.name` to `item.href || item.name` to avoid duplicate key warnings (two "Instellingen" items).

**router.jsx changes:**

1. Add lazy import for FinanceSettings: `const FinanceSettings = lazy(() => import('@/pages/Finance/FinanceSettings'));`

2. Add routes under the protected layout children:
   ```js
   // Finance routes - requires financieel capability
   {
     path: 'financien/contributie',
     element: (
       <FinancieelRoute>
         <Contributie />
       </FinancieelRoute>
     ),
   },
   {
     path: 'financien/contributie/:tab',
     element: (
       <FinancieelRoute>
         <Contributie />
       </FinancieelRoute>
     ),
   },
   {
     path: 'financien/instellingen',
     element: (
       <FinancieelRoute>
         <FinanceSettings />
       </FinancieelRoute>
     ),
   },
   ```

3. Keep the old `/contributie` and `/contributie/:tab` routes but change them to redirect:
   ```js
   { path: 'contributie', element: <Navigate to="/financien/contributie" replace /> },
   { path: 'contributie/:tab', element: <Navigate to="/financien/contributie" replace /> },
   ```
   This ensures any bookmarks or links to the old URL still work.

4. Create an empty placeholder page at `src/pages/Finance/FinanceSettings.jsx`:
   ```jsx
   export default function FinanceSettings() {
     return (
       <div className="space-y-6">
         <p className="text-gray-500 dark:text-gray-400">Financien instellingen worden geladen...</p>
       </div>
     );
   }
   ```
   This placeholder will be replaced with the full implementation in Plan 02.
  </action>
  <verify>
Run `npm run build` from the rondo-club directory -- should compile without errors. Verify the placeholder FinanceSettings page exists at src/pages/Finance/FinanceSettings.jsx.
  </verify>
  <done>
Sidebar shows Financien section with Contributie, Facturen (disabled/grayed), and Instellingen sub-items. Old /contributie URLs redirect to /financien/contributie. /financien/instellingen route loads placeholder page.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FinanceConfig PHP class and REST API endpoints</name>
  <files>includes/class-finance-config.php, includes/class-rest-api.php, functions.php, src/api/client.js</files>
  <action>
**Create includes/class-finance-config.php:**

Follow the pattern of `class-club-config.php` but with finance-specific settings. Namespace: `Rondo\Config`. Class: `FinanceConfig`.

Settings stored as individual WordPress options (consistent with ClubConfig pattern):
- `rondo_finance_org_name` (string) -- Organization name for invoices
- `rondo_finance_org_address` (string, multi-line) -- Organization address
- `rondo_finance_contact_email` (string, email) -- Contact email for invoices
- `rondo_finance_iban` (string) -- Bank account IBAN
- `rondo_finance_payment_term_days` (int, default 14) -- Payment term in days
- `rondo_finance_payment_clause` (string, multi-line) -- Payment clause text shown on invoices
- `rondo_finance_email_template` (string, multi-line) -- Email body template with variable placeholders
- `rondo_finance_rabobank_credentials` (string, encrypted) -- Encrypted JSON containing client_id, client_secret, environment (sandbox/production)

Methods:
- `get_all_settings(): array` -- Returns all settings (Rabobank credentials return `has_credentials: bool` and `environment: string`, NOT the actual secrets)
- `get_setting(string $key): mixed` -- Get individual setting
- `update_settings(array $data): bool` -- Bulk update, handles encryption for Rabobank credentials
- Individual getters/setters following ClubConfig pattern
- `get_rabobank_credentials(): ?array` -- Decrypts and returns credentials (for internal use only, never exposed via REST)
- `update_rabobank_credentials(string $client_id, string $client_secret, string $environment): bool` -- Encrypts and stores

For `update_settings()`: iterate over provided keys, sanitize appropriately:
- Text fields: `sanitize_text_field()`
- Multi-line fields (address, payment_clause, email_template): `sanitize_textarea_field()`
- Email: `sanitize_email()`
- IBAN: `sanitize_text_field()` + uppercase + strip spaces
- Payment term days: `absint()` with minimum 1
- Rabobank credentials: special handling -- if `rabobank_client_id` and `rabobank_client_secret` are provided, encrypt via `CredentialEncryption::encrypt()`. If `rabobank_environment` provided alone, decrypt existing, update environment, re-encrypt.

For the email template, provide a default template in Dutch:
```
Beste {naam},

Bijgevoegd vindt u de factuur {factuur_nummer} voor opgelegde boetes vanuit de tuchtcommissie.

{tuchtzaken_lijst}

Het totaalbedrag is {totaal_bedrag}.

U kunt betalen via de volgende link: {betaallink}

Met vriendelijke groet,
{organisatie_naam}
```

**Update includes/class-rest-api.php:**

Add two REST route registrations in the `register_routes()` method (near the existing `/config` route):

```php
// Finance settings (admin only)
register_rest_route(
    'rondo/v1',
    '/finance/settings',
    [
        [
            'methods'             => \WP_REST_Server::READABLE,
            'callback'            => [ $this, 'get_finance_settings' ],
            'permission_callback' => [ $this, 'check_admin_permission' ],
        ],
        [
            'methods'             => \WP_REST_Server::CREATABLE,
            'callback'            => [ $this, 'update_finance_settings' ],
            'permission_callback' => [ $this, 'check_admin_permission' ],
            'args'                => [
                'org_name'              => [ 'required' => false, 'sanitize_callback' => 'sanitize_text_field' ],
                'org_address'           => [ 'required' => false, 'sanitize_callback' => 'sanitize_textarea_field' ],
                'contact_email'         => [ 'required' => false, 'sanitize_callback' => 'sanitize_email' ],
                'iban'                  => [ 'required' => false, 'sanitize_callback' => 'sanitize_text_field' ],
                'payment_term_days'     => [ 'required' => false, 'type' => 'integer' ],
                'payment_clause'        => [ 'required' => false, 'sanitize_callback' => 'sanitize_textarea_field' ],
                'email_template'        => [ 'required' => false, 'sanitize_callback' => 'sanitize_textarea_field' ],
                'rabobank_client_id'    => [ 'required' => false, 'sanitize_callback' => 'sanitize_text_field' ],
                'rabobank_client_secret' => [ 'required' => false, 'sanitize_callback' => 'sanitize_text_field' ],
                'rabobank_environment'  => [ 'required' => false, 'sanitize_callback' => 'sanitize_text_field' ],
            ],
        ],
    ]
);
```

Add callback methods:

```php
public function get_finance_settings( $request ) {
    $config = new \Rondo\Config\FinanceConfig();
    return rest_ensure_response( $config->get_all_settings() );
}

public function update_finance_settings( $request ) {
    $config = new \Rondo\Config\FinanceConfig();
    $config->update_settings( $request->get_params() );
    return rest_ensure_response( $config->get_all_settings() );
}
```

**Update functions.php:**

Add the `use` import near the other Config imports (line ~70):
```php
use Rondo\Config\FinanceConfig;
```

No class alias needed (new code, no backward compatibility required). The FinanceConfig class is instantiated on-demand in REST callbacks, not in rondo_init(), so no initialization changes needed.

**Update src/api/client.js:**

Add to the `prmApi` object (near the existing `getClubConfig`/`updateClubConfig` methods):
```js
// Finance settings (admin only)
getFinanceSettings: () => api.get('/rondo/v1/finance/settings'),
updateFinanceSettings: (data) => api.post('/rondo/v1/finance/settings', data),
```
  </action>
  <verify>
Run `npm run build` to verify frontend compiles. Then verify the PHP class follows proper PSR-4 autoloading by checking `composer.json` maps `Rondo\` to `includes/` -- confirm file is at `includes/class-finance-config.php` with namespace `Rondo\Config`. Run `npm run lint` to check for lint issues in modified JS files (may have pre-existing errors, but no NEW errors should appear).
  </verify>
  <done>
FinanceConfig PHP class exists with all settings getters/setters and sodium encryption for Rabobank credentials. REST API endpoints at /rondo/v1/finance/settings accept GET (read) and POST (update) with admin-only permission. Frontend API client has getFinanceSettings/updateFinanceSettings methods.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Sidebar navigation shows: Dashboard, Leden, VOG, Tuchtzaken, Teams, Commissies, **Financien** (section header), Contributie, Facturen (grayed out), Instellingen (admin only), Taken, Feedback, Instellingen
3. `/contributie` redirects to `/financien/contributie`
4. `/financien/instellingen` loads placeholder page
5. PHP class `includes/class-finance-config.php` exists with proper namespace
6. REST endpoints registered at `/rondo/v1/finance/settings` (GET and POST)
7. API client methods `getFinanceSettings` and `updateFinanceSettings` exist
</verification>

<success_criteria>
- Navigation restructured with Financien section containing 3 sub-items
- Old Contributie URL redirects to new location
- FinanceConfig class stores/retrieves all 8 settings via WP Options API
- Rabobank credentials encrypted via sodium (CredentialEncryption class)
- REST API endpoints work with admin-only permissions
- Frontend API client wired to new endpoints
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/178-finance-navigation-settings-backend/178-01-SUMMARY.md`
</output>
