---
phase: 178-finance-navigation-settings-backend
plan: 02
type: execute
wave: 2
depends_on: ["178-01"]
files_modified:
  - src/pages/Finance/FinanceSettings.jsx
  - src/hooks/useFinanceSettings.js
autonomous: true

must_haves:
  truths:
    - "Admin can save and load club invoice details (org name, address, contact email)"
    - "Admin can configure bank account IBAN, payment term days, and payment clause text"
    - "Admin can edit email template with variable placeholder documentation visible"
    - "Admin can enter Rabobank API credentials with sandbox/production toggle"
    - "Saved settings persist across page reloads"
    - "Success/error feedback shown on save"
  artifacts:
    - path: "src/pages/Finance/FinanceSettings.jsx"
      provides: "Full finance settings form with all sections"
      min_lines: 150
    - path: "src/hooks/useFinanceSettings.js"
      provides: "TanStack Query hook for finance settings CRUD"
      exports: ["useFinanceSettings", "useUpdateFinanceSettings"]
  key_links:
    - from: "src/hooks/useFinanceSettings.js"
      to: "src/api/client.js"
      via: "prmApi.getFinanceSettings / prmApi.updateFinanceSettings"
      pattern: "prmApi\\.getFinanceSettings"
    - from: "src/pages/Finance/FinanceSettings.jsx"
      to: "src/hooks/useFinanceSettings.js"
      via: "useFinanceSettings and useUpdateFinanceSettings hooks"
      pattern: "useFinanceSettings"
---

<objective>
Build the complete Finance Settings page UI at /financien/instellingen with form sections for invoice details, bank account, payment terms, email template, and Rabobank API credentials.

Purpose: Enables club admins to configure all finance-related settings needed for invoice generation in later phases. This is the user-facing form that persists data via the REST API created in Plan 01.
Output: Fully functional settings page with save/load, validation feedback, and placeholder documentation for email template variables.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/178-finance-navigation-settings-backend/178-01-SUMMARY.md
@src/pages/Settings/Settings.jsx
@src/pages/Contributie/Contributie.jsx
@src/hooks/useFinanceSettings.js
@src/api/client.js
@src/components/TabButton.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useFinanceSettings hook and FinanceSettings page</name>
  <files>src/hooks/useFinanceSettings.js, src/pages/Finance/FinanceSettings.jsx</files>
  <action>
**Create src/hooks/useFinanceSettings.js:**

Follow existing hook patterns (e.g., similar to how VOG settings or membership fee settings hooks work). Use TanStack Query:

```js
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { prmApi } from '@/api/client';

export function useFinanceSettings() {
  return useQuery({
    queryKey: ['finance-settings'],
    queryFn: () => prmApi.getFinanceSettings().then(res => res.data),
  });
}

export function useUpdateFinanceSettings() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: (data) => prmApi.updateFinanceSettings(data).then(res => res.data),
    onSuccess: (data) => {
      queryClient.setQueryData(['finance-settings'], data);
    },
  });
}
```

**Replace src/pages/Finance/FinanceSettings.jsx (placeholder from Plan 01):**

Build a settings form page with these sections, each in a card. Use the existing codebase styling conventions (Tailwind classes, card styling, form inputs matching other settings pages).

The page should:
1. Load settings via `useFinanceSettings()` hook on mount
2. Populate form state from loaded data
3. Allow editing all fields
4. Save all changed fields on form submit via `useUpdateFinanceSettings()`
5. Show success toast or inline success message on save
6. Show error message on failure

**Form Layout (single-column, sections in cards):**

**Section 1: "Organisatiegegevens" (Organization Details)**
Card with heading "Organisatiegegevens" and description "Deze gegevens worden op facturen vermeld."
- Organization name: text input, label "Organisatienaam", placeholder "Naam van de vereniging"
- Address: textarea (3 rows), label "Adres", placeholder "Straat, postcode, plaats"
- Contact email: email input, label "E-mailadres", placeholder "financien@vereniging.nl"

**Section 2: "Betaalgegevens" (Payment Details)**
Card with heading "Betaalgegevens" and description "Bankrekening en betalingsvoorwaarden voor facturen."
- IBAN: text input, label "IBAN", placeholder "NL00 RABO 0000 0000 00" -- on blur, auto-format: uppercase, strip extra spaces
- Payment term days: number input, label "Betalingstermijn (dagen)", default value 14, min 1, max 365
- Payment clause: textarea (3 rows), label "Betalingsclausule", placeholder "Tekst die onderaan de factuur wordt getoond over de betalingsvoorwaarden"

**Section 3: "E-mailsjabloon" (Email Template)**
Card with heading "E-mailsjabloon" and description "Sjabloon voor de e-mail waarmee facturen worden verstuurd."
- Email template: textarea (8 rows), label "E-mailtekst", monospace font (`font-mono text-sm`)
- Below the textarea, show a helper box with available variables:
  ```
  Beschikbare variabelen:
  {naam}              - Naam van het lid
  {factuur_nummer}    - Factuurnummer
  {tuchtzaken_lijst}  - Overzicht van tuchtzaken
  {totaal_bedrag}     - Totaalbedrag
  {betaallink}        - Link naar betaalverzoek
  {organisatie_naam}  - Naam van de organisatie
  ```
  Style this as a light info box: `bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 text-sm text-blue-700 dark:text-blue-300`. Use a `<code>` tag for each variable name.

**Section 4: "Rabobank Koppeling" (Rabobank Integration)**
Card with heading "Rabobank Koppeling" and description "API-gegevens voor het aanmaken van betaalverzoeken via Rabobank."
- Environment toggle: two radio buttons or a select, label "Omgeving":
  - "Sandbox (test)" value `sandbox`
  - "Productie" value `production`
  Default: `sandbox`. Show a warning badge/text when `production` is selected: "Let op: productieomgeving gebruikt echte betalingen"
- Client ID: text input, label "Client ID", placeholder "Rabobank Client ID"
- Client Secret: password input (type="password"), label "Client Secret", placeholder "Rabobank Client Secret"
- Note: When loading, if `has_credentials` is true from the API response, show placeholder dots in the password fields and a note "Opgeslagen credentials gevonden. Laat velden leeg om huidige waarden te behouden." Only send credential fields if the user actually types something new.

**Save Button:**
At the bottom, a primary button "Opslaan" that submits all changed settings. Show a loading spinner while saving (use `Loader2` from lucide-react). After successful save, show a brief green success message "Instellingen opgeslagen" that auto-fades after 3 seconds.

**Error handling:**
If the API call fails, show an error alert in red above the save button.

**Implementation notes:**
- Use `useState` for form fields, initialized from query data via `useEffect`
- For the Rabobank credentials: only include `rabobank_client_id` and `rabobank_client_secret` in the POST payload if the user has entered new values (non-empty). Always include `rabobank_environment`.
- Use existing Tailwind patterns: `card` class for card containers (already defined in the CSS), `input`/`textarea` base classes if they exist, or match the styling from Settings.jsx
- All text should be in Dutch
- Ensure dark mode compatibility on all elements
  </action>
  <verify>
Run `npm run build` -- should compile without errors. Run `npm run lint` to check for lint issues in the new files (no new errors from these files). Verify the FinanceSettings page imports correctly and renders form sections.
  </verify>
  <done>
Finance Settings page at /financien/instellingen shows 4 form sections: Organisatiegegevens (name, address, email), Betaalgegevens (IBAN, payment terms, clause), E-mailsjabloon (template editor with variable documentation), Rabobank Koppeling (environment toggle, client ID, client secret). Settings load from API, save persists to backend, success/error feedback displayed. Dark mode compatible.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. Navigate to /financien/instellingen -- settings page loads with 4 sections
3. Fill in organization name, address, email -- click save -- reload page -- values persist
4. Fill in IBAN (auto-formats to uppercase), payment term days, payment clause -- save and reload -- values persist
5. Edit email template -- variable documentation visible below editor -- save and reload -- persists
6. Enter Rabobank client ID and secret -- select environment -- save -- reload shows "credentials saved" indicator, password fields show placeholder
7. All sections render correctly in dark mode
</verification>

<success_criteria>
- Finance Settings page renders 4 distinct sections in cards
- All form fields load existing values from REST API
- Save button persists all settings via POST to /rondo/v1/finance/settings
- Rabobank credentials only sent when user enters new values
- Email template variable documentation clearly displayed
- Success/error feedback shown after save attempts
- Page works in both light and dark mode
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/178-finance-navigation-settings-backend/178-02-SUMMARY.md`
</output>
