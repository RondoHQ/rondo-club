---
phase: 135-fix-duplicate-api-calls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main.jsx
autonomous: true

must_haves:
  truths:
    - "Dashboard page load triggers single API call per endpoint (not 2x)"
    - "Page transitions trigger single API call per endpoint"
    - "Tab switching does not trigger refetches"
  artifacts:
    - path: "src/main.jsx"
      provides: "QueryClient with optimized defaults"
      contains: "refetchOnWindowFocus: false"
  key_links:
    - from: "src/main.jsx"
      to: "all useQuery calls"
      via: "QueryClientProvider defaultOptions"
      pattern: "defaultOptions.*queries"
---

<objective>
Eliminate duplicate API calls on page load by optimizing QueryClient configuration.

Purpose: Fix the 2x API call issue observed on all page loads, improving performance and reducing server load.
Output: Updated QueryClient defaults that prevent unnecessary refetches during React 18 StrictMode double-mount and tab switching.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/135-fix-duplicate-api-calls/135-RESEARCH.md
@src/main.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add refetchOnWindowFocus to QueryClient defaults</name>
  <files>src/main.jsx</files>
  <action>
Update the QueryClient defaultOptions to add `refetchOnWindowFocus: false`:

```javascript
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5 minutes (already present)
      refetchOnWindowFocus: false, // ADD THIS - prevents refetch on tab switch
      retry: 1, // (already present)
    },
  },
});
```

This prevents queries from refetching when the user switches browser tabs, which is unnecessary for a personal CRM application where data doesn't change frequently.

The existing `staleTime: 5 * 60 * 1000` already prevents duplicate calls during React 18 StrictMode's development-only double-mount cycle (data is considered fresh for 5 minutes, so the second mount doesn't trigger a refetch).
  </action>
  <verify>
Run `npm run lint` to ensure no linting errors.
Run `npm run build` to ensure production build succeeds.
  </verify>
  <done>
QueryClient defaultOptions include `refetchOnWindowFocus: false`.
Build completes successfully with no errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy and verify fix</name>
  <files>dist/</files>
  <action>
1. Run production build: `npm run build`
2. Deploy to production using `bin/deploy.sh`
3. The fix is now live for verification

Note: The duplicate API calls are primarily a development-mode issue caused by React 18 StrictMode double-mount. In production, StrictMode doesn't double-mount components. However, the `refetchOnWindowFocus: false` setting prevents unnecessary refetches when users switch tabs, which improves production performance.
  </action>
  <verify>
Deploy script completes without errors.
Production site loads successfully at the production URL.
  </verify>
  <done>
Production deployment successful.
Changes are live and ready for UAT verification.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Development verification** (local):
   - Run `npm run dev`
   - Open browser DevTools Network tab
   - Navigate to Dashboard
   - Observe that each endpoint is called once (not twice)
   - Note: Some duplication in dev is expected due to StrictMode, but should be deduped by React Query

2. **Production verification** (deployed):
   - Open production site
   - Open browser DevTools Network tab
   - Hard refresh Dashboard
   - Verify single API call per endpoint
   - Switch to another browser tab, then back
   - Verify NO refetch occurred (thanks to refetchOnWindowFocus: false)
</verification>

<success_criteria>
1. `npm run build` succeeds without errors
2. Production deployment completes successfully
3. QueryClient defaults include `refetchOnWindowFocus: false`
4. Tab switching does not trigger API refetches
</success_criteria>

<output>
After completion, create `.planning/phases/135-fix-duplicate-api-calls/135-01-SUMMARY.md`
</output>
