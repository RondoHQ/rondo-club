---
phase: 135-fix-duplicate-api-calls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main.jsx
autonomous: true

must_haves:
  truths:
    - "Production page loads make single API call per endpoint"
    - "Tab switching does not trigger refetches"
    - "React Query deduplicates concurrent requests with same queryKey"
  artifacts:
    - path: "src/main.jsx"
      provides: "QueryClient with optimized defaults"
      contains: "refetchOnWindowFocus: false"
  key_links:
    - from: "src/main.jsx"
      to: "all useQuery calls"
      via: "QueryClientProvider defaultOptions"
      pattern: "defaultOptions.*queries"
---

<objective>
Eliminate unnecessary API refetches by optimizing QueryClient configuration and documenting React Query's built-in deduplication behavior.

Purpose: Ensure production page loads make single API calls per endpoint and prevent tab-switch refetches. Clarify that React Query already handles concurrent request deduplication.
Output: Updated QueryClient defaults that prevent unnecessary refetches, with clear understanding of React Query's deduplication mechanisms.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/135-fix-duplicate-api-calls/135-RESEARCH.md
@src/main.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add refetchOnWindowFocus to QueryClient defaults</name>
  <files>src/main.jsx</files>
  <action>
Update the QueryClient defaultOptions to add `refetchOnWindowFocus: false`:

```javascript
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5 minutes (already present)
      refetchOnWindowFocus: false, // ADD THIS - prevents refetch on tab switch
      retry: 1, // (already present)
    },
  },
});
```

**Why this configuration prevents duplicate API calls:**

1. **React Query's built-in request deduplication (DUP-03):** When multiple components with the same queryKey initiate requests concurrently (within milliseconds), React Query automatically merges them into a single network request. This is built-in behavior that requires no configuration - all concurrent in-flight requests with identical queryKeys share the same Promise.

2. **staleTime prevents remount refetches:** The existing `staleTime: 5 * 60 * 1000` means data is considered "fresh" for 5 minutes. If a component remounts (e.g., during React 18 StrictMode double-mount in development), React Query checks the cache first. If data exists and is fresh, no network request is made.

3. **refetchOnWindowFocus prevents tab-switch refetches:** Adding `refetchOnWindowFocus: false` prevents unnecessary network requests when users switch browser tabs. For a personal CRM where data doesn't change frequently, this is appropriate.

**Combined effect:** StrictMode double-mount in development doesn't cause duplicate network requests because:
- If requests are concurrent (same tick), React Query deduplicates them
- If the second mount occurs after the first request completes, staleTime means cached data is used without refetching
  </action>
  <verify>
Run `npm run lint` to ensure no linting errors.
Run `npm run build` to ensure production build succeeds.
  </verify>
  <done>
QueryClient defaultOptions include `refetchOnWindowFocus: false`.
Build completes successfully with no errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy and verify fix in production</name>
  <files>dist/</files>
  <action>
1. Run production build: `npm run build`
2. Deploy to production using `bin/deploy.sh`
3. The fix is now live for verification

**Important scope clarification:**

The original issue ("duplicate API calls, all endpoints 2x") was likely observed in development mode. React 18 StrictMode intentionally double-mounts components in development to help detect side-effect issues. This is expected behavior and NOT a bug.

In **production**, StrictMode does not double-mount components, so the duplicate calls should not occur. The `refetchOnWindowFocus: false` setting provides tangible production benefit by preventing unnecessary refetches when users switch tabs.

**Verification focus should be on production behavior**, not development mode. Development duplicates from StrictMode are expected and harmless (React Query's deduplication ensures minimal network impact even then).
  </action>
  <verify>
Deploy script completes without errors.
Production site loads successfully at the production URL.
  </verify>
  <done>
Production deployment successful.
Changes are live and ready for UAT verification.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Production verification** (PRIMARY - this is where behavior matters):
   - Open production site in browser
   - Open DevTools Network tab, filter by "Fetch/XHR"
   - Hard refresh Dashboard (Cmd/Ctrl+Shift+R)
   - Verify single API call per endpoint (dashboard, current-user, etc.)
   - Switch to another browser tab for 5+ seconds, then return
   - Verify NO refetch occurred (Network tab should show no new requests)

2. **Development verification** (SECONDARY - informational only):
   - Run `npm run dev`
   - Open browser DevTools Network tab
   - Navigate to Dashboard
   - Note: Some duplication may appear due to StrictMode double-mount - this is EXPECTED BEHAVIOR
   - React Query's request deduplication ensures these concurrent requests share a single network call

3. **React Query deduplication confirmation** (DUP-03):
   - The existing codebase uses consistent queryKeys (e.g., ['dashboard'], ['currentUser'])
   - React Query automatically deduplicates concurrent requests with identical queryKeys
   - No additional code changes needed - this is built-in behavior
</verification>

<success_criteria>
1. `npm run build` succeeds without errors
2. Production deployment completes successfully
3. QueryClient defaults include `refetchOnWindowFocus: false`
4. **Production:** Single API call per endpoint on page load
5. **Production:** Tab switching does not trigger API refetches
6. **Documentation:** Team understands React Query's built-in deduplication (DUP-03 satisfied)
</success_criteria>

<output>
After completion, create `.planning/phases/135-fix-duplicate-api-calls/135-01-SUMMARY.md`
</output>
