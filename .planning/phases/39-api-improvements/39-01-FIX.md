---
phase: 39-api-improvements
plan: 01-FIX
type: fix
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-base.php
  - src/components/ImportantDateModal.jsx
autonomous: true
---

<objective>
Fix 1 UAT issue from plan 39-01: custom important date titles revert to auto-generated when reopening the edit modal.

Source: 39-UAT.md
Priority: 0 critical, 1 major, 0 minor

Purpose: Ensure user-edited important date titles persist through modal reopen.
Output: Backend returns custom_label field, frontend respects it on modal open.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issue being fixed:**
@.planning/phases/39-api-improvements/39-UAT.md

**Original plan for reference:**
@.planning/phases/39-api-improvements/39-01-PLAN.md

**Files to modify:**
@includes/class-rest-base.php
@src/components/ImportantDateModal.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-001 - Custom title reverts on modal reopen</name>
  <files>includes/class-rest-base.php, src/components/ImportantDateModal.jsx</files>
  <action>
**Root cause:** Backend saves custom title to `custom_label` ACF field (in class-auto-title.php), but the REST API's `format_date()` method doesn't include this field in the response. Without `custom_label` data, the frontend modal has no way to know the title was customized.

**Backend fix (class-rest-base.php):**
In the `format_date()` method, add the `custom_label` field to the returned data array:

```php
'custom_label' => get_field('custom_label', $post->ID) ?: '',
```

Add this alongside the other fields like `date`, `date_type`, etc.

**Frontend fix (ImportantDateModal.jsx):**
In the useEffect that runs when `dateItem` changes (the one that resets the form), check if `custom_label` is present and non-empty. If so, set `hasUserEditedTitle.current = true` AFTER the form reset completes:

```jsx
// After reset() call, check for custom_label
if (dateItem?.custom_label) {
  hasUserEditedTitle.current = true;
}
```

This ensures the auto-title effect sees that the user has "edited" the title (via custom_label) and skips regeneration.
  </action>
  <verify>
1. Edit an existing important date with a custom title
2. Change the title to something custom (e.g., "My Custom Birthday")
3. Save the date
4. Close and reopen the edit modal
5. The title should still be "My Custom Birthday" (not auto-generated)
6. `npm run build` succeeds
  </verify>
  <done>Custom important date titles persist when reopening the edit modal. The backend returns custom_label in the API response, and the frontend respects it by marking the title as user-edited.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Custom title persists through modal close/reopen cycle
- [ ] Auto-title still works for new dates without custom_label
- [ ] Existing dates with auto-generated titles still work normally
</verification>

<success_criteria>
- UAT-001 from 39-UAT.md addressed
- Build passes
- Ready for re-verification with /gsd:verify-work 39
</success_criteria>

<output>
After completion, create `.planning/phases/39-api-improvements/39-01-FIX-SUMMARY.md`
</output>
