---
phase: 01-rest-api-infrastructure
plan: 01
type: execute
depends_on: []
files_modified: [includes/class-rest-base.php, includes/class-rest-api.php, functions.php]
---

<objective>
Create the base REST API class with shared infrastructure that domain-specific classes will extend in later phases.

Purpose: Establish inheritance structure so endpoint extraction in phases 2-3 is straightforward and maintains DRY principles.
Output: Abstract `PRM_REST_Base` class with shared methods, `PRM_REST_API` updated to extend it.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/ARCHITECTURE.md

**Key source files:**
@includes/class-rest-api.php
@functions.php (autoloader at lines 48-79)

**Shared methods to extract (from class-rest-api.php):**
- `check_user_approved()` (line 481) - Used by 7+ endpoints
- `check_admin_permission()` (line 1865) - Used by admin-only endpoints
- `check_person_access()` (line 500) - Person ownership verification
- `check_person_edit_permission()` (line 1662) - Edit permission check
- `check_company_edit_permission()` (line 1638) - Edit permission check
- `format_person_summary()` (line 1474) - Response formatting helper
- `format_company_summary()` (line 1489) - Response formatting helper
- `format_date()` (line 1502) - Response formatting helper

**Decisions:**
- Keep all routes in PRM_REST_API for now (phases 2-3 will extract them)
- Base class is abstract - never instantiated directly
- Use protected methods for shared utilities
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PRM_REST_Base abstract class</name>
  <files>includes/class-rest-base.php</files>
  <action>
Create new file `includes/class-rest-base.php` with abstract class `PRM_REST_Base`.

Extract these methods from class-rest-api.php:
1. `check_user_approved()` - permission callback for approved users
2. `check_admin_permission()` - permission callback for admins only
3. `check_person_access($request)` - verify person ownership
4. `check_person_edit_permission($request)` - verify person edit permission
5. `check_company_edit_permission($request)` - verify company edit permission

Also extract these protected helper methods:
6. `format_person_summary($post)` - format person for API response
7. `format_company_summary($post)` - format company for API response
8. `format_date($post)` - format date for API response

Class structure:
- Abstract class (cannot be instantiated)
- Constructor can be empty or declare abstract `register_routes()` method
- All methods protected (accessible to child classes)
- Include PHPDoc for each method explaining its purpose

Follow existing conventions:
- `PRM_` prefix for class name
- ABSPATH check at top
- Method naming matches existing code
  </action>
  <verify>php -l includes/class-rest-base.php returns no syntax errors</verify>
  <done>class-rest-base.php exists with 8 extracted methods, passes PHP lint check</done>
</task>

<task type="auto">
  <name>Task 2: Update PRM_REST_API to extend base class</name>
  <files>includes/class-rest-api.php</files>
  <action>
Modify `class-rest-api.php`:

1. Change class declaration from `class PRM_REST_API` to `class PRM_REST_API extends PRM_REST_Base`

2. Remove these methods (now inherited from base):
   - `check_user_approved()` (~20 lines, around line 481)
   - `check_admin_permission()` (~7 lines, around line 1865)
   - `check_person_access()` (~18 lines, around line 500)
   - `check_person_edit_permission()` (~23 lines, around line 1662)
   - `check_company_edit_permission()` (~23 lines, around line 1638)
   - `format_person_summary()` (~15 lines, around line 1474)
   - `format_company_summary()` (~13 lines, around line 1489)
   - `format_date()` (~26 lines, around line 1502)

3. Keep constructor as-is (calls parent constructor implicitly since parent constructor is empty)

DO NOT change any route registrations or endpoint callbacks. The class should function identically after this change.

Verify by checking that method calls like `$this->check_user_approved()` will resolve to the parent class method.
  </action>
  <verify>php -l includes/class-rest-api.php returns no syntax errors AND grep -c "extends PRM_REST_Base" includes/class-rest-api.php returns 1</verify>
  <done>PRM_REST_API extends PRM_REST_Base, 8 methods removed, no duplicate method definitions</done>
</task>

<task type="auto">
  <name>Task 3: Update autoloader for new class</name>
  <files>functions.php</files>
  <action>
Add `PRM_REST_Base` to the autoloader class map in functions.php.

Find the `$class_map` array (around line 55) and add:
```php
'PRM_REST_Base' => 'class-rest-base.php',
```

Add it in alphabetical order by class name (after PRM_Reminders, before PRM_REST_API).

Also update the comment block above the array if one exists to reflect the new class.
  </action>
  <verify>grep "PRM_REST_Base" functions.php returns the new mapping line</verify>
  <done>Autoloader includes PRM_REST_Base mapping</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `php -l includes/class-rest-base.php` - no syntax errors
- [ ] `php -l includes/class-rest-api.php` - no syntax errors
- [ ] `php -l functions.php` - no syntax errors
- [ ] `grep "extends PRM_REST_Base" includes/class-rest-api.php` returns match
- [ ] `grep "PRM_REST_Base" functions.php` returns autoloader mapping
</verification>

<success_criteria>
- Abstract base class created with shared permission and formatting methods
- PRM_REST_API extends base class
- Autoloader updated
- All PHP files pass lint check
- No duplicate method definitions between base and child class
</success_criteria>

<output>
After completion, create `.planning/phases/01-rest-api-infrastructure/01-01-SUMMARY.md`
</output>
