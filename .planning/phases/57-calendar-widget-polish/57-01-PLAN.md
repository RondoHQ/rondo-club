---
phase: 57-calendar-widget-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/Dashboard.jsx
  - includes/class-rest-calendar.php
  - src/hooks/useTheme.js
autonomous: true
---

<objective>
Fix Today's meetings widget layout, timezone display, and update favicon.

Purpose: Polish the calendar integration and visual branding for better UX.
Output: Dashboard meetings widget with correct layout, timezone-aware times, and dynamic accent-colored favicon.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-dark-mode-console-fixes/56-01-SUMMARY.md

Source files:
@src/pages/Dashboard.jsx
@includes/class-rest-calendar.php
@src/hooks/useTheme.js
@favicon.svg
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Today's Meetings Layout</name>
  <files>src/pages/Dashboard.jsx</files>
  <action>
The Today's meetings block currently renders as a full-width card between row 1 (todos) and row 2 (favorites/recent). Per the todo, it should be a single column for better visual hierarchy.

**Layout change:**
1. Move Today's meetings block INTO the Row 1 grid (which uses `grid-cols-1 lg:grid-cols-3`)
2. Position it as the 4th item in a 4-column layout: Reminders | Todos | Awaiting | Meetings
3. On mobile (grid-cols-1), it will stack below the others
4. Change the row 1 grid from `lg:grid-cols-3` to `lg:grid-cols-4` when calendar connections exist
5. Conditionally render the grid class based on `hasCalendarConnections`

**Conditional layout logic:**
```jsx
<div className={`grid grid-cols-1 ${hasCalendarConnections ? 'lg:grid-cols-4' : 'lg:grid-cols-3'} gap-6`}>
  {/* Reminders */}
  {/* Todos */}
  {/* Awaiting */}
  {hasCalendarConnections && (
    /* Today's meetings card - same structure, just moved here */
  )}
</div>
```

**Important:** Remove the standalone Today's meetings block that sits between rows 1 and 2 (around lines 660-686). The conditional rendering already handles showing/hiding based on `hasCalendarConnections`.
  </action>
  <verify>npm run build succeeds, visually confirm 4-column layout on desktop when calendar connected, 3-column when not</verify>
  <done>Dashboard shows 4-column grid with meetings when calendar connected, 3-column otherwise</done>
</task>

<task type="auto">
  <name>Task 2: Fix Timezone Display in Meeting Times</name>
  <files>includes/class-rest-calendar.php, src/pages/Dashboard.jsx</files>
  <action>
Meeting times are stored in WordPress site timezone but sent without timezone info. JavaScript interprets the datetime string as local browser time, causing incorrect display when user's browser timezone differs from site timezone.

**Backend fix (class-rest-calendar.php):**
In the `format_today_meeting()` method (around line 1077), change `start_time` and `end_time` to include timezone offset:

1. Get WordPress timezone offset:
```php
$wp_timezone = wp_timezone();
$start_datetime = new DateTime(get_post_meta($event->ID, '_start_time', true), $wp_timezone);
$end_datetime = new DateTime(get_post_meta($event->ID, '_end_time', true), $wp_timezone);
```

2. Return ISO 8601 format with timezone:
```php
'start_time' => $start_datetime->format('c'),  // ISO 8601 with offset
'end_time'   => $end_datetime->format('c'),
```

The `'c'` format produces strings like `2026-01-15T10:00:00+01:00` which JavaScript's `new Date()` correctly parses in the specified timezone and converts to local.

**Frontend verification (Dashboard.jsx):**
The MeetingCard component (line 237) already uses `format(new Date(meeting.start_time), 'h:mm a')`. With ISO 8601 input, JavaScript will correctly convert to the user's local timezone before formatting. No frontend changes needed - the `date-fns` `format()` function will display in the user's local timezone automatically.

**Handle edge case:** If `_start_time` is empty or invalid, fall back to current time:
```php
$start_meta = get_post_meta($event->ID, '_start_time', true);
$start_datetime = new DateTime($start_meta ?: 'now', $wp_timezone);
```
  </action>
  <verify>Test by checking API response includes timezone offset (curl /rondo/v1/calendar/today-meetings), verify frontend shows correct local time</verify>
  <done>Meeting times display correctly in user's local timezone regardless of server timezone</done>
</task>

<task type="auto">
  <name>Task 3: Dynamic Favicon Based on Accent Color</name>
  <files>src/hooks/useTheme.js</files>
  <action>
The current favicon uses hardcoded orange (#d87708) but the app supports 8 accent colors. Update the favicon dynamically when the user changes their accent color.

**Implementation in useTheme.js:**

1. Add accent color hex mapping (Tailwind -500 values):
```js
const ACCENT_HEX = {
  orange: '#f97316',
  teal: '#14b8a6',
  indigo: '#6366f1',
  emerald: '#10b981',
  violet: '#8b5cf6',
  pink: '#ec4899',
  fuchsia: '#d946ef',
  rose: '#f43f5e',
};
```

2. Add favicon update function:
```js
function updateFavicon(accentColor) {
  if (typeof document === 'undefined') return;

  const hex = ACCENT_HEX[accentColor] || ACCENT_HEX.orange;

  // SVG path from favicon.svg (sparkle icon)
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${hex}">
    <path fill-rule="evenodd" d="M9 4.5a.75.75 0 0 1 .721.544l.813 2.846a3.75 3.75 0 0 0 2.576 2.576l2.846.813a.75.75 0 0 1 0 1.442l-2.846.813a3.75 3.75 0 0 0-2.576 2.576l-.813 2.846a.75.75 0 0 1-1.442 0l-.813-2.846a3.75 3.75 0 0 0-2.576-2.576l-2.846-.813a.75.75 0 0 1 0-1.442l2.846-.813A3.75 3.75 0 0 0 7.466 7.89l.813-2.846A.75.75 0 0 1 9 4.5ZM18 1.5a.75.75 0 0 1 .728.568l.258 1.036c.236.94.97 1.674 1.91 1.91l1.036.258a.75.75 0 0 1 0 1.456l-1.036.258c-.94.236-1.674.97-1.91 1.91l-.258 1.036a.75.75 0 0 1-1.456 0l-.258-1.036a2.625 2.625 0 0 0-1.91-1.91l-1.036-.258a.75.75 0 0 1 0-1.456l1.036-.258a2.625 2.625 0 0 0 1.91-1.91l.258-1.036A.75.75 0 0 1 18 1.5ZM16.5 15a.75.75 0 0 1 .712.513l.394 1.183c.15.447.5.799.948.948l1.183.395a.75.75 0 0 1 0 1.422l-1.183.395c-.447.15-.799.5-.948.948l-.395 1.183a.75.75 0 0 1-1.422 0l-.395-1.183a1.5 1.5 0 0 0-.948-.948l-1.183-.395a.75.75 0 0 1 0-1.422l1.183-.395c.447-.15.799-.5.948-.948l.395-1.183A.75.75 0 0 1 16.5 15Z" clip-rule="evenodd" />
  </svg>`;

  const dataUrl = `data:image/svg+xml,${encodeURIComponent(svg)}`;

  // Update existing favicon link or create new one
  let link = document.querySelector('link[rel="icon"]');
  if (!link) {
    link = document.createElement('link');
    link.rel = 'icon';
    document.head.appendChild(link);
  }
  link.type = 'image/svg+xml';
  link.href = dataUrl;
}
```

3. Call `updateFavicon(accentColor)` in the `applyTheme()` function alongside the existing DOM updates:
```js
function applyTheme(effectiveColorScheme, accentColor) {
  // ... existing dark mode and data-accent logic ...

  // Update favicon to match accent color
  updateFavicon(accentColor);
}
```

**Note:** The PHP-rendered favicon from `stadion_theme_add_favicon()` will be replaced by the JS-generated one once React loads. This is fine since the React app handles the SPA experience.
  </action>
  <verify>Change accent color in Settings, verify browser tab favicon updates to match the selected color</verify>
  <done>Favicon dynamically updates to match user's selected accent color</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] Dashboard shows 4-column grid when calendar connected
- [ ] Dashboard shows 3-column grid when no calendar connected
- [ ] Meeting times in API response include timezone offset (ISO 8601 format)
- [ ] Meeting times display in user's local timezone on frontend
- [ ] Favicon dynamically updates when accent color changes in Settings
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Dashboard meetings widget properly positioned in row 1
- Timezone handling works correctly
- Favicon dynamically matches user's accent color
</success_criteria>

<output>
After completion, create `.planning/phases/57-calendar-widget-polish/57-01-SUMMARY.md`
</output>
