---
phase: 166-backend-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - acf-json/group_person_fields.json
  - steps/submit-rondo-club-sync.js (rondo-sync repo)
  - ../developer/src/content/docs/api/people.md
autonomous: true

must_haves:
  truths:
    - "Person records have a former_member ACF field that defaults to false"
    - "REST API accepts updates to former_member field via PUT /wp/v2/people/{id}"
    - "rondo-sync marks removed members as former instead of deleting them"
    - "API documentation describes the former_member field and its usage"
  artifacts:
    - path: "acf-json/group_person_fields.json"
      provides: "former_member true_false field on person records"
      contains: "former_member"
    - path: "../developer/src/content/docs/api/people.md"
      provides: "API documentation for former_member field"
      contains: "former_member"
  key_links:
    - from: "rondo-sync submit-rondo-club-sync.js"
      to: "wp/v2/people/{id} REST API"
      via: "PUT request with acf.former_member: true"
      pattern: "former_member.*true"
---

<objective>
Add `former_member` boolean field to person records and make it accessible via REST API, then update rondo-sync to mark removed members as former instead of deleting them.

Purpose: This is the data foundation for the v23.0 Former Members milestone. Without this field, the system cannot distinguish between active and former members.

Output: ACF field on person records, REST API accessibility confirmed, rondo-sync updated to use marking instead of deletion, API docs updated.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@acf-json/group_person_fields.json
@includes/class-rest-api.php (register_acf_fields method, add_vog_fields_to_person pattern)
@../developer/src/content/docs/api/people.md
@../rondo-sync/steps/submit-rondo-club-sync.js (deleteRemovedMembers function)
@../rondo-sync/lib/rondo-club-client.js (rondoClubRequest function)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add former_member ACF field to person records</name>
  <files>acf-json/group_person_fields.json</files>
  <action>
Add a `former_member` true_false ACF field to the person fields group in `acf-json/group_person_fields.json`.

Field specification:
- key: `field_former_member`
- label: "Oud-lid" (Dutch for "former member")
- name: `former_member`
- type: `true_false`
- default_value: 0 (false)
- ui: 1 (toggle switch in admin)
- message: "Dit lid is niet meer actief bij de club" ("This member is no longer active at the club")

Place this field in the Basic Information tab, after the existing fields (after `field_photo_gallery` or similar basic fields). Since this is a system-managed field (set by rondo-sync, not by admins), add `readonly: 1` so it appears in the WordPress admin but cannot be changed manually.

Because the person CPT already has `show_in_rest: true` and ACF Pro automatically exposes fields in the REST API, adding this field to the ACF JSON will make it immediately available via `GET/PUT /wp/v2/people/{id}` as `acf.former_member`.

After modifying the JSON, deploy to production and verify the field is accessible. Run on production:
```bash
source .env && ssh -p "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" "cd $DEPLOY_REMOTE_THEME_PATH && wp eval 'echo json_encode(get_field_object(\"former_member\", false));'"
```
  </action>
  <verify>
1. `npm run build` succeeds (no build errors)
2. Deploy to production via `bin/deploy.sh`
3. Verify on production that the ACF field is registered:
   ```bash
   source .env && ssh -p "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" "cd $DEPLOY_REMOTE_THEME_PATH && wp post list --post_type=person --posts_per_page=1 --format=ids | xargs -I{} wp post meta get {} former_member"
   ```
4. Verify REST API exposes the field (GET a person and check for `acf.former_member` in response):
   ```bash
   source .env && ssh -p "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" "cd $DEPLOY_REMOTE_THEME_PATH && wp eval \"echo json_encode(wp_remote_get(rest_url('wp/v2/people?per_page=1')));\""
   ```
  </verify>
  <done>The `former_member` field exists on person records, defaults to false, and is readable/writable via the REST API at `acf.former_member`.</done>
</task>

<task type="auto">
  <name>Task 2: Update rondo-sync to mark former members instead of deleting</name>
  <files>../rondo-sync/steps/submit-rondo-club-sync.js</files>
  <action>
Modify the `deleteRemovedMembers()` function in `/Users/joostdevalk/Code/rondo/rondo-sync/steps/submit-rondo-club-sync.js`.

Current behavior: When a KNVB ID is no longer in Sportlink data, the function sends `DELETE /wp/v2/people/{id}` and removes the member from the local tracking DB.

New behavior: Instead of deleting, mark the person as a former member:
1. For members with a `stadion_id` (synced to Rondo Club): Send `PUT /wp/v2/people/{stadion_id}` with body `{ acf: { former_member: true } }` to mark them as former.
2. Keep the member in the local tracking DB (do NOT call `deleteMember(db, knvb_id)`) so we can detect if they rejoin later.
3. Log the action: `Marking as former member: {knvb_id} (Rondo Club ID: {stadion_id})`
4. For members without a `stadion_id` (never synced): Still remove from tracking DB since there's nothing to mark.

Also handle the reverse case: if a formerly marked member reappears in Sportlink data, the normal `syncPerson()` update flow should set `former_member: false`. Add `former_member: false` to the data payload in the member preparation step or in the syncPerson update path so that active members are always explicitly marked as not former.

Rename the function from `deleteRemovedMembers` to `markFormerMembers` to reflect the new behavior. Update all call sites (the main sync orchestration function in the same file) to use the new name. Also update the return value shape if needed.

Handle errors gracefully: if the PUT request fails, log the error and continue (same pattern as existing delete error handling). Handle 404 as "already deleted from WordPress" — remove from tracking DB.

Important: This is in the rondo-sync repo at `/Users/joostdevalk/Code/rondo/rondo-sync/`. Git operations must be run from that directory.
  </action>
  <verify>
1. Code review: `deleteRemovedMembers` is replaced by `markFormerMembers` that uses PUT instead of DELETE.
2. The function sends `{ acf: { former_member: true } }` via PUT to `/wp/v2/people/{id}`.
3. Members are kept in the tracking DB after being marked as former.
4. The main sync function calls `markFormerMembers` instead of `deleteRemovedMembers`.
5. The parent deletion function (`deleteOrphanParents`) still uses DELETE (parents are not members — they should still be deleted when orphaned).
  </verify>
  <done>rondo-sync marks removed members as former via PUT with `acf.former_member: true` instead of deleting them. Active members being synced are explicitly set to `former_member: false`.</done>
</task>

<task type="auto">
  <name>Task 3: Update API documentation for former_member field</name>
  <files>../developer/src/content/docs/api/people.md</files>
  <action>
Update the People API documentation at `/Users/joostdevalk/Code/rondo/developer/src/content/docs/api/people.md` to document the `former_member` field.

Add the field in two places:

1. **In the "Computed Fields (Read-Only)" section** — Wait, this is NOT a computed field. It's a system-managed field set by rondo-sync. Add a new section called "### Membership Status" between "Basic Information" and "Contact Information", with:

| Field | Type | Description | Values |
|-------|------|-------------|--------|
| `acf.former_member` | boolean | Whether the person is a former member (oud-lid) | `true`, `false` (default) |

Add a note: "This field is managed by rondo-sync. When a member is no longer found in Sportlink data, they are automatically marked as a former member. The field defaults to `false` for all new and active members."

2. **In the "Update a Person" section**, add an example showing how to mark a member as former:

```bash
# Mark a member as former (used by rondo-sync)
curl -X PUT "https://your-site.com/wp-json/wp/v2/people/456" \
  -u "username:xxxx xxxx xxxx xxxx xxxx xxxx" \
  -H "Content-Type: application/json" \
  -d '{"acf": {"former_member": true}}'
```

3. **In the response examples**, add `"former_member": false` to the `acf` object in the Create and Get response examples so integrators know it exists.
  </action>
  <verify>
1. The file contains documentation for `acf.former_member`.
2. The "Membership Status" section exists with the field reference table.
3. A curl example shows how to mark a member as former.
4. Response examples include `former_member: false`.
  </verify>
  <done>API documentation describes the `former_member` field, its purpose, default value, how to set it, and it appears in response examples.</done>
</task>

</tasks>

<verification>
1. ACF field `former_member` exists in `acf-json/group_person_fields.json` as a true_false field with default 0
2. The field is accessible via REST API (GET returns it, PUT/PATCH can set it)
3. rondo-sync's `submit-rondo-club-sync.js` marks removed members as former instead of deleting
4. Active synced members explicitly have `former_member: false`
5. API documentation at `developer/src/content/docs/api/people.md` describes the field
6. Both repos committed and pushed
</verification>

<success_criteria>
- Person records have `former_member` ACF field (boolean, default false)
- REST API accepts `former_member` updates via standard PUT endpoint
- rondo-sync marks removed members as former (PUT with acf.former_member: true) instead of DELETE
- API documentation describes the field for integrators
</success_criteria>

<output>
After completion, create `.planning/phases/166-backend-foundation/166-01-SUMMARY.md`
</output>
