---
phase: 60-calendar-email-matching
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-calendar-matcher.php
  - includes/class-auto-title.php
autonomous: true
---

<objective>
Trigger calendar event re-matching when a person's email addresses change, ensuring newly added emails immediately match against existing calendar events.

Purpose: When a user adds an email address to a person, existing calendar events with that email should now show as matched to that person.
Output: Automatic re-matching of calendar events when person emails are saved.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Current implementation context:
# - PRM_Calendar_Matcher::get_email_lookup() already builds lookup from ALL emails in contact_info repeater
# - PRM_Calendar_Matcher::invalidate_cache() exists but is never called
# - Calendar events store _attendees JSON with original attendee emails
# - Calendar events store _matched_people JSON with match results
# - PRM_Auto_Title already hooks acf/save_post for person post type
# - Email normalization (lowercase) already happens via acf/update_value filter

@includes/class-calendar-matcher.php
@includes/class-auto-title.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add re-matching method to PRM_Calendar_Matcher</name>
  <files>includes/class-calendar-matcher.php</files>
  <action>
Add a new static method `rematch_events_for_user(int $user_id)` that:

1. Gets all calendar_event posts owned by the user that have non-empty `_attendees` meta
2. For each event, calls `match_attendees()` with the stored attendees
3. Updates `_matched_people` meta with new match results
4. Returns count of events re-matched

Implementation details:
- Query calendar_event posts: `'post_type' => 'calendar_event', 'author' => $user_id, 'posts_per_page' => -1`
- Filter to events with _attendees meta that is not empty
- For each event:
  - Get `_attendees` meta, json_decode it
  - Call `self::match_attendees($user_id, $attendees)`
  - Update `_matched_people` meta with `wp_json_encode($matches)`
- Log count of events processed (use error_log only in WP_DEBUG mode)
- Return the count of events processed

Also add a helper method `on_person_saved(int $post_id)` that:
1. Checks if post type is 'person'
2. Gets the post author (user_id)
3. Calls `invalidate_cache($user_id)` to clear the email lookup cache
4. Calls `rematch_events_for_user($user_id)` to update all event matches
  </action>
  <verify>Verify methods exist and have correct signatures by reading the file</verify>
  <done>PRM_Calendar_Matcher has rematch_events_for_user() and on_person_saved() methods</done>
</task>

<task type="auto">
  <name>Task 2: Hook person save to trigger re-matching</name>
  <files>includes/class-auto-title.php</files>
  <action>
Add a hook in PRM_Auto_Title constructor to trigger calendar re-matching when a person is saved:

1. Add to constructor: `add_action('acf/save_post', [$this, 'trigger_calendar_rematch'], 25);`
   (Priority 25 = after auto-title generation at 20, ensuring all ACF fields are saved)

2. Add new method `trigger_calendar_rematch($post_id)`:
   ```php
   public function trigger_calendar_rematch($post_id) {
       // Skip if not a person post type
       if (get_post_type($post_id) !== 'person') {
           return;
       }

       // Skip autosaves and revisions
       if (wp_is_post_autosave($post_id) || wp_is_post_revision($post_id)) {
           return;
       }

       // Trigger calendar re-matching
       PRM_Calendar_Matcher::on_person_saved($post_id);
   }
   ```

The re-matching happens on EVERY person save, which is acceptable because:
- It's a background operation after the save completes
- The email lookup cache rebuild is O(n) where n = user's contacts
- Event re-matching only updates posts, no external API calls
- User won't notice the extra processing time
  </action>
  <verify>Check that the hook is registered in constructor and method exists</verify>
  <done>Person saves trigger PRM_Calendar_Matcher::on_person_saved() via acf/save_post hook</done>
</task>

<task type="auto">
  <name>Task 3: Add WP-CLI command for manual re-matching</name>
  <files>includes/class-calendar-matcher.php</files>
  <action>
Add WP-CLI command registration at the end of class-calendar-matcher.php (after the class definition):

```php
// Register WP-CLI command
if (defined('WP_CLI') && WP_CLI) {
    WP_CLI::add_command('prm calendar rematch', function($args, $assoc_args) {
        $user_id = isset($assoc_args['user']) ? (int) $assoc_args['user'] : get_current_user_id();

        if (!$user_id) {
            WP_CLI::error('No user ID provided. Use --user=ID');
        }

        $user = get_user_by('ID', $user_id);
        if (!$user) {
            WP_CLI::error("User {$user_id} not found.");
        }

        WP_CLI::log("Invalidating email cache for user {$user_id}...");
        PRM_Calendar_Matcher::invalidate_cache($user_id);

        WP_CLI::log("Re-matching calendar events for user {$user_id}...");
        $count = PRM_Calendar_Matcher::rematch_events_for_user($user_id);

        WP_CLI::success("Re-matched {$count} calendar events for user {$user->display_name}.");
    });
}
```

This allows manual triggering: `wp prm calendar rematch --user=1`
  </action>
  <verify>Run `wp prm calendar rematch --help` to verify command is registered</verify>
  <done>WP-CLI command `wp prm calendar rematch` available for manual re-matching</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `rematch_events_for_user()` method exists in PRM_Calendar_Matcher
- [ ] `on_person_saved()` method exists in PRM_Calendar_Matcher
- [ ] `trigger_calendar_rematch()` method exists in PRM_Auto_Title
- [ ] acf/save_post hook registered at priority 25 in PRM_Auto_Title constructor
- [ ] WP-CLI command `wp prm calendar rematch` is available
- [ ] No PHP syntax errors (`php -l includes/class-calendar-matcher.php`)
- [ ] No PHP syntax errors (`php -l includes/class-auto-title.php`)
</verification>

<success_criteria>

- All tasks completed
- Person email changes trigger automatic calendar event re-matching
- WP-CLI command available for manual re-matching
- No performance issues (re-matching is efficient, no external API calls)
</success_criteria>

<output>
After completion, create `.planning/phases/60-calendar-email-matching/60-01-SUMMARY.md`
</output>
