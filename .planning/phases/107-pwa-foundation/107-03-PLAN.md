---
phase: 107-pwa-foundation
plan: 03
type: execute
wave: 2
depends_on: ["107-01", "107-02"]
files_modified:
  - src/components/ReloadPrompt.jsx
  - src/App.jsx
  - src/hooks/useTheme.js
autonomous: false

must_haves:
  truths:
    - "Service worker registers successfully on page load"
    - "Users see update notification when new version available"
    - "Theme color meta tag updates when user changes accent color"
    - "App is installable on Android (shows install prompt)"
  artifacts:
    - path: "src/components/ReloadPrompt.jsx"
      provides: "SW update prompt UI"
      contains: "useRegisterSW"
      min_lines: 30
    - path: "src/App.jsx"
      provides: "ReloadPrompt integration"
      contains: "ReloadPrompt"
    - path: "src/hooks/useTheme.js"
      provides: "Dynamic theme-color meta tag update"
      contains: "theme-color"
  key_links:
    - from: "src/App.jsx"
      to: "src/components/ReloadPrompt.jsx"
      via: "import and render"
      pattern: "import.*ReloadPrompt"
    - from: "src/hooks/useTheme.js"
      to: "document meta theme-color"
      via: "querySelector and content update"
      pattern: "meta.*theme-color"
---

<objective>
Create the ReloadPrompt component for service worker updates, integrate it into App.jsx, and add dynamic theme-color meta tag updates to useTheme hook.

Purpose: Complete the PWA foundation by enabling update prompts when new versions are available and making the theme color dynamic based on user's accent color preference.

Output: Working ReloadPrompt component, integrated into App, with dynamic theme color that matches user's accent setting.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/107-pwa-foundation/107-RESEARCH.md
@.planning/phases/107-pwa-foundation/107-CONTEXT.md
@src/App.jsx
@src/hooks/useTheme.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ReloadPrompt component for SW updates</name>
  <files>
    - src/components/ReloadPrompt.jsx
  </files>
  <action>
Create src/components/ReloadPrompt.jsx using the useRegisterSW hook from vite-plugin-pwa.

```jsx
import { useRegisterSW } from 'virtual:pwa-register/react';
import { RefreshCw, X, CheckCircle } from 'lucide-react';

/**
 * ReloadPrompt - Shows notifications for PWA updates and offline readiness
 *
 * Uses vite-plugin-pwa's useRegisterSW hook to:
 * - Register the service worker
 * - Detect when a new version is available
 * - Allow users to trigger update (reload)
 * - Show "ready for offline" notification
 */
export function ReloadPrompt() {
  const {
    offlineReady: [offlineReady, setOfflineReady],
    needRefresh: [needRefresh, setNeedRefresh],
    updateServiceWorker
  } = useRegisterSW({
    onRegistered(registration) {
      // SW registered successfully
      console.log('SW Registered:', registration);
    },
    onRegisterError(error) {
      console.error('SW registration error:', error);
    }
  });

  const close = () => {
    setOfflineReady(false);
    setNeedRefresh(false);
  };

  // Don't render anything if no notification needed
  if (!offlineReady && !needRefresh) {
    return null;
  }

  return (
    <div className="fixed bottom-4 right-4 z-50 max-w-sm">
      {/* Offline ready notification */}
      {offlineReady && (
        <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 p-4 flex items-start gap-3">
          <div className="flex-shrink-0">
            <CheckCircle className="w-5 h-5 text-green-500" />
          </div>
          <div className="flex-1 min-w-0">
            <p className="text-sm font-medium text-gray-900 dark:text-gray-100">
              Ready for offline use
            </p>
            <p className="text-sm text-gray-500 dark:text-gray-400">
              Stadion can now work offline
            </p>
          </div>
          <button
            onClick={close}
            className="flex-shrink-0 p-1 text-gray-400 hover:text-gray-500 dark:hover:text-gray-300"
            aria-label="Dismiss"
          >
            <X className="w-4 h-4" />
          </button>
        </div>
      )}

      {/* Update available notification */}
      {needRefresh && (
        <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-accent-200 dark:border-accent-700 p-4">
          <div className="flex items-start gap-3">
            <div className="flex-shrink-0">
              <RefreshCw className="w-5 h-5 text-accent-600 dark:text-accent-400" />
            </div>
            <div className="flex-1 min-w-0">
              <p className="text-sm font-medium text-gray-900 dark:text-gray-100">
                Update available
              </p>
              <p className="text-sm text-gray-500 dark:text-gray-400">
                A new version of Stadion is ready
              </p>
            </div>
          </div>
          <div className="mt-3 flex gap-2 justify-end">
            <button
              onClick={close}
              className="px-3 py-1.5 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200"
            >
              Later
            </button>
            <button
              onClick={() => updateServiceWorker(true)}
              className="px-3 py-1.5 text-sm bg-accent-600 text-white rounded-md hover:bg-accent-700 focus:outline-none focus:ring-2 focus:ring-accent-500 focus:ring-offset-2"
            >
              Reload now
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

export default ReloadPrompt;
```

Key points:
- Uses virtual:pwa-register/react module from vite-plugin-pwa
- Matches existing app styling (card, colors, dark mode)
- Uses lucide-react icons (already in project)
- Fixed positioning bottom-right, doesn't interfere with content
- Two states: offlineReady (dismissable) and needRefresh (with reload button)
  </action>
  <verify>
    test -f src/components/ReloadPrompt.jsx
    grep -q "useRegisterSW" src/components/ReloadPrompt.jsx
    grep -q "virtual:pwa-register/react" src/components/ReloadPrompt.jsx
  </verify>
  <done>
    ReloadPrompt.jsx exists with useRegisterSW integration and styled UI
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ReloadPrompt into App.jsx</name>
  <files>
    - src/App.jsx
  </files>
  <action>
Update src/App.jsx to import and render the ReloadPrompt component.

1. Add import at top with other component imports:
   ```jsx
   import { ReloadPrompt } from '@/components/ReloadPrompt';
   ```

2. Add ReloadPrompt inside the app-root div, after UpdateBanner:
   ```jsx
   function App() {
     // Initialize theme on app mount (applies dark class and accent color)
     useTheme();

     return (
       <div className="app-root">
         <UpdateBanner />
         <ReloadPrompt />
         <Routes>
           {/* ... routes ... */}
         </Routes>
       </div>
     );
   }
   ```

Note: ReloadPrompt and UpdateBanner serve different purposes:
- UpdateBanner: Checks backend for new version (manifest.json build time)
- ReloadPrompt: Handles service worker lifecycle (offline ready, SW updates)

Both can coexist. In the future, consider consolidating them, but for now keep both for different update scenarios (server-side vs SW updates).
  </action>
  <verify>
    grep -q "import.*ReloadPrompt" src/App.jsx
    grep -q "<ReloadPrompt" src/App.jsx
  </verify>
  <done>
    App.jsx imports and renders ReloadPrompt component
  </done>
</task>

<task type="auto">
  <name>Task 3: Add dynamic theme-color meta tag update to useTheme</name>
  <files>
    - src/hooks/useTheme.js
  </files>
  <action>
Update src/hooks/useTheme.js to also update the theme-color meta tags when accent color changes.

1. Add ACCENT_HEX_DARK object for dark mode variants (Tailwind -600 values):
   ```javascript
   const ACCENT_HEX_DARK = {
     orange: '#ea580c',
     teal: '#0d9488',
     indigo: '#4f46e5',
     emerald: '#059669',
     violet: '#7c3aed',
     pink: '#db2777',
     fuchsia: '#c026d3',
     rose: '#e11d48',
   };
   ```

2. Add a new function to update theme-color meta tags:
   ```javascript
   /**
    * Update theme-color meta tags for PWA
    * These control the browser/OS chrome color on mobile
    * @param {string} accentColor - The accent color name
    */
   function updateThemeColorMeta(accentColor) {
     if (typeof document === 'undefined') return;

     const lightHex = ACCENT_HEX[accentColor] || ACCENT_HEX.orange;
     const darkHex = ACCENT_HEX_DARK[accentColor] || ACCENT_HEX_DARK.orange;

     // Update light mode theme-color
     const lightMeta = document.querySelector('meta[name="theme-color"][media*="light"]');
     if (lightMeta) {
       lightMeta.content = lightHex;
     }

     // Update dark mode theme-color
     const darkMeta = document.querySelector('meta[name="theme-color"][media*="dark"]');
     if (darkMeta) {
       darkMeta.content = darkHex;
     }
   }
   ```

3. Call updateThemeColorMeta from within applyTheme function:
   ```javascript
   function applyTheme(effectiveColorScheme, accentColor) {
     if (typeof document === 'undefined') return;

     const root = document.documentElement;

     // Apply dark mode class
     if (effectiveColorScheme === 'dark') {
       root.classList.add('dark');
     } else {
       root.classList.remove('dark');
     }

     // Apply accent color via data attribute
     root.setAttribute('data-accent', accentColor);

     // Update favicon to match accent color
     updateFavicon(accentColor);

     // Update theme-color meta tags for PWA
     updateThemeColorMeta(accentColor);
   }
   ```

This ensures that when users change their accent color in Settings, the browser chrome / title bar color also updates to match.
  </action>
  <verify>
    grep -q "updateThemeColorMeta" src/hooks/useTheme.js
    grep -q "ACCENT_HEX_DARK" src/hooks/useTheme.js
    grep -q "theme-color" src/hooks/useTheme.js
  </verify>
  <done>
    useTheme.js updates theme-color meta tags when accent color changes
  </done>
</task>

</tasks>

<verification>
Run these checks after all tasks complete:

1. **ReloadPrompt component exists:**
   ```bash
   test -f src/components/ReloadPrompt.jsx && echo "ReloadPrompt exists"
   ```

2. **App.jsx integrates ReloadPrompt:**
   ```bash
   grep -q "ReloadPrompt" src/App.jsx && echo "ReloadPrompt integrated"
   ```

3. **useTheme updates theme-color:**
   ```bash
   grep -q "updateThemeColorMeta" src/hooks/useTheme.js && echo "Theme color update added"
   ```

4. **Build still works:**
   ```bash
   npm run build && echo "Build successful"
   ```

5. **Lint passes:**
   ```bash
   npm run lint
   ```
</verification>

<success_criteria>
- src/components/ReloadPrompt.jsx exists with useRegisterSW hook
- App.jsx imports and renders ReloadPrompt
- useTheme.js has updateThemeColorMeta function
- useTheme.js calls updateThemeColorMeta in applyTheme
- npm run build succeeds
- npm run lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/107-pwa-foundation/107-03-SUMMARY.md`
</output>
