---
phase: 107-pwa-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - index.php
  - functions.php
  - src/index.css
autonomous: true

must_haves:
  truths:
    - "iOS Add to Home Screen shows proper app icon and name"
    - "App launches in standalone mode (no Safari chrome)"
    - "Content displays correctly on iPhone X+ (not hidden behind notch)"
    - "Theme color meta tag matches accent color"
  artifacts:
    - path: "index.php"
      provides: "viewport-fit=cover for safe areas"
      contains: "viewport-fit=cover"
    - path: "functions.php"
      provides: "PWA meta tags via wp_head action"
      contains: "apple-mobile-web-app-capable"
    - path: "src/index.css"
      provides: "Safe area padding using env()"
      contains: "safe-area-inset"
  key_links:
    - from: "functions.php"
      to: "index.php wp_head()"
      via: "add_action wp_head hook"
      pattern: "stadion_pwa_meta_tags"
    - from: "src/index.css"
      to: "index.php viewport meta"
      via: "viewport-fit=cover enables env() values"
      pattern: "env\\(safe-area-inset"
---

<objective>
Add iOS-specific PWA meta tags and safe area CSS to enable proper Add to Home Screen functionality and handle notch/Dynamic Island display.

Purpose: Make Stadion installable on iOS with correct splash screen, icon, status bar styling, and ensure content never appears under the notch.

Output: iOS PWA meta tags in wp_head, updated viewport meta tag, and safe area CSS for notch handling.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/107-pwa-foundation/107-RESEARCH.md
@.planning/phases/107-pwa-foundation/107-CONTEXT.md
@index.php
@functions.php
@src/index.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update viewport meta tag for safe area support</name>
  <files>
    - index.php
  </files>
  <action>
Update the viewport meta tag in index.php to include viewport-fit=cover.

This is REQUIRED for CSS env(safe-area-inset-*) to work on iOS.

Change from:
```html
<meta name="viewport" content="width=device-width, initial-scale=1.0">
```

To:
```html
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
```

The viewport-fit=cover tells iOS to extend content to the edges (behind notch/Dynamic Island), then we use CSS env() to add padding back.
  </action>
  <verify>
    grep -q "viewport-fit=cover" index.php
  </verify>
  <done>
    index.php viewport meta tag includes viewport-fit=cover
  </done>
</task>

<task type="auto">
  <name>Task 2: Add PWA meta tags via PHP wp_head action</name>
  <files>
    - functions.php
  </files>
  <action>
Add a new function to functions.php that outputs PWA meta tags via wp_head action.

Add this function near other head-related functions (around line 565, after stadion_theme_add_config_to_head):

```php
/**
 * Output PWA meta tags for iOS and Android support
 *
 * vite-plugin-pwa handles manifest generation, but we need to manually
 * inject meta tags since WordPress uses PHP templates, not index.html.
 */
function stadion_pwa_meta_tags() {
    $theme_url = RONDO_THEME_URL;
    ?>
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Stadion">

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="<?php echo esc_url( $theme_url . '/public/icons/apple-touch-icon-180x180.png' ); ?>">

    <!-- Manifest -->
    <link rel="manifest" href="<?php echo esc_url( $theme_url . '/dist/manifest.webmanifest' ); ?>">

    <!-- Theme Color (default orange, React will update dynamically) -->
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f97316">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#ea580c">
    <?php
}
add_action( 'wp_head', 'stadion_pwa_meta_tags', 2 );
```

Key points:
- Use priority 2 (after config at 0, but early in head)
- apple-mobile-web-app-status-bar-style: "default" for dark text on light backgrounds (per CONTEXT.md)
- Two theme-color meta tags with media queries for light/dark mode support
- Manifest link points to dist/manifest.webmanifest (generated by vite-plugin-pwa)
- Apple touch icon points to public/icons/ (not dist/)
  </action>
  <verify>
    grep -q "stadion_pwa_meta_tags" functions.php
    grep -q "apple-mobile-web-app-capable" functions.php
    grep -q "manifest.webmanifest" functions.php
  </verify>
  <done>
    functions.php has stadion_pwa_meta_tags function hooked to wp_head
  </done>
</task>

<task type="auto">
  <name>Task 3: Add safe area CSS for notch/Dynamic Island handling</name>
  <files>
    - src/index.css
  </files>
  <action>
Add safe area CSS to src/index.css to handle iPhone notch and Dynamic Island.

Add these styles in the @layer base section (after the body styles, around line 13):

```css
  /* iOS Safe Area - handle notch and Dynamic Island */
  html {
    /* Extend background color behind safe areas */
    min-height: calc(100% + env(safe-area-inset-top));
  }

  /* Apply safe area padding to main content containers */
  /* The Layout component and fixed elements need this */
  .safe-top {
    padding-top: env(safe-area-inset-top);
  }
  .safe-bottom {
    padding-bottom: env(safe-area-inset-bottom);
  }
  .safe-left {
    padding-left: env(safe-area-inset-left);
  }
  .safe-right {
    padding-right: env(safe-area-inset-right);
  }
  .safe-x {
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
  }
  .safe-y {
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
  }
  .safe-all {
    padding-top: env(safe-area-inset-top);
    padding-right: env(safe-area-inset-right);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
  }
```

Then update the body styles to add horizontal safe area padding (for landscape mode on notched devices):

Change:
```css
  body {
    @apply bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100;
  }
```

To:
```css
  body {
    @apply bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100;
    /* Apply safe area padding for iOS standalone mode */
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
  }
```

Note: We apply horizontal padding to body globally. Vertical (top) padding will be applied at the Layout/header component level to avoid double-padding issues.

The env() values are 0 on non-iOS devices and in Safari browser, so this has no effect outside iOS standalone mode.
  </action>
  <verify>
    grep -q "safe-area-inset" src/index.css
    grep -q "env(safe-area-inset-left)" src/index.css
  </verify>
  <done>
    src/index.css includes safe area CSS utilities and body padding
  </done>
</task>

</tasks>

<verification>
Run these checks after all tasks complete:

1. **Viewport meta updated:**
   ```bash
   grep "viewport-fit=cover" index.php
   ```

2. **PWA meta tags function exists:**
   ```bash
   grep -A 20 "function stadion_pwa_meta_tags" functions.php
   ```

3. **Safe area CSS added:**
   ```bash
   grep "safe-area-inset" src/index.css
   ```

4. **Build still works:**
   ```bash
   npm run build && echo "Build successful"
   ```

5. **Lint passes:**
   ```bash
   npm run lint
   ```
</verification>

<success_criteria>
- index.php has viewport-fit=cover in viewport meta tag
- functions.php has stadion_pwa_meta_tags function outputting iOS meta tags
- functions.php links to manifest.webmanifest and apple-touch-icon
- src/index.css has safe area utility classes (.safe-top, .safe-bottom, etc.)
- src/index.css body has horizontal safe area padding
- npm run build succeeds
- npm run lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/107-pwa-foundation/107-02-SUMMARY.md`
</output>
