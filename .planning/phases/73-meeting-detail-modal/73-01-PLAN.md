---
phase: 73-meeting-detail-modal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-calendar.php
  - src/api/client.js
  - src/hooks/useMeetings.js
autonomous: true

must_haves:
  truths:
    - "API returns both matched and unmatched attendees for meetings"
    - "API returns meeting description from post_content"
    - "API allows saving and retrieving meeting notes per event"
  artifacts:
    - path: "includes/class-rest-calendar.php"
      provides: "Extended meeting responses with attendees array and notes endpoints"
      contains: "_meeting_notes"
  key_links:
    - from: "src/hooks/useMeetings.js"
      to: "/prm/v1/calendar/events/{id}/notes"
      via: "useMeetingNotes hook"
      pattern: "getMeetingNotes|updateMeetingNotes"
---

<objective>
Extend the calendar API to return complete attendee information (both matched and unmatched) and add meeting notes CRUD functionality.

Purpose: The Meeting Detail Modal (Plan 02) needs full attendee data to display who's known vs unknown, and needs to persist meeting prep notes.

Output:
- Extended format_today_meeting() with attendees array containing matched status
- GET/PUT endpoints for meeting notes stored in post meta
- React hooks for fetching/updating meeting notes
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/73-meeting-detail-modal/73-RESEARCH.md

Key files:
@includes/class-rest-calendar.php (format_today_meeting, get_today_meetings)
@src/api/client.js (prmApi methods)
@src/hooks/useMeetings.js (meetingsKeys, useTodayMeetings)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend meeting API response with full attendee list</name>
  <files>includes/class-rest-calendar.php</files>
  <action>
In class-rest-calendar.php, modify the `format_today_meeting()` method to include a new `attendees` array that contains ALL attendees with their matched status.

Add after getting `$matched_people` (around line 1220):

```php
// Get raw attendees and enrich with match status
$attendees_json = get_post_meta( $event->ID, '_attendees', true );
$raw_attendees = $attendees_json ? json_decode( $attendees_json, true ) : [];
$attendees = [];

if ( is_array( $raw_attendees ) ) {
    // Build email lookup for matched people
    $matched_emails = [];
    if ( is_array( $matched_people_raw ) ) {
        foreach ( $matched_people_raw as $match ) {
            $email = strtolower( $match['attendee_email'] ?? '' );
            if ( $email ) {
                $matched_emails[$email] = $match;
            }
        }
    }

    foreach ( $raw_attendees as $attendee ) {
        $email = strtolower( $attendee['email'] ?? '' );
        $match = $matched_emails[$email] ?? null;

        $attendee_data = [
            'email' => $attendee['email'] ?? '',
            'name' => $attendee['name'] ?? '',
            'status' => $attendee['status'] ?? '',
            'matched' => $match !== null,
        ];

        if ( $match ) {
            $person_id = $match['person_id'] ?? 0;
            $attendee_data['person_id'] = $person_id;
            $attendee_data['person_name'] = get_the_title( $person_id );

            // Get person thumbnail
            $featured_image_id = get_post_thumbnail_id( $person_id );
            $attendee_data['thumbnail'] = $featured_image_id
                ? wp_get_attachment_image_url( $featured_image_id, 'thumbnail' )
                : null;
        }

        $attendees[] = $attendee_data;
    }
}
```

Add these fields to the return array:
- 'attendees' => $attendees,
- 'description' => $event->post_content, (already available from post object)

Sort attendees with matched first, then alphabetically by name.
  </action>
  <verify>
Test via WP REST API:
```bash
curl -s "https://cael.is/wp-json/prm/v1/calendar/today-meetings" -H "Cookie: [auth]" | jq '.meetings[0].attendees'
```
Should return array with email, name, status, matched (boolean), and for matched attendees: person_id, person_name, thumbnail.
  </verify>
  <done>format_today_meeting returns attendees array with matched/unmatched distinction and description field</done>
</task>

<task type="auto">
  <name>Task 2: Add meeting notes REST endpoints</name>
  <files>includes/class-rest-calendar.php</files>
  <action>
Register two new routes in `register_routes()`:

```php
// GET /prm/v1/calendar/events/(?P<id>\d+)/notes - Get meeting notes
register_rest_route(
    'prm/v1',
    '/calendar/events/(?P<id>\d+)/notes',
    [
        'methods'             => \WP_REST_Server::READABLE,
        'callback'            => [ $this, 'get_meeting_notes' ],
        'permission_callback' => [ $this, 'check_user_approved' ],
        'args'                => [
            'id' => [
                'required'          => true,
                'type'              => 'integer',
                'validate_callback' => function ( $param ) {
                    return is_numeric( $param );
                },
            ],
        ],
    ]
);

// PUT /prm/v1/calendar/events/(?P<id>\d+)/notes - Update meeting notes
register_rest_route(
    'prm/v1',
    '/calendar/events/(?P<id>\d+)/notes',
    [
        'methods'             => \WP_REST_Server::EDITABLE,
        'callback'            => [ $this, 'update_meeting_notes' ],
        'permission_callback' => [ $this, 'check_user_approved' ],
        'args'                => [
            'id' => [
                'required'          => true,
                'type'              => 'integer',
                'validate_callback' => function ( $param ) {
                    return is_numeric( $param );
                },
            ],
            'notes' => [
                'required'          => true,
                'type'              => 'string',
                'sanitize_callback' => 'wp_kses_post',
            ],
        ],
    ]
);
```

Add callback methods:

```php
/**
 * Get meeting notes for a calendar event
 *
 * @param WP_REST_Request $request The REST request object.
 * @return WP_REST_Response|WP_Error Response with notes or error.
 */
public function get_meeting_notes( $request ) {
    $event_id = absint( $request->get_param( 'id' ) );
    $user_id = get_current_user_id();

    // Get and verify the event
    $event = get_post( $event_id );
    if ( ! $event || $event->post_type !== 'calendar_event' ) {
        return new \WP_Error( 'not_found', __( 'Event not found.', 'caelis' ), [ 'status' => 404 ] );
    }

    // Verify ownership
    if ( (int) $event->post_author !== $user_id ) {
        return new \WP_Error( 'forbidden', __( 'You do not have permission to view this event.', 'caelis' ), [ 'status' => 403 ] );
    }

    $notes = get_post_meta( $event_id, '_meeting_notes', true );

    return rest_ensure_response( [
        'notes' => $notes ?: '',
    ] );
}

/**
 * Update meeting notes for a calendar event
 *
 * @param WP_REST_Request $request The REST request object.
 * @return WP_REST_Response|WP_Error Response with success or error.
 */
public function update_meeting_notes( $request ) {
    $event_id = absint( $request->get_param( 'id' ) );
    $user_id = get_current_user_id();
    $notes = $request->get_param( 'notes' );

    // Get and verify the event
    $event = get_post( $event_id );
    if ( ! $event || $event->post_type !== 'calendar_event' ) {
        return new \WP_Error( 'not_found', __( 'Event not found.', 'caelis' ), [ 'status' => 404 ] );
    }

    // Verify ownership
    if ( (int) $event->post_author !== $user_id ) {
        return new \WP_Error( 'forbidden', __( 'You do not have permission to edit this event.', 'caelis' ), [ 'status' => 403 ] );
    }

    update_post_meta( $event_id, '_meeting_notes', $notes );

    return rest_ensure_response( [
        'success' => true,
        'message' => __( 'Notes saved.', 'caelis' ),
    ] );
}
```
  </action>
  <verify>
Test GET:
```bash
curl -s "https://cael.is/wp-json/prm/v1/calendar/events/123/notes" -H "Cookie: [auth]"
```
Should return { "notes": "" } for new event.

Test PUT:
```bash
curl -X PUT "https://cael.is/wp-json/prm/v1/calendar/events/123/notes" \
  -H "Cookie: [auth]" -H "Content-Type: application/json" \
  -d '{"notes": "<p>Meeting prep notes</p>"}'
```
Should return { "success": true, "message": "Notes saved." }
  </verify>
  <done>GET and PUT /prm/v1/calendar/events/{id}/notes endpoints working with proper auth</done>
</task>

<task type="auto">
  <name>Task 3: Add React API client methods and hooks</name>
  <files>src/api/client.js, src/hooks/useMeetings.js</files>
  <action>
In src/api/client.js, add to prmApi object:

```javascript
// Meeting notes
getMeetingNotes: (eventId) => prmClient.get(`/calendar/events/${eventId}/notes`),
updateMeetingNotes: (eventId, notes) => prmClient.put(`/calendar/events/${eventId}/notes`, { notes }),
```

In src/hooks/useMeetings.js, add query key and hooks:

```javascript
export const meetingsKeys = {
  all: ['meetings'],
  today: ['meetings', 'today'],
  person: (personId) => ['person-meetings', personId],
  notes: (eventId) => ['meeting-notes', eventId], // Add this
};

/**
 * Hook to fetch meeting notes for a specific event
 *
 * @param {number} eventId - The calendar event ID
 * @returns {Object} TanStack Query result with { notes }
 */
export function useMeetingNotes(eventId) {
  return useQuery({
    queryKey: meetingsKeys.notes(eventId),
    queryFn: async () => {
      const response = await prmApi.getMeetingNotes(eventId);
      return response.data;
    },
    enabled: !!eventId,
  });
}

/**
 * Hook to update meeting notes for a specific event
 *
 * @returns {Object} TanStack Query mutation object
 */
export function useUpdateMeetingNotes() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ eventId, notes }) => prmApi.updateMeetingNotes(eventId, notes),
    onSuccess: (data, variables) => {
      // Invalidate the notes query for this event
      queryClient.invalidateQueries({ queryKey: meetingsKeys.notes(variables.eventId) });
    },
  });
}
```
  </action>
  <verify>
Build passes:
```bash
cd /Users/joostdevalk/Code/caelis && npm run build
```
No TypeScript/ESLint errors related to new hooks.
  </verify>
  <done>prmApi has getMeetingNotes/updateMeetingNotes methods, useMeetings.js exports useMeetingNotes and useUpdateMeetingNotes hooks</done>
</task>

</tasks>

<verification>
1. Build: `npm run build` passes
2. API test: Today's meetings endpoint returns attendees array with matched boolean
3. API test: Notes GET/PUT endpoints work with proper authentication
4. Frontend: New hooks are importable and have correct query keys
</verification>

<success_criteria>
- format_today_meeting() returns attendees[] with matched/unmatched distinction
- format_today_meeting() returns description from post_content
- GET /prm/v1/calendar/events/{id}/notes returns stored notes
- PUT /prm/v1/calendar/events/{id}/notes saves notes to _meeting_notes meta
- useMeetingNotes hook fetches notes for an event
- useUpdateMeetingNotes hook saves notes with cache invalidation
</success_criteria>

<output>
After completion, create `.planning/phases/73-meeting-detail-modal/73-01-SUMMARY.md`
</output>
