---
phase: 127.1-nikki-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-wp-cli.php
autonomous: true

must_haves:
  truths:
    - "WP-CLI command `wp stadion nikki import <file>` exists and accepts SQLite file path"
    - "Command matches Nikki relatiecode to persons via knvb-id field"
    - "Command stores _nikki_{year}_total and _nikki_{year}_saldo in person meta"
    - "Command reports matched count, unmatched count, and skipped records"
    - "Command supports --year and --dry-run options"
  artifacts:
    - path: "includes/class-wp-cli.php"
      provides: "RONDO_Nikki_CLI_Command class with import subcommand"
      contains: "class RONDO_Nikki_CLI_Command"
  key_links:
    - from: "RONDO_Nikki_CLI_Command::import()"
      to: "PDO SQLite"
      via: "new PDO('sqlite:' . $db_path)"
      pattern: "new.*PDO.*sqlite"
    - from: "RONDO_Nikki_CLI_Command::import()"
      to: "person post meta"
      via: "update_post_meta with _nikki_{year}_total"
      pattern: "update_post_meta.*_nikki_"
---

<objective>
Create WP-CLI command to import Nikki contribution data from SQLite database

Purpose: Automate import of external contribution tracking data into WordPress for comparison with calculated fees
Output: RONDO_Nikki_CLI_Command class with `import` subcommand that reads SQLite, matches records by KNVB ID, and stores in person meta
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/127.1-nikki-integration/127.1-RESEARCH.md

Key files:
@includes/class-wp-cli.php (add class at end, before closing WP_CLI check)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RONDO_Nikki_CLI_Command class</name>
  <files>includes/class-wp-cli.php</files>
  <action>
Add RONDO_Nikki_CLI_Command class BEFORE the final closing brace of the `if ( defined( 'WP_CLI' ) && WP_CLI )` block (around line 2810).

The class must have:

1. **import() method** with PHPDoc options block:
   - `<file>` - Required positional arg: Path to Nikki SQLite database
   - `[--year=<year>]` - Optional: Nikki year (defaults to current year e.g., 2025)
   - `[--dry-run]` - Optional: Preview without saving

2. **build_knvb_lookup() private method**:
   - Query all persons with non-empty `knvb-id` meta
   - Return array: `[ knvb_id_string => person_id ]`
   - Use direct $wpdb query for performance

3. **import() logic**:
   - Validate file exists, error if not
   - Open SQLite via PDO: `new \PDO('sqlite:' . $db_path)`
   - Query: `SELECT relatiecode, totaal, saldo FROM contributies WHERE jaar = :year`
   - Build KNVB lookup
   - For each Nikki record:
     - Trim relatiecode and lookup person_id
     - If found and not dry-run: `update_post_meta($person_id, '_nikki_' . $year . '_total', floatval($totaal))`
     - If found and not dry-run: `update_post_meta($person_id, '_nikki_' . $year . '_saldo', floatval($saldo))`
     - Track matched/unmatched counts
   - Log progress with WP_CLI::log()
   - Final summary with WP_CLI::success() or WP_CLI::warning()

4. **Register command** at bottom with other commands:
   `WP_CLI::add_command( 'stadion nikki', 'RONDO_Nikki_CLI_Command' );`

Important notes:
- Field name is `knvb-id` (with hyphen), not `relatiecode`
- Nikki column is `relatiecode`, matches to `knvb-id` field value
- Year defaults to current calendar year (date('Y'))
- Handle null/empty saldo as 0.0
- Use try/catch for PDO connection and query errors
- Log unmatched relatiecodes for debugging (first 10, then count)
  </action>
  <verify>
Check syntax: `php -l includes/class-wp-cli.php`
Check class exists: `grep -n "class RONDO_Nikki_CLI_Command" includes/class-wp-cli.php`
Check registration: `grep -n "stadion nikki" includes/class-wp-cli.php`
  </verify>
  <done>
RONDO_Nikki_CLI_Command class exists with import method, build_knvb_lookup method, and command registered
  </done>
</task>

<task type="auto">
  <name>Task 2: Test WP-CLI command on production</name>
  <files></files>
  <action>
1. Deploy to production: `bin/deploy.sh`

2. SSH to production and verify command is registered:
   ```bash
   source .env && ssh -p "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" \
     "cd ~/www/stadion.svawc.nl/public_html/wp-content/themes/stadion && wp stadion nikki --help"
   ```

3. Verify import subcommand help shows:
   - File argument documented
   - --year option documented
   - --dry-run option documented

4. If nikki.db is available, test with --dry-run:
   ```bash
   source .env && ssh -p "$DEPLOY_SSH_PORT" "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" \
     "cd ~/www/stadion.svawc.nl/public_html/wp-content/themes/stadion && wp stadion nikki import /path/to/nikki.db --dry-run --year=2025"
   ```
  </action>
  <verify>
WP-CLI help output shows `wp stadion nikki import` command with correct options
  </verify>
  <done>
Command registered and help output displays correctly on production
  </done>
</task>

</tasks>

<verification>
- [ ] `php -l includes/class-wp-cli.php` passes
- [ ] `grep "class RONDO_Nikki_CLI_Command" includes/class-wp-cli.php` finds class
- [ ] `grep "stadion nikki" includes/class-wp-cli.php` finds registration
- [ ] Production: `wp stadion nikki --help` shows command
- [ ] Production: `wp stadion nikki import --help` shows import subcommand options
</verification>

<success_criteria>
- WP-CLI command `wp stadion nikki import <file>` exists
- Command accepts --year and --dry-run options
- Command reads SQLite via PDO
- Command matches Nikki relatiecode to person knvb-id field
- Command stores _nikki_{year}_total and _nikki_{year}_saldo in person meta
- Command logs match statistics (matched, unmatched, total)
</success_criteria>

<output>
After completion, create `.planning/phases/127.1-nikki-integration/127.1-01-SUMMARY.md`
</output>
