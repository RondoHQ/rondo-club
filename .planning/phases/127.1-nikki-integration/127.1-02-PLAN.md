---
phase: 127.1-nikki-integration
plan: 02
type: execute
wave: 2
depends_on: ["127.1-01"]
files_modified:
  - includes/class-rest-api.php
  - src/pages/Contributie/ContributieList.jsx
autonomous: true

must_haves:
  truths:
    - "Contributie list shows Nikki Total column after Final Fee column"
    - "Contributie list shows Saldo (Outstanding) column after Nikki Total"
    - "All monetary values in Nikki columns display with 2 decimal places"
    - "Positive saldo displays in red (owes money), zero/null in green/gray"
    - "REST API /rondo/v1/fees returns nikki_total and nikki_saldo per member"
  artifacts:
    - path: "includes/class-rest-api.php"
      provides: "get_fee_list returns nikki_total and nikki_saldo fields"
      contains: "nikki_total"
    - path: "src/pages/Contributie/ContributieList.jsx"
      provides: "Two new columns for Nikki data"
      contains: "nikki_total"
  key_links:
    - from: "ContributieList.jsx"
      to: "/rondo/v1/fees"
      via: "useFeeList hook"
      pattern: "member\\.nikki_"
    - from: "get_fee_list()"
      to: "person post meta"
      via: "get_post_meta with _nikki_{year}_total"
      pattern: "get_post_meta.*_nikki_"
---

<objective>
Extend REST API and Contributie list UI to display Nikki contribution data

Purpose: Allow users to compare calculated fees with actual Nikki contributions and see outstanding balances
Output: Two new columns (Nikki Total, Saldo) in Contributie list with proper currency formatting
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/127.1-nikki-integration/127.1-RESEARCH.md
@.planning/phases/127.1-nikki-integration/127.1-01-SUMMARY.md

Key files:
@includes/class-rest-api.php (get_fee_list method around line 2570)
@src/pages/Contributie/ContributieList.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend REST API to return Nikki data</name>
  <files>includes/class-rest-api.php</files>
  <action>
In the `get_fee_list()` method (around line 2570-2646), add Nikki data to each result:

1. Before the foreach loop (after getting $season), calculate Nikki year:
   ```php
   // Nikki year = first 4 chars of season (2025-2026 => 2025)
   $nikki_year = substr( $season, 0, 4 );
   ```

2. Inside the foreach loop, after building the $results[] array entry (around line 2622), add two new fields to the array:
   ```php
   // Add Nikki data
   $nikki_total = get_post_meta( $person->ID, '_nikki_' . $nikki_year . '_total', true );
   $nikki_saldo = get_post_meta( $person->ID, '_nikki_' . $nikki_year . '_saldo', true );

   $results[] = [
       // ... existing fields ...
       'nikki_total'    => $nikki_total !== '' ? (float) $nikki_total : null,
       'nikki_saldo'    => $nikki_saldo !== '' ? (float) $nikki_saldo : null,
   ];
   ```

Note: Return null (not 0) when meta is empty, so UI can distinguish "no data" from "zero balance".
  </action>
  <verify>
Check syntax: `php -l includes/class-rest-api.php`
Check fields added: `grep -n "nikki_total\|nikki_saldo" includes/class-rest-api.php`
  </verify>
  <done>
get_fee_list() returns nikki_total and nikki_saldo for each member
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Nikki columns to ContributieList UI</name>
  <files>src/pages/Contributie/ContributieList.jsx</files>
  <action>
Extend the ContributieList.jsx to show Nikki Total and Saldo columns:

1. **Update formatCurrency function** to accept optional decimals parameter:
   ```javascript
   function formatCurrency(amount, decimals = 0) {
     if (amount === null || amount === undefined) return '-';
     return new Intl.NumberFormat('nl-NL', {
       style: 'currency',
       currency: 'EUR',
       minimumFractionDigits: decimals,
       maximumFractionDigits: decimals,
     }).format(amount);
   }
   ```

2. **Add two new columns to FeeRow component** after the Final Fee column (after line 129):
   ```jsx
   {/* Nikki Total */}
   <td className="px-4 py-3 text-sm text-right">
     {member.nikki_total !== null ? (
       <span className="text-gray-700 dark:text-gray-300">
         {formatCurrency(member.nikki_total, 2)}
       </span>
     ) : (
       <span className="text-gray-400 dark:text-gray-500">-</span>
     )}
   </td>

   {/* Saldo (Outstanding) */}
   <td className="px-4 py-3 text-sm text-right">
     {member.nikki_saldo !== null ? (
       <span className={member.nikki_saldo > 0
         ? 'text-red-600 dark:text-red-400 font-medium'
         : 'text-green-600 dark:text-green-400'
       }>
         {formatCurrency(member.nikki_saldo, 2)}
       </span>
     ) : (
       <span className="text-gray-400 dark:text-gray-500">-</span>
     )}
   </td>
   ```

3. **Add column headers** in the thead (after the "Bedrag" SortableHeader, around line 309):
   ```jsx
   <th
     scope="col"
     className="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider bg-gray-50 dark:bg-gray-800"
   >
     Nikki
   </th>
   <th
     scope="col"
     className="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider bg-gray-50 dark:bg-gray-800"
   >
     Saldo
   </th>
   ```

4. **Update tfoot colspan** to account for 2 new columns:
   - Change `colSpan="3"` to `colSpan="3"` (first cell stays same)
   - Change `colSpan="2"` (empty spacer) to `colSpan="4"` to account for 2 new columns after final fee

5. **Update totals calculation** to include Nikki totals:
   ```javascript
   const totals = sortedMembers.reduce(
     (acc, m) => ({
       baseFee: acc.baseFee + m.base_fee,
       finalFee: acc.finalFee + m.final_fee,
       nikkiTotal: acc.nikkiTotal + (m.nikki_total || 0),
       nikkiSaldo: acc.nikkiSaldo + (m.nikki_saldo || 0),
     }),
     { baseFee: 0, finalFee: 0, nikkiTotal: 0, nikkiSaldo: 0 }
   );
   ```

6. **Add totals in tfoot** for Nikki columns:
   ```jsx
   <td className="px-4 py-3 text-sm text-gray-500 dark:text-gray-400 text-right">
     {formatCurrency(totals.nikkiTotal, 2)}
   </td>
   <td className="px-4 py-3 text-sm font-medium text-right">
     <span className={totals.nikkiSaldo > 0
       ? 'text-red-600 dark:text-red-400'
       : 'text-green-600 dark:text-green-400'
     }>
       {formatCurrency(totals.nikkiSaldo, 2)}
     </span>
   </td>
   ```
  </action>
  <verify>
Check build: `npm run build`
Check lint: `npm run lint`
Check columns: `grep -n "nikki_total\|nikki_saldo\|Nikki\|Saldo" src/pages/Contributie/ContributieList.jsx`
  </verify>
  <done>
ContributieList shows Nikki Total and Saldo columns with 2-decimal currency formatting
  </done>
</task>

<task type="auto">
  <name>Task 3: Deploy and verify</name>
  <files></files>
  <action>
1. Build frontend: `npm run build`
2. Deploy to production: `bin/deploy.sh`
3. Test REST API returns new fields:
   ```bash
   source .env && curl -s "${DEPLOY_PRODUCTION_URL}/wp-json/rondo/v1/fees" -H "Cookie: ..." | jq '.members[0] | {nikki_total, nikki_saldo}'
   ```
4. Verify Contributie page shows new columns at production URL
  </action>
  <verify>
REST API returns nikki_total and nikki_saldo fields
Contributie list displays two new columns with correct headers
  </verify>
  <done>
Nikki columns visible in Contributie list with proper formatting
  </done>
</task>

</tasks>

<verification>
- [ ] `php -l includes/class-rest-api.php` passes
- [ ] `npm run build` succeeds
- [ ] `npm run lint` passes (max-warnings: 0)
- [ ] REST API /fees endpoint returns nikki_total and nikki_saldo
- [ ] Contributie list shows "Nikki" and "Saldo" column headers
- [ ] Nikki values display with 2 decimal places (e.g., EUR 127,50)
- [ ] Positive saldo values show in red
- [ ] Zero/negative saldo values show in green
- [ ] Null/missing values show dash (-)
- [ ] Footer totals include Nikki columns
</verification>

<success_criteria>
- REST API returns nikki_total and nikki_saldo for each member
- Contributie list displays Nikki Total column after Final Fee
- Contributie list displays Saldo column after Nikki Total
- All monetary values display with 2 decimal places
- Positive saldo (owes money) displays in red
- Zero/null saldo displays in green/gray
- Footer shows column totals
</success_criteria>

<output>
After completion, create `.planning/phases/127.1-nikki-integration/127.1-02-SUMMARY.md`
</output>
