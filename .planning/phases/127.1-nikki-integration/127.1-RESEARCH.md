# Phase 127.1: Nikki Integration - Research

**Researched:** 2026-02-01
**Domain:** WP-CLI SQLite import, WordPress post meta storage, React table columns
**Confidence:** HIGH

## Summary

This phase adds integration with Nikki, an external contribution tracking system that stores data in SQLite. The implementation requires: (1) A WP-CLI command to import Nikki SQLite data, (2) matching Nikki records to existing Stadion persons via the `knvb-id` ACF field (relatiecode), (3) storing Nikki data in person post meta, and (4) displaying Nikki columns in the Contributie list.

The codebase has well-established patterns for all components: WP-CLI commands follow the RONDO_*_CLI_Command pattern with PHPDoc-style options, post meta storage follows the `_prefix_year_field` pattern, and the ContributieList.jsx component already displays fee columns that can be extended. The `knvb-id` field exists on person posts and is used for Sportlink integration.

The key technical challenge is reading an external SQLite file from WP-CLI. PHP 8.1+ supports PDO SQLite with file URI mode, allowing read-only access via `sqlite:file:/path/to/db?mode=ro`. The Nikki year-to-season mapping (2025 = season 2025-2026) aligns with the existing season key format.

**Primary recommendation:** Create RONDO_Nikki_CLI_Command class with an `import` subcommand that reads SQLite via PDO, matches records by KNVB ID, stores data in `_nikki_{year}_total` and `_nikki_{year}_saldo` meta keys, then extend the fees REST endpoint and ContributieList to display the new columns.

## Standard Stack

The established libraries/tools for this domain:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| PHP PDO SQLite | PHP 8.0+ | Read external SQLite database | Built-in, no dependencies needed |
| WordPress Post Meta | Core | Store Nikki data per person | Native storage, indexed, follows existing patterns |
| WP-CLI | 2.x | CLI command framework | Already in use, well-documented command patterns |
| ACF get_field | Pro | Read knvb-id field | Already used throughout codebase |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| TanStack Query | 5.x | Frontend data fetching | Already used for fees, hook extension |
| React | 18.x | UI components | Extend ContributieList |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| PDO SQLite | SQLite3 class | PDO is more consistent with rest of codebase patterns |
| Post meta | Custom table | Custom tables violate AGENTS.md Rule 0 |
| WP-CLI | REST endpoint | CLI is correct for batch import from file system |

**Installation:**
No additional packages needed. PDO SQLite is built into PHP.

## Architecture Patterns

### Recommended Project Structure
```
includes/
  class-wp-cli.php              # Add RONDO_Nikki_CLI_Command class
  class-rest-api.php            # Extend get_fee_list() to include Nikki data

src/pages/Contributie/
  ContributieList.jsx           # Add Nikki Total and Saldo columns
```

### Pattern 1: WP-CLI Command Class Structure
**What:** WP-CLI command class with PHPDoc options and subcommands
**When to use:** Any batch/import operations that read from files
**Example:**
```php
// Source: includes/class-wp-cli.php (existing pattern from RONDO_Google_Contacts_CLI_Command)
class RONDO_Nikki_CLI_Command {

    /**
     * Import Nikki contribution data from SQLite database
     *
     * ## OPTIONS
     *
     * <file>
     * : Path to the Nikki SQLite database file
     *
     * [--year=<year>]
     * : The Nikki year to import (e.g., 2025). Defaults to current year.
     *
     * [--dry-run]
     * : Preview changes without making them
     *
     * ## EXAMPLES
     *
     *     wp stadion nikki import /path/to/nikki.db
     *     wp stadion nikki import /path/to/nikki.db --year=2025
     *     wp stadion nikki import /path/to/nikki.db --dry-run
     *
     * @when after_wp_load
     */
    public function import( $args, $assoc_args ) {
        // Implementation
    }
}

// Registration at bottom of file
WP_CLI::add_command( 'stadion nikki', 'RONDO_Nikki_CLI_Command' );
```

### Pattern 2: PDO SQLite Read-Only Connection
**What:** Open external SQLite file in read-only mode
**When to use:** Reading data from external SQLite databases
**Example:**
```php
// Source: PHP 8.1+ PDO SQLite file URI support
// https://php.watch/versions/8.1/pdo-sqlite-file-uri

$db_path = $args[0]; // File path from CLI argument

// Validate file exists
if ( ! file_exists( $db_path ) ) {
    WP_CLI::error( sprintf( 'Database file not found: %s', $db_path ) );
    return;
}

try {
    // Read-only connection prevents accidental writes
    $pdo = new \PDO( 'sqlite:' . $db_path, null, null, [
        \PDO::ATTR_ERRMODE => \PDO::ERRMODE_EXCEPTION,
    ]);
} catch ( \PDOException $e ) {
    WP_CLI::error( sprintf( 'Failed to open database: %s', $e->getMessage() ) );
    return;
}

// Query Nikki data
$stmt = $pdo->query( 'SELECT relatiecode, totaal, saldo FROM contributions WHERE jaar = :year' );
```

### Pattern 3: Meta Key with Year Suffix
**What:** Store year-specific data in meta keys like `_nikki_{year}_total`
**When to use:** When data varies by year/season and needs separate storage
**Example:**
```php
// Source: Similar to stadion_fee_cache_{season} pattern in class-membership-fees.php

// Store Nikki data for a person
$year = 2025;
update_post_meta( $person_id, '_nikki_' . $year . '_total', $total );
update_post_meta( $person_id, '_nikki_' . $year . '_saldo', $saldo );

// Retrieve for REST API
$nikki_year = $this->get_nikki_year_for_season( $season ); // 2025-2026 => 2025
$nikki_total = get_post_meta( $person_id, '_nikki_' . $nikki_year . '_total', true );
$nikki_saldo = get_post_meta( $person_id, '_nikki_' . $nikki_year . '_saldo', true );
```

### Pattern 4: KNVB ID Lookup for Matching
**What:** Build lookup table of KNVB IDs to person IDs for fast matching
**When to use:** Batch operations matching external data to persons
**Example:**
```php
// Source: Similar pattern used in calendar Matcher class

// Build lookup table: knvb_id => person_id
global $wpdb;
$persons = $wpdb->get_results(
    "SELECT p.ID, pm.meta_value as knvb_id
     FROM {$wpdb->posts} p
     JOIN {$wpdb->postmeta} pm ON p.ID = pm.post_id
     WHERE p.post_type = 'person'
       AND p.post_status = 'publish'
       AND pm.meta_key = 'knvb-id'
       AND pm.meta_value != ''"
);

$lookup = [];
foreach ( $persons as $p ) {
    $lookup[ $p->knvb_id ] = (int) $p->ID;
}

// Match Nikki record
$person_id = $lookup[ $nikki_relatiecode ] ?? null;
if ( $person_id ) {
    // Store Nikki data
}
```

### Anti-Patterns to Avoid
- **Creating custom database tables:** Violates AGENTS.md Rule 0, use post meta
- **Storing all Nikki data in single meta key:** Use separate keys for total/saldo for clean queries
- **Hardcoding SQLite file path:** Accept path as CLI argument for flexibility
- **Matching by name instead of KNVB ID:** Names can have duplicates/typos, KNVB ID is unique
- **Modifying external SQLite file:** Use read-only mode to prevent accidents

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| SQLite reading | Custom file parsing | PHP PDO SQLite | Built-in, handles edge cases, SQL queries |
| Year-to-season mapping | Complex date logic | Simple string manipulation | Season 2025-2026 = year 2025 (first part) |
| Currency formatting | Inline formatting | Intl.NumberFormat in React | Already used in ContributieList |
| Decimal places | toFixed() | NumberFormat with minimumFractionDigits: 2 | Handles locale properly |
| CLI progress | Echo statements | WP_CLI::log() with progress bar | Standard WP-CLI UX |

**Key insight:** The existing codebase has all the patterns needed. WP-CLI class structure, post meta storage with year suffixes, REST API fee endpoints, and React table columns are all established.

## Common Pitfalls

### Pitfall 1: KNVB ID Field Name Mismatch
**What goes wrong:** Code uses `relatiecode` but ACF field is named `knvb-id`
**Why it happens:** Requirements doc says "relatiecode" (Nikki's column name) vs Stadion's field name
**How to avoid:** Always use `knvb-id` when reading from WordPress, `relatiecode` when reading from Nikki
**Warning signs:** Zero matches despite valid data

### Pitfall 2: Decimal Precision in Currency
**What goes wrong:** Values like 127.50 display as 127.5 or 128
**Why it happens:** PHP floats, JavaScript Number, missing decimal formatting
**How to avoid:** Store as float in meta, format with 2 decimal places in REST and React
**Warning signs:** Totals don't add up, values look rounded

### Pitfall 3: Year vs Season Confusion
**What goes wrong:** Nikki 2025 data matched to wrong season
**Why it happens:** Nikki uses calendar year (2025), Stadion uses season (2025-2026)
**How to avoid:** Nikki year N = Season N-N+1 (e.g., 2025 = 2025-2026). Document mapping clearly.
**Warning signs:** Nikki columns show data for wrong season

### Pitfall 4: SQLite File Path on Production
**What goes wrong:** SQLite file not found on production server
**Why it happens:** File uploaded to different location, path not configured
**How to avoid:** Accept absolute path as CLI argument, document where to upload file
**Warning signs:** "File not found" errors on production only

### Pitfall 5: Missing KNVB IDs
**What goes wrong:** Many Nikki records can't be matched
**Why it happens:** Some persons don't have KNVB ID in Stadion (not imported from Sportlink)
**How to avoid:** Log unmatched records with relatiecode for manual review
**Warning signs:** Low match rate (< 80%)

### Pitfall 6: Empty Saldo Interpretation
**What goes wrong:** Null/empty saldo displayed incorrectly or breaks calculation
**Why it happens:** Nikki may have null/empty values for paid-up members
**How to avoid:** Treat null/empty saldo as 0.00, store as 0 not empty string
**Warning signs:** "NaN" or empty cells in saldo column

## Code Examples

Verified patterns from existing codebase:

### WP-CLI Command Registration
```php
// Source: includes/class-wp-cli.php lines 2086-2097
// Register at bottom of class file, inside if ( WP_CLI ) block

WP_CLI::add_command( 'stadion nikki', 'RONDO_Nikki_CLI_Command' );
```

### Building KNVB ID Lookup
```php
// Source: Pattern from class-calendar-matcher.php (adapted)
private function build_knvb_lookup() {
    global $wpdb;

    $results = $wpdb->get_results(
        "SELECT p.ID, pm.meta_value as knvb_id
         FROM {$wpdb->posts} p
         INNER JOIN {$wpdb->postmeta} pm ON p.ID = pm.post_id
         WHERE p.post_type = 'person'
           AND p.post_status = 'publish'
           AND pm.meta_key = 'knvb-id'
           AND pm.meta_value IS NOT NULL
           AND pm.meta_value != ''"
    );

    $lookup = [];
    foreach ( $results as $row ) {
        // KNVB IDs are numeric strings, normalize to string for consistent matching
        $lookup[ trim( $row->knvb_id ) ] = (int) $row->ID;
    }

    return $lookup;
}
```

### REST API Response Extension
```php
// Source: includes/class-rest-api.php get_fee_list() lines 2570-2646 (extend)
// In the foreach loop, after building $results[] array:

// Get Nikki year from season (2025-2026 => 2025)
$nikki_year = substr( $season, 0, 4 );

// Add Nikki data to each result
foreach ( $query->posts as $person ) {
    // ... existing fee_data code ...

    // Nikki data
    $nikki_total = get_post_meta( $person->ID, '_nikki_' . $nikki_year . '_total', true );
    $nikki_saldo = get_post_meta( $person->ID, '_nikki_' . $nikki_year . '_saldo', true );

    $results[] = [
        // ... existing fields ...
        'nikki_total' => $nikki_total !== '' ? (float) $nikki_total : null,
        'nikki_saldo' => $nikki_saldo !== '' ? (float) $nikki_saldo : null,
    ];
}
```

### Currency Formatting with 2 Decimals (React)
```javascript
// Source: src/pages/Contributie/ContributieList.jsx (modify existing formatCurrency)
function formatCurrency(amount, decimals = 0) {
  if (amount === null || amount === undefined) return '-';
  return new Intl.NumberFormat('nl-NL', {
    style: 'currency',
    currency: 'EUR',
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals,
  }).format(amount);
}

// Usage in columns:
// formatCurrency(member.nikki_total, 2)  // Shows "EUR 127,50"
// formatCurrency(member.nikki_saldo, 2)  // Shows "EUR 0,00"
```

### Table Column Addition (React)
```javascript
// Source: src/pages/Contributie/ContributieList.jsx FeeRow component (extend)
// Add after Final Fee column:

{/* Nikki Total */}
<td className="px-4 py-3 text-sm text-right">
  {member.nikki_total !== null ? (
    <span className="text-gray-700 dark:text-gray-300">
      {formatCurrency(member.nikki_total, 2)}
    </span>
  ) : (
    <span className="text-gray-400 dark:text-gray-500">-</span>
  )}
</td>

{/* Saldo (Outstanding) */}
<td className="px-4 py-3 text-sm text-right">
  {member.nikki_saldo !== null ? (
    <span className={member.nikki_saldo > 0
      ? 'text-red-600 dark:text-red-400 font-medium'
      : 'text-green-600 dark:text-green-400'
    }>
      {formatCurrency(member.nikki_saldo, 2)}
    </span>
  ) : (
    <span className="text-gray-400 dark:text-gray-500">-</span>
  )}
</td>
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Manual data entry | SQLite import | Phase 127.1 | Automated data sync |
| No Nikki comparison | Side-by-side display | Phase 127.1 | Can identify discrepancies |
| Currency as integers | Currency with decimals | Phase 127.1 | Accurate cent-level tracking |

**Deprecated/outdated:**
- None (this is a new feature)

## Open Questions

Things that couldn't be fully resolved:

1. **Nikki SQLite Schema**
   - What we know: Contains relatiecode, totaal, saldo, jaar columns
   - What's unclear: Exact table name, column types, any other useful columns
   - Recommendation: Document actual schema after first import attempt, adapt query as needed

2. **Nikki File Location on Production**
   - What we know: File must be accessible to WP-CLI
   - What's unclear: Where to upload, permissions, naming convention
   - Recommendation: Document in PLAN.md that user must upload to /tmp or theme folder

3. **Saldo Interpretation**
   - What we know: Saldo = outstanding balance
   - What's unclear: Is positive saldo "owes money" or "credit"?
   - Recommendation: Assume positive = owes money (red), confirm with user

4. **Historical Data**
   - What we know: Phase requires 2025 year data = 2025-2026 season
   - What's unclear: Should we support importing multiple years?
   - Recommendation: Start with single year, add multi-year later if needed

## Sources

### Primary (HIGH confidence)
- `/Users/joostdevalk/Code/rondo/rondo-club/includes/class-wp-cli.php` - WP-CLI command patterns, registration
- `/Users/joostdevalk/Code/rondo/rondo-club/includes/class-rest-api.php` - get_fee_list() endpoint at line 2570
- `/Users/joostdevalk/Code/rondo/rondo-club/includes/class-membership-fees.php` - Fee cache meta key pattern
- `/Users/joostdevalk/Code/rondo/rondo-club/src/pages/Contributie/ContributieList.jsx` - Full component structure
- `/Users/joostdevalk/Code/rondo/rondo-club/src/pages/People/PersonDetail.jsx` - knvb-id field usage at line 1106

### Secondary (MEDIUM confidence)
- [PHP PDO SQLite Manual](https://www.php.net/manual/en/ref.pdo-sqlite.php) - SQLite connection syntax
- [PHP 8.1 PDO SQLite File URI](https://php.watch/versions/8.1/pdo-sqlite-file-uri) - Read-only mode support

### Tertiary (LOW confidence)
- None

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All components exist in codebase, no new dependencies
- Architecture: HIGH - Follows established WP-CLI, meta, REST, React patterns exactly
- Pitfalls: MEDIUM - Some unknowns about Nikki data format, but patterns are clear
- Code examples: HIGH - All examples derived from existing codebase

**Research date:** 2026-02-01
**Valid until:** 2026-03-03 (30 days - stable patterns, no version changes expected)

---

## Key Findings Summary

1. **KNVB ID field:** Named `knvb-id` in ACF (not `relatiecode`), accessed via `get_field('knvb-id', $person_id)` or in post meta
2. **WP-CLI pattern:** RONDO_*_CLI_Command class with PHPDoc options, register with `WP_CLI::add_command()`
3. **SQLite access:** PHP PDO with `sqlite:/path/to/file.db`, use read-only mode for safety
4. **Meta key pattern:** `_nikki_{year}_total` and `_nikki_{year}_saldo` per person
5. **Year mapping:** Nikki year 2025 = Season 2025-2026 (extract first 4 chars from season key)
6. **REST extension:** Add nikki_total and nikki_saldo to get_fee_list() response
7. **UI extension:** Add two columns to ContributieList.jsx table with 2-decimal currency formatting
8. **Currency decimals:** Success criteria requires 2 decimal places, use Intl.NumberFormat with minimumFractionDigits: 2
