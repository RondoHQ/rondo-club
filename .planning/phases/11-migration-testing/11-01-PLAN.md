---
phase: 11-migration-testing
plan: 01
type: execute
depends_on: []
files_modified: [includes/class-wp-cli.php]
---

<objective>
Create the `wp prm migrate-to-multiuser` WP-CLI command for upgrading existing Caelis installations to the multi-user system.

Purpose: Provide a clear, user-friendly migration path that sets visibility defaults and validates the upgrade completed successfully.
Output: Working WP-CLI command with dry-run support and validation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@includes/class-wp-cli.php

**Existing capability:** The `PRM_Visibility_CLI_Command::set_defaults()` method already sets `_visibility = 'private'` on all existing contacts. The migration command should wrap this with better UX.

**Tech stack available:** WordPress WP-CLI framework, existing PRM_*_CLI_Command pattern

**Constraining decisions:**
- Phase 7: Default visibility = private (preserves single-user behavior)
- All existing contacts must be migrated to have explicit visibility set
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migrate-to-multiuser command</name>
  <files>includes/class-wp-cli.php</files>
  <action>
Add a new `PRM_MultiUser_CLI_Command` class with a `migrate` subcommand that:

1. Displays welcome message explaining the migration
2. Calls the existing visibility set-defaults logic for person, company, and important_date post types
3. Shows progress and results
4. Supports `--dry-run` flag (pass through to visibility logic)

Command signature: `wp prm multiuser migrate [--dry-run]`

Follow the existing CLI command patterns in the file. Use WP_CLI::log() for output, WP_CLI::success() for completion.

Register the command at the bottom of the file with other commands.
  </action>
  <verify>Run `wp prm multiuser migrate --dry-run` and verify it shows what would be migrated without making changes</verify>
  <done>Command executes, shows migration preview in dry-run mode, reports counts for each post type</done>
</task>

<task type="auto">
  <name>Task 2: Add validate subcommand</name>
  <files>includes/class-wp-cli.php</files>
  <action>
Add a `validate` subcommand to `PRM_MultiUser_CLI_Command` that:

1. Checks all person, company, and important_date posts have `_visibility` set
2. Reports count of posts with/without visibility
3. Returns success if all posts have visibility, warning if some are missing
4. Suggests running `wp prm multiuser migrate` if validation fails

Command signature: `wp prm multiuser validate`

This allows users to verify their installation is properly migrated.
  </action>
  <verify>Run `wp prm multiuser validate` and verify it reports the visibility status of all posts</verify>
  <done>Command reports visibility status, returns appropriate success/warning based on state</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `wp prm multiuser migrate --dry-run` shows preview without changes
- [ ] `wp prm multiuser migrate` sets visibility on posts without it
- [ ] `wp prm multiuser validate` reports correct counts
- [ ] `wp prm multiuser --help` shows available subcommands
- [ ] No PHP errors or warnings
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Migration command provides clear user feedback
- Validation command accurately reports migration status
</success_criteria>

<output>
After completion, create `.planning/phases/11-migration-testing/11-01-SUMMARY.md`
</output>
