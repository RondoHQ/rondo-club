---
phase: 19-important-date-polish
plan: 01
type: execute
depends_on: []
files_modified: [src/components/ImportantDateModal.jsx, src/pages/People/PersonDetail.jsx]
---

<objective>
Fix Important Date frontend bugs including default date value, visibility error on edit, and cache invalidation.

Purpose: Make Important Date editing work reliably without errors and with better UX defaults.
Output: Working date creation/editing with proper defaults and cache updates.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/components/ImportantDateModal.jsx
@src/pages/People/PersonDetail.jsx

**Issues being addressed:**
- Date field should default to today when creating new important date
- REST API returns 400 "_visibility is a required property of acf" when editing
- Important dates card may not update after edit (verify cache invalidation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Default date to today when creating new important date</name>
  <files>src/components/ImportantDateModal.jsx</files>
  <action>
In the ImportantDateModal component, when resetting the form for a new date (not editing), set date_value to today's date in YYYY-MM-DD format.

Location: The `useEffect` that calls `reset()` around line 222-232.

Change the reset call for new dates from:
```javascript
reset({
  title: '',
  date_value: '',  // <-- This should be today
  ...
});
```

To:
```javascript
// Get today's date in YYYY-MM-DD format
const today = new Date().toISOString().split('T')[0];
reset({
  title: '',
  date_value: today,
  ...
});
```

Note: Only set default for NEW dates, not when editing (dateItem is truthy).
  </action>
  <verify>
1. Open PersonDetail page
2. Click "Add date" to open ImportantDateModal
3. Date field should be pre-filled with today's date
4. When editing an existing date, the original date should still load correctly
  </verify>
  <done>New important dates default to today's date; editing existing dates shows the original date value</done>
</task>

<task type="auto">
  <name>Task 2: Fix visibility required error when editing important date</name>
  <files>src/pages/People/PersonDetail.jsx</files>
  <action>
In the handleSaveDate function around line 247-286, the update path doesn't include _visibility in the ACF payload. The REST API requires it.

Change the update call from:
```javascript
await wpApi.updateDate(editingDate.id, {
  title: data.title,
  date_type: data.date_type,
  acf: {
    date_value: data.date_value,
    related_people: data.related_people,
    is_recurring: data.is_recurring,
    year_unknown: data.year_unknown,
  },
});
```

To:
```javascript
await wpApi.updateDate(editingDate.id, {
  title: data.title,
  date_type: data.date_type,
  acf: {
    date_value: data.date_value,
    related_people: data.related_people,
    is_recurring: data.is_recurring,
    year_unknown: data.year_unknown,
    // Preserve existing visibility to satisfy ACF required field validation
    _visibility: editingDate.acf?._visibility || 'private',
    _assigned_workspaces: editingDate.acf?._assigned_workspaces || [],
  },
});
```

Note: editingDate contains the original date object with acf fields from the API response.
  </action>
  <verify>
1. Navigate to a person with an existing important date
2. Click edit on the important date
3. Change any field (e.g., toggle "Repeats every year")
4. Click "Save changes"
5. Should save successfully without 400 error
6. Check browser network tab - no 400 error on PUT request
  </verify>
  <done>Editing important dates saves without REST API 400 error about _visibility</done>
</task>

<task type="auto">
  <name>Task 3: Verify and fix cache invalidation after date update</name>
  <files>src/pages/People/PersonDetail.jsx</files>
  <action>
The handleSaveDate function already invalidates cache on line 278-279:
```javascript
queryClient.invalidateQueries({ queryKey: ['person-dates', id] });
queryClient.invalidateQueries({ queryKey: ['reminders'] });
```

However, there may be additional query keys that need invalidation. Check what query key is used to fetch dates on this page:

1. Search for where dates are fetched in PersonDetail.jsx
2. Verify the query key matches 'person-dates'
3. If there's a mismatch, fix the invalidation key
4. Also check if dates are fetched via a different endpoint (prmApi vs wpApi)

The dates are likely fetched via a hook like useQuery with key ['person-dates', id] - verify this matches.

If the issue persists after Task 2 is fixed (since the update was failing before), document that the cache invalidation is already correct and the card should update once the 400 error is resolved.
  </action>
  <verify>
1. Edit an important date (Task 2 must be complete)
2. After save, the Important Dates card should immediately show updated values
3. No page refresh should be needed
4. Test both date value changes and checkbox toggles
  </verify>
  <done>Important dates card updates immediately after editing a date without requiring page refresh</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] New important dates default to today's date
- [ ] Editing dates saves without 400 error
- [ ] After editing, the dates card updates without page refresh
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No new TypeScript/ESLint errors or warnings
- Important date CRUD workflow is smooth and error-free
</success_criteria>

<output>
After completion, create `.planning/phases/19-important-date-polish/19-01-SUMMARY.md`
</output>
