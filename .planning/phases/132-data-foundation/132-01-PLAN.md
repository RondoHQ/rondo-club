---
phase: 132-data-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-post-types.php
  - includes/class-taxonomies.php
  - acf-json/group_discipline_case_fields.json
autonomous: true

must_haves:
  truths:
    - "discipline_case CPT exists and appears in WordPress admin menu"
    - "REST API endpoint /wp/v2/discipline-cases returns list of cases"
    - "seizoen taxonomy appears in admin and is assignable to discipline cases"
    - "ACF fields appear when editing a discipline case in admin"
    - "All ACF fields are exposed via REST API in acf object"
  artifacts:
    - path: "includes/class-post-types.php"
      provides: "discipline_case CPT registration"
      contains: "register_discipline_case_post_type"
    - path: "includes/class-taxonomies.php"
      provides: "seizoen taxonomy with current season support"
      contains: "register_seizoen_taxonomy"
    - path: "acf-json/group_discipline_case_fields.json"
      provides: "All discipline case fields"
      contains: "dossier_id"
  key_links:
    - from: "includes/class-post-types.php"
      to: "WordPress REST API"
      via: "show_in_rest: true"
      pattern: "'show_in_rest'\\s*=>\\s*true"
    - from: "acf-json/group_discipline_case_fields.json"
      to: "WordPress REST API"
      via: "show_in_rest: 1"
      pattern: '"show_in_rest":\\s*1'
---

<objective>
Register the discipline_case Custom Post Type, seizoen taxonomy, and ACF field group for storing discipline case data from Sportlink.

Purpose: Establishes the data layer for discipline cases, enabling storage, REST API access, and future UI display.
Output: CPT visible in admin, REST endpoint functional, ACF fields available for data entry.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/132-data-foundation/132-CONTEXT.md
@.planning/phases/132-data-foundation/132-RESEARCH.md
@includes/class-post-types.php
@includes/class-taxonomies.php
@acf-json/group_important_date_fields.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register discipline_case CPT and seizoen taxonomy</name>
  <files>
    includes/class-post-types.php
    includes/class-taxonomies.php
  </files>
  <action>
**In class-post-types.php:**
1. Add call to `$this->register_discipline_case_post_type()` in `register_post_types()` method
2. Create new private method `register_discipline_case_post_type()` following existing patterns:

```php
private function register_discipline_case_post_type() {
    $labels = [
        'name'               => _x( 'Tuchtzaken', 'Post type general name', 'stadion' ),
        'singular_name'      => _x( 'Tuchtzaak', 'Post type singular name', 'stadion' ),
        'menu_name'          => _x( 'Tuchtzaken', 'Admin Menu text', 'stadion' ),
        'add_new'            => __( 'Add New', 'stadion' ),
        'add_new_item'       => __( 'Add New Tuchtzaak', 'stadion' ),
        'edit_item'          => __( 'Edit Tuchtzaak', 'stadion' ),
        'new_item'           => __( 'New Tuchtzaak', 'stadion' ),
        'view_item'          => __( 'View Tuchtzaak', 'stadion' ),
        'search_items'       => __( 'Search Tuchtzaken', 'stadion' ),
        'not_found'          => __( 'No tuchtzaken found', 'stadion' ),
        'not_found_in_trash' => __( 'No tuchtzaken found in Trash', 'stadion' ),
        'all_items'          => __( 'All Tuchtzaken', 'stadion' ),
    ];

    $args = [
        'labels'             => $labels,
        'public'             => false,
        'publicly_queryable' => false,
        'show_ui'            => true,
        'show_in_menu'       => true,
        'show_in_rest'       => true,
        'rest_base'          => 'discipline-cases',
        'query_var'          => false,
        'rewrite'            => false,
        'capability_type'    => 'post',
        'has_archive'        => false,
        'hierarchical'       => false,
        'menu_position'      => 9,
        'menu_icon'          => 'dashicons-warning',
        'supports'           => [ 'title', 'author' ],
    ];

    register_post_type( 'discipline_case', $args );
}
```

**In class-taxonomies.php:**
1. Add call to `$this->register_seizoen_taxonomy()` in `register_taxonomies()` method
2. Create new private method `register_seizoen_taxonomy()`:

```php
private function register_seizoen_taxonomy() {
    $labels = [
        'name'          => _x( 'Seizoenen', 'taxonomy general name', 'stadion' ),
        'singular_name' => _x( 'Seizoen', 'taxonomy singular name', 'stadion' ),
        'search_items'  => __( 'Search Seizoenen', 'stadion' ),
        'all_items'     => __( 'All Seizoenen', 'stadion' ),
        'edit_item'     => __( 'Edit Seizoen', 'stadion' ),
        'update_item'   => __( 'Update Seizoen', 'stadion' ),
        'add_new_item'  => __( 'Add New Seizoen', 'stadion' ),
        'new_item_name' => __( 'New Seizoen Name', 'stadion' ),
        'menu_name'     => __( 'Seizoenen', 'stadion' ),
    ];

    $args = [
        'hierarchical'      => false,
        'labels'            => $labels,
        'show_ui'           => true,
        'show_admin_column' => true,
        'show_in_rest'      => true,
        'query_var'         => true,
        'rewrite'           => [ 'slug' => 'seizoen' ],
    ];

    register_taxonomy( 'seizoen', [ 'discipline_case' ], $args );
}
```

3. Add two helper functions for current season management (add as public methods in the class):

```php
/**
 * Set a season as the current season
 * Clears any previous current season flag
 *
 * @param string $season_slug The season slug (e.g., '2024-2025')
 * @return bool True on success, false on failure
 */
public function set_current_season( $season_slug ) {
    // Clear previous current season
    $previous_current = get_terms( [
        'taxonomy'   => 'seizoen',
        'hide_empty' => false,
        'meta_query' => [
            [
                'key'   => 'is_current_season',
                'value' => '1',
            ],
        ],
    ] );

    if ( ! is_wp_error( $previous_current ) ) {
        foreach ( $previous_current as $term ) {
            delete_term_meta( $term->term_id, 'is_current_season' );
        }
    }

    // Set new current season
    $term = get_term_by( 'slug', $season_slug, 'seizoen' );
    if ( $term && ! is_wp_error( $term ) ) {
        update_term_meta( $term->term_id, 'is_current_season', '1' );
        return true;
    }

    return false;
}

/**
 * Get the current season term
 *
 * @return WP_Term|null The current season term or null if not set
 */
public function get_current_season() {
    $terms = get_terms( [
        'taxonomy'   => 'seizoen',
        'hide_empty' => false,
        'meta_query' => [
            [
                'key'   => 'is_current_season',
                'value' => '1',
            ],
        ],
    ] );

    if ( ! is_wp_error( $terms ) && ! empty( $terms ) ) {
        return $terms[0];
    }

    return null;
}
```
  </action>
  <verify>
    1. Visit WordPress admin - Tuchtzaken should appear in menu with warning icon
    2. Create a test discipline case - editor should load
    3. Seizoen should appear as a column/filter in discipline case list
    4. Run: `curl -s "https://[site]/wp-json/wp/v2/discipline-cases" -H "Cookie: [auth]"` - should return 200
  </verify>
  <done>
    - discipline_case CPT registered with Dutch labels (Tuchtzaak/Tuchtzaken)
    - seizoen taxonomy registered, non-hierarchical, REST-enabled
    - Current season helper methods available for future Sportlink sync
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ACF field group for discipline cases</name>
  <files>
    acf-json/group_discipline_case_fields.json
  </files>
  <action>
Create the ACF field group JSON file with all required fields per CONTEXT.md decisions:

**Field specifications (from CONTEXT.md):**
- `dossier_id`: Text, required, unique - primary Sportlink sync key
- `person`: Post Object (single, optional) - links to person CPT
- `match_date`: Date picker - when the incident occurred
- `match_description`: Text - description of the match/event
- `team_name`: Text - team involved (stored as text, not relationship)
- `charge_codes`: Text - single charge code per case
- `charge_description`: Textarea - description of the charge
- `sanction_description`: Textarea - description of the sanction
- `processing_date`: Date picker - when case was processed
- `administrative_fee`: Number (step 0.01, prepend euro) - fee in euros
- `is_charged`: True/False - whether costs were charged to person (Is doorbelast)

**JSON structure** (write to acf-json/group_discipline_case_fields.json):

```json
{
    "key": "group_discipline_case_fields",
    "title": "Tuchtzaak Details",
    "fields": [
        {
            "key": "field_discipline_dossier_id",
            "label": "Dossier ID",
            "name": "dossier_id",
            "type": "text",
            "instructions": "Uniek identificatienummer uit Sportlink",
            "required": 1,
            "wrapper": {
                "width": "50",
                "class": "",
                "id": ""
            }
        },
        {
            "key": "field_discipline_person",
            "label": "Persoon",
            "name": "person",
            "type": "post_object",
            "instructions": "Gekoppelde persoon (optioneel - kan later worden gekoppeld)",
            "required": 0,
            "post_type": ["person"],
            "multiple": 0,
            "return_format": "id",
            "allow_null": 1,
            "wrapper": {
                "width": "50",
                "class": "",
                "id": ""
            }
        },
        {
            "key": "field_discipline_match_date",
            "label": "Wedstrijddatum",
            "name": "match_date",
            "type": "date_picker",
            "instructions": "Datum van de wedstrijd/het incident",
            "required": 0,
            "display_format": "d-m-Y",
            "return_format": "Ymd",
            "wrapper": {
                "width": "50",
                "class": "",
                "id": ""
            }
        },
        {
            "key": "field_discipline_processing_date",
            "label": "Verwerkingsdatum",
            "name": "processing_date",
            "type": "date_picker",
            "instructions": "Datum waarop de zaak is verwerkt",
            "required": 0,
            "display_format": "d-m-Y",
            "return_format": "Ymd",
            "wrapper": {
                "width": "50",
                "class": "",
                "id": ""
            }
        },
        {
            "key": "field_discipline_match_description",
            "label": "Wedstrijdomschrijving",
            "name": "match_description",
            "type": "text",
            "instructions": "Omschrijving van de wedstrijd (bijv. Team A - Team B)",
            "required": 0,
            "wrapper": {
                "width": "",
                "class": "",
                "id": ""
            }
        },
        {
            "key": "field_discipline_team_name",
            "label": "Teamnaam",
            "name": "team_name",
            "type": "text",
            "instructions": "Naam van het betrokken team",
            "required": 0,
            "wrapper": {
                "width": "50",
                "class": "",
                "id": ""
            }
        },
        {
            "key": "field_discipline_charge_codes",
            "label": "Artikelnummer",
            "name": "charge_codes",
            "type": "text",
            "instructions": "Artikelnummer van de overtreding",
            "required": 0,
            "wrapper": {
                "width": "50",
                "class": "",
                "id": ""
            }
        },
        {
            "key": "field_discipline_charge_description",
            "label": "Artikelomschrijving",
            "name": "charge_description",
            "type": "textarea",
            "instructions": "Omschrijving van de overtreding",
            "required": 0,
            "rows": 3,
            "wrapper": {
                "width": "",
                "class": "",
                "id": ""
            }
        },
        {
            "key": "field_discipline_sanction_description",
            "label": "Strafbeschrijving",
            "name": "sanction_description",
            "type": "textarea",
            "instructions": "Omschrijving van de opgelegde straf",
            "required": 0,
            "rows": 3,
            "wrapper": {
                "width": "",
                "class": "",
                "id": ""
            }
        },
        {
            "key": "field_discipline_administrative_fee",
            "label": "Administratiekosten",
            "name": "administrative_fee",
            "type": "number",
            "instructions": "Administratiekosten in euro's",
            "required": 0,
            "min": 0,
            "step": 0.01,
            "prepend": "\u20ac",
            "wrapper": {
                "width": "50",
                "class": "",
                "id": ""
            }
        },
        {
            "key": "field_discipline_is_charged",
            "label": "Is doorbelast",
            "name": "is_charged",
            "type": "true_false",
            "instructions": "Zijn de kosten doorbelast aan de persoon?",
            "message": "Kosten zijn doorbelast",
            "default_value": 0,
            "ui": 1,
            "wrapper": {
                "width": "50",
                "class": "",
                "id": ""
            }
        }
    ],
    "location": [
        [
            {
                "param": "post_type",
                "operator": "==",
                "value": "discipline_case"
            }
        ]
    ],
    "menu_order": 0,
    "position": "normal",
    "style": "default",
    "label_placement": "top",
    "instruction_placement": "label",
    "hide_on_screen": [
        "excerpt",
        "discussion",
        "comments",
        "slug"
    ],
    "active": true,
    "show_in_rest": 1
}
```

Note: The euro symbol is escaped as `\u20ac` in JSON.
  </action>
  <verify>
    1. Verify JSON is valid: `cat acf-json/group_discipline_case_fields.json | python3 -m json.tool`
    2. Visit WordPress admin, edit a discipline case - all fields should appear
    3. Create a test case with data, then GET via REST API - verify `acf` object contains all fields
  </verify>
  <done>
    - ACF field group created with all 11 fields
    - show_in_rest: 1 ensures REST API exposure
    - Person field uses post_object with single selection and allow_null
    - Currency field has proper step/prepend for euros
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unique dossier-id validation</name>
  <files>
    includes/class-taxonomies.php
  </files>
  <action>
Add ACF validation filter to ensure dossier_id is unique across all discipline cases.

**Add to class-taxonomies.php constructor:**

```php
// Add unique validation for discipline case dossier_id
add_filter( 'acf/validate_value/name=dossier_id', [ $this, 'validate_unique_dossier_id' ], 10, 4 );
```

**Add new public method:**

```php
/**
 * Validate that dossier_id is unique across discipline cases
 *
 * @param mixed  $valid      Whether the value is valid (true) or not (string error message)
 * @param mixed  $value      The field value
 * @param array  $field      The field array
 * @param string $input_name The input name/key
 * @return mixed True if valid, error message string if invalid
 */
public function validate_unique_dossier_id( $valid, $value, $field, $input_name ) {
    // Skip if already invalid or empty
    if ( ! $valid || empty( $value ) ) {
        return $valid;
    }

    // Get current post ID from various sources
    $post_id = 0;
    if ( isset( $_POST['post_ID'] ) ) {
        $post_id = intval( $_POST['post_ID'] );
    } elseif ( isset( $_POST['post_id'] ) ) {
        $post_id = intval( $_POST['post_id'] );
    }

    // Query for existing discipline cases with this dossier_id
    $existing = get_posts( [
        'post_type'      => 'discipline_case',
        'post_status'    => 'any',
        'posts_per_page' => 1,
        'fields'         => 'ids',
        'post__not_in'   => $post_id ? [ $post_id ] : [],
        'meta_query'     => [
            [
                'key'   => 'dossier_id',
                'value' => $value,
            ],
        ],
    ] );

    if ( ! empty( $existing ) ) {
        return __( 'Dit dossier-ID bestaat al. Elk dossier moet een uniek ID hebben.', 'stadion' );
    }

    return $valid;
}
```

Why in class-taxonomies.php: This class already handles ACF-related configuration for taxonomies (relationship type configurations). The validation filter fits naturally here alongside other ACF integrations.
  </action>
  <verify>
    1. Create a discipline case with dossier_id "TEST-001", save
    2. Create another discipline case with dossier_id "TEST-001" - should show error message
    3. Edit first case and save with same dossier_id - should succeed (not flagged as duplicate of itself)
  </verify>
  <done>
    - Unique dossier_id validation prevents duplicate Sportlink imports
    - Error message in Dutch matches project language
    - Validation excludes current post when editing
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **CPT exists:** WordPress admin shows Tuchtzaken menu item with warning icon
2. **REST endpoint works:** `GET /wp-json/wp/v2/discipline-cases` returns 200 with empty array (or cases if created)
3. **Taxonomy works:** Seizoenen appears in admin column, can create/assign terms
4. **ACF fields work:** All 11 fields appear when editing a discipline case
5. **REST includes ACF:** GET single case includes `acf` object with all field values
6. **Unique validation works:** Cannot save duplicate dossier_id values
</verification>

<success_criteria>
- DATA-01: discipline_case CPT exists with labels Tuchtzaak/Tuchtzaken
- DATA-02: ACF field group contains all 11 specified fields
- DATA-03: seizoen taxonomy is registered, non-hierarchical, REST-enabled
- DATA-04: REST API returns discipline cases with all ACF fields via wp/v2/discipline-cases endpoint
</success_criteria>

<output>
After completion, create `.planning/phases/132-data-foundation/132-01-SUMMARY.md`
</output>
