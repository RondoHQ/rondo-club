---
phase: 161-configurable-matching-rules
plan: 02
type: execute
wave: 2
depends_on: ["161-01"]
files_modified:
  - src/pages/Settings/FeeCategorySettings.jsx
  - src/api/client.js
  - style.css
  - package.json
  - CHANGELOG.md
autonomous: true

must_haves:
  truths:
    - "Admin can select matching teams from a multi-select checkbox list when editing a fee category"
    - "Admin can select matching werkfuncties from a multi-select checkbox list when editing a fee category"
    - "Category cards show matching teams and werkfuncties in the summary view"
    - "Matching rules are saved and loaded correctly when switching seasons"
    - "Version is bumped to 21.1.0 and changelog updated for configurable matching rules"
  artifacts:
    - path: "src/pages/Settings/FeeCategorySettings.jsx"
      provides: "Multi-select team and werkfunctie inputs in EditCategoryForm, matching rules display on SortableCategoryCard"
      contains: "matching_teams"
    - path: "src/api/client.js"
      provides: "API client method for fetching available werkfuncties"
      contains: "getAvailableWerkfuncties"
  key_links:
    - from: "src/pages/Settings/FeeCategorySettings.jsx EditCategoryForm"
      to: "/wp/v2/team"
      via: "TanStack Query fetch for team list multi-select"
      pattern: "useQuery.*teams"
    - from: "src/pages/Settings/FeeCategorySettings.jsx EditCategoryForm"
      to: "/rondo/v1/werkfuncties/available"
      via: "TanStack Query fetch for werkfunctie list multi-select"
      pattern: "getAvailableWerkfuncties"
    - from: "src/pages/Settings/FeeCategorySettings.jsx handleSave"
      to: "REST API POST /rondo/v1/membership-fees/settings"
      via: "matching_teams and matching_werkfuncties included in category save payload"
      pattern: "matching_teams.*matching_werkfuncties"
---

<objective>
Add multi-select team and werkfunctie matching rule inputs to the FeeCategorySettings UI, display matching rules on category cards, add API client method, bump version, update docs, and deploy.

Purpose: Completes the admin UI for configurable matching rules, allowing administrators to visually configure which teams and werkfuncties trigger specific fee categories — the final piece of v21.0.

Output: Updated FeeCategorySettings with matching rule inputs, version 21.1.0, deployed to production.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/161-configurable-matching-rules/161-RESEARCH.md
@.planning/phases/161-configurable-matching-rules/161-01-SUMMARY.md
@src/pages/Settings/FeeCategorySettings.jsx
@src/api/client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add matching rules UI to FeeCategorySettings and API client method</name>
  <files>
    src/pages/Settings/FeeCategorySettings.jsx
    src/api/client.js
  </files>
  <action>
  **1. Add API client method** in `src/api/client.js`:
  Add to the `prmApi` object:
  ```js
  getAvailableWerkfuncties: () => api.get('/rondo/v1/werkfuncties/available'),
  ```

  **2. Update FeeCategorySettings.jsx:**

  **2a. Add team and werkfunctie queries** in the main `FeeCategorySettings` component:
  ```jsx
  // Fetch all teams for matching rules multi-select
  const { data: allTeams } = useQuery({
    queryKey: ['teams', 'all-for-settings'],
    queryFn: async () => {
      const response = await wpApi.get('/wp/v2/team', {
        params: { per_page: 100, orderby: 'title', order: 'asc' }
      });
      return response.data;
    },
    staleTime: 5 * 60 * 1000,
  });

  // Fetch available werkfuncties for matching rules multi-select
  const { data: availableWerkfuncties } = useQuery({
    queryKey: ['werkfuncties', 'available'],
    queryFn: async () => {
      const response = await prmApi.getAvailableWerkfuncties();
      return response.data;
    },
    staleTime: 5 * 60 * 1000,
  });
  ```

  Import `wpApi` from `@/api/client` (it's already imported as `prmApi` — check the import line and add `wpApi` if not present). The WordPress REST API for teams uses the `wpApi` client (standard `/wp/v2/` namespace), not `prmApi`.

  **2b. Pass team and werkfunctie data to EditCategoryForm:**
  Update all `<EditCategoryForm>` usages (there are two: one for editing existing, one for adding new) to pass:
  ```jsx
  allTeams={allTeams || []}
  availableWerkfuncties={availableWerkfuncties || []}
  ```

  **2c. Update `EditCategoryForm` component:**
  - Add `allTeams = []` and `availableWerkfuncties = []` to the destructured props
  - Add `matching_teams` and `matching_werkfuncties` to the `formData` state:
    ```js
    matching_teams: category?.matching_teams || [],
    matching_werkfuncties: category?.matching_werkfuncties || [],
    ```
  - Include them in `handleSubmit` → `onSave()` call:
    ```js
    onSave(effectiveSlug, {
      label: formData.label,
      amount: parseFloat(formData.amount) || 0,
      age_classes: formData.age_classes,
      is_youth: formData.is_youth,
      matching_teams: formData.matching_teams,
      matching_werkfuncties: formData.matching_werkfuncties,
    });
    ```
  - Add toggle handlers:
    ```js
    const toggleTeam = (teamId) => {
      setFormData(prev => ({
        ...prev,
        matching_teams: prev.matching_teams.includes(teamId)
          ? prev.matching_teams.filter(id => id !== teamId)
          : [...prev.matching_teams, teamId],
      }));
    };

    const toggleWerkfunctie = (wf) => {
      setFormData(prev => ({
        ...prev,
        matching_werkfuncties: prev.matching_werkfuncties.includes(wf)
          ? prev.matching_werkfuncties.filter(w => w !== wf)
          : [...prev.matching_werkfuncties, wf],
      }));
    };
    ```
  - Add matching teams UI section (after the is_youth checkbox, before the actions):
    ```jsx
    {/* Matching teams */}
    <div>
      <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
        Teams die deze categorie krijgen
      </label>
      <p className="text-xs text-gray-500 dark:text-gray-400 mb-2">
        Leden die uitsluitend in geselecteerde teams spelen krijgen deze categorie.
        Laat leeg als deze categorie niet op basis van teams wordt toegewezen.
      </p>
      {allTeams.length > 0 ? (
        <div className="border border-gray-300 dark:border-gray-600 rounded-md p-3 max-h-48 overflow-y-auto space-y-1.5 bg-white dark:bg-gray-700">
          {allTeams.map(team => (
            <label key={team.id} className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 rounded px-1 py-0.5">
              <input
                type="checkbox"
                checked={formData.matching_teams.includes(team.id)}
                onChange={() => toggleTeam(team.id)}
                className="rounded border-gray-300 dark:border-gray-600 text-accent-600 focus:ring-accent-500"
              />
              <span className="text-sm text-gray-700 dark:text-gray-300">{team.title.rendered}</span>
            </label>
          ))}
        </div>
      ) : (
        <p className="text-sm text-gray-500 dark:text-gray-400 italic">Laden...</p>
      )}
    </div>
    ```
  - Add matching werkfuncties UI section (after matching teams):
    ```jsx
    {/* Matching werkfuncties */}
    <div>
      <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
        Werkfuncties die deze categorie krijgen
      </label>
      <p className="text-xs text-gray-500 dark:text-gray-400 mb-2">
        Leden met een geselecteerde werkfunctie krijgen deze categorie.
        Laat leeg als deze categorie niet op basis van werkfuncties wordt toegewezen.
      </p>
      {availableWerkfuncties.length > 0 ? (
        <div className="border border-gray-300 dark:border-gray-600 rounded-md p-3 max-h-48 overflow-y-auto space-y-1.5 bg-white dark:bg-gray-700">
          {availableWerkfuncties.map(wf => (
            <label key={wf} className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 rounded px-1 py-0.5">
              <input
                type="checkbox"
                checked={formData.matching_werkfuncties.includes(wf)}
                onChange={() => toggleWerkfunctie(wf)}
                className="rounded border-gray-300 dark:border-gray-600 text-accent-600 focus:ring-accent-500"
              />
              <span className="text-sm text-gray-700 dark:text-gray-300">{wf}</span>
            </label>
          ))}
        </div>
      ) : (
        <p className="text-sm text-gray-500 dark:text-gray-400 italic">Geen werkfuncties gevonden</p>
      )}
    </div>
    ```

  **2d. Update `SortableCategoryCard` to display matching rules:**
  After the age_classes display (lines 81-89), add:
  ```jsx
  {category.matching_teams && category.matching_teams.length > 0 && (
    <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">
      Teams: {category.matching_teams.length} team(s) geselecteerd
    </p>
  )}
  {category.matching_werkfuncties && category.matching_werkfuncties.length > 0 && (
    <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">
      Werkfuncties: {category.matching_werkfuncties.join(', ')}
    </p>
  )}
  ```

  **2e. Update `handleSave` in the main component:**
  When saving an edited category, preserve matching_teams and matching_werkfuncties from the existing category if the form doesn't include them (for backward compat with the save flow):
  The current save already spreads `categoryData` which will include matching_teams and matching_werkfuncties from the form, so this should work naturally. No change needed here.
  </action>
  <verify>
  - Run `npm run lint` from rondo-club/ to check for lint errors
  - Run `npm run build` from rondo-club/ to verify production build succeeds
  - Read the updated FeeCategorySettings.jsx to verify multi-select UI for teams and werkfuncties
  - Read src/api/client.js to verify getAvailableWerkfuncties is added
  </verify>
  <done>
  - EditCategoryForm shows multi-select checkbox lists for teams and werkfuncties
  - Team list fetched from /wp/v2/team, werkfuncties from /rondo/v1/werkfuncties/available
  - SortableCategoryCard displays matching teams count and werkfunctie names
  - matching_teams and matching_werkfuncties are saved as part of category data
  - Build succeeds with zero lint errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Version bump, changelog, developer docs, deploy</name>
  <files>
    style.css
    package.json
    CHANGELOG.md
  </files>
  <action>
  **1. Version bump to 21.1.0:**
  - Update `style.css` version in theme header comment to `21.1.0`
  - Update `package.json` version to `21.1.0`

  **2. Update CHANGELOG.md:**
  Add entry at the top under a new `## [21.1.0] - 2026-02-09` section:
  ```
  ### Added
  - Configurable matching rules: each fee category can specify matching teams (by ID) and matching werkfuncties
  - Admin UI for selecting teams and werkfuncties per fee category in Settings
  - GET /rondo/v1/werkfuncties/available endpoint for listing distinct werkfunctie values
  - Auto-migration: existing 'recreant' categories pre-populated with recreational team IDs, 'donateur' with Donateur werkfunctie

  ### Changed
  - calculate_fee() now uses config-driven team and werkfunctie matching instead of hardcoded is_recreational_team() and is_donateur()
  - is_recreational_team() and is_donateur() deprecated (kept for migration only)
  ```

  **3. Update developer docs:**
  Update `/Users/joostdevalk/Code/rondo/developer/src/content/docs/features/membership-fees.md` to document:
  - The new matching_teams and matching_werkfuncties fields in category data structure
  - How calculate_fee() now uses config-driven matching
  - The new werkfuncties/available endpoint
  - Migration behavior for existing categories

  **4. Build and deploy:**
  - Run `npm run build` to generate production assets
  - Run `bin/deploy.sh` to deploy to production
  </action>
  <verify>
  - Verify style.css contains version 21.1.0
  - Verify package.json contains version 21.1.0
  - Verify CHANGELOG.md has the new entry
  - Verify `npm run build` succeeds
  - Verify deployment completes successfully
  </verify>
  <done>
  - Version 21.1.0 in style.css and package.json
  - CHANGELOG.md documents configurable matching rules
  - Developer docs updated with matching rules documentation
  - Production build succeeds
  - Deployed to production
  </done>
</task>

</tasks>

<verification>
1. On production, navigate to Settings > Contributiecategorieën
2. Edit a category (e.g., 'Recreant') — verify multi-select team checkboxes appear with teams from the system
3. Verify 'Recreant' has recreational teams pre-selected (from migration)
4. Edit 'Donateur' category — verify 'Donateur' werkfunctie is pre-selected
5. Save and reload — verify matching rules persist
6. Switch to next season — verify matching rules are present there too
7. Check contributie list — verify fee calculations still produce correct results
</verification>

<success_criteria>
- Admin can configure matching teams and werkfuncties for each fee category through the Settings UI
- Existing 'recreant' and 'donateur' categories have pre-populated matching rules from migration
- Category cards show matching rules summary
- All fee calculations produce identical results to before the change
- Version 21.1.0 deployed to production
</success_criteria>

<output>
After completion, create `.planning/phases/161-configurable-matching-rules/161-02-SUMMARY.md`
</output>
