---
phase: 05-xss-protection
plan: 01
type: execute
depends_on: []
files_modified: [includes/class-rest-base.php, includes/class-rest-api.php]
---

<objective>
Add server-side XSS sanitization to REST API responses using WordPress native functions.

Purpose: Prevent stored XSS attacks by sanitizing user-supplied content in API responses. Defense-in-depth: even though input is sanitized, output escaping provides a second layer of protection.

Output: All REST API string responses containing user-supplied data are sanitized with appropriate WordPress functions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key decision from PROJECT.md:**
- Use WordPress native XSS functions (wp_kses) instead of client-side DOMPurify

**Relevant prior summaries:**
@.planning/phases/01-rest-api-infrastructure/01-01-SUMMARY.md (established RONDO_REST_Base with format methods)

**Source files:**
@includes/class-rest-base.php (format_person_summary, format_team_summary, format_date)
@includes/class-rest-api.php (dashboard, search, timeline responses)
@includes/class-comment-types.php (already uses wp_kses_post on INPUT, verify OUTPUT)

**Tech stack available:**
- WordPress native: wp_kses(), wp_kses_post(), esc_html(), esc_url(), esc_attr()

**Established patterns:**
- Input sanitization via wp_kses_post() and sanitize_text_field() (see class-comment-types.php)
- html_entity_decode() used for output but doesn't sanitize

**XSS Protection Strategy:**
The REST API returns JSON consumed by the React frontend. The frontend uses `dangerouslySetInnerHTML` in some places (timeline content with links). We need:
1. `wp_kses_post()` for rich content fields (notes, activity content) - allows safe HTML
2. `esc_html()` for plain text fields (names, titles) - escapes all HTML
3. `esc_url()` for URL fields (website, thumbnail) - validates URL format

Note: Some fields like `post_title` already have HTML entities from WordPress. The current code uses `html_entity_decode()` to display them properly. We should keep this behavior but also sanitize.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sanitization helper methods to RONDO_REST_Base</name>
  <files>includes/class-rest-base.php</files>
  <action>
Add three protected helper methods to RONDO_REST_Base for consistent sanitization:

1. `sanitize_text($text)` - For plain text fields (names, titles):
   - Return `esc_html(html_entity_decode($text, ENT_QUOTES, 'UTF-8'))`
   - This decodes entities first (to avoid double-encoding), then escapes

2. `sanitize_rich_content($content)` - For HTML-allowed fields (notes, descriptions):
   - Return `wp_kses_post($content)`
   - Allows safe HTML (bold, italic, links, lists) but strips dangerous tags

3. `sanitize_url($url)` - For URL fields:
   - Return empty string if empty/null
   - Return `esc_url($url)` otherwise

Then update the three format methods to use these helpers:

**format_person_summary():**
- `name` -> use sanitize_text()
- `first_name`, `last_name` -> use sanitize_text()
- `thumbnail` -> use sanitize_url()
- `labels` -> already safe (taxonomy terms are sanitized by WordPress)

**format_team_summary():**
- `name` -> use sanitize_text()
- `thumbnail` -> use sanitize_url()
- `website` -> use sanitize_url()
- `labels` -> already safe

**format_date():**
- `title` -> use sanitize_text()
- Person names in `related_people` -> use sanitize_text()
- Other fields are booleans/dates - already safe

IMPORTANT: Do NOT double-escape. Remove existing html_entity_decode() calls and let sanitize_text() handle it.
  </action>
  <verify>
Run `php -l includes/class-rest-base.php` to check syntax.
Verify methods exist: `grep -E "function sanitize_(text|rich_content|url)" includes/class-rest-base.php`
  </verify>
  <done>
- Three new protected sanitization methods added to RONDO_REST_Base
- format_person_summary, format_team_summary, format_date use sanitization helpers
- No duplicate html_entity_decode calls
- No PHP syntax errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Sanitize remaining REST API response fields</name>
  <files>includes/class-rest-api.php</files>
  <action>
Review and sanitize remaining response fields in RONDO_REST_API that don't use the base class formatters.

**get_investments() around line 905:**
- `name` -> use `$this->sanitize_text()` (inherited from base)
- `industry` -> use `$this->sanitize_text()`
- `website` -> use `$this->sanitize_url()`
- `thumbnail` -> use `$this->sanitize_url()`

**get_all_todos() around line 800:**
- `person_name` (from get_the_title) -> use `$this->sanitize_text()`
- `content` -> already sanitized on input via wp_kses_post, but wrap in sanitize_rich_content() for consistency
- `thumbnail` -> use `$this->sanitize_url()`

**global_search() around line 562:**
- Uses format_person_summary and format_team_summary - already handled by Task 1

**get_dashboard_summary() around line 650:**
- Uses format_person_summary - already handled by Task 1

Note: class-comment-types.php already sanitizes content with wp_kses_post() on INPUT (lines 249, 278, 333, 380). The format_comment() method uses make_clickable() which is safe. No changes needed there.
  </action>
  <verify>
Run `php -l includes/class-rest-api.php` to check syntax.
Verify sanitization applied: `grep -c "sanitize_text\|sanitize_url\|sanitize_rich_content" includes/class-rest-api.php` should show multiple matches.
  </verify>
  <done>
- get_investments() response fields sanitized
- get_all_todos() response fields sanitized
- No PHP syntax errors
- Build completes: `npm run build`
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `php -l includes/class-rest-base.php` - no syntax errors
- [ ] `php -l includes/class-rest-api.php` - no syntax errors
- [ ] `npm run build` - production build succeeds
- [ ] Manual test: Visit https://cael.is/ and verify:
  - Dashboard loads with people/teams displayed
  - Person detail page loads with timeline
  - Search works and shows results
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No PHP syntax errors introduced
- REST API responses include sanitized user content
- Existing functionality preserved (dashboard, search, timeline)
- Phase 5 complete
</success_criteria>

<output>
After completion, create `.planning/phases/05-xss-protection/05-01-SUMMARY.md`:

# Phase 05-01: XSS Protection Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description
- `path/to/another.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase complete, ready for Phase 6: Code Cleanup
</output>
