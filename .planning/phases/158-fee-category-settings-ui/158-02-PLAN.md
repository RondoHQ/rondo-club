---
phase: 158-fee-category-settings-ui
plan: 02
type: execute
wave: 2
depends_on: ["158-01"]
files_modified:
  - src/pages/Settings/Settings.jsx
  - style.css
  - package.json
  - CHANGELOG.md
autonomous: false

must_haves:
  truths:
    - "Navigating to Settings > Beheer > Contributie shows the new FeeCategorySettings component instead of the old hardcoded fee inputs"
    - "Old fee state management (currentSeasonFees, nextSeasonFees, feeLoading, feeSaving, feeMessage, handleSeasonFeeSave) is fully removed from Settings.jsx"
    - "Admin can add, edit, reorder, and delete fee categories on production"
    - "Age class coverage display is visible with current category configuration"
    - "Version is bumped and changelog is updated"
  artifacts:
    - path: "src/pages/Settings/Settings.jsx"
      provides: "FeeCategorySettings integration replacing old FeesSubtab"
    - path: "style.css"
      provides: "Updated version number"
    - path: "package.json"
      provides: "Updated version number"
    - path: "CHANGELOG.md"
      provides: "v21.0 changelog entries for Phases 155-158"
  key_links:
    - from: "src/pages/Settings/Settings.jsx"
      to: "src/pages/Settings/FeeCategorySettings.jsx"
      via: "import and render in AdminTabWithSubtabs fees subtab"
      pattern: "import FeeCategorySettings|<FeeCategorySettings"
---

<objective>
Wire the new FeeCategorySettings component into Settings.jsx, remove all old hardcoded fee state management, bump version, update changelog for the full v21.0 milestone (Phases 155-158), build, deploy, and verify on production.

Purpose: This completes the v21.0 Per-Season Fee Categories frontend and resolves the deployment blocker (Phases 155-158 must deploy together). After this plan, admins can manage fee categories on production.

Output: Working fee category management UI on production, version bump to 21.0.0, changelog updated.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

Prior plan output:
@.planning/phases/158-fee-category-settings-ui/158-01-SUMMARY.md

Key source references:
@src/pages/Settings/Settings.jsx (FeesSubtab lines 3282-3398, AdminTabWithSubtabs lines 3185-3279, fee state lines 139-150, fee fetch lines 276-294, handleSeasonFeeSave lines 362-376, fee props passed at lines 712-719 and 3247-3254)
@src/pages/Settings/FeeCategorySettings.jsx (created in Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace FeesSubtab with FeeCategorySettings in Settings.jsx and clean up</name>
  <files>src/pages/Settings/Settings.jsx, style.css, package.json, CHANGELOG.md</files>
  <action>
**Replace FeesSubtab in Settings.jsx:**

1. Add import at top of Settings.jsx:
   ```jsx
   import FeeCategorySettings from './FeeCategorySettings';
   ```

2. In `AdminTabWithSubtabs`, replace the `FeesSubtab` render (around line 3245-3255) with:
   ```jsx
   ) : activeSubtab === 'fees' ? (
     <FeeCategorySettings />
   ```
   The new component is self-contained - no props needed.

3. Remove all fee-related props from `AdminTabWithSubtabs` function signature (lines 3195-3202):
   - Remove: `currentSeasonFees`, `setCurrentSeasonFees`, `nextSeasonFees`, `setNextSeasonFees`, `feeLoading`, `feeSaving`, `feeMessage`, `handleSeasonFeeSave`

4. Remove all fee-related props from the `AdminTabWithSubtabs` JSX call in `renderTabContent` (around lines 712-719):
   - Remove: `currentSeasonFees={currentSeasonFees}`, `setCurrentSeasonFees={setCurrentSeasonFees}`, `nextSeasonFees={nextSeasonFees}`, `setNextSeasonFees={setNextSeasonFees}`, `feeLoading={feeLoading}`, `feeSaving={feeSaving}`, `feeMessage={feeMessage}`, `handleSeasonFeeSave={handleSeasonFeeSave}`

5. Remove old fee state from the Settings() main component (around lines 139-150):
   - Remove: `currentSeasonFees`, `setCurrentSeasonFees`, `nextSeasonFees`, `setNextSeasonFees`, `feeLoading`, `setFeeLoading`, `feeSaving`, `setFeeSaving`, `feeMessage`, `setFeeMessage`

6. Remove the `handleSeasonFeeSave` function (around lines 362-376).

7. Remove the `fetchFeeSettings` useEffect (around lines 276-294).

8. **Delete the entire old `FeesSubtab` component** (lines 3282-3398). It is fully replaced.

**Version bump (MAJOR - breaking change in data model per v21.0):**
- Note: The version in package.json and style.css is currently 19.2.0. The v20.0 milestone was already shipped but version was not bumped (it's in the Unreleased changelog). Per the project rules, v21.0 Per-Season Fee Categories is the next milestone. However, since v20.0 Configurable Roles is already in the Unreleased changelog, we need to:
  1. First close out v20.0: Move current Unreleased items under `## [20.0.0] - 2026-02-08`
  2. Then add v21.0 items under a new `## [21.0.0] - 2026-02-09` section
  3. Update version to `21.0.0` in both package.json and style.css

**Changelog update:**
Add under `## [21.0.0] - 2026-02-09`:

```markdown
### Added
- Per-season fee category management UI in Settings > Beheer > Contributie
- Season selector toggle for managing current and next season categories
- Drag-and-drop reordering of fee categories with sort order persistence
- Inline editing of category fields: label, amount, age classes, youth flag
- Age class coverage summary showing which Sportlink age classes map to which categories
- API validation feedback: errors (blocking) and warnings (informational) displayed in UI
- Fee category data model with per-season storage in WordPress options
- Config-driven fee calculation replacing hardcoded category constants
- REST API endpoints for category CRUD with structured validation

### Changed
- Fee calculation now reads from per-season category configuration instead of hardcoded values
- Fee settings UI is fully dynamic - no hardcoded fee type names
- Category sort order derived from config, removing duplicated arrays across codebase
- Fee list REST API response includes category metadata for dynamic frontend rendering

### Removed
- Hardcoded fee type definitions (mini, pupil, junior, senior, recreant, donateur) from Settings UI
- Hardcoded category_order arrays from REST API, Google Sheets export, and ContributieList
- Old flat-amount fee settings UI replaced with full category management
```

**Build and deploy:**
- Run `npm run build` to generate production assets.
- Run `bin/deploy.sh` to deploy to production. This resolves the Phase 155-158 deployment blocker since all 4 phases will now be deployed together.
  </action>
  <verify>
    Run `npm run lint` - no lint errors.
    Run `npm run build` - build succeeds.
    Grep Settings.jsx for "FeesSubtab" - should return 0 matches (old component fully removed).
    Grep Settings.jsx for "currentSeasonFees" - should return 0 matches (old state fully removed).
    Grep Settings.jsx for "FeeCategorySettings" - should find import and render.
    Verify version is 21.0.0 in both package.json and style.css.
    Deploy succeeds without errors.
  </verify>
  <done>
    Settings.jsx renders FeeCategorySettings in the fees subtab. All old fee state management removed. Version bumped to 21.0.0. Changelog updated with v20.0 and v21.0 entries. Production deployed with Phases 155-158 together.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete fee category management UI deployed to production:
    - Season selector (current/next) with toggle buttons
    - Drag-and-drop reorderable category list
    - Inline add/edit/delete of categories
    - API validation display (errors in red, warnings in amber)
    - Age class coverage summary
    - Replaced old hardcoded fee inputs
  </what-built>
  <how-to-verify>
    Visit the production site and navigate to Settings > Beheer > Contributie.

    1. **Season selector:** Verify toggle buttons show "Huidig seizoen" and "Volgend seizoen" with correct season keys. Switching between them updates the category list.

    2. **View categories:** Verify the existing fee categories are displayed with their label, amount, age classes, and youth badge.

    3. **Edit a category:** Click the edit button on a category. Change the amount or label. Click "Opslaan". Verify the change persists after page refresh.

    4. **Reorder:** Drag a category to a different position. Verify the new order persists after page refresh.

    5. **Add category:** Click "Nieuwe categorie". Fill in slug, label, amount. Save. Verify it appears in the list.

    6. **Delete category:** Delete the test category you just added. Verify it disappears.

    7. **Age class coverage:** Verify the blue summary card shows which age classes are assigned to each category. Categories with no age classes should show "(Catch-all)".

    8. **Validation:** Try saving a category with an empty label. Verify a red error message appears.

    9. **Mobile:** Check the UI is usable on mobile viewport (drag-and-drop should work with touch).
  </how-to-verify>
  <resume-signal>Type "approved" if the fee category management UI works correctly, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
- `npm run lint` passes with 0 warnings
- `npm run build` succeeds
- Old FeesSubtab component fully removed from Settings.jsx
- Old fee state management fully removed from Settings.jsx
- FeeCategorySettings renders in Admin > Contributie subtab
- Production is deployed and accessible
- Version 21.0.0 in package.json and style.css
- Changelog has v20.0 and v21.0 sections
</verification>

<success_criteria>
- Admin can manage fee categories on production through Settings > Beheer > Contributie
- All 5 UI requirements (UI-01 through UI-05) are verifiable on production
- Old hardcoded fee UI is completely gone
- Phase 155-158 deployment blocker is resolved
- Version and changelog reflect v21.0 milestone
</success_criteria>

<output>
After completion, create `.planning/phases/158-fee-category-settings-ui/158-02-SUMMARY.md`
</output>
