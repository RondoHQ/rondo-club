---
phase: 158-fee-category-settings-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/Settings/FeeCategorySettings.jsx
autonomous: true

must_haves:
  truths:
    - "Admin sees a season toggle (current/next) and the selected season's categories render below it"
    - "Admin can drag categories to reorder them and the new sort_order is persisted to the API"
    - "Admin can add a new category with slug, label, amount, age_classes, and is_youth fields"
    - "Admin can edit any existing category's label, amount, age_classes, and is_youth fields inline"
    - "Admin can delete a category with confirmation"
    - "API validation errors display as red inline messages blocking save"
    - "API validation warnings display as yellow/amber messages after successful save"
    - "Age class coverage summary shows which Sportlink age classes are assigned to which category"
  artifacts:
    - path: "src/pages/Settings/FeeCategorySettings.jsx"
      provides: "Complete fee category management UI component"
      min_lines: 250
  key_links:
    - from: "src/pages/Settings/FeeCategorySettings.jsx"
      to: "/rondo/v1/membership-fees/settings"
      via: "TanStack Query useQuery + useMutation"
      pattern: "prmApi\\.getMembershipFeeSettings|prmApi\\.updateMembershipFeeSettings"
    - from: "src/pages/Settings/FeeCategorySettings.jsx"
      to: "@dnd-kit/core"
      via: "DndContext + SortableContext for drag-and-drop reordering"
      pattern: "DndContext|SortableContext|useSortable"
---

<objective>
Create the FeeCategorySettings component: a self-contained React component for managing per-season fee categories with drag-and-drop reordering, inline CRUD, API validation display, and age class coverage visualization.

Purpose: This component replaces the old hardcoded FeesSubtab with a fully dynamic, config-driven category management UI that consumes the Phase 157 REST API.

Output: A new `src/pages/Settings/FeeCategorySettings.jsx` file containing the complete fee category management UI, ready to be wired into Settings.jsx in Plan 02.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/158-fee-category-settings-ui/158-RESEARCH.md

Key source references:
@src/pages/Settings/CustomFields.jsx (drag-and-drop pattern with @dnd-kit, optimistic updates)
@src/pages/Settings/Settings.jsx (existing FeesSubtab at lines 3282-3398, Tailwind patterns, TabButton usage)
@src/api/client.js (prmApi.getMembershipFeeSettings, prmApi.updateMembershipFeeSettings at lines 294-296)
@includes/class-rest-api.php (GET/POST /membership-fees/settings response shapes at lines 2573-2734)

Phase 157 summaries for API contract:
@.planning/phases/157-fee-category-rest-api/157-01-SUMMARY.md
@.planning/phases/157-fee-category-rest-api/157-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FeeCategorySettings component with season selector, DnD category list, and CRUD</name>
  <files>src/pages/Settings/FeeCategorySettings.jsx</files>
  <action>
Create a new self-contained component `FeeCategorySettings` that manages its own data fetching (no prop drilling from Settings.jsx).

**Data layer:**
- Use `useQuery({ queryKey: ['membership-fee-settings'], queryFn: ... })` to fetch from `prmApi.getMembershipFeeSettings()`. The response shape is:
  ```json
  {
    "current_season": { "key": "2025-2026", "categories": { "slug": { "label": "...", "amount": 0, "age_classes": [], "is_youth": false, "sort_order": 0 } } },
    "next_season": { "key": "2026-2027", "categories": { ... } }
  }
  ```
- Use `useMutation` with `prmApi.updateMembershipFeeSettings(settings, seasonKey)` for saves. The POST body is `{ categories: { slug: { label, amount, age_classes, is_youth, sort_order } }, season: "2025-2026" }`.
- On success, update the query cache directly with `queryClient.setQueryData(['membership-fee-settings'], response.data)`.
- Track `warnings` from successful save responses (`response.data.warnings`).
- Track `errors` from failed saves (`error.response.data.data.errors`) - note: WP_Error wraps additional data in `data.data`.

**Season selector:**
- State: `const [selectedSeason, setSelectedSeason] = useState('current')`.
- Two toggle buttons at top: "Huidig seizoen (2025-2026)" and "Volgend seizoen (2026-2027)" using season keys from the API response.
- Active button: `bg-accent-600 text-white`, inactive: `bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300`.
- Derive active categories: `selectedSeason === 'current' ? data.current_season : data.next_season`.

**Category list with drag-and-drop:**
- Follow the CustomFields.jsx pattern exactly (see RESEARCH.md Pattern 1):
  - Import DndContext, closestCenter, PointerSensor, TouchSensor, KeyboardSensor, useSensor, useSensors from `@dnd-kit/core`
  - Import arrayMove, SortableContext, sortableKeyboardCoordinates, useSortable, verticalListSortingStrategy from `@dnd-kit/sortable`
  - Import CSS from `@dnd-kit/utilities`
  - Configure sensors with PointerSensor (distance: 8), TouchSensor (delay: 200, tolerance: 8), KeyboardSensor
- Render categories sorted by `sort_order` as card rows (not table rows - cards are more mobile-friendly for complex content).
- Each card shows: drag handle (GripVertical icon), label, amount (formatted as EUR), age_classes summary, is_youth badge, edit/delete buttons.
- `onDragEnd`: Use `arrayMove` to reorder, rebuild categories object with new `sort_order` values (0-indexed), immediately save via mutation.
- Use optimistic update pattern from CustomFields.jsx: `onMutate` -> cancel queries, snapshot, optimistically update cache; `onError` -> rollback; `onSettled` -> invalidate.

**SortableCategoryCard sub-component:**
- Uses `useSortable({ id: slug })` hook.
- Applies transform/transition styles and isDragging visual feedback (shadow, opacity).
- Display mode: shows category info with Edit (Edit2 icon) and Delete (Trash2 icon) buttons.
- Edit mode: inline form with fields for label (text input), amount (number input with EUR prefix), age_classes (text input, comma-separated), is_youth (checkbox). Save and Cancel buttons.
- When editing, slug is shown but NOT editable (slug is the key, changing it means delete+add).
- Edit form uses local state (useState), NOT react-hook-form (too heavy for inline editing of 4 simple fields).
- On save: rebuild the full categories object with the edited category and call the save mutation.

**Add category:**
- "Nieuwe categorie" button below the list (Plus icon, dashed border card style matching project patterns).
- Clicking reveals an inline form (same fields as edit + slug field which IS editable for new categories).
- Slug field: text input with pattern hint "kleine-letters-met-streepjes". Auto-generate slug from label using a simple slugify (lowercase, replace spaces with hyphens, strip non-alphanumeric).
- On save: add the new category to the categories object with `sort_order` = current max + 1, then call save mutation.

**Delete category:**
- Click Trash2 icon shows a confirmation inline or uses `window.confirm("Categorie '{label}' verwijderen?")`.
- On confirm: remove the slug from categories object, recalculate sort_order for remaining categories, call save mutation.

**Loading/error states:**
- Show `Loader2` spinner while fetching (same pattern as existing FeesSubtab).
- Show saving indicator on mutation (disable save buttons, show Loader2 in save button).
  </action>
  <verify>
    Run `npm run lint` - no lint errors.
    Run `npm run build` - build succeeds (component is created but not yet imported anywhere, so it won't be in the bundle but should have no syntax errors).
    Verify the file exists and imports are correct by checking that all imported modules (@dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities, @tanstack/react-query, lucide-react, @/api/client) resolve.
  </verify>
  <done>
    FeeCategorySettings.jsx exists with: season toggle, DnD-sortable category list, inline edit for all category fields, add new category, delete category, optimistic updates, loading/saving states. Component is self-contained (fetches own data via TanStack Query).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add API validation display and age class coverage visualization</name>
  <files>src/pages/Settings/FeeCategorySettings.jsx</files>
  <action>
Enhance the FeeCategorySettings component with validation feedback and the age class coverage display.

**API validation display (errors and warnings):**
- Add state: `const [saveErrors, setSaveErrors] = useState([])` and `const [saveWarnings, setSaveWarnings] = useState([])`.
- In the save mutation's `onSuccess`: check `response.data.warnings`, set warnings state, clear errors.
- In the save mutation's `onError`: parse `error.response?.data?.data?.errors` (WP_Error nests additional data), set errors state, clear warnings.
- **Error display (red, blocking):** Show above the category list as a red alert box (`bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4`). List each error with its field path and message. Use AlertCircle icon. Text: "Kan niet opslaan:" followed by bullet list of errors.
- **Warning display (amber, informational):** Show below the category list as an amber info box (`bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-4`). Use AlertCircle icon in amber. Text: "Let op:" followed by bullet list of warnings.
- Clear errors/warnings when user starts editing (on any edit action) or when season changes.

**Age class coverage summary (UI-05):**
- Create an `AgeCoverageSummary` sub-component rendered below the category list.
- For each category (sorted by sort_order), show a row with:
  - Category label (font-medium)
  - Colon separator
  - If age_classes array is non-empty: comma-separated list of age class strings
  - If age_classes is empty: italic text "(Catch-all voor niet-toegewezen klassen)"
- Style as an info card: `bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4`.
- Header: "Leeftijdsklasse dekking" (small, semibold).
- If there are warnings related to age_classes (from saveWarnings state), show them below a divider in amber text: "Overlappende toewijzingen:" followed by the warning messages.
- This component should be visible at all times (not just after save), showing the current state of the categories. After a save with warnings, the overlap warnings become visible.

**Success feedback:**
- After successful save (no errors), briefly show a green success message: "Instellingen opgeslagen" that auto-dismisses after 3 seconds using `setTimeout`.
- Use the same pattern as other settings pages: green text below the action area.

**Dutch language consistency:**
- All UI text must be in Dutch (consistent with the rest of the app).
- Labels: "Slug", "Label", "Bedrag", "Leeftijdsklassen", "Jeugdcategorie".
- Buttons: "Opslaan", "Annuleren", "Bewerken", "Verwijderen", "Nieuwe categorie".
- Messages: "Instellingen opgeslagen", "Kan niet opslaan:", "Let op:".
  </action>
  <verify>
    Run `npm run lint` - no lint errors.
    Run `npm run build` - build succeeds.
    Manually review FeeCategorySettings.jsx to confirm:
    1. Error display section exists with red styling and AlertCircle icon.
    2. Warning display section exists with amber styling.
    3. AgeCoverageSummary section exists with blue info card styling.
    4. Success message with auto-dismiss exists.
    5. All UI text is in Dutch.
  </verify>
  <done>
    FeeCategorySettings.jsx includes: red error alerts for API validation errors, amber warning alerts for API warnings (including age class overlaps), blue age class coverage summary card showing which categories cover which age classes, green success message on save with auto-dismiss. All text is in Dutch.
  </done>
</task>

</tasks>

<verification>
- `npm run lint` passes with 0 warnings
- `npm run build` succeeds
- FeeCategorySettings.jsx exists with all required sub-components
- Component imports resolve correctly (all @dnd-kit, TanStack Query, lucide-react imports valid)
- No hardcoded fee type names (mini, pupil, junior, senior, recreant, donateur) appear in the file
- All UI text is in Dutch
</verification>

<success_criteria>
- FeeCategorySettings.jsx is a complete, self-contained component covering all 5 UI requirements:
  - UI-01: Add, edit, remove categories (CRUD)
  - UI-02: All per-category fields editable (slug on add, label, amount, age_classes, is_youth)
  - UI-03: Season selector toggle (current/next)
  - UI-04: Drag-and-drop reordering with sort_order persistence
  - UI-05: Age class coverage display with overlap warnings from API
- Component fetches its own data via TanStack Query (no prop drilling needed)
- Follows established codebase patterns (@dnd-kit from CustomFields.jsx, Tailwind styling, lucide-react icons)
- Handles API validation: errors block save (red), warnings inform (amber)
</success_criteria>

<output>
After completion, create `.planning/phases/158-fee-category-settings-ui/158-01-SUMMARY.md`
</output>
