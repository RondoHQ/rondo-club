---
phase: 121-bulk-actions
plan: 02
type: execute
wave: 2
depends_on: ["121-01"]
files_modified:
  - src/pages/VOG/VOGList.jsx
autonomous: true

must_haves:
  truths:
    - "User can select individual volunteers via checkbox in first column"
    - "User can select/deselect all visible volunteers via header checkbox"
    - "Selected rows have visual highlight (blue/gray tint)"
    - "Selection toolbar shows count and action buttons when items selected"
    - "User can send VOG emails to all selected people with one action"
    - "User can mark selected people as VOG requested with one action"
    - "Confirmation modal appears before bulk actions"
    - "Results feedback shows sent/failed counts"
  artifacts:
    - path: "src/pages/VOG/VOGList.jsx"
      provides: "Bulk selection and actions for VOG list"
      contains: "selectedIds"
  key_links:
    - from: "src/pages/VOG/VOGList.jsx"
      to: "prmApi.bulkSendVOGEmails"
      via: "useMutation"
      pattern: "bulkSendVOGEmails"
---

<objective>
Add checkbox selection and bulk action capabilities to the VOGList page, allowing users to select multiple volunteers and perform bulk operations (send VOG emails, mark as requested).

Purpose: Enable efficient processing of multiple VOG requests at once
Output: VOGList.jsx with full bulk selection UI following PeopleList.jsx patterns
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/121-bulk-actions/121-CONTEXT.md
@.planning/phases/121-bulk-actions/121-RESEARCH.md
@.planning/phases/120-vog-list-page/120-01-SUMMARY.md
@src/pages/VOG/VOGList.jsx
@src/pages/People/PeopleList.jsx (reference for bulk selection patterns)
@src/api/client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add selection state and checkbox column to VOGList</name>
  <files>src/pages/VOG/VOGList.jsx</files>
  <action>
Update VOGList.jsx to add checkbox selection following PeopleList.jsx patterns exactly.

**1. Add imports:**
```javascript
import { useState, useMemo, useCallback, useRef, useEffect } from 'react';
// ... existing imports ...
import { ArrowUp, ArrowDown, CheckCircle, Mail, RefreshCw, Square, CheckSquare, MinusSquare, ChevronDown, X } from 'lucide-react';
import { useMutation } from '@tanstack/react-query';
```

**2. Add selection state inside VOGList component (after existing useState hooks):**
```javascript
// Selection state
const [selectedIds, setSelectedIds] = useState(new Set());
const [showBulkDropdown, setShowBulkDropdown] = useState(false);
const bulkDropdownRef = useRef(null);

// Selection helpers
const toggleSelection = (personId) => {
  setSelectedIds(prev => {
    const next = new Set(prev);
    if (next.has(personId)) {
      next.delete(personId);
    } else {
      next.add(personId);
    }
    return next;
  });
};

const toggleSelectAll = () => {
  if (selectedIds.size === people.length) {
    setSelectedIds(new Set());
  } else {
    setSelectedIds(new Set(people.map(p => p.id)));
  }
};

const clearSelection = () => setSelectedIds(new Set());

// Derived state
const isAllSelected = people.length > 0 && selectedIds.size === people.length;
const isSomeSelected = selectedIds.size > 0 && selectedIds.size < people.length;

// Clear selection when data changes
useEffect(() => {
  setSelectedIds(new Set());
}, [people]);

// Close dropdown when clicking outside
useEffect(() => {
  const handleClickOutside = (event) => {
    if (bulkDropdownRef.current && !bulkDropdownRef.current.contains(event.target)) {
      setShowBulkDropdown(false);
    }
  };
  document.addEventListener('mousedown', handleClickOutside);
  return () => document.removeEventListener('mousedown', handleClickOutside);
}, []);
```

**3. Update VOGRow component to accept selection props and add checkbox column:**

Change VOGRow signature:
```javascript
function VOGRow({ person, customFieldsMap, isOdd, isSelected, onToggleSelection }) {
```

Add checkbox as first td in the row:
```javascript
<tr className={`hover:bg-gray-100 dark:hover:bg-gray-700 ${
  isSelected
    ? 'bg-accent-50 dark:bg-accent-900/30'
    : isOdd ? 'bg-gray-50 dark:bg-gray-800/50' : 'bg-white dark:bg-gray-800'
}`}>
  {/* Checkbox column */}
  <td className="pl-4 pr-2 py-3 w-10">
    <button
      onClick={(e) => { e.preventDefault(); onToggleSelection(person.id); }}
      className="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300"
    >
      {isSelected ? (
        <CheckSquare className="w-5 h-5 text-accent-600 dark:text-accent-400" />
      ) : (
        <Square className="w-5 h-5" />
      )}
    </button>
  </td>
  {/* Name with badge - existing code */}
  ...
```

**4. Add checkbox header column to table thead:**

Add before the Name header:
```javascript
<tr>
  {/* Checkbox header */}
  <th scope="col" className="pl-4 pr-2 py-3 w-10 bg-gray-50 dark:bg-gray-800">
    <button
      onClick={toggleSelectAll}
      className="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300"
      title={isAllSelected ? 'Deselecteer alles' : 'Selecteer alles'}
    >
      {isAllSelected ? (
        <CheckSquare className="w-5 h-5 text-accent-600 dark:text-accent-400" />
      ) : isSomeSelected ? (
        <MinusSquare className="w-5 h-5 text-accent-600 dark:text-accent-400" />
      ) : (
        <Square className="w-5 h-5" />
      )}
    </button>
  </th>
  <SortableHeader ... />
  ...
```

**5. Update VOGRow usage in the map to pass selection props:**
```javascript
{people.map((person, index) => (
  <VOGRow
    key={person.id}
    person={person}
    customFieldsMap={customFieldsMap}
    isOdd={index % 2 === 1}
    isSelected={selectedIds.has(person.id)}
    onToggleSelection={toggleSelection}
  />
))}
```
  </action>
  <verify>
Check that selection state and checkbox column are implemented:
```bash
grep -n "selectedIds\|toggleSelection\|CheckSquare" src/pages/VOG/VOGList.jsx | head -20
```
  </verify>
  <done>VOGList has checkbox column in first position with working select all/individual selection</done>
</task>

<task type="auto">
  <name>Task 2: Add selection toolbar with bulk actions dropdown</name>
  <files>src/pages/VOG/VOGList.jsx</files>
  <action>
Add the selection toolbar and bulk action modals following PeopleList.jsx patterns.

**1. Add modal state (after selection state):**
```javascript
// Modal state
const [showSendEmailModal, setShowSendEmailModal] = useState(false);
const [showMarkRequestedModal, setShowMarkRequestedModal] = useState(false);
const [bulkActionLoading, setBulkActionLoading] = useState(false);
const [bulkActionResult, setBulkActionResult] = useState(null);
```

**2. Add bulk action mutations:**
```javascript
// Bulk action mutations
const sendEmailsMutation = useMutation({
  mutationFn: ({ ids }) => prmApi.bulkSendVOGEmails(ids),
  onSuccess: (response) => {
    setBulkActionResult(response.data);
    queryClient.invalidateQueries({ queryKey: ['people', 'filtered'] });
  },
});

const markRequestedMutation = useMutation({
  mutationFn: ({ ids }) => prmApi.bulkMarkVOGRequested(ids),
  onSuccess: (response) => {
    setBulkActionResult(response.data);
    queryClient.invalidateQueries({ queryKey: ['people', 'filtered'] });
  },
});
```

**3. Add handler functions:**
```javascript
const handleSendEmails = async () => {
  setBulkActionLoading(true);
  setBulkActionResult(null);
  try {
    await sendEmailsMutation.mutateAsync({ ids: Array.from(selectedIds) });
  } finally {
    setBulkActionLoading(false);
  }
};

const handleMarkRequested = async () => {
  setBulkActionLoading(true);
  setBulkActionResult(null);
  try {
    await markRequestedMutation.mutateAsync({ ids: Array.from(selectedIds) });
  } finally {
    setBulkActionLoading(false);
  }
};

const handleCloseModal = () => {
  setShowSendEmailModal(false);
  setShowMarkRequestedModal(false);
  setBulkActionResult(null);
  if (bulkActionResult && bulkActionResult.sent > 0 || bulkActionResult?.marked > 0) {
    clearSelection();
  }
};
```

**4. Add selection toolbar (place before the card with the table, inside the space-y-4 div):**
```javascript
{/* Selection toolbar - sticky */}
{selectedIds.size > 0 && (
  <div className="sticky top-0 z-20 flex items-center justify-between bg-accent-50 dark:bg-accent-800 border border-accent-200 dark:border-accent-700 rounded-lg px-4 py-2 shadow-sm">
    <span className="text-sm text-accent-800 dark:text-accent-200 font-medium">
      {selectedIds.size} {selectedIds.size === 1 ? 'vrijwilliger' : 'vrijwilligers'} geselecteerd
    </span>
    <div className="flex items-center gap-3">
      {/* Bulk Actions Dropdown */}
      <div className="relative" ref={bulkDropdownRef}>
        <button
          onClick={() => setShowBulkDropdown(!showBulkDropdown)}
          className="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-accent-700 dark:text-accent-200 bg-white dark:bg-gray-800 border border-accent-300 dark:border-accent-600 rounded-md hover:bg-accent-50 dark:hover:bg-gray-700"
        >
          Acties
          <ChevronDown className={`w-4 h-4 transition-transform ${showBulkDropdown ? 'rotate-180' : ''}`} />
        </button>
        {showBulkDropdown && (
          <div className="absolute right-0 mt-1 w-56 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50">
            <div className="py-1">
              <button
                onClick={() => {
                  setShowBulkDropdown(false);
                  setShowSendEmailModal(true);
                }}
                className="w-full flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700"
              >
                <Mail className="w-4 h-4" />
                VOG email verzenden...
              </button>
              <button
                onClick={() => {
                  setShowBulkDropdown(false);
                  setShowMarkRequestedModal(true);
                }}
                className="w-full flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700"
              >
                <CheckCircle className="w-4 h-4" />
                Markeren als aangevraagd...
              </button>
            </div>
          </div>
        )}
      </div>
      <button
        onClick={clearSelection}
        className="text-sm text-accent-600 dark:text-accent-400 hover:text-accent-800 dark:hover:text-accent-300 font-medium"
      >
        Selectie wissen
      </button>
    </div>
  </div>
)}
```

**5. Add modal components at the end of the return statement (before closing PullToRefreshWrapper):**

```javascript
{/* Send Email Modal */}
{showSendEmailModal && (
  <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4">
      <div className="flex items-center justify-between p-4 border-b dark:border-gray-700">
        <h2 className="text-lg font-semibold text-gray-900 dark:text-gray-50">VOG email verzenden</h2>
        <button onClick={handleCloseModal} disabled={bulkActionLoading} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
          <X className="w-5 h-5" />
        </button>
      </div>
      <div className="p-4 space-y-4">
        {bulkActionResult ? (
          <div className="space-y-2">
            {bulkActionResult.sent > 0 && (
              <p className="text-sm text-green-600 dark:text-green-400">
                {bulkActionResult.sent} email{bulkActionResult.sent > 1 ? 's' : ''} verzonden
              </p>
            )}
            {bulkActionResult.failed > 0 && (
              <p className="text-sm text-red-600 dark:text-red-400">
                {bulkActionResult.failed} mislukt
              </p>
            )}
            {bulkActionResult.results?.filter(r => !r.success).map((r, i) => (
              <p key={i} className="text-xs text-gray-500 dark:text-gray-400 pl-2">
                ID {r.id}: {r.error}
              </p>
            ))}
          </div>
        ) : (
          <>
            <p className="text-sm text-gray-600 dark:text-gray-300">
              Verstuur VOG email naar {selectedIds.size} {selectedIds.size === 1 ? 'vrijwilliger' : 'vrijwilligers'}.
            </p>
            <p className="text-sm text-gray-500 dark:text-gray-400">
              Het systeem selecteert automatisch de juiste template (nieuw of vernieuwing) op basis van de bestaande VOG datum.
            </p>
          </>
        )}
      </div>
      <div className="flex justify-end gap-2 p-4 border-t dark:border-gray-700">
        {bulkActionResult ? (
          <button onClick={handleCloseModal} className="px-4 py-2 text-sm font-medium text-white bg-accent-600 hover:bg-accent-700 rounded-md">
            Sluiten
          </button>
        ) : (
          <>
            <button onClick={handleCloseModal} disabled={bulkActionLoading} className="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-md">
              Annuleren
            </button>
            <button onClick={handleSendEmails} disabled={bulkActionLoading} className="px-4 py-2 text-sm font-medium text-white bg-accent-600 hover:bg-accent-700 rounded-md disabled:opacity-50">
              {bulkActionLoading ? 'Verzenden...' : `Verstuur naar ${selectedIds.size} vrijwilliger${selectedIds.size > 1 ? 's' : ''}`}
            </button>
          </>
        )}
      </div>
    </div>
  </div>
)}

{/* Mark Requested Modal */}
{showMarkRequestedModal && (
  <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4">
      <div className="flex items-center justify-between p-4 border-b dark:border-gray-700">
        <h2 className="text-lg font-semibold text-gray-900 dark:text-gray-50">Markeren als aangevraagd</h2>
        <button onClick={handleCloseModal} disabled={bulkActionLoading} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
          <X className="w-5 h-5" />
        </button>
      </div>
      <div className="p-4 space-y-4">
        {bulkActionResult ? (
          <div className="space-y-2">
            {bulkActionResult.marked > 0 && (
              <p className="text-sm text-green-600 dark:text-green-400">
                {bulkActionResult.marked} vrijwilliger{bulkActionResult.marked > 1 ? 's' : ''} gemarkeerd
              </p>
            )}
            {bulkActionResult.failed > 0 && (
              <p className="text-sm text-red-600 dark:text-red-400">
                {bulkActionResult.failed} mislukt
              </p>
            )}
          </div>
        ) : (
          <>
            <p className="text-sm text-gray-600 dark:text-gray-300">
              Markeer {selectedIds.size} {selectedIds.size === 1 ? 'vrijwilliger' : 'vrijwilligers'} als "VOG aangevraagd".
            </p>
            <p className="text-sm text-gray-500 dark:text-gray-400">
              Dit registreert de huidige datum als datum van VOG-aanvraag, zonder een email te versturen.
            </p>
          </>
        )}
      </div>
      <div className="flex justify-end gap-2 p-4 border-t dark:border-gray-700">
        {bulkActionResult ? (
          <button onClick={handleCloseModal} className="px-4 py-2 text-sm font-medium text-white bg-accent-600 hover:bg-accent-700 rounded-md">
            Sluiten
          </button>
        ) : (
          <>
            <button onClick={handleCloseModal} disabled={bulkActionLoading} className="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-md">
              Annuleren
            </button>
            <button onClick={handleMarkRequested} disabled={bulkActionLoading} className="px-4 py-2 text-sm font-medium text-white bg-accent-600 hover:bg-accent-700 rounded-md disabled:opacity-50">
              {bulkActionLoading ? 'Markeren...' : `Markeer ${selectedIds.size} vrijwilliger${selectedIds.size > 1 ? 's' : ''}`}
            </button>
          </>
        )}
      </div>
    </div>
  </div>
)}
```
  </action>
  <verify>
Check that toolbar and modals are implemented:
```bash
grep -n "showSendEmailModal\|showBulkDropdown\|bulkSendVOGEmails" src/pages/VOG/VOGList.jsx | head -15
```
  </verify>
  <done>Selection toolbar with dropdown and confirmation modals are implemented</done>
</task>

<task type="auto">
  <name>Task 3: Build, lint, and deploy</name>
  <files></files>
  <action>
Run lint, build, and deploy:

```bash
npm run lint
npm run build
bin/deploy.sh
```
  </action>
  <verify>
- `npm run lint` passes with no errors
- `npm run build` completes successfully
- `bin/deploy.sh` completes successfully
  </verify>
  <done>Code is linted, built, and deployed to production</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Checkbox column appears as first column in VOGList table
2. Header checkbox toggles all/none selection
3. Individual checkboxes work for each row
4. Selected rows have visual highlight
5. Selection toolbar appears when items selected
6. "VOG email verzenden" action opens confirmation modal
7. "Markeren als aangevraagd" action opens confirmation modal
8. Bulk operations complete and show results
9. Selection clears after successful operation
10. Dark mode styling works throughout
</verification>

<success_criteria>
- User can select multiple people via checkboxes
- Selection toolbar shows "{N} vrijwilligers geselecteerd"
- Acties dropdown has two options: VOG email verzenden, Markeren als aangevraagd
- Confirmation modals show before actions
- Results feedback shows success/failure counts
- Selection clears after successful bulk operation
- No lint errors
- Production deployed
</success_criteria>

<output>
After completion, create `.planning/phases/121-bulk-actions/121-02-SUMMARY.md`
</output>
