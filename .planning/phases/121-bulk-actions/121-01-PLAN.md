---
phase: 121-bulk-actions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-rest-api.php
  - src/api/client.js
autonomous: true

must_haves:
  truths:
    - "Backend accepts array of person IDs for bulk VOG operations"
    - "Backend determines template type (new vs renewal) per person based on datum-vog"
    - "Backend records vog-email-verzonden date when email is sent"
    - "API returns detailed results showing success/failure per person"
  artifacts:
    - path: "includes/class-rest-api.php"
      provides: "Bulk VOG endpoints"
      contains: "bulk_send_vog_emails"
    - path: "src/api/client.js"
      provides: "Frontend API methods for bulk VOG operations"
      contains: "bulkSendVOGEmails"
  key_links:
    - from: "src/api/client.js"
      to: "/stadion/v1/vog/bulk-send"
      via: "axios POST"
      pattern: "api.post.*vog/bulk-send"
---

<objective>
Create REST API endpoints for bulk VOG operations that allow sending VOG emails to multiple people and marking multiple people as "VOG requested" in a single API call.

Purpose: Enable efficient bulk operations from the frontend without making N individual API calls
Output: Two new REST endpoints (bulk-send and bulk-mark) with corresponding frontend API methods
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/121-bulk-actions/121-CONTEXT.md
@.planning/phases/121-bulk-actions/121-RESEARCH.md
@.planning/phases/119-backend-foundation/119-01-SUMMARY.md
@includes/class-vog-email.php
@includes/class-rest-people.php (reference for bulk_update_people pattern)
@src/api/client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bulk VOG REST endpoints</name>
  <files>includes/class-rest-api.php</files>
  <action>
Add two new REST endpoints for bulk VOG operations following the pattern from class-rest-people.php bulk_update_people:

**Register routes in register_routes() method:**

```php
// Bulk send VOG emails
register_rest_route(
    'stadion/v1',
    '/vog/bulk-send',
    [
        'methods'             => \WP_REST_Server::CREATABLE,
        'callback'            => [ $this, 'bulk_send_vog_emails' ],
        'permission_callback' => [ $this, 'check_user_approved' ],
        'args'                => [
            'ids' => [
                'required'          => true,
                'validate_callback' => function ( $param ) {
                    return is_array( $param ) && ! empty( $param );
                },
            ],
        ],
    ]
);

// Bulk mark VOG as requested (records current date)
register_rest_route(
    'stadion/v1',
    '/vog/bulk-mark-requested',
    [
        'methods'             => \WP_REST_Server::CREATABLE,
        'callback'            => [ $this, 'bulk_mark_vog_requested' ],
        'permission_callback' => [ $this, 'check_user_approved' ],
        'args'                => [
            'ids' => [
                'required'          => true,
                'validate_callback' => function ( $param ) {
                    return is_array( $param ) && ! empty( $param );
                },
            ],
        ],
    ]
);
```

**Add callback methods:**

```php
/**
 * Bulk send VOG emails to multiple people
 *
 * @param WP_REST_Request $request The request object
 * @return WP_REST_Response Response with results per person
 */
public function bulk_send_vog_emails( $request ) {
    $ids = $request->get_param( 'ids' );
    $vog_email = new \Stadion\VOG\VOGEmail();

    $results = [];
    $sent = 0;
    $failed = 0;

    foreach ( $ids as $person_id ) {
        // Determine template type based on datum-vog
        $datum_vog = get_field( 'datum-vog', $person_id );
        $template_type = empty( $datum_vog ) ? 'new' : 'renewal';

        $result = $vog_email->send( (int) $person_id, $template_type );

        if ( $result === true ) {
            // Update ACF field for email sent date
            update_field( 'vog-email-verzonden', current_time( 'Y-m-d' ), $person_id );
            $sent++;
            $results[] = [
                'id'      => $person_id,
                'success' => true,
                'type'    => $template_type,
            ];
        } else {
            $failed++;
            $results[] = [
                'id'      => $person_id,
                'success' => false,
                'error'   => is_wp_error( $result ) ? $result->get_error_message() : 'Unknown error',
            ];
        }
    }

    return rest_ensure_response( [
        'results' => $results,
        'sent'    => $sent,
        'failed'  => $failed,
        'total'   => count( $ids ),
    ] );
}

/**
 * Bulk mark VOG as requested for multiple people
 *
 * Records the current date in the vog-email-verzonden field without sending email.
 * Used when VOG request was made through other channels (phone, in-person).
 *
 * @param WP_REST_Request $request The request object
 * @return WP_REST_Response Response with results
 */
public function bulk_mark_vog_requested( $request ) {
    $ids = $request->get_param( 'ids' );
    $current_date = current_time( 'Y-m-d' );

    $marked = 0;
    $failed = 0;
    $results = [];

    foreach ( $ids as $person_id ) {
        $person = get_post( (int) $person_id );

        if ( ! $person || 'person' !== $person->post_type ) {
            $failed++;
            $results[] = [
                'id'      => $person_id,
                'success' => false,
                'error'   => 'Invalid person ID',
            ];
            continue;
        }

        // Update ACF field
        update_field( 'vog-email-verzonden', $current_date, $person_id );
        $marked++;
        $results[] = [
            'id'      => $person_id,
            'success' => true,
        ];
    }

    return rest_ensure_response( [
        'results' => $results,
        'marked'  => $marked,
        'failed'  => $failed,
        'total'   => count( $ids ),
    ] );
}
```

**Important:** Use `update_field()` for ACF fields (not `update_post_meta`). The field key is `vog-email-verzonden` (not `vog_email_sent_date` which was used in plan 119 - that's the post_meta fallback).
  </action>
  <verify>
Check that both endpoints are registered and callbacks exist:
```bash
grep -n "bulk_send_vog_emails\|bulk_mark_vog_requested" includes/class-rest-api.php
```
  </verify>
  <done>Both bulk VOG endpoints are registered in class-rest-api.php with proper permission checks and result handling</done>
</task>

<task type="auto">
  <name>Task 2: Add frontend API methods</name>
  <files>src/api/client.js</files>
  <action>
Add two new methods to the prmApi object for calling the bulk VOG endpoints:

```javascript
// In prmApi object, add after getVOGSettings/updateVOGSettings:

// VOG Bulk Operations
bulkSendVOGEmails: (ids) => api.post('/stadion/v1/vog/bulk-send', { ids }),
bulkMarkVOGRequested: (ids) => api.post('/stadion/v1/vog/bulk-mark-requested', { ids }),
```

These methods:
- Accept an array of person IDs
- Return response with { results: [], sent/marked: N, failed: N, total: N }
  </action>
  <verify>
Check that both methods are added:
```bash
grep -n "bulkSendVOGEmails\|bulkMarkVOGRequested" src/api/client.js
```
  </verify>
  <done>Frontend API client has methods for both bulk VOG operations</done>
</task>

<task type="auto">
  <name>Task 3: Build and verify</name>
  <files></files>
  <action>
Run the build to ensure no syntax errors:
```bash
npm run build
```

Then verify the PHP syntax is valid:
```bash
php -l includes/class-rest-api.php
```
  </action>
  <verify>
- `npm run build` completes without errors
- `php -l includes/class-rest-api.php` shows "No syntax errors detected"
  </verify>
  <done>Build passes and PHP syntax is valid</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Both REST endpoints registered in class-rest-api.php
2. Both frontend API methods exist in client.js
3. Build passes without errors
4. PHP syntax is valid
</verification>

<success_criteria>
- POST /stadion/v1/vog/bulk-send endpoint exists and accepts { ids: number[] }
- POST /stadion/v1/vog/bulk-mark-requested endpoint exists and accepts { ids: number[] }
- prmApi.bulkSendVOGEmails() and prmApi.bulkMarkVOGRequested() methods exist
- Both endpoints update the vog-email-verzonden ACF field
- Bulk send automatically determines template type from datum-vog field
</success_criteria>

<output>
After completion, create `.planning/phases/121-bulk-actions/121-01-SUMMARY.md`
</output>
